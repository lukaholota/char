This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: node_modules, dist
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.cursor/
  rules/
    ukr-translation.mdc
prisma/
  enums/
    Ability.prisma
    AOEShapes.prisma
    ArmorCategory.prisma
    ArmorType.prisma
    BackgroundCategory.prisma
    Classes.prisma
    DamageType.prisma
    DragonbornTypes.prisma
    EquipmentPackCategory.prisma
    FeatCategory.prisma
    Feats.prisma
    FeatureDisplayType.prisma
    FeatureMechanic.prisma
    InfusionTargetType.prisma
    ItemRarity.prisma
    Language.prisma
    MagicItemType.prisma
    Races.prisma
    RestType.prisma
    Size.prisma
    SkillProficiencyType.prisma
    Skills.prisma
    Source.prisma
    SpellcastingType.prisma
    SpellOrigin.prisma
    SpellSchool.prisma
    Subclasses.prisma
    Subraces.prisma
    ToolCategory.prisma
    Variants.prisma
    WeaponCategory.prisma
    WeaponProperty.prisma
    WeaponType.prisma
  migrations/
    0_init/
      migration.sql
    20241205173000_add_sort_order/
      migration.sql
    20251212_subclass_enum/
      migration.sql
    migration_lock.toml
  models/
    accounts/
      Account.prisma
      User.prisma
    backgrounds/
      Background.prisma
    characters/
      Character.prisma
      CharacterSpells.prisma
    choices/
      ChoiceOption.prisma
      ChoiceOptionFeature.prisma
    classes/
      Class.prisma
      ClassChoiceOption.prisma
      ClassFeature.prisma
      ClassOptionalFeature.prisma
      ClassOptionalFeatureReplacesFeature.prisma
      ClassStartingEquipmentOption.prisma
      FightingStyle.prisma
      Subclass.prisma
      SubclassChoiceOption.prisma
      SubclassFeature.prisma
    creatures/
      Creature.prisma
    feats/
      Feat.prisma
      FeatChoiceOption.prisma
    features/
      Feature.prisma
    items/
      Armor.prisma
      EquipmentPack.prisma
      Infusion.prisma
      MagicItem.prisma
      Weapon.prisma
    pers/
      Pers.prisma
      PersArmor.prisma
      PersFeat.prisma
      PersFeatChoice.prisma
      PersFeature.prisma
      PersInfusion.prisma
      PersMagicItem.prisma
      PersMulticlass.prisma
      PersSkill.prisma
      PersSpell.prisma
      PersWeapon.prisma
    races/
      Race.prisma
      RaceChoiceOption.prisma
      RaceChoiceOptionTrait.prisma
      RaceTrait.prisma
      RaceVariant.prisma
      RaceVariantTrait.prisma
      Subrace.prisma
      SubraceTrait.prisma
    spells/
      Spell.prisma
      Spellbook.prisma
      SpellbookSpells.prisma
      SpellClasses.prisma
      SpellRaces.prisma
  seed/
    helpers/
      featureDisplayType.ts
      groupNames.ts
    armorSeed.ts
    backgroundSeed.ts
    choiceOptionSeed.ts
    classChoiceOptionSeed.ts
    classEquipmentSeed.ts
    classFeatureSeed.ts
    classSeed.ts
    equipmentPackSeed.ts
    featChoiceOptionSeed_OLD.ts
    featChoiceOptionSeed.ts
    featSeed.ts
    infusionFeaturesSeed.ts
    infusionSeed.ts
    magicItemSeed.ts
    optionalFeatureSeed.ts
    raceChoiceOptionSeed.ts
    raceFeatureSeed.ts
    raceSeed.ts
    raceVariantSeed.ts
    subclassChoiceOptionSeed.ts
    subclassFeatureSeed.ts
    subclassSeed.ts
    subraceFeatureSeed.ts
    subraceSeed.ts
    weaponSeed.ts
  tools/
    clean_classFeatureSeed.js
    find_dups.js
  schema.prisma
  seed_variant.ts
  seed.ts
public/
  fonts/
    NotoSans-Bold.ttf
    NotoSans-Regular.ttf
  images/
    book-active.png
    book-inactive.png
    dark-favicon.ico
    dragon.png
    favicon.ico
    home-characters.webp
    home-spells.webp
    logo-new.png
    logo.png
  CharacterSheet.pdf
src/
  app/
    actions/
      level-up.ts
    api/
      auth/
        [...nextauth]/
          route.ts
      character/
        level-up/
          route.ts
      spells/
        print/
          route.ts
    pers/
      [id]/
        levelup/
          page.tsx
        print/
          actions.ts
        page.tsx
      home/
        page.tsx
      share/
        [token]/
          page.tsx
      page.tsx
    spells/
      page.tsx
      spells-client.tsx
    globals.css
    layout.tsx
    page.tsx
    providers.tsx
  components/
    level-up/
      LevelUpWizard.tsx
      LevelUpWizardMulticlass.tsx
      StepRenderer.tsx
      useLevelUpManager.ts
    ui/
      alert.tsx
      App.tsx
      badge.tsx
      button.tsx
      card.tsx
      checkbox.tsx
      collapsible.tsx
      dialog.tsx
      dropdown-menu.tsx
      FormattedDescription.tsx
      input.tsx
      label.tsx
      Navigation.tsx
      radio-group.tsx
      scroll-area.tsx
      select.tsx
      sonner.tsx
      switch.tsx
      tabs.tsx
  domain/
    pers/
      AbilityScores.ts
      Background.ts
      CharacterNotes.ts
      CreatePersInput.schema.ts
      Equipment.ts
      HitPoints.ts
      Money.ts
      Pers.ts
      PersClass.ts
      PersFactory.ts
      Race.ts
  hooks/
    useCharacterStats.ts
    useFantasyNameGenerator.ts
    useMediaQuery.ts
    useModalBackButton.ts
    useStepForm.ts
  lib/
    actions/
      bonus-actions.ts
      character-logic.ts
      character-transaction-multiclass.ts
      character-transaction.ts
      character.ts
      combat-actions.ts
      equipment-actions.ts
      feature-uses.ts
      levelup.ts
      pers.ts
      rest-actions.ts
      share-actions.ts
      snapshot-actions.ts
      spell-actions.ts
      spell-slots.ts
      update-character.ts
    components/
      auth/
        GoogleAuthDialog.tsx
        GoogleOneTap.tsx
      characterCreator/
        ASIForm.tsx
        BackgroundsForm.tsx
        CharacterCreateHeader.tsx
        ClassChoiceOptionsForm.tsx
        ClassesForm.tsx
        ClassOptionalFeaturesForm.tsx
        EntityInfoDialog.tsx
        EquipmentForm.tsx
        ExpertiseForm.tsx
        FeatChoiceOptionsForm.tsx
        FeatsForm.tsx
        infoUtils.ts
        MultiStepForm.tsx
        NameForm.tsx
        RaceChoiceOptionsForm.tsx
        RacesForm.tsx
        RaceVariantsForm.tsx
        SkillsForm.tsx
        SourceBadge.tsx
        SubclassChoiceOptionsForm.tsx
        SubclassForm.tsx
        SubracesForm.tsx
      characterSheet/
        shared/
          FeatureCards.tsx
        slides/
          FeaturesSlide.tsx
          MagicSlide.tsx
          MainStatsSlide.tsx
          SkillsSlide.tsx
        AddArmorDialog.tsx
        AddSpellDialog.tsx
        AddWeaponDialog.tsx
        ArmorCustomizeModal.tsx
        CharacterCarousel.tsx
        CharacterSheet.tsx
        CombatPage.tsx
        EntityInfoDialog.tsx
        FeaturesPage.tsx
        ModifyStatModal.tsx
        PrintCharacterDialog.tsx
        RestButton.tsx
        ShareDialog.tsx
        ShortRestDialog.tsx
        SnapshotHistoryModal.tsx
        SpellInfoModal.tsx
        SpellsPage.tsx
        StatsPage.tsx
        WeaponCustomizeModal.tsx
      icons/
        Logo.tsx
      levelUp/
        LevelUpASIForm.tsx
        LevelUpHPStep.tsx
        LevelUpWizard.tsx
        OptionalFeaturesForm.tsx
      test/
        Task.tsx
        TaskCreator.tsx
        Tasks.tsx
      ui/
        card.tsx
        dialog.tsx
    hooks/
      useMediaQuery.ts
    logic/
      bonus-calculator.ts
      multiclass-resolver.ts
      progression-resolver.ts
      spell-logic.ts
      utils.ts
    refs/
      classesBaseASI.ts
      dictionary.json
      dictionary.ts
      fantasyNames.ts
      static.ts
      translation.ts
    server/
      formatters/
        generalFormatters.ts
        weaponFormatter.ts
    stores/
      persFormStore.ts
    types/
      enums.ts
      model-types.ts
      prisma-json.d.ts
    zod/
      schemas/
        persCreateSchema.ts
    auth.ts
    prisma.ts
    utils.ts
  server/
    pdf/
      generateCharacterPdf.ts
      overlayLayout.ts
      types.ts
  store/
    character-store.ts
  types/
    character-flow.ts
tools/
  fix_spell_links.ts
  list_pdf_fields.ts
  make_pdf_grid.ts
.gitignore
check_connection.ts
check_pers_data.ts
components.json
defined_features.txt
eslint.config.mjs
next.config.ts
package.json
postcss.config.js
prisma.config.ts
README.md
referenced_features.txt
tailwind.config.ts
test_pg.js
todo
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/server/pdf/overlayLayout.ts">
import type { Ability } from "@prisma/client";

export type OverlayFieldKey =
  | "characterName"
  | "classLevel"
  | "background"
  | "playerName"
  | "race"
  | "alignment"
  | "xp"
  | "ac"
  | "initiative"
  | "speed"
  | "proficiencyBonus"
  | "hpMax"
  | "hpCurrent"
  | "hpTemp"
  | `stat:${Ability}:score`
  | `stat:${Ability}:mod`;

export type OverlayText = {
  pageIndex: number; // 0-based
  x: number;
  y: number;
  width: number;
  height: number;
  size?: number;
  align?: "left" | "right" | "center";
};

// NOTE:
// - These coordinates are template-dependent.
// - Use `npx tsx tools/make_pdf_grid.ts public/CharacterSheet.pdf` to generate a grid PDF
//   and tune the rects below.
// - Units are PDF points (1 inch = 72 points). Origin is bottom-left.
export const CHARACTER_SHEET_OVERLAY: Partial<Record<OverlayFieldKey, OverlayText>> = {
  // Header
  characterName: { pageIndex: 0, x: 66, y: 734, width: 250, height: 16, size: 12, align: "left" },
  classLevel: { pageIndex: 0, x: 66, y: 710, width: 250, height: 12, size: 10, align: "left" },
  background: { pageIndex: 0, x: 66, y: 692, width: 250, height: 12, size: 10, align: "left" },
  playerName: { pageIndex: 0, x: 330, y: 710, width: 210, height: 12, size: 10, align: "left" },
  race: { pageIndex: 0, x: 330, y: 692, width: 210, height: 12, size: 10, align: "left" },
  alignment: { pageIndex: 0, x: 330, y: 674, width: 120, height: 12, size: 10, align: "left" },
  xp: { pageIndex: 0, x: 460, y: 674, width: 80, height: 12, size: 10, align: "right" },

  // Top right combat boxes (very approximate)
  ac: { pageIndex: 0, x: 458, y: 734, width: 40, height: 16, size: 14, align: "center" },
  initiative: { pageIndex: 0, x: 505, y: 734, width: 40, height: 16, size: 12, align: "center" },
  speed: { pageIndex: 0, x: 552, y: 734, width: 50, height: 16, size: 12, align: "center" },

  // HP block (approx)
  hpMax: { pageIndex: 0, x: 460, y: 610, width: 60, height: 12, size: 10, align: "center" },
  hpCurrent: { pageIndex: 0, x: 460, y: 580, width: 140, height: 18, size: 12, align: "center" },
  hpTemp: { pageIndex: 0, x: 460, y: 548, width: 140, height: 18, size: 12, align: "center" },

  // Proficiency bonus (approx)
  proficiencyBonus: { pageIndex: 0, x: 92, y: 628, width: 40, height: 16, size: 12, align: "center" },

  // Ability scores and mods (approx; tune with grid)
  "stat:STR:score": { pageIndex: 0, x: 54, y: 648, width: 50, height: 16, size: 12, align: "center" },
  "stat:STR:mod": { pageIndex: 0, x: 54, y: 622, width: 50, height: 16, size: 12, align: "center" },

  "stat:DEX:score": { pageIndex: 0, x: 54, y: 586, width: 50, height: 16, size: 12, align: "center" },
  "stat:DEX:mod": { pageIndex: 0, x: 54, y: 560, width: 50, height: 16, size: 12, align: "center" },

  "stat:CON:score": { pageIndex: 0, x: 54, y: 524, width: 50, height: 16, size: 12, align: "center" },
  "stat:CON:mod": { pageIndex: 0, x: 54, y: 498, width: 50, height: 16, size: 12, align: "center" },

  "stat:INT:score": { pageIndex: 0, x: 54, y: 462, width: 50, height: 16, size: 12, align: "center" },
  "stat:INT:mod": { pageIndex: 0, x: 54, y: 436, width: 50, height: 16, size: 12, align: "center" },

  "stat:WIS:score": { pageIndex: 0, x: 54, y: 400, width: 50, height: 16, size: 12, align: "center" },
  "stat:WIS:mod": { pageIndex: 0, x: 54, y: 374, width: 50, height: 16, size: 12, align: "center" },

  "stat:CHA:score": { pageIndex: 0, x: 54, y: 338, width: 50, height: 16, size: 12, align: "center" },
  "stat:CHA:mod": { pageIndex: 0, x: 54, y: 312, width: 50, height: 16, size: 12, align: "center" },
};
</file>

<file path="tools/list_pdf_fields.ts">
import fs from "node:fs";
import { PDFDocument } from "pdf-lib";

async function main() {
  const file = process.argv[2] ?? "public/CharacterSheet.pdf";
  const bytes = fs.readFileSync(file);
  const pdf = await PDFDocument.load(bytes, { ignoreEncryption: true });

  let fields: string[] = [];
  try {
    const form = pdf.getForm();
    fields = form.getFields().map((f) => f.getName());
  } catch {
    fields = [];
  }

  // Keep output machine-readable for quick copy/paste.
  // Exit code 2 when no fields are present (useful in scripts/CI).
  const result = {
    file,
    pages: pdf.getPages().length,
    fieldsCount: fields.length,
    fields,
  };

  console.log(JSON.stringify(result, null, 2));

  if (fields.length === 0) process.exitCode = 2;
}

main().catch((err) => {
  console.error(err);
  process.exitCode = 1;
});
</file>

<file path="tools/make_pdf_grid.ts">
import fs from "node:fs";
import path from "node:path";
import { PDFDocument, rgb, StandardFonts } from "pdf-lib";

async function main() {
  const input = process.argv[2] ?? "public/CharacterSheet.pdf";
  const output = process.argv[3] ?? "public/CharacterSheet.grid.pdf";

  const bytes = fs.readFileSync(input);
  const pdf = await PDFDocument.load(bytes, { ignoreEncryption: true });

  const font = await pdf.embedFont(StandardFonts.Helvetica);

  for (const page of pdf.getPages()) {
    const { width, height } = page.getSize();

    // Draw a light grid every 36pt (0.5 inch) and a darker grid every 72pt (1 inch).
    const minor = 36;
    const major = 72;

    for (let x = 0; x <= width; x += minor) {
      const isMajor = x % major === 0;
      page.drawLine({
        start: { x, y: 0 },
        end: { x, y: height },
        thickness: isMajor ? 0.8 : 0.4,
        color: isMajor ? rgb(0.9, 0.1, 0.1) : rgb(0.85, 0.85, 0.85),
        opacity: 0.35,
      });

      if (isMajor) {
        page.drawText(String(x), {
          x: x + 2,
          y: height - 12,
          size: 8,
          font,
          color: rgb(0.6, 0, 0),
          opacity: 0.7,
        });
      }
    }

    for (let y = 0; y <= height; y += minor) {
      const isMajor = y % major === 0;
      page.drawLine({
        start: { x: 0, y },
        end: { x: width, y },
        thickness: isMajor ? 0.8 : 0.4,
        color: isMajor ? rgb(0.1, 0.1, 0.9) : rgb(0.85, 0.85, 0.85),
        opacity: 0.35,
      });

      if (isMajor) {
        page.drawText(String(y), {
          x: 2,
          y: y + 2,
          size: 8,
          font,
          color: rgb(0, 0, 0.6),
          opacity: 0.7,
        });
      }
    }

    // Draw origin marker
    page.drawCircle({ x: 0, y: 0, size: 6, color: rgb(0, 0, 0), opacity: 0.6 });
    page.drawText("(0,0)", { x: 8, y: 4, size: 8, font, color: rgb(0, 0, 0), opacity: 0.7 });
  }

  const outBytes = await pdf.save();
  fs.writeFileSync(output, outBytes);

  console.log(
    JSON.stringify(
      {
        input: path.resolve(input),
        output: path.resolve(output),
        note: "Open the output PDF and use the grid labels to tune overlay coordinates.",
      },
      null,
      2
    )
  );
}

main().catch((err) => {
  console.error(err);
  process.exitCode = 1;
});
</file>

<file path="prisma/enums/Ability.prisma">
enum Ability {
  STR
  DEX
  CON
  INT
  WIS
  CHA
}
</file>

<file path="prisma/enums/AOEShapes.prisma">
enum AOEShapes {
  CONE
  CUBE
  CYLINDER
  EMANATION
  LINE
  SPHERE
}
</file>

<file path="prisma/enums/ArmorCategory.prisma">
enum ArmorCategory {
  PADDED
  LEATHER
  STUDDED_LEATHER
  HIDE
  CHAIN_SHIRT
  SCALE_MAIL
  BREASTPLATE
  HALF_PLATE
  RING_MAIL
  CHAIN_MAIL
  SPLINT
  PLATE
  SHIELD
  HOMEBREW
}
</file>

<file path="prisma/enums/ArmorType.prisma">
enum ArmorType {
  LIGHT
  MEDIUM
  HEAVY
  SHIELD
}
</file>

<file path="prisma/enums/BackgroundCategory.prisma">
enum BackgroundCategory {
  ACOLYTE
  CHARLATAN
  CRIMINAL
  ENTERTAINER
  FOLK_HERO
  GUILD_ARTISAN
  GUILD_MERCHANT
  HERMIT
  NOBLE
  OUTLANDER
  SAGE
  SAILOR
  SOLDIER
  URCHIN
  GLADIATOR
  KNIGHT
  PIRATE
  SPY
  ANTHROPOLOGIST
  ARCHAEOLOGIST
  CITY_WATCH
  CLAN_CRAFTER
  CLOISTERED_SCHOLAR
  COURTIER
  FACTION_AGENT
  FAR_TRAVELER
  INHERITOR
  INVESTIGATOR
  KNIGHT_OF_THE_ORDER
  MERCENARY_VETERAN
  URBAN_BOUNTY_HUNTER
  UTHGARDT_TRIBE_MEMBER
  WATERDHAVIAN_NOBLE
  FISHER
  SHIPWRIGHT
  SMUGGLER
  MARINE
  AZORIUS_FUNCTIONARY
  BOROS_LEGIONNAIRE
  DIMIR_OPERATIVE
  GOLGARI_AGENT
  GRUUL_ANARCH
  IZZET_ENGINEER
  ORZHOV_REPRESENTATIVE
  RAKDOS_CULTIST
  SELESNYA_INITIATE
  SIMIC_SCIENTIST
  GRINNER
  VOLSTRUCKER_AGENT
  ATHLETE
  LOREHOLD_STUDENT
  PRISMARI_STUDENT
  QUANDRIX_STUDENT
  SILVERQUILL_STUDENT
  WITHERBLOOM_STUDENT
  ASTRAL_DRIFTER
  FACELESS
  FAILED_MERCHANT
  FEYLOST
  GAMBLER
  HAUNTED_ONE
  PLAINTIFF
  RIVAL_INTERN
  WILDSPACER
  WITCHLIGHT_HAND
  KNIGHT_OF_SOLAMNIA
  MAGE_OF_HIGH_SORCERY
  HOUSE_AGENT
  ARTISAN_2024
  CHARLATAN_2024
  CRIMINAL_2024
  ENTERTAINER_2024
  FARMER_2024
  GUARD_2024
  GUIDE_2024
  HERMIT_2024
  MERCHANT_2024
  NOBLE_2024
  SAGE_2024
  SAILOR_2024
  SCRIBE_2024
  SOLDIER_2024
  WAYFARER_2024
  CUSTOM
}
</file>

<file path="prisma/enums/Classes.prisma">
enum Classes {
  ARTIFICER_2014
  BARBARIAN_2014
  BARD_2014
  CLERIC_2014
  DRUID_2014
  FIGHTER_2014
  MONK_2014
  PALADIN_2014
  RANGER_2014
  ROGUE_2014
  SORCERER_2014
  WARLOCK_2014
  WIZARD_2014
}
</file>

<file path="prisma/enums/DamageType.prisma">
enum DamageType {
  BLUDGEONING
  PIERCING
  SLASHING
  ACID
  COLD
  FIRE
  LIGHTNING
  THUNDER
  FORCE
  NECROTIC
  POISON
  PSYCHIC
  RADIANT
}
</file>

<file path="prisma/enums/DragonbornTypes.prisma">
enum DragonbornTypes {
  BLACK
  BLUE
  BRASS
  BRONZE
  COPPER
  GOLD
  GREEN
  RED
  SILVER
  WHITE
  AMETHYST
  CRYSTAL
  EMETALD
  SAPPHIRE
  TOPAZ
}
</file>

<file path="prisma/enums/EquipmentPackCategory.prisma">
enum EquipmentPackCategory {
  BURGLARS_PACK
  DIPLOMATS_PACK
  DUNGEONEERS_PACK
  ENTERTAINERS_PACK
  EXPLORERS_PACK
  PRIESTS_PACK
  SCHOLARS_PACK
  COMPONENT_POUCH
  SPELLBOOK
  HOMEBREW
}
</file>

<file path="prisma/enums/FeatCategory.prisma">
enum FeatCategory {
  ORIGIN
  GENERAL
  FIGHTING_STYLE
  EPIC_BOON
}
</file>

<file path="prisma/enums/Feats.prisma">
enum Feats {
  // Batch 1: PHB General
  ALERT
  ATHLETE
  ACTOR
  CHARGER
  CROSSBOW_EXPERT
  DEFENSIVE_DUELIST
  DUAL_WIELDER
  DUNGEON_DELVER
  DURABLE
  ELEMENTAL_ADEPT
  GRAPPLER
  GREAT_WEAPON_MASTER
  HEALER
  HEAVILY_ARMORED
  HEAVY_ARMOR_MASTER
  INSPIRING_LEADER
  KEEN_MIND
  LIGHTLY_ARMORED
  LINGUIST
  LUCKY
  MAGE_SLAYER
  MAGIC_INITIATE
  MARTIAL_ADEPT
  MEDIUM_ARMOR_MASTER
  MOBILE
  MODERATELY_ARMORED
  MOUNTED_COMBATANT
  OBSERVANT
  POLEARM_MASTER
  RESILIENT
  RITUAL_CASTER
  SAVAGE_ATTACKER
  SENTINEL
  SHARPSHOOTER
  SHIELD_MASTER
  SKILLED
  SKULKER
  SPELL_SNIPER
  TAVERN_BRAWLER
  TOUGH
  WAR_CASTER
  WEAPON_MASTER

  // Batch 2: Racial
  BOUNTIFUL_LUCK
  DRAGON_FEAR
  DRAGON_HIDE
  DROW_HIGH_MAGIC
  DWARVEN_FORTITUDE
  ELVEN_ACCURACY
  FADE_AWAY
  FEY_TELEPORTATION
  FLAMES_OF_PHLEGETHOS
  INFERNAL_CONSTITUTION
  ORCISH_FURY
  PRODIGY
  SECOND_CHANCE
  SQUAT_NIMBLENESS
  WOOD_ELF_MAGIC

  // Batch 3: Tasha's
  ARTIFICER_INITIATE
  CHEF
  CRUSHER
  ELDRITCH_ADEPT
  FEY_TOUCHED
  FIGHTING_INITIATE
  GUNNER
  METAMAGIC_ADEPT
  PIERCER
  POISONER
  SHADOW_TOUCHED
  SKILL_EXPERT
  SLASHER
  TELEKINETIC
  TELEPATHIC

  // Batch 4: Xanathar's/Other
  ABERRANT_DRAGONMARK
  GIFT_OF_THE_CHROMATIC_DRAGON
  GIFT_OF_THE_GEM_DRAGON
  GIFT_OF_THE_METALLIC_DRAGON
  STRIKE_OF_THE_GIANTS
  EMBER_OF_GIANTS
  FURY_OF_GIANTS
  GUILE_OF_GIANTS
  KEENNESS_OF_GIANTS
  SOUL_OF_GIANTS
  VIGOR_OF_GIANTS
}
</file>

<file path="prisma/enums/FeatureDisplayType.prisma">
enum FeatureDisplayType {
  STANDARD
  RESOURCE
  ACTION
  BONUSACTION
  PASSIVE
  TOGGLE
  FREE
  REACTION
  CLASS_RESOURCE
  MAGIC_ITEM
  HIDDEN
}
</file>

<file path="prisma/enums/FeatureMechanic.prisma">
enum FeatureMechanic {
  PASSIVE
  CHOICE_SUBCLASS
  CHOICE_ASI
  CHOICE_SPELLS
  CHOICE_EXPERTISE
  CHOICE_SPECIFIC
  CHOICE_COMPLEX
}
</file>

<file path="prisma/enums/InfusionTargetType.prisma">
// ===== Infusions =====


enum InfusionTargetType {
  ARMOR
  SHIELD
  WEAPON
  WAND_ROD_STAFF
  BOOTS
  HELMET
  RING
  AMMO
  GEM_CRYSTAL
  ANY
}
</file>

<file path="prisma/enums/ItemRarity.prisma">
enum ItemRarity {
  COMMON
  UNCOMMON
  RARE
  VERY_RARE
  LEGENDARY
  ARTIFACT
}
</file>

<file path="prisma/enums/Language.prisma">
enum Language {
  COMMON
  DWARVISH
  ELVISH
  GIANT
  GNOMISH
  GOBLIN
  HALFLING
  ORC
  ABYSSAL
  CELESTIAL
  DRACONIC
  DEEP_SPEECH
  INFERNAL
  PRIMORDIAL
  SYLVAN
  UNDERCOMMON
  DRUIDIC
  THIEVES_CANT
  COMMON_SIGN_LANGUAGE
  GRUNG
  AQUAN
  LOXODON
  VEDALKEN
  QUORI
  LEONIN
}
</file>

<file path="prisma/enums/MagicItemType.prisma">
enum MagicItemType {
  WEAPON
  ARMOR
  WONDROUS_ITEM
  POTION
  SCROLL
  RING
  WAND
  ROD
  STAFF
}
</file>

<file path="prisma/enums/RestType.prisma">
enum RestType {
  SHORT_REST
  LONG_REST
  DAY
}
</file>

<file path="prisma/enums/Size.prisma">
enum Size {
  TINY
  SMALL
  MEDIUM
  LARGE
  HUGE
  GARGANTUAN
}
</file>

<file path="prisma/enums/SkillProficiencyType.prisma">
enum SkillProficiencyType {
  NONE
  HALF
  PROFICIENT
  EXPERTISE
}
</file>

<file path="prisma/enums/Skills.prisma">
enum Skills {
  ATHLETICS
  ACROBATICS
  SLEIGHT_OF_HAND
  STEALTH
  ARCANA
  HISTORY
  INVESTIGATION
  NATURE
  RELIGION
  ANIMAL_HANDLING
  INSIGHT
  MEDICINE
  PERCEPTION
  SURVIVAL
  DECEPTION
  INTIMIDATION
  PERFORMANCE
  PERSUASION
}
</file>

<file path="prisma/enums/Source.prisma">
enum Source {
  PHB
  DMG
  MM
  XGTE
  TCOE
  FTOD
  EGTW
  SCAG
  GGTR
  AI
  IDROTF
  SPELLJAMMER
  COS
  BGDIA
  VGTM
  MTOF
  MPMM
  BPGOTG
  VRGTR
  MOOT
  SACOC
  WBTW
  EBERRON
  DRAGONLANCE
  PHB_2024
  DMG_2024
  MM_2024
  OGA // One Grung Above
  LR // Locathah Rising
}
</file>

<file path="prisma/enums/SpellcastingType.prisma">
enum SpellcastingType {
  NONE
  FULL
  HALF
  THIRD
  PACT
}
</file>

<file path="prisma/enums/SpellOrigin.prisma">
enum SpellOrigin {
  CLASS
  RACE
  FEAT
  MANUAL
  ITEM
}
</file>

<file path="prisma/enums/SpellSchool.prisma">
enum SpellSchool {
  ABJURATION
  CONJURATION
  DIVINATION
  ENCHANTMENT
  EVOCATION
  ILLUSION
  NECROMANCY
  TRANSMUTATION
}
</file>

<file path="prisma/enums/Subclasses.prisma">
enum Subclasses {
  // Artificer
  ALCHEMIST
  ARMORER
  ARTILLERIST
  BATTLE_SMITH

  // Barbarian
  PATH_OF_THE_ANCESTRAL_GUARDIAN
  PATH_OF_THE_BATTLERAGER
  PATH_OF_THE_BEAST
  PATH_OF_THE_BERSERKER
  PATH_OF_THE_GIANT
  PATH_OF_THE_STORM_HERALD
  PATH_OF_THE_TOTEM_WARRIOR
  PATH_OF_WILD_MAGIC
  PATH_OF_THE_ZEALOT

  // Bard
  COLLEGE_OF_CREATION
  COLLEGE_OF_ELOQUENCE
  COLLEGE_OF_GLAMOUR
  COLLEGE_OF_LORE
  COLLEGE_OF_SPIRITS
  COLLEGE_OF_SWORDS
  COLLEGE_OF_VALOR
  COLLEGE_OF_WHISPERS

  // Cleric
  ARCANA_DOMAIN
  DEATH_DOMAIN
  FORGE_DOMAIN
  GRAVE_DOMAIN
  KNOWLEDGE_DOMAIN
  LIFE_DOMAIN
  LIGHT_DOMAIN
  NATURE_DOMAIN
  ORDER_DOMAIN
  PEACE_DOMAIN
  TEMPEST_DOMAIN
  TRICKERY_DOMAIN
  TWILIGHT_DOMAIN
  WAR_DOMAIN

  // Druid
  CIRCLE_OF_DREAMS
  CIRCLE_OF_THE_LAND
  CIRCLE_OF_THE_MOON
  CIRCLE_OF_THE_SHEPHERD
  CIRCLE_OF_SPORES
  CIRCLE_OF_STARS
  CIRCLE_OF_WILDFIRE

  // Fighter
  ARCANE_ARCHER
  BANNERET
  BATTLE_MASTER
  CAVALIER
  CHAMPION
  ECHO_KNIGHT
  ELDRITCH_KNIGHT
  PSI_WARRIOR
  RUNE_KNIGHT
  SAMURAI

  // Monk
  WAY_OF_MERCY
  WAY_OF_THE_ASCENDANT_DRAGON
  WAY_OF_THE_ASTRAL_SELF
  WAY_OF_THE_DRUNKEN_MASTER
  WAY_OF_THE_FOUR_ELEMENTS
  WAY_OF_THE_KENSEI
  WAY_OF_THE_LONG_DEATH
  WAY_OF_THE_OPEN_HAND
  WAY_OF_SHADOW
  WAY_OF_THE_SUN_SOUL

  // Paladin
  OATH_OF_THE_ANCIENTS
  OATH_OF_CONQUEST
  OATH_OF_THE_CROWN
  OATH_OF_DEVOTION
  OATH_OF_GLORY
  OATH_OF_REDEMPTION
  OATH_OF_VENGEANCE
  OATH_OF_THE_WATCHERS
  OATHBREAKER

  // Ranger
  BEAST_MASTER_CONCLAVE
  DRAKEWARDEN
  FEY_WANDERER
  GLOOM_STALKER_CONCLAVE
  HORIZON_WALKER_CONCLAVE
  HUNTER_CONCLAVE
  MONSTER_SLAYER_CONCLAVE
  SWARMKEEPER

  // Rogue
  ARCANE_TRICKSTER
  ASSASSIN
  INQUISITIVE
  MASTERMIND
  PHANTOM
  SCOUT
  SOULKNIFE
  SWASHBUCKLER
  THIEF

  // Sorcerer
  ABERRANT_MIND
  CLOCKWORK_SOUL
  DRACONIC_BLOODLINE
  DIVINE_SOUL
  LUNAR_SORCERY
  SHADOW_MAGIC
  STORM_SORCERY
  WILD_MAGIC

  // Warlock
  ARCHFEY
  CELESTIAL
  FATHOMLESS
  FIEND
  THE_GENIE
  GREAT_OLD_ONE
  HEXBLADE
  UNDEAD
  UNDYING

  // Wizard
  SCHOOL_OF_ABJURATION
  SCHOOL_OF_BLADESINGING
  SCHOOL_OF_CHRONURGY
  SCHOOL_OF_CONJURATION
  SCHOOL_OF_DIVINATION
  SCHOOL_OF_ENCHANTMENT
  SCHOOL_OF_EVOCATION
  SCHOOL_OF_GRAVITURGY
  SCHOOL_OF_ILLUSION
  SCHOOL_OF_NECROMANCY
  ORDER_OF_SCRIBES
  SCHOOL_OF_TRANSMUTATION
  SCHOOL_OF_WAR_MAGIC
}
</file>

<file path="prisma/enums/ToolCategory.prisma">
enum ToolCategory {
  ARTISAN_TOOLS
  DICE_SET
  DRAGONCHESS_SET
  PLAYING_CARD_SET
  THREE_DRAGON_ANTE_SET
  GAMING_SET
  MUSICAL_INSTRUMENT
  DISGUISE_KIT
  FORGERY_KIT
  HERBALISM_KIT
  NAVIGATORS_TOOLS
  POISONERS_KIT
  THIEVES_TOOLS
  JEWELERS_TOOLS
  FISHING_TACKLE
  CARTOGRAPHERS_TOOLS
  VEHICLES_LAND
  VEHICLES_WATER
}
</file>

<file path="prisma/enums/WeaponCategory.prisma">
enum WeaponCategory {
  CLUB
  DAGGER
  GREATCLUB
  HANDAXE
  JAVELIN
  LIGHT_HAMMER
  MACE
  QUARTERSTAFF
  SICKLE
  SPEAR
  UNARMED_STRIKE
  LIGHT_CROSSBOW
  DART
  SHORTBOW
  SLING
  BATTLEAXE
  FLAIL
  GLAIVE
  GREATAXE
  GREATSWORD
  HALBERD
  LANCE
  LONGSWORD
  MAUL
  MORNINGSTAR
  PIKE
  RAPIER
  SCIMITAR
  SHORTSWORD
  TRIDENT
  WAR_PICK
  WARHAMMER
  WHIP
  BLOWGUN

  HAND_CROSSBOW
  HEAVY_CROSSBOW
  LONGBOW
  NET
  HOMEBREW

  // Renaissance Firearms
  PISTOL_RENAISSANCE
  MUSKET

  // Modern Firearms
  PISTOL_AUTOMATIC
  REVOLVER
  RIFLE_HUNTING
  RIFLE_AUTOMATIC
  SHOTGUN

  // Futuristic Firearms
  LASER_PISTOL
  ANTIMATTER_RIFLE
  LASER_RIFLE
}
</file>

<file path="prisma/enums/WeaponProperty.prisma">
enum WeaponProperty {
  FINESSE
  VERSATILE
  LIGHT
  HEAVY
  REACH
  TWO_HANDED
  THROWN
  AMMUNITION
  LOADING
  SPECIAL
  MAGIC_WEAPON
  RELOAD
  BURST_FIRE
}
</file>

<file path="prisma/enums/WeaponType.prisma">
enum WeaponType {
  SIMPLE_WEAPON
  MARTIAL_WEAPON
  FIREARMS
}
</file>

<file path="prisma/migrations/0_init/migration.sql">
-- CreateEnum
CREATE TYPE "Ability" AS ENUM ('STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA');

-- CreateEnum
CREATE TYPE "SpellcastingType" AS ENUM ('NONE', 'FULL', 'HALF', 'THIRD', 'PACT');

-- CreateEnum
CREATE TYPE "Size" AS ENUM ('TINY', 'SMALL', 'MEDIUM', 'LARGE', 'HUGE', 'GARGANTUAN');

-- CreateEnum
CREATE TYPE "SpellSchool" AS ENUM ('ABJURATION', 'CONJURATION', 'DIVINATION', 'ENCHANTMENT', 'EVOCATION', 'ILLUSION', 'NECROMANCY', 'TRANSMUTATION');

-- CreateEnum
CREATE TYPE "ArmorCategory" AS ENUM ('PADDED', 'LEATHER', 'STUDDED_LEATHER', 'HIDE', 'CHAIN_SHIRT', 'SCALE_MAIL', 'BREASTPLATE', 'HALF_PLATE', 'RING_MAIL', 'CHAIN_MAIL', 'SPLINT', 'PLATE', 'SHIELD', 'HOMEBREW');

-- CreateEnum
CREATE TYPE "ArmorType" AS ENUM ('LIGHT', 'MEDIUM', 'HEAVY', 'SHIELD');

-- CreateEnum
CREATE TYPE "SkillProficiencyType" AS ENUM ('NONE', 'HALF', 'PROFICIENT', 'EXPERTISE');

-- CreateEnum
CREATE TYPE "RestType" AS ENUM ('SHORT_REST', 'LONG_REST', 'DAY');

-- CreateEnum
CREATE TYPE "Language" AS ENUM ('COMMON', 'DWARVISH', 'ELVISH', 'GIANT', 'GNOMISH', 'GOBLIN', 'HALFLING', 'ORC', 'ABYSSAL', 'CELESTIAL', 'DRACONIC', 'DEEP_SPEECH', 'INFERNAL', 'PRIMORDIAL', 'SYLVAN', 'UNDERCOMMON', 'DRUIDIC', 'THIEVES_CANT', 'COMMON_SIGN_LANGUAGE');

-- CreateEnum
CREATE TYPE "DamageType" AS ENUM ('BLUDGEONING', 'PIERCING', 'SLASHING', 'ACID', 'COLD', 'FIRE', 'LIGHTNING', 'THUNDER', 'FORCE', 'NECROTIC', 'POISON', 'PSYCHIC', 'RADIANT');

-- CreateEnum
CREATE TYPE "EquipmentPackCategory" AS ENUM ('BURGLARS_PACK', 'DIPLOMATS_PACK', 'DUNGEONEERS_PACK', 'ENTERTAINERS_PACK', 'EXPLORERS_PACK', 'PRIESTS_PACK', 'SCHOLARS_PACK', 'COMPONENT_POUCH', 'SPELLBOOK', 'HOMEBREW');

-- CreateEnum
CREATE TYPE "Source" AS ENUM ('PHB', 'DMG', 'MM', 'XGTE', 'TCOE', 'FTOD', 'EGTW', 'SCAG', 'GGTR', 'AI', 'IDROTF', 'SPELLJAMMER', 'COS', 'BGDIA', 'VGTM', 'MTOF', 'MPMM', 'BPGOTG', 'VRGTR', 'MOOT', 'SACOC', 'WBTW', 'EBERRON', 'DRAGONLANCE', 'PHB_2024', 'DMG_2024', 'MM_2024');

-- CreateEnum
CREATE TYPE "WeaponType" AS ENUM ('SIMPLE_WEAPON', 'MARTIAL_WEAPON', 'FIREARMS');

-- CreateEnum
CREATE TYPE "WeaponCategory" AS ENUM ('CLUB', 'DAGGER', 'GREATCLUB', 'HANDAXE', 'JAVELIN', 'LIGHT_HAMMER', 'MACE', 'QUARTERSTAFF', 'SICKLE', 'SPEAR', 'UNARMED_STRIKE', 'LIGHT_CROSSBOW', 'DART', 'SHORTBOW', 'SLING', 'BATTLEAXE', 'FLAIL', 'GLAIVE', 'GREATAXE', 'GREATSWORD', 'HALBERD', 'LANCE', 'LONGSWORD', 'MAUL', 'MORNINGSTAR', 'PIKE', 'RAPIER', 'SCIMITAR', 'SHORTSWORD', 'TRIDENT', 'WAR_PICK', 'WARHAMMER', 'WHIP', 'BLOWGUN', 'HAND_CROSSBOW', 'HEAVY_CROSSBOW', 'LONGBOW', 'NET', 'HOMEBREW');

-- CreateEnum
CREATE TYPE "Skills" AS ENUM ('ATHLETICS', 'ACROBATICS', 'SLEIGHT_OF_HAND', 'STEALTH', 'ARCANA', 'HISTORY', 'INVESTIGATION', 'NATURE', 'RELIGION', 'ANIMAL_HANDLING', 'INSIGHT', 'MEDICINE', 'PERCEPTION', 'SURVIVAL', 'DECEPTION', 'INTIMIDATION', 'PERFORMANCE', 'PERSUASION');

-- CreateEnum
CREATE TYPE "BackgroundCategory" AS ENUM ('ACOLYTE', 'CHARLATAN', 'CRIMINAL', 'ENTERTAINER', 'FOLK_HERO', 'GUILD_ARTISAN', 'GUILD_MERCHANT', 'HERMIT', 'NOBLE', 'OUTLANDER', 'SAGE', 'SAILOR', 'SOLDIER', 'URCHIN', 'GLADIATOR', 'KNIGHT', 'PIRATE', 'SPY', 'ANTHROPOLOGIST', 'ARCHAEOLOGIST', 'CITY_WATCH', 'CLAN_CRAFTER', 'CLOISTERED_SCHOLAR', 'COURTIER', 'FACTION_AGENT', 'FAR_TRAVELER', 'INHERITOR', 'INVESTIGATOR', 'KNIGHT_OF_THE_ORDER', 'MERCENARY_VETERAN', 'URBAN_BOUNTY_HUNTER', 'UTHGARDT_TRIBE_MEMBER', 'WATERDHAVIAN_NOBLE', 'FISHER', 'SHIPWRIGHT', 'SMUGGLER', 'MARINE', 'AZORIUS_FUNCTIONARY', 'BOROS_LEGIONNAIRE', 'DIMIR_OPERATIVE', 'GOLGARI_AGENT', 'GRUUL_ANARCH', 'IZZET_ENGINEER', 'ORZHOV_REPRESENTATIVE', 'RAKDOS_CULTIST', 'SELESNYA_INITIATE', 'SIMIC_SCIENTIST', 'GRINNER', 'VOLSTRUCKER_AGENT', 'ATHLETE', 'LOREHOLD_STUDENT', 'PRISMARI_STUDENT', 'QUANDRIX_STUDENT', 'SILVERQUILL_STUDENT', 'WITHERBLOOM_STUDENT', 'ASTRAL_DRIFTER', 'FACELESS', 'FAILED_MERCHANT', 'FEYLOST', 'GAMBLER', 'HAUNTED_ONE', 'PLAINTIFF', 'RIVAL_INTERN', 'WILDSPACER', 'WITCHLIGHT_HAND', 'KNIGHT_OF_SOLAMNIA', 'MAGE_OF_HIGH_SORCERY', 'HOUSE_AGENT', 'ARTISAN_2024', 'CHARLATAN_2024', 'CRIMINAL_2024', 'ENTERTAINER_2024', 'FARMER_2024', 'GUARD_2024', 'GUIDE_2024', 'HERMIT_2024', 'MERCHANT_2024', 'NOBLE_2024', 'SAGE_2024', 'SAILOR_2024', 'SCRIBE_2024', 'SOLDIER_2024', 'WAYFARER_2024', 'CUSTOM');

-- CreateEnum
CREATE TYPE "FeatureDisplayType" AS ENUM ('STANDARD', 'RESOURCE', 'ACTION', 'PASSIVE', 'TOGGLE');

-- CreateEnum
CREATE TYPE "WeaponProperty" AS ENUM ('FINESSE', 'VERSATILE', 'LIGHT', 'HEAVY', 'REACH', 'TWO_HANDED', 'THROWN', 'AMMUNITION', 'LOADING', 'SPECIAL', 'MAGIC_WEAPON');

-- CreateEnum
CREATE TYPE "MagicItemType" AS ENUM ('WEAPON', 'ARMOR', 'WONDROUS_ITEM', 'POTION', 'SCROLL', 'RING', 'WAND', 'ROD', 'STAFF');

-- CreateEnum
CREATE TYPE "ItemRarity" AS ENUM ('COMMON', 'UNCOMMON', 'RARE', 'VERY_RARE', 'LEGENDARY', 'ARTIFACT');

-- CreateEnum
CREATE TYPE "FeatCategory" AS ENUM ('ORIGIN', 'GENERAL', 'FIGHTING_STYLE', 'EPIC_BOON');

-- CreateEnum
CREATE TYPE "ToolCategory" AS ENUM ('ARTISAN_TOOLS', 'DICE_SET', 'DRAGONCHESS_SET', 'PLAYING_CARD_SET', 'THREE_DRAGON_ANTE_SET', 'GAMING_SET', 'MUSICAL_INSTRUMENT', 'DISGUISE_KIT', 'FORGERY_KIT', 'HERBALISM_KIT', 'NAVIGATORS_TOOLS', 'POISONERS_KIT', 'THIEVES_TOOLS', 'JEWELERS_TOOLS', 'FISHING_TACKLE', 'CARTOGRAPHERS_TOOLS', 'VEHICLES_LAND', 'VEHICLES_WATER');

-- CreateEnum
CREATE TYPE "Races" AS ENUM ('AASIMAR_2024', 'DRAGONBORN_2024', 'DWARF_2024', 'ELF_2024', 'GNOME_2024', 'GOLIATH_2024', 'HALFLING_2024', 'HUMAN_2024', 'ORC_2024', 'TIEFLING_2024', 'DRAGONBORN_2014', 'DWARF_2014', 'ELF_2014', 'GNOME_2014', 'HALF_ELF_2014', 'HALF_ORC_2014', 'HALFLING_2014', 'HUMAN_2014', 'TIEFLING_2014', 'CENTAUR_GGTR', 'LOXODON_GGTR', 'MINOTAUR_GGTR', 'SIMIC_HYBRID_GGTR', 'VEDALKEN_GGTR', 'VERDAN_AI', 'KALASHTAR_AI', 'WARFORGED_AI', 'LEONIN_MOOT', 'SATYR_MOOT', 'DHAMPIR_VRGTR', 'HEXBLOOD_VRGTR', 'REBORN_VRGTR', 'OWLIN_SACOC', 'AARAKOCRA_MPMM', 'AASIMAR_MPMM', 'BUGBEAR_MPMM', 'CENTAUR_MPMM', 'CHANGELING_MPMM', 'DEEP_GNOME_MPMM', 'DUERGAR_MPMM', 'ELADRIN_MPMM', 'FAIRY_MPMM', 'FIRBOLG_MPMM', 'GENASI_AIR_MPMM', 'GENASI_EARTH_MPMM', 'GENASI_FIRE_MPMM', 'GENASI_WATER_MPMM', 'GITHYANKI_MPMM', 'GITHZERAI_MPMM', 'GOBLIN_MPMM', 'GOLIATH_MPMM', 'HARENGON_MPMM', 'HOBGOBLIN_MPMM', 'KENKU_MPMM', 'KOBOLD_MPMM', 'LIZARDFOLK_MPMM', 'MINOTAUR_MPMM', 'ORC_MPMM', 'SATYR_MPMM', 'SEA_ELF_MPMM', 'SHADAR_KAI_MPMM', 'SHIFTER_MPMM', 'TABAXI_MPMM', 'TORTLE_MPMM', 'TRITON_MPMM', 'YUAN_TI_MPMM', 'ASTRAL_ELF_SPELLJAMMER', 'AUTOGNOME_SPELLJAMMER', 'GIFF_SPELLJAMMER', 'HADOZEE_SPELLJAMMER', 'PLASMOID_SPELLJAMMER', 'THRI_KREEN_SPELLJAMMER', 'KENDER_DRAGONLANCE', 'GRUNG', 'LOCATHAH');

-- CreateEnum
CREATE TYPE "Subraces" AS ENUM ('DWARF_HILL_2014', 'DWARF_MOUNTAIN_2014', 'DWARF_DUERGAR_GRAY_SCAG', 'ELF_HIGH_2014', 'ELF_WOOD_2014', 'ELF_DARK_DROW_2014', 'ELF_ELADRIN_DMG', 'ELF_ELADRIN_MPMM', 'ELF_SHADAR_KAI_MPMM', 'ELF_SEA_MTOF', 'ELF_PALLID_EGTW', 'GNOME_FOREST_2014', 'GNOME_ROCK_2014', 'GNOME_DEEP_SCAG', 'HALFLING_LIGHTFOOT_2014', 'HALFLING_STOUT_2014', 'HALFLING_GHOSTWISE_SCAG', 'TIEFLING_ASMODEUS', 'TIEFLING_BAALZEBUL', 'TIEFLING_DISPATER', 'TIEFLING_FIERNA', 'TIEFLING_GLASYA', 'TIEFLING_LEVISTUS', 'TIEFLING_MAMMON', 'TIEFLING_MEPHISTOPHELES', 'TIEFLING_ZARIEL', 'DRAGONBORN_BLACK', 'DRAGONBORN_BLUE', 'DRAGONBORN_BRASS', 'DRAGONBORN_BRONZE', 'DRAGONBORN_COPPER', 'DRAGONBORN_GOLD', 'DRAGONBORN_GREEN', 'DRAGONBORN_RED', 'DRAGONBORN_SILVER', 'DRAGONBORN_WHITE', 'DRAGONBORN_CHROMATIC', 'DRAGONBORN_METALLIC', 'DRAGONBORN_GEM', 'DRAGONBORN_DRACONBLOOD', 'DRAGONBORN_RAVENITE', 'GENASI_AIR', 'GENASI_EARTH', 'GENASI_FIRE', 'GENASI_WATER', 'AASIMAR_PROTECTOR', 'AASIMAR_SCOURGE', 'AASIMAR_FALLEN', 'GITH_GITHYANKI', 'GITH_GITHZERAI', 'SHIFTER_BEASTHIDE', 'SHIFTER_LONGTOOTH', 'SHIFTER_SWIFTSTRIDE', 'SHIFTER_WILDHUNT');

-- CreateEnum
CREATE TYPE "Variants" AS ENUM ('HALF_ELF_VARIANT_HIGH_DESCENT_SCAG', 'HALF_ELF_VARIANT_WOOD_DESCENT_SCAG', 'HALF_ELF_VARIANT_DROW_DESCENT_SCAG', 'HALF_ELF_VARIANT_AQUATIC_DESCENT_SCAG', 'HALF_ELF_VARIANT', 'TIEFLING_VARIANT_FERAL_SCAG', 'TIEFLING_VARIANT_DEVILS_TONGUE_SCAG', 'TIEFLING_VARIANT_HELLFIRE_SCAG', 'TIEFLING_VARIANT_WINGED_SCAG');

-- CreateEnum
CREATE TYPE "DragonbornTypes" AS ENUM ('BLACK', 'BLUE', 'BRASS', 'BRONZE', 'COPPER', 'GOLD', 'GREEN', 'RED', 'SILVER', 'WHITE', 'AMETHYST', 'CRYSTAL', 'EMETALD', 'SAPPHIRE', 'TOPAZ');

-- CreateEnum
CREATE TYPE "AOEShapes" AS ENUM ('CONE', 'CUBE', 'CYLINDER', 'EMANATION', 'LINE', 'SPHERE');

-- CreateTable
CREATE TABLE "character" (
    "character_id" SERIAL NOT NULL,
    "name" VARCHAR,
    "user_id" INTEGER,

    CONSTRAINT "character_pkey" PRIMARY KEY ("character_id")
);

-- CreateTable
CREATE TABLE "character_spells" (
    "character_spell_id" SERIAL NOT NULL,
    "character_id" INTEGER,
    "spell_id" INTEGER,

    CONSTRAINT "character_spells_pkey" PRIMARY KEY ("character_spell_id")
);

-- CreateTable
CREATE TABLE "creature" (
    "creature_id" SERIAL NOT NULL,
    "name" VARCHAR,
    "name_eng" VARCHAR,
    "size" VARCHAR,
    "type" VARCHAR,
    "alignment" VARCHAR,
    "source" "Source" NOT NULL DEFAULT 'MM',
    "ac" VARCHAR,
    "hp" VARCHAR,
    "speed" VARCHAR,
    "strength" VARCHAR,
    "dexterity" VARCHAR,
    "constitution" VARCHAR,
    "intelligence" VARCHAR,
    "wisdom" VARCHAR,
    "charisma" VARCHAR,
    "skills" VARCHAR,
    "senses" VARCHAR,
    "languages" VARCHAR,
    "challenge" VARCHAR,
    "damage_immunity" VARCHAR,
    "damage_resistance" VARCHAR,
    "condition_immunity" VARCHAR,
    "saving_throws" VARCHAR,
    "special_abilities" VARCHAR,
    "actions" VARCHAR,
    "reactions" VARCHAR,
    "legendary_actions" VARCHAR,
    "proficiency_bonus" VARCHAR,
    "description" VARCHAR,
    "lair_actions" VARCHAR,
    "lair_info" VARCHAR,
    "region_effects" VARCHAR,
    "xp" VARCHAR,

    CONSTRAINT "creature_pkey" PRIMARY KEY ("creature_id")
);

-- CreateTable
CREATE TABLE "spell" (
    "spell_id" SERIAL NOT NULL,
    "name" VARCHAR(255) NOT NULL,
    "level" INTEGER NOT NULL,
    "school" VARCHAR(255),
    "casting_time" VARCHAR(255) NOT NULL,
    "range" VARCHAR(255) NOT NULL,
    "components" VARCHAR(500),
    "duration" VARCHAR(255) NOT NULL,
    "description" TEXT NOT NULL,
    "has_ritual" VARCHAR,
    "has_concentration" VARCHAR,
    "source" "Source" NOT NULL DEFAULT 'PHB',

    CONSTRAINT "spell_pkey" PRIMARY KEY ("spell_id")
);

-- CreateTable
CREATE TABLE "spell_classes" (
    "class_id" SERIAL NOT NULL,
    "spell_id" INTEGER NOT NULL,
    "class_name" VARCHAR(255) NOT NULL,

    CONSTRAINT "spell_classes_pkey" PRIMARY KEY ("class_id")
);

-- CreateTable
CREATE TABLE "spell_races" (
    "spell_id" INTEGER,
    "race_id" SERIAL NOT NULL,
    "race_name" VARCHAR,

    CONSTRAINT "spell_races_pkey" PRIMARY KEY ("race_id")
);

-- CreateTable
CREATE TABLE "spellbook" (
    "spellbook_id" SERIAL NOT NULL,
    "user_id" INTEGER,

    CONSTRAINT "spellbook_pkey" PRIMARY KEY ("spellbook_id")
);

-- CreateTable
CREATE TABLE "spellbook_spells" (
    "spellbook_spell_id" SERIAL NOT NULL,
    "spell_id" INTEGER,
    "spellbook_id" INTEGER,

    CONSTRAINT "spellbook_spells_pkey" PRIMARY KEY ("spellbook_spell_id")
);

-- CreateTable
CREATE TABLE "user" (
    "user_id" SERIAL NOT NULL,
    "login" VARCHAR NOT NULL,
    "password" VARCHAR,

    CONSTRAINT "user_pkey" PRIMARY KEY ("user_id")
);

-- CreateTable
CREATE TABLE "class" (
    "class_id" SERIAL NOT NULL,
    "name" TEXT NOT NULL,
    "hit_die" INTEGER NOT NULL,
    "primary_casting_stat" "Ability",
    "spellcasting_type" "SpellcastingType" NOT NULL DEFAULT 'NONE',
    "ability_score_up_levels" INTEGER[] DEFAULT ARRAY[4, 8, 12, 16, 19]::INTEGER[],
    "subclass_level" INTEGER NOT NULL DEFAULT 3,
    "multiclass_str_req" INTEGER NOT NULL DEFAULT 0,
    "multiclass_dex_req" INTEGER NOT NULL DEFAULT 0,
    "multiclass_con_req" INTEGER NOT NULL DEFAULT 0,
    "multiclass_int_req" INTEGER NOT NULL DEFAULT 0,
    "multiclass_wis_req" INTEGER NOT NULL DEFAULT 0,
    "multiclass_cha_req" INTEGER NOT NULL DEFAULT 0,
    "armor_proficiencies" "ArmorType"[] DEFAULT ARRAY[]::"ArmorType"[],
    "weapon_proficiencies" "WeaponType"[],
    "saving_throws" "Ability"[],
    "skill_proficiencies" "Ability"[],
    "tool_proficiencies" "ToolCategory"[] DEFAULT ARRAY[]::"ToolCategory"[],
    "languages_to_choose_count" INTEGER NOT NULL DEFAULT 0,
    "languages" "Language"[] DEFAULT ARRAY[]::"Language"[],
    "special_spell_slot_progression" JSONB,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "class_pkey" PRIMARY KEY ("class_id")
);

-- CreateTable
CREATE TABLE "subclass" (
    "subclass_id" SERIAL NOT NULL,
    "class_id" INTEGER NOT NULL,
    "name" VARCHAR(100) NOT NULL,
    "description" TEXT,
    "grants_spells" BOOLEAN NOT NULL DEFAULT false,
    "languages_to_choose_count" INTEGER NOT NULL DEFAULT 0,
    "languages" "Language"[] DEFAULT ARRAY[]::"Language"[],
    "tool_proficiencies" "ToolCategory"[] DEFAULT ARRAY[]::"ToolCategory"[],

    CONSTRAINT "subclass_pkey" PRIMARY KEY ("subclass_id")
);

-- CreateTable
CREATE TABLE "pers" (
    "pers_id" SERIAL NOT NULL,
    "user_id" INTEGER NOT NULL,
    "name" VARCHAR(100) NOT NULL,
    "level" INTEGER NOT NULL DEFAULT 1,
    "current_spell_slots" INTEGER[] DEFAULT ARRAY[]::INTEGER[],
    "class_id" INTEGER NOT NULL,
    "subclass_id" INTEGER,
    "background_id" INTEGER NOT NULL,
    "race_id" INTEGER NOT NULL,
    "subrace_id" INTEGER,
    "current_hp" INTEGER NOT NULL,
    "max_hp" INTEGER NOT NULL,
    "temp_hp" INTEGER NOT NULL DEFAULT 0,
    "race_custom" VARCHAR(100) NOT NULL DEFAULT '',
    "class_custom" VARCHAR(100) NOT NULL DEFAULT '',
    "alignment" VARCHAR(100) NOT NULL DEFAULT '',
    "xp" INTEGER NOT NULL DEFAULT 0,
    "custom_background" VARCHAR(100) NOT NULL DEFAULT '',
    "custom_features" TEXT NOT NULL DEFAULT '',
    "custom_languages_known" TEXT NOT NULL DEFAULT '',
    "custom_equipment" TEXT NOT NULL DEFAULT '',
    "personality_traits" TEXT NOT NULL DEFAULT '',
    "ideals" TEXT NOT NULL DEFAULT '',
    "bonds" TEXT NOT NULL DEFAULT '',
    "flaws" TEXT NOT NULL DEFAULT '',
    "backstory" TEXT NOT NULL DEFAULT '',
    "notes" TEXT NOT NULL DEFAULT '',
    "str" INTEGER NOT NULL,
    "dex" INTEGER NOT NULL,
    "con" INTEGER NOT NULL,
    "int" INTEGER NOT NULL,
    "wis" INTEGER NOT NULL,
    "cha" INTEGER NOT NULL,
    "cp" INTEGER NOT NULL DEFAULT 0,
    "sp" INTEGER NOT NULL DEFAULT 0,
    "ep" INTEGER NOT NULL DEFAULT 0,
    "gp" INTEGER NOT NULL DEFAULT 0,
    "pp" INTEGER NOT NULL DEFAULT 0,
    "additional_save_proficiencies" "Ability"[] DEFAULT ARRAY[]::"Ability"[],
    "misc_save_bonuses" JSONB,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "pers_pkey" PRIMARY KEY ("pers_id")
);

-- CreateTable
CREATE TABLE "pers_multiclass" (
    "pers_multiclass_id" SERIAL NOT NULL,
    "pers_id" INTEGER NOT NULL,
    "class_id" INTEGER NOT NULL,
    "subclass_id" INTEGER,
    "class_level" INTEGER NOT NULL,

    CONSTRAINT "pers_multiclass_pkey" PRIMARY KEY ("pers_multiclass_id")
);

-- CreateTable
CREATE TABLE "pers_feature" (
    "pers_feature_id" SERIAL NOT NULL,
    "pers_id" INTEGER NOT NULL,
    "feature_id" INTEGER NOT NULL,
    "uses_remaining" INTEGER,

    CONSTRAINT "pers_feature_pkey" PRIMARY KEY ("pers_feature_id")
);

-- CreateTable
CREATE TABLE "feature" (
    "feature_id" SERIAL NOT NULL,
    "name" VARCHAR(100) NOT NULL,
    "description" TEXT NOT NULL,
    "short_description" TEXT,
    "modifies_stats" JSONB,
    "limited_uses_per" "RestType",
    "uses_count" INTEGER,
    "display_type" "FeatureDisplayType" NOT NULL DEFAULT 'STANDARD',
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "feature_pkey" PRIMARY KEY ("feature_id")
);

-- CreateTable
CREATE TABLE "class_feature" (
    "class_feature_id" SERIAL NOT NULL,
    "class_id" INTEGER NOT NULL,
    "feature_id" INTEGER NOT NULL,
    "level_granted" INTEGER NOT NULL,
    "grants_spell_slots" BOOLEAN NOT NULL DEFAULT false,

    CONSTRAINT "class_feature_pkey" PRIMARY KEY ("class_feature_id")
);

-- CreateTable
CREATE TABLE "subclass_feature" (
    "subclass_feature_id" SERIAL NOT NULL,
    "subclass_id" INTEGER NOT NULL,
    "feature_id" INTEGER NOT NULL,
    "level_granted" INTEGER NOT NULL,
    "grants_spell_slots" BOOLEAN NOT NULL DEFAULT false,

    CONSTRAINT "subclass_feature_pkey" PRIMARY KEY ("subclass_feature_id")
);

-- CreateTable
CREATE TABLE "race_trait" (
    "race_trait_id" SERIAL NOT NULL,
    "race_id" INTEGER NOT NULL,
    "feature_id" INTEGER NOT NULL,

    CONSTRAINT "race_trait_pkey" PRIMARY KEY ("race_trait_id")
);

-- CreateTable
CREATE TABLE "subrace_trait" (
    "subrace_trait_id" SERIAL NOT NULL,
    "subrace_id" INTEGER NOT NULL,
    "feature_id" INTEGER NOT NULL,

    CONSTRAINT "subrace_trait_pkey" PRIMARY KEY ("subrace_trait_id")
);

-- CreateTable
CREATE TABLE "race_variant_trait" (
    "race_variant_trait_id" SERIAL NOT NULL,
    "race_variant_id" INTEGER NOT NULL,
    "feature_id" INTEGER NOT NULL,

    CONSTRAINT "race_variant_trait_pkey" PRIMARY KEY ("race_variant_trait_id")
);

-- CreateTable
CREATE TABLE "race_choice_option_trait" (
    "race_choice_option_trait_id" SERIAL NOT NULL,
    "option_id" INTEGER NOT NULL,
    "feature_id" INTEGER NOT NULL,

    CONSTRAINT "race_choice_option_trait_pkey" PRIMARY KEY ("race_choice_option_trait_id")
);

-- CreateTable
CREATE TABLE "feat_feature" (
    "feat_feature_id" SERIAL NOT NULL,
    "feat_id" INTEGER NOT NULL,
    "feature_id" INTEGER NOT NULL,

    CONSTRAINT "feat_feature_pkey" PRIMARY KEY ("feat_feature_id")
);

-- CreateTable
CREATE TABLE "magic_item_feature" (
    "magic_item_feature_id" SERIAL NOT NULL,
    "magic_item_id" INTEGER NOT NULL,
    "feature_id" INTEGER NOT NULL,

    CONSTRAINT "magic_item_feature_pkey" PRIMARY KEY ("magic_item_feature_id")
);

-- CreateTable
CREATE TABLE "race" (
    "race_id" SERIAL NOT NULL,
    "name" "Races" NOT NULL,
    "size" "Size"[] DEFAULT ARRAY['MEDIUM']::"Size"[],
    "speed" INTEGER NOT NULL DEFAULT 30,
    "burrow_speed" INTEGER NOT NULL DEFAULT 0,
    "flight_speed" INTEGER NOT NULL DEFAULT 0,
    "swim_speed" INTEGER NOT NULL DEFAULT 0,
    "climb_speed" INTEGER NOT NULL DEFAULT 0,
    "ac" INTEGER NOT NULL DEFAULT 10,
    "source" "Source" NOT NULL DEFAULT 'PHB',
    "languages" "Language"[] DEFAULT ARRAY['COMMON']::"Language"[],
    "languages_to_choose_count" INTEGER NOT NULL DEFAULT 0,
    "ASI" JSONB NOT NULL,
    "tool_proficiencies" "ToolCategory"[] DEFAULT ARRAY[]::"ToolCategory"[],
    "skill_proficiencies" "Skills"[],
    "weapon_proficiencies" "WeaponCategory"[] DEFAULT ARRAY[]::"WeaponCategory"[],
    "armor_proficiencies" "ArmorType"[] DEFAULT ARRAY[]::"ArmorType"[],

    CONSTRAINT "race_pkey" PRIMARY KEY ("race_id")
);

-- CreateTable
CREATE TABLE "subrace" (
    "subrace_id" SERIAL NOT NULL,
    "race_id" INTEGER NOT NULL,
    "name" "Subraces" NOT NULL,
    "speed_modifier" INTEGER,
    "source" "Source" NOT NULL DEFAULT 'PHB',
    "replaces_asi" BOOLEAN NOT NULL DEFAULT false,
    "additional_asi" JSONB,
    "additional_languages" "Language"[] DEFAULT ARRAY[]::"Language"[],
    "languages_to_choose_count" INTEGER NOT NULL DEFAULT 0,
    "tool_proficiencies" "ToolCategory"[] DEFAULT ARRAY[]::"ToolCategory"[],
    "skill_proficiencies" JSONB,
    "weapon_proficiencies" "WeaponCategory"[] DEFAULT ARRAY[]::"WeaponCategory"[],
    "armor_proficiencies" "ArmorType"[] DEFAULT ARRAY[]::"ArmorType"[],

    CONSTRAINT "subrace_pkey" PRIMARY KEY ("subrace_id")
);

-- CreateTable
CREATE TABLE "race_variant" (
    "race_variant_id" SERIAL NOT NULL,
    "race_id" INTEGER NOT NULL,
    "name" "Variants" NOT NULL,
    "source" "Source" NOT NULL,
    "exclusivity_group" TEXT,
    "overrides_race_asi" JSONB NOT NULL,
    "overrides_race_speed" INTEGER,
    "overrides_flight_speed" INTEGER,

    CONSTRAINT "race_variant_pkey" PRIMARY KEY ("race_variant_id")
);

-- CreateTable
CREATE TABLE "race_choice_option" (
    "option_id" SERIAL NOT NULL,
    "race_id" INTEGER NOT NULL,
    "subrace_id" INTEGER,
    "choice_group_name" TEXT NOT NULL,
    "option_name" TEXT NOT NULL,
    "description" TEXT,
    "select_multiple" BOOLEAN NOT NULL DEFAULT false,
    "max_selection" INTEGER NOT NULL DEFAULT 1,
    "grants_asi" JSONB,
    "grants_skill_proficiencies" "Skills"[] DEFAULT ARRAY[]::"Skills"[],
    "grants_languages" "Language"[] DEFAULT ARRAY[]::"Language"[],
    "languages_to_choose_count" INTEGER NOT NULL DEFAULT 0,
    "modifies_speed" INTEGER,
    "draconic_damage_type" "DamageType",
    "breath_weapon_shape" "AOEShapes",
    "breath_weapon_aoe" TEXT,

    CONSTRAINT "race_choice_option_pkey" PRIMARY KEY ("option_id")
);

-- CreateTable
CREATE TABLE "background" (
    "background_id" SERIAL NOT NULL,
    "name" "BackgroundCategory" NOT NULL,
    "source" "Source" NOT NULL DEFAULT 'PHB',
    "tool_proficiencies" "ToolCategory"[] DEFAULT ARRAY[]::"ToolCategory"[],
    "skill_proficiencies" "Skills"[],
    "languages_to_choose_count" INTEGER NOT NULL DEFAULT 0,
    "items" JSONB,

    CONSTRAINT "background_pkey" PRIMARY KEY ("background_id")
);

-- CreateTable
CREATE TABLE "feat" (
    "feat_id" SERIAL NOT NULL,
    "name" VARCHAR(100) NOT NULL,
    "category" "FeatCategory" NOT NULL,
    "short_description" TEXT NOT NULL,
    "long_description" TEXT NOT NULL,
    "languages_to_choose_count" INTEGER NOT NULL DEFAULT 0,
    "languages" "Language"[] DEFAULT ARRAY[]::"Language"[],
    "prerequisites" JSONB,

    CONSTRAINT "feat_pkey" PRIMARY KEY ("feat_id")
);

-- CreateTable
CREATE TABLE "feat_ability_boost" (
    "boost_id" SERIAL NOT NULL,
    "feat_id" INTEGER NOT NULL,
    "ability" "Ability",
    "increase_value" INTEGER NOT NULL,
    "abilities_to_choose" "Ability"[] DEFAULT ARRAY[]::"Ability"[],
    "max_value" INTEGER NOT NULL DEFAULT 20,

    CONSTRAINT "feat_ability_boost_pkey" PRIMARY KEY ("boost_id")
);

-- CreateTable
CREATE TABLE "pers_feat" (
    "pers_feat_id" SERIAL NOT NULL,
    "feat_id" INTEGER NOT NULL,
    "pers_id" INTEGER NOT NULL,

    CONSTRAINT "pers_feat_pkey" PRIMARY KEY ("pers_feat_id")
);

-- CreateTable
CREATE TABLE "magic_item" (
    "magic_item_id" SERIAL NOT NULL,
    "name" VARCHAR(100) NOT NULL,
    "item_type" "MagicItemType" NOT NULL,
    "rarity" "ItemRarity" NOT NULL,
    "description" TEXT NOT NULL,
    "bonus_to_ac" INTEGER,
    "bonus_to_attack_roll" INTEGER,
    "bonus_to_damage" INTEGER,

    CONSTRAINT "magic_item_pkey" PRIMARY KEY ("magic_item_id")
);

-- CreateTable
CREATE TABLE "weapon" (
    "weapon_id" SERIAL NOT NULL,
    "name" "WeaponCategory" NOT NULL,
    "damage" TEXT NOT NULL,
    "damage_type" "DamageType" NOT NULL,
    "weapon_type" "WeaponType" NOT NULL,
    "properties" "WeaponProperty"[],
    "versatile_damage" TEXT,
    "normal_range" INTEGER,
    "long_range" INTEGER,

    CONSTRAINT "weapon_pkey" PRIMARY KEY ("weapon_id")
);

-- CreateTable
CREATE TABLE "armor" (
    "armor_id" SERIAL NOT NULL,
    "name" "ArmorCategory" NOT NULL,
    "armor_type" "ArmorType" NOT NULL,
    "base_ac" INTEGER NOT NULL,
    "strength_req" INTEGER,
    "stealth_disadvantage" BOOLEAN NOT NULL DEFAULT false,

    CONSTRAINT "armor_pkey" PRIMARY KEY ("armor_id")
);

-- CreateTable
CREATE TABLE "pers_skill" (
    "pers_skill_id" SERIAL NOT NULL,
    "skill_id" INTEGER NOT NULL,
    "pers_id" INTEGER NOT NULL,
    "proficiency_type" "SkillProficiencyType" NOT NULL DEFAULT 'NONE',
    "custom_modifier" INTEGER,
    "name" "Skills" NOT NULL,

    CONSTRAINT "pers_skill_pkey" PRIMARY KEY ("pers_skill_id")
);

-- CreateTable
CREATE TABLE "pers_weapon" (
    "pers_weapon_id" SERIAL NOT NULL,
    "pers_id" INTEGER NOT NULL,
    "weapon_id" INTEGER NOT NULL,
    "override_damage" TEXT,
    "attack_bonus" INTEGER,
    "override_name" TEXT,
    "override_normal_range" INTEGER,
    "override_long_range" INTEGER,
    "override_damage_type" "DamageType",
    "override_attack_ability" "Ability",
    "is_proficient" BOOLEAN NOT NULL DEFAULT true,

    CONSTRAINT "pers_weapon_pkey" PRIMARY KEY ("pers_weapon_id")
);

-- CreateTable
CREATE TABLE "pers_armor" (
    "pers_armor_id" SERIAL NOT NULL,
    "armor_id" INTEGER NOT NULL,
    "pers_id" INTEGER NOT NULL,
    "override_base_ac" INTEGER,
    "misc_ac_bonus" INTEGER,
    "is_proficient" BOOLEAN NOT NULL DEFAULT true,
    "equipped" BOOLEAN NOT NULL DEFAULT false,

    CONSTRAINT "pers_armor_pkey" PRIMARY KEY ("pers_armor_id")
);

-- CreateTable
CREATE TABLE "pers_magic_item" (
    "pers_magic_item_id" SERIAL NOT NULL,
    "pers_id" INTEGER NOT NULL,
    "magic_item_id" INTEGER NOT NULL,

    CONSTRAINT "pers_magic_item_pkey" PRIMARY KEY ("pers_magic_item_id")
);

-- CreateTable
CREATE TABLE "equipment_pack" (
    "equipment_pack_id" SERIAL NOT NULL,
    "name" "EquipmentPackCategory" NOT NULL,
    "description" TEXT NOT NULL,
    "items" JSONB NOT NULL,

    CONSTRAINT "equipment_pack_pkey" PRIMARY KEY ("equipment_pack_id")
);

-- CreateTable
CREATE TABLE "class_starting_equipment_option" (
    "option_id" SERIAL NOT NULL,
    "class_id" INTEGER NOT NULL,
    "choice_group" INTEGER NOT NULL,
    "option" CHAR(1) NOT NULL,
    "weapon_id" INTEGER,
    "armor_id" INTEGER,
    "equipment_pack_id" INTEGER,
    "quantity" INTEGER NOT NULL DEFAULT 1,
    "choose_any_armor" BOOLEAN NOT NULL DEFAULT false,
    "armor_type" "ArmorType",
    "choose_any_weapon" BOOLEAN NOT NULL DEFAULT false,
    "weapon_type" "WeaponType",
    "weapon_count" INTEGER NOT NULL DEFAULT 1,
    "description" TEXT,

    CONSTRAINT "class_starting_equipment_option_pkey" PRIMARY KEY ("option_id")
);

-- CreateTable
CREATE TABLE "_SubclassExpandedSpells" (
    "A" INTEGER NOT NULL,
    "B" INTEGER NOT NULL,

    CONSTRAINT "_SubclassExpandedSpells_AB_pkey" PRIMARY KEY ("A","B")
);

-- CreateTable
CREATE TABLE "_PersToSpell" (
    "A" INTEGER NOT NULL,
    "B" INTEGER NOT NULL,

    CONSTRAINT "_PersToSpell_AB_pkey" PRIMARY KEY ("A","B")
);

-- CreateTable
CREATE TABLE "_PersToRaceVariant" (
    "A" INTEGER NOT NULL,
    "B" INTEGER NOT NULL,

    CONSTRAINT "_PersToRaceVariant_AB_pkey" PRIMARY KEY ("A","B")
);

-- CreateTable
CREATE TABLE "_PersToRaceChoiceOption" (
    "A" INTEGER NOT NULL,
    "B" INTEGER NOT NULL,

    CONSTRAINT "_PersToRaceChoiceOption_AB_pkey" PRIMARY KEY ("A","B")
);

-- CreateTable
CREATE TABLE "_FeatureToSpell" (
    "A" INTEGER NOT NULL,
    "B" INTEGER NOT NULL,

    CONSTRAINT "_FeatureToSpell_AB_pkey" PRIMARY KEY ("A","B")
);

-- CreateTable
CREATE TABLE "_SubraceReplacesTraits" (
    "A" INTEGER NOT NULL,
    "B" INTEGER NOT NULL,

    CONSTRAINT "_SubraceReplacesTraits_AB_pkey" PRIMARY KEY ("A","B")
);

-- CreateTable
CREATE TABLE "_VariantReplacesTraits" (
    "A" INTEGER NOT NULL,
    "B" INTEGER NOT NULL,

    CONSTRAINT "_VariantReplacesTraits_AB_pkey" PRIMARY KEY ("A","B")
);

-- CreateIndex
CREATE UNIQUE INDEX "unique_names" ON "spell"("name");

-- CreateIndex
CREATE UNIQUE INDEX "class_name_key" ON "class"("name");

-- CreateIndex
CREATE UNIQUE INDEX "subclass_class_id_name_key" ON "subclass"("class_id", "name");

-- CreateIndex
CREATE UNIQUE INDEX "pers_multiclass_pers_id_class_id_key" ON "pers_multiclass"("pers_id", "class_id");

-- CreateIndex
CREATE UNIQUE INDEX "pers_feature_pers_id_feature_id_key" ON "pers_feature"("pers_id", "feature_id");

-- CreateIndex
CREATE UNIQUE INDEX "feature_feature_id_key" ON "feature"("feature_id");

-- CreateIndex
CREATE INDEX "feat_feature_feat_id_idx" ON "feat_feature"("feat_id");

-- CreateIndex
CREATE INDEX "feat_feature_feature_id_idx" ON "feat_feature"("feature_id");

-- CreateIndex
CREATE UNIQUE INDEX "feat_feature_feat_id_feature_id_key" ON "feat_feature"("feat_id", "feature_id");

-- CreateIndex
CREATE UNIQUE INDEX "race_name_key" ON "race"("name");

-- CreateIndex
CREATE UNIQUE INDEX "subrace_name_key" ON "subrace"("name");

-- CreateIndex
CREATE UNIQUE INDEX "race_choice_option_race_id_subrace_id_choice_group_name_opt_key" ON "race_choice_option"("race_id", "subrace_id", "choice_group_name", "option_name");

-- CreateIndex
CREATE UNIQUE INDEX "background_name_key" ON "background"("name");

-- CreateIndex
CREATE UNIQUE INDEX "feat_ability_boost_feat_id_key" ON "feat_ability_boost"("feat_id");

-- CreateIndex
CREATE UNIQUE INDEX "pers_feat_feat_id_pers_id_key" ON "pers_feat"("feat_id", "pers_id");

-- CreateIndex
CREATE UNIQUE INDEX "magic_item_name_key" ON "magic_item"("name");

-- CreateIndex
CREATE UNIQUE INDEX "weapon_name_key" ON "weapon"("name");

-- CreateIndex
CREATE UNIQUE INDEX "armor_name_key" ON "armor"("name");

-- CreateIndex
CREATE UNIQUE INDEX "pers_skill_pers_id_name_key" ON "pers_skill"("pers_id", "name");

-- CreateIndex
CREATE UNIQUE INDEX "equipment_pack_name_key" ON "equipment_pack"("name");

-- CreateIndex
CREATE INDEX "class_starting_equipment_option_class_id_choice_group_optio_idx" ON "class_starting_equipment_option"("class_id", "choice_group", "option");

-- CreateIndex
CREATE INDEX "_SubclassExpandedSpells_B_index" ON "_SubclassExpandedSpells"("B");

-- CreateIndex
CREATE INDEX "_PersToSpell_B_index" ON "_PersToSpell"("B");

-- CreateIndex
CREATE INDEX "_PersToRaceVariant_B_index" ON "_PersToRaceVariant"("B");

-- CreateIndex
CREATE INDEX "_PersToRaceChoiceOption_B_index" ON "_PersToRaceChoiceOption"("B");

-- CreateIndex
CREATE INDEX "_FeatureToSpell_B_index" ON "_FeatureToSpell"("B");

-- CreateIndex
CREATE INDEX "_SubraceReplacesTraits_B_index" ON "_SubraceReplacesTraits"("B");

-- CreateIndex
CREATE INDEX "_VariantReplacesTraits_B_index" ON "_VariantReplacesTraits"("B");

-- AddForeignKey
ALTER TABLE "character" ADD CONSTRAINT "character_user_id_fkey" FOREIGN KEY ("user_id") REFERENCES "user"("user_id") ON DELETE NO ACTION ON UPDATE NO ACTION;

-- AddForeignKey
ALTER TABLE "character_spells" ADD CONSTRAINT "character_spells_character_id_fkey" FOREIGN KEY ("character_id") REFERENCES "character"("character_id") ON DELETE NO ACTION ON UPDATE NO ACTION;

-- AddForeignKey
ALTER TABLE "character_spells" ADD CONSTRAINT "character_spells_spell_id_fkey" FOREIGN KEY ("spell_id") REFERENCES "spell"("spell_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "spell_classes" ADD CONSTRAINT "fk_spell_classes" FOREIGN KEY ("spell_id") REFERENCES "spell"("spell_id") ON DELETE NO ACTION ON UPDATE NO ACTION;

-- AddForeignKey
ALTER TABLE "spell_races" ADD CONSTRAINT "spell_races_spell_id_fkey" FOREIGN KEY ("spell_id") REFERENCES "spell"("spell_id") ON DELETE NO ACTION ON UPDATE NO ACTION;

-- AddForeignKey
ALTER TABLE "spellbook" ADD CONSTRAINT "fk_user_id" FOREIGN KEY ("user_id") REFERENCES "user"("user_id") ON DELETE NO ACTION ON UPDATE NO ACTION;

-- AddForeignKey
ALTER TABLE "spellbook_spells" ADD CONSTRAINT "spellbook_spells_spell_id_fkey" FOREIGN KEY ("spell_id") REFERENCES "spell"("spell_id") ON DELETE NO ACTION ON UPDATE NO ACTION;

-- AddForeignKey
ALTER TABLE "spellbook_spells" ADD CONSTRAINT "spellbook_spells_spellbook_id_fkey" FOREIGN KEY ("spellbook_id") REFERENCES "spellbook"("spellbook_id") ON DELETE NO ACTION ON UPDATE NO ACTION;

-- AddForeignKey
ALTER TABLE "subclass" ADD CONSTRAINT "subclass_class_id_fkey" FOREIGN KEY ("class_id") REFERENCES "class"("class_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers" ADD CONSTRAINT "pers_user_id_fkey" FOREIGN KEY ("user_id") REFERENCES "user"("user_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers" ADD CONSTRAINT "pers_class_id_fkey" FOREIGN KEY ("class_id") REFERENCES "class"("class_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers" ADD CONSTRAINT "pers_subclass_id_fkey" FOREIGN KEY ("subclass_id") REFERENCES "subclass"("subclass_id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers" ADD CONSTRAINT "pers_race_id_fkey" FOREIGN KEY ("race_id") REFERENCES "race"("race_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers" ADD CONSTRAINT "pers_subrace_id_fkey" FOREIGN KEY ("subrace_id") REFERENCES "subrace"("subrace_id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers" ADD CONSTRAINT "pers_background_id_fkey" FOREIGN KEY ("background_id") REFERENCES "background"("background_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers_multiclass" ADD CONSTRAINT "pers_multiclass_pers_id_fkey" FOREIGN KEY ("pers_id") REFERENCES "pers"("pers_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers_multiclass" ADD CONSTRAINT "pers_multiclass_class_id_fkey" FOREIGN KEY ("class_id") REFERENCES "class"("class_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers_multiclass" ADD CONSTRAINT "pers_multiclass_subclass_id_fkey" FOREIGN KEY ("subclass_id") REFERENCES "subclass"("subclass_id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers_feature" ADD CONSTRAINT "pers_feature_feature_id_fkey" FOREIGN KEY ("feature_id") REFERENCES "feature"("feature_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers_feature" ADD CONSTRAINT "pers_feature_pers_id_fkey" FOREIGN KEY ("pers_id") REFERENCES "pers"("pers_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "class_feature" ADD CONSTRAINT "class_feature_feature_id_fkey" FOREIGN KEY ("feature_id") REFERENCES "feature"("feature_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "class_feature" ADD CONSTRAINT "class_feature_class_id_fkey" FOREIGN KEY ("class_id") REFERENCES "class"("class_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "subclass_feature" ADD CONSTRAINT "subclass_feature_feature_id_fkey" FOREIGN KEY ("feature_id") REFERENCES "feature"("feature_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "subclass_feature" ADD CONSTRAINT "subclass_feature_subclass_id_fkey" FOREIGN KEY ("subclass_id") REFERENCES "subclass"("subclass_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "race_trait" ADD CONSTRAINT "race_trait_feature_id_fkey" FOREIGN KEY ("feature_id") REFERENCES "feature"("feature_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "race_trait" ADD CONSTRAINT "race_trait_race_id_fkey" FOREIGN KEY ("race_id") REFERENCES "race"("race_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "subrace_trait" ADD CONSTRAINT "subrace_trait_feature_id_fkey" FOREIGN KEY ("feature_id") REFERENCES "feature"("feature_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "subrace_trait" ADD CONSTRAINT "subrace_trait_subrace_id_fkey" FOREIGN KEY ("subrace_id") REFERENCES "subrace"("subrace_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "race_variant_trait" ADD CONSTRAINT "race_variant_trait_feature_id_fkey" FOREIGN KEY ("feature_id") REFERENCES "feature"("feature_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "race_variant_trait" ADD CONSTRAINT "race_variant_trait_race_variant_id_fkey" FOREIGN KEY ("race_variant_id") REFERENCES "race_variant"("race_variant_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "race_choice_option_trait" ADD CONSTRAINT "race_choice_option_trait_feature_id_fkey" FOREIGN KEY ("feature_id") REFERENCES "feature"("feature_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "race_choice_option_trait" ADD CONSTRAINT "race_choice_option_trait_option_id_fkey" FOREIGN KEY ("option_id") REFERENCES "race_choice_option"("option_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "feat_feature" ADD CONSTRAINT "feat_feature_feature_id_fkey" FOREIGN KEY ("feature_id") REFERENCES "feature"("feature_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "feat_feature" ADD CONSTRAINT "feat_feature_feat_id_fkey" FOREIGN KEY ("feat_id") REFERENCES "feat"("feat_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "magic_item_feature" ADD CONSTRAINT "magic_item_feature_feature_id_fkey" FOREIGN KEY ("feature_id") REFERENCES "feature"("feature_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "magic_item_feature" ADD CONSTRAINT "magic_item_feature_magic_item_id_fkey" FOREIGN KEY ("magic_item_id") REFERENCES "magic_item"("magic_item_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "subrace" ADD CONSTRAINT "subrace_race_id_fkey" FOREIGN KEY ("race_id") REFERENCES "race"("race_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "race_variant" ADD CONSTRAINT "race_variant_race_id_fkey" FOREIGN KEY ("race_id") REFERENCES "race"("race_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "race_choice_option" ADD CONSTRAINT "race_choice_option_race_id_fkey" FOREIGN KEY ("race_id") REFERENCES "race"("race_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "race_choice_option" ADD CONSTRAINT "race_choice_option_subrace_id_fkey" FOREIGN KEY ("subrace_id") REFERENCES "subrace"("subrace_id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "feat_ability_boost" ADD CONSTRAINT "feat_ability_boost_feat_id_fkey" FOREIGN KEY ("feat_id") REFERENCES "feat"("feat_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers_feat" ADD CONSTRAINT "pers_feat_feat_id_fkey" FOREIGN KEY ("feat_id") REFERENCES "feat"("feat_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers_feat" ADD CONSTRAINT "pers_feat_pers_id_fkey" FOREIGN KEY ("pers_id") REFERENCES "pers"("pers_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers_skill" ADD CONSTRAINT "pers_skill_pers_id_fkey" FOREIGN KEY ("pers_id") REFERENCES "pers"("pers_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers_weapon" ADD CONSTRAINT "pers_weapon_pers_id_fkey" FOREIGN KEY ("pers_id") REFERENCES "pers"("pers_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers_weapon" ADD CONSTRAINT "pers_weapon_weapon_id_fkey" FOREIGN KEY ("weapon_id") REFERENCES "weapon"("weapon_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers_armor" ADD CONSTRAINT "pers_armor_pers_id_fkey" FOREIGN KEY ("pers_id") REFERENCES "pers"("pers_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers_armor" ADD CONSTRAINT "pers_armor_armor_id_fkey" FOREIGN KEY ("armor_id") REFERENCES "armor"("armor_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers_magic_item" ADD CONSTRAINT "pers_magic_item_pers_id_fkey" FOREIGN KEY ("pers_id") REFERENCES "pers"("pers_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pers_magic_item" ADD CONSTRAINT "pers_magic_item_magic_item_id_fkey" FOREIGN KEY ("magic_item_id") REFERENCES "magic_item"("magic_item_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "class_starting_equipment_option" ADD CONSTRAINT "class_starting_equipment_option_class_id_fkey" FOREIGN KEY ("class_id") REFERENCES "class"("class_id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "class_starting_equipment_option" ADD CONSTRAINT "class_starting_equipment_option_weapon_id_fkey" FOREIGN KEY ("weapon_id") REFERENCES "weapon"("weapon_id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "class_starting_equipment_option" ADD CONSTRAINT "class_starting_equipment_option_armor_id_fkey" FOREIGN KEY ("armor_id") REFERENCES "armor"("armor_id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "class_starting_equipment_option" ADD CONSTRAINT "class_starting_equipment_option_equipment_pack_id_fkey" FOREIGN KEY ("equipment_pack_id") REFERENCES "equipment_pack"("equipment_pack_id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "_SubclassExpandedSpells" ADD CONSTRAINT "_SubclassExpandedSpells_A_fkey" FOREIGN KEY ("A") REFERENCES "spell"("spell_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "_SubclassExpandedSpells" ADD CONSTRAINT "_SubclassExpandedSpells_B_fkey" FOREIGN KEY ("B") REFERENCES "subclass"("subclass_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "_PersToSpell" ADD CONSTRAINT "_PersToSpell_A_fkey" FOREIGN KEY ("A") REFERENCES "pers"("pers_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "_PersToSpell" ADD CONSTRAINT "_PersToSpell_B_fkey" FOREIGN KEY ("B") REFERENCES "spell"("spell_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "_PersToRaceVariant" ADD CONSTRAINT "_PersToRaceVariant_A_fkey" FOREIGN KEY ("A") REFERENCES "pers"("pers_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "_PersToRaceVariant" ADD CONSTRAINT "_PersToRaceVariant_B_fkey" FOREIGN KEY ("B") REFERENCES "race_variant"("race_variant_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "_PersToRaceChoiceOption" ADD CONSTRAINT "_PersToRaceChoiceOption_A_fkey" FOREIGN KEY ("A") REFERENCES "pers"("pers_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "_PersToRaceChoiceOption" ADD CONSTRAINT "_PersToRaceChoiceOption_B_fkey" FOREIGN KEY ("B") REFERENCES "race_choice_option"("option_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "_FeatureToSpell" ADD CONSTRAINT "_FeatureToSpell_A_fkey" FOREIGN KEY ("A") REFERENCES "feature"("feature_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "_FeatureToSpell" ADD CONSTRAINT "_FeatureToSpell_B_fkey" FOREIGN KEY ("B") REFERENCES "spell"("spell_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "_SubraceReplacesTraits" ADD CONSTRAINT "_SubraceReplacesTraits_A_fkey" FOREIGN KEY ("A") REFERENCES "race_trait"("race_trait_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "_SubraceReplacesTraits" ADD CONSTRAINT "_SubraceReplacesTraits_B_fkey" FOREIGN KEY ("B") REFERENCES "subrace"("subrace_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "_VariantReplacesTraits" ADD CONSTRAINT "_VariantReplacesTraits_A_fkey" FOREIGN KEY ("A") REFERENCES "race_trait"("race_trait_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "_VariantReplacesTraits" ADD CONSTRAINT "_VariantReplacesTraits_B_fkey" FOREIGN KEY ("B") REFERENCES "race_variant"("race_variant_id") ON DELETE CASCADE ON UPDATE CASCADE;
</file>

<file path="prisma/migrations/20241205173000_add_sort_order/migration.sql">
-- Add sort order columns for PHB ordering
ALTER TABLE "race" ADD COLUMN "sort_order" INTEGER NOT NULL DEFAULT 999;
ALTER TABLE "class" ADD COLUMN "sort_order" INTEGER NOT NULL DEFAULT 999;
ALTER TABLE "weapon" ADD COLUMN "sort_order" INTEGER NOT NULL DEFAULT 999;
</file>

<file path="prisma/migrations/20251212_subclass_enum/migration.sql">
-- Create enum type for subclasses
CREATE TYPE "Subclasses" AS ENUM (
  'ALCHEMIST',
  'ARMORER',
  'ARTILLERIST',
  'BATTLE_SMITH',
  'PATH_OF_THE_ANCESTRAL_GUARDIAN',
  'PATH_OF_THE_BATTLERAGER',
  'PATH_OF_THE_BEAST',
  'PATH_OF_THE_BERSERKER',
  'PATH_OF_THE_GIANT',
  'PATH_OF_THE_STORM_HERALD',
  'PATH_OF_THE_TOTEM_WARRIOR',
  'PATH_OF_WILD_MAGIC',
  'PATH_OF_THE_ZEALOT',
  'COLLEGE_OF_CREATION',
  'COLLEGE_OF_ELOQUENCE',
  'COLLEGE_OF_GLAMOUR',
  'COLLEGE_OF_LORE',
  'COLLEGE_OF_SPIRITS',
  'COLLEGE_OF_SWORDS',
  'COLLEGE_OF_VALOR',
  'COLLEGE_OF_WHISPERS',
  'ARCANA_DOMAIN',
  'DEATH_DOMAIN',
  'FORGE_DOMAIN',
  'GRAVE_DOMAIN',
  'KNOWLEDGE_DOMAIN',
  'LIFE_DOMAIN',
  'LIGHT_DOMAIN',
  'NATURE_DOMAIN',
  'ORDER_DOMAIN',
  'PEACE_DOMAIN',
  'TEMPEST_DOMAIN',
  'TRICKERY_DOMAIN',
  'TWILIGHT_DOMAIN',
  'WAR_DOMAIN',
  'CIRCLE_OF_DREAMS',
  'CIRCLE_OF_THE_LAND',
  'CIRCLE_OF_THE_MOON',
  'CIRCLE_OF_THE_SHEPHERD',
  'CIRCLE_OF_SPORES',
  'CIRCLE_OF_STARS',
  'CIRCLE_OF_WILDFIRE',
  'ARCANE_ARCHER',
  'BANNERET',
  'BATTLE_MASTER',
  'CAVALIER',
  'CHAMPION',
  'ECHO_KNIGHT',
  'ELDRITCH_KNIGHT',
  'PSI_WARRIOR',
  'RUNE_KNIGHT',
  'SAMURAI',
  'WAY_OF_MERCY',
  'WAY_OF_THE_ASCENDANT_DRAGON',
  'WAY_OF_THE_ASTRAL_SELF',
  'WAY_OF_THE_DRUNKEN_MASTER',
  'WAY_OF_THE_FOUR_ELEMENTS',
  'WAY_OF_THE_KENSEI',
  'WAY_OF_THE_LONG_DEATH',
  'WAY_OF_THE_OPEN_HAND',
  'WAY_OF_SHADOW',
  'WAY_OF_THE_SUN_SOUL',
  'OATH_OF_THE_ANCIENTS',
  'OATH_OF_CONQUEST',
  'OATH_OF_THE_CROWN',
  'OATH_OF_DEVOTION',
  'OATH_OF_GLORY',
  'OATH_OF_REDEMPTION',
  'OATH_OF_VENGEANCE',
  'OATH_OF_THE_WATCHERS',
  'OATHBREAKER',
  'BEAST_MASTER_CONCLAVE',
  'DRAKEWARDEN',
  'FEY_WANDERER',
  'GLOOM_STALKER_CONCLAVE',
  'HORIZON_WALKER_CONCLAVE',
  'HUNTER_CONCLAVE',
  'MONSTER_SLAYER_CONCLAVE',
  'SWARMKEEPER',
  'ARCANE_TRICKSTER',
  'ASSASSIN',
  'INQUISITIVE',
  'MASTERMIND',
  'PHANTOM',
  'SCOUT',
  'SOULKNIFE',
  'SWASHBUCKLER',
  'THIEF',
  'ABERRANT_MIND',
  'CLOCKWORK_SOUL',
  'DRACONIC_BLOODLINE',
  'DIVINE_SOUL',
  'LUNAR_SORCERY',
  'SHADOW_MAGIC',
  'STORM_SORCERY',
  'WILD_MAGIC',
  'ARCHFEY',
  'CELESTIAL',
  'FATHOMLESS',
  'FIEND',
  'THE_GENIE',
  'GREAT_OLD_ONE',
  'HEXBLADE',
  'UNDEAD',
  'UNDYING',
  'SCHOOL_OF_ABJURATION',
  'SCHOOL_OF_BLADESINGING',
  'SCHOOL_OF_CHRONURGY',
  'SCHOOL_OF_CONJURATION',
  'SCHOOL_OF_DIVINATION',
  'SCHOOL_OF_ENCHANTMENT',
  'SCHOOL_OF_EVOCATION',
  'SCHOOL_OF_GRAVITURGY',
  'SCHOOL_OF_ILLUSION',
  'SCHOOL_OF_NECROMANCY',
  'ORDER_OF_SCRIBES',
  'SCHOOL_OF_TRANSMUTATION',
  'SCHOOL_OF_WAR_MAGIC'
);

ALTER TABLE "subclass"
  ALTER COLUMN "name" TYPE "Subclasses" USING "name"::"Subclasses";
</file>

<file path="prisma/migrations/migration_lock.toml">
provider = "postgresql"
</file>

<file path="prisma/models/accounts/User.prisma">
model User {
  id            Int       @id @default(autoincrement()) @map("user_id")
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  accounts      Account[]
  perses        Pers[]

  @@map("user")
}
</file>

<file path="prisma/models/backgrounds/Background.prisma">
model Background {
  backgroundId Int                @id @default(autoincrement()) @map("background_id")
  name         BackgroundCategory @unique

  source                 Source         @default(PHB)
  toolProficiencies      ToolCategory[] @default([]) @map("tool_proficiencies")
  /// [SkillProficiencies]
  skillProficiencies     Json?          @map("skill_proficiencies")
  languagesToChooseCount Int            @default(0) @map("languages_to_choose_count")
  items                  Json?
  specialAbilityName     String?
  description            String?        @db.Text // ability description

  perses Pers[]

  @@map("background")
}
</file>

<file path="prisma/models/characters/Character.prisma">
model Character {
  characterId Int     @id @default(autoincrement()) @map("character_id")
  name        String? @db.VarChar
  userId      Int?    @map("user_id")

  characterSpells CharacterSpells[]

  @@map("character")
}
</file>

<file path="prisma/models/characters/CharacterSpells.prisma">
model CharacterSpells {
  characterSpellId Int  @id @default(autoincrement()) @map("character_spell_id")
  characterId      Int? @map("character_id")
  spellId          Int? @map("spell_id")

  character Character? @relation(fields: [characterId], references: [characterId], onDelete: NoAction, onUpdate: NoAction)
  spell     Spell?     @relation(fields: [spellId], references: [spellId], onDelete: Cascade, onUpdate: Cascade)

  @@map("character_spells")
}
</file>

<file path="prisma/models/classes/ClassOptionalFeatureReplacesFeature.prisma">
model ClassOptionalFeatureReplacesFeature {
  classOptionalFeatureId Int @map("class_optional_feature_id")
  replacedFeatureId      Int @map("replaced_feature_id")

  classOptionalFeature ClassOptionalFeature @relation(fields: [classOptionalFeatureId], references: [optionalFeatureId], onDelete: Cascade)
  replacedFeature      Feature              @relation("ReplacedByOptionalFeatures", fields: [replacedFeatureId], references: [featureId], onDelete: Cascade)

  @@id([classOptionalFeatureId, replacedFeatureId])
  @@map("class_optional_feature_replaces_feature")
}
</file>

<file path="prisma/models/classes/FightingStyle.prisma">
model FightingStyle {
  id          Int    @id @default(autoincrement())
  name        String
  engName     String @unique @map("eng_name")
  description String

  @@map("fighting_style")
}
</file>

<file path="prisma/models/creatures/Creature.prisma">
model Creature {
  creatureId        Int     @id @default(autoincrement()) @map("creature_id")
  name              String? @db.VarChar
  nameEng           String? @map("name_eng") @db.VarChar
  size              String? @db.VarChar
  type              String? @db.VarChar
  alignment         String? @db.VarChar
  source            Source  @default(MM)
  ac                String? @db.VarChar
  hp                String? @db.VarChar
  speed             String? @db.VarChar
  strength          String? @db.VarChar
  dexterity         String? @db.VarChar
  constitution      String? @db.VarChar
  intelligence      String? @db.VarChar
  wisdom            String? @db.VarChar
  charisma          String? @db.VarChar
  skills            String? @db.VarChar
  senses            String? @db.VarChar
  languages         String? @db.VarChar
  challenge         String? @db.VarChar
  damageImmunity    String? @map("damage_immunity") @db.VarChar
  damageResistance  String? @map("damage_resistance") @db.VarChar
  conditionImmunity String? @map("condition_immunity") @db.VarChar
  savingThrows      String? @map("saving_throws") @db.VarChar
  specialAbilities  String? @map("special_abilities") @db.VarChar
  actions           String? @db.VarChar
  reactions         String? @db.VarChar
  legendaryActions  String? @map("legendary_actions") @db.VarChar
  proficiencyBonus  String? @map("proficiency_bonus") @db.VarChar
  description       String? @db.VarChar
  lairActions       String? @map("lair_actions") @db.VarChar
  lairInfo          String? @map("lair_info") @db.VarChar
  regionEffects     String? @map("region_effects") @db.VarChar
  xp                String? @db.VarChar

  @@map("creature")
}
</file>

<file path="prisma/models/items/Armor.prisma">
model Armor {
  armorId Int           @id @default(autoincrement()) @map("armor_id")
  name    ArmorCategory @unique

  armorType ArmorType @map("armor_type")
  baseAC    Int       @map("base_ac")

  strengthReq         Int?    @map("strength_req")
  stealthDisadvantage Boolean @default(false) @map("stealth_disadvantage")

  persArmor                    PersArmor[]
  classStartingEquipmentOption ClassStartingEquipmentOption[]

  @@map("armor")
}
</file>

<file path="prisma/models/items/EquipmentPack.prisma">
model EquipmentPack {
  equipmentPackId Int                   @id @default(autoincrement()) @map("equipment_pack_id")
  name            EquipmentPackCategory @unique
  description     String                @db.Text

  items Json

  classStartingEquipmentOptions ClassStartingEquipmentOption[]

  @@map("equipment_pack")
}
</file>

<file path="prisma/models/items/Infusion.prisma">
model Infusion {
  infusionId Int    @id @default(autoincrement()) @map("infusion_id")
  name       String @db.VarChar(120)
  engName    String @unique @map("eng_name") @db.VarChar(120)

  minArtificerLevel  Int                @default(1) @map("min_artificer_level")
  targetType         InfusionTargetType @map("target_type")
  requiresAttunement Boolean            @default(false) @map("requires_attunement")

  // Explicit effect fields ( JSON)
  bonusToAC                  Int?    @map("bonus_to_ac")
  bonusToAttackRoll          Int?    @map("bonus_to_attack_roll")
  bonusToDamage              Int?    @map("bonus_to_damage")
  spellAttackBonus           Int?    @map("spell_attack_bonus")
  speedBonus                 Int?    @map("speed_bonus")
  charges                    Int?    @map("charges")
  rechargeDice               String? @map("recharge_dice")
  restoresSpellSlotUpToLevel Int?    @map("restores_spell_slot_upto_level")

  // Scaling (+2 at level 10 for some infusions)
  increasesAtLevel10By Int? @map("increases_at_level10_by")

  // Replicate Magic Item
  replicatedMagicItemId Int?       @map("replicated_magic_item_id")
  replicatedMagicItem   MagicItem? @relation(fields: [replicatedMagicItemId], references: [magicItemId])

  // Special flags
  createsHomunculus Boolean? @map("creates_homunculus")

  // Link to Feature for static description
  featureId Int?     @map("feature_id")
  feature   Feature? @relation(fields: [featureId], references: [featureId], onDelete: Cascade)

  persInfusions PersInfusion[]

  @@map("infusion")
}
</file>

<file path="prisma/models/spells/Spellbook.prisma">
model Spellbook {
  spellbookId Int  @id @default(autoincrement()) @map("spellbook_id")
  userId      Int? @map("user_id")

  spellbookSpells SpellbookSpells[]

  @@map("spellbook")
}
</file>

<file path="prisma/models/spells/SpellbookSpells.prisma">
model SpellbookSpells {
  spellbookSpellId Int  @id @default(autoincrement()) @map("spellbook_spell_id")
  spellId          Int? @map("spell_id")
  spellbookId      Int? @map("spellbook_id")

  spell     Spell?     @relation(fields: [spellId], references: [spellId], onDelete: NoAction, onUpdate: NoAction)
  spellbook Spellbook? @relation(fields: [spellbookId], references: [spellbookId], onDelete: NoAction, onUpdate: NoAction)

  @@map("spellbook_spells")
}
</file>

<file path="prisma/models/spells/SpellClasses.prisma">
model SpellClasses {
  classId   Int    @id @default(autoincrement()) @map("class_id") // OLDDDDDD
  spellId   Int    @map("spell_id")
  className String @map("class_name") @db.VarChar(255)

  spell Spell @relation(fields: [spellId], references: [spellId], onDelete: NoAction, onUpdate: NoAction, map: "fk_spell_classes")

  @@map("spell_classes")
}
</file>

<file path="prisma/models/spells/SpellRaces.prisma">
model SpellRaces {
  spellId  Int?    @map("spell_id")
  raceId   Int     @id @default(autoincrement()) @map("race_id") // OLDDDDDDD
  raceName String? @map("race_name") @db.VarChar

  spell Spell? @relation(fields: [spellId], references: [spellId], onDelete: NoAction, onUpdate: NoAction)

  @@map("spell_races")
}
</file>

<file path="prisma/seed/helpers/groupNames.ts">
/**
 * Shared group names for choice options across different seed files
 * This ensures consistency between subclass seeds and feat seeds
 */

export const CHOICE_GROUPS = {
  // Battle Master Maneuvers (shared with MARTIAL_ADEPT feat)
  BATTLE_MASTER_MANEUVERS: "  ",
  
  // Add more shared groups as needed
  // RUNE_KNIGHT_RUNES: " ",
} as const;
</file>

<file path="prisma/seed/equipmentPackSeed.ts">
import { PrismaClient, EquipmentPackCategory, Prisma } from "@prisma/client";

export const seedEquipmentPacks = async (prisma: PrismaClient) => {
    console.log('Seeding equipment packs...')

    const packs: Prisma.EquipmentPackCreateInput[] = [
        {
            name: EquipmentPackCategory.BURGLARS_PACK,
            description: '    ,     .',
            items: [
                { name: '', quantity: 1 },
                { name: '  1000 ', quantity: 1 },
                { name: ' (10 )', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 5 },
                { name: '', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 10 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 2 },
                { name: ' (1 )', quantity: 5 },
                { name: '', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '  (50 )', quantity: 1 }
            ]
        },
        {
            name: EquipmentPackCategory.DIPLOMATS_PACK,
            description: '         .',
            items: [
                { name: '', quantity: 1 },
                { name: '    ', quantity: 2 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 2 },
                { name: ' ', quantity: 5 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 1 }
            ]
        },
        {
            name: EquipmentPackCategory.DUNGEONEERS_PACK,
            description: '       .',
            items: [
                { name: '', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 10 },
                { name: '', quantity: 10 },
                { name: '', quantity: 1 },
                { name: ' (1 )', quantity: 10 },
                { name: '', quantity: 1 },
                { name: '  (50 )', quantity: 1 }
            ]
        },
        {
            name: EquipmentPackCategory.ENTERTAINERS_PACK,
            description: '  ,     .',
            items: [
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 2 },
                { name: '', quantity: 5 },
                { name: ' (1 )', quantity: 5 },
                { name: '', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: '  ', quantity: 1}
            ]
        },
        {
            name: EquipmentPackCategory.EXPLORERS_PACK,
            description: '          .',
            items: [
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '   ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 10 },
                { name: ' (1 )', quantity: 10 },
                { name: '', quantity: 1 },
                { name: '  (50 )', quantity: 1 }
            ]
        },
        {
            name: EquipmentPackCategory.PRIESTS_PACK,
            description: '          .',
            items: [
                { name: '', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 10 },
                { name: '', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 2 },
                { name: '', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' (1 )', quantity: 2 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1}
            ]
        },
        {
            name: EquipmentPackCategory.SCHOLARS_PACK,
            description: '       .',
            items: [
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 10 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 }
            ]
        },
        {
            name: EquipmentPackCategory.COMPONENT_POUCH,
            description: '         .',
            items: [
                { name: ' ', quantity: 1 }
            ]
        },
        {
            name: EquipmentPackCategory.SPELLBOOK,
            description: '            .',
            items: [
                { name: ' ', quantity: 1 }
            ]
        },
        {
            name: EquipmentPackCategory.HOMEBREW,
            description: '  .',
            items: []
        }
    ]

    for (const pack of packs) {
        await prisma.equipmentPack.upsert({
            where: { name: pack.name },
            update: {},
            create: pack
        })
    }

    console.log(` Seeded ${packs.length} equipment packs`)
}
</file>

<file path="prisma/seed/featChoiceOptionSeed_OLD.ts">
import { PrismaClient, Feats, Ability, Skills, Prisma } from "@prisma/client";

export const seedFeatChoiceOptions = async (prisma: PrismaClient) => {
    console.log('      (Feats)...');

    // Helper to find feat by name
    const findFeat = async (name: Feats) => {
        const feat = await prisma.feat.findUnique({ where: { name } });
        if (!feat) console.warn(`Feat ${name} not found!`);
        return feat;
    };

    // Helper to create or find ChoiceOption
    const createChoiceOption = async (
        groupName: string,
        optionName: string,
        optionNameEng: string,
        features: { engName: string }[] = []
    ) => {
        const existing = await prisma.choiceOption.findUnique({
            where: { optionNameEng }
        });

        if (existing) return existing;

        // Find features to connect
        const featureConnects: Prisma.ChoiceOptionFeatureCreateWithoutOptionInput[] = [];
        for (const f of features) {
            const feature = await prisma.feature.findFirst({ where: { engName: f.engName } });
            if (feature) {
                featureConnects.push({ feature: { connect: { featureId: feature.featureId } } });
            } else {
                console.warn(`Feature ${f.engName} not found for choice option ${optionNameEng}`);
            }
        }

        return await prisma.choiceOption.create({
            data: {
                groupName,
                optionName,
                optionNameEng,
                features: {
                    create: featureConnects
                }
            }
        });
    };

    // Helper to link Feat and ChoiceOption
    const linkFeatChoice = async (featId: number, choiceOptionId: number) => {
        const existing = await prisma.featChoiceOption.findUnique({
            where: {
                unique_feat_choice: {
                    featId,
                    choiceOptionId
                }
            }
        });

        if (!existing) {
            await prisma.featChoiceOption.create({
                data: {
                    featId,
                    choiceOptionId
                }
            });
        }
    };

    // ========================================================================
    // RESILIENT ()
    // Choose one ability score to increase by 1, and gain proficiency in saving throws using that ability.
    // ========================================================================
    const resilient = await findFeat(Feats.RESILIENT);
    if (resilient) {
        const abilities = [
            { name: '', eng: 'Strength', code: Ability.STR },
            { name: '', eng: 'Dexterity', code: Ability.DEX },
            { name: '', eng: 'Constitution', code: Ability.CON },
            { name: '', eng: 'Intelligence', code: Ability.INT },
            { name: '', eng: 'Wisdom', code: Ability.WIS },
            { name: '', eng: 'Charisma', code: Ability.CHA },
        ];

        for (const ab of abilities) {
            // We need features for these. Usually "Resilient (Strength)" feature exists or we create it?
            // Assuming features like "Resilient (Strength)" exist or we just rely on the choice name for now.
            // Ideally, we should have features that grant the save proficiency.
            // For now, let's assume the choice itself is the marker, or we link to a generic feature if specific ones don't exist.
            // Let's check if we have features for saves.
            // If not, we just create the choice option. The system might handle ASI/Saves based on choice name or we need features.
            // Let's assume we just create options for now.
            
            const option = await createChoiceOption(
                '  ',
                ab.name,
                `Resilient (${ab.eng})`
            );
            await linkFeatChoice(resilient.featId, option.choiceOptionId);
        }
    }

    // ========================================================================
    // SKILLED ()
    // You gain proficiency in any combination of 3 skills or tools of your choice.
    // This is usually handled by a generic "Choose 3" in the UI, but if we want explicit options:
    // We would need options for EVERY skill and tool.
    // That's a lot of options.
    // If the UI handles "Select 3 Skills" via a special component (like Class Skills), we might not need ChoiceOptions for this.
    // BUT, if we want to use the ChoiceOption system, we need them.
    // Let's add options for Skills for now.
    // ========================================================================
    const skilled = await findFeat(Feats.SKILLED);
    if (skilled) {
        // We can reuse existing skill options if they exist, or create new ones.
        // Let's create options for each skill.
        for (const skill of Object.values(Skills)) {
             const option = await createChoiceOption(
                ' ',
                skill, // Localized name is tricky here if we only have enum. Assuming enum is English or mapped.
                `Skilled (${skill})`
            );
            await linkFeatChoice(skilled.featId, option.choiceOptionId);
        }
    }

    // ========================================================================
    // WEAPON MASTER ( )
    // Choose 4 weapons to gain proficiency with.
    // ========================================================================
    const weaponMaster = await findFeat(Feats.WEAPON_MASTER);
    if (weaponMaster) {
        // We need options for all weapons.
        // Fetch all weapons? Or just categories? "Simple", "Martial" or specific?
        // "Four weapons of your choice". Usually specific weapons.
        // That's a lot of options (all weapons in DB).
        // For seed, maybe just a few examples or skip if too many?
        // Let's skip for now to avoid bloating seed unless requested.
    }

    // ========================================================================
    // MAGIC INITIATE ( )
    // Choose a class: Bard, Cleric, Druid, Sorcerer, Warlock, or Wizard.
    // ========================================================================
    const magicInitiate = await findFeat(Feats.MAGIC_INITIATE);
    if (magicInitiate) {
        const classes = ['Bard', 'Cleric', 'Druid', 'Sorcerer', 'Warlock', 'Wizard'];
        for (const cls of classes) {
            const option = await createChoiceOption(
                '  ',
                cls, // Need translation
                `Magic Initiate (${cls})`
            );
            await linkFeatChoice(magicInitiate.featId, option.choiceOptionId);
        }
    }

    // ========================================================================
    // ELEMENTAL ADEPT ( )
    // Choose one type of damage: acid, cold, fire, lightning, or thunder.
    // ========================================================================
    const elementalAdept = await findFeat(Feats.ELEMENTAL_ADEPT);
    if (elementalAdept) {
        const elements = [
            { name: '', eng: 'Acid' },
            { name: '', eng: 'Cold' },
            { name: '', eng: 'Fire' },
            { name: '', eng: 'Lightning' },
            { name: '', eng: 'Thunder' },
        ];
        for (const el of elements) {
            const option = await createChoiceOption(
                ' ',
                el.name,
                `Elemental Adept (${el.eng})`
            );
            await linkFeatChoice(elementalAdept.featId, option.choiceOptionId);
        }
    }

    // ========================================================================
    // MARTIAL ADEPT ( )
    // Choose two maneuvers from the Battle Master archetype.
    // ========================================================================
    const martialAdept = await findFeat(Feats.MARTIAL_ADEPT);
    if (martialAdept) {
        // We need to find Battle Master maneuvers.
        // They are features linked to Battle Master subclass? Or just features with a tag?
        // Let's assume we can find them by name or they are already seeded as ChoiceOptions for Battle Master.
        // If they are seeded for Battle Master, we can reuse the ChoiceOption?
        // No, ChoiceOption is linked to Class/Subclass via join table.
        // We can link the SAME ChoiceOption to the Feat!
        // Let's try to find existing ChoiceOptions for Battle Master Maneuvers.
        
        // This requires knowing the group name used in SubclassChoiceOptionSeed.
        // Let's assume "Maneuvers".
        const maneuverOptions = await prisma.choiceOption.findMany({
            where: { groupName: '  ' } // Assuming this name
        });

        if (maneuverOptions.length > 0) {
            for (const opt of maneuverOptions) {
                await linkFeatChoice(martialAdept.featId, opt.choiceOptionId);
            }
        }
    }

    // ========================================================================
    // SKILL EXPERT ( )
    // 1. Increase one ability score by 1.
    // 2. Gain proficiency in one skill.
    // 3. Gain expertise in one skill.
    // ========================================================================
    const skillExpert = await findFeat(Feats.SKILL_EXPERT);
    if (skillExpert) {
        // 1. Ability Score
        const abilities = [
            { name: '', eng: 'Strength', code: Ability.STR },
            { name: '', eng: 'Dexterity', code: Ability.DEX },
            { name: '', eng: 'Constitution', code: Ability.CON },
            { name: '', eng: 'Intelligence', code: Ability.INT },
            { name: '', eng: 'Wisdom', code: Ability.WIS },
            { name: '', eng: 'Charisma', code: Ability.CHA },
        ];
        for (const ab of abilities) {
            const option = await createChoiceOption(
                '  ',
                ab.name,
                `Skill Expert Ability (${ab.eng})`
            );
            await linkFeatChoice(skillExpert.featId, option.choiceOptionId);
        }

        // 2. Skill Proficiency
        for (const skill of Object.values(Skills)) {
             const option = await createChoiceOption(
                '  ',
                skill, 
                `Skill Expert Proficiency (${skill})`
            );
            await linkFeatChoice(skillExpert.featId, option.choiceOptionId);
        }

        // 3. Skill Expertise
        for (const skill of Object.values(Skills)) {
             const option = await createChoiceOption(
                '  ',
                skill, 
                `Skill Expert Expertise (${skill})`
            );
            await linkFeatChoice(skillExpert.featId, option.choiceOptionId);
        }
    }

    // ========================================================================
    // HALF-FEATS (ASI Choices)
    // Many feats allow choosing between 2 or more ability scores to increase.
    // ========================================================================
    
    const halfFeatConfigs: { feat: Feats, abilities: Ability[] }[] = [
        { feat: Feats.ATHLETE, abilities: [Ability.STR, Ability.DEX] },
        { feat: Feats.LIGHTLY_ARMORED, abilities: [Ability.STR, Ability.DEX] },
        { feat: Feats.MODERATELY_ARMORED, abilities: [Ability.STR, Ability.DEX] },
        { feat: Feats.OBSERVANT, abilities: [Ability.INT, Ability.WIS] },
        { feat: Feats.TAVERN_BRAWLER, abilities: [Ability.STR, Ability.CON] },
        { feat: Feats.WEAPON_MASTER, abilities: [Ability.STR, Ability.DEX] },
        { feat: Feats.DRAGON_FEAR, abilities: [Ability.STR, Ability.CON, Ability.CHA] },
        { feat: Feats.DRAGON_HIDE, abilities: [Ability.STR, Ability.CON, Ability.CHA] },
        { feat: Feats.ELVEN_ACCURACY, abilities: [Ability.DEX, Ability.INT, Ability.WIS, Ability.CHA] },
        { feat: Feats.FADE_AWAY, abilities: [Ability.DEX, Ability.INT] },
        { feat: Feats.FLAMES_OF_PHLEGETHOS, abilities: [Ability.INT, Ability.CHA] },
        { feat: Feats.ORCISH_FURY, abilities: [Ability.STR, Ability.CON] },
        { feat: Feats.SECOND_CHANCE, abilities: [Ability.DEX, Ability.CON, Ability.CHA] },
        { feat: Feats.SQUAT_NIMBLENESS, abilities: [Ability.STR, Ability.DEX] },
        { feat: Feats.CHEF, abilities: [Ability.CON, Ability.WIS] },
        { feat: Feats.CRUSHER, abilities: [Ability.STR, Ability.CON] },
        { feat: Feats.PIERCER, abilities: [Ability.STR, Ability.DEX] },
        { feat: Feats.SLASHER, abilities: [Ability.STR, Ability.DEX] },
        { feat: Feats.TELEKINETIC, abilities: [Ability.INT, Ability.WIS, Ability.CHA] },
        { feat: Feats.TELEPATHIC, abilities: [Ability.INT, Ability.WIS, Ability.CHA] },
        { feat: Feats.GIFT_OF_THE_GEM_DRAGON, abilities: [Ability.INT, Ability.WIS, Ability.CHA] },
        { feat: Feats.EMBER_OF_GIANTS, abilities: [Ability.STR, Ability.CON, Ability.WIS] },
        { feat: Feats.FURY_OF_GIANTS, abilities: [Ability.STR, Ability.CON, Ability.WIS] },
        { feat: Feats.GUILE_OF_GIANTS, abilities: [Ability.STR, Ability.CON, Ability.WIS] },
        { feat: Feats.KEENNESS_OF_GIANTS, abilities: [Ability.STR, Ability.CON, Ability.WIS] },
        { feat: Feats.SOUL_OF_GIANTS, abilities: [Ability.STR, Ability.CON, Ability.WIS] },
        { feat: Feats.VIGOR_OF_GIANTS, abilities: [Ability.STR, Ability.CON, Ability.WIS] },
        { feat: Feats.FEY_TOUCHED, abilities: [Ability.INT, Ability.WIS, Ability.CHA] },
        { feat: Feats.SHADOW_TOUCHED, abilities: [Ability.INT, Ability.WIS, Ability.CHA] },
    ];

    const abilityNames: Record<Ability, { name: string, eng: string }> = {
        [Ability.STR]: { name: '', eng: 'Strength' },
        [Ability.DEX]: { name: '', eng: 'Dexterity' },
        [Ability.CON]: { name: '', eng: 'Constitution' },
        [Ability.INT]: { name: '', eng: 'Intelligence' },
        [Ability.WIS]: { name: '', eng: 'Wisdom' },
        [Ability.CHA]: { name: '', eng: 'Charisma' },
    };

    for (const config of halfFeatConfigs) {
        const feat = await findFeat(config.feat);
        if (feat) {
            for (const abilityCode of config.abilities) {
                const info = abilityNames[abilityCode];
                const option = await createChoiceOption(
                    ` ${feat.name}`, // e.g. " Athlete"
                    info.name,
                    `${config.feat} Ability (${info.eng})`
                );
                await linkFeatChoice(feat.featId, option.choiceOptionId);
            }
        }
    }

    // ========================================================================
    // RITUAL CASTER ( )
    // Choose a class: Bard, Cleric, Druid, Sorcerer, Warlock, or Wizard.
    // ========================================================================
    const ritualCaster = await findFeat(Feats.RITUAL_CASTER);
    if (ritualCaster) {
        const classes = ['Bard', 'Cleric', 'Druid', 'Sorcerer', 'Warlock', 'Wizard'];
        for (const cls of classes) {
            const option = await createChoiceOption(
                '  ',
                cls, 
                `Ritual Caster (${cls})`
            );
            await linkFeatChoice(ritualCaster.featId, option.choiceOptionId);
        }
    }

    console.log('     !');
};
</file>

<file path="prisma/seed/featChoiceOptionSeed.ts">
import { PrismaClient, Feats, Ability, Skills, DamageType, Classes, Prisma } from "@prisma/client";
import { 
  damageTypeTranslations, 
  engEnumSkills, 
  attributesUkrFull,
  featTranslations,
  classTranslations
} from "../../src/lib/refs/translation";
import { CHOICE_GROUPS } from "./helpers/groupNames";

export const seedFeatChoiceOptions = async (prisma: PrismaClient) => {
  console.log('      (Feats)...');

  // Verify Battle Master maneuvers exist (dependency check)
  const maneuverCount = await prisma.choiceOption.count({
    where: { groupName: CHOICE_GROUPS.BATTLE_MASTER_MANEUVERS }
  });
  
  if (maneuverCount === 0) {
    console.warn("     !  subclassChoiceOptionSeed  .");
  }

  /**
   * Helper to find feat by enum value
   */
  const findFeat = async (name: Feats) => {
    const feat = await prisma.feat.findUnique({ where: { name } });
    if (!feat) console.warn(` Feat ${name} not found!`);
    return feat;
  };

  /**
   * Helper to create or find ChoiceOption
   * @param groupName - Ukrainian group name for UI display
   * @param optionName - Ukrainian option name for UI display
   * @param optionNameEng - UNIQUE English identifier
   * @param features - Array of feature engNames to connect (optional)
   */
  const createChoiceOption = async (
    groupName: string,
    optionName: string,
    optionNameEng: string,
    features: { engName: string }[] = []
  ) => {
    const existing = await prisma.choiceOption.findUnique({
      where: { optionNameEng }
    });

    if (existing) return existing;

    // Find features to connect
    const featureConnects: Prisma.ChoiceOptionFeatureCreateWithoutOptionInput[] = [];
    for (const f of features) {
      const feature = await prisma.feature.findFirst({ where: { engName: f.engName } });
      if (feature) {
        featureConnects.push({ feature: { connect: { featureId: feature.featureId } } });
      } else {
        console.warn(` Feature ${f.engName} not found for choice option ${optionNameEng}`);
      }
    }

    return await prisma.choiceOption.create({
      data: {
        groupName,
        optionName,
        optionNameEng,
        features: {
          create: featureConnects
        }
      }
    });
  };

  /**
   * Helper to link Feat and ChoiceOption (prevents duplicates)
   */
  const linkFeatChoice = async (featId: number, choiceOptionId: number) => {
    const existing = await prisma.featChoiceOption.findUnique({
      where: {
        unique_feat_choice: {
          featId,
          choiceOptionId
        }
      }
    });

    if (!existing) {
      await prisma.featChoiceOption.create({
        data: {
          featId,
          choiceOptionId
        }
      });
    }
  };

  // ========================================================================
  // RESILIENT ()
  // Choose one ability score to increase by 1, and gain proficiency in saving throws
  // ========================================================================
  const resilient = await findFeat(Feats.RESILIENT);
  if (resilient) {
    for (const ability of Object.values(Ability)) {
      const ukrainianName = attributesUkrFull[ability];
      
      const option = await createChoiceOption(
        "Resilient ()",
        ukrainianName,
        `Resilient (${ability})`,
        []
      );
      await linkFeatChoice(resilient.featId, option.choiceOptionId);
    }
    console.log(` Resilient: ${Object.values(Ability).length} ability choices`);
  }

  // ========================================================================
  // SKILLED ()
  // Gain proficiency in any combination of 3 skills or tools
  // ========================================================================
  const skilled = await findFeat(Feats.SKILLED);
  if (skilled) {
    for (const skill of Object.values(Skills)) {
      const skillTranslation = engEnumSkills.find(s => s.eng === skill)?.ukr || skill;
      
      const option = await createChoiceOption(
        "Skilled ()",
        skillTranslation,
        skill, // Just the enum value like "ATHLETICS"
        []
      );
      await linkFeatChoice(skilled.featId, option.choiceOptionId);
    }
    console.log(` Skilled: ${Object.values(Skills).length} skill choices`);
  }

  // ========================================================================
  // MAGIC INITIATE (  )
  // Choose a class: Bard, Cleric, Druid, Sorcerer, Warlock, or Wizard
  // ========================================================================
  const magicInitiate = await findFeat(Feats.MAGIC_INITIATE);
  if (magicInitiate) {
    const casterClasses = [
      Classes.BARD_2014,
      Classes.CLERIC_2014,
      Classes.DRUID_2014,
      Classes.SORCERER_2014,
      Classes.WARLOCK_2014,
      Classes.WIZARD_2014,
    ];
    
    for (const cls of casterClasses) {
      const classNameUkr = classTranslations[cls];
      
      const option = await createChoiceOption(
        "Magic Initiate ()",
        classNameUkr,
        `Magic Initiate (${cls})`,
        []
      );
      await linkFeatChoice(magicInitiate.featId, option.choiceOptionId);
    }
    console.log(` Magic Initiate: ${casterClasses.length} class choices`);
  }

  // ========================================================================
  // ELEMENTAL ADEPT ( )
  // Choose one damage type: acid, cold, fire, lightning, or thunder
  // ========================================================================
  const elementalAdept = await findFeat(Feats.ELEMENTAL_ADEPT);
  if (elementalAdept) {
    const elementalTypes = [
      DamageType.ACID,
      DamageType.COLD,
      DamageType.FIRE,
      DamageType.LIGHTNING,
      DamageType.THUNDER,
    ];

    for (const dmgType of elementalTypes) {
      const ukrainianName = damageTypeTranslations[dmgType];
      
      const option = await createChoiceOption(
        "Elemental Adept ( )",
        ukrainianName,
        `Elemental Adept (${dmgType})`, // e.g., "Elemental Adept (FIRE)"
        []
      );
      
      await linkFeatChoice(elementalAdept.featId, option.choiceOptionId);
    }
    console.log(` Elemental Adept: ${elementalTypes.length} damage type choices`);
  }

  // ========================================================================
  // MARTIAL ADEPT ( )
  // Choose two maneuvers from the Battle Master archetype
  // REUSES existing Battle Master maneuvers from subclassChoiceOptionSeed
  // ========================================================================
  const martialAdept = await findFeat(Feats.MARTIAL_ADEPT);
  if (martialAdept) {
    const maneuverOptions = await prisma.choiceOption.findMany({
      where: {
        groupName: CHOICE_GROUPS.BATTLE_MASTER_MANEUVERS,
        optionNameEng: {
          contains: "(Maneuver)" // All Battle Master maneuvers have this suffix
        }
      }
    });

    if (maneuverOptions.length === 0) {
      console.warn(" Martial Adept: No Battle Master maneuvers found! Run subclassChoiceOptionSeed first.");
    } else {
      for (const opt of maneuverOptions) {
        await linkFeatChoice(martialAdept.featId, opt.choiceOptionId);
      }
      console.log(` Martial Adept: Linked ${maneuverOptions.length} maneuvers`);
    }
  }

  // ========================================================================
  // SKILL EXPERT ( )
  // 1. Increase one ability score by 1
  // 2. Gain proficiency in one skill
  // 3. Gain expertise in one skill
  // ========================================================================
  const skillExpert = await findFeat(Feats.SKILL_EXPERT);
  if (skillExpert) {
    // 1. Ability Score
    for (const ability of Object.values(Ability)) {
      const ukrainianName = attributesUkrFull[ability];
      
      const option = await createChoiceOption(
        "  ",
        ukrainianName,
        `Skill Expert (${ability})`,
        []
      );
      await linkFeatChoice(skillExpert.featId, option.choiceOptionId);
    }

    // 2. Skill Proficiency
    for (const skill of Object.values(Skills)) {
      const skillTranslation = engEnumSkills.find(s => s.eng === skill)?.ukr || skill;
      
      const option = await createChoiceOption(
        "  ",
        skillTranslation,
        `Skill Expert Proficiency (${skill})`,
        []
      );
      await linkFeatChoice(skillExpert.featId, option.choiceOptionId);
    }

    // 3. Expertise
    for (const skill of Object.values(Skills)) {
      const skillTranslation = engEnumSkills.find(s => s.eng === skill)?.ukr || skill;
      
      const option = await createChoiceOption(
        "  ",
        skillTranslation,
        `Skill Expert Expertise (${skill})`,
        []
      );
      await linkFeatChoice(skillExpert.featId, option.choiceOptionId);
    }
    
    console.log(` Skill Expert: ${Object.values(Ability).length} abilities, ${Object.values(Skills).length * 2} skill options`);
  }

  // ========================================================================
  // HALF-FEATS (ASI Choices)
  // Many feats allow choosing between 2 or more ability scores to increase
  // ========================================================================
  const halfFeatConfigs: { feat: Feats, abilities: Ability[] }[] = [
    { feat: Feats.ATHLETE, abilities: [Ability.STR, Ability.DEX] },
    { feat: Feats.LIGHTLY_ARMORED, abilities: [Ability.STR, Ability.DEX] },
    { feat: Feats.MODERATELY_ARMORED, abilities: [Ability.STR, Ability.DEX] },
    { feat: Feats.OBSERVANT, abilities: [Ability.INT, Ability.WIS] },
    { feat: Feats.TAVERN_BRAWLER, abilities: [Ability.STR, Ability.CON] },
    { feat: Feats.WEAPON_MASTER, abilities: [Ability.STR, Ability.DEX] },
    { feat: Feats.DRAGON_FEAR, abilities: [Ability.STR, Ability.CON, Ability.CHA] },
    { feat: Feats.DRAGON_HIDE, abilities: [Ability.STR, Ability.CON, Ability.CHA] },
    { feat: Feats.ELVEN_ACCURACY, abilities: [Ability.DEX, Ability.INT, Ability.WIS, Ability.CHA] },
    { feat: Feats.FADE_AWAY, abilities: [Ability.DEX, Ability.INT] },
    { feat: Feats.FLAMES_OF_PHLEGETHOS, abilities: [Ability.INT, Ability.CHA] },
    { feat: Feats.ORCISH_FURY, abilities: [Ability.STR, Ability.CON] },
    { feat: Feats.SECOND_CHANCE, abilities: [Ability.DEX, Ability.CON, Ability.CHA] },
    { feat: Feats.SQUAT_NIMBLENESS, abilities: [Ability.STR, Ability.DEX] },
    { feat: Feats.CHEF, abilities: [Ability.CON, Ability.WIS] },
    { feat: Feats.CRUSHER, abilities: [Ability.STR, Ability.CON] },
    { feat: Feats.PIERCER, abilities: [Ability.STR, Ability.DEX] },
    { feat: Feats.SLASHER, abilities: [Ability.STR, Ability.DEX] },
    { feat: Feats.TELEKINETIC, abilities: [Ability.INT, Ability.WIS, Ability.CHA] },
    { feat: Feats.TELEPATHIC, abilities: [Ability.INT, Ability.WIS, Ability.CHA] },
    { feat: Feats.GIFT_OF_THE_GEM_DRAGON, abilities: [Ability.INT, Ability.WIS, Ability.CHA] },
    { feat: Feats.EMBER_OF_GIANTS, abilities: [Ability.STR, Ability.CON, Ability.WIS] },
    { feat: Feats.FURY_OF_GIANTS, abilities: [Ability.STR, Ability.CON, Ability.WIS] },
    { feat: Feats.GUILE_OF_GIANTS, abilities: [Ability.STR, Ability.CON, Ability.WIS] },
    { feat: Feats.KEENNESS_OF_GIANTS, abilities: [Ability.STR, Ability.CON, Ability.WIS] },
    { feat: Feats.SOUL_OF_GIANTS, abilities: [Ability.STR, Ability.CON, Ability.WIS] },
    { feat: Feats.VIGOR_OF_GIANTS, abilities: [Ability.STR, Ability.CON, Ability.WIS] },
    { feat: Feats.FEY_TOUCHED, abilities: [Ability.INT, Ability.WIS, Ability.CHA] },
    { feat: Feats.SHADOW_TOUCHED, abilities: [Ability.INT, Ability.WIS, Ability.CHA] },
  ];

  let halfFeatCount = 0;
  for (const config of halfFeatConfigs) {
    const feat = await findFeat(config.feat);
    if (!feat) continue;
    
    const featNameUkr = featTranslations[config.feat] || config.feat;
    
    for (const ability of config.abilities) {
      const abilityNameUkr = attributesUkrFull[ability];
      
      const option = await createChoiceOption(
        `${featNameUkr} ()`,
        abilityNameUkr,
        `${config.feat} (${ability})`,
        []
      );
      await linkFeatChoice(feat.featId, option.choiceOptionId);
    }
    halfFeatCount++;
  }
  console.log(` Half-feats: ${halfFeatCount} feats with ability choices`);

  // ========================================================================
  // RITUAL CASTER ( )
  // Choose a class: Bard, Cleric, Druid, Sorcerer, Warlock, or Wizard
  // ========================================================================
  const ritualCaster = await findFeat(Feats.RITUAL_CASTER);
  if (ritualCaster) {
    const casterClasses = [
      Classes.BARD_2014,
      Classes.CLERIC_2014,
      Classes.DRUID_2014,
      Classes.SORCERER_2014,
      Classes.WARLOCK_2014,
      Classes.WIZARD_2014,
    ];
    
    for (const cls of casterClasses) {
      const classNameUkr = classTranslations[cls];
      
      const option = await createChoiceOption(
        "Ritual Caster ()",
        classNameUkr,
        `Ritual Caster (${cls})`,
        []
      );
      await linkFeatChoice(ritualCaster.featId, option.choiceOptionId);
    }
    console.log(` Ritual Caster: ${casterClasses.length} class choices`);
  }

  console.log('     !');
};
</file>

<file path="prisma/seed/featSeed.ts">
import { Prisma, PrismaClient, Feats, Source, Language, Races, Subraces, ArmorType } from '@prisma/client';

// We now pass the prisma client from the main seed.ts

interface FeatCreateInput {
  name: Feats;
  engName: string;
  source: Source;
  description: string;
  shortDescription: string;
  prerequisiteAbilityScore?: Prisma.JsonValue;
  prerequisiteLevel?: number;
  prerequisiteProficiency?: Prisma.JsonValue;
  prerequisiteSpellcasting?: boolean;
  prerequisiteFeat?: string;
  raceRestriction?: Races[];
  subraceRestriction?: Subraces[];
  grantedASI?: Prisma.JsonValue;
  grantedSkillCount?: number;
  grantedSkills?: Prisma.JsonValue;
  grantedLanguageCount?: number;
  grantedLanguages?: Language[];
  grantedToolProficiencies?: Prisma.JsonValue;
  grantedWeaponProficiencies?: Prisma.JsonValue;
  grantedArmorProficiencies?: ArmorType[];
  grantsFeature?: Prisma.FeatureCreateNestedManyWithoutGrantsByFeatInput;
}

const feats: FeatCreateInput[] = [
  {
    name: Feats.ALERT,
    engName: 'Alert',
    source: Source.PHB,
    shortDescription: '  .         .',
    description: `    ,     :

-    +5  .
-      ,    .
-             ,     .`,
  },
  {
    name: Feats.ATHLETE,
    engName: 'Athlete',
    source: Source.PHB,
    shortDescription: '  :  ,   .',
    description: `    ,    :

-        1,   20.
-    ,       5      .
-      .
-           5 ,   10 .`,
    grantedASI: { STR_OR_DEX: 1 },
  },
  {
    name: Feats.ACTOR,
    engName: 'Actor',
    source: Source.PHB,
    shortDescription: '   .       .',
    description: `    ,    :

-      1,   20.
-       ()   (),       .
-        ,    .    ,   ,   ,   ,   1 .     ()    ()   ,   .`,
    grantedASI: { CHA: 1 },
  },
  {
    name: Feats.CHARGER,
    engName: 'Charger',
    source: Source.PHB,
    shortDescription: ' ,        .',
    description: `    ,     ,         .

     10          ,     +5    [damage roll]   (     ),       10    (       ).`,
  },
  {
    name: Feats.CROSSBOW_EXPERT,
    engName: 'Crossbow Expert',
    source: Source.PHB,
    shortDescription: '   :     .',
    description: `     ,     :

-      ,    .
-    5            .
-         ,     ,    ,   .`,
  },
  {
    name: Feats.DEFENSIVE_DUELIST,
    engName: 'Defensive Duelist',
    source: Source.PHB,
    shortDescription: ' ,    ,     .',
    description: `    ,    ,        ,     ,           ,     .`,
    prerequisiteAbilityScore: { DEX: 13 },
  },
  {
    name: Feats.DUAL_WIELDER,
    engName: 'Dual Wielder',
    source: Source.PHB,
    shortDescription: '   :       .',
    description: `    ,   :

-    +1  ,        .
-      ,          .
-        ,          .`,
  },
  {
    name: Feats.DUNGEON_DELVER,
    engName: 'Dungeon Delver',
    source: Source.PHB,
    shortDescription: '   :         .',
    description: `      ,    ,    :

-       ()   (),     .
-     ,      .
-     ,  .
-    ,     ,  ,     .`,
  },
  {
    name: Feats.DURABLE,
    engName: 'Durable',
    source: Source.PHB,
    shortDescription: '          .',
    description: `  ,    :

-      1,   20.
-     ',   -,   ,     ,      ( 2).`,
    grantedASI: { CON: 1 },
  },
  {
    name: Feats.ELEMENTAL_ADEPT,
    engName: 'Elemental Adept',
    source: Source.PHB,
    shortDescription: '         .',
    description: `    ,    : , , ,   .

,   ,      .  ,       ,   ,     ,    - 1     2.

      .  ,    ,      .`,
    prerequisiteSpellcasting: true,
  },
  {
    name: Feats.GRAPPLER,
    engName: 'Grappler',
    source: Source.PHB,
    shortDescription: ' :       .',
    description: `  ,   ,     .    :

-        ,   .
-     ,    ,  .       .        ,    .`,
    prerequisiteAbilityScore: { STR: 13 },
  },
  {
    name: Feats.GREAT_WEAPON_MASTER,
    engName: 'Great Weapon Master',
    source: Source.PHB,
    shortDescription: '    : -5    +10  .',
    description: `        ,      .    :

-   ,          -   0 ,     ,      .
-  ,       ,    ,     -5   .   ,   +10    .`,
  },
  {
    name: Feats.HEALER,
    engName: 'Healer',
    source: Source.PHB,
    shortDescription: '        .',
    description: `  ,          .    :

-     ,    ,     1 -.
-        ,      16 + 4 -    -,    ' .     -     ,       .`,
  },
  {
    name: Feats.HEAVILY_ARMORED,
    engName: 'Heavily Armored',
    source: Source.PHB,
    shortDescription: '      .',
    description: `  ,     ,   :

-      1,   20.
-     .`,
    prerequisiteProficiency: { armor: ['MEDIUM'] },
    grantedASI: { STR: 1 },
    grantedArmorProficiencies: [ArmorType.HEAVY],
  },
  {
    name: Feats.HEAVY_ARMOR_MASTER,
    engName: 'Heavy Armor Master',
    source: Source.PHB,
    shortDescription: '      ,    .',
    description: `    ,   ,    .    :

-      1,   20.
-     , ,    ,      ,   3.`,
    prerequisiteProficiency: { armor: ['HEAVY'] },
    grantedASI: { STR: 1 },
  },
  {
    name: Feats.INSPIRING_LEADER,
    engName: 'Inspiring Leader',
    source: Source.PHB,
    shortDescription: '   ,    -.',
    description: `   10 ,   ,     .    ,      ( )   30   ,          .     -,    +   .      -    ,       .`,
    prerequisiteAbilityScore: { CHA: 13 },
  },
  {
    name: Feats.KEEN_MIND,
    engName: 'Keen Mind',
    source: Source.PHB,
    shortDescription: '   .        .',
    description: `  ,     ,   .    :

-      1,   20.
-   ,  .
-     ,        .
-     ,        .`,
    grantedASI: { INT: 1 },
  },
  {
    name: Feats.LIGHTLY_ARMORED,
    engName: 'Lightly Armored',
    source: Source.PHB,
    shortDescription: '        .',
    description: `  ,     ,   :

-        1,   20.
-     .`,
    grantedASI: { STR_OR_DEX: 1 },
    grantedArmorProficiencies: [ArmorType.LIGHT],
  },
  {
    name: Feats.LINGUIST,
    engName: 'Linguist',
    source: Source.PHB,
    shortDescription: '  ,      .',
    description: `       .    :

-      1,   20.
-       .
-     .     ,     ,        (     +   ),      .`,
    grantedASI: { INT: 1 },
    grantedLanguageCount: 3,
  },
  {
    name: Feats.LUCKY,
    engName: 'Lucky',
    source: Source.PHB,
    shortDescription: '   3  ,       .',
    description: `    , , ,   ,   .

   3  .  ,      [attack roll],   [ability check]  ,      ,    20.       ,    ,   ,    .   ,   20    ,    .

      ,      .  20,   ,     ,  .

       ,     ,     ;    .

    ,    .`,
  },
  {
    name: Feats.MAGE_SLAYER,
    engName: 'Mage Slayer',
    source: Source.PHB,
    shortDescription: '    :       .',
    description: `     ,   :

-       5   ,     ,        .
-     ,    ,      ,      .
-       ,     5   .`,
  },
  {
    name: Feats.MAGIC_INITIATE,
    engName: 'Magic Initiate',
    source: Source.PHB,
    shortDescription: ' 2   1  1     .',
    description: ` : , , , ,   .            .

,    1       .   ,           ,      ,      .

       :   ,   ;     ;    .`,
  },
  {
    name: Feats.MARTIAL_ADEPT,
    engName: 'Martial Adept',
    source: Source.PHB,
    shortDescription: ' 2     1   6.',
    description: `        .    :

-            [Battle Master]  .           ,    8 +      +   .
-        [superiority dice],    ;       6.       .   ,    ,       .`,
  },
  {
    name: Feats.MEDIUM_ARMOR_MASTER,
    engName: 'Medium Armor Master',
    source: Source.PHB,
    shortDescription: '   :        .',
    description: `      .    :

-           ().
-     ,    3,   2,   ,     16  .`,
    prerequisiteProficiency: { armor: ['MEDIUM'] },
  },
  {
    name: Feats.MOBILE,
    engName: 'Mobile',
    source: Source.PHB,
    shortDescription: '        .',
    description: `    .    :

-     10 .
-     ,          .
-       ,            ,   ,    .`,
  },
  {
    name: Feats.MODERATELY_ARMORED,
    engName: 'Moderately Armored',
    source: Source.PHB,
    shortDescription: '   ,      .',
    description: `  ,        ,   :

-        1,   20.
-       .`,
    prerequisiteProficiency: { armor: ['LIGHT'] },
    grantedASI: { STR_OR_DEX: 1 },
    grantedArmorProficiencies: [ArmorType.MEDIUM, ArmorType.SHIELD],
  },
  {
    name: Feats.MOUNTED_COMBATANT,
    engName: 'Mounted Combatant',
    source: Source.PHB,
    shortDescription: '  :       .',
    description: `  ,   .      ,    :

-          ,       .
-    ,    ,    .
-     ,      ,     ,                .`,
  },
  {
    name: Feats.OBSERVANT,
    engName: 'Observant',
    source: Source.PHB,
    shortDescription: '      .    .',
    description: `     .    :

-        1,   20.
-     ,    ,   ,   ,   ,   .
-    +5      ()    ().`,
    grantedASI: { INT_OR_WIS: 1 },
  },
  {
    name: Feats.POLEARM_MASTER,
    engName: 'Polearm Master',
    source: Source.PHB,
    shortDescription: '    :        .',
    description: `         .    :

-         ,   ,     ,       .       4,     .
-    , ,   ,       ,          .`,
  },
  {
    name: Feats.RESILIENT,
    engName: 'Resilient',
    source: Source.PHB,
    shortDescription: '       .',
    description: `   .    :

-      1,   20.
-    ,    .`,
    grantedASI: { ANY: 1 },
  },
  {
    name: Feats.RITUAL_CASTER,
    engName: 'Ritual Caster',
    source: Source.PHB,
    shortDescription: '        .',
    description: `   ,     .      ,      ,   .

    ,     : , , , ,   .        13,    .

   ,     1-        ,    .         .         .`,
    prerequisiteAbilityScore: { INT: 13, WIS: 13 }, // It's INT or WIS, but JSON usually handles as AND or OR. I'll stick to a simpler representation.
  },
  {
    name: Feats.SAVAGE_ATTACKER,
    engName: 'Savage Attacker',
    source: Source.PHB,
    shortDescription: '           .',
    description: `      ,        ,         - .`,
  },
  {
    name: Feats.SENTINEL,
    engName: 'Sentinel',
    source: Source.PHB,
    shortDescription: '   :       .',
    description: `    ,    .    :

-       ,     0    .
-      ,       ,    .
-     5        ,   (      ),     ,        .`,
  },
  {
    name: Feats.SHARPSHOOTER,
    engName: 'Sharpshooter',
    source: Source.PHB,
    shortDescription: ' :      ,     .',
    description: `       ,   .    :

-             .
-           .
-  ,      ,    ,     -5   .   ,   +10    .`,
  },
  {
    name: Feats.SHIELD_MASTER,
    engName: 'Shield Master',
    source: Source.PHB,
    shortDescription: '         .',
    description: `       ,    .    ,   :

-        ,     ,       5     .
-    ,         -  ,         ,    .
-     ,      ,     ,     ,    ,      .`,
  },
  {
    name: Feats.SKILLED,
    engName: 'Skilled',
    source: Source.PHB,
    shortDescription: '   -      .',
    description: `    -         .`,
    grantedSkillCount: 3,
  },
  {
    name: Feats.SKULKER,
    engName: 'Skulker',
    source: Source.PHB,
    shortDescription: ' :         .',
    description: `        .    :

-    ,      [lightly obscured]  ,    .
-            ,      .
-          (),   .`,
    prerequisiteAbilityScore: { DEX: 13 },
  },
  {
    name: Feats.SPELL_SNIPER,
    engName: 'Spell Sniper',
    source: Source.PHB,
    shortDescription: '       .  1  .',
    description: `  ,       .    :

-    ,    ,   .
-           .
-    ,    .     , , , ,   .         .`,
    prerequisiteSpellcasting: true,
  },
  {
    name: Feats.TAVERN_BRAWLER,
    engName: 'Tavern Brawler',
    source: Source.PHB,
    shortDescription: '     .    .',
    description: `      -  ,    :

-        1,   20.
-     .
-     14 .
-             ,     ,    .`,
    grantedASI: { STR_OR_CON: 1 },
  },
  {
    name: Feats.TOUGH,
    engName: 'Tough',
    source: Source.PHB,
    shortDescription: '  -   ,     .',
    description: `  -   ,     ,     .  ,      ,   -    2 -.`,
  },
  {
    name: Feats.WAR_CASTER,
    engName: 'War Caster',
    source: Source.PHB,
    shortDescription: '  :          .',
    description: `      ,   :

-      ,        ,   .
-      ,        .
-         ,     ,      ,     .      1        .`,
    prerequisiteSpellcasting: true,
  },
  {
    name: Feats.WEAPON_MASTER,
    engName: 'Weapon Master',
    source: Source.PHB,
    shortDescription: '         .',
    description: `     ,   :

-        1,   20.
-         .       .`,
    grantedASI: { STR_OR_DEX: 1 },
  },

  // Batch 2: Racial Feats (Xanathar's Guide to Everything)
  {
    name: Feats.BOUNTIFUL_LUCK,
    engName: 'Bountiful Luck',
    source: Source.XGTE,
    shortDescription: '    1,   .',
    description: `    ,      .

 ,      30   ,  1  20    [attack roll],   [ability check]  ,     ,      .     .

    ,             .`,
    raceRestriction: [Races.HALFLING_2014],
  },
  {
    name: Feats.DRAGON_FEAR,
    engName: 'Dragon Fear',
    source: Source.XGTE,
    shortDescription: '  ,     .',
    description: `  ,     .    :

-    ,     1,   20.
-  ,        ,     .        30   ,      ,       ( = 8 +    +   )      1 .    ,    ,      .`,
    raceRestriction: [Races.DRAGONBORN_2014],
    grantedASI: { STR_OR_CON_OR_CHA: 1 },
  },
  {
    name: Feats.DRAGON_HIDE,
    engName: 'Dragon Hide',
    source: Source.XGTE,
    shortDescription: '   ( 13 + )   .',
    description: `      .    :

-    ,     1,   20.
-   .     ,    13 +   .          .
-    .     14      .`,
    raceRestriction: [Races.DRAGONBORN_2014],
    grantedASI: { STR_OR_CON_OR_CHA: 1 },
  },
  {
    name: Feats.DROW_HIGH_MAGIC,
    engName: 'Drow High Magic',
    source: Source.XGTE,
    shortDescription: '  ,       .',
    description: `     .    :

-    <a href="/spell/detect-magic">  [Detect Magic]</a>      ,    .
-    <a href="/spell/levitate"></a>  <a href="/spell/dispel-magic">  [Dispel Magic]</a>.            .        ,    .        .`,
    subraceRestriction: [Subraces.ELF_DARK_DROW_2014],
  },
  {
    name: Feats.DWARVEN_FORTITUDE,
    engName: 'Dwarven Fortitude',
    source: Source.XGTE,
    shortDescription: ' ,       .',
    description: `  ,      .    :

-      1,   20.
-       ,      ',   .  ,        - ( 1).`,
    raceRestriction: [Races.DWARF_2014],
    grantedASI: { CON: 1 },
  },
  {
    name: Feats.ELVEN_ACCURACY,
    engName: 'Elven Accuracy',
    source: Source.XGTE,
    shortDescription: '        ///.',
    description: `  .    :

-    , ,     1,   20.
-        [attack roll],   , ,   ,        .`,
    raceRestriction: [Races.ELF_2014, Races.HALF_ELF_2014],
    grantedASI: { DEX_OR_INT_OR_WIS_OR_CHA: 1 },
  },
  {
    name: Feats.FADE_AWAY,
    engName: 'Fade Away',
    source: Source.XGTE,
    shortDescription: '      .',
    description: `       ,    .    :

-        1,   20.
-   ,      ,     ,             ,         .       ,       .`,
    raceRestriction: [Races.GNOME_2014],
    grantedASI: { DEX_OR_INT: 1 },
  },
  {
    name: Feats.FEY_TELEPORTATION,
    engName: 'Fey Teleportation',
    source: Source.XGTE,
    shortDescription: '     .    .',
    description: `    .    :

-        1,   20.
-    .
-    <a href="/spell/misty-step">  [Misty Step]</a>          .         .        (  ).`,
    subraceRestriction: [Subraces.ELF_HIGH_2014],
    grantedASI: { INT_OR_CHA: 1 },
    grantedLanguages: [Language.SYLVAN],
  },
  {
    name: Feats.FLAMES_OF_PHLEGETHOS,
    engName: 'Flames of Phlegethos',
    source: Source.XGTE,
    shortDescription: '          .',
    description: `       .    :

-        1,   20.
-         ,    - 1   ,    .
-    ,    ,        .       .       10       10 .  , -    5   ,      ,  14  .`,
    raceRestriction: [Races.TIEFLING_2014],
    grantedASI: { INT_OR_CHA: 1 },
  },
  {
    name: Feats.INFERNAL_CONSTITUTION,
    engName: 'Infernal Constitution',
    source: Source.XGTE,
    shortDescription: '    ,     .',
    description: `   .    :

-      1,   20.
-        .
-       .`,
    raceRestriction: [Races.TIEFLING_2014],
    grantedASI: { CON: 1 },
  },
  {
    name: Feats.ORCISH_FURY,
    engName: 'Orcish Fury',
    source: Source.XGTE,
    shortDescription: '          .',
    description: `    .    :

-        1,   20.
-     ,           .            .
-   ,         [Relentless Endurance],     ,     .`,
    raceRestriction: [Races.HALF_ORC_2014],
    grantedASI: { STR_OR_CON: 1 },
  },
  {
    name: Feats.PRODIGY,
    engName: 'Prodigy',
    source: Source.XGTE,
    shortDescription: '  , ,      .',
    description: `     .    :

-      ,         .
-   ,   .      ,       -   .`,
    raceRestriction: [Races.HUMAN_2014, Races.HALF_ELF_2014, Races.HALF_ORC_2014],
    grantedSkillCount: 1,
    grantedLanguageCount: 1,
  },
  {
    name: Feats.SECOND_CHANCE,
    engName: 'Second Chance',
    source: Source.XGTE,
    shortDescription: '       .',
    description: `      ,    .    :

-    ,     1,   20.
-  ,   ,      [attack roll],     ,      .     .       ,           .`,
    raceRestriction: [Races.HALFLING_2014],
    grantedASI: { DEX_OR_CON_OR_CHA: 1 },
  },
  {
    name: Feats.SQUAT_NIMBLENESS,
    engName: 'Squat Nimbleness',
    source: Source.XGTE,
    shortDescription: '       .',
    description: `         .    :

-        1,   20.
-     5 .
-        .
-       ()   (),      .`,
    raceRestriction: [Races.DWARF_2014, Races.HALFLING_2014, Races.GNOME_2014],
    grantedASI: { STR_OR_DEX: 1 },
    grantedSkillCount: 1,
  },
  {
    name: Feats.WOOD_ELF_MAGIC,
    engName: 'Wood Elf Magic',
    source: Source.XGTE,
    shortDescription: '   ,       .',
    description: `   .    :

-           .      .
-    <a href="/spell/pass-without-trace">   [Pass Without Trace]</a>  <a href="/spell/speak-with-animals">   [Speak with Animals]</a>.            .        ,    .       .`,
    subraceRestriction: [Subraces.ELF_WOOD_2014],
  },

  // Batch 3: Tasha's Cauldron of Everything
  {
    name: Feats.ARTIFICER_INITIATE,
    engName: 'Artificer Initiate',
    source: Source.TCOE,
    shortDescription: '      1  .',
    description: `    .    :

-        1-     .
-                  .      ,     .
-                    [spellcasting focus]  - ,       .
-       .`,
    grantedToolProficiencies: { ANY_ARTISAN_TOOL: 1 },
  },
  {
    name: Feats.CHEF,
    engName: 'Chef',
    source: Source.TCOE,
    shortDescription: ' ,           .',
    description: `,   ,    ,    .    :

-        1,   20.
-     ,      .
-         .    '  ,           '   ,   18  .
-    1      ,     ,     .     8 .     ,  '     -,      .`,
    grantedASI: { CON_OR_WIS: 1 },
    grantedToolProficiencies: { COOKS_UTENSILS: 1 },
  },
  {
    name: Feats.CRUSHER,
    engName: 'Crusher',
    source: Source.TCOE,
    shortDescription: '   :        .',
    description: `     .    :

-        1,   20.
-    ,      ,    ,      5    ,  ,          .
-      ,    ,             .`,
    grantedASI: { STR_OR_CON: 1 },
  },
  {
    name: Feats.ELDRITCH_ADEPT,
    engName: 'Eldritch Adept',
    source: Source.TCOE,
    shortDescription: '    .',
    description: `   ,             .
    
   - ,        ,    .
    
 ,    ,       .`,
    prerequisiteSpellcasting: true, // or Pact Magic
  },
  {
    name: Feats.FEY_TOUCHED,
    engName: 'Fey Touched',
    source: Source.TCOE,
    shortDescription: '      1  (/).   .',
    description: `      .    :

-    ,     1,   20.
-    <a href="/spell/misty-step">  [Misty Step]</a>    1-    .  1-        .                   .      ,    .      ,     .`,
    grantedASI: { INT_OR_WIS_OR_CHA: 1 },
  },
  {
    name: Feats.FIGHTING_INITIATE,
    engName: 'Fighting Initiate',
    source: Source.TCOE,
    shortDescription: '      .',
    description: `             .     ,    .
    
 ,    ,      ,           .`,
    prerequisiteProficiency: { armor: ['LIGHT', 'MEDIUM', 'HEAVY'], weapons: ['martial'] }, // simplified: "proficiency with a martial weapon"
  },
  {
    name: Feats.GUNNER,
    engName: 'Gunner',
    source: Source.TCOE,
    shortDescription: '  :     .',
    description: `    ,    .    :

-      1,   20.
-     .
-       .
-    5            .`,
    grantedASI: { DEX: 1 },
    grantedWeaponProficiencies: { type: ['FIREARMS'] },
  },
  {
    name: Feats.METAMAGIC_ADEPT,
    engName: 'Metamagic Adept',
    source: Source.TCOE,
    shortDescription: ' 2     2  .',
    description: ` ,        .    :

-           .          ,    .  ,    ,        .
-   2      .      ,    .`,
    prerequisiteSpellcasting: true,
  },
  {
    name: Feats.PIERCER,
    engName: 'Piercer',
    source: Source.TCOE,
    shortDescription: '   :       .',
    description: ` ,     .    :

-        1,   20.
-    ,      ,    ,            .
-      ,    ,           ,  .`,
    grantedASI: { STR_OR_DEX: 1 },
  },
  {
    name: Feats.POISONER,
    engName: 'Poisoner',
    source: Source.TCOE,
    shortDescription: '  ,        .',
    description: `      .    :

-           ,  ,      .
-            .
-     ,      .         ,     ,    (   50   ).         ( 14)   28          .`,
    grantedToolProficiencies: { POISONERS_KIT: 1 },
  },
  {
    name: Feats.SHADOW_TOUCHED,
    engName: 'Shadow Touched',
    source: Source.TCOE,
    shortDescription: '     1  (/).   .',
    description: `     .    :

-    ,     1,   20.
-    <a href="/spell/invisibility"></a>    1-    .  1-        .                   .      ,    .      ,     .`,
    grantedASI: { INT_OR_WIS_OR_CHA: 1 },
  },
  {
    name: Feats.SKILL_EXPERT,
    engName: 'Skill Expert',
    source: Source.TCOE,
    shortDescription: ' ,        .',
    description: `   .    :

-         1,   20.
-         .
-   ,   .      ,       -   .`,
    grantedASI: { ANY: 1 },
    grantedSkillCount: 1,
  },
  {
    name: Feats.SLASHER,
    engName: 'Slasher',
    source: Source.TCOE,
    shortDescription: '   :       .',
    description: `     .    :

-        1,   20.
-    ,      ,    ,       10      .
-      ,    ,      .            .`,
    grantedASI: { STR_OR_DEX: 1 },
  },
  {
    name: Feats.TELEKINETIC,
    engName: 'Telekinetic',
    source: Source.TCOE,
    shortDescription: '   ()     .',
    description: `      .    :

-    ,     1,   20.
-    <a href="/spell/mage-hand">  [Mage Hand]</a>.         ,   .      ,     30 .     ,     .
-         ,      30   .        ( = 8 +    +   )     5      .      .`,
    grantedASI: { INT_OR_WIS_OR_CHA: 1 },
  },
  {
    name: Feats.TELEPATHIC,
    engName: 'Telepathic',
    source: Source.TCOE,
    shortDescription: '     .   .',
    description: `      .    :

-    ,     1,   20.
-      - ,      60   .        ,    ,         .  '      .
-    <a href="/spell/detect-thoughts">  [Detect Thoughts]</a>           (  )       .     ,    .     ,     .`,
    grantedASI: { INT_OR_WIS_OR_CHA: 1 },
  },

  // Batch 4: Other sources (Eberron, Fizban's, Bigby's)
  {
    name: Feats.ABERRANT_DRAGONMARK,
    engName: 'Aberrant Dragonmark',
    source: Source.EBERRON,
    shortDescription: '   : ,  1      .',
    description: `    .    :

-      1,   20.
-        .
-     1-    .          ,         .       .
-     1-    ,      ',    .  .   ,    ,   .       30          .`,
    grantedASI: { CON: 1 },
  },
  {
    name: Feats.GIFT_OF_THE_CHROMATIC_DRAGON,
    engName: 'Gift of the Chromatic Dragon',
    source: Source.FTOD,
    shortDescription: '         .',
    description: `      .    :

-            (, , ,   ).  1     14   .          .
-      , , ,   ,     ,         .       ,     ,      .`,
  },
  {
    name: Feats.GIFT_OF_THE_GEM_DRAGON,
    engName: 'Gift of the Gem Dragon',
    source: Source.FTOD,
    shortDescription: '        .',
    description: `        .    :

-    ,     1,   20.
-  ,      10   ,   ,     ,    .        ( = 8 +    +   )   28        10 .         .       ,     ,      .`,
    grantedASI: { INT_OR_WIS_OR_CHA: 1 },
  },
  {
    name: Feats.GIFT_OF_THE_METALLIC_DRAGON,
    engName: 'Gift of the Metallic Dragon',
    source: Source.FTOD,
    shortDescription: '         .',
    description: `      .    :

-    <a href="/spell/cure-wounds">  [Cure Wounds]</a>          ,     .     ,    .     ,    (   ).
-        .        5       ,     ,           .       ,     ,      .`,
  },
  {
    name: Feats.STRIKE_OF_THE_GIANTS,
    engName: 'Strike of the Giants',
    source: Source.BPGOTG,
    shortDescription: '          .',
    description: `    .     (, , , , '  ).
    
   ,          ,           (,       ),      .      .`,
    prerequisiteProficiency: { weapons: ['martial'] }, // simplified
  },
  {
    name: Feats.EMBER_OF_GIANTS,
    engName: 'Ember of the Fire Giant',
    source: Source.BPGOTG,
    shortDescription: '        .',
    description: `    .    :

-    ,     1,   20.
-      .
-       ,     '.        15        ( = 8 +    +   )            .      .`,
    prerequisiteFeat: 'Strike of the Giants',
    grantedASI: { STR_OR_CON_OR_CHA: 1 },
  },
  {
    name: Feats.FURY_OF_GIANTS,
    engName: 'Fury of the Frost Giant',
    source: Source.BPGOTG,
    shortDescription: '           .',
    description: `    .    :

-    ,     1,   20.
-      .
-     10      ,     ,               0     .      .`,
    prerequisiteFeat: 'Strike of the Giants',
    grantedASI: { STR_OR_CON_OR_CHA: 1 },
  },
  {
    name: Feats.GUILE_OF_GIANTS,
    engName: 'Guile of the Cloud Giant',
    source: Source.BPGOTG,
    shortDescription: '         .',
    description: `     .    :

-    ,     1,   20.
-  ,   ,     ,     ,          30 .      .`,
    prerequisiteFeat: 'Strike of the Giants',
    grantedASI: { STR_OR_CON_OR_CHA: 1 },
  },
  {
    name: Feats.KEENNESS_OF_GIANTS,
    engName: 'Keenness of the Stone Giant',
    source: Source.BPGOTG,
    shortDescription: ' ,        .',
    description: `   .    :

-    ,     1,   20.
-      60 .     ,    60 .
-       ,      60     ,   .      .`,
    prerequisiteFeat: 'Strike of the Giants',
    grantedASI: { STR_OR_CON_OR_CHA: 1 },
  },
  {
    name: Feats.SOUL_OF_GIANTS,
    engName: 'Soul of the Storm Giant',
    source: Source.BPGOTG,
    shortDescription: '   /      .',
    description: `    .    :

-    ,     1,   20.
-        .
-         1 .    10          ,        ,  .      .`,
    prerequisiteFeat: 'Strike of the Giants',
    grantedASI: { STR_OR_CON_OR_CHA: 1 },
  },
  {
    name: Feats.VIGOR_OF_GIANTS,
    engName: 'Vigor of the Hill Giant',
    source: Source.BPGOTG,
    shortDescription: '    ,        .',
    description: `    .    :

-    ,     1,   20.
-    ,       ,     ,    .
-     ,        .`,
    prerequisiteFeat: 'Strike of the Giants',
    grantedASI: { STR_OR_CON_OR_CHA: 1 },
  },
];

export async function seedFeats(prisma: PrismaClient) {
  console.log(' Seeding Feats...');
  
  for (const featData of feats) {
    const { grantsFeature, ...rest } = featData;
    
    await prisma.feat.upsert({
      where: { name: rest.name },
      update: {
        ...rest as any,
        grantsFeature: grantsFeature ? {
            deleteMany: {},
            connect: grantsFeature.connect
        } : undefined
      },
      create: {
        ...rest as any,
        grantsFeature: grantsFeature ? {
          create: grantsFeature.create
        } : undefined
      },
    });
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  
  console.log(` Seeded ${feats.length} feats`);
}
</file>

<file path="prisma/seed/infusionSeed.ts">
import { InfusionTargetType, Prisma, PrismaClient } from "@prisma/client"

export const seedInfusions = async ( prisma: PrismaClient ) => {
    console.log( "   (Infusions)..." );

    const infusions: Prisma.InfusionCreateInput[] = [
        {
            name: "  ",
            engName: "Enhanced Arcane Focus",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.WAND_ROD_STAFF,
            requiresAttunement: true,
            spellAttackBonus: 1,
            increasesAtLevel10By: 1,
            feature: { connect: { engName: "Infusion: Enhanced Arcane Focus" } },
        },
        {
            name: " ",
            engName: "Enhanced Defense",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.ARMOR,
            requiresAttunement: false,
            bonusToAC: 1,
            increasesAtLevel10By: 1,
            feature: { connect: { engName: "Infusion: Enhanced Defense" } },
        },
        {
            name: " ",
            engName: "Enhanced Weapon",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.WEAPON,
            requiresAttunement: false,
            bonusToAttackRoll: 1,
            bonusToDamage: 1,
            increasesAtLevel10By: 1,
            feature: { connect: { engName: "Infusion: Enhanced Weapon" } },
        },
        {
            name: " ",
            engName: "Returning Weapon",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.WEAPON,
            requiresAttunement: false,
            bonusToAttackRoll: 1,
            bonusToDamage: 1,
            feature: { connect: { engName: "Infusion: Returning Weapon" } },
        },
        {
            name: " ",
            engName: "Repeating Shot",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.WEAPON,
            requiresAttunement: true,
            bonusToAttackRoll: 1,
            bonusToDamage: 1,
            feature: { connect: { engName: "Infusion: Repeating Shot" } },
        },
        {
            name: " ",
            engName: "Radiant Weapon",
            minArtificerLevel: 6,
            targetType: InfusionTargetType.WEAPON,
            requiresAttunement: true,
            bonusToAttackRoll: 1,
            bonusToDamage: 1,
            feature: { connect: { engName: "Infusion: Radiant Weapon" } },
        },
        {
            name: " ",
            engName: "Mind Sharpener",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.ARMOR,
            requiresAttunement: false,
            feature: { connect: { engName: "Infusion: Mind Sharpener" } },
        },
        {
            name: "  ",
            engName: "Armor of Magical Strength",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.ARMOR,
            requiresAttunement: false,
            feature: { connect: { engName: "Infusion: Armor of Magical Strength" } },
        },
        {
            name: "  ",
            engName: "Spell-Refueling Ring",
            minArtificerLevel: 6,
            targetType: InfusionTargetType.RING,
            requiresAttunement: true,
            restoresSpellSlotUpToLevel: 3,
            feature: { connect: { engName: "Infusion: Spell-Refueling Ring" } },
        },
        {
            name: " ",
            engName: "Repulsion Shield",
            minArtificerLevel: 6,
            targetType: InfusionTargetType.SHIELD,
            requiresAttunement: true,
            bonusToAC: 1,
            feature: { connect: { engName: "Infusion: Repulsion Shield" } },
        },
        {
            name: " ",
            engName: "Resistant Armor",
            minArtificerLevel: 6,
            targetType: InfusionTargetType.ARMOR,
            requiresAttunement: true,
            feature: { connect: { engName: "Infusion: Resistant Armor" } },
        },
        {
            name: "  ",
            engName: "Boots of the Winding Path",
            minArtificerLevel: 6,
            targetType: InfusionTargetType.BOOTS,
            requiresAttunement: true,
            feature: { connect: { engName: "Infusion: Boots of the Winding Path" } },
        },
        {
            name: " ",
            engName: "Helm of Awareness",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.HELMET,
            requiresAttunement: true,
            feature: { connect: { engName: "Infusion: Helm of Awareness" } },
        },
        {
            name: " ",
            engName: "Arcane Propulsion Armor",
            minArtificerLevel: 14,
            targetType: InfusionTargetType.ARMOR,
            requiresAttunement: true,
            speedBonus: 5,
            feature: { connect: { engName: "Infusion: Arcane Propulsion Armor" } },
        },
        {
            name: "-",
            engName: "Homunculus Servant",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.GEM_CRYSTAL,
            requiresAttunement: false,
            feature: { connect: { engName: "Infusion: Homunculus Servant" } },
        },
        // Replicate Magic Item (2nd-level)
        {
            name: ":  ",
            engName: "Replicate: Bag of Holding",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Bag of Holding" } },
        },
        {
            name: ":   ",
            engName: "Replicate: Cap of Water Breathing",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Cap of Water Breathing" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Goggles of Night",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Goggles of Night" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Prosthetic Limb",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Prosthetic Limb" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Rope of Climbing",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Rope of Climbing" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Sending Stones",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Sending Stones" } },
        },
        {
            name: ":   ",
            engName: "Replicate: Wand of Magic Detection",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Wand of Magic Detection" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Wand of Secrets",
            minArtificerLevel: 2,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Wand of Secrets" } },
        },
        // Replicate Magic Item (6th-level)
        {
            name: ":  ",
            engName: "Replicate: Boots of Elvenkind",
            minArtificerLevel: 6,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Boots of Elvenkind" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Cloak of Elvenkind",
            minArtificerLevel: 6,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Cloak of Elvenkind" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Cloak of the Manta Ray",
            minArtificerLevel: 6,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Cloak of the Manta Ray" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Eyes of Charming",
            minArtificerLevel: 6,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Eyes of Charming" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Gloves of Thievery",
            minArtificerLevel: 6,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Gloves of Thievery" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Lantern of Revealing",
            minArtificerLevel: 6,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Lantern of Revealing" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Pipes of Haunting",
            minArtificerLevel: 6,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Pipes of Haunting" } },
        },
        {
            name: ":    ",
            engName: "Replicate: Ring of Water Walking",
            minArtificerLevel: 6,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Ring of Water Walking" } },
        },
        // Replicate Magic Item (10th-level)
        {
            name: ":    ",
            engName: "Replicate: Boots of Striding and Springing",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Boots of Striding and Springing" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Boots of the Winterlands",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Boots of the Winterlands" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Bracers of Archery",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Bracers of Archery" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Brooch of Shielding",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Brooch of Shielding" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Cloak of Protection",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Cloak of Protection" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Eyes of the Eagle",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Eyes of the Eagle" } },
        },
        {
            name: ":   ",
            engName: "Replicate: Gauntlets of Ogre Power",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Gauntlets of Ogre Power" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Gloves of Missile Snaring",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Gloves of Missile Snaring" } },
        },
        {
            name: ":    ",
            engName: "Replicate: Gloves of Swimming and Climbing",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Gloves of Swimming and Climbing" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Hat of Disguise",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Hat of Disguise" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Headband of Intellect",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Headband of Intellect" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Helm of Telepathy",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Helm of Telepathy" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Medallion of Thoughts",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Medallion of Thoughts" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Necklace of Adaptation",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Necklace of Adaptation" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Periapt of Wound Closure",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Periapt of Wound Closure" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Pipes of the Sewers",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Pipes of the Sewers" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Quiver of Ehlonna",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Quiver of Ehlonna" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Ring of Jumping",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Ring of Jumping" } },
        },
        {
            name: ":   ",
            engName: "Replicate: Ring of Mind Shielding",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Ring of Mind Shielding" } },
        },
        {
            name: ":   ",
            engName: "Replicate: Slippers of Spider Climbing",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Slippers of Spider Climbing" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Ventilating Lungs",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Ventilating Lungs" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Winged Boots",
            minArtificerLevel: 10,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Winged Boots" } },
        },
        // Replicate Magic Item (14th-level)
        {
            name: ":  ",
            engName: "Replicate: Amulet of Health",
            minArtificerLevel: 14,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Amulet of Health" } },
        },
        {
            name: ":   ",
            engName: "Replicate: Arcane Propulsion Arm",
            minArtificerLevel: 14,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Arcane Propulsion Arm" } },
        },
        {
            name: ":    ",
            engName: "Replicate: Belt of Hill Giant Strength",
            minArtificerLevel: 14,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Belt of Hill Giant Strength" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Boots of Levitation",
            minArtificerLevel: 14,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Boots of Levitation" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Boots of Speed",
            minArtificerLevel: 14,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Boots of Speed" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Bracers of Defense",
            minArtificerLevel: 14,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Bracers of Defense" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Cloak of the Bat",
            minArtificerLevel: 14,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Cloak of the Bat" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Dimensional Shackles",
            minArtificerLevel: 14,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Dimensional Shackles" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Gem of Seeing",
            minArtificerLevel: 14,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Gem of Seeing" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Horn of Blasting",
            minArtificerLevel: 14,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: false,
            replicatedMagicItem: { connect: { engName: "Horn of Blasting" } },
        },
        {
            name: ":   ",
            engName: "Replicate: Ring of Free Action",
            minArtificerLevel: 14,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Ring of Free Action" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Ring of Protection",
            minArtificerLevel: 14,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Ring of Protection" } },
        },
        {
            name: ":  ",
            engName: "Replicate: Ring of the Ram",
            minArtificerLevel: 14,
            targetType: InfusionTargetType.ANY,
            requiresAttunement: true,
            replicatedMagicItem: { connect: { engName: "Ring of the Ram" } },
        },
    ];

    for ( const it of infusions ) {
        await prisma.infusion.upsert( {
            where: { engName: it.engName },
            update: {},
            create: it as any,
        } );
    }

    console.log( " / " );
};
</file>

<file path="prisma/tools/clean_classFeatureSeed.js">
const fs = require('fs');
const path = 'prisma/seed/classFeatureSeed.ts';
let s = fs.readFileSync(path, 'utf8');
const re = /\{[\s\S]*?engName:\s*'([^']+)'[\s\S]*?\}/g;
let m;
const items = [];
while ((m = re.exec(s))) {
  const block = m[0];
  const eng = m[1];
  const descMatch = /description\s*:\s*'([\s\S]*?)'\s*(,|$)/m.exec(block);
  const desc = descMatch ? descMatch[1] : '';
  items.push({ eng, block, descLen: desc.trim().length });
}
if (items.length === 0) {
  console.error('No feature blocks found. Aborting.');
  process.exit(1);
}
// Determine bounds of matched region
const firstMatch = re.exec(s); // move pointer
// Reset and re-extract positions
let all = [];
re.lastIndex = 0;
while ((m = re.exec(s))) {
  all.push({ start: m.index, end: re.lastIndex, block: m[0], eng: m[1] });
}
const regionStart = all[0].start;
const regionEnd = all[all.length - 1].end;
// Group by engName and pick block with maximum descLen
const map = new Map();
for (const it of items) {
  if (!map.has(it.eng) || map.get(it.eng).descLen < it.descLen) map.set(it.eng, it);
}
const kept = [...map.values()].map(x => x.block);
// Ensure shortDescription exists in kept blocks; derive by taking first 160 chars of description without HTML
function deriveShort(block) {
  if (/shortDescription\s*:/.test(block)) return block;
  const descMatch = /description\s*:\s*'([\s\S]*?)'\s*(,|$)/m.exec(block);
  const desc = descMatch ? descMatch[1].replace(/<[^>]+>/g, '').replace(/\s+/g, ' ').trim() : '';
  const short = desc.length > 160 ? desc.slice(0, 157).trim() + '...' : desc;
  // insert before the final closing brace of the object
  return block.replace(/\}\s*$/,'  ,\n  shortDescription: \'' + short.replace(/'/g, "\\'") + '\'\n}');
}
const normalized = kept.map(deriveShort);
// Build new file content by replacing region with normalized blocks joined by ',\n'
const newRegion = normalized.join(',\n\n');
const newContent = s.slice(0, regionStart) + newRegion + s.slice(regionEnd);
fs.writeFileSync(path, newContent, 'utf8');
console.log('Wrote cleaned file with', normalized.length, 'unique features.');
</file>

<file path="prisma/tools/find_dups.js">
const fs = require('fs');
const path = 'prisma/seed/classFeatureSeed.ts';
const s = fs.readFileSync(path, 'utf8');
const re = /\{[\s\S]*?engName:\s*'([^']+)'[\s\S]*?\}/g;
const map = new Map();
let m;
while ((m = re.exec(s))) {
  const block = m[0];
  const name = m[1];
  const hasShort = /shortDescription\s*:/.test(block);
  const descMatch = /description\s*:\s*'([\s\S]*?)'\s*,/m.exec(block);
  const descLen = descMatch ? descMatch[1].trim().length : 0;
  const line = s.slice(0, m.index).split('\n').length + 1;
  if (!map.has(name)) map.set(name, []);
  map.get(name).push({ line, hasShort, descLen, preview: block.slice(0, 140).replace(/\n/g, ' ') });
}
const dups = [...map.entries()].filter(([k, v]) => v.length > 1).map(([k, v]) => ({ engName: k, occurrences: v }));
console.log(JSON.stringify(dups, null, 2));
</file>

<file path="prisma/seed_variant.ts">
import 'dotenv/config';
import { prisma } from "@/lib/prisma";
import { seedRaceVariants } from "./seed/raceVariantSeed";

async function main() {
    console.log('Starting seed variants...')
    await seedRaceVariants(prisma)
}

main()
    .catch((e) => {
        console.error(e)
        process.exit(1)
    })
    .finally(async () => {
        await prisma.$disconnect()
    })
</file>

<file path="src/app/actions/level-up.ts">
'use server'

import { prisma } from '@/lib/prisma';
import { FeatureDisplayType, FeatureMechanic } from '@prisma/client';

export type LevelUpFeature = {
  featureId: number;
  name: string;
  description: string;
  displayType: FeatureDisplayType[];
  mechanicType: FeatureMechanic | null;
  mechanicMetadata: unknown;
  // If it's a choice, we populate this
  choiceData?: {
    type: 'SUBCLASS' | 'SPELLS' | 'ASI' | 'SPECIFIC';
    options?: {
      id: number; // subclassId, choiceOptionId, spellId
      name: string;
      description?: string;
      payload?: unknown; // extra data
    }[];
    count?: number; // how many to pick
    source?: string; // for SPECIFIC
  };
  isAutomatic: boolean;
};

export type LevelUpInfo = {
  targetLevel: number;
  classId: number;
  className: string;
  features: LevelUpFeature[];
};

export async function getLevelUpInfo(persId: number, targetLevel: number): Promise<LevelUpInfo | null> {
  const pers = await prisma.pers.findUnique({
    where: { persId },
    include: {
      class: true,
    }
  });

  if (!pers || !pers.class) return null;

  // Fetch features granted at this level
  const classFeatures = await prisma.classFeature.findMany({
    where: {
      classId: pers.classId,
      levelGranted: targetLevel,
    },
    include: {
      feature: true,
    },
    orderBy: {
      displayOrder: 'asc',
    }
  });

  const features: LevelUpFeature[] = [];

  for (const cf of classFeatures) {
    const f = cf.feature;
    const isAutomatic = cf.mechanicType === FeatureMechanic.PASSIVE || cf.mechanicType === null;
    
    let choiceData: LevelUpFeature['choiceData'] = undefined;

    if (!isAutomatic) {
      if (cf.mechanicType === FeatureMechanic.CHOICE_SUBCLASS) {
        // Fetch available subclasses
        const subclasses = await prisma.subclass.findMany({
          where: { classId: pers.classId },
        });
        choiceData = {
          type: 'SUBCLASS',
          options: subclasses.map(s => ({
            id: s.subclassId,
            name: s.name,
            description: s.description ?? undefined,
          })),
          count: 1,
        };
      } else if (cf.mechanicType === FeatureMechanic.CHOICE_ASI) {
        choiceData = {
          type: 'ASI',
          count: 2, // Usually 2 points
        };
      } else if (cf.mechanicType === FeatureMechanic.CHOICE_SPECIFIC) {
        const meta = cf.mechanicMetadata as unknown as { options_source?: string; pick_count?: number } | null;
        const source = meta?.options_source;
        if (source) {
          const options = await prisma.choiceOption.findMany({
            where: { groupName: source },
          });
          choiceData = {
            type: 'SPECIFIC',
            source,
            count: meta?.pick_count || 1,
            options: options.map(o => ({
              id: o.choiceOptionId,
              name: o.optionName,
              payload: o.prerequisites,
            })),
          };
        }
      }
      // TODO: Handle CHOICE_SPELLS if needed
    }

    features.push({
      featureId: f.featureId,
      name: f.name,
      description: f.description,
      displayType: f.displayType,
      mechanicType: cf.mechanicType,
      mechanicMetadata: cf.mechanicMetadata,
      choiceData,
      isAutomatic,
    });
  }

  return {
    targetLevel,
    classId: pers.classId,
    className: pers.class?.name || '',
    features,
  };
}

export type LevelUpSelections = {
  subclassId?: number;
  asi?: { stat: string; value: number }[]; // e.g. [{stat: 'STR', value: 2}] or [{stat: 'STR', value: 1}, {stat: 'DEX', value: 1}]
  specificChoices?: {
    featureId: number; // The parent feature ID (e.g. Fighting Style)
    choiceOptionId: number;
  }[];
  spellIds?: number[]; // For CHOICE_SPELLS - spell IDs to learn at this level
};

export async function commitLevelUp(persId: number, selections: LevelUpSelections): Promise<{ success: boolean; newLevel?: number; error?: string }> {
  try {
    const pers = await prisma.pers.findUnique({ where: { persId } });
    if (!pers) return { success: false, error: '  ' };

  const nextLevel = pers.level + 1;

  // Start transaction
  await prisma.$transaction(async (tx) => {
    // 1. Update Level
    await tx.pers.update({
      where: { persId },
      data: { level: nextLevel },
    });

    // 2. Fetch features for this level
    const classFeatures = await tx.classFeature.findMany({
      where: {
        classId: pers.classId,
        levelGranted: nextLevel,
      },
      include: { feature: true },
    });

    let currentSubclassId = pers.subclassId;

    for (const cf of classFeatures) {
      // Automatic features
      if (cf.mechanicType === FeatureMechanic.PASSIVE || cf.mechanicType === null) {
        await tx.persFeature.create({
          data: {
            persId,
            featureId: cf.featureId,
          },
        });
      }
      
      // Subclass
      if (cf.mechanicType === FeatureMechanic.CHOICE_SUBCLASS) {
        if (!selections.subclassId) {
          throw new Error('Subclass selection missing');
        }
        await tx.pers.update({
          where: { persId },
          data: { subclassId: selections.subclassId },
        });
        currentSubclassId = selections.subclassId;
      }

      // ASI
      if (cf.mechanicType === FeatureMechanic.CHOICE_ASI) {
        if (!selections.asi || selections.asi.length === 0) {
          throw new Error('ASI selection missing');
        }
        // Apply stats
        const updateData: Record<string, { increment: number }> = {};
        for (const boost of selections.asi) {
          const stat = boost.stat.toLowerCase(); // str, dex...
          // Need to read current value? Or just increment?
          // Prisma update with increment is safer
          updateData[stat] = { increment: boost.value };
        }
        await tx.pers.update({
          where: { persId },
          data: updateData,
        });
        // Also record the ASI feature itself?
        await tx.persFeature.create({
          data: { persId, featureId: cf.featureId },
        });
      }

      // Spells (for casters at certain levels)
      if (cf.mechanicType === FeatureMechanic.CHOICE_SPELLS) {
        if (selections.spellIds && selections.spellIds.length > 0) {
          await tx.persSpell.createMany({
            data: selections.spellIds.map(spellId => ({
              persId,
              spellId,
              learnedAtLevel: nextLevel,
            })),
            skipDuplicates: true,
          });
        }
        // Record the feature that granted spells
        await tx.persFeature.create({
          data: { persId, featureId: cf.featureId },
        });
      }

      // Specific Choices (Fighting Style, etc.)
      if (cf.mechanicType === FeatureMechanic.CHOICE_SPECIFIC) {
        const choice = selections.specificChoices?.find(c => c.featureId === cf.featureId);
        if (!choice) throw new Error(`Choice missing for feature ${cf.feature.name}`);

        // Record the parent feature
        await tx.persFeature.create({
          data: { persId, featureId: cf.featureId },
        });

        // Find the chosen option and its granted feature
        const option = await tx.choiceOption.findUnique({
          where: { choiceOptionId: choice.choiceOptionId },
          include: { features: true }
        });

        if (option && option.features.length > 0) {
          for (const granted of option.features) {
             await tx.persFeature.create({
               data: { persId, featureId: granted.featureId },
             });
          }
        }
      }
    }

    // 3. Apply Subclass Features (if any)
    if (currentSubclassId) {
        const subclassFeatures = await tx.subclassFeature.findMany({
          where: {
            subclassId: currentSubclassId,
            levelGranted: nextLevel,
          },
          include: { feature: true },
        });

        for (const scf of subclassFeatures) {
           // Check if already added
           const exists = await tx.persFeature.findUnique({
             where: {
               persId_featureId: {
                 persId,
                 featureId: scf.featureId
               }
             }
           });
           if (!exists) {
             await tx.persFeature.create({
               data: {
                 persId,
                 featureId: scf.featureId,
               }
             });
           }
        }
    }
  });
  
  return { success: true, newLevel: nextLevel };
  } catch (error) {
    console.error('Level-up error:', error);
    const message = error instanceof Error ? error.message : ' .   .';
    return { success: false, error: message };
  }
}

export type LevelUpChoicesInput = {
  persId: number;
  targetLevel: number;
  choices: {
    featureId: number;
    mechanicType: FeatureMechanic;
    subclassId?: number;
    abilityIncreases?: { ability: string; amount: number }[];
    spellIds?: number[];
    choiceOptionIds?: number[];
  }[];
};

export async function saveLevelUpChoices(input: LevelUpChoicesInput): Promise<{ success: boolean; error?: string; newLevel?: number }> {
  const pers = await prisma.pers.findUnique({
    where: { persId: input.persId },
    select: { level: true },
  });

  if (!pers) return { success: false, error: "  " };
  if (pers.level !== input.targetLevel - 1) {
    return { success: false, error: `   ${input.targetLevel - 1} ` };
  }

  const selections: LevelUpSelections = {};

  for (const c of input.choices) {
    if (c.mechanicType === FeatureMechanic.CHOICE_SUBCLASS && c.subclassId) {
      selections.subclassId = c.subclassId;
    }
    if (c.mechanicType === FeatureMechanic.CHOICE_ASI && c.abilityIncreases) {
      selections.asi = c.abilityIncreases.map((inc) => ({ stat: inc.ability, value: inc.amount }));
    }
    if (c.mechanicType === FeatureMechanic.CHOICE_SPELLS && c.spellIds) {
      selections.spellIds = c.spellIds;
    }
    if (c.mechanicType === FeatureMechanic.CHOICE_SPECIFIC && c.choiceOptionIds && c.choiceOptionIds.length > 0) {
      selections.specificChoices = (selections.specificChoices ?? []).concat(
        c.choiceOptionIds.map((choiceOptionId) => ({
          featureId: c.featureId,
          choiceOptionId,
        }))
      );
    }
  }

  const result = await commitLevelUp(input.persId, selections);
  return result.success
    ? { success: true, newLevel: result.newLevel }
    : { success: false, error: result.error ?? " " };
}
</file>

<file path="src/app/api/character/level-up/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { getLevelUpSteps } from '@/lib/actions/character-logic';
import { confirmLevelUp } from '@/lib/actions/character-transaction';
import { confirmMulticlassLevelUp } from '@/lib/actions/character-transaction-multiclass';

export async function GET(req: NextRequest) {
  const searchParams = req.nextUrl.searchParams;
  const persId = Number(searchParams.get('persId'));
  const classId = searchParams.get('classId') ? Number(searchParams.get('classId')) : undefined;

  if (!persId) {
    return NextResponse.json({ error: 'Missing persId' }, { status: 400 });
  }

  try {
    const result = await getLevelUpSteps(persId, classId);
    return NextResponse.json(result);
  } catch (error) {
    console.error('Error fetching level up steps:', error);
    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });
  }
}

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const { persId, choices, isMulticlass } = body;

    if (!persId || !choices) {
      return NextResponse.json({ error: 'Missing required fields' }, { status: 400 });
    }

    let result;
    if (isMulticlass) {
        result = await confirmMulticlassLevelUp({ persId, choices });
    } else {
        // We need to determine the new level. In a real app, this comes from the session or calculated
        // For now, we'll fetch the character and increment
        // This logic should ideally be inside confirmLevelUp or passed from client securely
        // Simplified for this example:
        const newLevel = 2; // Placeholder! Logic needs to be robust
        result = await confirmLevelUp({ persId, choices, newLevel });
    }

    if (!result.success) {
      return NextResponse.json({ error: result.error }, { status: 400 });
    }

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Error confirming level up:', error);
    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/spells/print/route.ts">
import { NextResponse } from "next/server";

import { prisma } from "@/lib/prisma";

import { existsSync } from "node:fs";

import { remark } from "remark";
import remarkGfm from "remark-gfm";
import remarkHtml from "remark-html";

import chromium from "@sparticuz/chromium";
import puppeteer, { type Browser } from "puppeteer-core";

type Body = {
  spellIds?: unknown;
};

function parseSpellIdsFromUnknown(value: unknown): number[] {
  if (!Array.isArray(value) || value.length === 0) return [];
  return value
    .map((v) => Number(v))
    .filter((n) => Number.isFinite(n))
    .map((n) => Math.trunc(n));
}

function parseSpellIdsFromQuery(url: URL): number[] {
  const raw = url.searchParams.get("ids") ?? url.searchParams.get("spellIds") ?? "";
  if (!raw.trim()) return [];
  return raw
    .split(",")
    .map((v) => Number(v.trim()))
    .filter((n) => Number.isFinite(n))
    .map((n) => Math.trunc(n));
}

async function markdownToHtml(markdown: string) {
  const file = await remark().use(remarkGfm).use(remarkHtml, { sanitize: false }).process(markdown);
  return String(file);
}

function escapeHtml(text: string) {
  return text
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}

function levelLabel(level: number) {
  return level === 0 ? "" : ` ${level}`;
}

function getLocalPuppeteerExecutablePath() {
  const fromEnv =
    process.env.PUPPETEER_EXECUTABLE_PATH ||
    process.env.CHROME_PATH ||
    process.env.GOOGLE_CHROME_BIN ||
    process.env.CHROMIUM_PATH;

  if (fromEnv && existsSync(fromEnv)) return fromEnv;

  // Common macOS locations
  const candidates = [
    "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome",
    "/Applications/Google Chrome Canary.app/Contents/MacOS/Google Chrome Canary",
    "/Applications/Chromium.app/Contents/MacOS/Chromium",
    "/Applications/Microsoft Edge.app/Contents/MacOS/Microsoft Edge",
    "/Applications/Brave Browser.app/Contents/MacOS/Brave Browser",
  ];

  for (const p of candidates) {
    if (existsSync(p)) return p;
  }

  return undefined;
}

export async function POST(req: Request) {
  let body: Body;
  try {
    body = (await req.json()) as Body;
  } catch {
    return NextResponse.json({ error: " JSON" }, { status: 400 });
  }

  const spellIds = parseSpellIdsFromUnknown(body.spellIds);
  if (spellIds.length === 0) {
    return NextResponse.json({ error: "spellIds    " }, { status: 400 });
  }

  return generatePdf(spellIds);
}

export async function GET(req: Request) {
  const url = new URL(req.url);
  const spellIds = parseSpellIdsFromQuery(url);
  if (spellIds.length === 0) {
    return NextResponse.json({ error: "ids     ( )" }, { status: 400 });
  }

  return generatePdf(spellIds);
}

async function generatePdf(spellIds: number[]) {

  const spells = await prisma.spell.findMany({
    where: { spellId: { in: spellIds } },
    orderBy: [{ level: "asc" }, { name: "asc" }],
    select: {
      spellId: true,
      name: true,
      level: true,
      school: true,
      castingTime: true,
      range: true,
      duration: true,
      components: true,
      description: true,
      source: true,
    },
  });

  const sections = await Promise.all(
    spells.map(async (s) => {
      const descriptionHtml = await markdownToHtml(s.description);
      return {
        ...s,
        source: String(s.source),
        descriptionHtml,
      };
    })
  );

  const html = `<!doctype html>
<html lang="uk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Spells Print</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600&family=Noto+Serif:wght@600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      @page { size: letter portrait; margin: 16mm 12mm; }
      * { box-sizing: border-box; }
      body {
        font-family: "Noto Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        color: #0f172a;
        background: #ffffff;
        margin: 0;
      }
      .wrap { padding: 0; }
      .columns {
        column-count: 2;
        column-gap: 14px;
        column-fill: auto;
      }
      .spell {
        display: block;
        padding: 0 0 10px 0;
        margin: 0 0 12px 0;
        border-bottom: 1px solid rgba(15, 23, 42, 0.18);
        break-inside: avoid-column;
        page-break-inside: avoid;
      }
      .header { display:flex; align-items: baseline; justify-content: space-between; gap: 12px; }
      .name { font-family: "Noto Serif", Georgia, "Times New Roman", serif; font-size: 18px; font-weight: 700; margin: 0; }
      .meta { font-size: 11px; color: rgba(15,23,42,0.65); text-align: right; white-space: nowrap; }
      .sub { margin-top: 6px; display:flex; gap: 10px; flex-wrap: wrap; font-size: 12px; color: rgba(15,23,42,0.8); }
      .grid { margin-top: 10px; display:grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .cell { border: 1px solid rgba(15,23,42,0.12); border-radius: 10px; padding: 8px; }
      .label { font-size: 10px; color: rgba(15,23,42,0.6); }
      .val { margin-top: 2px; font-size: 12px; }
      .desc { margin-top: 10px; font-size: 12px; line-height: 1.5; }
      .desc h1 { font-size: 14px; margin: 10px 0 6px 0; font-weight: 700; }
      .desc h2 { font-size: 13px; margin: 10px 0 6px 0; font-weight: 700; }
      .desc h3 { font-size: 12px; margin: 10px 0 6px 0; font-weight: 700; }
      .desc p { margin: 0 0 8px 0; }
      .desc table { width: 100%; border-collapse: collapse; margin: 8px 0; }
      .desc th, .desc td { border: 1px solid rgba(15,23,42,0.2); padding: 6px; text-align: left; }
      .desc ul, .desc ol { margin: 0 0 8px 18px; }
      .generated { column-span: all; margin-top: 14px; font-size: 10px; color: rgba(15,23,42,0.6); }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="columns">
      ${sections
        .map(
          (s) => `
      <section class="spell">
        <div class="header">
          <h1 class="name">${escapeHtml(s.name)}</h1>
          <div class="meta">${escapeHtml(String(s.source))}</div>
        </div>
        <div class="sub">
          <div><strong>${escapeHtml(levelLabel(s.level))}</strong></div>
          <div><em>${escapeHtml(s.school || "")}</em></div>
        </div>
        <div class="grid">
          <div class="cell"><div class="label"> </div><div class="val">${escapeHtml(s.castingTime)}</div></div>
          <div class="cell"><div class="label"></div><div class="val">${escapeHtml(s.duration)}</div></div>
          <div class="cell"><div class="label"></div><div class="val">${escapeHtml(s.range)}</div></div>
          <div class="cell"><div class="label"></div><div class="val">${escapeHtml(s.components || "")}</div></div>
        </div>
        <div class="desc">${s.descriptionHtml}</div>
      </section>`
        )
        .join("\n")}
      </div>
      <div class="generated">  spells.holota.family | pers.holota.family</div>
    </div>
  </body>
</html>`;

  let browser: Browser | null = null;

  try {
    const isVercelLike = Boolean(process.env.VERCEL) || Boolean(process.env.AWS_LAMBDA_FUNCTION_NAME);

    const executablePath = isVercelLike ? await chromium.executablePath() : getLocalPuppeteerExecutablePath();

    if (!executablePath) {
      throw new Error(
        "Puppeteer   .     Chrome/Chromium   PUPPETEER_EXECUTABLE_PATH ( CHROME_PATH)."
      );
    }

    browser = await puppeteer.launch({
      args: isVercelLike ? chromium.args : ["--no-sandbox", "--disable-setuid-sandbox"],
      executablePath,
      headless: true,
    });

    const page = await browser.newPage();
    await page.setContent(html, { waitUntil: "networkidle0" });

    const pdfBuffer = await page.pdf({
      printBackground: true,
      format: "letter",
      margin: { top: "16mm", right: "12mm", bottom: "16mm", left: "12mm" },
    });

    const pdfBytes = Uint8Array.from(pdfBuffer);
    const pdfBlob = new Blob([pdfBytes], { type: "application/pdf" });

    return new NextResponse(pdfBlob, {
      status: 200,
      headers: {
        "content-type": "application/pdf",
        "content-disposition": "inline; filename=spells.pdf",
        "cache-control": "no-store",
      },
    });
  } catch (error) {
    console.error("PDF generation failed:", error);
    return NextResponse.json({ error: "   PDF" }, { status: 500 });
  } finally {
    await browser?.close();
  }
}
</file>

<file path="src/app/pers/[id]/levelup/page.tsx">
import { getLevelUpInfo } from "@/lib/actions/levelup";
import { notFound } from "next/navigation";
import LevelUpWizard from "@/lib/components/levelUp/LevelUpWizard";

export default async function Page({ params }: { params: Promise<{ id: string }> }) {
  const { id: idStr } = await params;
  const id = parseInt(idStr);
  if (isNaN(id)) notFound();

  const info = await getLevelUpInfo(id);
  
  if ('error' in info) {
      // Handle error (e.g. unauthorized, max level)
      return <div>Error: {info.error}</div>;
  }

  return <LevelUpWizard info={info} />;
}
</file>

<file path="src/app/pers/[id]/print/actions.ts">
"use server";

import { auth } from "@/lib/auth";
import { generateCharacterPdf } from "@/server/pdf/generateCharacterPdf";
import type { PrintConfig } from "@/server/pdf/types";

export async function generateCharacterPdfAction(persId: number, config: PrintConfig) {
  const session = await auth();
  if (!session?.user?.email) throw new Error("Unauthorized");

  const pdfBytes = await generateCharacterPdf(persId, session.user.email, config);

  return {
    contentType: "application/pdf",
    data: Buffer.from(pdfBytes).toString("base64"),
  };
}
</file>

<file path="src/app/pers/[id]/page.tsx">
import { getCharacterFeaturesGrouped, getPersById } from "@/lib/actions/pers";
import { notFound } from "next/navigation";
import CharacterSheet from "@/lib/components/characterSheet/CharacterSheet";

export default async function Page({ params }: { params: Promise<{ id: string }> }) {
  const { id: idStr } = await params;
  const id = parseInt(idStr);
  if (isNaN(id)) notFound();

  const pers = await getPersById(id);
  if (!pers) notFound();

  const groupedFeatures = await getCharacterFeaturesGrouped(id);

  return <CharacterSheet pers={pers} groupedFeatures={groupedFeatures} />;
}
</file>

<file path="src/app/pers/home/page.tsx">
import { getUserPerses } from "@/lib/actions/pers";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import Link from "next/link";
import { Plus } from "lucide-react";
import { translateValue } from "@/lib/components/characterCreator/infoUtils";
import { SnapshotHistoryModal } from "@/lib/components/characterSheet/SnapshotHistoryModal";

export default async function Page() {
  const perses = await getUserPerses();

  return (
    <div className="container mx-auto py-8 px-4">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold"> </h1>
        <Link href="/pers">
          <Button>
            <Plus className="mr-2 h-4 w-4" /> 
          </Button>
        </Link>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {perses.map((pers) => (
          <Link href={`/pers/${pers.persId}`} key={pers.persId} className="block hover:no-underline">
            <Card className="h-full hover:shadow-lg transition-shadow cursor-pointer relative group">
              <div className="absolute top-4 right-4 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                <SnapshotHistoryModal persId={pers.persId} characterName={pers.name} />
              </div>
              <CardHeader>
                <CardTitle className="pr-10">{pers.name}</CardTitle>
                <CardDescription>
                  {translateValue(pers.race.name)} {translateValue(pers.class.name)} {pers.level}
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="flex justify-between text-sm text-muted-foreground">
                  <span>
                    HP: {pers.currentHp}/{pers.maxHp}
                  </span>
                  <span>: {translateValue(pers.background.name)}</span>
                </div>
              </CardContent>
            </Card>
          </Link>
        ))}

        {perses.length === 0 && (
          <div className="col-span-full text-center py-12 text-muted-foreground">
                .  !
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/app/pers/share/[token]/page.tsx">
import { getCharacterFeaturesGrouped } from "@/lib/actions/pers";
import { getPersByShareToken } from "@/lib/actions/share-actions";
import { notFound } from "next/navigation";
import CharacterSheet from "@/lib/components/characterSheet/CharacterSheet";
import { PersWithRelations } from "@/lib/actions/pers";

export default async function Page({ params }: { params: Promise<{ token: string }> }) {
  const { token } = await params;

  const pers = await getPersByShareToken(token);
  if (!pers) notFound();

  const groupedFeatures = await getCharacterFeaturesGrouped(pers.persId);

  return <CharacterSheet pers={pers as PersWithRelations} groupedFeatures={groupedFeatures} isPublicView={true} />;
}
</file>

<file path="src/app/spells/page.tsx">
import { Suspense } from "react";
import { prisma } from "@/lib/prisma";
import { SpellsClient, type SpellListItem } from "./spells-client";

export const dynamic = "force-dynamic";

export default async function SpellsPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | string[] | undefined>>;
}) {
  const resolvedSearchParams = await searchParams;

  const spells = await prisma.spell.findMany({
    orderBy: [{ level: "asc" }, { name: "asc" }],
    select: {
      spellId: true,
      name: true,
      engName: true,
      level: true,
      school: true,
      castingTime: true,
      duration: true,
      range: true,
      components: true,
      description: true,
      source: true,
      hasRitual: true,
      hasConcentration: true,
      spellClasses: { select: { className: true } },
      spellRaces: { select: { raceName: true } },
    },
  });

  const items: SpellListItem[] = spells.map((s) => ({
    spellId: s.spellId,
    name: s.name,
    engName: s.engName,
    level: s.level,
    school: s.school,
    castingTime: s.castingTime,
    duration: s.duration,
    range: s.range,
    components: s.components,
    description: s.description,
    source: String(s.source),
    hasRitual: s.hasRitual,
    hasConcentration: s.hasConcentration,
    spellClasses: s.spellClasses,
    spellRaces: s.spellRaces,
  }));

  return (
    <div className="h-full w-full">
      <Suspense fallback={null}>
        <SpellsClient spells={items} initialSearchParams={resolvedSearchParams} />
      </Suspense>
    </div>
  );
}
</file>

<file path="src/app/spells/spells-client.tsx">
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { motion } from "framer-motion";
import {
  Filter,
  Printer,
  Search,
  UserPlus,
  Check,
  Loader2,
  X,
} from "lucide-react";
import { Virtuoso } from "react-virtuoso";

import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Dialog, DialogContent, DialogTitle } from "@/components/ui/dialog";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { FormattedDescription } from "@/components/ui/FormattedDescription";

import { classTranslations, sourceTranslations, spellSchoolTranslations } from "@/lib/refs/translation";
import { getUserPersesSpellIndex } from "@/lib/actions/pers";
import { toggleSpellForPers } from "@/lib/actions/spell-actions";
import { useModalBackButton } from "@/hooks/useModalBackButton";

export type SpellListItem = {
  spellId: number;
  name: string;
  engName: string;
  level: number;
  school: string | null;
  castingTime: string;
  duration: string;
  range: string;
  components: string | null;
  description: string;
  source: string;
  hasRitual: string | null;
  hasConcentration: string | null;
  spellClasses: { className: string }[];
  spellRaces: { raceName: string | null }[];
};

type InitialSearchParams = Record<string, string | string[] | undefined>;

type SelectionState = {
  levels: Set<string>;
  classes: Set<string>;
  subclasses: Set<string>;
  schools: Set<string>;
  times: Set<string>;
  sources: Set<string>;
  ritual: boolean | null;
  conc: boolean | null;
  q: string;
  spell: string;
};

// Embed mode params
type EmbedParams = {
  origin: string | null;
  persId: number | null;
  persName: string | null;
  maxSpellLevel: number | null;
};

function parseEmbedParams(params: URLSearchParams): EmbedParams {
  const origin = params.get("origin");
  const persIdRaw = params.get("persId");
  const persId = persIdRaw ? parseInt(persIdRaw, 10) : null;
  const persName = params.get("persName");
  const maxSpellLevel = params.get("maxSpellLevel") ? parseInt(params.get("maxSpellLevel")!, 10) : null;
  return {
    origin,
    persId: Number.isFinite(persId) ? persId : null,
    persName,
    maxSpellLevel: Number.isFinite(maxSpellLevel) ? maxSpellLevel : null,
  };
}

function getParamSet(params: URLSearchParams, key: string): Set<string> {
  const raw = params.get(key);
  if (!raw) return new Set();
  return new Set(
    raw
      .split(",")
      .map((v) => v.trim())
      .filter(Boolean)
  );
}

function setParamSet(params: URLSearchParams, key: string, values: Set<string>) {
  const nextValues = Array.from(values).filter(Boolean);
  if (nextValues.length === 0) params.delete(key);
  else params.set(key, nextValues.join(","));
}

function setBoolParam(params: URLSearchParams, key: string, value: boolean | null) {
  if (value === null) params.delete(key);
  else params.set(key, value ? "1" : "0");
}

function getBoolParam(params: URLSearchParams, key: string): boolean | null {
  const raw = params.get(key);
  if (raw === null) return null;
  if (raw === "1") return true;
  if (raw === "0") return false;
  return null;
}

function getSearchParamsFromLocation(): URLSearchParams {
  if (typeof window === "undefined") return new URLSearchParams();
  return new URLSearchParams(window.location.search);
}

function parseSelectionFromParams(params: URLSearchParams): SelectionState {
  return {
    levels: getParamSet(params, "lvl"),
    classes: getParamSet(params, "cls"),
    subclasses: getParamSet(params, "sub"),
    schools: getParamSet(params, "sch"),
    times: getParamSet(params, "time"),
    sources: getParamSet(params, "src"),
    ritual: getBoolParam(params, "rit"),
    conc: getBoolParam(params, "conc"),
    q: params.get("q")?.trim().toLowerCase() || "",
    spell: params.get("spell")?.trim() || "",
  };
}

function initSelectionFromInitialSearchParams(initialSearchParams: InitialSearchParams): SelectionState {
  const params = new URLSearchParams();
  for (const [key, value] of Object.entries(initialSearchParams)) {
    if (Array.isArray(value)) {
      const v = value[0];
      if (typeof v === "string") params.set(key, v);
    } else if (typeof value === "string") {
      params.set(key, value);
    }
  }
  return parseSelectionFromParams(params);
}

function replaceUrlSearchParams(next: URLSearchParams) {
  if (typeof window === "undefined") return;
  const url = new URL(window.location.href);
  url.search = next.toString();
  window.history.replaceState({}, "", url);
  const w = window as Window & { __locationchange_patched__?: boolean };
  if (w.__locationchange_patched__) return;
  const fire = () => window.dispatchEvent(new Event("locationchange"));
  if (typeof queueMicrotask === "function") queueMicrotask(fire);
  else window.setTimeout(fire, 0);
}

function pushUrlSearchParams(next: URLSearchParams) {
  if (typeof window === "undefined") return;
  const url = new URL(window.location.href);
  url.search = next.toString();
  window.history.pushState({}, "", url);
  const w = window as Window & { __locationchange_patched__?: boolean };
  if (w.__locationchange_patched__) return;
  const fire = () => window.dispatchEvent(new Event("locationchange"));
  if (typeof queueMicrotask === "function") queueMicrotask(fire);
  else window.setTimeout(fire, 0);
}

function selectionKey(sel: SelectionState): string {
  const key = (set: Set<string>) => Array.from(set).sort().join(",");
  return [
    `lvl=${key(sel.levels)}`,
    `cls=${key(sel.classes)}`,
    `sub=${key(sel.subclasses)}`,
    `sch=${key(sel.schools)}`,
    `time=${key(sel.times)}`,
    `src=${key(sel.sources)}`,
    `rit=${String(sel.ritual)}`,
    `conc=${String(sel.conc)}`,
    `q=${sel.q}`,
    `spell=${sel.spell}`,
  ].join("|");
}

function levelLabel(level: number, isRitual: boolean) {
  const base = level === 0 ? "" : ` ${level}`;
  return isRitual ? `${base} ()` : base;
}

function schoolLabel(school: string | null) {
  if (!school) return "";
  return spellSchoolTranslations[school as keyof typeof spellSchoolTranslations] || school;
}

function sourceLabel(source: string) {
  return sourceTranslations[source as keyof typeof sourceTranslations] || source;
}

function normalizeFlag(value: string | null | undefined): boolean {
  const v = (value ?? "").trim().toLowerCase();
  if (!v) return false;
  return v === "" || v === "yes" || v === "true" || v === "1";
}

function flagsLabel(spell: Pick<SpellListItem, "hasRitual" | "hasConcentration">): string {
  const flags: string[] = [];
  if (normalizeFlag(spell.hasRitual)) flags.push("");
  if (normalizeFlag(spell.hasConcentration)) flags.push("");
  return flags.length ? flags.join("  ") : "";
}

function splitClasses(values: string[]): { classes: string[]; subclasses: string[] } {
  const isSubclass = (raw: string) => {
    const v = raw.trim().toLowerCase();
    if (!v) return false;
    if (v.includes(":")) return true;
    if (v.includes("(")) return true;
    if (v.includes("-")) return true;
    // Most base classes are single words; multi-word entries are typically subclass lines.
    if (v.split(/\s+/).length > 1) return true;
    return false;
  };

  const classes: string[] = [];
  const subclasses: string[] = [];
  for (const v of values) {
    if (isSubclass(v)) subclasses.push(v);
    else classes.push(v);
  }
  return { classes, subclasses };
}

type PersIndexItem = {
  persId: number;
  name: string;
  spellIds: number[];
};

function SpellDetailPane({ spell }: { spell: SpellListItem }) {
  const classList = useMemo(() => {
    const uniq = new Set(spell.spellClasses.map((c) => c.className).filter(Boolean));
    return Array.from(uniq).sort((a, b) => a.localeCompare(b, "uk"));
  }, [spell.spellClasses]);

  const raceList = useMemo(() => {
    const uniq = new Set(spell.spellRaces.map((r) => r.raceName || "").filter(Boolean));
    return Array.from(uniq).sort((a, b) => a.localeCompare(b, "uk"));
  }, [spell.spellRaces]);

  return (
    <div className="glass-card border border-white/10 bg-slate-950/60 p-4 shadow-[0_0_30px_rgba(45,212,191,0.08)] ring-1 ring-white/10 backdrop-blur-xl sm:p-6">
      <div className="min-w-0">
        <h2 className="font-sans text-xl font-semibold uppercase tracking-[0.16em] text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-violet-400 truncate">
          {spell.name}
        </h2>
      </div>

      <div className="mt-4 rounded-2xl bg-white/5 p-3 glass-panel border border-white/10">
        <div className="flex items-center justify-between gap-3">
          <div className="min-w-0 flex flex-wrap items-center gap-x-2 gap-y-1 text-sm">
            <span className="text-slate-300">{levelLabel(spell.level, normalizeFlag(spell.hasRitual))}</span>
            <span className="italic text-slate-300">{schoolLabel(spell.school)}</span>
          </div>

          <div className="min-w-0 max-w-[45%] flex-shrink text-right text-xs text-slate-400 truncate">
            {sourceLabel(spell.source)}
          </div>
        </div>
      </div>

      <div className="mt-4 grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div className="rounded-2xl bg-slate-900/40 border border-white/5 p-3 glass-panel">
          <div className="text-xs text-slate-400"> </div>
          <div className="mt-1 text-sm text-slate-200">{spell.castingTime || ""}</div>
        </div>
        <div className="rounded-2xl bg-slate-900/40 border border-white/5 p-3 glass-panel">
          <div className="text-xs text-slate-400"></div>
          <div className="mt-1 text-sm text-slate-200">{spell.duration || ""}</div>
        </div>
        <div className="rounded-2xl bg-slate-900/40 border border-white/5 p-3 glass-panel">
          <div className="text-xs text-slate-400"></div>
          <div className="mt-1 text-sm text-slate-200">{spell.range || ""}</div>
        </div>
        <div className="rounded-2xl bg-slate-900/40 border border-white/5 p-3 glass-panel">
          <div className="text-xs text-slate-400"></div>
          <div className="mt-1 text-sm text-slate-200">{spell.components || ""}</div>
        </div>
      </div>

      <div className="mt-5 glass-panel rounded-2xl border border-white/10 bg-white/[0.03] p-4">
        <FormattedDescription content={spell.description} className="text-slate-300" />
      </div>

      <div className="mt-5 border-t border-slate-800/70 pt-4 text-sm text-slate-300">
        <div>
          <span className="text-slate-400">:</span> {classList.length ? classList.join(", ") : ""}
        </div>
        <div className="mt-1">
          <span className="text-slate-400">:</span> {raceList.length ? raceList.join(", ") : ""}
        </div>
      </div>
    </div>
  );
}

// Embed mode: simple add button for a specific character
function EmbedAddButton({
  spellId,
  persId,
  persSpellIds,
  setPersSpellIds,
}: {
  spellId: number;
  persId: number;
  persSpellIds: Set<number>;
  setPersSpellIds: React.Dispatch<React.SetStateAction<Set<number>>>;
}) {
  const [isPending, setIsPending] = useState(false);
  const has = persSpellIds.has(spellId);

  const handleToggle = async () => {
    setIsPending(true);
    try {
      const res = await toggleSpellForPers({ persId, spellId });
      if (res.success) {
        setPersSpellIds((prev) => {
          const next = new Set(prev);
          if (res.added) next.add(spellId);
          else next.delete(spellId);
          return next;
        });
      }
    } finally {
      setIsPending(false);
    }
  };

  return (
    <button
      type="button"
      disabled={isPending}
      onClick={handleToggle}
      className={
        "inline-flex h-9 w-9 items-center justify-center rounded-xl transition " +
        (has
          ? "bg-teal-500/20 text-teal-300 border border-teal-500/30"
          : "text-slate-400 hover:text-teal-300 hover:bg-white/5")
      }
      aria-label={has ? "  " : "  "}
    >
      {isPending ? (
        <Loader2 className="h-4 w-4 animate-spin" />
      ) : has ? (
        <Check className="h-4 w-4" />
      ) : (
        <UserPlus className="h-4 w-4" />
      )}
    </button>
  );
}

function SpellbookDropdown({
  spellId,
  persIndex,
  setPersIndex,
}: {
  spellId: number;
  persIndex: PersIndexItem[] | null;
  setPersIndex: (value: PersIndexItem[] | null) => void;
}) {
  const [open, setOpen] = useState(false);
  const [loading, setLoading] = useState(false);

  useModalBackButton(open, () => setOpen(false));

  const load = async () => {
    if (persIndex) return;
    setLoading(true);
    try {
      const data = await getUserPersesSpellIndex();
      setPersIndex(data);
    } finally {
      setLoading(false);
    }
  };

  return (
    <DropdownMenu
      open={open}
      onOpenChange={(next) => {
        setOpen(next);
        if (next) void load();
      }}
    >
      <DropdownMenuTrigger asChild>
        <button
          type="button"
          className="inline-flex h-9 w-9 items-center justify-center rounded-xl text-slate-400 transition hover:text-teal-300"
          aria-label="  "
        >
          <UserPlus className="h-4 w-4" />
        </button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-64">
        <DropdownMenuLabel>  </DropdownMenuLabel>
        <DropdownMenuSeparator />

        {loading ? (
          <div className="px-2 py-2 text-xs text-slate-400 flex items-center gap-2">
            <Loader2 className="h-4 w-4 animate-spin" /> 
          </div>
        ) : persIndex && persIndex.length === 0 ? (
          <div className="px-2 py-2 text-xs text-slate-400"> </div>
        ) : (
          persIndex?.map((p) => {
            const has = p.spellIds.includes(spellId);
            const label = p.name || ` #${p.persId}`;
            return (
              <DropdownMenuItem
                key={p.persId}
                className="flex items-center justify-between gap-2"
                onSelect={async (e) => {
                  e.preventDefault();
                  const res = await toggleSpellForPers({ persId: p.persId, spellId });
                  if (!res.success) return;

                  setPersIndex(
                    (persIndex || []).map((item) =>
                      item.persId !== p.persId
                        ? item
                        : {
                            ...item,
                            spellIds: res.added
                              ? Array.from(new Set([...item.spellIds, spellId]))
                              : item.spellIds.filter((id) => id !== spellId),
                          }
                    )
                  );
                }}
              >
                <span className="truncate">{label}</span>
                {has ? <Check className="h-4 w-4 text-teal-400" /> : null}
              </DropdownMenuItem>
            );
          })
        )}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}

export function SpellsClient({
  spells,
  initialSearchParams,
}: {
  spells: SpellListItem[];
  initialSearchParams: InitialSearchParams;
}) {
  const [filtersOpen, setFiltersOpen] = useState(false);
  const [persIndex, setPersIndex] = useState<PersIndexItem[] | null>(null);
  const [classFilter, setClassFilter] = useState("");
  const [subclassFilter, setSubclassFilter] = useState("");

  // Embed mode state
  const [embedParams, setEmbedParams] = useState<EmbedParams>(() => {
    if (typeof window === "undefined") return { origin: null, persId: null, persName: null, maxSpellLevel: null };
    return parseEmbedParams(new URLSearchParams(window.location.search));
  });
  const isEmbedMode = embedParams.origin === "character" && embedParams.persId !== null;
  const [persSpellIds, setPersSpellIds] = useState<Set<number>>(() => new Set());

  // Load persSpellIds when in embed mode
  useEffect(() => {
    if (!isEmbedMode || !embedParams.persId) return;
    getUserPersesSpellIndex().then((data) => {
      const found = data.find((p) => p.persId === embedParams.persId);
      if (found) setPersSpellIds(new Set(found.spellIds));
    });
  }, [isEmbedMode, embedParams.persId]);

  useModalBackButton(filtersOpen, () => setFiltersOpen(false));

  const [printIds, setPrintIds] = useState<number[]>([]);

  const initialQ = useMemo(() => {
    const raw = initialSearchParams.q;
    return Array.isArray(raw) ? raw[0] ?? "" : raw ?? "";
  }, [initialSearchParams.q]);

  const [qInput, setQInput] = useState(initialQ);
  const debounceRef = useRef<number | null>(null);

  const [selection, setSelection] = useState<SelectionState>(() =>
    initSelectionFromInitialSearchParams(initialSearchParams)
  );
  const selectionKeyRef = useRef<string>(selectionKey(initSelectionFromInitialSearchParams(initialSearchParams)));

  useEffect(() => {
    // Patch history methods once so we can react to other code using pushState/replaceState.
    const w = window as Window & { __locationchange_patched__?: boolean };
    if (typeof window !== "undefined" && !w.__locationchange_patched__) {
      w.__locationchange_patched__ = true;

      const dispatchLocationChangeAsync = () => {
        const fire = () => window.dispatchEvent(new Event("locationchange"));
        if (typeof queueMicrotask === "function") queueMicrotask(fire);
        else window.setTimeout(fire, 0);
      };

      const wrap = (type: "pushState" | "replaceState") => {
        const original = window.history[type];
        return function (this: History, ...args: unknown[]) {
          const result = (original as unknown as (...a: unknown[]) => unknown).apply(this, args);
          dispatchLocationChangeAsync();
          return result;
        };
      };

      window.history.pushState = wrap("pushState");
      window.history.replaceState = wrap("replaceState");
    }

    const sync = () => {
      const next = parseSelectionFromParams(getSearchParamsFromLocation());
      const nextKey = selectionKey(next);
      if (nextKey !== selectionKeyRef.current) {
        selectionKeyRef.current = nextKey;
        setSelection(next);
      }

      // Keep input box in sync with URL too.
      const nextQ = next.q || "";
      setQInput((prev) => (prev === nextQ ? prev : nextQ));
    };

    window.addEventListener("popstate", sync);
    window.addEventListener("locationchange", sync);
    sync();

    return () => {
      window.removeEventListener("popstate", sync);
      window.removeEventListener("locationchange", sync);
    };
  }, []);

  useEffect(() => {
    if (debounceRef.current) window.clearTimeout(debounceRef.current);
    debounceRef.current = window.setTimeout(() => {
      const next = getSearchParamsFromLocation();
      const trimmed = qInput.trim();
      if (!trimmed) next.delete("q");
      else next.set("q", trimmed);

      // Zero-latency: only update URL (no Next navigation).
      replaceUrlSearchParams(next);
    }, 250);

    return () => {
      if (debounceRef.current) window.clearTimeout(debounceRef.current);
    };
  }, [qInput]);

  const filtered = useMemo(() => {
    return spells.filter((s) => {
      if (selection.q) {
        const hay = `${s.name} ${s.engName}`.toLowerCase();
        if (!hay.includes(selection.q)) return false;
      }

      if (selection.levels.size > 0) {
        if (!selection.levels.has(String(s.level))) return false;
      }

      if (selection.schools.size > 0) {
        if (!s.school || !selection.schools.has(s.school)) return false;
      }

      if (selection.sources.size > 0) {
        if (!selection.sources.has(s.source)) return false;
      }

      if (selection.times.size > 0) {
        if (!selection.times.has(s.castingTime)) return false;
      }

      if (selection.classes.size > 0) {
        const spellClasses = new Set(s.spellClasses.map((c) => c.className));
        let ok = false;
        for (const cls of selection.classes) {
          if (spellClasses.has(cls)) {
            ok = true;
            break;
          }
        }
        if (!ok) return false;
      }

      if (selection.subclasses.size > 0) {
        const spellClasses = new Set(s.spellClasses.map((c) => c.className));
        let ok = false;
        for (const sub of selection.subclasses) {
          if (spellClasses.has(sub)) {
            ok = true;
            break;
          }
        }
        if (!ok) return false;
      }

      if (selection.ritual !== null) {
        if (normalizeFlag(s.hasRitual) !== selection.ritual) return false;
      }

      if (selection.conc !== null) {
        if (normalizeFlag(s.hasConcentration) !== selection.conc) return false;
      }

      return true;
    });
  }, [spells, selection]);

  const grouped = useMemo(() => {
    const map = new Map<number, SpellListItem[]>();
    for (const s of filtered) {
      const arr = map.get(s.level) ?? [];
      arr.push(s);
      map.set(s.level, arr);
    }
    return Array.from(map.entries()).sort(([a], [b]) => a - b);
  }, [filtered]);

  const selectedSpell = useMemo(() => {
    const byParam = selection.spell
      ? spells.find((s) => String(s.spellId) === selection.spell || s.engName === selection.spell || s.name === selection.spell)
      : null;

    if (byParam) return byParam;
    return filtered[0] ?? null;
  }, [filtered, selection.spell, spells]);

  const setParams = (mutate: (next: URLSearchParams) => void) => {
    const next = getSearchParamsFromLocation();
    mutate(next);
    replaceUrlSearchParams(next);
  };

  const pushParams = (mutate: (next: URLSearchParams) => void) => {
    const next = getSearchParamsFromLocation();
    mutate(next);
    pushUrlSearchParams(next);
  };

  const toggleSetValue = (key: string, value: string) => {
    setParams((next) => {
      const set = getParamSet(next, key);
      if (set.has(value)) set.delete(value);
      else set.add(value);
      setParamSet(next, key, set);
    });
  };

  const available = useMemo(() => {
    const classes = new Set<string>();
    const schools = new Set<string>();
    const times = new Set<string>();
    const sources = new Set<string>();
    const levels = new Set<number>();

    for (const s of spells) {
      levels.add(s.level);
      if (s.school) schools.add(s.school);
      times.add(s.castingTime);
      sources.add(s.source);
      for (const c of s.spellClasses) classes.add(c.className);
    }

    const split = splitClasses(Array.from(classes));

    return {
      levels: Array.from(levels).sort((a, b) => a - b),
      classes: split.classes.sort((a, b) => a.localeCompare(b, "uk")),
      subclasses: split.subclasses.sort((a, b) => a.localeCompare(b, "uk")),
      schools: Array.from(schools).sort((a, b) => a.localeCompare(b, "uk")),
      times: Array.from(times).sort((a, b) => a.localeCompare(b, "uk")),
      sources: Array.from(sources).sort((a, b) => a.localeCompare(b, "uk")),
    };
  }, [spells]);

  const clearFilters = () => {
    setParams((next) => {
      next.delete("lvl");
      next.delete("cls");
      next.delete("sub");
      next.delete("sch");
      next.delete("time");
      next.delete("src");
      next.delete("rit");
      next.delete("conc");
    });
  };

  const hasActiveFilters =
    selection.levels.size > 0 ||
    selection.classes.size > 0 ||
    selection.subclasses.size > 0 ||
    selection.schools.size > 0 ||
    selection.times.size > 0 ||
    selection.sources.size > 0 ||
    selection.ritual !== null ||
    selection.conc !== null;

  const onSelectSpell = (spell: SpellListItem) => {
    pushParams((next) => {
      next.set("spell", String(spell.spellId));
    });

    if (typeof window !== "undefined") {
      window.dispatchEvent(
        new CustomEvent("spell:open", {
          detail: { spellId: String(spell.spellId), spell },
        })
      );
    }
  };

  const baseTitleRef = useRef<string>("");
  useEffect(() => {
    if (typeof document === "undefined") return;
    if (!baseTitleRef.current) baseTitleRef.current = document.title;

    if (!selection.spell) {
      document.title = baseTitleRef.current;
      return;
    }

    const s = spells.find(
      (it) => String(it.spellId) === selection.spell || it.engName === selection.spell || it.name === selection.spell
    );
    if (s?.name) document.title = s.name;
  }, [selection.spell, spells]);

  const flatRows = useMemo(() => {
    return grouped.flatMap(([lvl, items]) => {
      return [
        { kind: "header" as const, lvl, count: items.length },
        ...items.map((spell) => ({ kind: "spell" as const, lvl, spell })),
      ];
    });
  }, [grouped]);

  const doPrint = () => {
    if (printIds.length === 0) return;
    const ids = encodeURIComponent(printIds.join(","));
    window.open(`/api/spells/print?ids=${ids}`, "_blank", "noopener,noreferrer");
  };

  // Filter by maxSpellLevel in embed mode
  const filteredByLevel = useMemo(() => {
    if (!isEmbedMode || embedParams.maxSpellLevel === null) return filtered;
    return filtered.filter((s) => s.level <= (embedParams.maxSpellLevel ?? 9));
  }, [filtered, isEmbedMode, embedParams.maxSpellLevel]);

  // Override grouped to use filteredByLevel in embed mode
  const finalGrouped = useMemo(() => {
    const source = isEmbedMode ? filteredByLevel : filtered;
    const map = new Map<number, SpellListItem[]>();
    for (const s of source) {
      const arr = map.get(s.level) ?? [];
      arr.push(s);
      map.set(s.level, arr);
    }
    return Array.from(map.entries()).sort(([a], [b]) => a - b);
  }, [filtered, filteredByLevel, isEmbedMode]);

  // Use finalGrouped for flatRows
  const finalFlatRows = useMemo(() => {
    return finalGrouped.flatMap(([lvl, items]) => {
      return [
        { kind: "header" as const, lvl, count: items.length },
        ...items.map((spell) => ({ kind: "spell" as const, lvl, spell })),
      ];
    });
  }, [finalGrouped]);

  return (
    <div className="h-full w-full bg-[radial-gradient(circle_at_50%_0%,rgba(45,212,191,0.05),transparent_50%)]">
      {/* Embed mode banner */}
      {isEmbedMode && (
        <div className="sticky top-0 z-30 border-b border-teal-500/30 bg-teal-500/10 backdrop-blur-xl">
          <div className="mx-auto w-full max-w-6xl px-3 py-2 sm:px-4">
            <div className="flex items-center justify-between gap-2 text-sm">
              <div className="flex items-center gap-2 text-teal-200">
                <UserPlus className="h-4 w-4" />
                <span>
                     <strong>{embedParams.persName || ` #${embedParams.persId}`}</strong>
                  {embedParams.maxSpellLevel !== null && (
                    <span className="ml-1 text-teal-300/70">(. : {embedParams.maxSpellLevel})</span>
                  )}
                </span>
              </div>
              <span className="text-xs text-teal-300/60"> +  </span>
            </div>
          </div>
        </div>
      )}

      <div className="sticky top-0 z-20 border-b border-white/10 bg-slate-950/40 backdrop-blur-xl" style={isEmbedMode ? { top: '40px' } : {}}>
        <div className="mx-auto w-full max-w-6xl px-3 py-3 sm:px-4">
          <div className="flex items-center gap-2 rounded-2xl border border-white/10 bg-white/5 p-2 backdrop-blur-xl">
            <div className="flex items-center gap-2 px-2 text-slate-400">
              <Search className="h-4 w-4" />
            </div>
            <Input
              value={qInput}
              onChange={(e) => setQInput(e.target.value)}
              placeholder=" "
              className="border-0 bg-transparent text-slate-200 placeholder:text-slate-500 focus-visible:ring-0"
            />

            <div className="flex items-center gap-1 rounded-xl border border-white/10 bg-white/5 p-1">
              <Button
                type="button"
                variant="secondary"
                className={
                  "h-9 gap-2 border-0 bg-transparent hover:bg-white/5 " +
                  (hasActiveFilters ? "text-teal-200 bg-teal-500/10" : "")
                }
                onClick={() => setFiltersOpen(true)}
              >
                <Filter className="h-4 w-4" />
                <span className="hidden sm:inline"></span>
              </Button>

              {hasActiveFilters ? (
                <Button
                  type="button"
                  variant="secondary"
                  className="h-9 gap-2 border-0 bg-transparent hover:bg-white/5 text-slate-200"
                  onClick={clearFilters}
                  aria-label=" "
                >
                  <X className="h-4 w-4" />
                  <span className="hidden sm:inline"></span>
                </Button>
              ) : null}

              <Button
                type="button"
                variant="secondary"
                className="h-9 gap-2 border-0 bg-transparent hover:bg-white/5"
                onClick={doPrint}
                disabled={printIds.length === 0}
              >
                <Printer className="h-4 w-4" />
                <span className="hidden sm:inline"></span>
                <span className="text-xs text-slate-300">({printIds.length})</span>
              </Button>
            </div>
          </div>
        </div>
      </div>

      <div className="mx-auto grid h-[calc(100vh-140px)] w-full max-w-6xl grid-cols-1 gap-4 px-3 py-4 sm:px-4 lg:grid-cols-5">
        <div className="lg:col-span-2 h-full">
          <div className="custom-scrollbar h-full">
            {finalGrouped.length === 0 ? (
              <div className="glass-panel rounded-2xl border border-white/10 p-4 text-sm text-slate-400">
                  
              </div>
            ) : (
              <Virtuoso
                style={{ height: "100%" }}
                data={finalFlatRows}
                itemContent={(index, row) => {
                  if (row.kind === "header") {
                    return (
                      <div className="pt-4 px-1">
                        <div className="glass-panel rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-base text-slate-200 backdrop-blur-xl">
                          <span className="font-semibold">{levelLabel(row.lvl, false)}</span>
                          <span className="ml-2 text-sm text-slate-400">({row.count})</span>
                        </div>
                      </div>
                    );
                  }

                  const spell = row.spell;
                  const active = selectedSpell?.spellId === spell.spellId;
                  const inPrint = printIds.includes(spell.spellId);

                  return (
                    <div className="pt-1.5 px-1">
                      <motion.div
                        layout
                        initial={{ opacity: 0, scale: 0.98 }}
                        animate={{ opacity: 1, scale: active ? 1.005 : 1 }}
                        whileHover={{ scale: active ? 1.005 : 1.003 }}
                        transition={{ type: "spring", stiffness: 380, damping: 32, mass: 0.7 }}
                        className={
                          "glass-panel group relative overflow-hidden rounded-xl border p-2 transition-all duration-300 " +
                          (active
                            ? "border-gradient-rpg border-gradient-rpg-active glass-active bg-white/5 text-white"
                            : "border-white/10 bg-white/5 text-slate-300 hover:bg-white/7")
                        }
                      >
                        <div className="flex items-start justify-between gap-3">
                          <button
                            type="button"
                            className="min-w-0 flex-1 text-left"
                            onClick={() => onSelectSpell(spell)}
                          >
                            <div className="flex items-baseline gap-2">
                              <span className="text-base font-bold tabular-nums text-violet-300">{spell.level}</span>
                              <span className="truncate text-sm font-semibold font-sans text-slate-100">
                                {spell.name}
                              </span>
                            </div>
                            <div className="mt-1 truncate text-xs text-slate-400">
                              {schoolLabel(spell.school)}  {spell.castingTime} {flagsLabel(spell) ? " " : ""}{flagsLabel(spell)}
                            </div>
                          </button>

                          <div className="flex flex-shrink-0 items-center gap-1">
                            <button
                              type="button"
                              className={
                                "inline-flex h-8 w-8 items-center justify-center rounded-lg text-slate-400 transition " +
                                (inPrint ? "text-teal-300" : "hover:text-teal-300")
                              }
                              onClick={() => {
                                setPrintIds((prev) =>
                                  prev.includes(spell.spellId)
                                    ? prev.filter((id) => id !== spell.spellId)
                                    : [...prev, spell.spellId]
                                );
                              }}
                              aria-label={inPrint ? "  " : "  "}
                            >
                              <Printer className="h-4 w-4" />
                            </button>

                            {isEmbedMode && embedParams.persId ? (
                              <EmbedAddButton
                                spellId={spell.spellId}
                                persId={embedParams.persId}
                                persSpellIds={persSpellIds}
                                setPersSpellIds={setPersSpellIds}
                              />
                            ) : (
                              <SpellbookDropdown
                                spellId={spell.spellId}
                                persIndex={persIndex}
                                setPersIndex={setPersIndex}
                              />
                            )}
                          </div>
                        </div>
                      </motion.div>
                    </div>
                  );
                }}
              />
            )}
          </div>
        </div>

        <div className="hidden lg:col-span-3 lg:block h-full overflow-hidden">
          <div className="custom-scrollbar h-full overflow-auto pr-1">
            {selectedSpell ? (
              <SpellDetailPane spell={selectedSpell} />
            ) : (
              <div className="glass-panel rounded-2xl border border-white/10 p-6 text-sm text-slate-400">
                   
              </div>
            )}
          </div>
        </div>
      </div>

      <Dialog open={filtersOpen} onOpenChange={setFiltersOpen}>
        <DialogContent className="max-h-[85vh] w-[95vw] max-w-3xl overflow-y-auto p-0" showClose={false}>
          <div className="p-4 sm:p-6">
            <div className="flex items-start justify-between gap-3">
              <DialogTitle className="font-rpg-display text-2xl font-semibold tracking-wide text-teal-400"></DialogTitle>
              <button
                type="button"
                onClick={() => setFiltersOpen(false)}
                className="glass-panel inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/50 text-slate-200/90 hover:text-teal-300"
                aria-label=""
              >
                <X className="h-4 w-4" />
              </button>
            </div>

            <div className="mt-4 space-y-4">
              <div className="glass-panel rounded-xl border border-white/10 p-3">
                <div className="text-xs font-semibold text-slate-300"></div>
                <div className="mt-2 max-h-44 overflow-auto pr-1">
                  <div className="flex flex-wrap gap-2">
                    {available.levels.map((lvl) => {
                      const active = selection.levels.has(String(lvl));
                      return (
                        <Badge
                          key={lvl}
                          variant={active ? "default" : "outline"}
                          className={active ? "bg-teal-500/15 text-teal-300 border-teal-500/30" : ""}
                          onClick={() => toggleSetValue("lvl", String(lvl))}
                          role="button"
                        >
                          {lvl}
                        </Badge>
                      );
                    })}
                  </div>
                </div>
              </div>

              <div className="glass-panel rounded-xl border border-white/10 p-3">
                <div className="text-xs font-semibold text-slate-300"></div>
                <div className="mt-2">
                  <Input
                    value={classFilter}
                    onChange={(e) => setClassFilter(e.target.value)}
                    placeholder=" "
                    className="h-9 border-white/10 bg-slate-950/40 text-slate-200 placeholder:text-slate-500"
                  />
                </div>
                <div className="mt-2 max-h-44 overflow-auto pr-1">
                  <div className="flex flex-wrap gap-2">
                    {available.classes
                      .filter((cls) => {
                        const q = classFilter.trim().toLowerCase();
                        if (!q) return true;
                        const label = classTranslations[cls as keyof typeof classTranslations] || cls;
                        return `${cls} ${label}`.toLowerCase().includes(q);
                      })
                      .map((cls) => {
                    const active = selection.classes.has(cls);
                    const label = classTranslations[cls as keyof typeof classTranslations] || cls;
                    return (
                      <Badge
                        key={cls}
                        variant={active ? "default" : "outline"}
                        className={active ? "bg-teal-500/15 text-teal-300 border-teal-500/30" : ""}
                        onClick={() => toggleSetValue("cls", cls)}
                        role="button"
                      >
                        {label}
                      </Badge>
                    );
                  })}
                  </div>
                </div>
              </div>

              <div className="glass-panel rounded-xl border border-white/10 p-3">
                <div className="text-xs font-semibold text-slate-300"></div>
                <div className="mt-2">
                  <Input
                    value={subclassFilter}
                    onChange={(e) => setSubclassFilter(e.target.value)}
                    placeholder=" "
                    className="h-9 border-white/10 bg-slate-950/40 text-slate-200 placeholder:text-slate-500"
                  />
                </div>
                <div className="mt-2 max-h-44 overflow-auto pr-1">
                  <div className="flex flex-wrap gap-2">
                    {available.subclasses
                      .filter((sub) => {
                        const q = subclassFilter.trim().toLowerCase();
                        if (!q) return true;
                        const label = classTranslations[sub as keyof typeof classTranslations] || sub;
                        return `${sub} ${label}`.toLowerCase().includes(q);
                      })
                      .map((sub) => {
                        const active = selection.subclasses.has(sub);
                        const label = classTranslations[sub as keyof typeof classTranslations] || sub;
                        return (
                          <Badge
                            key={sub}
                            variant={active ? "default" : "outline"}
                            className={active ? "bg-teal-500/15 text-teal-300 border-teal-500/30" : ""}
                            onClick={() => toggleSetValue("sub", sub)}
                            role="button"
                          >
                            {label}
                          </Badge>
                        );
                      })}
                  </div>
                </div>
              </div>

              <div className="glass-panel rounded-xl border border-white/10 p-3">
                <div className="text-xs font-semibold text-slate-300"></div>
                <div className="mt-2 max-h-44 overflow-auto pr-1">
                  <div className="flex flex-wrap gap-2">
                    {available.schools.map((sch) => {
                      const active = selection.schools.has(sch);
                      return (
                        <Badge
                          key={sch}
                          variant={active ? "default" : "outline"}
                          className={active ? "bg-teal-500/15 text-teal-300 border-teal-500/30" : ""}
                          onClick={() => toggleSetValue("sch", sch)}
                          role="button"
                        >
                          {spellSchoolTranslations[sch as keyof typeof spellSchoolTranslations] || sch}
                        </Badge>
                      );
                    })}
                  </div>
                </div>
              </div>

              <div className="glass-panel rounded-xl border border-white/10 p-3">
                <div className="text-xs font-semibold text-slate-300"> </div>
                <div className="mt-2 max-h-44 overflow-auto pr-1">
                  <div className="flex flex-wrap gap-2">
                    {available.times.map((t) => {
                      const active = selection.times.has(t);
                      return (
                        <Badge
                          key={t}
                          variant={active ? "default" : "outline"}
                          className={active ? "bg-teal-500/15 text-teal-300 border-teal-500/30" : ""}
                          onClick={() => toggleSetValue("time", t)}
                          role="button"
                        >
                          {t}
                        </Badge>
                      );
                    })}
                  </div>
                </div>
              </div>

              <div className="glass-panel rounded-xl border border-white/10 p-3">
                <div className="text-xs font-semibold text-slate-300"></div>
                <div className="mt-2 max-h-44 overflow-auto pr-1">
                  <div className="flex flex-wrap gap-2">
                    {available.sources.map((src) => {
                      const active = selection.sources.has(src);
                      return (
                        <Badge
                          key={src}
                          variant={active ? "default" : "outline"}
                          className={active ? "bg-teal-500/15 text-teal-300 border-teal-500/30" : ""}
                          onClick={() => toggleSetValue("src", src)}
                          role="button"
                        >
                          {sourceLabel(src)}
                        </Badge>
                      );
                    })}
                  </div>
                </div>
              </div>

              <div className="glass-panel rounded-xl border border-white/10 p-3">
                <div className="text-xs font-semibold text-slate-300"></div>
                <div className="mt-2 flex flex-wrap gap-2">
                  <Badge
                    variant={selection.conc === true ? "default" : "outline"}
                    className={selection.conc === true ? "bg-teal-500/15 text-teal-300 border-teal-500/30" : ""}
                    onClick={() =>
                      setParams((next) =>
                        setBoolParam(next, "conc", selection.conc === true ? null : true)
                      )
                    }
                    role="button"
                  >
                    
                  </Badge>
                  <Badge
                    variant={selection.ritual === true ? "default" : "outline"}
                    className={selection.ritual === true ? "bg-teal-500/15 text-teal-300 border-teal-500/30" : ""}
                    onClick={() =>
                      setParams((next) =>
                        setBoolParam(next, "rit", selection.ritual === true ? null : true)
                      )
                    }
                    role="button"
                  >
                    
                  </Badge>
                </div>
              </div>

              <div className="flex items-center justify-between gap-2">
                <Button
                  type="button"
                  variant="secondary"
                  className="border border-white/10 bg-slate-900/40"
                  onClick={clearFilters}
                >
                  
                </Button>
                <Button
                  type="button"
                  className="bg-teal-500/15 text-teal-300 border border-teal-500/30"
                  onClick={() => setFiltersOpen(false)}
                >
                  
                </Button>
              </div>
            </div>

            <div className="mt-4 text-xs text-slate-500">
              :    URL  <span className="text-slate-300">?spell=ID</span>.
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}
</file>

<file path="src/app/providers.tsx">
"use client";

import React from "react";
import { SessionProvider } from "next-auth/react";
import GoogleOneTap from "@/lib/components/auth/GoogleOneTap";
import { Toaster } from "@/components/ui/sonner";

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <SessionProvider>
      <GoogleOneTap />
      {children}
      <Toaster position="top-right" richColors closeButton />
    </SessionProvider>
  );
}
</file>

<file path="src/components/level-up/LevelUpWizard.tsx">
'use client';

import React, { useEffect } from 'react';
import { useCharacterStore } from '@/store/character-store';
import { StepRenderer } from './StepRenderer';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';
import { Loader2, CheckCircle2, AlertCircle } from 'lucide-react';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';

interface LevelUpWizardProps {
  persId: number;
  currentLevel: number;
}

export const LevelUpWizard: React.FC<LevelUpWizardProps> = ({
  persId,
  currentLevel,
}) => {
  const {
    phase,
    steps,
    error,
    initiateLevelUp,
    nextStep,
    prevStep,
    submitLevelUp,
    isSubmitting,
  } = useCharacterStore();

  const currentStepIndex = useCharacterStore((s) => s.currentStepIndex);
  const currentStep = steps[currentStepIndex];
  const isLastStep = currentStepIndex === steps.length - 1;

  // Start the wizard when component mounts
  useEffect(() => {
    initiateLevelUp(persId, currentLevel);
  }, [persId, currentLevel, initiateLevelUp]);

  if (phase === 'loading') {
    return (
      <div className="flex flex-col items-center justify-center h-64 space-y-4">
        <Loader2 className="w-12 h-12 animate-spin text-primary" />
        <p className="text-muted-foreground">  ...</p>
      </div>
    );
  }

  if (phase === 'error') {
    return (
      <Alert variant="destructive">
        <AlertCircle className="h-4 w-4" />
        <AlertTitle></AlertTitle>
        <AlertDescription>{error || '   .'}</AlertDescription>
      </Alert>
    );
  }

  if (phase === 'complete') {
    return (
      <div className="flex flex-col items-center justify-center h-64 space-y-4 text-center animate-in zoom-in">
        <div className="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center text-green-500">
          <CheckCircle2 className="w-10 h-10" />
        </div>
        <h2 className="text-2xl font-bold"> !</h2>
        <p className="text-muted-foreground">   .</p>
        <Button onClick={() => window.location.reload()}>  </Button>
      </div>
    );
  }

  if (!currentStep) return null;

  return (
    <Card className="w-full max-w-4xl mx-auto shadow-lg border-t-4 border-t-primary">
      <CardHeader>
        <div className="flex justify-between items-center">
            <CardTitle>Level Up:  {currentLevel + 1}</CardTitle>
            <span className="text-sm text-muted-foreground">
                 {currentStepIndex + 1}  {steps.length}
            </span>
        </div>
        {/* Progress Bar */}
        <div className="w-full bg-secondary h-2 rounded-full mt-2 overflow-hidden">
            <div 
                className="bg-primary h-full transition-all duration-500 ease-out"
                style={{ width: `${((currentStepIndex + 1) / steps.length) * 100}%` }}
            />
        </div>
      </CardHeader>
      
      <CardContent className="min-h-[400px] p-6">
        <StepRenderer step={currentStep} />
      </CardContent>

      <CardFooter className="flex justify-between bg-secondary/20 p-6">
        <Button 
            variant="outline" 
            onClick={prevStep} 
            disabled={currentStepIndex === 0 || isSubmitting}
        >
          
        </Button>
        
        {isLastStep ? (
          <Button onClick={submitLevelUp} disabled={isSubmitting}>
            {isSubmitting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
              
          </Button>
        ) : (
          <Button onClick={nextStep}>
            
          </Button>
        )}
      </CardFooter>
    </Card>
  );
};
</file>

<file path="src/components/level-up/LevelUpWizardMulticlass.tsx">
'use client';

import React, { useState, useEffect } from 'react';
// import { useCharacterStore } from '@/store/character-store';
import { LevelUpWizard } from './LevelUpWizard';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Loader2 } from 'lucide-react';

interface LevelUpWizardMulticlassProps {
  persId: number;
  currentLevel: number; // Total level
}

export const LevelUpWizardMulticlass: React.FC<LevelUpWizardMulticlassProps> = ({
  persId,
  currentLevel,
}) => {
  // const [multiclassInfo, setMulticlassInfo] = useState<any>(null);
  const [selectedClassId, setSelectedClassId] = useState<number | null>(null);
  const [loading, setLoading] = useState(true);

  // Fetch multiclass info on mount
  useEffect(() => {
      // Mock fetch - replace with actual server action call
      // const info = await getMulticlassInfo(persId);
      // setMulticlassInfo(info);
      setLoading(false);
      
      // For now, auto-select the only class if single class
      // if (info.classes.length === 1) setSelectedClassId(info.classes[0].classId);
  }, [persId]);

  if (loading) {
      return <div className="flex justify-center p-10"><Loader2 className="animate-spin" /></div>;
  }

  // If class is selected, show the standard wizard for that class
  if (selectedClassId) {
      // We need to know the CURRENT level of that specific class to ask for the NEXT level features
      // const classInfo = multiclassInfo.classes.find(c => c.classId === selectedClassId);
      // return <LevelUpWizard persId={persId} currentLevel={classInfo.classLevel} classId={selectedClassId} />;
      
      // For now, just pass through to the standard wizard which assumes single class logic for now
      return <LevelUpWizard persId={persId} currentLevel={currentLevel} />;
  }

  return (
    <Card className="max-w-2xl mx-auto mt-10">
      <CardHeader>
        <CardTitle>    </CardTitle>
        <CardDescription>
                .      ?
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
          {/* Mock Class Selection UI */}
          <Button className="w-full justify-start text-lg h-auto p-4" onClick={() => setSelectedClassId(1)}>
              <div className="text-left">
                  <div className="font-bold"> (Fighter)</div>
                  <div className="text-sm opacity-70"> : 3  4</div>
              </div>
          </Button>
           <Button variant="outline" className="w-full justify-start text-lg h-auto p-4" disabled>
              <div className="text-left">
                  <div className="font-bold">   (Multiclass)</div>
                  <div className="text-sm opacity-70">   (INT &lt; 13)</div>
              </div>
          </Button>
      </CardContent>
    </Card>
  );
};
</file>

<file path="src/components/level-up/useLevelUpManager.ts">
import { useState, useEffect } from 'react';
import { getLevelUpInfo, commitLevelUp, LevelUpInfo, LevelUpSelections } from '@/app/actions/level-up';

export function useLevelUpManager(persId: number, currentLevel: number) {
  const [info, setInfo] = useState<LevelUpInfo | null>(null);
  const [selections, setSelections] = useState<LevelUpSelections>({});
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [isCommitting, setIsCommitting] = useState(false);

  useEffect(() => {
    setLoading(true);
    getLevelUpInfo(persId, currentLevel + 1)
      .then(data => {
        setInfo(data);
        setLoading(false);
      })
      .catch(err => {
        setError(err.message);
        setLoading(false);
      });
  }, [persId, currentLevel]);

  const setSubclass = (subclassId: number) => {
    setSelections(prev => ({ ...prev, subclassId }));
  };

  const setAsi = (asi: { stat: string; value: number }[]) => {
    setSelections(prev => ({ ...prev, asi }));
  };

  const setSpecificChoice = (featureId: number, choiceOptionId: number) => {
    setSelections(prev => {
      const existing = prev.specificChoices || [];
      const filtered = existing.filter(c => c.featureId !== featureId);
      return {
        ...prev,
        specificChoices: [...filtered, { featureId, choiceOptionId }]
      };
    });
  };

  const commit = async () => {
    if (!info) return;
    setIsCommitting(true);
    try {
      await commitLevelUp(persId, selections);
      // Handle success (e.g. redirect or refresh)
    } catch (err: any) {
      setError(err.message);
    } finally {
      setIsCommitting(false);
    }
  };

  // Validation helper
  const isValid = () => {
    if (!info) return false;
    for (const f of info.features) {
      if (f.choiceData) {
        if (f.choiceData.type === 'SUBCLASS' && !selections.subclassId) return false;
        if (f.choiceData.type === 'ASI' && (!selections.asi || selections.asi.length === 0)) return false;
        if (f.choiceData.type === 'SPECIFIC') {
           const choice = selections.specificChoices?.find(c => c.featureId === f.featureId);
           if (!choice) return false;
        }
      }
    }
    return true;
  };

  return { 
    info, 
    selections, 
    setSubclass, 
    setAsi, 
    setSpecificChoice, 
    commit, 
    loading, 
    error, 
    isCommitting,
    isValid 
  };
}
</file>

<file path="src/components/ui/alert.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLHeadingElement>>(({ className, ...props }, ref) => (
  <h5 ref={ref} className={className} {...props} />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLParagraphElement>>(({ className, ...props }, ref) => (
  <div ref={ref} className={className} {...props} />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }
</file>

<file path="src/components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline:
          "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }
</file>

<file path="src/components/ui/collapsible.tsx">
"use client";

import * as React from "react";

type CollapsibleContextValue = {
  open: boolean;
  setOpen: (next: boolean) => void;
};

const CollapsibleContext = React.createContext<CollapsibleContextValue | null>(null);

export function Collapsible({
  open: openProp,
  defaultOpen,
  onOpenChange,
  className,
  children,
}: {
  open?: boolean;
  defaultOpen?: boolean;
  onOpenChange?: (open: boolean) => void;
  className?: string;
  children: React.ReactNode;
}) {
  const [uncontrolledOpen, setUncontrolledOpen] = React.useState(!!defaultOpen);
  const isControlled = typeof openProp === "boolean";
  const open = isControlled ? (openProp as boolean) : uncontrolledOpen;

  const setOpen = React.useCallback(
    (next: boolean) => {
      if (!isControlled) setUncontrolledOpen(next);
      onOpenChange?.(next);
    },
    [isControlled, onOpenChange]
  );

  return (
    <CollapsibleContext.Provider value={{ open, setOpen }}>
      <div className={className} data-state={open ? "open" : "closed"}>
        {children}
      </div>
    </CollapsibleContext.Provider>
  );
}

export const CollapsibleTrigger = React.forwardRef<
  HTMLButtonElement,
  React.ButtonHTMLAttributes<HTMLButtonElement>
>(function CollapsibleTrigger({ onClick, type, ...props }, ref) {
  const ctx = React.useContext(CollapsibleContext);
  if (!ctx) {
    throw new Error("CollapsibleTrigger must be used within <Collapsible>");
  }

  return (
    <button
      ref={ref}
      type={type ?? "button"}
      aria-expanded={ctx.open}
      data-state={ctx.open ? "open" : "closed"}
      onClick={(e) => {
        ctx.setOpen(!ctx.open);
        onClick?.(e);
      }}
      {...props}
    />
  );
});

export const CollapsibleContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(function CollapsibleContent({ style, hidden, ...props }, ref) {
  const ctx = React.useContext(CollapsibleContext);
  if (!ctx) {
    throw new Error("CollapsibleContent must be used within <Collapsible>");
  }

  return (
    <div
      ref={ref}
      data-state={ctx.open ? "open" : "closed"}
      hidden={!ctx.open || hidden}
      style={style}
      {...props}
    />
  );
});
</file>

<file path="src/components/ui/dropdown-menu.tsx">
"use client";

import * as React from "react";
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu";
import { Check, ChevronRight } from "lucide-react";

import { cn } from "@/lib/utils";

const DropdownMenu = DropdownMenuPrimitive.Root;
const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger;
const DropdownMenuGroup = DropdownMenuPrimitive.Group;
const DropdownMenuPortal = DropdownMenuPrimitive.Portal;
const DropdownMenuSub = DropdownMenuPrimitive.Sub;
const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup;

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean;
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-md px-2 py-1.5 text-sm outline-none focus:bg-white/5 data-[state=open]:bg-white/5",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </DropdownMenuPrimitive.SubTrigger>
));
DropdownMenuSubTrigger.displayName = DropdownMenuPrimitive.SubTrigger.displayName;

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "glass-card z-50 min-w-[12rem] overflow-hidden rounded-xl border border-white/10 bg-slate-950/90 p-1 text-slate-200 shadow-lg backdrop-blur",
      className
    )}
    {...props}
  />
));
DropdownMenuSubContent.displayName = DropdownMenuPrimitive.SubContent.displayName;

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 8, ...props }, ref) => (
  <DropdownMenuPortal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "glass-card z-50 min-w-[12rem] overflow-hidden rounded-xl border border-white/10 bg-slate-950/90 p-1 text-slate-200 shadow-lg backdrop-blur",
        className
      )}
      {...props}
    />
  </DropdownMenuPortal>
));
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName;

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-md px-2 py-1.5 text-sm outline-none transition-colors focus:bg-white/5 data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
));
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName;

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-md py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-white/5 data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4 text-teal-400" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
));
DropdownMenuCheckboxItem.displayName = DropdownMenuPrimitive.CheckboxItem.displayName;

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-md py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-white/5 data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <div className="h-2 w-2 rounded-full bg-teal-400" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
));
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName;

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & { inset?: boolean }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-xs font-semibold text-slate-300", inset && "pl-8", className)}
    {...props}
  />
));
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName;

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-white/10", className)}
    {...props}
  />
));
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName;

const DropdownMenuShortcut = ({ className, ...props }: React.HTMLAttributes<HTMLSpanElement>) => {
  return <span className={cn("ml-auto text-xs tracking-widest text-slate-400", className)} {...props} />;
};
DropdownMenuShortcut.displayName = "DropdownMenuShortcut";

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
};
</file>

<file path="src/components/ui/FormattedDescription.tsx">
"use client";

import React from "react";
import ReactMarkdown from "react-markdown";
import remarkGfm from "remark-gfm";
import rehypeRaw from "rehype-raw";
import rehypeSanitize, { defaultSchema } from "rehype-sanitize";

function extractSpellIdFromHref(href: string | undefined): string | null {
  if (!href) return null;

  const trimmed = href.trim();
  if (!trimmed) return null;

  if (trimmed.startsWith("spell:")) {
    const value = trimmed.slice("spell:".length).trim();
    return /^\d+$/.test(value) ? value : null;
  }

  try {
    const url = new URL(trimmed, "https://local.invalid");
    const spell = url.searchParams.get("spell");
    if (spell && /^\d+$/.test(spell)) return spell;

    const parts = url.pathname.split("/").filter(Boolean);
    const idxSpell = parts.findIndex((p) => p === "spell" || p === "spells");
    const candidate = idxSpell >= 0 ? parts[idxSpell + 1] : null;
    return candidate && /^\d+$/.test(candidate) ? candidate : null;
  } catch {
    const withoutHash = trimmed.split("#")[0];
    const withoutQuery = withoutHash.split("?")[0];
    const parts = withoutQuery.split("/").filter(Boolean);
    const idxSpell = parts.findIndex((p) => p === "spell" || p === "spells");
    const candidate = idxSpell >= 0 ? parts[idxSpell + 1] : null;
    return candidate && /^\d+$/.test(candidate) ? candidate : null;
  }
}

const sanitizeSchema = {
  ...defaultSchema,
  tagNames: Array.from(
    new Set([
      ...(defaultSchema.tagNames ?? []),
      "a",
      "p",
      "br",
      "hr",
      "strong",
      "em",
      "ul",
      "ol",
      "li",
      "blockquote",
      "code",
      "pre",
      "table",
      "thead",
      "tbody",
      "tr",
      "th",
      "td",
    ])
  ),
  attributes: {
    ...(defaultSchema.attributes ?? {}),
    a: ["href", "title", "target", "rel"],
  },
} as const;

export function FormattedDescription({
  content,
  className,
}: {
  content: string;
  className?: string;
}) {
  const dispatchLocationChangeAsync = () => {
    if (typeof window === "undefined") return;
    const fire = () => window.dispatchEvent(new Event("locationchange"));
    if (typeof queueMicrotask === "function") queueMicrotask(fire);
    else window.setTimeout(fire, 0);
  };

  const openSpell = (spellId: string) => {
    if (typeof window === "undefined") return;

    const url = new URL(window.location.href);
    url.searchParams.set("spell", spellId);
    window.history.pushState({}, "", url);
    window.dispatchEvent(new CustomEvent("spell:open", { detail: { spellId } }));
    dispatchLocationChangeAsync();
  };

  return (
    <div className={className}>
      <ReactMarkdown
        remarkPlugins={[remarkGfm]}
        rehypePlugins={[[rehypeRaw], [rehypeSanitize, sanitizeSchema]]}
        components={{
          strong: ({ children }) => <span className="font-semibold text-teal-400">{children}</span>,
          a: ({ href, children }) => {
            const spellId = extractSpellIdFromHref(href);

            if (!spellId) {
              return (
                <a
                  href={href}
                  className="text-teal-400 underline underline-offset-2 hover:text-teal-300"
                  target={href?.startsWith("http") ? "_blank" : undefined}
                  rel={href?.startsWith("http") ? "noreferrer" : undefined}
                >
                  {children}
                </a>
              );
            }

            return (
              <a
                href={href}
                className="text-teal-400 underline underline-offset-2 hover:text-teal-300"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();

                  openSpell(String(spellId));
                }}
              >
                {children}
              </a>
            );
          },
          p: ({ children }) => <p className="mb-3 text-sm leading-relaxed text-inherit last:mb-0">{children}</p>,
          ul: ({ children }) => <ul className="mb-3 list-disc space-y-1 pl-5 text-sm text-inherit">{children}</ul>,
          ol: ({ children }) => <ol className="mb-3 list-decimal space-y-1 pl-5 text-sm text-inherit">{children}</ol>,
          li: ({ children }) => <li className="leading-relaxed">{children}</li>,
          table: ({ children }) => (
            <div className="mb-3 overflow-x-auto">
              <table className="w-full border-collapse text-sm">{children}</table>
            </div>
          ),
          thead: ({ children }) => <thead className="bg-slate-950/40">{children}</thead>,
          tr: ({ children }) => <tr className="border-b border-slate-600/60">{children}</tr>,
          th: ({ children }) => (
            <th className="border border-slate-600 px-3 py-2 text-left font-semibold text-inherit">{children}</th>
          ),
          td: ({ children }) => <td className="border border-slate-600 px-3 py-2 text-inherit">{children}</td>,
        }}
      >
        {content}
      </ReactMarkdown>
    </div>
  );
}
</file>

<file path="src/components/ui/radio-group.tsx">
import * as React from "react"
import { cn } from "@/lib/utils"

const RadioGroup = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & { onValueChange?: (value: string) => void; defaultValue?: string; value?: string }
>(({ className, onValueChange: _onValueChange, defaultValue: _defaultValue, value: _value, ...props }, ref) => {
  return (
    <div className={cn("grid gap-2", className)} ref={ref} {...props} />
  )
})
RadioGroup.displayName = "RadioGroup"

const RadioGroupItem = React.forwardRef<
  HTMLButtonElement,
  React.ButtonHTMLAttributes<HTMLButtonElement> & { value: string }
>(({ className, value: _value, ...props }, ref) => {
  return (
    <button
      type="button"
      className={cn(
        "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      ref={ref}
      {...props}
    />
  )
})
RadioGroupItem.displayName = "RadioGroupItem"

export { RadioGroup, RadioGroupItem }
</file>

<file path="src/components/ui/scroll-area.tsx">
import * as React from "react"

const ScrollArea = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(({ className, ...props }, ref) => (
  <div ref={ref} className={className} {...props} />
))
ScrollArea.displayName = "ScrollArea"

export { ScrollArea }
</file>

<file path="src/components/ui/select.tsx">
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn("flex cursor-default items-center justify-center py-1", className)}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn("flex cursor-default items-center justify-center py-1", className)}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName = SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>

    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}
</file>

<file path="src/domain/pers/AbilityScores.ts">
import { Ability } from "@prisma/client";

export class AbilityScores {
  private readonly scores: Record<Ability, number>;

  constructor(scores: Record<Ability, number>) {
    for (const [ability, value] of Object.entries(scores)) {
      if (value < 1) {
        throw new Error(`Ability ${ability} must be >= 1`);
      }
    }
    this.scores = { ...scores };
  }

  get(ability: Ability): number {
    return this.scores[ability];
  }

  toPrimitives() {
    return { ...this.scores };
  }
}
</file>

<file path="src/domain/pers/Background.ts">
// domain/character/Background.ts
export class Background {
  constructor(
    readonly backgroundId: number,
  ) {}
}
</file>

<file path="src/domain/pers/CharacterNotes.ts">
export class CharacterNotes {
  constructor(
    readonly alignment?: string,
    readonly personalityTraits?: string,
    readonly ideals?: string,
    readonly bonds?: string,
    readonly flaws?: string,
    readonly backstory?: string,
    readonly notes?: string,
  ) {}
}
</file>

<file path="src/domain/pers/CreatePersInput.schema.ts">
import { SkillsEnum } from "@/lib/types/enums";
import { Ability } from "@prisma/client";
import { z } from "zod";

export const AbilitySchema = z.enum(Ability)

export const createPersInputSchema = z.object({
  name: z.string().min(1),
  raceId: z.number().int().positive(),
  classId: z.number().int().positive(),
  subclassId: z.number().int().positive().optional(),
  backgroundId: z.number().int().positive(),

  abilityScores: z.record(AbilitySchema, z.number()),

  skills: z.array(z.enum(SkillsEnum)).optional(),
  equipmentIds: z.array(z.number()),

  classChoiceOptions: z.array(z.number()).optional(),
  classOptionalFeatures: z.array(z.number()).optional(),
  subclassChoiceOptions: z.array(z.number()).optional(),
  subclassOptionalFeatures: z.array(z.number()).optional(),
});

export type CreatePersInput =
  z.infer<typeof createPersInputSchema>;
export type AbilitySchema = z.infer<typeof AbilitySchema>;
</file>

<file path="src/domain/pers/Equipment.ts">

</file>

<file path="src/domain/pers/HitPoints.ts">
export class HitPoints {
  constructor(
    private current: number,
    private max: number,
    private temp: number = 0,
  ) {
    if (current > max) {
      throw new Error("Current HP cannot exceed max HP");
    }
  }

  getCurrent() {
    return this.current;
  }

  getMax() {
    return this.max;
  }

  getTemp() {
    return this.temp;
  }
}
</file>

<file path="src/domain/pers/Money.ts">
// domain/character/Money.ts
export class Money {
  constructor(
    readonly cp = 0,
    readonly sp = 0,
    readonly gp = 0,
    readonly pp = 0,
  ) {}

  toPrimitives() {
    return {
      cp: this.cp,
      sp: this.sp,
      gp: this.gp,
      pp: this.pp,
    };
  }
}
</file>

<file path="src/domain/pers/PersClass.ts">
// domain/character/persClass.ts
export class PersClass {
  constructor(
    readonly classId: number,
    readonly subclassId?: number,
  ) {}
}
</file>

<file path="src/domain/pers/Race.ts">
// domain/character/Race.ts
export class Race {
  constructor(
    readonly raceId: number,
    readonly name?: string,
    readonly subraceId?: number,
  ) {}
}
</file>

<file path="src/hooks/useCharacterStats.ts">
import { useMemo } from 'react';
import { usePersFormStore } from '@/lib/stores/persFormStore';
import { Ability, RaceVariant } from '@prisma/client';
import { RaceI, FeatPrisma, RaceASI } from '@/lib/types/model-types';

const attributes = [
  { key: Ability.STR, label: '' },
  { key: Ability.DEX, label: '' },
  { key: Ability.CON, label: '' },
  { key: Ability.INT, label: '' },
  { key: Ability.WIS, label: '' },
  { key: Ability.CHA, label: '' },
];

interface UseCharacterStatsProps {
  race?: RaceI;
  raceVariant?: RaceVariant | null;
  feat?: FeatPrisma | null;
}

export const useCharacterStats = ({ race, raceVariant, feat }: UseCharacterStatsProps) => {
  const { formData } = usePersFormStore();

  const stats = useMemo(() => {
    const scores: Record<string, { base: number; bonus: number; total: number; mod: number }> = {};

    // 1. Base Scores
    const baseScores: Record<string, number> = {
      STR: 10, DEX: 10, CON: 10, INT: 10, WIS: 10, CHA: 10
    };

    if (formData.asiSystem === 'POINT_BUY') {
      formData.asi?.forEach(s => baseScores[s.ability] = s.value);
    } else if (formData.asiSystem === 'SIMPLE') {
      formData.simpleAsi?.forEach(s => baseScores[s.ability] = s.value);
    } else if (formData.asiSystem === 'CUSTOM' && formData.customAsi) {
      formData.customAsi.forEach(s => baseScores[s.ability] = Number(s.value) || 10);
    }

    // Initialize result structure
    attributes.forEach(attr => {
      scores[attr.key] = { base: baseScores[attr.key], bonus: 0, total: 0, mod: 0 };
    });

    // 2. Racial Bonuses (Fixed)
    let effectiveASI = race?.ASI as RaceASI | undefined;
    if (raceVariant?.overridesRaceASI) {
      effectiveASI = raceVariant.overridesRaceASI as unknown as RaceASI;
    }

    if (effectiveASI?.basic?.simple) {
      Object.entries(effectiveASI.basic.simple).forEach(([ability, bonus]) => {
        if (scores[ability]) scores[ability].bonus += Number(bonus);
      });
    }

    // 3. Racial Bonuses (Choices)
    if (formData.racialBonusChoiceSchema) {
      const choices = formData.isDefaultASI 
          ? formData.racialBonusChoiceSchema.basicChoices 
          : formData.racialBonusChoiceSchema.tashaChoices;
      
      choices?.forEach(choice => {
          choice.selectedAbilities.forEach(ability => {
             if (scores[ability]) scores[ability].bonus += 1;
          });
      });
    }

    // 4. Feat Bonuses (Fixed)
    if (feat?.grantedASI) {
       const featASI = feat.grantedASI as any;
       if (featASI?.basic?.simple) {
         Object.entries(featASI.basic.simple).forEach(([ability, bonus]) => {
            if (scores[ability]) scores[ability].bonus += Number(bonus);
         });
       }
    }

    // 5. Feat Bonuses (Choices)
    // We need to look at featChoiceSelections and map them to abilities
    if (feat && formData.featChoiceSelections) {
        Object.values(formData.featChoiceSelections).forEach(optionId => {
            // Find the option in the feat's options
            const option = feat.featChoiceOptions.find(o => o.choiceOptionId === optionId);
            if (option) {
                // Check if the option name corresponds to an ability
                // We seeded them as "Strength", "Dexterity", etc. or localized "", ""
                // Let's check both or use a map.
                // In seed: "Skill Expert Ability (Strength)" -> optionNameEng
                // In seed: "Resilient (Strength)" -> optionNameEng
                
                const nameEng = option.choiceOption.optionNameEng;
                if (nameEng.includes('Strength')) scores['STR'].bonus += 1;
                else if (nameEng.includes('Dexterity')) scores['DEX'].bonus += 1;
                else if (nameEng.includes('Constitution')) scores['CON'].bonus += 1;
                else if (nameEng.includes('Intelligence')) scores['INT'].bonus += 1;
                else if (nameEng.includes('Wisdom')) scores['WIS'].bonus += 1;
                else if (nameEng.includes('Charisma')) scores['CHA'].bonus += 1;
            }
        });
    }

    // Calculate Totals and Mods
    Object.keys(scores).forEach(key => {
        scores[key].total = scores[key].base + scores[key].bonus;
        scores[key].mod = Math.floor((scores[key].total - 10) / 2);
    });

    return scores;
  }, [formData, race, raceVariant, feat]);

  return stats;
};
</file>

<file path="src/hooks/useFantasyNameGenerator.ts">
import { useCallback, useEffect, useMemo, useState } from "react";
import { FANTASY_NAMES } from "@/lib/refs/fantasyNames";

export function useFantasyNameGenerator() {
  const names = useMemo(() => FANTASY_NAMES, []);
  const [currentName, setCurrentName] = useState<string>(names[0] ?? "");

  const generateName = useCallback(() => {
    if (!names.length) return "";
    const randomIndex = Math.floor(Math.random() * names.length);
    const next = names[randomIndex];
    setCurrentName(next);
    return next;
  }, [names]);

  useEffect(() => {
    if (!currentName) generateName();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  return { currentName, generateName };
}
</file>

<file path="src/hooks/useMediaQuery.ts">
"use client";

import { useEffect, useState } from "react";

const BREAKPOINTS: Record<"md" | "lg", number> = {
  md: 768,
  lg: 1024,
};

export function useMediaQuery(breakpoint: "md" | "lg") {
  const minWidth = BREAKPOINTS[breakpoint];
  const [matches, setMatches] = useState(false);

  useEffect(() => {
    const mql = window.matchMedia(`(min-width: ${minWidth}px)`);
    const onChange = () => setMatches(mql.matches);

    onChange();
    mql.addEventListener("change", onChange);
    return () => mql.removeEventListener("change", onChange);
  }, [minWidth]);

  return matches;
}
</file>

<file path="src/hooks/useModalBackButton.ts">
import { useEffect, useRef } from "react";

export function useModalBackButton(isOpen: boolean, onClose: () => void) {
  const onCloseRef = useRef(onClose);

  useEffect(() => {
    onCloseRef.current = onClose;
  }, [onClose]);

  useEffect(() => {
    if (!isOpen) return;
    if (typeof window === "undefined") return;

    //     
    window.history.pushState({ modal: true }, "");

    const handlePopState = () => {
      //      ""
      onCloseRef.current();
    };

    window.addEventListener("popstate", handlePopState);

    return () => {
      window.removeEventListener("popstate", handlePopState);

      //  history       
      // (    Escape)
      if (window.history.state?.modal) {
        window.history.back();
      }
    };
  }, [isOpen]);
}
</file>

<file path="src/lib/actions/bonus-actions.ts">
"use server";

import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";
import { Ability, Prisma, Skills, SkillProficiencyType } from "@prisma/client";
import { StatBonuses, SkillBonuses, SimpleBonusField } from "@/lib/types/model-types";

/**
 * Helper to assert the user owns the pers
 */
async function assertOwnsPers(persId: number) {
  const session = await auth();
  if (!session?.user?.email) return { ok: false as const, error: " " };

  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
    select: { id: true },
  });

  if (!user) return { ok: false as const, error: "  " };

  const pers = await prisma.pers.findUnique({
    where: { persId },
    select: {
      persId: true,
      userId: true,
      statBonuses: true,
      statModifierBonuses: true,
      saveBonuses: true,
      skillBonuses: true,
      hpBonuses: true,
      acBonuses: true,
      speedBonuses: true,
      proficiencyBonuses: true,
      initiativeBonuses: true,
      spellAttackBonuses: true,
      spellDCBonuses: true,
    },
  });

  if (!pers || pers.userId !== user.id) {
    return { ok: false as const, error: "   " };
  }

  return { ok: true as const, pers };
}

type BonusUpdateType = 'stat' | 'statModifier' | 'save' | 'skill' | SimpleBonusField;

interface UpdateBonusResult {
  success: true;
  updatedField: string;
  updatedValue: unknown;
}

interface UpdateBonusError {
  success: false;
  error: string;
}

/**
 * Update a bonus for a character
 * 
 * @param persId - Character ID
 * @param bonusType - Type of bonus to update
 * @param key - Ability or Skill enum value (null for simple bonuses like HP/AC)
 * @param value - New bonus value (0 removes the bonus)
 */
export async function updateBonus(
  persId: number,
  bonusType: BonusUpdateType,
  key: string | null,
  value: number
): Promise<UpdateBonusResult | UpdateBonusError> {
  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };

  const pers = owned.pers;
  
  // Validate value
  if (!Number.isFinite(value)) {
    return { success: false, error: "  " };
  }
  
  // Round to integer
  const roundedValue = Math.trunc(value);

  try {
    let updatedField = "";
    let updatedValue: Record<string, number> | { value: number } | typeof Prisma.JsonNull | null = null;

    if (bonusType === 'stat' || bonusType === 'statModifier' || bonusType === 'save') {
      // Validate ability key
      if (!key || !Object.values(Ability).includes(key as Ability)) {
        return { success: false, error: " " };
      }
      
      const abilityFieldMap: Record<string, string> = {
        stat: 'statBonuses',
        statModifier: 'statModifierBonuses',
        save: 'saveBonuses',
      };
      
      updatedField = abilityFieldMap[bonusType];
      
      // Get existing bonuses
      const existingJson = (pers as Record<string, unknown>)[updatedField];
      const existing: StatBonuses = (existingJson && typeof existingJson === 'object') 
        ? { ...existingJson as StatBonuses }
        : {};
      
      // Update
      if (roundedValue === 0) {
        delete existing[key as Ability];
      } else {
        existing[key as Ability] = roundedValue;
      }
      
      updatedValue = Object.keys(existing).length > 0 ? existing : Prisma.JsonNull;
      
      await prisma.pers.update({
        where: { persId },
        data: { [updatedField]: updatedValue },
      });
      
    } else if (bonusType === 'skill') {
      // Validate skill key
      if (!key || !Object.values(Skills).includes(key as Skills)) {
        return { success: false, error: " " };
      }
      
      updatedField = 'skillBonuses';
      
      // Get existing bonuses
      const skillJson = pers.skillBonuses;
      const existingSkills: SkillBonuses = (skillJson && typeof skillJson === 'object') 
        ? { ...skillJson as SkillBonuses }
        : {};
      
      // Update
      if (roundedValue === 0) {
        delete existingSkills[key as Skills];
      } else {
        existingSkills[key as Skills] = roundedValue;
      }
      
      updatedValue = Object.keys(existingSkills).length > 0 ? existingSkills : Prisma.JsonNull;
      
      await prisma.pers.update({
        where: { persId },
        data: { skillBonuses: updatedValue },
      });
      
    } else {
      // Simple bonus (hp, ac, speed, proficiency, initiative, spellAttack, spellDC)
      const simpleFieldMap: Record<SimpleBonusField, string> = {
        hp: 'hpBonuses',
        ac: 'acBonuses',
        speed: 'speedBonuses',
        proficiency: 'proficiencyBonuses',
        initiative: 'initiativeBonuses',
        spellAttack: 'spellAttackBonuses',
        spellDC: 'spellDCBonuses',
      };
      
      updatedField = simpleFieldMap[bonusType];
      updatedValue = roundedValue === 0 ? Prisma.JsonNull : { value: roundedValue };
      
      await prisma.pers.update({
        where: { persId },
        data: { [updatedField]: updatedValue },
      });
    }

    revalidatePath(`/pers/${persId}`);
    revalidatePath(`/character/${persId}`);

    return {
      success: true,
      updatedField,
      updatedValue: updatedValue === Prisma.JsonNull ? null : updatedValue,
    };
  } catch (error) {
    console.error("Error updating bonus:", error);
    return { success: false, error: "   " };
  }
}

/**
 * Update skill proficiency type for a character
 */
export async function updateSkillProficiency(
  persId: number,
  skillName: Skills,
  proficiencyType: SkillProficiencyType
): Promise<{ success: true } | { success: false; error: string }> {
  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };

  try {
    // Find skill ID (assuming all skills exist in character or we need to upsert)
    // Actually our PersSkill has a unique constraint on [persId, name]
    await prisma.persSkill.upsert({
      where: {
        persId_name: {
          persId,
          name: skillName,
        }
      },
      update: {
        proficiencyType,
      },
      create: {
        persId,
        name: skillName,
        proficiencyType,
        skillId: 0, // We need to handle skillId. Wait, where does it come from? 
        // Let me check if Skill table exists.
      },
    });

    revalidatePath(`/pers/${persId}`);
    revalidatePath(`/character/${persId}`);

    return { success: true };
  } catch (error) {
    console.error("Error updating skill proficiency:", error);
    return { success: false, error: "    " };
  }
}

/**
 * Update saving throw proficiency for a character
 */
export async function updateSaveProficiency(
  persId: number,
  ability: Ability,
  isProficient: boolean
): Promise<{ success: true } | { success: false; error: string }> {
  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };

  const pers = owned.pers;
  const currentSaves = (pers as any).additionalSaveProficiencies as Ability[] ?? [];
  
  let nextSaves: Ability[];
  if (isProficient) {
    if (currentSaves.includes(ability)) return { success: true };
    nextSaves = [...currentSaves, ability];
  } else {
    if (!currentSaves.includes(ability)) return { success: true };
    nextSaves = currentSaves.filter(a => a !== ability);
  }

  try {
    await prisma.pers.update({
      where: { persId },
      data: { additionalSaveProficiencies: nextSaves },
    });

    revalidatePath(`/pers/${persId}`);
    revalidatePath(`/character/${persId}`);

    return { success: true };
  } catch (error) {
    console.error("Error updating save proficiency:", error);
    return { success: false, error: "     " };
  }
}

/**
 * Get all bonuses for a character (for initial load)
 */
export async function getAllBonuses(persId: number): Promise<{
  success: true;
  bonuses: {
    statBonuses: StatBonuses | null;
    statModifierBonuses: StatBonuses | null;
    saveBonuses: StatBonuses | null;
    skillBonuses: SkillBonuses | null;
    hpBonuses: { value: number } | null;
    acBonuses: { value: number } | null;
    speedBonuses: { value: number } | null;
    proficiencyBonuses: { value: number } | null;
    initiativeBonuses: { value: number } | null;
    spellAttackBonuses: { value: number } | null;
    spellDCBonuses: { value: number } | null;
  };
} | { success: false; error: string }> {
  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };

  return {
    success: true,
    bonuses: {
      statBonuses: owned.pers.statBonuses as StatBonuses | null,
      statModifierBonuses: owned.pers.statModifierBonuses as StatBonuses | null,
      saveBonuses: owned.pers.saveBonuses as StatBonuses | null,
      skillBonuses: owned.pers.skillBonuses as SkillBonuses | null,
      hpBonuses: owned.pers.hpBonuses as { value: number } | null,
      acBonuses: owned.pers.acBonuses as { value: number } | null,
      speedBonuses: owned.pers.speedBonuses as { value: number } | null,
      proficiencyBonuses: owned.pers.proficiencyBonuses as { value: number } | null,
      initiativeBonuses: owned.pers.initiativeBonuses as { value: number } | null,
      spellAttackBonuses: owned.pers.spellAttackBonuses as { value: number } | null,
      spellDCBonuses: owned.pers.spellDCBonuses as { value: number } | null,
    },
  };
}
</file>

<file path="src/lib/actions/character-logic.ts">
'use server';

import { prisma } from '@/lib/prisma';
import { ProgressionResolver } from '@/lib/logic/progression-resolver';

export async function getLevelUpSteps(persId: number, classId?: number) {
  console.log(` Getting Level-Up steps for persId=${persId}`);

  const pers = await prisma.pers.findUnique({
    where: { persId },
    include: { class: true },
  });

  if (!pers) {
    return { error: 'Character not found' };
  }

  // Determine which class to level up
  // If classId is provided (multiclass choice), use it.
  // Otherwise use primary class.
  const targetClassId = classId || pers.classId;
  
  // Determine current level for THAT class
  // TODO: Logic for multiclass level calculation
  const currentClassLevel = pers.level; // Simplified for single class
  const newLevel = currentClassLevel + 1;

  const className = pers.class.name; // Should fetch class name for targetClassId if different

  const steps = await ProgressionResolver.resolveLevelUpSteps(
    persId,
    targetClassId,
    newLevel,
    className,
    { STR: 10, DEX: 10 } // Mock stats, fetch real ones
  );

  return {
    newLevel,
    className,
    steps,
  };
}
</file>

<file path="src/lib/actions/character-transaction-multiclass.ts">
'use server';

import { prisma } from '@/lib/prisma';
import { confirmLevelUp } from './character-transaction';

interface MulticlassConfirmLevelUpInput {
  persId: number;
  choices: any[];
}

export async function confirmMulticlassLevelUp(input: MulticlassConfirmLevelUpInput) {
  console.log(` Multiclass Level-Up for persId=${input.persId}`);

  // 1. Check if user selected a new class (Multiclassing into something new)
  const newClassChoice = input.choices.find(c => c.stepType === 'MULTICLASS_NEW_CLASS');
  
  if (newClassChoice) {
      // Handle adding a new class to PersClass
      // await prisma.persClass.create(...)
      return { success: true, message: "  !" };
  }

  // 2. Determine which class is being leveled up
  // In a real implementation, the wizard would pass the classId being leveled
  // For now, we assume single class or primary class logic via the standard confirmLevelUp
  
  // We need to calculate the new TOTAL level
  const pers = await prisma.pers.findUnique({ where: { persId: input.persId } });
  if (!pers) return { success: false, error: "Character not found" };

  const newTotalLevel = pers.level + 1;

  // Delegate to the standard handler
  return await confirmLevelUp({
      persId: input.persId,
      choices: input.choices,
      newLevel: newTotalLevel
  });
}

export async function addClassToCharacter(_persId: number, _classId: number) {
    // Logic to add a second class
    // Check prerequisites (stats)
    // Create PersClass record
    return { success: true };
}
</file>

<file path="src/lib/actions/character-transaction.ts">
'use server';

import { prisma } from '@/lib/prisma';
import { learnClassSpells } from './spell-actions';

interface LevelUpChoice {
  stepType: string;
  [key: string]: any;
}

interface ConfirmLevelUpInput {
  persId: number;
  choices: LevelUpChoice[];
  newLevel: number;
}

export async function createCharacter(data: any) {
    // Placeholder for character creation logic
    // This would normally create the Pers, PersClass, etc.
    console.log("Creating character...", data);
    return { success: true, persId: 1 }; // Mock response
}

export async function confirmLevelUp(input: ConfirmLevelUpInput) {
  const { persId, choices, newLevel } = input;

  console.log(`Processing Level Up for persId: ${persId} to level ${newLevel}`);

  try {
    // 1. Validate choices (omitted for brevity)

    // 2. Process choices
    for (const choice of choices) {
      // 
      // HANDLE: CHOICE_SPELLS
      // 
      if (choice.stepType === 'CHOICE_SPELLS') {
        const spellIds = choice.selectedSpellIds as number[];
        if (spellIds && spellIds.length > 0) {
          await learnClassSpells({
            persId,
            spellIds,
            level: newLevel,
          });
        }
      }
      
      // 
      // HANDLE: SELECT_SUBCLASS
      // 
      if (choice.stepType === 'SELECT_SUBCLASS') {
          await prisma.pers.update({
              where: { persId },
              data: { subclassId: choice.subclassId }
          });
      }

      // Add other handlers here (FEAT, ASI, HP, etc.)
    }

    // 3. Update Character Level
    // Note: In a real app, you might update PersClass level instead/also
    await prisma.pers.update({
      where: { persId },
      data: { level: newLevel },
    });

    return { success: true };
  } catch (error) {
    console.error("Level up failed:", error);
    return { success: false, error: "Level up failed" };
  }
}
</file>

<file path="src/lib/actions/combat-actions.ts">
"use server";

import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";

type HpMode = "damage" | "heal" | "temp";

function clampInt(value: unknown, fallback = 0) {
  const n = typeof value === "number" ? value : Number(value);
  if (!Number.isFinite(n)) return fallback;
  return Math.trunc(n);
}

async function assertOwnsPers(persId: number) {
  const session = await auth();
  if (!session?.user?.email) return { ok: false as const, error: " " };

  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
    select: { id: true },
  });
  if (!user) return { ok: false as const, error: "  " };

  const pers = await prisma.pers.findUnique({
    where: { persId },
    select: {
      persId: true,
      userId: true,
      currentHp: true,
      maxHp: true,
      tempHp: true,
      deathSaveSuccesses: true,
      deathSaveFailures: true,
      isDead: true,
    },
  });

  if (!pers || pers.userId !== user.id) return { ok: false as const, error: "   " };
  return { ok: true as const, pers };
}

export async function applyHpChange({
  persId,
  mode,
  amount,
}: {
  persId: number;
  mode: HpMode;
  amount: number;
}): Promise<
  | { success: true; currentHp: number; tempHp: number; maxHp: number; deathSaveSuccesses: number; deathSaveFailures: number; isDead: boolean }
  | { success: false; error: string }
> {
  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };

  const amt = Math.max(0, clampInt(amount, 0));
  const curHp = Math.max(0, clampInt(owned.pers.currentHp, 0));
  const maxHp = Math.max(1, clampInt(owned.pers.maxHp, 1));
  const curTemp = Math.max(0, clampInt(owned.pers.tempHp, 0));

  let nextHp = curHp;
  let nextTemp = curTemp;

  if (mode === "damage") {
    const dmgToTemp = Math.min(nextTemp, amt);
    nextTemp -= dmgToTemp;
    const remaining = amt - dmgToTemp;
    nextHp = Math.max(0, nextHp - remaining);
  } else if (mode === "heal") {
    nextHp = Math.min(maxHp, nextHp + amt);
  } else if (mode === "temp") {
    // DnD 5e: temp HP doesn't stack; take the higher value.
    nextTemp = Math.max(nextTemp, amt);
  } else {
    return { success: false, error: " " };
  }

  // If character is back above 0 HP, clear death saves and dead flag.
  const clearsDeath = nextHp > 0;

  const updated = await prisma.pers.update({
    where: { persId },
    data: {
      currentHp: nextHp,
      tempHp: nextTemp,
      ...(clearsDeath
        ? {
            deathSaveSuccesses: 0,
            deathSaveFailures: 0,
            isDead: false,
          }
        : {}),
    },
    select: {
      currentHp: true,
      tempHp: true,
      maxHp: true,
      deathSaveSuccesses: true,
      deathSaveFailures: true,
      isDead: true,
    },
  });

  revalidatePath(`/pers/${persId}`);
  revalidatePath(`/character/${persId}`);

  return { success: true, ...updated };
}

export async function setDeathSaves({
  persId,
  successes,
  failures,
}: {
  persId: number;
  successes: number;
  failures: number;
}): Promise<
  | { success: true; currentHp: number; deathSaveSuccesses: number; deathSaveFailures: number; isDead: boolean }
  | { success: false; error: string }
> {
  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };

  const nextSuccess = Math.max(0, Math.min(3, clampInt(successes, 0)));
  const nextFail = Math.max(0, Math.min(3, clampInt(failures, 0)));

  // If dead, don't auto-revive via saves.
  if (owned.pers.isDead) {
    const updated = await prisma.pers.update({
      where: { persId },
      data: {
        deathSaveSuccesses: nextSuccess,
        deathSaveFailures: nextFail,
      },
      select: { currentHp: true, deathSaveSuccesses: true, deathSaveFailures: true, isDead: true },
    });

    revalidatePath(`/pers/${persId}`);
    revalidatePath(`/character/${persId}`);
    return { success: true, ...updated };
  }

  // 3 successes => stabilize to 1 HP
  if (nextSuccess >= 3) {
    const updated = await prisma.pers.update({
      where: { persId },
      data: {
        currentHp: 1,
        deathSaveSuccesses: 0,
        deathSaveFailures: 0,
        isDead: false,
      },
      select: { currentHp: true, deathSaveSuccesses: true, deathSaveFailures: true, isDead: true },
    });

    revalidatePath(`/pers/${persId}`);
    revalidatePath(`/character/${persId}`);
    return { success: true, ...updated };
  }

  // 3 failures => dead
  if (nextFail >= 3) {
    const updated = await prisma.pers.update({
      where: { persId },
      data: {
        deathSaveSuccesses: nextSuccess,
        deathSaveFailures: nextFail,
        isDead: true,
      },
      select: { currentHp: true, deathSaveSuccesses: true, deathSaveFailures: true, isDead: true },
    });

    revalidatePath(`/pers/${persId}`);
    revalidatePath(`/character/${persId}`);
    return { success: true, ...updated };
  }

  const updated = await prisma.pers.update({
    where: { persId },
    data: {
      deathSaveSuccesses: nextSuccess,
      deathSaveFailures: nextFail,
    },
    select: { currentHp: true, deathSaveSuccesses: true, deathSaveFailures: true, isDead: true },
  });

  revalidatePath(`/pers/${persId}`);
  revalidatePath(`/character/${persId}`);
  return { success: true, ...updated };
}

export async function reviveCharacter({
  persId,
}: {
  persId: number;
}): Promise<
  | { success: true; currentHp: number; deathSaveSuccesses: number; deathSaveFailures: number; isDead: boolean }
  | { success: false; error: string }
> {
  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };

  const updated = await prisma.pers.update({
    where: { persId },
    data: {
      currentHp: 1,
      deathSaveSuccesses: 0,
      deathSaveFailures: 0,
      isDead: false,
    },
    select: { currentHp: true, deathSaveSuccesses: true, deathSaveFailures: true, isDead: true },
  });

  revalidatePath(`/pers/${persId}`);
  revalidatePath(`/character/${persId}`);
  return { success: true, ...updated };
}
</file>

<file path="src/lib/actions/equipment-actions.ts">
"use server";

import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";
import { Ability } from "@prisma/client";

/**
 * Helper to assert the user owns the pers
 */
async function assertOwnsPers(persId: number) {
  const session = await auth();
  if (!session?.user?.email) return { ok: false as const, error: " " };

  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
    select: { id: true },
  });

  if (!user) return { ok: false as const, error: "  " };

  const pers = await prisma.pers.findUnique({
    where: { persId },
    select: {
      persId: true,
      userId: true,
      wearsShield: true,
      additionalShieldBonus: true,
    },
  });

  if (!pers || pers.userId !== user.id) {
    return { ok: false as const, error: "   " };
  }

  return { ok: true as const, pers };
}

// ============================================================================
// WEAPON ACTIONS
// ============================================================================

export async function addWeapon(
  persId: number,
  weaponId: number | null,
  customData: {
    overrideName?: string;
    attackBonus?: number;
    customDamageBonus?: number;
    customDamageDice?: string;
    customDamageAbility?: Ability;
    isMagical?: boolean;
    isProficient?: boolean;
  }
) {
  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };

  try {
    const newWeapon = await prisma.persWeapon.create({
      data: {
        persId,
        weaponId: weaponId || 1, // Fallback to a default weapon if null? Wait, weaponId is required in schema?
        // Let me check PersWeapon.prisma again.
        // Yes, weaponId is required. I should probably have a "Custom" weapon in DB or allow it to be 0/null if possible.
        // Actually, seed likely has a generic weapon.
        overrideName: customData.overrideName || null,
        attackBonus: customData.attackBonus || 0,
        customDamageBonus: customData.customDamageBonus || 0,
        customDamageDice: customData.customDamageDice || null,
        customDamageAbility: customData.customDamageAbility || null,
        isMagical: customData.isMagical || false,
        isProficient: customData.isProficient ?? true,
      },
    });

    revalidatePath(`/pers/${persId}`);
    revalidatePath(`/character/${persId}`);
    return { success: true, weapon: newWeapon };
  } catch (error) {
    console.error("Error adding weapon:", error);
    return { success: false, error: "   " };
  }
}

export async function updateWeapon(
  persWeaponId: number,
  updates: {
    overrideName?: string | null;
    attackBonus?: number | null;
    customDamageBonus?: number | null;
    customDamageDice?: string | null;
    customDamageAbility?: Ability | null;
    isMagical?: boolean;
    isProficient?: boolean;
  }
) {
  const weapon = await prisma.persWeapon.findUnique({
    where: { persWeaponId },
    select: { persId: true },
  });

  if (!weapon) return { success: false, error: "  " };

  const owned = await assertOwnsPers(weapon.persId);
  if (!owned.ok) return { success: false, error: owned.error };

  try {
    const updated = await prisma.persWeapon.update({
      where: { persWeaponId },
      data: updates,
    });

    revalidatePath(`/pers/${weapon.persId}`);
    revalidatePath(`/character/${weapon.persId}`);
    return { success: true, weapon: updated };
  } catch (error) {
    console.error("Error updating weapon:", error);
    return { success: false, error: "   " };
  }
}

export async function deleteWeapon(persWeaponId: number) {
  const weapon = await prisma.persWeapon.findUnique({
    where: { persWeaponId },
    select: { persId: true },
  });

  if (!weapon) return { success: false, error: "  " };

  const owned = await assertOwnsPers(weapon.persId);
  if (!owned.ok) return { success: false, error: owned.error };

  try {
    await prisma.persWeapon.delete({
      where: { persWeaponId },
    });

    revalidatePath(`/pers/${weapon.persId}`);
    revalidatePath(`/character/${weapon.persId}`);
    return { success: true };
  } catch (error) {
    console.error("Error deleting weapon:", error);
    return { success: false, error: "   " };
  }
}

// ============================================================================
// ARMOR ACTIONS
// ============================================================================

export async function addArmor(
  persId: number,
  armorId: number | null,
  customData: {
    overrideBaseAC?: number;
    miscACBonus?: number;
    isProficient?: boolean;
    equipped?: boolean;
  }
) {
  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };

  try {
    // If equipping new armor, unequip others
    if (customData.equipped) {
      await prisma.persArmor.updateMany({
        where: { persId, equipped: true },
        data: { equipped: false },
      });
    }

    const newArmor = await prisma.persArmor.create({
      data: {
        persId,
        armorId: armorId || 1, // Fallback
        overrideBaseAC: customData.overrideBaseAC || null,
        miscACBonus: customData.miscACBonus || 0,
        isProficient: customData.isProficient ?? true,
        equipped: customData.equipped || false,
      },
    });

    revalidatePath(`/pers/${persId}`);
    revalidatePath(`/character/${persId}`);
    return { success: true, armor: newArmor };
  } catch (error) {
    console.error("Error adding armor:", error);
    return { success: false, error: "   " };
  }
}

export async function updateArmor(
  persArmorId: number,
  updates: {
    overrideBaseAC?: number | null;
    miscACBonus?: number | null;
    isProficient?: boolean;
    equipped?: boolean;
  }
) {
  const armor = await prisma.persArmor.findUnique({
    where: { persArmorId },
    select: { persId: true },
  });

  if (!armor) return { success: false, error: "  " };

  const owned = await assertOwnsPers(armor.persId);
  if (!owned.ok) return { success: false, error: owned.error };

  try {
    // If equipping, unequip others
    if (updates.equipped) {
      await prisma.persArmor.updateMany({
        where: { persId: armor.persId, equipped: true },
        data: { equipped: false },
      });
    }

    const updated = await prisma.persArmor.update({
      where: { persArmorId },
      data: updates,
    });

    revalidatePath(`/pers/${armor.persId}`);
    revalidatePath(`/character/${armor.persId}`);
    return { success: true, armor: updated };
  } catch (error) {
    console.error("Error updating armor:", error);
    return { success: false, error: "   " };
  }
}

export async function deleteArmor(persArmorId: number) {
  const armor = await prisma.persArmor.findUnique({
    where: { persArmorId },
    select: { persId: true },
  });

  if (!armor) return { success: false, error: "  " };

  const owned = await assertOwnsPers(armor.persId);
  if (!owned.ok) return { success: false, error: owned.error };

  try {
    await prisma.persArmor.delete({
      where: { persArmorId },
    });

    revalidatePath(`/pers/${armor.persId}`);
    revalidatePath(`/character/${armor.persId}`);
    return { success: true };
  } catch (error) {
    console.error("Error deleting armor:", error);
    return { success: false, error: "   " };
  }
}

// ============================================================================
// SHIELD ACTIONS
// ============================================================================

export async function updateShieldStatus(
  persId: number,
  updates: {
    wearsShield?: boolean;
    additionalShieldBonus?: number;
  }
) {
  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };

  try {
    await prisma.pers.update({
      where: { persId },
      data: updates,
    });

    revalidatePath(`/pers/${persId}`);
    revalidatePath(`/character/${persId}`);
    return { success: true };
  } catch (error) {
    console.error("Error updating shield:", error);
    return { success: false, error: "   " };
  }
}

// ============================================================================
// DATA FETCHING
// ============================================================================

export async function getBaseEquipment() {
  try {
    const [weapons, armors] = await Promise.all([
      prisma.weapon.findMany({
        orderBy: { sortOrder: 'asc' },
      }),
      prisma.armor.findMany({
        orderBy: { baseAC: 'asc' }
      })
    ]);

    return { success: true, weapons, armors };
  } catch (error) {
    console.error("Error fetching base equipment:", error);
    return { success: false, error: "    " };
  }
}
</file>

<file path="src/lib/actions/feature-uses.ts">
"use server";

import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";

export async function spendFeatureUse({
  persId,
  featureId,
}: {
  persId: number;
  featureId: number;
}): Promise<{ success: true; usesRemaining: number | null } | { success: false; error: string }> {
  const session = await auth();
  if (!session?.user?.email) return { success: false, error: " " };

  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
    select: { id: true },
  });
  if (!user) return { success: false, error: "  " };

  const pers = await prisma.pers.findUnique({
    where: { persId },
    select: { persId: true, userId: true },
  });
  if (!pers || pers.userId !== user.id) return { success: false, error: "   " };

  const pf = await prisma.persFeature.findUnique({
    where: {
      persId_featureId: {
        persId,
        featureId,
      },
    },
    select: { usesRemaining: true },
  });

  const cur = pf?.usesRemaining;
  if (typeof cur !== "number") {
    return { success: true, usesRemaining: null };
  }

  const next = Math.max(0, Math.trunc(cur) - 1);

  const updated = await prisma.persFeature.update({
    where: {
      persId_featureId: {
        persId,
        featureId,
      },
    },
    data: { usesRemaining: next },
    select: { usesRemaining: true },
  });

  revalidatePath(`/pers/${persId}`);
  revalidatePath(`/character/${persId}`);

  return { success: true, usesRemaining: updated.usesRemaining };
}

export async function restoreFeatureUse({
  persId,
  featureId,
}: {
  persId: number;
  featureId: number;
}): Promise<{ success: true; usesRemaining: number | null } | { success: false; error: string }> {
  const session = await auth();
  if (!session?.user?.email) return { success: false, error: " " };

  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
    select: { id: true },
  });
  if (!user) return { success: false, error: "  " };

  const pers = await prisma.pers.findUnique({
    where: { persId },
    select: { persId: true, userId: true },
  });
  if (!pers || pers.userId !== user.id) return { success: false, error: "   " };

  const pf = await prisma.persFeature.findUnique({
    where: {
      persId_featureId: {
        persId,
        featureId,
      },
    },
    include: { 
      feature: true,
      pers: {
        select: { level: true }
      }
    },
  });

  if (!pf) return { success: false, error: "  " };

  // Calculate max uses
  let max = pf.feature.usesCount;
  if (pf.feature.usesCountDependsOnProficiencyBonus) {
      max = Math.ceil(pf.pers.level / 4) + 1;
  }
  
  const cur = pf.usesRemaining;
  if (typeof cur !== "number" || typeof max !== "number") {
    return { success: true, usesRemaining: null };
  }

  const next = Math.min(max, Math.trunc(cur) + 1);

  const updated = await prisma.persFeature.update({
    where: {
      persId_featureId: {
        persId,
        featureId,
      },
    },
    data: { usesRemaining: next },
    select: { usesRemaining: true },
  });

  revalidatePath(`/pers/${persId}`);
  revalidatePath(`/character/${persId}`);

  return { success: true, usesRemaining: updated.usesRemaining };
}
</file>

<file path="src/lib/actions/rest-actions.ts">
"use server";

import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";
import { RestType } from "@prisma/client";
import { getAbilityMod } from "@/lib/logic/utils";

/**
 * Helper to assert the user owns the pers and return pers data
 */
async function assertOwnsPers(persId: number) {
  const session = await auth();
  if (!session?.user?.email) return { ok: false as const, error: " " };

  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
    select: { id: true },
  });

  if (!user) return { ok: false as const, error: "  " };

  const pers = await prisma.pers.findUnique({
    where: { persId },
    select: {
      persId: true,
      userId: true,
      currentHp: true,
      maxHp: true,
      tempHp: true,
      level: true,
      con: true,
      currentHitDice: true,
      usedHitDice: true,
      currentSpellSlots: true,
      currentPactSlots: true,
      class: {
        select: {
          classId: true,
          hitDie: true,
        },
      },
      multiclasses: {
        select: {
          classId: true,
          classLevel: true,
          class: {
            select: {
              hitDie: true,
            },
          },
        },
      },
    },
  });

  if (!pers || pers.userId !== user.id) {
    return { ok: false as const, error: "   " };
  }

  return { ok: true as const, pers };
}

/**
 * Get max hit dice per class for a character
 * Returns an object with classId as key and { max, hitDie } as value
 */
function getMaxHitDiceByClass(
  pers: NonNullable<Awaited<ReturnType<typeof assertOwnsPers>> & { ok: true }>["pers"]
): Record<number, { max: number; hitDie: number }> {
  const result: Record<number, { max: number; hitDie: number }> = {};
  
  // Calculate main class level (total level - sum of multiclass levels)
  const multiclassLevelSum = pers.multiclasses.reduce((acc, mc) => acc + mc.classLevel, 0);
  const mainClassLevel = pers.level - multiclassLevelSum;
  
  // Main class
  result[pers.class.classId] = {
    max: mainClassLevel,
    hitDie: pers.class.hitDie,
  };
  
  // Multiclasses
  for (const mc of pers.multiclasses) {
    result[mc.classId] = {
      max: mc.classLevel,
      hitDie: mc.class.hitDie,
    };
  }
  
  return result;
}

/**
 * Get current hit dice by class (from JSON or calculate defaults)
 */
function getCurrentHitDiceByClass(
  pers: NonNullable<Awaited<ReturnType<typeof assertOwnsPers>> & { ok: true }>["pers"],
  maxByClass: Record<number, { max: number; hitDie: number }>
): Record<number, number> {
  const stored = pers.currentHitDice as Record<string, number> | null;
  const result: Record<number, number> = {};
  
  for (const classIdStr of Object.keys(maxByClass)) {
    const classId = Number(classIdStr);
    if (stored && typeof stored[classIdStr] === "number") {
      result[classId] = Math.max(0, Math.min(stored[classIdStr], maxByClass[classId].max));
    } else {
      // Default to max if not set
      result[classId] = maxByClass[classId].max;
    }
  }
  
  return result;
}

export interface HitDiceToUse {
  classId: number;
  count: number;
}

export interface ShortRestResult {
  success: true;
  hpRestored: number;
  newCurrentHp: number;
  currentHitDice: Record<number, number>;
  featuresRestored: number;
}

export interface ShortRestError {
  success: false;
  error: string;
}

/**
 * Perform a short rest
 * - Use hit dice to restore HP
 * - Restore features with limitedUsesPer = SHORT_REST
 */
export async function shortRest(
  persId: number,
  hitDiceToUse: HitDiceToUse[]
): Promise<ShortRestResult | ShortRestError> {
  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };
  
  const pers = owned.pers;
  const maxByClass = getMaxHitDiceByClass(pers);
  const currentByClass = getCurrentHitDiceByClass(pers, maxByClass);
  const conMod = getAbilityMod(pers.con);
  
  // Validate dice usage
  let totalHpRestored = 0;
  const updatedDice = { ...currentByClass };
  
  for (const dice of hitDiceToUse) {
    if (!maxByClass[dice.classId]) {
      return { success: false, error: `  ID: ${dice.classId}` };
    }
    
    const available = currentByClass[dice.classId] ?? 0;
    if (dice.count > available) {
      return { success: false, error: ` -   ${dice.classId}` };
    }
    
    // Calculate HP: roll hit dice + CON modifier per die
    // For simplicity, use average roll (half of die max, rounded up)
    const hitDie = maxByClass[dice.classId].hitDie;
    const avgRoll = Math.ceil(hitDie / 2);
    
    for (let i = 0; i < dice.count; i++) {
      // Random roll between 1 and hitDie, or use average
      const roll = Math.max(1, Math.floor(Math.random() * hitDie) + 1);
      totalHpRestored += Math.max(1, roll + conMod);
    }
    
    updatedDice[dice.classId] = available - dice.count;
  }
  
  // Calculate new HP (capped at maxHp)
  const newCurrentHp = Math.min(pers.maxHp, pers.currentHp + totalHpRestored);
  
  // Restore SHORT_REST features
  const featuresWithShortRest = await prisma.persFeature.findMany({
    where: {
      persId,
      feature: {
        limitedUsesPer: RestType.SHORT_REST,
      },
    },
    include: {
      feature: {
        select: {
          usesCount: true,
          usesCountDependsOnProficiencyBonus: true,
        },
      },
    },
  });
  
  const proficiencyBonus = 2 + Math.floor((pers.level - 1) / 4);
  let featuresRestored = 0;
  
  for (const pf of featuresWithShortRest) {
    const maxUses = pf.feature.usesCountDependsOnProficiencyBonus
      ? proficiencyBonus
      : pf.feature.usesCount ?? 0;
    
    if (maxUses > 0) {
      await prisma.persFeature.update({
        where: {
          persId_featureId: {
            persId,
            featureId: pf.featureId,
          },
        },
        data: { usesRemaining: maxUses },
      });
      featuresRestored++;
    }
  }
  
  // Update database
  await prisma.pers.update({
    where: { persId },
    data: {
      currentHp: newCurrentHp,
      currentHitDice: updatedDice as object,
    },
  });
  
  revalidatePath(`/pers/${persId}`);
  revalidatePath(`/character/${persId}`);
  
  return {
    success: true,
    hpRestored: totalHpRestored,
    newCurrentHp,
    currentHitDice: updatedDice,
    featuresRestored,
  };
}

export interface LongRestResult {
  success: true;
  newCurrentHp: number;
  currentHitDice: Record<number, number>;
  currentSpellSlots: number[];
  currentPactSlots: number;
  spellSlotsRestored: boolean;
  featuresRestored: number;
}

export interface LongRestError {
  success: false;
  error: string;
}

/**
 * Perform a long rest
 * - Restore HP to max
 * - Restore all hit dice
 * - Restore all spell slots
 * - Restore all features (SHORT_REST and LONG_REST types)
 */
export async function longRest(persId: number): Promise<LongRestResult | LongRestError> {
  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };
  
  const pers = owned.pers;
  const maxByClass = getMaxHitDiceByClass(pers);
  
  // Restore all hit dice to max
  const restoredHitDice: Record<number, number> = {};
  for (const classIdStr of Object.keys(maxByClass)) {
    const classId = Number(classIdStr);
    restoredHitDice[classId] = maxByClass[classId].max;
  }
  
  // Restore ALL features (both SHORT_REST and LONG_REST)
  const featuresWithRest = await prisma.persFeature.findMany({
    where: {
      persId,
      feature: {
        limitedUsesPer: {
          in: [RestType.SHORT_REST, RestType.LONG_REST],
        },
      },
    },
    include: {
      feature: {
        select: {
          usesCount: true,
          usesCountDependsOnProficiencyBonus: true,
        },
      },
    },
  });
  
  const proficiencyBonus = 2 + Math.floor((pers.level - 1) / 4);
  let featuresRestored = 0;
  
  for (const pf of featuresWithRest) {
    const maxUses = pf.feature.usesCountDependsOnProficiencyBonus
      ? proficiencyBonus
      : pf.feature.usesCount ?? 0;
    
    if (maxUses > 0) {
      await prisma.persFeature.update({
        where: {
          persId_featureId: {
            persId,
            featureId: pf.featureId,
          },
        },
        data: { usesRemaining: maxUses },
      });
      featuresRestored++;
    }
  }
  
  // Get max spell slots for the character's level
  // Using standard 5e spell slot progression
  const maxSpellSlots = getMaxSpellSlots(pers.level);
  const maxPactSlots = getMaxPactSlots(pers.level);
  
  // Update database
  await prisma.pers.update({
    where: { persId },
    data: {
      currentHp: pers.maxHp,
      tempHp: 0, // Reset temp HP on long rest
      currentHitDice: restoredHitDice as object,
      currentSpellSlots: maxSpellSlots,
      currentPactSlots: maxPactSlots, // Warlocks
      deathSaveSuccesses: 0,
      deathSaveFailures: 0,
      isDead: false,
    },
  });
  
  revalidatePath(`/pers/${persId}`);
  revalidatePath(`/character/${persId}`);
  
  return {
    success: true,
    newCurrentHp: pers.maxHp,
    currentHitDice: restoredHitDice,
    currentSpellSlots: maxSpellSlots,
    currentPactSlots: maxPactSlots,
    spellSlotsRestored: true,
    featuresRestored,
  };
}

/**
 * Get standard max spell slots for a given caster level
 * This is a simplified version - in reality, depends on class
 */
function getMaxSpellSlots(level: number): number[] {
  const slotProgression: number[][] = [
    [],                           // Level 0 (doesn't exist)
    [2, 0, 0, 0, 0, 0, 0, 0, 0],  // Level 1
    [3, 0, 0, 0, 0, 0, 0, 0, 0],  // Level 2
    [4, 2, 0, 0, 0, 0, 0, 0, 0],  // Level 3
    [4, 3, 0, 0, 0, 0, 0, 0, 0],  // Level 4
    [4, 3, 2, 0, 0, 0, 0, 0, 0],  // Level 5
    [4, 3, 3, 0, 0, 0, 0, 0, 0],  // Level 6
    [4, 3, 3, 1, 0, 0, 0, 0, 0],  // Level 7
    [4, 3, 3, 2, 0, 0, 0, 0, 0],  // Level 8
    [4, 3, 3, 3, 1, 0, 0, 0, 0],  // Level 9
    [4, 3, 3, 3, 2, 0, 0, 0, 0],  // Level 10
    [4, 3, 3, 3, 2, 1, 0, 0, 0],  // Level 11
    [4, 3, 3, 3, 2, 1, 0, 0, 0],  // Level 12
    [4, 3, 3, 3, 2, 1, 1, 0, 0],  // Level 13
    [4, 3, 3, 3, 2, 1, 1, 0, 0],  // Level 14
    [4, 3, 3, 3, 2, 1, 1, 1, 0],  // Level 15
    [4, 3, 3, 3, 2, 1, 1, 1, 0],  // Level 16
    [4, 3, 3, 3, 2, 1, 1, 1, 1],  // Level 17
    [4, 3, 3, 3, 3, 1, 1, 1, 1],  // Level 18
    [4, 3, 3, 3, 3, 2, 1, 1, 1],  // Level 19
    [4, 3, 3, 3, 3, 2, 2, 1, 1],  // Level 20
  ];
  
  const clampedLevel = Math.max(1, Math.min(20, level));
  return slotProgression[clampedLevel] ?? [0, 0, 0, 0, 0, 0, 0, 0, 0];
}

/**
 * Get max pact slots for Warlocks
 */
function getMaxPactSlots(level: number): number {
  if (level < 1) return 0;
  if (level === 1) return 1;
  if (level <= 10) return 2;
  if (level <= 16) return 3;
  return 4;
}

/**
 * Get hit dice info for a character (for display purposes)
 */
export async function getHitDiceInfo(persId: number): Promise<{
  success: true;
  hitDice: Array<{
    classId: number;
    className: string;
    hitDie: number;
    current: number;
    max: number;
  }>;
} | { success: false; error: string }> {
  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };
  
  const pers = owned.pers;
  const maxByClass = getMaxHitDiceByClass(pers);
  const currentByClass = getCurrentHitDiceByClass(pers, maxByClass);
  
  // Get class names
  const classIds = Object.keys(maxByClass).map(Number);
  const classes = await prisma.class.findMany({
    where: { classId: { in: classIds } },
    select: { classId: true, name: true },
  });
  
  const classNameMap = new Map(classes.map(c => [c.classId, c.name]));
  
  const hitDice = classIds.map(classId => ({
    classId,
    className: classNameMap.get(classId) ?? "",
    hitDie: maxByClass[classId].hitDie,
    current: currentByClass[classId],
    max: maxByClass[classId].max,
  }));
  
  return { success: true, hitDice };
}
</file>

<file path="src/lib/actions/share-actions.ts">
"use server";

import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { randomBytes } from "crypto";

export async function generateShareToken(persId: number) {
  const session = await auth();
  if (!session?.user?.email) return { error: "Unauthorized" };

  try {
    const pers = await prisma.pers.findUnique({
      where: { persId },
      select: { userId: true }
    });

    if (!pers) return { error: "Character not found" };

    const user = await prisma.user.findUnique({ where: { email: session.user.email } });
    if (pers.userId !== user?.id) return { error: "Forbidden" };

    const token = randomBytes(16).toString("hex");

    await prisma.pers.update({
      where: { persId },
      data: { shareToken: token }
    });

    return { success: true, token };
  } catch (error) {
    console.error("Token generation failed:", error);
    return { error: "Failed to generate share link" };
  }
}

export async function getPersByShareToken(token: string) {
  const pers = await prisma.pers.findUnique({
    where: { shareToken: token },
    include: {
        race: {
            include: {
                traits: {
                    include: {
                        feature: true
                    }
                }
            }
        },
        subrace: {
            include: {
                traits: {
                    include: {
                        feature: true
                    }
                }
            }
        },
        class: {
            include: {
                features: {
                    include: {
                        feature: true
                    }
                }
            }
        },
        subclass: {
            include: {
                features: {
                    include: {
                        feature: true
                    }
                }
            }
        },
        multiclasses: {
            include: {
                class: {
                    include: {
                        features: {
                            include: {
                                feature: true,
                            },
                        },
                    },
                },
                subclass: {
                    include: {
                        features: {
                            include: {
                                feature: true,
                            },
                        },
                    },
                },
            },
        },
        background: true,
        skills: true,
        feats: { 
            include: { 
                feat: true,
                choices: {
                    include: {
                        choiceOption: true,
                    }
                }
            } 
        },
        raceVariants: {
            include: {
                traits: {
                    include: {
                        feature: true,
                    },
                },
            },
        },
        features: { include: { feature: true } },
        choiceOptions: true,
        raceChoiceOptions: true,
        persSpells: {
            include: {
                spell: true,
            },
            orderBy: [
                { spell: { level: "asc" } },
                { spell: { name: "asc" } },
            ],
        },
        weapons: { include: { weapon: true } },
        armors: { include: { armor: true } },
    }
  });

  return pers;
}

export async function copyPersByToken(token: string) {
  const session = await auth();
  if (!session?.user?.email) return { error: ",   " };

  try {
    const user = await prisma.user.findUnique({ where: { email: session.user.email } });
    if (!user) return { error: "  " };

    const sourcePers = await prisma.pers.findUnique({
      where: { shareToken: token },
      include: {
        skills: true,
        persSpells: true,
        features: true,
        feats: { include: { choices: true } },
        weapons: true,
        armors: true,
        multiclasses: true,
        magicItems: true,
        raceVariants: true,
        raceChoiceOptions: true,
        choiceOptions: true,
        classOptionalFeatures: true,
        spells: true,
      }
    });

    if (!sourcePers) return { error: "     " };

    const newPersId = await prisma.$transaction(async (tx) => {
      const newPers = await tx.pers.create({
        data: {
          userId: user.id,
          name: `${sourcePers.name} ()`,
          level: sourcePers.level,
          currentSpellSlots: sourcePers.currentSpellSlots,
          currentPactSlots: sourcePers.currentPactSlots,
          classId: sourcePers.classId,
          subclassId: sourcePers.subclassId,
          backgroundId: sourcePers.backgroundId,
          raceId: sourcePers.raceId,
          subraceId: sourcePers.subraceId,
          currentHp: sourcePers.currentHp,
          maxHp: sourcePers.maxHp,
          tempHp: sourcePers.tempHp,
          deathSaveSuccesses: sourcePers.deathSaveSuccesses,
          deathSaveFailures: sourcePers.deathSaveFailures,
          isDead: sourcePers.isDead,
          raceCustom: sourcePers.raceCustom,
          classCustom: sourcePers.classCustom,
          alignment: sourcePers.alignment,
          xp: sourcePers.xp,
          customBackground: sourcePers.customBackground,
          customProficiencies: sourcePers.customProficiencies,
          customFeatures: sourcePers.customFeatures,
          customLanguagesKnown: sourcePers.customLanguagesKnown,
          customEquipment: sourcePers.customEquipment,
          personalityTraits: sourcePers.personalityTraits,
          ideals: sourcePers.ideals,
          bonds: sourcePers.bonds,
          flaws: sourcePers.flaws,
          backstory: sourcePers.backstory,
          notes: sourcePers.notes,
          str: sourcePers.str,
          dex: sourcePers.dex,
          con: sourcePers.con,
          int: sourcePers.int,
          wis: sourcePers.wis,
          cha: sourcePers.cha,
          cp: sourcePers.cp,
          ep: sourcePers.ep,
          sp: sourcePers.sp,
          gp: sourcePers.gp,
          pp: sourcePers.pp,
          additionalSaveProficiencies: sourcePers.additionalSaveProficiencies,
          miscSaveBonuses: sourcePers.miscSaveBonuses || undefined,
          wearsShield: sourcePers.wearsShield,
          additionalShieldBonus: sourcePers.additionalShieldBonus,
          armorBonus: sourcePers.armorBonus,
          wearsNaturalArmor: sourcePers.wearsNaturalArmor,
          statBonuses: sourcePers.statBonuses || undefined,
          statModifierBonuses: sourcePers.statModifierBonuses || undefined,
          saveBonuses: sourcePers.saveBonuses || undefined,
          skillBonuses: sourcePers.skillBonuses || undefined,
          hpBonuses: sourcePers.hpBonuses || undefined,
          acBonuses: sourcePers.acBonuses || undefined,
          speedBonuses: sourcePers.speedBonuses || undefined,
          proficiencyBonuses: sourcePers.proficiencyBonuses || undefined,
          initiativeBonuses: sourcePers.initiativeBonuses || undefined,
          spellAttackBonuses: sourcePers.spellAttackBonuses || undefined,
          spellDCBonuses: sourcePers.spellDCBonuses || undefined,
          currentHitDice: sourcePers.currentHitDice || undefined,
          usedHitDice: sourcePers.usedHitDice || undefined,
          
          isSnapshot: false,
          
          raceVariants: { connect: sourcePers.raceVariants.map(rv => ({ raceVariantId: rv.raceVariantId })) },
          raceChoiceOptions: { connect: sourcePers.raceChoiceOptions.map(rco => ({ optionId: rco.optionId })) },
          choiceOptions: { connect: sourcePers.choiceOptions.map(co => ({ choiceOptionId: co.choiceOptionId })) },
          classOptionalFeatures: { connect: sourcePers.classOptionalFeatures.map(cof => ({ optionalFeatureId: cof.optionalFeatureId })) },
          spells: { connect: sourcePers.spells.map(s => ({ spellId: s.spellId })) },
        }
      });

      if (sourcePers.skills.length > 0) {
        await tx.persSkill.createMany({
          data: sourcePers.skills.map(s => ({
            persId: newPers.persId,
            skillId: s.skillId,
            name: s.name,
            proficiencyType: s.proficiencyType,
            customModifier: s.customModifier,
          }))
        });
      }

      if (sourcePers.persSpells.length > 0) {
        await tx.persSpell.createMany({
          data: sourcePers.persSpells.map(ps => ({
            persId: newPers.persId,
            spellId: ps.spellId,
            learnedAtLevel: ps.learnedAtLevel,
            isPrepared: ps.isPrepared,
            origin: ps.origin,
            sourceId: ps.sourceId,
            sourceName: ps.sourceName,
            notes: ps.notes,
          }))
        });
      }

      if (sourcePers.features.length > 0) {
        await tx.persFeature.createMany({
          data: sourcePers.features.map(f => ({
            persId: newPers.persId,
            featureId: f.featureId,
            usesRemaining: f.usesRemaining,
          }))
        });
      }

      for (const pf of sourcePers.feats) {
        const newPersFeat = await tx.persFeat.create({
          data: { persId: newPers.persId, featId: pf.featId }
        });
        if (pf.choices.length > 0) {
          await tx.persFeatChoice.createMany({
            data: pf.choices.map(c => ({
              persFeatId: newPersFeat.persFeatId,
              choiceOptionId: c.choiceOptionId,
            }))
          });
        }
      }

      if (sourcePers.weapons.length > 0) {
        await tx.persWeapon.createMany({
          data: sourcePers.weapons.map(w => ({
            persId: newPers.persId,
            weaponId: w.weaponId,
            overrideName: w.overrideName,
            customDamageDice: w.customDamageDice,
            customDamageAbility: w.customDamageAbility,
            customDamageBonus: w.customDamageBonus as any,
            isProficient: w.isProficient,
          }))
        });
      }

      if (sourcePers.armors.length > 0) {
        await tx.persArmor.createMany({
          data: sourcePers.armors.map(a => ({
            persId: newPers.persId,
            armorId: a.armorId,
            overrideBaseAC: a.overrideBaseAC,
            isProficient: a.isProficient,
            equipped: a.equipped,
            miscACBonus: a.miscACBonus,
          }))
        });
      }

      if (sourcePers.multiclasses.length > 0) {
        await tx.persMulticlass.createMany({
          data: sourcePers.multiclasses.map(m => ({
            persId: newPers.persId,
            classId: m.classId,
            classLevel: m.classLevel,
            subclassId: m.subclassId,
          }))
        });
      }

      if (sourcePers.magicItems.length > 0) {
        await tx.persMagicItem.createMany({
          data: sourcePers.magicItems.map(mi => ({
            persId: newPers.persId,
            magicItemId: mi.magicItemId,
          }))
        });
      }

      return newPers.persId;
    });

    return { success: true, persId: newPersId };
  } catch (error) {
    console.error("Copy char failed:", error);
    return { error: "   " };
  }
}
</file>

<file path="src/lib/actions/snapshot-actions.ts">
"use server";

import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";

export async function createCharacterSnapshot(persId: number) {
  const session = await auth();
  if (!session?.user?.email) return { error: "Unauthorized" };

  try {
    const pers = await prisma.pers.findUnique({
      where: { persId },
      include: {
        skills: true,
        persSpells: true,
        features: true,
        feats: {
          include: {
            choices: true,
          }
        },
        weapons: true,
        armors: true,
        multiclasses: true,
        magicItems: true,
        // Implicit M:N relations
        raceVariants: true,
        raceChoiceOptions: true,
        choiceOptions: true,
        classOptionalFeatures: true,
        spells: true,
      }
    });

    if (!pers) return { error: "Character not found" };

    // Deep copy logic
    const snapshot = await prisma.$transaction(async (tx) => {
      // 1. Create the base character record
      const newPers = await tx.pers.create({
        data: {
          userId: pers.userId,
          name: `${pers.name} ( ${pers.level})`,
          level: pers.level,
          currentSpellSlots: pers.currentSpellSlots,
          currentPactSlots: pers.currentPactSlots,
          classId: pers.classId,
          subclassId: pers.subclassId,
          backgroundId: pers.backgroundId,
          raceId: pers.raceId,
          subraceId: pers.subraceId,
          currentHp: pers.currentHp,
          maxHp: pers.maxHp,
          tempHp: pers.tempHp,
          deathSaveSuccesses: pers.deathSaveSuccesses,
          deathSaveFailures: pers.deathSaveFailures,
          isDead: pers.isDead,
          raceCustom: pers.raceCustom,
          classCustom: pers.classCustom,
          alignment: pers.alignment,
          xp: pers.xp,
          customBackground: pers.customBackground,
          customProficiencies: pers.customProficiencies,
          customFeatures: pers.customFeatures,
          customLanguagesKnown: pers.customLanguagesKnown,
          customEquipment: pers.customEquipment,
          personalityTraits: pers.personalityTraits,
          ideals: pers.ideals,
          bonds: pers.bonds,
          flaws: pers.flaws,
          backstory: pers.backstory,
          notes: pers.notes,
          str: pers.str,
          dex: pers.dex,
          con: pers.con,
          int: pers.int,
          wis: pers.wis,
          cha: pers.cha,
          cp: pers.cp,
          ep: pers.ep,
          sp: pers.sp,
          gp: pers.gp,
          pp: pers.pp,
          additionalSaveProficiencies: pers.additionalSaveProficiencies,
          miscSaveBonuses: pers.miscSaveBonuses || undefined,
          wearsShield: pers.wearsShield,
          additionalShieldBonus: pers.additionalShieldBonus,
          armorBonus: pers.armorBonus,
          wearsNaturalArmor: pers.wearsNaturalArmor,
          statBonuses: pers.statBonuses || undefined,
          statModifierBonuses: pers.statModifierBonuses || undefined,
          saveBonuses: pers.saveBonuses || undefined,
          skillBonuses: pers.skillBonuses || undefined,
          hpBonuses: pers.hpBonuses || undefined,
          acBonuses: pers.acBonuses || undefined,
          speedBonuses: pers.speedBonuses || undefined,
          proficiencyBonuses: pers.proficiencyBonuses || undefined,
          initiativeBonuses: pers.initiativeBonuses || undefined,
          spellAttackBonuses: pers.spellAttackBonuses || undefined,
          spellDCBonuses: pers.spellDCBonuses || undefined,
          currentHitDice: pers.currentHitDice || undefined,
          usedHitDice: pers.usedHitDice || undefined,
          
          // Snapshot specific
          parentPersId: pers.persId,
          isSnapshot: true,
          snapshotLevel: pers.level,
          isActive: false,

          // Connect M:N relations
          raceVariants: { connect: pers.raceVariants.map(rv => ({ raceVariantId: rv.raceVariantId })) },
          raceChoiceOptions: { connect: pers.raceChoiceOptions.map(rco => ({ raceChoiceOptionId: rco.raceChoiceOptionId })) },
          choiceOptions: { connect: pers.choiceOptions.map(co => ({ choiceOptionId: co.choiceOptionId })) },
          classOptionalFeatures: { connect: pers.classOptionalFeatures.map(cof => ({ optionalFeatureId: cof.optionalFeatureId })) },
          spells: { connect: pers.spells.map(s => ({ spellId: s.spellId })) },
        }
      });

      // 2. Create related records (Deep Clone)
      
      // Skills
      if (pers.skills.length > 0) {
        await tx.persSkill.createMany({
          data: pers.skills.map(s => ({
            persId: newPers.persId,
            skillId: s.skillId,
            name: s.name,
            proficiencyType: s.proficiencyType,
            customModifier: s.customModifier,
          }))
        });
      }

      // PersSpells (for prepared status, origin, etc.)
      if (pers.persSpells.length > 0) {
        await tx.persSpell.createMany({
          data: pers.persSpells.map(ps => ({
            persId: newPers.persId,
            spellId: ps.spellId,
            learnedAtLevel: ps.learnedAtLevel,
            isPrepared: ps.isPrepared,
            origin: ps.origin,
            sourceId: ps.sourceId,
            sourceName: ps.sourceName,
            notes: ps.notes,
          }))
        });
      }

      // Features
      if (pers.features.length > 0) {
        await tx.persFeature.createMany({
          data: pers.features.map(f => ({
            persId: newPers.persId,
            featureId: f.featureId,
            usesRemaining: f.usesRemaining,
          }))
        });
      }

      // Feats
      for (const pf of pers.feats) {
        const newPersFeat = await tx.persFeat.create({
          data: {
            persId: newPers.persId,
            featId: pf.featId,
          }
        });
        if (pf.choices.length > 0) {
          await tx.persFeatChoice.createMany({
            data: pf.choices.map(c => ({
              persFeatId: newPersFeat.persFeatId,
              choiceOptionId: c.choiceOptionId,
            }))
          });
        }
      }

      // Weapons
      if (pers.weapons.length > 0) {
        await tx.persWeapon.createMany({
          data: pers.weapons.map(w => ({
            persId: newPers.persId,
            weaponId: w.weaponId,
            overrideName: w.overrideName,
            customDamageDice: w.customDamageDice,
            customDamageAbility: w.customDamageAbility,
            customDamageBonus: w.customDamageBonus,
            isProficient: w.isProficient,
            equipped: w.equipped,
          }))
        });
      }

      // Armors
      if (pers.armors.length > 0) {
        await tx.persArmor.createMany({
          data: pers.armors.map(a => ({
            persId: newPers.persId,
            armorId: a.armorId,
            overrideName: a.overrideName,
            overrideBaseAC: a.overrideBaseAC,
            isProficient: a.isProficient,
            equipped: a.equipped,
            miscACBonus: a.miscACBonus,
          }))
        });
      }

      // Multiclasses
      if (pers.multiclasses.length > 0) {
        await tx.persMulticlass.createMany({
          data: pers.multiclasses.map(m => ({
            persId: newPers.persId,
            classId: m.classId,
            classLevel: m.classLevel,
            subclassId: m.subclassId,
          }))
        });
      }

      // Magic Items
      if (pers.magicItems.length > 0) {
        await tx.persMagicItem.createMany({
          data: pers.magicItems.map(mi => ({
            persId: newPers.persId,
            magicItemId: mi.magicItemId,
          }))
        });
      }

      return newPers;
    });

    return { success: true, snapshotId: snapshot.persId };
  } catch (error) {
    console.error("Snapshot creation failed:", error);
    return { error: "Failed to create character snapshot" };
  }
}

export async function getSnapshots(persId: number) {
  const session = await auth();
  if (!session?.user?.email) return [];

  return prisma.pers.findMany({
    where: { 
      parentPersId: persId,
      isSnapshot: true 
    },
    orderBy: { snapshotLevel: 'desc' },
    select: {
      persId: true,
      name: true,
      level: true,
      snapshotLevel: true,
      createdAt: true,
      isActive: true,
    }
  });
}

export async function activateSnapshot(snapshotId: number) {
  const session = await auth();
  if (!session?.user?.email) return { error: "Unauthorized" };

  try {
    const snapshot = await prisma.pers.findUnique({
      where: { persId: snapshotId },
      select: { userId: true, parentPersId: true }
    });

    if (!snapshot || !snapshot.parentPersId) return { error: "Snapshot not found" };

    const user = await prisma.user.findUnique({ where: { email: session.user.email } });
    if (snapshot.userId !== user?.id) return { error: "Forbidden" };

    await prisma.pers.update({
      where: { persId: snapshotId },
      data: { isActive: true }
    });

    revalidatePath("/pers/home");
    return { success: true };
  } catch (error) {
    console.error("Snapshot activation failed:", error);
    return { error: "Failed to activate snapshot" };
  }
}
</file>

<file path="src/lib/actions/spell-slots.ts">
"use server";

import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";
import { calculateCasterLevel } from "../logic/spell-logic";
import { SPELL_SLOT_PROGRESSION } from "../refs/static";

async function assertOwnsPers(persId: number) {
  const session = await auth();
  if (!session?.user?.email) return { ok: false as const, error: " " };

  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
    select: { id: true },
  });

  if (!user) return { ok: false as const, error: "  " };

  const pers = await prisma.pers.findUnique({
    where: { persId },
    select: {
      persId: true,
      userId: true,
      currentSpellSlots: true,
      currentPactSlots: true,
    },
  });

  if (!pers || pers.userId !== user.id) {
    return { ok: false as const, error: "   " };
  }

  return { ok: true as const, pers };
}

/**
 * Decrement a standard spell slot of given level (1..9).
 * Updates Pers.currentSpellSlots in DB.
 */
export async function spendSpellSlot(
  persId: number,
  slotLevel: number
): Promise<{ success: true; currentSpellSlots: number[] } | { success: false; error: string }> {
  const level = Math.trunc(Number(slotLevel));
  if (!Number.isFinite(level) || level < 1 || level > 9) {
    return { success: false, error: "  " };
  }

  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };

  const raw = Array.isArray(owned.pers.currentSpellSlots) ? owned.pers.currentSpellSlots : [];
  const next = Array.from({ length: 9 }, (_, idx) => {
    const v = raw[idx];
    return Number.isFinite(v) ? Math.max(0, Math.trunc(v)) : 0;
  });

  const idx = level - 1;
  if ((next[idx] ?? 0) <= 0) {
    return { success: true, currentSpellSlots: next };
  }

  next[idx] = Math.max(0, (next[idx] ?? 0) - 1);

  const updated = await prisma.pers.update({
    where: { persId },
    data: { currentSpellSlots: next },
    select: { currentSpellSlots: true },
  });

  revalidatePath(`/pers/${persId}`);
  revalidatePath(`/character/${persId}`);

  return { success: true, currentSpellSlots: updated.currentSpellSlots as number[] };
}

/**
 * Decrement Warlock Pact Magic slots (stored separately in Pers.currentPactSlots).
 */
export async function spendPactSlot(
  persId: number
): Promise<{ success: true; currentPactSlots: number } | { success: false; error: string }> {
  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };

  const cur = Number.isFinite(owned.pers.currentPactSlots)
    ? Math.max(0, Math.trunc(owned.pers.currentPactSlots))
    : 0;

  if (cur <= 0) {
    return { success: true, currentPactSlots: cur };
  }

  const updated = await prisma.pers.update({
    where: { persId },
    data: { currentPactSlots: cur - 1 },
    select: { currentPactSlots: true },
  });

  revalidatePath(`/pers/${persId}`);
  revalidatePath(`/character/${persId}`);

  return { success: true, currentPactSlots: updated.currentPactSlots };
}

/**
 * Increment a standard spell slot of given level (1..9).
 */
export async function restoreSpellSlot(
  persId: number,
  slotLevel: number
): Promise<{ success: true; currentSpellSlots: number[] } | { success: false; error: string }> {
  const level = Math.trunc(Number(slotLevel));
  if (!Number.isFinite(level) || level < 1 || level > 9) {
    return { success: false, error: "  " };
  }

  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };

  // Need full data for max slots calculation
  const persWithClass = await prisma.pers.findUnique({
    where: { persId },
    include: {
      class: true,
      subclass: true,
      multiclasses: {
        include: {
          class: true,
          subclass: true,
        },
      },
    },
  });

  if (!persWithClass) return { success: false, error: "  " };

  const caster = calculateCasterLevel(persWithClass as any);
  const casterLevel = Math.max(0, Math.min(20, Math.trunc(caster.casterLevel || 0)));
  const row = (SPELL_SLOT_PROGRESSION as any).FULL?.[casterLevel] as number[] | undefined;
  const max = row ? (row[level - 1] ?? 0) : 0;

  const raw = Array.isArray(persWithClass.currentSpellSlots) ? (persWithClass.currentSpellSlots as number[]) : [];
  const next = Array.from({ length: 9 }, (_, idx) => {
    const v = raw[idx];
    return Number.isFinite(v) ? Math.max(0, Math.trunc(v)) : 0;
  });

  const idx = level - 1;
  if (next[idx] >= max) {
    return { success: true, currentSpellSlots: next };
  }

  next[idx] = next[idx] + 1;

  const updated = await prisma.pers.update({
    where: { persId },
    data: { currentSpellSlots: next },
    select: { currentSpellSlots: true },
  });

  revalidatePath(`/pers/${persId}`);
  revalidatePath(`/character/${persId}`);

  return { success: true, currentSpellSlots: updated.currentSpellSlots as number[] };
}

/**
 * Increment Warlock Pact Magic slots.
 */
export async function restorePactSlot(
  persId: number
): Promise<{ success: true; currentPactSlots: number } | { success: false; error: string }> {
  const owned = await assertOwnsPers(persId);
  if (!owned.ok) return { success: false, error: owned.error };

  const persWithClass = await prisma.pers.findUnique({
    where: { persId },
    include: {
      class: true,
      subclass: true,
      multiclasses: {
        include: {
          class: true,
          subclass: true,
        },
      },
    },
  });

  if (!persWithClass) return { success: false, error: "  " };

  const caster = calculateCasterLevel(persWithClass as any);
  const pactLevel = Math.max(0, Math.min(20, Math.trunc(caster.pactLevel || 0)));
  const pactRow = (SPELL_SLOT_PROGRESSION as any).PACT?.[pactLevel] as { slots: number; level: number } | undefined;
  const max = pactRow ? pactRow.slots : 0;

  const cur = Number.isFinite(persWithClass.currentPactSlots)
    ? Math.max(0, Math.trunc(persWithClass.currentPactSlots))
    : 0;

  if (cur >= max) {
    return { success: true, currentPactSlots: cur };
  }

  const updated = await prisma.pers.update({
    where: { persId },
    data: { currentPactSlots: cur + 1 },
    select: { currentPactSlots: true },
  });

  revalidatePath(`/pers/${persId}`);
  revalidatePath(`/character/${persId}`);

  return { success: true, currentPactSlots: updated.currentPactSlots };
}
</file>

<file path="src/lib/actions/update-character.ts">
"use server";

import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";

export type UpdateCharacterPayload = {
  persId: number;
  data: {
    customProficiencies?: string;
    customLanguagesKnown?: string;
    personalityTraits?: string;
    ideals?: string;
    bonds?: string;
    flaws?: string;
    backstory?: string;
    notes?: string;
    alignment?: string;
    xp?: number;
    cp?: string;
    ep?: string;
    sp?: string;
    gp?: string;
    pp?: string;
  };
};

export async function updateCharacterAction(payload: UpdateCharacterPayload): Promise<
  | { success: true }
  | { success: false; error: string }
> {
  const session = await auth();
  if (!session?.user?.email) return { success: false, error: " " };

  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
    select: { id: true },
  });
  if (!user) return { success: false, error: "  " };

  const pers = await prisma.pers.findUnique({
    where: { persId: payload.persId },
    select: { persId: true, userId: true },
  });
  if (!pers || pers.userId !== user.id) return { success: false, error: "   " };

  const d = payload.data ?? {};

  await prisma.pers.update({
    where: { persId: payload.persId },
    data: {
      ...(typeof d.customProficiencies === "string" ? { customProficiencies: d.customProficiencies } : {}),
      ...(typeof d.customLanguagesKnown === "string" ? { customLanguagesKnown: d.customLanguagesKnown } : {}),
      ...(typeof d.personalityTraits === "string" ? { personalityTraits: d.personalityTraits } : {}),
      ...(typeof d.ideals === "string" ? { ideals: d.ideals } : {}),
      ...(typeof d.bonds === "string" ? { bonds: d.bonds } : {}),
      ...(typeof d.flaws === "string" ? { flaws: d.flaws } : {}),
      ...(typeof d.backstory === "string" ? { backstory: d.backstory } : {}),
      ...(typeof d.notes === "string" ? { notes: d.notes } : {}),
      ...(typeof d.alignment === "string" ? { alignment: d.alignment.slice(0, 100) } : {}),
      ...(typeof d.xp === "number" ? { xp: Math.max(0, Math.trunc(d.xp)) } : {}),
      ...(typeof d.cp === "string" ? { cp: String(Math.max(0, parseInt(d.cp) || 0)) } : {}),
      ...(typeof d.ep === "string" ? { ep: String(Math.max(0, parseInt(d.ep) || 0)) } : {}),
      ...(typeof d.sp === "string" ? { sp: String(Math.max(0, parseInt(d.sp) || 0)) } : {}),
      ...(typeof d.gp === "string" ? { gp: String(Math.max(0, parseInt(d.gp) || 0)) } : {}),
      ...(typeof d.pp === "string" ? { pp: String(Math.max(0, parseInt(d.pp) || 0)) } : {}),
    },
  });

  revalidatePath(`/pers/${payload.persId}`);
  revalidatePath(`/character/${payload.persId}`);

  return { success: true };
}
</file>

<file path="src/lib/components/characterSheet/shared/FeatureCards.tsx">
"use client";

import { Minus, Plus, Info } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { FormattedDescription } from "@/components/ui/FormattedDescription";
import { FeatureDisplayType, RestType } from "@prisma/client";
import clsx from "clsx";

export interface FeatureItemData {
  featureId?: number;
  name: string;
  description: string;
  shortDescription?: string | null;
  displayType: FeatureDisplayType[];
  restType?: string | null;
  usesCount?: number | null;
  usesRemaining?: number | null;
  source?: string;
  sourceName?: string;
}

// FeatureSource enum values from backend
type FeatureSource = 'CLASS' | 'SUBCLASS' | 'RACE' | 'SUBRACE' | 'BACKGROUND' | 'FEAT' | 'PERS' | 'CHOICE' | 'RACECHOICE';

// Normalizes various source string formats to a canonical FeatureSource
function normalizeFeatureSource(raw: unknown): FeatureSource | null {
  if (typeof raw !== 'string' || !raw) return null;
  const upper = raw.toUpperCase().trim();
  
  // Direct enum matches
  if (upper === 'CLASS') return 'CLASS';
  if (upper === 'SUBCLASS') return 'SUBCLASS';
  if (upper === 'RACE') return 'RACE';
  if (upper === 'SUBRACE') return 'SUBRACE';
  if (upper === 'BACKGROUND') return 'BACKGROUND';
  if (upper === 'FEAT') return 'FEAT';
  if (upper === 'PERS') return 'PERS';
  if (upper === 'CHOICE') return 'CHOICE';
  if (upper === 'RACECHOICE') return 'RACECHOICE';
  
  // Legacy/alternative formats
  if (upper.includes('SUBCLASS')) return 'SUBCLASS';
  if (upper.includes('CLASS')) return 'CLASS';
  if (upper.includes('SUBRACE')) return 'SUBRACE';
  if (upper.includes('RACE')) return 'RACE';
  if (upper.includes('BACKGROUND') || upper.includes('BG')) return 'BACKGROUND';
  if (upper.includes('FEAT')) return 'FEAT';
  if (upper.includes('CUSTOM') || upper.includes('PERS')) return 'PERS';
  if (upper.includes('CHOICE')) return 'CHOICE';
  
  return null;
}

// Returns Ukrainian label for feature source
function getFeatureSourceLabel(source: FeatureSource): string {
  switch (source) {
    case 'CLASS': return '';
    case 'SUBCLASS': return '';
    case 'RACE': return '';
    case 'SUBRACE': return '';
    case 'BACKGROUND': return '';
    case 'FEAT': return '';
    case 'CHOICE':
    case 'RACECHOICE': return '';
    case 'PERS': return '';
    default: return '';
  }
}

// Check if source is class-related for styling
function isClassRelatedSource(source: FeatureSource | null): boolean {
  return source === 'CLASS' || source === 'SUBCLASS';
}

const stripMarkdownPreview = (value: string) => {
  return value
    .replace(/\r\n/g, "\n")
    .replace(/<[^>]+>/g, " ")
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, "$1")
    .replace(/`{1,3}([^`]+)`{1,3}/g, "$1")
    .replace(/\*\*([^*]+)\*\*/g, "$1")
    .replace(/\s+/g, " ")
    .trim();
};

export function ResourceCard({ 
  feature, 
  onSpend, 
  onRestore, 
  onInfo, 
  isPending,
  isReadOnly
}: { 
  feature: FeatureItemData, 
  onSpend?: () => void, 
  onRestore?: () => void,
  onInfo?: () => void,
  isPending?: boolean,
  isReadOnly?: boolean
}) {
  const hasTracker = (feature.restType || feature.usesCount !== null) && feature.usesCount !== null;

  return (
    <Card className="bg-purple-900/20 border-purple-500/30 backdrop-blur-sm overflow-hidden border-l-4 border-l-purple-500 shadow-inner group">
      <CardContent className="p-3 flex items-center justify-between gap-3">
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2">
            <div className="font-bold text-purple-50 truncate">{feature.name}</div>
            {onInfo && (
              <button 
                type="button"
                onClick={onInfo} 
                className="p-1 rounded-full hover:bg-white/10 text-purple-400 transition"
              >
                <Info className="w-3.5 h-3.5" />
              </button>
            )}
          </div>
          {(feature.shortDescription || feature.description) && (
            <div className="text-[11px] text-purple-300/80 truncate">
              {stripMarkdownPreview(feature.shortDescription || feature.description)}
            </div>
          )}
        </div>

        {hasTracker && (
          <div className="flex items-center gap-2 bg-black/20 rounded-lg p-1 border border-white/5">
            {!isReadOnly && onSpend && (
              <Button 
                variant="ghost" 
                size="icon" 
                className="h-7 w-7 rounded-md hover:bg-white/10 text-purple-300" 
                onClick={onSpend}
                disabled={isPending || (feature.usesRemaining ?? 0) <= 0}
              >
                <Minus className="w-4 h-4" />
              </Button>
            )}
            <div className="px-2 text-center min-w-[3rem]">
              <div className="text-xs font-bold text-white leading-none">
                {feature.usesRemaining ?? feature.usesCount} / {feature.usesCount}
              </div>
              <div className="text-[8px] uppercase font-bold text-purple-400 mt-0.5">
                {feature.restType === "LR" ? "LR" : feature.restType === "SR" ? "SR" : "uses"}
              </div>
            </div>
            {!isReadOnly && onRestore && (
              <Button 
                variant="ghost" 
                size="icon" 
                className="h-7 w-7 rounded-md hover:bg-white/10 text-purple-300" 
                onClick={onRestore}
                disabled={isPending || (feature.usesRemaining ?? 0) >= (feature.usesCount ?? 0)}
              >
                <Plus className="w-4 h-4" />
              </Button>
            )}
          </div>
        )}
      </CardContent>
    </Card>
  );
}

export function FeatureCard({ 
  feature, 
  onSpend, 
  onRestore, 
  onClick, 
  isPending,
  isReadOnly
}: { 
  feature: FeatureItemData, 
  onSpend?: () => void, 
  onRestore?: () => void,
  onClick?: () => void,
  isPending?: boolean,
  isReadOnly?: boolean
}) {
  const hasTracker = feature.restType && feature.usesCount !== null;
  const normalizedSource = normalizeFeatureSource(feature.source);
  const isClass = isClassRelatedSource(normalizedSource);
  const sourceLabel = normalizedSource ? getFeatureSourceLabel(normalizedSource) : null;

  return (
    <div 
      className={clsx(
        "p-4 rounded-xl border transition group animate-in fade-in slide-in-from-bottom-2",
        isClass 
          ? 'bg-purple-900/10 border-purple-500/20 hover:border-purple-500/40' 
          : 'bg-slate-900/30 border-white/10 hover:border-white/20',
        onClick && "cursor-pointer"
      )}
      onClick={onClick}
    >
      <div className="flex items-start justify-between gap-3">
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 mb-1">
            <span className="font-bold text-slate-100 group-hover:text-purple-200 transition">{feature.name}</span>
            {sourceLabel && (
              <span className={clsx(
                "text-[10px] px-1.5 py-0.5 rounded uppercase font-bold tracking-tight",
                isClass ? 'bg-purple-500/20 text-purple-300 border border-purple-500/30' : 'bg-slate-500/20 text-slate-400 border border-slate-500/30'
              )}>
                {sourceLabel}
              </span>
            )}
          </div>
          {feature.shortDescription || feature.description ? (
            <div className="text-xs text-slate-400 line-clamp-2">
              {stripMarkdownPreview(feature.shortDescription || feature.description)}
            </div>
          ) : (
            <div className="text-[10px] italic text-slate-500">  ...</div>
          )}
        </div>

        {hasTracker && (
          <div className="flex flex-col items-center gap-1.5 bg-black/30 rounded-xl p-1.5 border border-white/5 shrink-0">
            <div className="flex items-center gap-1">
              {!isReadOnly && onSpend && (
                <Button 
                  variant="ghost" 
                  size="icon" 
                  className="h-6 w-6 rounded-lg hover:bg-white/10 text-white" 
                  onClick={(e) => { e.stopPropagation(); onSpend(); }}
                  disabled={isPending || (feature.usesRemaining ?? 0) <= 0}
                >
                  <Minus className="w-3 h-3" />
                </Button>
              )}
              <div className="px-1 text-center min-w-[2.5rem]">
                <span className="text-xs font-black text-white">
                  {feature.usesRemaining ?? feature.usesCount} / {feature.usesCount}
                </span>
              </div>
              {!isReadOnly && onRestore && (
                <Button 
                  variant="ghost" 
                  size="icon" 
                  className="h-6 w-6 rounded-lg hover:bg-white/10 text-white" 
                  onClick={(e) => { e.stopPropagation(); onRestore(); }}
                  disabled={isPending || (feature.usesRemaining ?? 0) >= (feature.usesCount ?? 0)}
                >
                  <Plus className="w-3 h-3" />
                </Button>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/lib/components/characterSheet/AddArmorDialog.tsx">
"use client";

import { useEffect, useState, useTransition } from "react";
import { Plus, Search, Shield } from "lucide-react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { 
  getBaseEquipment, 
  addArmor 
} from "@/lib/actions/equipment-actions";
import { armorTranslations, armorTypeTranslations } from "@/lib/refs/translation";
import { Armor } from "@prisma/client";
import { toast } from "sonner";
import { useModalBackButton } from "@/hooks/useModalBackButton";

interface AddArmorDialogProps {
  persId: number;
  onSuccess?: () => void;
}

export default function AddArmorDialog({ persId, onSuccess }: AddArmorDialogProps) {
  const [open, setOpen] = useState(false);
  const [armors, setArmors] = useState<Armor[]>([]);
  const [search, setSearch] = useState("");
  const [typeFilter, setTypeFilter] = useState<string>("ALL");
  const [isPending, startTransition] = useTransition();
  const [isLoading, setIsLoading] = useState(false);

  useModalBackButton(open, () => setOpen(false));

  useEffect(() => {
    if (open) {
      setIsLoading(true);
      getBaseEquipment().then((res) => {
        if (res.success && res.armors) {
          setArmors(res.armors.filter(a => a.armorType !== "SHIELD"));
        }
        setIsLoading(false);
      });
    }
  }, [open]);

  const filteredArmors = armors.filter((a) => {
    const name = armorTranslations[a.name as keyof typeof armorTranslations] || a.name;
    const matchesSearch = name.toLowerCase().includes(search.toLowerCase());
    const matchesType = typeFilter === "ALL" || a.armorType === typeFilter;
    return matchesSearch && matchesType;
  });

  const handleAdd = (armor: Armor) => {
    startTransition(async () => {
      const res = await addArmor(persId, armor.armorId, {
        isProficient: true,
        equipped: false,
      });

      if (res.success) {
        toast.success(" ");
        setOpen(false);
        onSuccess?.();
      } else {
        toast.error(res.error || "   ");
      }
    });
  };

  const handleAddCustom = () => {
    startTransition(async () => {
        const res = await addArmor(persId, null, {
          overrideBaseAC: 10,
          isProficient: true,
          equipped: false,
        });
  
        if (res.success) {
          toast.success("  ");
          setOpen(false);
          onSuccess?.();
        } else {
          toast.error(res.error || "   ");
        }
      });
  };

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button size="sm" className="h-8 gap-1 bg-indigo-600/20 hover:bg-indigo-600/30 border-indigo-500/30 text-indigo-100">
          <Plus className="w-4 h-4" />
          <span> </span>
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-md bg-slate-900/60 backdrop-blur-xl border-white/10 text-slate-50 p-0 overflow-hidden flex flex-col h-[80vh]">
        <DialogHeader className="p-4 border-b border-white/10 shrink-0">
          <DialogTitle className="flex items-center gap-2">
            <Shield className="w-5 h-5 text-indigo-400" />
             
          </DialogTitle>
        </DialogHeader>

        <div className="p-4 space-y-4 flex-1 overflow-y-auto">
          <div className="space-y-2">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
              <Input
                placeholder=" ..."
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                className="pl-9 bg-white/5 border-white/10 text-slate-50"
              />
            </div>

            <div className="flex flex-wrap gap-2">
              <Button 
                variant={typeFilter === "ALL" ? "secondary" : "outline"} 
                size="sm" 
                className="h-7 text-[10px] px-2"
                onClick={() => setTypeFilter("ALL")}
              ></Button>
              <Button 
                variant={typeFilter === "LIGHT_ARMOR" ? "secondary" : "outline"} 
                size="sm" 
                className="h-7 text-[10px] px-2"
                onClick={() => setTypeFilter("LIGHT_ARMOR")}
              ></Button>
              <Button 
                variant={typeFilter === "MEDIUM_ARMOR" ? "secondary" : "outline"} 
                size="sm" 
                className="h-7 text-[10px] px-2"
                onClick={() => setTypeFilter("MEDIUM_ARMOR")}
              ></Button>
              <Button 
                variant={typeFilter === "HEAVY_ARMOR" ? "secondary" : "outline"} 
                size="sm" 
                className="h-7 text-[10px] px-2"
                onClick={() => setTypeFilter("HEAVY_ARMOR")}
              ></Button>
            </div>
          </div>

          <Button 
            variant="outline" 
            className="w-full border-dashed border-white/20 hover:bg-white/5 h-12 gap-2"
            onClick={handleAddCustom}
            disabled={isPending}
          >
            <Plus className="w-4 h-4" />
              
          </Button>

          <div className="space-y-2">
            {isLoading ? (
              <div className="text-center py-8 text-slate-400">...</div>
            ) : filteredArmors.length > 0 ? (
              filteredArmors.map((a) => (
                <div
                  key={a.armorId}
                  className="flex items-center justify-between p-3 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition group"
                >
                  <div>
                    <div className="font-semibold">
                      {armorTranslations[a.name as keyof typeof armorTranslations] || a.name}
                    </div>
                    <div className="text-xs text-slate-400">
                      {armorTypeTranslations[a.armorType as keyof typeof armorTypeTranslations] || a.armorType}   {a.baseAC}
                    </div>
                  </div>
                  <Button 
                    size="sm" 
                    variant="ghost" 
                    className="opacity-0 group-hover:opacity-100 transition h-8 w-8 p-0"
                    onClick={() => handleAdd(a)}
                    disabled={isPending}
                  >
                    <Plus className="w-4 h-4" />
                  </Button>
                </div>
              ))
            ) : (
              <div className="text-center py-8 text-slate-400">  </div>
            )}
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/lib/components/characterSheet/AddSpellDialog.tsx">
"use client";

import { PersWithRelations } from "@/lib/actions/pers";
import { Button } from "@/components/ui/button";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Search, Plus, Check, ExternalLink } from "lucide-react";
import { useEffect, useState, useTransition } from "react";
import { Badge } from "@/components/ui/badge";
import { spellSchoolTranslations } from "@/lib/refs/translation";
import { toggleSpellForPers, getSpellsList } from "@/lib/actions/spell-actions";
import { toast } from "sonner";
import { calculateCasterLevel } from "@/lib/logic/spell-logic";
import { SPELL_SLOT_PROGRESSION } from "@/lib/refs/static";
import { useMemo } from "react";

// We need a server action to fetch the base spells list
// Let's assume we'll add getBaseSpells to spell-actions.ts or similar

interface SpellBase {
    spellId: number;
    name: string;
    engName: string;
    level: number;
    school: string | null;
}

interface AddSpellDialogProps {
  pers: PersWithRelations;
  onPersUpdate: (next: PersWithRelations) => void;
  isReadOnly?: boolean;
}

export default function AddSpellDialog({ pers, onPersUpdate, isReadOnly }: AddSpellDialogProps) {
  const [open, setOpen] = useState(false);
  const [query, setQuery] = useState("");
  const [spells, setSpells] = useState<SpellBase[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isPending, startTransition] = useTransition();

  // Calculate max spell level for embed mode
  const maxSpellLevel = useMemo(() => {
    const caster = calculateCasterLevel(pers as any);
    const level = Math.max(0, Math.min(20, Math.trunc(caster.casterLevel || 0)));
    if (level <= 0) return 0;
    const row = (SPELL_SLOT_PROGRESSION as any).FULL?.[level] as number[] | undefined;
    if (!Array.isArray(row)) return 0;
    // Find highest slot level with slots > 0
    for (let i = row.length - 1; i >= 0; i--) {
      if (row[i] > 0) return i + 1;
    }
    return 0;
  }, [pers]);

  // Build URL for /spells embed mode
  const buildSpellsUrl = () => {
    const params = new URLSearchParams();
    params.set("origin", "character");
    params.set("persId", String(pers.persId));
    params.set("persName", pers.name || ` #${pers.persId}`);
    if (maxSpellLevel > 0) params.set("maxSpellLevel", String(maxSpellLevel));
    // Add class filter
    const classNames: string[] = [];
    if (pers.class?.name) classNames.push(pers.class.name);
    pers.multiclasses?.forEach((mc: any) => {
      if (mc.class?.name) classNames.push(mc.class.name);
    });
    if (classNames.length > 0) params.set("cls", classNames.join(","));
    return `/spells?${params.toString()}`;
  };

  // Load spells when dialog opens
  useEffect(() => {
    if (open) {
      loadSpells();
    }
  }, [open]);

  async function loadSpells() {
    setIsLoading(true);
    try {
      const data = await getSpellsList();
      setSpells(data);
    } catch (error) {
      console.error("Failed to load spells:", error);
    } finally {
      setIsLoading(false);
    }
  }

  const filteredSpells = spells.filter((s) => {
    const q = query.toLowerCase();
    return s.name.toLowerCase().includes(q) || s.engName.toLowerCase().includes(q);
  });

  const handleToggle = async (spellId: number) => {
    startTransition(async () => {
        const res = await toggleSpellForPers({ persId: pers.persId, spellId });
        if (res.success) {
            toast.success(res.added ? " " : " ");
            // Here we should Ideally trigger a refetch of pers data
            // but for simple logic we can rely on router.refresh() if needed
            // however, since we have onPersUpdate, we might want to use it
        } else {
            toast.error(res.error);
        }
    });
  };

  const isSpellOwned = (spellId: number) => {
    return (pers as any).persSpells?.some((ps: any) => ps.spellId === spellId);
  };

  return (
    <div className="space-y-2">
      <Dialog open={open} onOpenChange={setOpen}>
        <DialogTrigger asChild>
          <Button 
              disabled={isReadOnly}
              variant="outline" 
              className="w-full h-12 gap-2 border-fuchsia-500/30 bg-fuchsia-500/10 hover:bg-fuchsia-500/20 text-fuchsia-200"
          >
            <Plus className="w-5 h-5" />
             
          </Button>
        </DialogTrigger>
        <DialogContent className="max-w-2xl bg-slate-900 border-white/10 text-white p-0 overflow-hidden flex flex-col max-h-[90vh]">
        <DialogHeader className="p-6 pb-2">
          <DialogTitle className="text-xl font-bold flex items-center gap-2">
            <Search className="w-5 h-5 text-fuchsia-400" />
             
          </DialogTitle>
          <div className="relative mt-4">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
            <Input
              placeholder="  ..."
              className="pl-10 bg-slate-800/50 border-white/10 focus:border-fuchsia-500/50"
              value={query}
              onChange={(e) => setQuery(e.target.value)}
            />
          </div>
        </DialogHeader>

        <ScrollArea className="flex-1 p-6 pt-2">
          <div className="space-y-2 pb-6">
            {isLoading ? (
              <div className="text-center py-10 text-slate-400">...</div>
            ) : filteredSpells.length === 0 ? (
              <div className="text-center py-10 text-slate-400">  </div>
            ) : (
              filteredSpells.map((spell) => {
                const owned = isSpellOwned(spell.spellId);
                return (
                  <div
                    key={spell.spellId}
                    className="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/5 hover:bg-white/10 transition group"
                  >
                    <div className="flex-1 min-w-0 pr-4">
                      <div className="font-bold text-slate-100 flex items-center gap-2">
                        {spell.name}
                        <span className="text-[10px] text-slate-400 font-normal uppercase tracking-tighter">{spell.engName}</span>
                      </div>
                      <div className="flex items-center gap-2 mt-1">
                        <Badge variant="outline" className="text-[10px] uppercase bg-slate-800/50 border-white/10 text-slate-300">
                          {spell.level === 0 ? "" : `${spell.level} `}
                        </Badge>
                        <span className="text-xs text-slate-500">
                          {(spell.school && (spellSchoolTranslations as any)[spell.school]) || spell.school || ""}
                        </span>
                      </div>
                    </div>
                    <Button
                      size="sm"
                      variant={owned ? "secondary" : "default"}
                      className={owned ? "bg-emerald-500/20 text-emerald-400 border-emerald-500/30" : "bg-fuchsia-600 hover:bg-fuchsia-700"}
                      onClick={() => handleToggle(spell.spellId)}
                      disabled={isPending}
                    >
                      {owned ? <Check className="w-4 h-4" /> : <Plus className="w-4 h-4" />}
                    </Button>
                  </div>
                );
              })
            )}
          </div>
        </ScrollArea>
      </DialogContent>
      </Dialog>
      {!isReadOnly && (
        <a
          href={buildSpellsUrl()}
          target="_blank"
          rel="noopener noreferrer"
          className="w-full h-10 flex items-center justify-center gap-2 rounded-md border border-white/10 bg-white/5 hover:bg-white/10 text-slate-300 text-sm transition"
        >
          <ExternalLink className="w-4 h-4" />
            
        </a>
      )}
    </div>
  );
}
</file>

<file path="src/lib/components/characterSheet/AddWeaponDialog.tsx">
"use client";

import { useEffect, useState, useTransition } from "react";
import { Plus, Search, Sword } from "lucide-react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { 
  getBaseEquipment, 
  addWeapon 
} from "@/lib/actions/equipment-actions";
import { weaponTranslations, damageTypeTranslations } from "@/lib/refs/translation";
import { Weapon, Ability } from "@prisma/client";
import { toast } from "sonner";
import { useModalBackButton } from "@/hooks/useModalBackButton";

interface AddWeaponDialogProps {
  persId: number;
  onSuccess?: () => void;
}

export default function AddWeaponDialog({ persId, onSuccess }: AddWeaponDialogProps) {
  const [open, setOpen] = useState(false);
  const [weapons, setWeapons] = useState<Weapon[]>([]);
  const [search, setSearch] = useState("");
  const [typeFilter, setTypeFilter] = useState<string>("ALL");
  const [rangedFilter, setRangedFilter] = useState<boolean | null>(null);
  const [isPending, startTransition] = useTransition();
  const [isLoading, setIsLoading] = useState(false);

  useModalBackButton(open, () => setOpen(false));

  useEffect(() => {
    if (open) {
      setIsLoading(true);
      getBaseEquipment().then((res) => {
        if (res.success && res.weapons) {
          setWeapons(res.weapons);
        }
        setIsLoading(false);
      });
    }
  }, [open]);

  const filteredWeapons = weapons.filter((w) => {
    const name = weaponTranslations[w.name as keyof typeof weaponTranslations] || w.name;
    const matchesSearch = name.toLowerCase().includes(search.toLowerCase());
    const matchesType = typeFilter === "ALL" || w.weaponType === typeFilter;
    const matchesRanged = rangedFilter === null || w.isRanged === rangedFilter;
    return matchesSearch && matchesType && matchesRanged;
  });

  const handleAdd = (weapon: Weapon) => {
    startTransition(async () => {
      const res = await addWeapon(persId, weapon.weaponId, {
        overrideName: weaponTranslations[weapon.name as keyof typeof weaponTranslations] || weapon.name,
        customDamageDice: weapon.damage,
        customDamageAbility: weapon.isRanged ? Ability.DEX : Ability.STR,
        isProficient: true,
      });

      if (res.success) {
        toast.success(" ");
        setOpen(false);
        onSuccess?.();
      } else {
        toast.error(res.error || "   ");
      }
    });
  };

  const handleAddCustom = () => {
    startTransition(async () => {
        const res = await addWeapon(persId, null, {
          overrideName: " ",
          customDamageDice: "1d6",
          customDamageAbility: Ability.STR,
          isProficient: true,
        });
  
        if (res.success) {
          toast.success("  ");
          setOpen(false);
          onSuccess?.();
        } else {
          toast.error(res.error || "   ");
        }
      });
  };

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button size="sm" className="h-8 gap-1 bg-indigo-600/20 hover:bg-indigo-600/30 border-indigo-500/30 text-indigo-100">
          <Plus className="w-4 h-4" />
          <span> </span>
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-md bg-slate-900/60 backdrop-blur-xl border-white/10 text-slate-50 p-0 overflow-hidden flex flex-col h-[80vh]">
        <DialogHeader className="p-4 border-b border-white/10 shrink-0">
          <DialogTitle className="flex items-center gap-2">
            <Sword className="w-5 h-5 text-indigo-400" />
             
          </DialogTitle>
        </DialogHeader>

        <div className="p-4 space-y-4 flex-1 overflow-y-auto">
          <div className="space-y-2">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
              <Input
                placeholder=" ..."
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                className="pl-9 bg-white/5 border-white/10 text-slate-50"
              />
            </div>
            
            <div className="flex flex-wrap gap-2">
              <Button 
                variant={typeFilter === "ALL" ? "secondary" : "outline"} 
                size="sm" 
                className="h-7 text-[10px] px-2"
                onClick={() => setTypeFilter("ALL")}
              ></Button>
              <Button 
                variant={typeFilter === "SIMPLE_WEAPON" ? "secondary" : "outline"} 
                size="sm" 
                className="h-7 text-[10px] px-2"
                onClick={() => setTypeFilter("SIMPLE_WEAPON")}
              ></Button>
              <Button 
                variant={typeFilter === "MARTIAL_WEAPON" ? "secondary" : "outline"} 
                size="sm" 
                className="h-7 text-[10px] px-2"
                onClick={() => setTypeFilter("MARTIAL_WEAPON")}
              ></Button>
              <div className="w-px h-7 bg-white/10 mx-1 hidden sm:block" />
              <Button 
                variant={rangedFilter === false ? "secondary" : "outline"} 
                size="sm" 
                className="h-7 text-[10px] px-2"
                onClick={() => setRangedFilter(rangedFilter === false ? null : false)}
              ></Button>
              <Button 
                variant={rangedFilter === true ? "secondary" : "outline"} 
                size="sm" 
                className="h-7 text-[10px] px-2"
                onClick={() => setRangedFilter(rangedFilter === true ? null : true)}
              ></Button>
            </div>
          </div>

          <Button 
            variant="outline" 
            className="w-full border-dashed border-white/20 hover:bg-white/5 h-12 gap-2"
            onClick={handleAddCustom}
            disabled={isPending}
          >
            <Plus className="w-4 h-4" />
              
          </Button>

          <div className="space-y-2">
            {isLoading ? (
              <div className="text-center py-8 text-slate-400">...</div>
            ) : filteredWeapons.length > 0 ? (
              filteredWeapons.map((w) => (
                <div
                  key={w.weaponId}
                  className="flex items-center justify-between p-3 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition group"
                >
                  <div>
                    <div className="font-semibold">
                      {weaponTranslations[w.name as keyof typeof weaponTranslations] || w.name}
                    </div>
                    <div className="text-xs text-slate-400">
                      {w.damage} {damageTypeTranslations[w.damageType as keyof typeof damageTypeTranslations] || w.damageType}
                    </div>
                  </div>
                  <Button 
                    size="sm" 
                    variant="ghost" 
                    className="opacity-0 group-hover:opacity-100 transition h-8 w-8 p-0"
                    onClick={() => handleAdd(w)}
                    disabled={isPending}
                  >
                    <Plus className="w-4 h-4" />
                  </Button>
                </div>
              ))
            ) : (
              <div className="text-center py-8 text-slate-400">  </div>
            )}
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/lib/components/characterSheet/ArmorCustomizeModal.tsx">
"use client";

import { useEffect, useState, useTransition } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { updateArmor, deleteArmor } from "@/lib/actions/equipment-actions";
import { toast } from "sonner";
import { useModalBackButton } from "@/hooks/useModalBackButton";
import { PersArmorWithArmor } from "@/lib/actions/pers";
import { Trash2 } from "lucide-react";

interface ArmorCustomizeModalProps {
  persArmor: PersArmorWithArmor;
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export default function ArmorCustomizeModal({ persArmor, open, onOpenChange }: ArmorCustomizeModalProps) {
  const [isPending, startTransition] = useTransition();
  const [formData, setFormData] = useState({
    overrideBaseAC: persArmor.overrideBaseAC,
    miscACBonus: persArmor.miscACBonus || 0,
    isProficient: persArmor.isProficient,
    equipped: persArmor.equipped,
  });

  useModalBackButton(open, () => onOpenChange(false));

  useEffect(() => {
    if (open) {
      setFormData({
        overrideBaseAC: persArmor.overrideBaseAC,
        miscACBonus: persArmor.miscACBonus || 0,
        isProficient: persArmor.isProficient,
        equipped: persArmor.equipped,
      });
    }
  }, [open, persArmor]);

  const handleSave = () => {
    startTransition(async () => {
      const res = await updateArmor(persArmor.persArmorId, {
        ...formData,
        miscACBonus: formData.miscACBonus || 0,
      });

      if (res.success) {
        toast.success(" ");
        onOpenChange(false);
      } else {
        toast.error(res.error || "   ");
      }
    });
  };

  const handleDelete = () => {
    if (!confirm(" ,     ?")) return;
    
    startTransition(async () => {
      const res = await deleteArmor(persArmor.persArmorId);
      if (res.success) {
        toast.success(" ");
        onOpenChange(false);
      } else {
        toast.error(res.error || "   ");
      }
    });
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-md bg-slate-900/60 backdrop-blur-xl border-white/10 text-slate-50">
        <DialogHeader>
          <DialogTitle> </DialogTitle>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div className="space-y-2">
            <Label>  (   )</Label>
            <Input
              type="number"
              value={formData.overrideBaseAC ?? ""}
              onChange={(e) => setFormData({ ...formData, overrideBaseAC: e.target.value ? parseInt(e.target.value) : null })}
              placeholder={persArmor.armor?.baseAC?.toString() || "10"}
              className="bg-white/5 border-white/10"
            />
          </div>

          <div className="space-y-2">
            <Label>    ( +1  .)</Label>
            <Input
              type="number"
              value={formData.miscACBonus}
              onChange={(e) => setFormData({ ...formData, miscACBonus: parseInt(e.target.value) || 0 })}
              className="bg-white/5 border-white/10"
            />
          </div>

          <div className="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10">
            <div className="space-y-0.5">
              <Label></Label>
              <div className="text-xs text-slate-400">     </div>
            </div>
            <Switch
              checked={formData.equipped}
              onCheckedChange={(val) => setFormData({ ...formData, equipped: val })}
            />
          </div>

          <div className="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10">
            <div className="space-y-0.5">
              <Label></Label>
              <div className="text-xs text-slate-400">   </div>
            </div>
            <Switch
              checked={formData.isProficient}
              onCheckedChange={(val) => setFormData({ ...formData, isProficient: val })}
            />
          </div>

          <div className="flex gap-2 pt-4">
            <Button variant="destructive" className="gap-2" onClick={handleDelete} disabled={isPending}>
              <Trash2 className="w-4 h-4" />
              
            </Button>
            <div className="flex-1" />
            <Button variant="ghost" onClick={() => onOpenChange(false)}>
              
            </Button>
            <Button className="bg-indigo-600 hover:bg-indigo-700" onClick={handleSave} disabled={isPending}>
              
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/lib/components/characterSheet/ModifyStatModal.tsx">
"use client";

import { useState, useMemo, useCallback } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { toast } from "sonner";
import { useRouter } from "next/navigation";
import { Ability, Skills, SkillProficiencyType } from "@prisma/client";
import { PersWithRelations } from "@/lib/actions/pers";
import { updateBonus, updateSkillProficiency, updateSaveProficiency } from "@/lib/actions/bonus-actions";
import { bonusTranslations, skillTranslations } from "@/lib/refs/translation";
import { Switch } from "@/components/ui/switch";
import { Label } from "@/components/ui/label";
import {
  getStatBonus,
  getModifierBonus,
  getSaveBonus,
  getSkillBonus,
  getSimpleBonus,
  calculateFinalStat,
  calculateFinalAC,
  calculateFinalSpeed,
  calculateFinalInitiative,
  calculateFinalProficiency,
  calculateSpellAttack,
  calculateSpellDC,
} from "@/lib/logic/bonus-calculator";
import { getAbilityMod, getProficiencyBonus } from "@/lib/logic/utils";
import { Minus, Plus } from "lucide-react";
import { SimpleBonusField } from "@/lib/types/model-types";

// ============================================================================
// Types
// ============================================================================

export type ModifyConfig =
  | { type: "stat"; ability: Ability }
  | { type: "skill"; skill: Skills }
  | { type: "simple"; field: SimpleBonusField };

interface ModifyStatModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  pers: PersWithRelations;
  onPersUpdate: (next: PersWithRelations) => void;
  config: ModifyConfig | null;
}

// ============================================================================
// Component
// ============================================================================

export default function ModifyStatModal({
  open,
  onOpenChange,
  pers,
  onPersUpdate,
  config,
}: ModifyStatModalProps) {
  const router = useRouter();
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  // Local bonus states for immediate feedback
  const [localStatBonus, setLocalStatBonus] = useState(0);
  const [localModifierBonus, setLocalModifierBonus] = useState(0);
  const [localSaveBonus, setLocalSaveBonus] = useState(0);
  const [localSkillBonus, setLocalSkillBonus] = useState(0);
  const [localSimpleBonus, setLocalSimpleBonus] = useState(0);
  const [localProficiency, setLocalProficiency] = useState<SkillProficiencyType>("NONE");
  const [localSaveProficiency, setLocalSaveProficiency] = useState(false);
  
  // Initialize local state when modal opens
  const initializeState = useCallback(() => {
    if (!config) return;
    
    if (config.type === "stat") {
      setLocalStatBonus(getStatBonus(pers, config.ability));
      setLocalModifierBonus(getModifierBonus(pers, config.ability));
      setLocalSaveBonus(getSaveBonus(pers, config.ability));
      
      const savingThrows = pers.class.savingThrows ?? [];
      const additionalSaves = (pers as any).additionalSaveProficiencies as Ability[] ?? [];
      setLocalSaveProficiency(savingThrows.includes(config.ability) || additionalSaves.includes(config.ability));
    } else if (config.type === "skill") {
      setLocalSkillBonus(getSkillBonus(pers, config.skill));
      const persSkill = pers.skills.find((ps) => ps.name === config.skill);
      setLocalProficiency(persSkill?.proficiencyType ?? "NONE");
    } else if (config.type === "simple") {
      setLocalSimpleBonus(getSimpleBonus(pers, config.field));
    }
  }, [config, pers]);
  
  // Initialize when modal opens
  useMemo(() => {
    if (open) {
      initializeState();
    }
  }, [open, initializeState]);

  // Get title based on config
  const title = useMemo(() => {
    if (!config) return "";
    
    if (config.type === "stat") {
      const statName = bonusTranslations.statNames[config.ability as keyof typeof bonusTranslations.statNames];
      return `${bonusTranslations.modifyTitle}: ${statName}`;
    } else if (config.type === "skill") {
      const skillName = skillTranslations[config.skill] ?? config.skill;
      return `${bonusTranslations.modifyTitle}: ${skillName}`;
    } else {
      const fieldName = bonusTranslations.fieldNames[config.field as keyof typeof bonusTranslations.fieldNames];
      return `${bonusTranslations.modifyTitle}: ${fieldName}`;
    }
  }, [config]);

  // Calculate preview values
  const previewValues = useMemo(() => {
    if (!config) return null;
    
    if (config.type === "stat") {
      const ability = config.ability;
      const baseStatMap: Record<Ability, number> = {
        STR: pers.str,
        DEX: pers.dex,
        CON: pers.con,
        INT: pers.int,
        WIS: pers.wis,
        CHA: pers.cha,
      };
      const baseStat = baseStatMap[ability];
      const finalStat = baseStat + localStatBonus;
      const baseMod = getAbilityMod(finalStat);
      const finalMod = baseMod + localModifierBonus;
      
      const savingThrows = pers.class.savingThrows ?? [];
      const additionalSaves = (pers as any).additionalSaveProficiencies as Ability[] ?? [];
      const isProficient = savingThrows.includes(ability) || additionalSaves.includes(ability);
      
      // Predict preview based on local toggle if editing stat
      const effectiveIsProficient = localSaveProficiency;
      
      const pb = calculateFinalProficiency(pers);
      const baseSave = finalMod + (effectiveIsProficient ? pb : 0);
      const finalSave = baseSave + localSaveBonus;
      
      return {
        stat: { base: baseStat, bonus: localStatBonus, final: finalStat },
        modifier: { base: baseMod, bonus: localModifierBonus, final: finalMod },
        save: { base: baseSave, bonus: localSaveBonus, final: finalSave, isProficient: effectiveIsProficient },
      };
    } else if (config.type === "skill") {
      const skill = config.skill;
      const abilityKey = (skill.toLowerCase() in { athletics: 1 } ? "str" : 
                         ["acrobatics", "sleight_of_hand", "stealth"].includes(skill.toLowerCase()) ? "dex" :
                         ["arcana", "history", "investigation", "nature", "religion"].includes(skill.toLowerCase()) ? "int" :
                         ["animal_handling", "insight", "medicine", "perception", "survival"].includes(skill.toLowerCase()) ? "wis" : "cha");
      
      const ability = abilityKey.toUpperCase() as Ability;
      const finalStat = calculateFinalStat(pers, ability);
      const abilityMod = getAbilityMod(finalStat);
      const modBonus = getModifierBonus(pers, ability);
      
      const pb = calculateFinalProficiency(pers);
      let baseTotal = abilityMod + modBonus;
      
      if (localProficiency === "PROFICIENT") baseTotal += pb;
      if (localProficiency === "EXPERTISE") baseTotal += pb * 2;
      
      const finalTotal = baseTotal + localSkillBonus;
      
      return {
        skill: { base: baseTotal - localSkillBonus, bonus: localSkillBonus, final: finalTotal },
      };
    } else {
      // Simple bonus
      let baseValue = 0;
      switch (config.field) {
        case "hp": baseValue = pers.maxHp; break;
        case "ac": baseValue = calculateFinalAC(pers) - getSimpleBonus(pers, "ac"); break;
        case "speed": baseValue = 30; break;
        case "proficiency": baseValue = getProficiencyBonus(pers.level); break;
        case "initiative": baseValue = calculateFinalInitiative(pers) - getSimpleBonus(pers, "initiative"); break;
        case "spellAttack": {
          const ability = pers.class?.primaryCastingStat ?? Ability.INT;
          baseValue = calculateSpellAttack(pers, ability) - getSimpleBonus(pers, "spellAttack");
          break;
        }
        case "spellDC": {
          const ability = pers.class?.primaryCastingStat ?? Ability.INT;
          baseValue = calculateSpellDC(pers, ability) - getSimpleBonus(pers, "spellDC");
          break;
        }
        default: baseValue = 0;
      }
      const finalValue = baseValue + localSimpleBonus;
      
      return {
        simple: { base: baseValue, bonus: localSimpleBonus, final: finalValue },
      };
    }
  }, [config, pers, localStatBonus, localModifierBonus, localSaveBonus, localSkillBonus, localSimpleBonus, localProficiency, localSaveProficiency]);

  // Apply optimistic update and save
  const handleSave = async () => {
    if (!config || isSubmitting) return;
    
    setIsSubmitting(true);
    
    // Store previous state for rollback
    const prevPers = pers;
    
    try {
      if (config.type === "stat") {
        // Save all three bonuses for stat
        const ability = config.ability;
        
        // Optimistic update
        const nextPers = {
          ...pers,
          statBonuses: {
            ...(pers as any).statBonuses ?? {},
            [ability]: localStatBonus,
          },
          statModifierBonuses: {
            ...(pers as any).statModifierBonuses ?? {},
            [ability]: localModifierBonus,
          },
          saveBonuses: {
            ...(pers as any).saveBonuses ?? {},
            [ability]: localSaveBonus,
          },
          additionalSaveProficiencies: localSaveProficiency 
            ? Array.from(new Set([...((pers as any).additionalSaveProficiencies ?? []), ability]))
            : ((pers as any).additionalSaveProficiencies ?? []).filter((a: Ability) => a !== ability),
        } as unknown as PersWithRelations;
        
        onPersUpdate(nextPers);
        
        // Save to server
        const results = await Promise.all([
          updateBonus(pers.persId, "stat", ability, localStatBonus),
          updateBonus(pers.persId, "statModifier", ability, localModifierBonus),
          updateBonus(pers.persId, "save", ability, localSaveBonus),
          updateSaveProficiency(pers.persId, ability, localSaveProficiency),
        ]);
        
        const failed = results.find((r) => !r.success);
        if (failed && !failed.success) {
          onPersUpdate(prevPers);
          toast.error(failed.error);
          return;
        }
        
      } else if (config.type === "skill") {
        // Store previous state for skill proficiency rollback
        const skill = config.skill;
        const persSkill = pers.skills.find(s => s.name === skill);
        const prevProficiency = persSkill?.proficiencyType ?? "NONE";

        // Optimistic update
        const nextPers = {
          ...pers,
          skillBonuses: {
            ...(pers as unknown as { skillBonuses?: Record<string, number> }).skillBonuses ?? {},
            [skill]: localSkillBonus,
          },
          skills: pers.skills.map(s => s.name === skill ? { ...s, proficiencyType: localProficiency } : s),
        } as unknown as PersWithRelations;
        
        // If skill doesn't exist in the list, we'd need to add it, but currently assuming it exists or handled by server
        
        onPersUpdate(nextPers);
        
        const results = await Promise.all([
          updateBonus(pers.persId, "skill", skill, localSkillBonus),
          updateSkillProficiency(pers.persId, skill, localProficiency),
        ]);
        
        const failed = results.find((r) => !r.success);
        if (failed && !failed.success) {
          onPersUpdate(prevPers);
          toast.error(failed.error);
          return;
        }
        
      } else {
        // Simple bonus
        const fieldMap: Record<SimpleBonusField, string> = {
          hp: "hpBonuses",
          ac: "acBonuses",
          speed: "speedBonuses",
          proficiency: "proficiencyBonuses",
          initiative: "initiativeBonuses",
          spellAttack: "spellAttackBonuses",
          spellDC: "spellDCBonuses",
        };
        
        const field = fieldMap[config.field];
        const nextPers = {
          ...pers,
          [field]: localSimpleBonus === 0 ? null : { value: localSimpleBonus },
        } as PersWithRelations;
        
        onPersUpdate(nextPers);
        
        const res = await updateBonus(pers.persId, config.field, null, localSimpleBonus);
        if (!res.success) {
          onPersUpdate(prevPers);
          toast.error(res.error);
          return;
        }
      }
      
      onOpenChange(false);
      // Background refresh
      router.refresh();
      
    } finally {
      setIsSubmitting(false);
    }
  };

  // Number input with +/- buttons
  const NumberInput = ({
    value,
    onChange,
    label,
    preview,
  }: {
    value: number;
    onChange: (v: number) => void;
    label: string;
    preview?: { base: number; final: number };
  }) => (
    <div className="space-y-2">
      <div className="text-sm font-medium text-slate-200">{label}</div>
      <div className="flex items-center gap-2">
        <Button
          type="button"
          size="icon"
          variant="secondary"
          className="h-9 w-9"
          onClick={() => onChange(value - 1)}
          disabled={isSubmitting}
        >
          <Minus className="w-4 h-4" />
        </Button>
        <Input
          type="number"
          value={value}
          onChange={(e) => onChange(parseInt(e.target.value) || 0)}
          className="w-20 text-center h-9"
          disabled={isSubmitting}
        />
        <Button
          type="button"
          size="icon"
          variant="secondary"
          className="h-9 w-9"
          onClick={() => onChange(value + 1)}
          disabled={isSubmitting}
        >
          <Plus className="w-4 h-4" />
        </Button>
      </div>
      {preview && (
        <div className="text-xs text-slate-400 flex gap-2">
          <span>{bonusTranslations.baseValue}: <span className="text-slate-300">{preview.base}</span></span>
          <span></span>
          <span>{bonusTranslations.finalValue}: <span className="text-emerald-400 font-medium">{preview.final}</span></span>
        </div>
      )}
    </div>
  );

  if (!config) return null;

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-sm">
        <DialogHeader>
          <DialogTitle>{title}</DialogTitle>
        </DialogHeader>

        <div className="py-2 overflow-y-auto max-h-[60vh] px-1">
          {config.type === "stat" && previewValues?.stat && (
            <div className="space-y-6">
              {/* Stat Bonus */}
              <div className="bg-slate-800/20 p-3 rounded-lg border border-slate-700/30">
                <NumberInput
                  value={localStatBonus}
                  onChange={setLocalStatBonus}
                  label={bonusTranslations.statBonus}
                  preview={previewValues.stat}
                />
              </div>

              {/* Modifier Bonus */}
              <div className="bg-slate-800/20 p-3 rounded-lg border border-slate-700/30">
                <NumberInput
                  value={localModifierBonus}
                  onChange={setLocalModifierBonus}
                  label={bonusTranslations.modifierBonus}
                  preview={previewValues.modifier}
                />
              </div>

              {/* Save Bonus & Proficiency */}
              <div className="bg-slate-800/20 p-3 rounded-lg border border-slate-700/30 space-y-4">
                <NumberInput
                  value={localSaveBonus}
                  onChange={setLocalSaveBonus}
                  label={bonusTranslations.saveBonus}
                  preview={previewValues.save}
                />
                
                <div className="flex items-center justify-between pt-2 border-t border-slate-700/50">
                  <Label htmlFor="save-proficiency" className="text-sm font-medium text-slate-300">
                    {bonusTranslations.saveProficiency ?? "  "}
                  </Label>
                  <Switch
                    id="save-proficiency"
                    checked={localSaveProficiency}
                    onCheckedChange={setLocalSaveProficiency}
                    disabled={isSubmitting}
                  />
                </div>
              </div>
            </div>
          )}

          {config.type === "skill" && previewValues?.skill && (
            <div className="space-y-6">
              <div className="space-y-3">
                <div className="text-sm font-medium text-slate-200">{bonusTranslations.proficiencyLevel}</div>
                <Tabs value={localProficiency} onValueChange={(v) => setLocalProficiency(v as SkillProficiencyType)}>
                  <TabsList className="grid w-full grid-cols-3 bg-slate-800/50">
                    <TabsTrigger value="NONE" className="text-xs data-[state=active]:bg-slate-700">
                      {bonusTranslations.proficiencies.NONE}
                    </TabsTrigger>
                    <TabsTrigger value="PROFICIENT" className="text-xs data-[state=active]:bg-cyan-500/20 data-[state=active]:text-cyan-400">
                      {bonusTranslations.proficiencies.PROFICIENT}
                    </TabsTrigger>
                    <TabsTrigger value="EXPERTISE" className="text-xs data-[state=active]:bg-amber-500/20 data-[state=active]:text-amber-400">
                      {bonusTranslations.proficiencies.EXPERTISE}
                    </TabsTrigger>
                  </TabsList>
                </Tabs>
              </div>

              <NumberInput
                value={localSkillBonus}
                onChange={setLocalSkillBonus}
                label={bonusTranslations.skillBonus}
                preview={previewValues.skill}
              />
            </div>
          )}

          {config.type === "simple" && previewValues?.simple && (
            <NumberInput
              value={localSimpleBonus}
              onChange={setLocalSimpleBonus}
              label={bonusTranslations.fieldNames[config.field as keyof typeof bonusTranslations.fieldNames]}
              preview={previewValues.simple}
            />
          )}
        </div>

        <DialogFooter className="gap-2 sm:gap-0">
          <Button variant="secondary" onClick={() => onOpenChange(false)} disabled={isSubmitting}>
            {bonusTranslations.cancel}
          </Button>
          <Button
            onClick={handleSave}
            disabled={isSubmitting}
            className="bg-indigo-600 hover:bg-indigo-700"
          >
            {isSubmitting ? bonusTranslations.saving : bonusTranslations.save}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/lib/components/characterSheet/PrintCharacterDialog.tsx">
"use client";

import { useMemo, useState, useTransition } from "react";
import { toast } from "sonner";

import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";

import type { PrintConfig, PrintSection } from "@/server/pdf/types";
import { generateCharacterPdfAction } from "@/app/pers/[id]/print/actions";

function base64ToUint8Array(base64: string): Uint8Array {
  const binaryString = atob(base64);
  const bytes = new Uint8Array(binaryString.length);
  for (let i = 0; i < binaryString.length; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }
  return bytes;
}

export interface PrintCharacterDialogProps {
  persId: number;
  characterName: string;
  disabled?: boolean;
}

export default function PrintCharacterDialog({ persId, characterName, disabled }: PrintCharacterDialogProps) {
  const [open, setOpen] = useState(false);
  const [isPending, startTransition] = useTransition();

  const [includeCharacter, setIncludeCharacter] = useState(true);
  const [includeFeatures, setIncludeFeatures] = useState(true);
  const [includeSpells, setIncludeSpells] = useState(true);

  const config: PrintConfig = useMemo(() => {
    const sections: PrintSection[] = [];
    if (includeCharacter) sections.push("CHARACTER");
    if (includeFeatures) sections.push("FEATURES");
    if (includeSpells) sections.push("SPELLS");
    return { sections };
  }, [includeCharacter, includeFeatures, includeSpells]);

  const handleDownload = () => {
    startTransition(async () => {
      try {
        const res = await generateCharacterPdfAction(persId, config);
        const bytes = base64ToUint8Array(res.data);
        const arrayBuffer = new ArrayBuffer(bytes.byteLength);
        new Uint8Array(arrayBuffer).set(bytes);
        const blob = new Blob([arrayBuffer], { type: res.contentType });

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${characterName || "character"}.pdf`;
        a.click();
        URL.revokeObjectURL(url);

        setOpen(false);
      } catch (e) {
        const message = e instanceof Error ? e.message : "Failed to generate PDF";
        toast.error(message);
      }
    });
  };

  return (
    <>
      <Button
        size="sm"
        variant="secondary"
        className="h-8"
        onClick={() => setOpen(true)}
        disabled={disabled || isPending}
      >
        Print
      </Button>

      <Dialog open={open} onOpenChange={setOpen}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle>Print to PDF</DialogTitle>
          </DialogHeader>

          <div className="space-y-3">
            <div className="flex items-center gap-2">
              <Checkbox checked={includeCharacter} onCheckedChange={(v) => setIncludeCharacter(Boolean(v))} id="print-character" />
              <Label htmlFor="print-character">Include character sheet</Label>
            </div>

            <div className="flex items-center gap-2">
              <Checkbox checked={includeFeatures} onCheckedChange={(v) => setIncludeFeatures(Boolean(v))} id="print-features" />
              <Label htmlFor="print-features">Include features pages</Label>
            </div>

            <div className="flex items-center gap-2">
              <Checkbox checked={includeSpells} onCheckedChange={(v) => setIncludeSpells(Boolean(v))} id="print-spells" />
              <Label htmlFor="print-spells">Include spells pages</Label>
            </div>

            <div className="flex justify-end gap-2 pt-2">
              <Button variant="ghost" onClick={() => setOpen(false)} disabled={isPending}>
                Cancel
              </Button>
              <Button onClick={handleDownload} disabled={isPending || config.sections.length === 0}>
                {isPending ? "Generating" : "Download PDF"}
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </>
  );
}
</file>

<file path="src/lib/components/characterSheet/RestButton.tsx">
"use client";

import { useState, useTransition } from "react";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from "@/components/ui/dialog";
import { Moon, Sun, ChevronDown } from "lucide-react";
import { toast } from "sonner";
import { useRouter } from "next/navigation";
import { longRest } from "@/lib/actions/rest-actions";
import { restTranslations } from "@/lib/refs/translation";
import ShortRestDialog from "./ShortRestDialog";
import { PersWithRelations } from "@/lib/actions/pers";

interface RestButtonProps {
  pers: PersWithRelations;
  onPersUpdate?: (next: PersWithRelations) => void;
}

export default function RestButton({ pers, onPersUpdate }: RestButtonProps) {
  const router = useRouter();
  const [isRefreshing, startRefreshTransition] = useTransition();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [shortRestOpen, setShortRestOpen] = useState(false);
  const [longRestOpen, setLongRestOpen] = useState(false);

  const refreshInBackground = () => {
    startRefreshTransition(() => {
      router.refresh();
    });
  };

  const handleLongRest = async () => {
    if (isSubmitting) return;
    setIsSubmitting(true);
    try {
      const res = await longRest(pers.persId);
      if (!res.success) {
        toast.error(res.error);
        return;
      }

      onPersUpdate?.({
        ...pers,
        currentHp: res.newCurrentHp,
        tempHp: 0,
        currentHitDice: res.currentHitDice as any,
        currentSpellSlots: res.currentSpellSlots as any,
        currentPactSlots: res.currentPactSlots as any,
        deathSaveSuccesses: 0 as any,
        deathSaveFailures: 0 as any,
        isDead: false as any,
      });

      toast.success(restTranslations.longRestComplete, {
        description: `HP: ${res.newCurrentHp}, ${restTranslations.featuresRestored}: ${res.featuresRestored}`,
      });
      setLongRestOpen(false);
      refreshInBackground();
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <>
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button
            size="sm"
            variant="secondary"
            className="h-8 gap-2 bg-amber-600/20 hover:bg-amber-600/30 border-amber-500/30"
            disabled={isSubmitting}
          >
            <Moon className="w-4 h-4" />
            <span className="hidden sm:inline">{restTranslations.rest}</span>
            <ChevronDown className="w-3 h-3" />
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent align="end">
          <DropdownMenuItem onClick={() => setShortRestOpen(true)}>
            <Sun className="w-4 h-4 mr-2" />
            {restTranslations.shortRest}
          </DropdownMenuItem>
          <DropdownMenuItem onClick={() => setLongRestOpen(true)}>
            <Moon className="w-4 h-4 mr-2" />
            {restTranslations.longRest}
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>

      <ShortRestDialog
        pers={pers}
        open={shortRestOpen}
        onOpenChange={setShortRestOpen}
        onPersUpdate={onPersUpdate ? (next) => onPersUpdate(next) : undefined}
      />

      <Dialog open={longRestOpen} onOpenChange={setLongRestOpen}>
        <DialogContent className="max-w-sm">
          <DialogHeader>
            <DialogTitle>{restTranslations.confirmLongRest}</DialogTitle>
            <DialogDescription>
              {restTranslations.longRestDescription}
            </DialogDescription>
          </DialogHeader>
          <DialogFooter className="gap-2 sm:gap-0">
            <Button
              variant="secondary"
              onClick={() => setLongRestOpen(false)}
              disabled={isSubmitting}
            >
              {restTranslations.cancel}
            </Button>
            <Button
              onClick={handleLongRest}
              disabled={isSubmitting}
              className="bg-indigo-600 hover:bg-indigo-700"
            >
              {isSubmitting || isRefreshing ? restTranslations.takingLongRest : restTranslations.confirm}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </>
  );
}
</file>

<file path="src/lib/components/characterSheet/ShareDialog.tsx">
"use client";

import React, { useState } from "react";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Share2, Copy, Check, Link as LinkIcon } from "lucide-react";
import { generateShareToken } from "@/lib/actions/share-actions";
import { toast } from "sonner";

interface ShareDialogProps {
  persId: number;
  initialToken?: string | null;
}

export function ShareDialog({ persId, initialToken }: ShareDialogProps) {
  const [token, setToken] = useState<string | null>(initialToken || null);
  const [isGenerating, setIsGenerating] = useState(false);
  const [copied, setCopied] = useState(false);
  const [origin, setOrigin] = useState("");

  React.useEffect(() => {
    setOrigin(window.location.origin);
  }, []);

  const handleGenerate = async () => {
    setIsGenerating(true);
    const result = await generateShareToken(persId);
    setIsGenerating(false);
    if (result.success && result.token) {
      setToken(result.token);
      toast.success(" !");
    } else {
      toast.error(result.error || "   ");
    }
  };

  const shareUrl = token && origin ? `${origin}/pers/share/${token}` : "";

  const copyToClipboard = () => {
    if (!shareUrl) return;
    navigator.clipboard.writeText(shareUrl);
    setCopied(true);
    toast.success(" !");
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <Dialog>
      <DialogTrigger asChild>
        <Button variant="ghost" size="icon" className="h-8 w-8 text-slate-300 hover:text-white">
          <Share2 className="h-4 w-4" />
        </Button>
      </DialogTrigger>
      <DialogContent className="sm:max-w-[425px] glass-card border-white/10 text-slate-100">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <LinkIcon className="h-5 w-5" />
             
          </DialogTitle>
        </DialogHeader>
        
        <div className="py-4 space-y-4">
          <p className="text-sm text-slate-400">
              ,       (  ).
          </p>
          
          {token ? (
            <div className="space-y-3">
              <div className="flex items-center gap-2 p-2 bg-black/30 rounded border border-white/10">
                <code className="text-xs truncate flex-1 text-indigo-300">
                  {origin}/pers/share/{token.slice(0, 8)}...
                </code>
                <Button size="icon" variant="ghost" className="h-8 w-8" onClick={copyToClipboard}>
                  {copied ? <Check className="h-4 w-4 text-emerald-400" /> : <Copy className="h-4 w-4" />}
                </Button>
              </div>
              <p className="text-[10px] text-slate-500 text-center">
                -       .
              </p>
            </div>
          ) : (
            <Button 
                onClick={handleGenerate} 
                disabled={isGenerating}
                className="w-full bg-indigo-600 hover:bg-indigo-700"
            >
              {isGenerating ? "..." : " "}
            </Button>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/lib/components/characterSheet/ShortRestDialog.tsx">
"use client";

import { useEffect, useMemo, useState, useTransition } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";
import { useRouter } from "next/navigation";
import { shortRest, HitDiceToUse } from "@/lib/actions/rest-actions";
import { restTranslations, classTranslations } from "@/lib/refs/translation";
import { PersWithRelations } from "@/lib/actions/pers";
import { getAbilityMod } from "@/lib/logic/utils";
import { Classes } from "@prisma/client";
import { Minus, Plus, Dice6 } from "lucide-react";

interface ShortRestDialogProps {
  pers: PersWithRelations;
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onPersUpdate?: (next: PersWithRelations) => void;
}

interface HitDieInfo {
  classId: number;
  className: string;
  hitDie: number;
  current: number;
  max: number;
}

export default function ShortRestDialog({ pers, open, onOpenChange, onPersUpdate }: ShortRestDialogProps) {
  const router = useRouter();
  const [isRefreshing, startRefreshTransition] = useTransition();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [hitDice, setHitDice] = useState<HitDieInfo[]>([]);
  const [selected, setSelected] = useState<Record<number, number>>({});

  const conMod = getAbilityMod(pers.con);

  const derivedHitDice = useMemo<HitDieInfo[]>(() => {
    const multiclassLevelSum = pers.multiclasses?.reduce((acc, mc) => acc + mc.classLevel, 0) ?? 0;
    const mainClassLevel = pers.level - multiclassLevelSum;

    const stored = (pers as unknown as { currentHitDice?: Record<string, number> }).currentHitDice ?? {};

    const mainClassName = classTranslations[pers.class.name as Classes] ?? pers.class.name;
    const mainCurrentRaw = stored[String(pers.class.classId)];
    const mainCurrent = typeof mainCurrentRaw === "number" ? mainCurrentRaw : mainClassLevel;

    const result: HitDieInfo[] = [
      {
        classId: pers.class.classId,
        className: mainClassName,
        hitDie: pers.class.hitDie,
        current: Math.max(0, Math.min(mainCurrent, mainClassLevel)),
        max: Math.max(0, mainClassLevel),
      },
    ];

    for (const mc of pers.multiclasses ?? []) {
      const mcClassName = classTranslations[mc.class.name as unknown as Classes] ?? mc.class.name;
      const mcCurrentRaw = stored[String(mc.classId)];
      const mcCurrent = typeof mcCurrentRaw === "number" ? mcCurrentRaw : mc.classLevel;
      result.push({
        classId: mc.classId,
        className: mcClassName,
        hitDie: mc.class.hitDie,
        current: Math.max(0, Math.min(mcCurrent, mc.classLevel)),
        max: Math.max(0, mc.classLevel),
      });
    }

    return result;
  }, [pers]);

  const refreshInBackground = () => {
    startRefreshTransition(() => {
      router.refresh();
    });
  };

  useEffect(() => {
    if (open) {
      setHitDice(derivedHitDice);
      const initialSelection: Record<number, number> = {};
      derivedHitDice.forEach((hd) => {
        initialSelection[hd.classId] = 0;
      });
      setSelected(initialSelection);
    }
  }, [open, derivedHitDice]);

  const totalDiceSelected = Object.values(selected).reduce((sum, count) => sum + count, 0);

  // Calculate estimated HP restoration
  const estimatedHp = hitDice.reduce((sum, hd) => {
    const count = selected[hd.classId] ?? 0;
    if (count === 0) return sum;
    const avgRoll = Math.ceil(hd.hitDie / 2);
    return sum + count * Math.max(1, avgRoll + conMod);
  }, 0);

  const handleShortRest = () => {
    const hitDiceToUse: HitDiceToUse[] = Object.entries(selected)
      .filter(([, count]) => count > 0)
      .map(([classId, count]) => ({
        classId: Number(classId),
        count,
      }));

    if (isSubmitting) return;
    setIsSubmitting(true);
    (async () => {
      try {
        const res = await shortRest(pers.persId, hitDiceToUse);
        if (!res.success) {
          toast.error(res.error);
          return;
        }

        // Apply immediate local update (so UI doesn't wait for router.refresh)
        // Note: short rest doesn't change maxHp; just currentHp + hit dice.
        const nextPers: PersWithRelations = {
          ...pers,
          currentHp: res.newCurrentHp,
          currentHitDice: res.currentHitDice as any,
        };

        onPersUpdate?.(nextPers);

        toast.success(restTranslations.shortRestComplete, {
          description: `${restTranslations.hpRestored}: ${res.hpRestored}, ${restTranslations.featuresRestored}: ${res.featuresRestored}`,
        });
        onOpenChange(false);
        refreshInBackground();
      } finally {
        setIsSubmitting(false);
      }
    })();
  };

  const increment = (classId: number) => {
    const hd = hitDice.find((h) => h.classId === classId);
    if (!hd) return;
    const current = selected[classId] ?? 0;
    if (current < hd.current) {
      setSelected((prev) => ({ ...prev, [classId]: current + 1 }));
    }
  };

  const decrement = (classId: number) => {
    const current = selected[classId] ?? 0;
    if (current > 0) {
      setSelected((prev) => ({ ...prev, [classId]: current - 1 }));
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle>{restTranslations.shortRest}</DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          {/* Current HP display */}
          <div className="rounded-lg border border-white/10 bg-slate-900/40 p-3">
            <div className="text-xs text-slate-300">
              {restTranslations.currentHp}:{" "}
              <span className="font-semibold text-slate-50">{pers.currentHp}</span> / {pers.maxHp}
            </div>
          </div>

          {/* Hit dice selection */}
          <div className="space-y-2">
            <div className="text-sm font-medium text-slate-200">{restTranslations.selectHitDice}</div>
            
            {hitDice.length === 0 ? (
              <div className="text-sm text-slate-400">{restTranslations.noHitDiceAvailable}</div>
            ) : (
              <div className="space-y-2">
                {hitDice.map((hd) => (
                  <div
                    key={hd.classId}
                    className="flex items-center justify-between rounded-lg border border-white/10 bg-slate-900/40 p-3"
                  >
                    <div className="flex items-center gap-2">
                      <Dice6 className="w-4 h-4 text-amber-400" />
                      <div>
                        <div className="text-sm font-medium text-slate-100">{hd.className}</div>
                        <div className="text-xs text-slate-400">
                          {hd.current}/{hd.max} d{hd.hitDie}
                        </div>
                      </div>
                    </div>

                    <div className="flex items-center gap-2">
                      <Button
                        type="button"
                        size="icon"
                        variant="secondary"
                        className="h-7 w-7"
                        onClick={() => decrement(hd.classId)}
                        disabled={isSubmitting || (selected[hd.classId] ?? 0) <= 0}
                      >
                        <Minus className="w-3 h-3" />
                      </Button>
                      <span className="w-6 text-center text-sm font-medium text-slate-100">
                        {selected[hd.classId] ?? 0}
                      </span>
                      <Button
                        type="button"
                        size="icon"
                        variant="secondary"
                        className="h-7 w-7"
                        onClick={() => increment(hd.classId)}
                        disabled={isSubmitting || (selected[hd.classId] ?? 0) >= hd.current}
                      >
                        <Plus className="w-3 h-3" />
                      </Button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* HP restoration preview */}
          {totalDiceSelected > 0 && (
            <div className="rounded-lg border border-emerald-500/30 bg-emerald-500/10 p-3">
              <div className="text-xs text-emerald-300">
                 {restTranslations.restoreHp}:{" "}
                <span className="font-bold text-emerald-200">+{estimatedHp}</span>
                <span className="text-emerald-400 ml-1">()</span>
              </div>
              <div className="text-[10px] text-emerald-400/80 mt-1">
                d + {conMod >= 0 ? "+" : ""}{conMod} (CON) {restTranslations.perDie}
              </div>
            </div>
          )}
        </div>

        <DialogFooter className="gap-2 sm:gap-0">
          <Button variant="secondary" onClick={() => onOpenChange(false)} disabled={isSubmitting}>
            {restTranslations.cancel}
          </Button>
          <Button
            onClick={handleShortRest}
            disabled={isSubmitting}
            className="bg-amber-600 hover:bg-amber-700"
          >
            {isSubmitting || isRefreshing ? restTranslations.takingShortRest : restTranslations.confirm}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/lib/components/characterSheet/SnapshotHistoryModal.tsx">
"use client";

import React, { useState, useTransition } from "react";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { History, Eye, Play, Check } from "lucide-react";
import { getSnapshots, activateSnapshot } from "@/lib/actions/snapshot-actions";
import { toast } from "sonner";
import { format } from "date-fns";
import { uk } from "date-fns/locale";
import Link from "next/link";
import { Badge } from "@/components/ui/badge";

interface Snapshot {
  persId: number;
  name: string;
  level: number;
  snapshotLevel: number | null;
  createdAt: Date;
  isActive: boolean;
}

interface SnapshotHistoryModalProps {
  persId: number;
  characterName: string;
}

export function SnapshotHistoryModal({ persId, characterName }: SnapshotHistoryModalProps) {
  const [snapshots, setSnapshots] = useState<Snapshot[]>([]);
  const [isOpen, setIsOpen] = useState(false);
  const [isPending, startTransition] = useTransition();

  const loadSnapshots = async () => {
    const data = await getSnapshots(persId);
    setSnapshots(data as any);
  };

  const handleOpenChange = (open: boolean) => {
    setIsOpen(open);
    if (open) {
      loadSnapshots();
    }
  };

  const handleActivate = (snapshotId: number) => {
    startTransition(async () => {
      const result = await activateSnapshot(snapshotId);
      if (result.success) {
        toast.success(" !");
        loadSnapshots();
      } else {
        toast.error(result.error || "   ");
      }
    });
  };

  return (
    <Dialog open={isOpen} onOpenChange={handleOpenChange}>
      <DialogTrigger asChild>
        <Button variant="ghost" size="icon" className="h-8 w-8" onClick={(e) => e.stopPropagation()}>
          <History className="h-4 w-4" />
        </Button>
      </DialogTrigger>
      <DialogContent className="sm:max-w-[500px] glass-card border-white/10 text-slate-100">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <History className="h-5 w-5" />
            : {characterName}
          </DialogTitle>
        </DialogHeader>
        
        <div className="mt-4 space-y-4 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
          {snapshots.length === 0 ? (
            <div className="text-center py-8 text-slate-400">
                .      .
            </div>
          ) : (
            snapshots.map((snapshot) => (
              <div 
                key={snapshot.persId}
                className="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 transition-colors"
              >
                <div className="space-y-1">
                  <div className="flex items-center gap-2">
                    <span className="font-medium"> {snapshot.snapshotLevel || snapshot.level}</span>
                    {snapshot.isActive && (
                      <Badge variant="outline" className="bg-emerald-500/10 text-emerald-400 border-emerald-500/20 py-0 h-5">
                        <Check className="h-3 w-3 mr-1" /> 
                      </Badge>
                    )}
                  </div>
                  <p className="text-xs text-slate-400">
                    {format(new Date(snapshot.createdAt), "d MMMM yyyy, HH:mm", { locale: uk })}
                  </p>
                </div>
                
                <div className="flex gap-2">
                  <Link href={`/pers/${snapshot.persId}`} target="_blank">
                    <Button variant="ghost" size="icon" title="">
                      <Eye className="h-4 w-4" />
                    </Button>
                  </Link>
                  
                  {!snapshot.isActive && (
                    <Button 
                      variant="ghost" 
                      size="icon" 
                      title=""
                      disabled={isPending}
                      onClick={() => handleActivate(snapshot.persId)}
                    >
                      <Play className="h-4 w-4" />
                    </Button>
                  )}
                </div>
              </div>
            ))
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/lib/components/characterSheet/SpellInfoModal.tsx">
"use client";

import { useEffect, useMemo, useState } from "react";

import { Dialog, DialogContent, DialogTitle } from "@/components/ui/dialog";
import { FormattedDescription } from "@/components/ui/FormattedDescription";
import { getSpellForModal, type SpellForModal } from "@/lib/actions/spell-actions";
import { sourceTranslations, spellSchoolTranslations } from "@/lib/refs/translation";
import { useMediaQuery } from "@/lib/hooks/useMediaQuery";

function dispatchLocationChangeAsync() {
  if (typeof window === "undefined") return;
  const fire = () => window.dispatchEvent(new Event("locationchange"));
  if (typeof queueMicrotask === "function") queueMicrotask(fire);
  else window.setTimeout(fire, 0);
}

function getSpellParamFromLocation(): string {
  if (typeof window === "undefined") return "";
  return new URLSearchParams(window.location.search).get("spell")?.trim() || "";
}

function clearSpellParamInUrl() {
  if (typeof window === "undefined") return;
  const url = new URL(window.location.href);
  url.searchParams.delete("spell");
  window.history.pushState({}, "", url);
  dispatchLocationChangeAsync();
}

function isYesFlag(value: string | null | undefined): boolean {
  const v = (value ?? "").trim().toLowerCase();
  if (!v) return false;
  return v === "" || v === "yes" || v === "true" || v === "1";
}

function labelForLevel(level: number, isRitual: boolean) {
  const base = level === 0 ? "" : ` ${level}`;
  return isRitual ? `${base} ()` : base;
}

function uniqSorted(values: Array<string | null | undefined>) {
  return Array.from(
    new Set(values.map((value) => (value ?? "").trim()).filter(Boolean))
  ).sort((a, b) => a.localeCompare(b, "uk"));
}

function ritualForSpell(spell: SpellForModal | null): boolean {
  return spell ? isYesFlag(spell.hasRitual) : false;
}

type SpellOpenDetail = {
  spellId?: unknown;
  spell?: unknown;
};

function isSpellForModalLike(value: unknown): value is SpellForModal {
  if (!value || typeof value !== "object") return false;
  const v = value as Record<string, unknown>;
  return (
    typeof v.spellId === "number" &&
    typeof v.name === "string" &&
    typeof v.engName === "string" &&
    typeof v.level === "number" &&
    typeof v.castingTime === "string" &&
    typeof v.duration === "string" &&
    typeof v.range === "string" &&
    typeof v.description === "string" &&
    typeof v.source === "string" &&
    Array.isArray(v.spellClasses) &&
    Array.isArray(v.spellRaces)
  );
}

export function SpellInfoModal() {
  const isLg = useMediaQuery("(min-width: 1024px)");

  const [spellParam, setSpellParam] = useState<string>(() => getSpellParamFromLocation());
  const open = Boolean(spellParam) && !(isLg && typeof window !== "undefined" && window.location.pathname === "/spells");

  const [spell, setSpell] = useState<SpellForModal | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    // Patch history methods once so we can react to router pushes too.
    const w = window as Window & { __locationchange_patched__?: boolean };
    if (typeof window !== "undefined" && !w.__locationchange_patched__) {
      w.__locationchange_patched__ = true;

      const wrap = (type: "pushState" | "replaceState") => {
        const original = window.history[type];
        return function (this: History, ...args: unknown[]) {
          const result = (original as unknown as (...a: unknown[]) => unknown).apply(this, args);
          dispatchLocationChangeAsync();
          return result;
        };
      };

      window.history.pushState = wrap("pushState");
      window.history.replaceState = wrap("replaceState");
    }

    const syncFromUrl = () => {
      const next = getSpellParamFromLocation();
      setSpellParam(next);
    };

    const onSpellOpen = (e: Event) => {
      const detail = (e as CustomEvent).detail as SpellOpenDetail | undefined;

      const fromSpellObj = detail?.spell && isSpellForModalLike(detail.spell) ? detail.spell : null;
      const rawId = fromSpellObj ? String(fromSpellObj.spellId) : detail?.spellId;
      const next = typeof rawId === "string" ? rawId : String(rawId ?? "");

      if (fromSpellObj) {
        setSpell(fromSpellObj);
        setLoading(false);
        setError(null);
      }

      if (next && next !== "undefined" && next !== "null") setSpellParam(next);
    };

    window.addEventListener("popstate", syncFromUrl);
    window.addEventListener("locationchange", syncFromUrl);
    window.addEventListener("spell:open", onSpellOpen);

    return () => {
      window.removeEventListener("popstate", syncFromUrl);
      window.removeEventListener("locationchange", syncFromUrl);
      window.removeEventListener("spell:open", onSpellOpen);
    };
  }, []);

  useEffect(() => {
    let cancelled = false;

    async function run() {
      if (!spellParam) {
        setSpell(null);
        setError(null);
        setLoading(false);
        return;
      }

      // If we already have a full spell object (e.g. received from /spells list), skip DB fetch.
      if (
        spell &&
        (String(spell.spellId) === spellParam || spell.engName === spellParam || spell.name === spellParam)
      ) {
        setLoading(false);
        setError(null);
        return;
      }

      // Open instantly with skeleton while we fetch.
      setSpell(null);
      setLoading(true);
      setError(null);

      try {
        const result = await getSpellForModal(spellParam);
        if (cancelled) return;

        if (!result) {
          setSpell(null);
          setError("  ");
          return;
        }

        setSpell(result);
      } catch {
        if (cancelled) return;
        setSpell(null);
        setError("   ");
      } finally {
        if (cancelled) return;
        setLoading(false);
      }
    }

    void run();
    return () => {
      cancelled = true;
    };
  }, [spellParam, spell]);

  const onClose = () => {
    clearSpellParamInUrl();
    setSpellParam("");
  };

  const schoolLabel = useMemo(() => {
    if (!spell?.school) return null;
    return spellSchoolTranslations[spell.school as keyof typeof spellSchoolTranslations] || spell.school;
  }, [spell?.school]);

  const sourceLabel = useMemo(() => {
    if (!spell?.source) return null;
    return sourceTranslations[spell.source as keyof typeof sourceTranslations] || spell.source;
  }, [spell?.source]);

  const classList = useMemo(() => {
    if (!spell) return [];
    return uniqSorted(spell.spellClasses.map((c) => c.className));
  }, [spell]);

  const raceList = useMemo(() => {
    if (!spell) return [];
    return uniqSorted(spell.spellRaces.map((r) => r.raceName));
  }, [spell]);

  return (
    <Dialog
      open={open}
      onOpenChange={(nextOpen) => {
        if (!nextOpen) onClose();
      }}
    >
      <DialogContent
        className="max-h-[85vh] w-[95vw] max-w-3xl overflow-y-auto p-0 bg-gradient-to-b from-slate-950/18 to-slate-950/10"
      >
        <div className="p-3 sm:p-6">
          <div className="flex items-start justify-between gap-3">
            <DialogTitle className="min-w-0 font-sans text-xl font-semibold uppercase tracking-[0.10em] text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-violet-400 truncate">
              {spell?.name ?? (loading ? "" : "")}
            </DialogTitle>
          </div>

          <div className="mt-2 flex flex-col gap-2 rounded-xl bg-slate-800/50 p-2 sm:p-3 glass-panel">
            <div className="flex items-baseline justify-between gap-3">
              <div className="min-w-0 flex flex-wrap items-baseline gap-x-2 gap-y-1 text-sm text-slate-200/90">
                <span className="text-slate-200 font-medium">{spell ? labelForLevel(spell.level, ritualForSpell(spell)) : ""}</span>
                {schoolLabel ? <span className="italic text-slate-300">{schoolLabel}</span> : null}
              </div>
              {sourceLabel ? (
                <div className="min-w-0 max-w-[45%] flex-shrink text-right text-xs text-slate-400 truncate">
                  {sourceLabel}
                </div>
              ) : null}
            </div>
          </div>

          <div className="mt-3 grid grid-cols-2 gap-2 sm:gap-3">
            <div className="glass-panel rounded-2xl bg-slate-900/40 border border-white/5 p-2 sm:p-3">
              <div className="text-xs text-slate-400"> </div>
              <div className="mt-0.5 text-xs sm:text-sm text-slate-200">{spell?.castingTime ?? ""}</div>
            </div>
            <div className="glass-panel rounded-2xl bg-slate-900/40 border border-white/5 p-2 sm:p-3">
              <div className="text-xs text-slate-400"></div>
              <div className="mt-0.5 text-xs sm:text-sm text-slate-200">{spell?.duration ?? ""}</div>
            </div>
            <div className="glass-panel rounded-2xl bg-slate-900/40 border border-white/5 p-2 sm:p-3">
              <div className="text-xs text-slate-400"></div>
              <div className="mt-0.5 text-xs sm:text-sm text-slate-200">{spell?.range ?? ""}</div>
            </div>
            <div className="glass-panel rounded-2xl bg-slate-900/40 border border-white/5 p-2 sm:p-3">
              <div className="text-xs text-slate-400"></div>
              <div className="mt-0.5 text-xs sm:text-sm text-slate-200">{spell?.components ?? ""}</div>
            </div>
          </div>

          <div className="mt-5">
            {loading ? (
              <div className="glass-panel rounded-xl border border-slate-700/50 p-3 sm:p-4">
                <div className="animate-pulse space-y-3">
                  <div className="h-4 w-2/3 rounded bg-slate-700/40" />
                  <div className="h-4 w-full rounded bg-slate-700/30" />
                  <div className="h-4 w-5/6 rounded bg-slate-700/30" />
                </div>
                <div className="mt-3 text-xs text-slate-400"></div>
              </div>
            ) : error ? (
              <div className="glass-panel rounded-xl border border-slate-700/50 p-3 sm:p-4 text-sm text-slate-300">
                {error}
              </div>
            ) : spell ? (
              <div className="glass-panel rounded-xl border border-slate-700/50 p-3 sm:p-4">
                <FormattedDescription content={spell.description} className="text-slate-300" />
              </div>
            ) : null}
          </div>

          {spell ? (
            <div className="mt-5 border-t border-slate-800/70 pt-4 text-sm text-slate-300">
              <div>
                <span className="text-slate-400">:</span> {classList.length ? classList.join(", ") : ""}
              </div>
              
              {raceList.length ? (
                <div className="mt-1">
                <span className="text-slate-400">:</span> {raceList.length ? raceList.join(", ") : ""}
              </div>
              ) : null}
            </div>
          ) : null}
        </div>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/lib/components/characterSheet/WeaponCustomizeModal.tsx">
"use client";

import { useEffect, useState, useTransition } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { updateWeapon, deleteWeapon } from "@/lib/actions/equipment-actions";
import { Ability, PersWeapon } from "@prisma/client";
import { toast } from "sonner";
import { useModalBackButton } from "@/hooks/useModalBackButton";
import { Trash2 } from "lucide-react";

interface WeaponCustomizeModalProps {
  persWeapon: PersWeapon;
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export default function WeaponCustomizeModal({ persWeapon, open, onOpenChange }: WeaponCustomizeModalProps) {
  const [isPending, startTransition] = useTransition();
  const [formData, setFormData] = useState({
    overrideName: persWeapon.overrideName || "",
    attackBonus: persWeapon.attackBonus || 0,
    customDamageBonus: persWeapon.customDamageBonus as number || 0,
    customDamageDice: persWeapon.customDamageDice || "",
    customDamageAbility: persWeapon.customDamageAbility || "STR",
    isMagical: persWeapon.isMagical,
    isProficient: persWeapon.isProficient,
  });

  useModalBackButton(open, () => onOpenChange(false));

  useEffect(() => {
    if (open) {
      setFormData({
        overrideName: persWeapon.overrideName || "",
        attackBonus: persWeapon.attackBonus || 0,
        customDamageBonus: persWeapon.customDamageBonus as number || 0,
        customDamageDice: persWeapon.customDamageDice || "",
        customDamageAbility: persWeapon.customDamageAbility || "STR",
        isMagical: persWeapon.isMagical,
        isProficient: persWeapon.isProficient,
      });
    }
  }, [open, persWeapon]);

  const handleSave = () => {
    startTransition(async () => {
      const res = await updateWeapon(persWeapon.persWeaponId, {
        ...formData,
        overrideName: formData.overrideName || null,
        customDamageAbility: formData.customDamageAbility as Ability,
      });

      if (res.success) {
        toast.success(" ");
        onOpenChange(false);
      } else {
        toast.error(res.error || "   ");
      }
    });
  };

  const handleDelete = () => {
    if (!confirm(" ,     ?")) return;
    
    startTransition(async () => {
      const res = await deleteWeapon(persWeapon.persWeaponId);
      if (res.success) {
        toast.success(" ");
        onOpenChange(false);
      } else {
        toast.error(res.error || "   ");
      }
    });
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-md bg-slate-900/60 backdrop-blur-xl border-white/10 text-slate-50">
        <DialogHeader>
          <DialogTitle> </DialogTitle>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div className="space-y-2">
            <Label> ()</Label>
            <Input
              value={formData.overrideName}
              onChange={(e) => setFormData({ ...formData, overrideName: e.target.value })}
              className="bg-white/5 border-white/10"
              placeholder="   "
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label>  </Label>
              <Input
                type="number"
                value={formData.attackBonus}
                onChange={(e) => setFormData({ ...formData, attackBonus: parseInt(e.target.value) || 0 })}
                className="bg-white/5 border-white/10"
              />
            </div>
            <div className="space-y-2">
              <Label>  </Label>
              <Input
                type="number"
                value={formData.customDamageBonus}
                onChange={(e) => setFormData({ ...formData, customDamageBonus: parseInt(e.target.value) || 0 })}
                className="bg-white/5 border-white/10"
              />
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label>  (. 1d8)</Label>
              <Input
                value={formData.customDamageDice}
                onChange={(e) => setFormData({ ...formData, customDamageDice: e.target.value })}
                className="bg-white/5 border-white/10"
                placeholder=". 1d8"
              />
            </div>
            <div className="space-y-2">
              <Label></Label>
              <Select
                value={formData.customDamageAbility}
                onValueChange={(val) => setFormData({ ...formData, customDamageAbility: val })}
              >
                <SelectTrigger className="bg-white/5 border-white/10">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {Object.values(Ability).map((a) => (
                    <SelectItem key={a} value={a}>
                      {a}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>

          <div className="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10">
            <div className="space-y-0.5">
              <Label> </Label>
              <div className="text-xs text-slate-400">   </div>
            </div>
            <Switch
              checked={formData.isMagical}
              onCheckedChange={(val) => setFormData({ ...formData, isMagical: val })}
            />
          </div>

          <div className="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10">
            <div className="space-y-0.5">
              <Label></Label>
              <div className="text-xs text-slate-400">    </div>
            </div>
            <Switch
              checked={formData.isProficient}
              onCheckedChange={(val) => setFormData({ ...formData, isProficient: val })}
            />
          </div>

          <div className="flex gap-2 pt-4">
            <Button variant="destructive" className="gap-2" onClick={handleDelete} disabled={isPending}>
              <Trash2 className="w-4 h-4" />
              
            </Button>
            <div className="flex-1" />
            <Button variant="ghost" onClick={() => onOpenChange(false)}>
              
            </Button>
            <Button className="bg-indigo-600 hover:bg-indigo-700" onClick={handleSave} disabled={isPending}>
              
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/lib/components/levelUp/LevelUpHPStep.tsx">
"use client";

import { useEffect, useMemo, useRef, useState } from "react";

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";

import { usePersFormStore } from "@/lib/stores/persFormStore";
import { Ability } from "@prisma/client";
import type { FeatPrisma } from "@/lib/types/model-types";

type Mode = "AVERAGE" | "RANDOM" | "MANUAL";

interface Props {
  hitDie: number; // e.g. 10 for d10
  baseStats: { str: number; dex: number; con: number; int: number; wis: number; cha: number };
  feats: FeatPrisma[];
  formId: string;
  onNextDisabledChange?: (disabled: boolean) => void;
}

const averageHitDie = (hitDie: number) => Math.floor(hitDie / 2) + 1;

const getAbilityMod = (score: number) => Math.floor((score - 10) / 2);

const applyAsiFromStore = (
  base: Props["baseStats"],
  customAsi: unknown
): Props["baseStats"] => {
  const next = { ...base };
  if (!Array.isArray(customAsi)) return next;

  for (const entry of customAsi as Array<{ ability?: string; value?: string }>) {
    const ability = entry?.ability;
    const val = Number(entry?.value);
    if (!ability || !Number.isFinite(val) || val === 0) continue;

    const key = ability.toLowerCase() as keyof Props["baseStats"];
    if (key in next) {
      next[key] = next[key] + val;
    }
  }

  return next;
};

const applyFeatAsi = (
  stats: Props["baseStats"],
  feat?: FeatPrisma | null
): Props["baseStats"] => {
  if (!feat?.grantedASI) return stats;

  const next = { ...stats };
  const featASI = feat.grantedASI as any;
  const simple = featASI?.basic?.simple;
  if (simple && typeof simple === "object") {
    Object.entries(simple).forEach(([ability, bonus]) => {
      const key = ability.toLowerCase() as keyof Props["baseStats"];
      const val = Number(bonus);
      if (key in next && Number.isFinite(val)) {
        next[key] = next[key] + val;
      }
    });
  }

  return next;
};

export default function LevelUpHPStep({
  hitDie,
  baseStats,
  feats,
  formId,
  onNextDisabledChange,
}: Props) {
  const { formData, updateFormData } = usePersFormStore();
  const [mode, setMode] = useState<Mode>("AVERAGE");
  const inputRef = useRef<HTMLInputElement | null>(null);

  const selectedFeat = useMemo(() => {
    const id = formData.featId ? Number(formData.featId) : undefined;
    if (!id) return null;
    return feats.find((f) => f.featId === id) ?? null;
  }, [feats, formData.featId]);

  const effectiveStats = useMemo(() => {
    const withAsi = applyAsiFromStore(baseStats, formData.customAsi);
    return applyFeatAsi(withAsi, selectedFeat);
  }, [baseStats, formData.customAsi, selectedFeat]);

  const conMod = useMemo(() => getAbilityMod(effectiveStats.con), [effectiveStats.con]);
  const avg = useMemo(() => averageHitDie(hitDie), [hitDie]);

  const hpIncrease = useMemo(() => {
    const raw = formData.levelUpHpIncrease;
    if (typeof raw === "number" && Number.isFinite(raw)) return raw;
    return undefined;
  }, [formData.levelUpHpIncrease]);

  useEffect(() => {
    const disabled = typeof hpIncrease !== "number" || !Number.isFinite(hpIncrease) || hpIncrease < 0;
    onNextDisabledChange?.(disabled);
  }, [hpIncrease, onNextDisabledChange]);

  const setHpIncrease = (value: number) => {
    const safe = Number.isFinite(value) ? Math.max(0, Math.floor(value)) : 0;
    updateFormData({ levelUpHpIncrease: safe });
  };

  const applyAverage = () => {
    setMode("AVERAGE");
    setHpIncrease(avg + conMod);
  };

  const applyRandom = () => {
    setMode("RANDOM");
    const roll = Math.floor(Math.random() * hitDie) + 1;
    setHpIncrease(roll + conMod);
  };

  const enableManual = () => {
    setMode("MANUAL");
    queueMicrotask(() => inputRef.current?.focus());
  };

  // If user is in AVERAGE mode, keep value synced when CON changes (ASI/feat from previous step).
  useEffect(() => {
    if (mode !== "AVERAGE") return;
    applyAverage();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [conMod, avg, mode]);

  useEffect(() => {
    // Initialize default once.
    if (typeof hpIncrease === "number") return;
    applyAverage();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  return (
    <form id={formId} className="space-y-4">
      <Card className="glass-card">
        <CardHeader>
          <CardTitle> (HP)</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex flex-wrap items-center gap-2">
            <Badge variant="outline" className="border-white/15 bg-white/5 text-slate-100">
              d{hitDie}
            </Badge>
            <Badge variant="outline" className="border-white/15 bg-white/5 text-slate-100">
              : {avg}
            </Badge>
            <Badge variant="outline" className="border-white/15 bg-white/5 text-slate-100">
              . : {conMod >= 0 ? `+${conMod}` : conMod}
            </Badge>
          </div>

          <div className="space-y-2">
            <label className="text-sm text-slate-300"> HP  </label>
            <Input
              ref={inputRef}
              type="number"
              inputMode="numeric"
              min={0}
              value={typeof hpIncrease === "number" ? hpIncrease : ""}
              onChange={(e) => {
                setMode("MANUAL");
                const val = Number(e.target.value);
                if (!Number.isFinite(val)) {
                  updateFormData({ levelUpHpIncrease: undefined });
                  return;
                }
                setHpIncrease(val);
              }}
              className="border-white/10 bg-white/5 text-white focus-visible:ring-cyan-400/30"
            />
            <p className="text-xs text-slate-400">
                    ASI/.
            </p>
          </div>

          <div className="flex flex-wrap gap-2">
            <Button
              type="button"
              variant="outline"
              className={
                "border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white " +
                (mode === "AVERAGE" ? "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100" : "")
              }
              onClick={applyAverage}
            >
              
            </Button>
            <Button
              type="button"
              variant="outline"
              className={
                "border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white " +
                (mode === "RANDOM" ? "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100" : "")
              }
              onClick={applyRandom}
            >
              
            </Button>
            <Button
              type="button"
              variant="outline"
              className={
                "border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white " +
                (mode === "MANUAL" ? "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100" : "")
              }
              onClick={enableManual}
            >
               
            </Button>
          </div>
        </CardContent>
      </Card>
    </form>
  );
}
</file>

<file path="src/lib/components/levelUp/OptionalFeaturesForm.tsx">
"use client";

import { useEffect, useMemo } from "react";
import clsx from "clsx";

import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";

import { usePersFormStore } from "@/lib/stores/persFormStore";
import { classTranslations, classTranslationsEng } from "@/lib/refs/translation";
import { InfoSectionTitle } from "@/lib/components/characterCreator/EntityInfoDialog";
import { ClassI } from "@/lib/types/model-types";

interface Props {
  selectedClass?: ClassI | null;
  classLevel: number;
  formId: string;
  onNextDisabledChange?: (disabled: boolean) => void;
}

const displayName = (cls?: ClassI | null) =>
  cls ? classTranslations[cls.name] || classTranslationsEng[cls.name] || cls.name : "";

export default function OptionalFeaturesForm({
  selectedClass,
  classLevel,
  formId,
  onNextDisabledChange,
}: Props) {
  const { formData, updateFormData } = usePersFormStore();

  const decisions = (formData.classOptionalFeatureSelections as Record<string, boolean>) || {};

  const selectedChoiceIds = useMemo(() => {
    const selections = (formData.classChoiceSelections as Record<string, number>) || {};
    return Object.values(selections)
      .map((value) => Number(value))
      .filter((value) => !Number.isNaN(value));
  }, [formData.classChoiceSelections]);

  const optionalAtLevel = useMemo(() => {
    return (selectedClass?.classOptionalFeatures || [])
      .filter((item) => (item.grantedOnLevels || []).includes(classLevel))
      .filter((item) => Boolean(item.optionalFeatureId));
  }, [selectedClass, classLevel]);

  const visibleOptional = useMemo(() => {
    return optionalAtLevel
      .filter((item) => {
        const deps = (item as any).appearsOnlyIfChoicesTaken || [];
        if (!deps.length) return true;
        return deps.some((choice: any) => selectedChoiceIds.includes(choice.choiceOptionId));
      })
      .filter((item) => Boolean(item.optionalFeatureId));
  }, [optionalAtLevel, selectedChoiceIds]);

  useEffect(() => {
    if (!selectedClass) {
      onNextDisabledChange?.(true);
      return;
    }
    if (!visibleOptional.length) {
      onNextDisabledChange?.(false);
      return;
    }

    const incomplete = visibleOptional.some(
      (item) => decisions[item.optionalFeatureId?.toString() || ""] === undefined
    );
    onNextDisabledChange?.(incomplete);
  }, [selectedClass, visibleOptional, decisions, onNextDisabledChange]);

  const setDecision = (id: number, take: boolean) => {
    const next = { ...(decisions || {}), [id]: take };
    updateFormData({ classOptionalFeatureSelections: next });
  };

  if (!selectedClass) {
    return (
      <Card className="glass-card p-4 text-center text-slate-200">
          .
      </Card>
    );
  }

  if (!visibleOptional.length) {
    return (
      <Card className="glass-card p-4 text-center text-slate-200">
          {classLevel} {displayName(selectedClass)}   .  .
      </Card>
    );
  }

  return (
    <form id={formId} className="space-y-4">
      <div className="space-y-1 text-center">
        <p className="text-sm font-semibold text-slate-300"> {classLevel}</p>
        <h2 className="font-rpg-display text-3xl font-semibold uppercase tracking-widest text-slate-200 sm:text-4xl">
            
        </h2>
        <p className="text-sm text-slate-400">
                ( ,  )  .
        </p>
      </div>

      <div className="space-y-3">
        {visibleOptional.map((item) => {
          if (!item.optionalFeatureId) return null;

          const key = item.optionalFeatureId.toString();
          const accepted = decisions[key];
          const title = item.title || item.feature?.name || " ";
          const description = item.feature?.description || " .";
          const replaces =
            item.replacesFeatures
              ?.map((rep) => rep.replacedFeature?.name)
              .filter(Boolean)
              .join(", ") || "";

          return (
            <Card
              key={key}
              className={clsx(
                "glass-card",
                accepted === true && "border-gradient-rpg border-gradient-rpg-active glass-active",
                accepted === false && "opacity-90"
              )}
            >
              <CardContent className="space-y-3 p-4">
                <div className="flex flex-wrap items-center justify-between gap-2">
                  <div>
                    <p className="text-sm font-semibold text-white">{title}</p>
                    {replaces ? (
                      <p className="text-xs text-slate-400">: {replaces}</p>
                    ) : null}
                  </div>
                  <Badge variant="outline" className="border-white/15 bg-white/5 text-slate-200">
                     {classLevel}
                  </Badge>
                </div>

                <div className="glass-panel border-gradient-rpg space-y-1.5 rounded-lg p-3">
                  <InfoSectionTitle></InfoSectionTitle>
                  <p className="whitespace-pre-line text-sm leading-relaxed text-slate-200/90">
                    {description}
                  </p>
                </div>

                <div className="flex flex-wrap gap-2">
                  <Button
                    type="button"
                    size="sm"
                    variant="outline"
                    className={clsx(
                      "border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white",
                      accepted === true &&
                        "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100"
                    )}
                    onClick={() => setDecision(item.optionalFeatureId!, true)}
                  >
                     
                  </Button>
                  <Button
                    type="button"
                    size="sm"
                    variant="outline"
                    className={clsx(
                      "border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white",
                      accepted === false && "border-rose-400/40 bg-rose-500/10 text-rose-50"
                    )}
                    onClick={() => setDecision(item.optionalFeatureId!, false)}
                  >
                      
                  </Button>
                </div>
              </CardContent>
            </Card>
          );
        })}
      </div>
    </form>
  );
}
</file>

<file path="src/lib/components/test/Task.tsx">
export const Task = (
  { name, description, index, onPopTask }
    : { description: string, name: string, index: number, onPopTask: (i: number) => void }) => {
  return (
    <div className="border-2 border-red-500 hover:cursor-pointer" onClick={() => {onPopTask(index)}}>
      <span className="text-blue300">{name}</span>
      <p>{description}</p>
    </div>
  )
}

export default Task
</file>

<file path="src/lib/components/test/TaskCreator.tsx">
"use client";

import { useState } from "react";
import { TaskType } from "@/lib/components/test/Tasks";

export const TaskCreator = ({ onAddTask }: { onAddTask: ({ name, description }: TaskType ) => void}) => {
  const [taskName, setTaskName] = useState('')
  const [taskDescription, setTaskDescription] = useState('')

  return (
    <>
      <input placeholder="Name" onChange={(e) => {setTaskName(e.target.value)}} />
      <input placeholder="Description" onChange={(e) => {setTaskDescription(e.target.value)}} />

      <button onClick={() => {
        onAddTask({ name: taskName, description: taskDescription } )
      }}>Create Task</button>


    </>
  )
};
</file>

<file path="src/lib/components/test/Tasks.tsx">
"use client";

import { TaskCreator } from "@/lib/components/test/TaskCreator";
import { useState } from "react";
import Task from "./Task";

export type TaskType = {
  name: string,
  description: string,
}

export const Tasks = () => {
  const [tasks, setTasks] = useState<TaskType[]>([]);

  const handleAddTask = ({ name, description }: TaskType ) => {
    setTasks(prevTasks => [...prevTasks, { name, description }]);
  }
  const popTask = (i: number) => {
    setTasks(prevTasks => prevTasks.filter((p, index) => i != index ))
  }

  return (
    <>
      <TaskCreator onAddTask={handleAddTask} />

      {tasks.map((task, i)  => (
          <Task
            name={task.name}
            description={task.description}
            index={i}
            key={i}
            onPopTask={popTask}
          />
        )
      )}
    </>
  )
}

export default Tasks
</file>

<file path="src/lib/logic/bonus-calculator.ts">
/**
 * Bonus calculation helpers
 * All functions handle null/undefined JSON fields gracefully
 */

import { Ability, Skills, SkillProficiencyType, ArmorType } from "@prisma/client";
import { PersWithRelations } from "@/lib/actions/pers";
import { getAbilityMod, getProficiencyBonus, skillAbilityMap } from "./utils";
import { StatBonuses, SkillBonuses, SimpleBonusValue } from "@/lib/types/model-types";

// ============================================================================
// JSON Parsers (handle null/undefined/invalid JSON)
// ============================================================================

function parseStatBonuses(json: unknown): StatBonuses {
  if (!json || typeof json !== "object") return {};
  return json as StatBonuses;
}

function parseSkillBonuses(json: unknown): SkillBonuses {
  if (!json || typeof json !== "object") return {};
  return json as SkillBonuses;
}

function parseSimpleBonus(json: unknown): number {
  if (!json || typeof json !== "object") return 0;
  const obj = json as SimpleBonusValue;
  return typeof obj.value === "number" ? obj.value : 0;
}

// ============================================================================
// Individual Bonus Getters
// ============================================================================

/** Get stat bonus for an ability (e.g., +2 to STR base value) */
export function getStatBonus(pers: PersWithRelations, ability: Ability): number {
  const bonuses = parseStatBonuses((pers as unknown as { statBonuses?: unknown }).statBonuses);
  return bonuses[ability] ?? 0;
}

/** Get modifier bonus for an ability (adds directly to modifier, not stat) */
export function getModifierBonus(pers: PersWithRelations, ability: Ability): number {
  const bonuses = parseStatBonuses((pers as unknown as { statModifierBonuses?: unknown }).statModifierBonuses);
  return bonuses[ability] ?? 0;
}

/** Get save bonus for an ability */
export function getSaveBonus(pers: PersWithRelations, ability: Ability): number {
  const bonuses = parseStatBonuses((pers as unknown as { saveBonuses?: unknown }).saveBonuses);
  return bonuses[ability] ?? 0;
}

/** Get skill bonus */
export function getSkillBonus(pers: PersWithRelations, skill: Skills): number {
  const bonuses = parseSkillBonuses((pers as unknown as { skillBonuses?: unknown }).skillBonuses);
  return bonuses[skill] ?? 0;
}

/** Get simple bonus (HP, AC, speed, etc.) */
export function getSimpleBonus(pers: PersWithRelations, field: 'hp' | 'ac' | 'speed' | 'proficiency' | 'initiative' | 'spellAttack' | 'spellDC'): number {
  const fieldMap: Record<string, string> = {
    hp: 'hpBonuses',
    ac: 'acBonuses',
    speed: 'speedBonuses',
    proficiency: 'proficiencyBonuses',
    initiative: 'initiativeBonuses',
    spellAttack: 'spellAttackBonuses',
    spellDC: 'spellDCBonuses',
  };
  const jsonField = fieldMap[field];
  const json = (pers as unknown as Record<string, unknown>)[jsonField];
  return parseSimpleBonus(json);
}

// ============================================================================
// Final Value Calculators
// ============================================================================

/** Get base stat value for an ability */
function getBaseStat(pers: PersWithRelations, ability: Ability): number {
  const statMap: Record<Ability, number> = {
    STR: pers.str,
    DEX: pers.dex,
    CON: pers.con,
    INT: pers.int,
    WIS: pers.wis,
    CHA: pers.cha,
  };
  return statMap[ability];
}

/** Calculate final stat value (base + statBonuses) */
export function calculateFinalStat(pers: PersWithRelations, ability: Ability): number {
  return getBaseStat(pers, ability) + getStatBonus(pers, ability);
}

/** Calculate final modifier (from modified stat + modifierBonuses) */
export function calculateFinalModifier(pers: PersWithRelations, ability: Ability): number {
  const finalStat = calculateFinalStat(pers, ability);
  const baseMod = getAbilityMod(finalStat);
  return baseMod + getModifierBonus(pers, ability);
}

/** Calculate final save (modifier + proficiency if proficient + saveBonuses) */
export function calculateFinalSave(
  pers: PersWithRelations,
  ability: Ability,
  classSavingThrows: Ability[] // Renamed parameter to avoid conflict with local variable
): number {
  const mod = calculateFinalModifier(pers, ability);
  const additionalSaves = (pers as any).additionalSaveProficiencies as Ability[] ?? [];
  const isProficient = classSavingThrows.includes(ability) || additionalSaves.includes(ability);
  const pb = isProficient ? calculateFinalProficiency(pers) : 0;
  const saveBonus = getSaveBonus(pers, ability);
  
  // Also add misc save bonuses from existing field
  const miscBonuses = (pers as unknown as { miscSaveBonuses?: Record<string, number> }).miscSaveBonuses ?? {};
  const miscBonus = miscBonuses[ability] ?? 0;
  
  return mod + pb + saveBonus + miscBonus;
}

/** Calculate final skill modifier */
export function calculateFinalSkill(
  pers: PersWithRelations,
  skill: Skills
): { total: number; proficiency: SkillProficiencyType | "NONE" } {
  // Get ability for this skill
  const abilityKey = skillAbilityMap[skill];
  const ability = abilityKey?.toUpperCase() as Ability;
  
  // Get ability score
  const abilityScore = ability ? getBaseStat(pers, ability) + getStatBonus(pers, ability) : 10;
  const abilityMod = getAbilityMod(abilityScore);
  const modBonus = ability ? getModifierBonus(pers, ability) : 0;
  
  // Get proficiency
  const persSkill = pers.skills.find((ps) => ps.name === skill);
  const proficiency = persSkill?.proficiencyType ?? "NONE";
  
  const pb = calculateFinalProficiency(pers);
  let total = abilityMod + modBonus;
  
  if (proficiency === SkillProficiencyType.PROFICIENT) total += pb;
  if (proficiency === SkillProficiencyType.EXPERTISE) total += pb * 2;
  
  // Add skill bonus
  total += getSkillBonus(pers, skill);
  
  return { total, proficiency };
}

/** Calculate final proficiency bonus */
export function calculateFinalProficiency(pers: PersWithRelations): number {
  return getProficiencyBonus(pers.level) + getSimpleBonus(pers, "proficiency");
}

/** Calculate final AC */
export function calculateFinalAC(pers: PersWithRelations): number {
  const dexMod = calculateFinalModifier(pers, Ability.DEX);
  
  // 1. Find equipped armor
  const equippedArmor = pers.armors.find(a => a.equipped);
  
  let baseAC = 10 + dexMod; // default unarmored
  
  if (equippedArmor) {
    const armorBase = equippedArmor.overrideBaseAC ?? equippedArmor.armor.baseAC;
    const armorType = equippedArmor.armor.armorType;
    
    let dexBonus = dexMod;
    if (armorType === ArmorType.MEDIUM) {
      dexBonus = Math.min(dexMod, 2);
    } else if (armorType === ArmorType.HEAVY) {
      dexBonus = 0;
    }
    
    baseAC = armorBase + dexBonus + (equippedArmor.miscACBonus ?? 0);
  }
  
  // 2. Add shield
  if (pers.wearsShield) {
    baseAC += 2 + pers.additionalShieldBonus;
  }
  
  // 3. Add custom AC bonuses from simple bonus system
  return baseAC + getSimpleBonus(pers, "ac");
}

/** Calculate final speed (base 30 + bonuses) */
export function calculateFinalSpeed(pers: PersWithRelations): number {
  // TODO: Get from race when race has speed field
  return 30 + getSimpleBonus(pers, "speed");
}

/** Calculate final initiative */
export function calculateFinalInitiative(pers: PersWithRelations): number {
  const dexMod = calculateFinalModifier(pers, Ability.DEX);
  return dexMod + getSimpleBonus(pers, "initiative");
}

/** Calculate final max HP */
export function calculateFinalMaxHP(pers: PersWithRelations): number {
  return pers.maxHp + getSimpleBonus(pers, "hp");
}

/** Calculate spell attack bonus */
export function calculateSpellAttack(pers: PersWithRelations, spellcastingAbility: Ability): number {
  const mod = calculateFinalModifier(pers, spellcastingAbility);
  const pb = calculateFinalProficiency(pers);
  return mod + pb + getSimpleBonus(pers, "spellAttack");
}

/** Calculate spell save DC */
export function calculateSpellDC(pers: PersWithRelations, spellcastingAbility: Ability): number {
  const mod = calculateFinalModifier(pers, spellcastingAbility);
  const pb = calculateFinalProficiency(pers);
  return 8 + mod + pb + getSimpleBonus(pers, "spellDC");
}

// ============================================================================
// Helpers for UI
// ============================================================================

/** Check if any bonus is active for a stat */
export function hasStatBonuses(pers: PersWithRelations, ability: Ability): boolean {
  return getStatBonus(pers, ability) !== 0 ||
         getModifierBonus(pers, ability) !== 0 ||
         getSaveBonus(pers, ability) !== 0;
}

/** Check if skill has bonus */
export function hasSkillBonus(pers: PersWithRelations, skill: Skills): boolean {
  return getSkillBonus(pers, skill) !== 0;
}

/** Check if simple bonus is active */
export function hasSimpleBonus(pers: PersWithRelations, field: 'hp' | 'ac' | 'speed' | 'proficiency' | 'initiative' | 'spellAttack' | 'spellDC'): boolean {
  return getSimpleBonus(pers, field) !== 0;
}
</file>

<file path="src/lib/logic/multiclass-resolver.ts">
import { prisma } from '@/lib/prisma';

export interface ClassLevelInfo {
  classId: number;
  className: string;
  classLevel: number;
  hitDie: number;
}

export interface MulticlassCharacter {
  persId: number;
  totalLevel: number;
  classes: ClassLevelInfo[];
}

export async function getMulticlassInfo(persId: number): Promise<MulticlassCharacter> {
  const pers = await prisma.pers.findUnique({
    where: { persId },
    include: {
      class: true, // Primary class
      //    '  PersClass  
      // persClasses: { include: { class: true } } 
    },
  });

  if (!pers) throw new Error('Character not found');

  //      ,     
  //    PersClass,    '
  
  const classes: ClassLevelInfo[] = [
      {
          classId: pers.classId,
          className: pers.class.name,
          classLevel: pers.level,
          hitDie: 10, // TODO: Get from constant or DB
      }
  ];

  // Mock logic for multiclass if PersClass existed
  // const extraClasses = await prisma.persClass.findMany(...)
  // classes.push(...)

  return {
    persId,
    totalLevel: pers.level,
    classes,
  };
}
</file>

<file path="src/lib/logic/progression-resolver.ts">
import { prisma } from '@/lib/prisma';
import { FeatureMechanic } from '@prisma/client';
import { LevelUpStep, Stats } from '@/types/character-flow';

//   
const CLASS_NAMES_UK: Record<string, string> = {
  BARBARIAN: '',
  BARD: '',
  CLERIC: '',
  DRUID: '',
  FIGHTER: '',
  MONK: '',
  PALADIN: '',
  RANGER: '',
  ROGUE: '',
  SORCERER: '',
  WARLOCK: '',
  WIZARD: '',
  ARTIFICER: '',
};

const CLASS_HIT_DICE: Record<string, number> = {
  BARBARIAN: 12,
  BARD: 8,
  CLERIC: 8,
  DRUID: 8,
  FIGHTER: 10,
  MONK: 8,
  PALADIN: 10,
  RANGER: 10,
  ROGUE: 8,
  SORCERER: 6,
  WARLOCK: 8,
  WIZARD: 6,
  ARTIFICER: 8,
};

export class ProgressionResolver {
  static async resolveLevelUpSteps(
    persId: number,
    classId: number,
    newLevel: number,
    className: string,
    currentStats: Stats
  ) {
    const steps: LevelUpStep[] = [];

    // 1.       
    const features = await prisma.classFeature.findMany({
      where: {
        classId,
        levelGranted: newLevel,
      },
      include: {
        feature: true,
      },
      orderBy: {
        displayOrder: 'asc',
      },
    });

    console.log(` Found ${features.length} features for ${className} Level ${newLevel}`);

    // 2.       
    for (const f of features) {
      switch (f.mechanicType) {
        case FeatureMechanic.CHOICE_SUBCLASS:
          steps.push(await this.createSubclassStep(classId, className, newLevel));
          break;

        case FeatureMechanic.CHOICE_ASI:
          steps.push(this.createASIStep(currentStats));
          break;

        case FeatureMechanic.CHOICE_SPELLS:
           //      ,    
           // : const count = f.mechanicMetadata?.count || 2;
           // steps.push(this.createSpellStep(className, newLevel, count));
           break;

        case FeatureMechanic.CHOICE_SPECIFIC:
          if (f.mechanicMetadata) {
             const meta = f.mechanicMetadata as any;
             if (meta.options_source === 'fighting_styles') {
                steps.push(await this.createFightingStyleStep());
             }
          }
          break;
          
        case FeatureMechanic.PASSIVE:
        default:
          //      ,    
          // steps.push({ type: 'INFO', feature: f.feature });
          break;
      }
    }

    // 3.    HP (    1,   1    )
    if (newLevel > 1) {
      steps.push({
        type: 'ADD_HP',
        hitDie: CLASS_HIT_DICE[className] || 8,
        method: 'roll', // Default
      });
    }

    return steps;
  }

  private static async createSubclassStep(classId: number, className: string, level: number) {
    //   
    const subclasses = await prisma.subclass.findMany({
      where: { classId },
    });

    return {
      type: 'SELECT_SUBCLASS' as const,
      classId,
      className: CLASS_NAMES_UK[className] || className,
      classNameEng: className,
      level,
      options: subclasses.map(s => ({
        id: s.subclassId,
        name: s.name.toString(),
        description: s.description || '',
      })),
      isRequired: true,
    };
  }

  private static createASIStep(currentStats: Stats) {
    return {
      type: 'SELECT_FEAT_OR_ASI' as const,
      currentStats,
      // Feats       ,    
      feats: [], 
    };
  }

  private static async createFightingStyleStep() {
      const styles = await prisma.fightingStyle.findMany();
      return {
          type: 'CHOOSE_OPTIONAL_FEATURE' as const,
          featureId: 'fighting_style',
          title: ' ',
          description: '   ,      .',
          options: styles.map(s => ({
              id: s.id,
              name: s.name,
              description: s.description
          })),
          count: 1
      };
  }
}
</file>

<file path="src/lib/logic/utils.ts">
export function getAbilityMod(score: number): number {
  return Math.floor((score - 10) / 2);
}

export function getProficiencyBonus(level: number): number {
  return Math.ceil(level / 4) + 1;
}

export function formatModifier(mod: number): string {
  return mod >= 0 ? `+${mod}` : `${mod}`;
}

export const skillAbilityMap: Record<string, string> = {
  ATHLETICS: "str",
  ACROBATICS: "dex",
  SLEIGHT_OF_HAND: "dex",
  STEALTH: "dex",
  ARCANA: "int",
  HISTORY: "int",
  INVESTIGATION: "int",
  NATURE: "int",
  RELIGION: "int",
  ANIMAL_HANDLING: "wis",
  INSIGHT: "wis",
  MEDICINE: "wis",
  PERCEPTION: "wis",
  SURVIVAL: "wis",
  DECEPTION: "cha",
  INTIMIDATION: "cha",
  PERFORMANCE: "cha",
  PERSUASION: "cha",
};
</file>

<file path="src/lib/refs/classesBaseASI.ts">
import {Ability, Classes} from "@prisma/client";

export const classAbilityScores: Record<Classes, Array<{ability: Ability, value: number}>> = {
  [Classes.ARTIFICER_2014]: [
    { ability: Ability.STR, value: 8 },
    { ability: Ability.DEX, value: 13 },
    { ability: Ability.CON, value: 14 },
    { ability: Ability.INT, value: 15 },
    { ability: Ability.WIS, value: 12 },
    { ability: Ability.CHA, value: 10 }
  ],
  [Classes.BARBARIAN_2014]: [
    { ability: Ability.STR, value: 15 },
    { ability: Ability.DEX, value: 13 },
    { ability: Ability.CON, value: 14 },
    { ability: Ability.INT, value: 8 },
    { ability: Ability.WIS, value: 12 },
    { ability: Ability.CHA, value: 10 }
  ],
  [Classes.BARD_2014]: [
    { ability: Ability.STR, value: 8 },
    { ability: Ability.DEX, value: 14 },
    { ability: Ability.CON, value: 13 },
    { ability: Ability.INT, value: 10 },
    { ability: Ability.WIS, value: 12 },
    { ability: Ability.CHA, value: 15 }
  ],
  [Classes.CLERIC_2014]: [
    { ability: Ability.STR, value: 13 },
    { ability: Ability.DEX, value: 12 },
    { ability: Ability.CON, value: 14 },
    { ability: Ability.INT, value: 8 },
    { ability: Ability.WIS, value: 15 },
    { ability: Ability.CHA, value: 10 }
  ],
  [Classes.DRUID_2014]: [
    { ability: Ability.STR, value: 8 },
    { ability: Ability.DEX, value: 13 },
    { ability: Ability.CON, value: 14 },
    { ability: Ability.INT, value: 12 },
    { ability: Ability.WIS, value: 15 },
    { ability: Ability.CHA, value: 10 }
  ],
  [Classes.FIGHTER_2014]: [
    { ability: Ability.STR, value: 15 },
    { ability: Ability.DEX, value: 13 },
    { ability: Ability.CON, value: 14 },
    { ability: Ability.INT, value: 8 },
    { ability: Ability.WIS, value: 12 },
    { ability: Ability.CHA, value: 10 }
  ],
  [Classes.MONK_2014]: [
    { ability: Ability.STR, value: 12 },
    { ability: Ability.DEX, value: 15 },
    { ability: Ability.CON, value: 13 },
    { ability: Ability.INT, value: 8 },
    { ability: Ability.WIS, value: 14 },
    { ability: Ability.CHA, value: 10 }
  ],
  [Classes.PALADIN_2014]: [
    { ability: Ability.STR, value: 15 },
    { ability: Ability.DEX, value: 12 },
    { ability: Ability.CON, value: 13 },
    { ability: Ability.INT, value: 8 },
    { ability: Ability.WIS, value: 10 },
    { ability: Ability.CHA, value: 14 }
  ],
  [Classes.RANGER_2014]: [
    { ability: Ability.STR, value: 12 },
    { ability: Ability.DEX, value: 15 },
    { ability: Ability.CON, value: 13 },
    { ability: Ability.INT, value: 8 },
    { ability: Ability.WIS, value: 14 },
    { ability: Ability.CHA, value: 10 }
  ],
  [Classes.ROGUE_2014]: [
    { ability: Ability.STR, value: 8 },
    { ability: Ability.DEX, value: 15 },
    { ability: Ability.CON, value: 14 },
    { ability: Ability.INT, value: 12 },
    { ability: Ability.WIS, value: 10 },
    { ability: Ability.CHA, value: 13 }
  ],
  [Classes.SORCERER_2014]: [
    { ability: Ability.STR, value: 8 },
    { ability: Ability.DEX, value: 13 },
    { ability: Ability.CON, value: 14 },
    { ability: Ability.INT, value: 12 },
    { ability: Ability.WIS, value: 10 },
    { ability: Ability.CHA, value: 15 }
  ],
  [Classes.WARLOCK_2014]: [
    { ability: Ability.STR, value: 8 },
    { ability: Ability.DEX, value: 13 },
    { ability: Ability.CON, value: 14 },
    { ability: Ability.INT, value: 12 },
    { ability: Ability.WIS, value: 10 },
    { ability: Ability.CHA, value: 15 }
  ],
  [Classes.WIZARD_2014]: [
    { ability: Ability.STR, value: 8 },
    { ability: Ability.DEX, value: 13 },
    { ability: Ability.CON, value: 14 },
    { ability: Ability.INT, value: 15 },
    { ability: Ability.WIS, value: 12 },
    { ability: Ability.CHA, value: 10 }
  ]
};
</file>

<file path="src/lib/refs/fantasyNames.ts">
const SEED_NAMES = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

function mulberry32(seed: number) {
  let a = seed >>> 0;
  return function next() {
    a |= 0;
    a = (a + 0x6d2b79f5) | 0;
    let t = Math.imul(a ^ (a >>> 15), 1 | a);
    t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) ^ t;
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

function capFirst(value: string) {
  if (!value) return value;
  return value[0].toUpperCase() + value.slice(1);
}

function squeeze(value: string) {
  // Light de-dup for accidental double separators.
  return value
    .replace(/--+/g, "-")
    .replace(/\s+/g, " ")
    .trim();
}

function pick<T>(rng: () => number, list: readonly T[]): T {
  return list[Math.floor(rng() * list.length)];
}

const UA_TRAD = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const UA_ROOTS = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const UA_PREFIX = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const UA_SUFFIX = [
  "",
  "",
  "",
  "",
  "",
  "",
  "()",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const UA_SUFFIX_CLEAN = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const ELF_PRE = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const ELF_MID = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const ELF_SUF = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const DWARF_PRE = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const DWARF_SUF = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const ORC_PRE = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const ORC_SUF = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const TIEF_WORDS = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const TIEF_PRE = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const TIEF_SUF = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const GNOME_PRE = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const GNOME_SUF = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const HALFLING_PRE = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const HALFLING_SUF = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const EXOTIC_PRE = [
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

const EXOTIC_SUF = [
  "-",
  "",
  "",
  "",
  "",
  "",
  "",
] as const;

function buildUkrFantasy(rng: () => number) {
  const prefix = pick(rng, UA_PREFIX);
  const suffix = pick(rng, UA_SUFFIX_CLEAN);

  // Two simple patterns for variety.
  if (rng() < 0.5) {
    return squeeze(`${prefix}${capFirst(suffix)}`);
  }
  const root = pick(rng, UA_ROOTS);
  return squeeze(`${prefix}${capFirst(root)}${capFirst(suffix)}`);
}

function buildElf(rng: () => number) {
  const pre = pick(rng, ELF_PRE);
  const mid = pick(rng, ELF_MID);
  const suf = pick(rng, ELF_SUF);
  return squeeze(`${pre}${mid}${suf}`);
}

function buildDwarf(rng: () => number) {
  const pre = pick(rng, DWARF_PRE);
  const suf = pick(rng, DWARF_SUF);
  const maybeTitle = rng() < 0.15 ? `-${pick(rng, ["", "", "", ""] as const)}` : "";
  return squeeze(`${pre}${suf}${maybeTitle}`);
}

function buildOrc(rng: () => number) {
  const pre = pick(rng, ORC_PRE);
  const suf = pick(rng, ORC_SUF);
  return squeeze(`${pre}${suf}`);
}

function buildTiefling(rng: () => number) {
  if (rng() < 0.35) return pick(rng, TIEF_WORDS);
  const pre = pick(rng, TIEF_PRE);
  const suf = pick(rng, TIEF_SUF);
  return squeeze(`${pre}${suf}`);
}

function buildGnome(rng: () => number) {
  const pre = pick(rng, GNOME_PRE);
  const suf = pick(rng, GNOME_SUF);
  return squeeze(`${pre}${suf}`);
}

function buildHalfling(rng: () => number) {
  const pre = pick(rng, HALFLING_PRE);
  const suf = pick(rng, HALFLING_SUF);
  const cozy = rng() < 0.2 ? pick(rng, ["", "", "", "", ""] as const) : "";
  return cozy ? cozy : squeeze(`${pre}${suf}`);
}

function buildExotic(rng: () => number) {
  const pre = pick(rng, EXOTIC_PRE);
  const suf = pick(rng, EXOTIC_SUF);
  return squeeze(`${pre}${suf}`);
}

function buildHuman(rng: () => number) {
  if (rng() < 0.35) return pick(rng, UA_TRAD);
  // Adapted classic fantasy-ish.
  const pre = pick(rng, ["", "", "", "", "", "", "", "", "", ""] as const);
  const mid = pick(rng, ["", "", "", "", "", "", "", "", "", ""] as const);
  const suf = pick(rng, ["", "", "", "", "", "", "", "", ""] as const);
  return squeeze(`${pre}${mid}${suf}`);
}

function generateFantasyNames(targetCount: number) {
  const rng = mulberry32(0xC0FFEE);
  const out = new Set<string>(SEED_NAMES);

  const builders = [
    buildHuman,
    buildElf,
    buildDwarf,
    buildOrc,
    buildTiefling,
    buildGnome,
    buildHalfling,
    buildExotic,
    buildUkrFantasy,
  ] as const;

  // Ensure at least some purely-UA compound names.
  for (let i = 0; i < 200 && out.size < targetCount; i++) {
    out.add(buildUkrFantasy(rng));
  }

  while (out.size < targetCount) {
    const builder = pick(rng, builders);
    const name = builder(rng);

    // Filter super short / weird cases.
    if (name.length < 3) continue;
    if (name.length > 24) continue;

    out.add(name);
  }

  return Array.from(out);
}

export const FANTASY_NAMES = generateFantasyNames(3000) as readonly string[];
</file>

<file path="src/lib/refs/static.ts">
//  seed.ts   
import { Classes } from "@prisma/client"

export const SPELL_SLOT_PROGRESSION = {
    // Full casters (Wizard, Sorcerer, Cleric, Druid, Bard)
    FULL: {
        1: [2, 0, 0, 0, 0, 0, 0, 0, 0],
        2: [3, 0, 0, 0, 0, 0, 0, 0, 0],
        3: [4, 2, 0, 0, 0, 0, 0, 0, 0],
        4: [4, 3, 0, 0, 0, 0, 0, 0, 0],
        5: [4, 3, 2, 0, 0, 0, 0, 0, 0],
        6: [4, 3, 3, 0, 0, 0, 0, 0, 0],
        7: [4, 3, 3, 1, 0, 0, 0, 0, 0],
        8: [4, 3, 3, 2, 0, 0, 0, 0, 0],
        9: [4, 3, 3, 3, 1, 0, 0, 0, 0],
        10: [4, 3, 3, 3, 2, 0, 0, 0, 0],
        11: [4, 3, 3, 3, 2, 1, 0, 0, 0],
        12: [4, 3, 3, 3, 2, 1, 0, 0, 0],
        13: [4, 3, 3, 3, 2, 1, 1, 0, 0],
        14: [4, 3, 3, 3, 2, 1, 1, 0, 0],
        15: [4, 3, 3, 3, 2, 1, 1, 1, 0],
        16: [4, 3, 3, 3, 2, 1, 1, 1, 0],
        17: [4, 3, 3, 3, 2, 1, 1, 1, 1],
        18: [4, 3, 3, 3, 3, 1, 1, 1, 1],
        19: [4, 3, 3, 3, 3, 2, 1, 1, 1],
        20: [4, 3, 3, 3, 3, 2, 2, 1, 1]
    },

    // Half casters (Paladin, Ranger)
    HALF: {
        1: [0, 0, 0, 0, 0, 0, 0, 0, 0],
        2: [2, 0, 0, 0, 0, 0, 0, 0, 0],
        3: [3, 0, 0, 0, 0, 0, 0, 0, 0],
        4: [3, 0, 0, 0, 0, 0, 0, 0, 0],
        5: [4, 2, 0, 0, 0, 0, 0, 0, 0],
        6: [4, 2, 0, 0, 0, 0, 0, 0, 0],
        7: [4, 3, 0, 0, 0, 0, 0, 0, 0],
        8: [4, 3, 0, 0, 0, 0, 0, 0, 0],
        9: [4, 3, 2, 0, 0, 0, 0, 0, 0],
        10: [4, 3, 2, 0, 0, 0, 0, 0, 0],
        11: [4, 3, 3, 0, 0, 0, 0, 0, 0],
        12: [4, 3, 3, 0, 0, 0, 0, 0, 0],
        13: [4, 3, 3, 1, 0, 0, 0, 0, 0],
        14: [4, 3, 3, 1, 0, 0, 0, 0, 0],
        15: [4, 3, 3, 2, 0, 0, 0, 0, 0],
        16: [4, 3, 3, 2, 0, 0, 0, 0, 0],
        17: [4, 3, 3, 3, 1, 0, 0, 0, 0],
        18: [4, 3, 3, 3, 1, 0, 0, 0, 0],
        19: [4, 3, 3, 3, 2, 0, 0, 0, 0],
        20: [4, 3, 3, 3, 2, 0, 0, 0, 0]
    },

    // Third casters (Eldritch Knight, Arcane Trickster)
    THIRD: {
        1: [0, 0, 0, 0, 0, 0, 0, 0, 0],
        2: [0, 0, 0, 0, 0, 0, 0, 0, 0],
        3: [2, 0, 0, 0, 0, 0, 0, 0, 0],
        4: [3, 0, 0, 0, 0, 0, 0, 0, 0],
        5: [3, 0, 0, 0, 0, 0, 0, 0, 0],
        6: [3, 0, 0, 0, 0, 0, 0, 0, 0],
        7: [4, 2, 0, 0, 0, 0, 0, 0, 0],
        8: [4, 2, 0, 0, 0, 0, 0, 0, 0],
        9: [4, 2, 0, 0, 0, 0, 0, 0, 0],
        10: [4, 3, 0, 0, 0, 0, 0, 0, 0],
        11: [4, 3, 0, 0, 0, 0, 0, 0, 0],
        12: [4, 3, 0, 0, 0, 0, 0, 0, 0],
        13: [4, 3, 2, 0, 0, 0, 0, 0, 0],
        14: [4, 3, 2, 0, 0, 0, 0, 0, 0],
        15: [4, 3, 2, 0, 0, 0, 0, 0, 0],
        16: [4, 3, 3, 0, 0, 0, 0, 0, 0],
        17: [4, 3, 3, 0, 0, 0, 0, 0, 0],
        18: [4, 3, 3, 0, 0, 0, 0, 0, 0],
        19: [4, 3, 3, 1, 0, 0, 0, 0, 0],
        20: [4, 3, 3, 1, 0, 0, 0, 0, 0]
    },

    // Warlock pact slots (!)
    PACT: {
        1: { slots: 1, level: 1 },
        2: { slots: 2, level: 1 },
        3: { slots: 2, level: 2 },
        4: { slots: 2, level: 2 },
        5: { slots: 2, level: 3 },
        6: { slots: 2, level: 3 },
        7: { slots: 2, level: 4 },
        8: { slots: 2, level: 4 },
        9: { slots: 2, level: 5 },
        10: { slots: 2, level: 5 },
        11: { slots: 3, level: 5 },
        12: { slots: 3, level: 5 },
        13: { slots: 3, level: 5 },
        14: { slots: 3, level: 5 },
        15: { slots: 3, level: 5 },
        16: { slots: 3, level: 5 },
        17: { slots: 4, level: 5 },
        18: { slots: 4, level: 5 },
        19: { slots: 4, level: 5 },
        20: { slots: 4, level: 5 }
    }
}

export const MONK_PROGRESSION_TABLE = {
    martialArtsDie: [
        { levels: [1, 2, 3, 4], die: '4' },
        { levels: [5, 6, 7, 8, 9, 10], die: '6' },
        { levels: [11, 12, 13, 14, 15, 16], die: '8' },
        { levels: [17, 18, 19, 20], die: '10' },
    ],
    unarmoredMovement: [
        { levels: [2, 3, 4, 5], bonus: 10 },
        { levels: [6, 7, 8, 9], bonus: 15 },
        { levels: [10, 11, 12, 13], bonus: 20 },
        { levels: [14, 15, 16, 17], bonus: 25 },
        { levels: [18, 19, 20], bonus: 30 },
    ],
};

export const sneakAttackDice = {
    1: "16",
    3: "26",
    5: "36",
    7: "46",
    9: "56",
    11: "66",
    13: "76",
    15: "86",
    17: "96",
    19: "106"
}

export const CHOICE_RULES = [
    {
        class: Classes.WARLOCK_2014,
        featureName: 'ELDRITCH_INVOCATIONS',
        choices: [
            { level: 2, count: 2 },
            { level: 5, count: 1 },
            { level: 7, count: 1 },
            { level: 9, count: 1 },
            { level: 12, count: 1 },
            { level: 15, count: 1 },
            { level: 18, count: 1 },
        ]
    },
    {
        class: Classes.FIGHTER_2014,
        featureName: 'FIGHTING_STYLE',
        choices: [
            { level: 1, count: 1 },
            { level: 10, count: 1 }, // Additional Fighting Style feature
        ]
    },
] as const
</file>

<file path="src/lib/server/formatters/generalFormatters.ts">
export const groupBy = <
  V, K extends string | symbol | number
>(items: V[], keyFn: (item: V) => K): Record<K, V[]> =>
  items.reduce((acc, cur) => {
    const key = keyFn(cur);
    (acc[key] ??= []).push(cur);
    return acc;
  }, {} as Record<K, V[]>)
</file>

<file path="src/lib/server/formatters/weaponFormatter.ts">
import {Weapon, WeaponType} from "@prisma/client";

type WeaponByType = Record<WeaponType, Weapon[]>

export const getWeaponsByType = (weapons: Weapon[]): WeaponByType => {
  return weapons.reduce((acc, weapon) => {
    (acc[weapon.weaponType] ??= []).push(weapon)
    return acc;
  }, {} as WeaponByType);
}
</file>

<file path="src/lib/types/prisma-json.d.ts">
import * as CharacterTypes from './character-types';

declare global {
  namespace PrismaJson {
    type SkillProficiencies = CharacterTypes.SkillProficiencies;
    type RaceASI = CharacterTypes.RaceASI;
    type WeaponProficiencies = CharacterTypes.WeaponProficiencies;
    type ToolProficiencies = CharacterTypes.ToolProficiencies;
    type MulticlassReqs = CharacterTypes.MulticlassReqs;
    type WeaponProficienciesSpecial = CharacterTypes.WeaponProficienciesSpecial;
  }
}

export {};
</file>

<file path="src/lib/utils.ts">
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
</file>

<file path="src/server/pdf/generateCharacterPdf.ts">
import { auth } from "@/lib/auth";
import { getCharacterFeaturesGrouped, getPersById } from "@/lib/actions/pers";
import {
  calculateFinalAC,
  calculateFinalInitiative,
  calculateFinalModifier,
  calculateFinalProficiency,
  calculateFinalSave,
  calculateFinalSkill,
  calculateFinalSpeed,
  calculateFinalStat,
  calculateFinalMaxHP,
} from "@/lib/logic/bonus-calculator";
import { formatModifier } from "@/lib/logic/utils";
import { Ability, Skills, SkillProficiencyType } from "@prisma/client";
import { PDFDocument, StandardFonts, rgb, type PDFFont, type PDFPage, type PDFForm } from "pdf-lib";
import fontkit from "@pdf-lib/fontkit";

import type { CharacterPdfData, PersSpellWithSpell, PrintConfig, PrintSection } from "./types";
import { CHARACTER_SHEET_OVERLAY, type OverlayFieldKey } from "./overlayLayout";

type Maybe<T> = T | null | undefined;

type PersExtraFields = {
  alignment?: string | null;
  xp?: number | null;
  tempHp?: number | null;
  deathSaveSuccesses?: number | null;
  deathSaveFailures?: number | null;
  isDead?: boolean | null;
  backstory?: string | null;
  notes?: string | null;
  customProficiencies?: string | null;
  customLanguagesKnown?: string | null;
  additionalSaveProficiencies?: Ability[] | null;
  currentHitDice?: Record<string, number> | null;
};

function getPersExtras(pers: CharacterPdfData["pers"]): PersExtraFields {
  return pers as unknown as PersExtraFields;
}

const DEFAULT_SECTIONS: PrintSection[] = ["CHARACTER", "FEATURES", "SPELLS"];

// Layout constants for rendered (non-template) pages.
const PAGE_MARGIN = 48; // 2/3 inch-ish.
const HEADER_FONT_SIZE = 18;
const SUBHEADER_FONT_SIZE = 13;
const BODY_FONT_SIZE = 10;
const BODY_LINE_HEIGHT = 12;
const SECTION_GAP = 14;
const ITEM_GAP = 10;

interface PageContext {
  page: PDFPage;
  x: number;
  y: number;
  margin: number;
  width: number;
  height: number;
}

interface TextOptions {
  font: PDFFont;
  size: number;
  color?: ReturnType<typeof rgb>;
  maxWidth: number;
  lineHeight: number;
}

interface FeatureGroup {
  title: string;
  items: Array<{
    name: string;
    sourceName: string;
    description: string;
    usesRemaining?: number | null;
    usesPer?: number | null;
    restType?: string | null;
  }>;
}

function safeText(value: Maybe<string | number>): string {
  if (value === null || value === undefined) return "";
  return String(value);
}

function isAsciiOnly(text: string): boolean {
  // StandardFonts in pdf-lib can only encode WinAnsi (effectively limited).
  // If we detect non-ASCII, we should either embed a Unicode font or sanitize.
  return /^[\x00-\x7F]*$/.test(text);
}

function sanitizeForStandardFont(text: string): string {
  // Best-effort: preserve ASCII and replace anything else.
  // TODO: Embed NotoSans (or other) TTF in public/fonts and use it for true Unicode.
  return text.replace(/[^\x00-\x7F]/g, "?");
}

async function maybeEmbedUnicodeFonts(pdfDoc: PDFDocument): Promise<{ regular: PDFFont; bold: PDFFont } | null> {
  // Optional: If you add these files, we will use them automatically for full Unicode.
  // - public/fonts/NotoSans-Regular.ttf
  // - public/fonts/NotoSans-Bold.ttf
  try {
    const fs = await import("fs/promises");
    const path = await import("path");

    const regularPath = path.resolve(process.cwd(), "public", "fonts", "NotoSans-Regular.ttf");
    const boldPath = path.resolve(process.cwd(), "public", "fonts", "NotoSans-Bold.ttf");

    const [regularBytes, boldBytes] = await Promise.all([
      fs.readFile(regularPath),
      fs.readFile(boldPath),
    ]);

    pdfDoc.registerFontkit(fontkit);
    const regular = await pdfDoc.embedFont(regularBytes, { subset: true });
    const bold = await pdfDoc.embedFont(boldBytes, { subset: true });
    return { regular, bold };
  } catch {
    return null;
  }
}

function normalizePrintConfig(config: PrintConfig | null | undefined): PrintConfig {
  const sections = (config?.sections?.length ? config.sections : DEFAULT_SECTIONS).filter(Boolean);
  return { sections };
}

function groupPersSpellsByLevel(persSpells: PersSpellWithSpell[]): Record<number, PersSpellWithSpell[]> {
  const out: Record<number, PersSpellWithSpell[]> = {};
  for (const ps of persSpells ?? []) {
    const level = ps.spell?.level ?? 0;
    if (!out[level]) out[level] = [];
    out[level].push(ps);
  }
  return out;
}

function createPageWithMargin(pdfDoc: PDFDocument, templateSize?: { width: number; height: number }): PageContext {
  const width = templateSize?.width ?? 612; // Letter default
  const height = templateSize?.height ?? 792;
  const page = pdfDoc.addPage([width, height]);
  return {
    page,
    margin: PAGE_MARGIN,
    x: PAGE_MARGIN,
    y: height - PAGE_MARGIN,
    width,
    height,
  };
}

function ensureSpace(ctx: PageContext, neededHeight: number, pdfDoc: PDFDocument, templateSize?: { width: number; height: number }): PageContext {
  if (ctx.y - neededHeight >= ctx.margin) return ctx;
  return createPageWithMargin(pdfDoc, templateSize);
}

function drawTextLine(ctx: PageContext, text: string, opts: Omit<TextOptions, "maxWidth">): PageContext {
  const color = opts.color ?? rgb(0, 0, 0);
  ctx.page.drawText(text, {
    x: ctx.x,
    y: ctx.y - opts.size,
    size: opts.size,
    font: opts.font,
    color,
  });
  ctx.y -= opts.lineHeight;
  return ctx;
}

function wrapTextIntoLines(text: string, font: PDFFont, size: number, maxWidth: number): string[] {
  const words = text.split(/\s+/g).filter(Boolean);
  const lines: string[] = [];
  let line = "";

  for (const word of words) {
    const next = line ? `${line} ${word}` : word;
    const width = font.widthOfTextAtSize(next, size);
    if (width <= maxWidth) {
      line = next;
      continue;
    }

    if (line) lines.push(line);

    // If a single word is longer than maxWidth, hard-break it.
    if (font.widthOfTextAtSize(word, size) > maxWidth) {
      let chunk = "";
      for (const ch of word) {
        const c2 = chunk + ch;
        if (font.widthOfTextAtSize(c2, size) <= maxWidth) {
          chunk = c2;
        } else {
          if (chunk) lines.push(chunk);
          chunk = ch;
        }
      }
      line = chunk;
    } else {
      line = word;
    }
  }

  if (line) lines.push(line);
  return lines;
}

function drawWrappedText(
  ctx: PageContext,
  pdfDoc: PDFDocument,
  text: string,
  opts: TextOptions,
  templateSize?: { width: number; height: number },
  supportsUnicode: boolean = false
): PageContext {
  const color = opts.color ?? rgb(0, 0, 0);
  const sanitized = supportsUnicode || isAsciiOnly(text) ? text : sanitizeForStandardFont(text);
  const lines = wrapTextIntoLines(sanitized, opts.font, opts.size, opts.maxWidth);

  for (const line of lines) {
    ctx = ensureSpace(ctx, opts.lineHeight + 2, pdfDoc, templateSize);
    ctx.page.drawText(line, {
      x: ctx.x,
      y: ctx.y - opts.size,
      size: opts.size,
      font: opts.font,
      color,
    });
    ctx.y -= opts.lineHeight;
  }

  return ctx;
}

function tryGetTextField(form: PDFForm, name: string) {
  try {
    return form.getTextField(name);
  } catch {
    return null;
  }
}

function tryGetCheckBox(form: PDFForm, name: string) {
  try {
    return form.getCheckBox(name);
  } catch {
    return null;
  }
}

function setTextIfPresent(form: PDFForm, name: string, value: string) {
  const field = tryGetTextField(form, name);
  if (!field) return;
  field.setText(value ?? "");
  try {
    field.enableReadOnly();
    field.disableReadOnly();
  } catch {
    // Some field implementations may not support readOnly toggles.
  }
}

function setCheckIfPresent(form: PDFForm, name: string, checked: boolean) {
  const field = tryGetCheckBox(form, name);
  if (!field) return;
  if (checked) field.check();
  else field.uncheck();
}

function drawOverlayText(pdfDoc: PDFDocument, key: OverlayFieldKey, value: string, font: PDFFont) {
  const rect = CHARACTER_SHEET_OVERLAY[key];
  if (!rect) return;
  const page = pdfDoc.getPages()[rect.pageIndex];
  if (!page) return;

  const text = value ?? "";
  if (!text) return;

  const size = rect.size ?? 10;

  const draw = (t: string) => {
    const textWidth = font.widthOfTextAtSize(t, size);

    let x = rect.x;
    if (rect.align === "center") x = rect.x + (rect.width - textWidth) / 2;
    if (rect.align === "right") x = rect.x + rect.width - textWidth;

    // Vertically center within rect.
    const y = rect.y + (rect.height - size) / 2;

    page.drawText(t, {
      x,
      y,
      size,
      font,
      color: rgb(0, 0, 0),
    });
  };

  try {
    draw(text);
  } catch {
    // If the font can't encode text (e.g., WinAnsi standard fonts with Cyrillic),
    // degrade gracefully instead of crashing the request.
    draw(sanitizeForStandardFont(text));
  }
}

async function overlayFillFirstPage(pdfDoc: PDFDocument, data: CharacterPdfData, font: PDFFont) {
  const pers = data.pers;
  const extras = getPersExtras(pers);

  drawOverlayText(pdfDoc, "characterName", safeText(pers.name), font);
  drawOverlayText(pdfDoc, "classLevel", buildClassLevelString(pers), font);
  drawOverlayText(pdfDoc, "background", safeText(pers.background?.name), font);
  drawOverlayText(pdfDoc, "playerName", safeText(pers.user?.name ?? pers.user?.email), font);
  drawOverlayText(pdfDoc, "race", safeText(pers.race?.name), font);
  drawOverlayText(pdfDoc, "alignment", safeText(extras.alignment), font);
  drawOverlayText(pdfDoc, "xp", safeText(extras.xp), font);

  drawOverlayText(pdfDoc, "proficiencyBonus", formatModifier(calculateFinalProficiency(pers)), font);
  drawOverlayText(pdfDoc, "ac", safeText(calculateFinalAC(pers)), font);
  drawOverlayText(pdfDoc, "initiative", formatModifier(calculateFinalInitiative(pers)), font);
  drawOverlayText(pdfDoc, "speed", safeText(calculateFinalSpeed(pers)), font);

  drawOverlayText(pdfDoc, "hpMax", safeText(calculateFinalMaxHP(pers)), font);
  drawOverlayText(pdfDoc, "hpCurrent", safeText(pers.currentHp), font);
  drawOverlayText(pdfDoc, "hpTemp", safeText(extras.tempHp ?? 0), font);

  const abilities: Ability[] = ["STR", "DEX", "CON", "INT", "WIS", "CHA"];
  for (const ability of abilities) {
    const score = calculateFinalStat(pers, ability);
    const mod = calculateFinalModifier(pers, ability);
    drawOverlayText(pdfDoc, `stat:${ability}:score`, safeText(score), font);
    drawOverlayText(pdfDoc, `stat:${ability}:mod`, formatModifier(mod), font);
  }
}

function buildClassLevelString(pers: CharacterPdfData["pers"]): string {
  const multiclassLevelSum = pers.multiclasses?.reduce((acc, mc) => acc + mc.classLevel, 0) ?? 0;
  const mainClassLevel = pers.level - multiclassLevelSum;

  const parts: string[] = [];
  parts.push(`${pers.class.name} ${mainClassLevel}`);

  for (const mc of pers.multiclasses ?? []) {
    parts.push(`${mc.class.name} ${mc.classLevel}`);
  }

  return parts.join(" / ");
}

function buildHitDiceInfoFromPers(pers: CharacterPdfData["pers"]): { totalString: string; currentString: string } {
  const multiclassLevelSum = pers.multiclasses?.reduce((acc, mc) => acc + mc.classLevel, 0) ?? 0;
  const mainClassLevel = pers.level - multiclassLevelSum;

  const stored = getPersExtras(pers).currentHitDice ?? {};

  const chunks: Array<{ current: number; max: number; die: number }> = [];

  const mainCurrent = typeof stored[String(pers.class.classId)] === "number" ? stored[String(pers.class.classId)] : mainClassLevel;
  chunks.push({
    current: Math.min(mainCurrent, mainClassLevel),
    max: mainClassLevel,
    die: pers.class.hitDie,
  });

  for (const mc of pers.multiclasses ?? []) {
    const mcCurrent = typeof stored[String(mc.classId)] === "number" ? stored[String(mc.classId)] : mc.classLevel;
    chunks.push({
      current: Math.min(mcCurrent, mc.classLevel),
      max: mc.classLevel,
      die: mc.class.hitDie,
    });
  }

  const totalString = chunks.map((c) => `${c.max}d${c.die}`).join(" + ");
  const currentString = chunks.map((c) => `${c.current}d${c.die}`).join(" + ");
  return { totalString, currentString };
}

function fillAbility(form: PDFForm, ability: Ability, score: number, mod: number) {
  // These are common field names in many fillable 5e sheets.
  // Your template might differ; if so, update these mappings.
  const scoreFieldCandidates = {
    STR: ["STR", "Strength"],
    DEX: ["DEX", "Dexterity"],
    CON: ["CON", "Constitution"],
    INT: ["INT", "Intelligence"],
    WIS: ["WIS", "Wisdom"],
    CHA: ["CHA", "Charisma"],
  } as const;

  const modFieldCandidates = {
    STR: ["STRmod", "StrengthMod"],
    DEX: ["DEXmod", "DexterityMod"],
    CON: ["CONmod", "ConstitutionMod"],
    INT: ["INTmod", "IntelligenceMod"],
    WIS: ["WISmod", "WisdomMod"],
    CHA: ["CHAmod", "CharismaMod"],
  } as const;

  const scoreNames = scoreFieldCandidates[ability] ?? [];
  const modNames = modFieldCandidates[ability] ?? [];

  for (const name of scoreNames) setTextIfPresent(form, name, safeText(score));
  for (const name of modNames) setTextIfPresent(form, name, formatModifier(mod));
}

function fillSavingThrows(form: PDFForm, pers: CharacterPdfData["pers"]) {
  const classSavingThrows = pers.class.savingThrows ?? [];
  const extras = getPersExtras(pers);

  const mapping: Record<Ability, { value: string[]; proficient?: string[] }> = {
    STR: { value: ["ST Strength", "StrengthSave"], proficient: ["Check Box 11", "StrengthSaveProf"] },
    DEX: { value: ["ST Dexterity", "DexteritySave"], proficient: ["Check Box 18", "DexteritySaveProf"] },
    CON: { value: ["ST Constitution", "ConstitutionSave"], proficient: ["Check Box 19", "ConstitutionSaveProf"] },
    INT: { value: ["ST Intelligence", "IntelligenceSave"], proficient: ["Check Box 20", "IntelligenceSaveProf"] },
    WIS: { value: ["ST Wisdom", "WisdomSave"], proficient: ["Check Box 21", "WisdomSaveProf"] },
    CHA: { value: ["ST Charisma", "CharismaSave"], proficient: ["Check Box 22", "CharismaSaveProf"] },
  };

  for (const ability of Object.keys(mapping) as Ability[]) {
    const total = calculateFinalSave(pers, ability, classSavingThrows);
    for (const name of mapping[ability].value) setTextIfPresent(form, name, formatModifier(total));

    const isProficient =
      classSavingThrows.includes(ability) ||
      (Array.isArray(extras.additionalSaveProficiencies) && extras.additionalSaveProficiencies.includes(ability));
    for (const chk of mapping[ability].proficient ?? []) setCheckIfPresent(form, chk, Boolean(isProficient));
  }
}

function fillSkills(form: PDFForm, pers: CharacterPdfData["pers"]) {
  const skillFieldNames: Partial<Record<Skills, { mod: string[]; prof?: string[] }>> = {
    [Skills.ACROBATICS]: { mod: ["Acrobatics"], prof: ["Check Box 23"] },
    [Skills.ANIMAL_HANDLING]: { mod: ["Animal"], prof: ["Check Box 24"] },
    [Skills.ARCANA]: { mod: ["Arcana"], prof: ["Check Box 25"] },
    [Skills.ATHLETICS]: { mod: ["Athletics"], prof: ["Check Box 26"] },
    [Skills.DECEPTION]: { mod: ["Deception"], prof: ["Check Box 27"] },
    [Skills.HISTORY]: { mod: ["History"], prof: ["Check Box 28"] },
    [Skills.INSIGHT]: { mod: ["Insight"], prof: ["Check Box 29"] },
    [Skills.INTIMIDATION]: { mod: ["Intimidation"], prof: ["Check Box 30"] },
    [Skills.INVESTIGATION]: { mod: ["Investigation"], prof: ["Check Box 31"] },
    [Skills.MEDICINE]: { mod: ["Medicine"], prof: ["Check Box 32"] },
    [Skills.NATURE]: { mod: ["Nature"], prof: ["Check Box 33"] },
    [Skills.PERCEPTION]: { mod: ["Perception"], prof: ["Check Box 34"] },
    [Skills.PERFORMANCE]: { mod: ["Performance"], prof: ["Check Box 35"] },
    [Skills.PERSUASION]: { mod: ["Persuasion"], prof: ["Check Box 36"] },
    [Skills.RELIGION]: { mod: ["Religion"], prof: ["Check Box 37"] },
    [Skills.SLEIGHT_OF_HAND]: { mod: ["SleightofHand"], prof: ["Check Box 38"] },
    [Skills.STEALTH]: { mod: ["Stealth"], prof: ["Check Box 39"] },
    [Skills.SURVIVAL]: { mod: ["Survival"], prof: ["Check Box 40"] },
  };

  for (const skill of Object.keys(skillFieldNames) as unknown as Skills[]) {
    const mapping = skillFieldNames[skill];
    if (!mapping) continue;

    const { total, proficiency } = calculateFinalSkill(pers, skill);
    for (const name of mapping.mod) setTextIfPresent(form, name, formatModifier(total));

    const isProficient = proficiency === SkillProficiencyType.PROFICIENT || proficiency === SkillProficiencyType.EXPERTISE;
    for (const chk of mapping.prof ?? []) setCheckIfPresent(form, chk, Boolean(isProficient));
  }
}

function fillDeathSaves(form: PDFForm, pers: CharacterPdfData["pers"]) {
  const extras = getPersExtras(pers);
  const successes = Number.isFinite(extras.deathSaveSuccesses) ? Math.max(0, Math.trunc(extras.deathSaveSuccesses as number)) : 0;
  const failures = Number.isFinite(extras.deathSaveFailures) ? Math.max(0, Math.trunc(extras.deathSaveFailures as number)) : 0;

  // Common names in some sheets: DeathSaveSuccess1..3, DeathSaveFail1..3
  for (let i = 1; i <= 3; i++) {
    setCheckIfPresent(form, `DeathSaveSuccess${i}`, i <= successes);
    setCheckIfPresent(form, `DeathSaveFail${i}`, i <= failures);
  }
}

function fillFirstPage(form: PDFForm, data: CharacterPdfData) {
  const { pers } = data;
  const extras = getPersExtras(pers);

  // Identity
  setTextIfPresent(form, "CharacterName", safeText(pers.name));
  setTextIfPresent(form, "ClassLevel", buildClassLevelString(pers));
  setTextIfPresent(form, "Background", safeText(pers.background?.name));
  setTextIfPresent(form, "PlayerName", safeText(pers.user?.name ?? pers.user?.email));
  setTextIfPresent(form, "Race", safeText(pers.race?.name));
  setTextIfPresent(form, "Alignment", safeText(extras.alignment));
  setTextIfPresent(form, "XP", safeText(extras.xp));

  // Ability scores & modifiers
  for (const ability of [Ability.STR, Ability.DEX, Ability.CON, Ability.INT, Ability.WIS, Ability.CHA]) {
    const score = calculateFinalStat(pers, ability);
    const mod = calculateFinalModifier(pers, ability);
    fillAbility(form, ability, score, mod);
  }

  // Proficiency Bonus
  setTextIfPresent(form, "ProficiencyBonus", formatModifier(calculateFinalProficiency(pers)));

  // AC / Initiative / Speed
  setTextIfPresent(form, "AC", safeText(calculateFinalAC(pers)));
  setTextIfPresent(form, "Initiative", formatModifier(calculateFinalInitiative(pers)));
  setTextIfPresent(form, "Speed", safeText(calculateFinalSpeed(pers)));

  // HP
  setTextIfPresent(form, "HPMax", safeText(calculateFinalMaxHP(pers)));
  setTextIfPresent(form, "HPCurrent", safeText(pers.currentHp));
  setTextIfPresent(form, "HPTemp", safeText(extras.tempHp ?? 0));

  // Hit dice
  const hitDice = buildHitDiceInfoFromPers(pers);
  setTextIfPresent(form, "HitDiceTotal", hitDice.totalString);
  setTextIfPresent(form, "HitDiceCurrent", hitDice.currentString);

  // Death saves
  fillDeathSaves(form, pers);

  // Saves & skills
  fillSavingThrows(form, pers);
  fillSkills(form, pers);

  // Personality & backstory
  setTextIfPresent(form, "PersonalityTraits", safeText(pers.personalityTraits));
  setTextIfPresent(form, "Ideals", safeText(pers.ideals));
  setTextIfPresent(form, "Bonds", safeText(pers.bonds));
  setTextIfPresent(form, "Flaws", safeText(pers.flaws));

  setTextIfPresent(form, "Backstory", safeText(extras.backstory));
  setTextIfPresent(form, "Notes", safeText(extras.notes));

  // Optional: custom proficiencies/languages if your template has fields.
  setTextIfPresent(form, "Proficiencies", safeText(extras.customProficiencies));
  setTextIfPresent(form, "Languages", safeText(extras.customLanguagesKnown));
}

function buildFeatureGroups(data: CharacterPdfData): FeatureGroup[] {
  const allItems = Object.values(data.features).flat();
  const byKey = new Map<string, (typeof allItems)[number]>();
  for (const item of allItems) {
    if (!byKey.has(item.key)) byKey.set(item.key, item);
  }

  const items = [...byKey.values()];

  const fromSource = (sources: Array<(typeof items)[number]["source"]>) =>
    items
      .filter((i) => sources.includes(i.source))
      .map((i) => ({
        name: i.name,
        sourceName: i.sourceName,
        description: i.description,
        usesRemaining: i.usesRemaining ?? null,
        usesPer: i.usesPer ?? null,
        restType: i.restType ?? null,
      }));

  const groups: FeatureGroup[] = [
    {
      title: "Class & Subclass Features",
      items: fromSource(["CLASS", "SUBCLASS"]),
    },
    {
      title: "Race & Subrace Features",
      items: fromSource(["RACE", "SUBRACE"]),
    },
    {
      title: "Background Features",
      items: fromSource(["BACKGROUND"]),
    },
    {
      title: "Feats",
      items: fromSource(["FEAT"]),
    },
    {
      title: "Other Features",
      items: fromSource(["PERS", "CHOICE", "RACE_CHOICE"]),
    },
  ];

  return groups.filter((g) => g.items.length > 0);
}

async function renderFeaturesSection(
  pdfDoc: PDFDocument,
  data: CharacterPdfData,
  fonts: { regular: PDFFont; bold: PDFFont },
  templateSize?: { width: number; height: number },
  supportsUnicode: boolean = false
) {
  let ctx = createPageWithMargin(pdfDoc, templateSize);
  const maxWidth = ctx.width - ctx.margin * 2;

  ctx = drawTextLine(ctx, `Features  ${sanitizeForStandardFont(data.pers.name ?? "")}`, {
    font: fonts.bold,
    size: HEADER_FONT_SIZE,
    lineHeight: HEADER_FONT_SIZE + 8,
  });
  ctx.y -= SECTION_GAP;

  const groups = buildFeatureGroups(data);

  for (const group of groups) {
    ctx = ensureSpace(ctx, SUBHEADER_FONT_SIZE + 10, pdfDoc, templateSize);
    ctx = drawTextLine(ctx, sanitizeForStandardFont(group.title), {
      font: fonts.bold,
      size: SUBHEADER_FONT_SIZE,
      lineHeight: SUBHEADER_FONT_SIZE + 6,
    });

    for (const item of group.items) {
      const headerParts = [sanitizeForStandardFont(item.name)];
      if (item.sourceName && item.sourceName !== item.name) headerParts.push(`(${sanitizeForStandardFont(item.sourceName)})`);
      if (typeof item.usesPer === "number") {
        const used = typeof item.usesRemaining === "number" ? `${item.usesRemaining}/${item.usesPer}` : `/${item.usesPer}`;
        headerParts.push(`[${used}${item.restType ? ` ${item.restType}` : ""}]`);
      }

      ctx = ensureSpace(ctx, BODY_LINE_HEIGHT * 2, pdfDoc, templateSize);
      ctx = drawWrappedText(
        ctx,
        pdfDoc,
        headerParts.join(" "),
        {
          font: fonts.bold,
          size: BODY_FONT_SIZE,
          maxWidth,
          lineHeight: BODY_LINE_HEIGHT,
          color: rgb(0, 0, 0),
        },
        templateSize,
        supportsUnicode
      );

      const description = item.description?.trim() ?? "";
      if (description) {
        ctx = drawWrappedText(
          ctx,
          pdfDoc,
          description,
          {
            font: fonts.regular,
            size: BODY_FONT_SIZE,
            maxWidth,
            lineHeight: BODY_LINE_HEIGHT,
            color: rgb(0.12, 0.12, 0.12),
          },
          templateSize,
          supportsUnicode
        );
      }

      ctx.y -= ITEM_GAP;
    }

    ctx.y -= SECTION_GAP;
  }
}

function levelLabel(level: number): string {
  if (level === 0) return "Level 0 (Cantrips)";
  return `Level ${level}`;
}

function buildSpellOneLiner(ps: PersSpellWithSpell): string {
  const s = ps.spell;
  if (!s) return "";

  const school = s.school ? `${s.school}` : "";
  const ritual = s.hasRitual ? "R" : "";
  const conc = s.hasConcentration ? "C" : "";
  const tags = [ritual, conc].filter(Boolean).join("/");

  const parts = [
    s.name,
    school ? ` ${school}${tags ? ` (${tags})` : ""}` : (tags ? ` (${tags})` : ""),
    `, ${s.castingTime}`,
    `, ${s.range}`,
    s.components ? `, ${s.components}` : "",
    `, ${s.duration}`,
  ].join("");

  return parts;
}

async function renderSpellsSection(
  pdfDoc: PDFDocument,
  data: CharacterPdfData,
  fonts: { regular: PDFFont; bold: PDFFont },
  templateSize?: { width: number; height: number },
  supportsUnicode: boolean = false
) {
  let ctx = createPageWithMargin(pdfDoc, templateSize);
  const maxWidth = ctx.width - ctx.margin * 2;

  ctx = drawTextLine(ctx, `Spells  ${sanitizeForStandardFont(data.pers.name ?? "")}`, {
    font: fonts.bold,
    size: HEADER_FONT_SIZE,
    lineHeight: HEADER_FONT_SIZE + 8,
  });
  ctx.y -= SECTION_GAP;

  const levels = Object.keys(data.spellsByLevel)
    .map(Number)
    .sort((a, b) => a - b);

  for (const level of levels) {
    const spells = data.spellsByLevel[level] ?? [];
    if (spells.length === 0) continue;

    ctx = ensureSpace(ctx, SUBHEADER_FONT_SIZE + 10, pdfDoc, templateSize);
    ctx = drawTextLine(ctx, levelLabel(level), {
      font: fonts.bold,
      size: SUBHEADER_FONT_SIZE,
      lineHeight: SUBHEADER_FONT_SIZE + 6,
    });

    for (const ps of spells) {
      const oneLine = buildSpellOneLiner(ps);
      if (oneLine) {
        ctx = drawWrappedText(
          ctx,
          pdfDoc,
          oneLine,
          {
            font: fonts.bold,
            size: BODY_FONT_SIZE,
            maxWidth,
            lineHeight: BODY_LINE_HEIGHT,
          },
          templateSize,
          supportsUnicode
        );
      }

      const description = ps.spell?.description?.trim() ?? "";
      if (description) {
        ctx = drawWrappedText(
          ctx,
          pdfDoc,
          description,
          {
            font: fonts.regular,
            size: BODY_FONT_SIZE,
            maxWidth,
            lineHeight: BODY_LINE_HEIGHT,
            color: rgb(0.12, 0.12, 0.12),
          },
          templateSize,
          supportsUnicode
        );
      }

      ctx.y -= ITEM_GAP;
    }

    ctx.y -= SECTION_GAP;
  }
}

export async function generateCharacterPdf(
  persId: number,
  userEmail: string,
  config: PrintConfig
): Promise<Uint8Array> {
  const normalized = normalizePrintConfig(config);

  // 1) Authorization
  const session = await auth();
  if (!session?.user?.email) throw new Error("Unauthorized");
  if (session.user.email !== userEmail) throw new Error("Unauthorized");

  // 2) Gather data (reuses existing include/auth logic)
  const pers = await getPersById(persId);
  if (!pers) throw new Error("Not found");

  const features = await getCharacterFeaturesGrouped(persId);
  if (!features) throw new Error("Not found");

  const spellsByLevel = groupPersSpellsByLevel(pers.persSpells ?? []);

  const data: CharacterPdfData = { pers, features, spellsByLevel };

  // 3) Load template
  const fs = await import("fs/promises");
  const path = await import("path");

  const templatePath = path.resolve(process.cwd(), "public", "CharacterSheet.pdf");
  const existingPdfBytes = await fs.readFile(templatePath);

  const pdfDoc = await PDFDocument.load(existingPdfBytes);

  const templatePages = pdfDoc.getPages();
  const templateSize = templatePages.length
    ? { width: templatePages[0].getWidth(), height: templatePages[0].getHeight() }
    : undefined;

  // Embed Unicode fonts early so overlay drawing and wrapping can handle Cyrillic.
  const unicodeFonts = await maybeEmbedUnicodeFonts(pdfDoc);
  const regularFont = unicodeFonts?.regular ?? (await pdfDoc.embedFont(StandardFonts.Helvetica));
  const boldFont = unicodeFonts?.bold ?? (await pdfDoc.embedFont(StandardFonts.HelveticaBold));
  const supportsUnicode = Boolean(unicodeFonts);

  // 4) Fill template form fields (if any), else overlay-draw key values.
  if (normalized.sections.includes("CHARACTER")) {
    let filled = false;

    // If your template is a proper AcroForm PDF, pdf-lib will populate fields and keep them editable.
    try {
      const form = pdfDoc.getForm();
      const fieldCount = form.getFields().length;
      if (fieldCount > 0) {
        fillFirstPage(form, data);
        filled = true;
      }
      // Do NOT flatten to keep fields editable.
    } catch {
      filled = false;
    }

    // Fallback: template isn't a real AcroForm (common when fields were added via "Fill & Sign" / Typewriter).
    if (!filled) {
      await overlayFillFirstPage(pdfDoc, data, regularFont);
    }
  }

  // 5/6) Render additional sections
  const fonts = { regular: regularFont, bold: boldFont };

  if (normalized.sections.includes("FEATURES")) {
    await renderFeaturesSection(pdfDoc, data, fonts, templateSize, supportsUnicode);
  }

  if (normalized.sections.includes("SPELLS")) {
    await renderSpellsSection(pdfDoc, data, fonts, templateSize, supportsUnicode);
  }

  // 7) Save
  return pdfDoc.save();
}
</file>

<file path="src/server/pdf/types.ts">
import type { PersWithRelations } from "@/lib/actions/pers";
import type { CharacterFeaturesGroupedResult } from "@/lib/actions/pers";

export type PrintSection = "CHARACTER" | "FEATURES" | "SPELLS";

export interface PrintConfig {
  sections: PrintSection[];
}

export type PersSpellWithSpell = PersWithRelations["persSpells"][number];

export interface CharacterPdfData {
  pers: PersWithRelations;
  features: CharacterFeaturesGroupedResult;
  spellsByLevel: Record<number, PersSpellWithSpell[]>;
}
</file>

<file path="src/store/character-store.ts">
import { create } from 'zustand';
import { immer } from 'zustand/middleware/immer';
import { LevelUpChoice, LevelUpStep } from '@/types/character-flow';
import { getLevelUpSteps } from '@/lib/actions/character-logic';
import { commitLevelUp, LevelUpSelections } from '@/app/actions/level-up';

export type WizardPhase = 'idle' | 'loading' | 'steps' | 'complete' | 'error';

interface CharacterStoreState {
  phase: WizardPhase;
  steps: LevelUpStep[];
  choices: LevelUpChoice[];
  currentStepIndex: number;
  error: string | null;
  isSubmitting: boolean;
  message: string | null;
  persId: number | null; // Store persId for submission

  initiateLevelUp: (persId: number, currentLevel: number) => Promise<void>;
  nextStep: () => void;
  prevStep: () => void;
  addChoice: (choice: LevelUpChoice) => void;
  removeChoice: (stepType: LevelUpChoice['stepType']) => void;
  submitLevelUp: () => Promise<void>;
  reset: () => void;
  
  // Mock for createCharacter
  setCharacterInput: (input: unknown) => void;
  createCharacter: () => Promise<void>;
}

const initialState = {
  phase: 'idle' as WizardPhase,
  steps: [],
  choices: [],
  currentStepIndex: 0,
  error: null,
  isSubmitting: false,
  message: null,
  persId: null as number | null,
};

export const useCharacterStore = create<CharacterStoreState>()(
  immer((set) => ({
    ...initialState,

    initiateLevelUp: async (persId: number) => {
      set((state) => {
        state.phase = 'loading';
        state.error = null;
        state.persId = persId; // Store persId for later submission
      });

      try {
        const result = await getLevelUpSteps(persId);
        
        if ('error' in result) {
             set((state) => {
                state.phase = 'error';
                state.error = result.error;
             });
             return;
        }

        set((state) => {
          state.phase = 'steps';
          state.steps = result.steps;
          state.currentStepIndex = 0;
          state.choices = [];
        });
      } catch {
        set((state) => {
          state.phase = 'error';
          state.error = 'Failed to load level up steps';
        });
      }
    },

    nextStep: () => {
      set((state) => {
        if (state.currentStepIndex < state.steps.length - 1) {
          state.currentStepIndex += 1;
        }
      });
    },

    prevStep: () => {
      set((state) => {
        if (state.currentStepIndex > 0) {
          state.currentStepIndex -= 1;
        }
      });
    },

    addChoice: (choice: LevelUpChoice) => {
      set((state) => {
        const existingIndex = state.choices.findIndex(c => c.stepType === choice.stepType);
        if (existingIndex >= 0) {
          state.choices[existingIndex] = choice;
        } else {
          state.choices.push(choice);
        }
      });
    },

    removeChoice: (stepType: LevelUpChoice['stepType']) => {
      set((state) => {
        state.choices = state.choices.filter(c => c.stepType !== stepType);
      });
    },

    submitLevelUp: async () => {
        const state = useCharacterStore.getState();
        const { persId, choices } = state;
        
        if (!persId) {
          set((s) => { 
            s.phase = 'error'; 
            s.error = '  '; 
          });
          return;
        }

        set((s) => { s.isSubmitting = true; });

        try {
          // Transform choices to LevelUpSelections format
          const selections: LevelUpSelections = {};
          
          for (const choice of choices) {
            // Subclass selection
            if (choice.stepType === 'SELECT_SUBCLASS' && choice.subclassId) {
              selections.subclassId = choice.subclassId;
            }
            
            // ASI selection (stats object like { STR: 2 } or { DEX: 1, WIS: 1 })
            if (choice.stepType === 'SELECT_FEAT_OR_ASI' && choice.type === 'ASI' && choice.stats) {
              selections.asi = Object.entries(choice.stats)
                .filter(([, val]) => val && val > 0)
                .map(([stat, value]) => ({
                  stat: stat,
                  value: value as number,
                }));
            }
            
            // Optional feature choice (Fighting Style, etc.)
            if (choice.stepType === 'CHOOSE_OPTIONAL_FEATURE' && choice.featureId && choice.selectedOptionId) {
              if (!selections.specificChoices) selections.specificChoices = [];
              selections.specificChoices.push({
                featureId: Number(choice.featureId),
                choiceOptionId: choice.selectedOptionId,
              });
            }
            
            // Spell selection
            if (choice.stepType === 'SELECT_SPELLS' && choice.selectedSpellIds) {
              selections.spellIds = choice.selectedSpellIds;
            }
          }

          const result = await commitLevelUp(persId, selections);
          
          if (result.success) {
            set((s) => {
              s.isSubmitting = false;
              s.phase = 'complete';
            });
          } else {
            set((s) => {
              s.isSubmitting = false;
              s.phase = 'error';
              s.error = result.error || ' ';
            });
          }
        } catch (err) {
          console.error('Level-up submission error:', err);
          set((s) => {
            s.isSubmitting = false;
            s.phase = 'error';
            s.error = ' .   .';
          });
        }
    },

    reset: () => {
      set(initialState);
    },

    setCharacterInput: () => {},
    createCharacter: async () => {},
  }))
);
</file>

<file path="src/types/character-flow.ts">
import { z } from 'zod';

export const StatsSchema = z.object({
  STR: z.number().optional(),
  DEX: z.number().optional(),
  CON: z.number().optional(),
  INT: z.number().optional(),
  WIS: z.number().optional(),
  CHA: z.number().optional(),
});

export type Stats = z.infer<typeof StatsSchema>;

export type LevelUpStepType = 
  | 'SELECT_SUBCLASS'
  | 'SELECT_FEAT_OR_ASI'
  | 'SELECT_SPELLS'
  | 'ADD_HP'
  | 'CHOOSE_OPTIONAL_FEATURE'
  | 'MULTICLASS_NEW_CLASS'
  | 'INFO';

export interface LevelUpStepBase {
  type: LevelUpStepType;
}

export interface SelectSubclassStep extends LevelUpStepBase {
  type: 'SELECT_SUBCLASS';
  classId: number;
  className: string;
  classNameEng: string;
  level: number;
  options: {
    id: number;
    name: string;
    description: string;
  }[];
  isRequired: boolean;
}

export interface SelectFeatOrASIStep extends LevelUpStepBase {
  type: 'SELECT_FEAT_OR_ASI';
  currentStats: Stats;
  feats: any[]; // Define Feat type properly if needed
}

export interface AddHPStep extends LevelUpStepBase {
  type: 'ADD_HP';
  hitDie: number;
  method: 'roll' | 'fixed';
}

export interface ChooseOptionalFeatureStep extends LevelUpStepBase {
  type: 'CHOOSE_OPTIONAL_FEATURE';
  featureId: string | number;
  title: string;
  description: string;
  options: {
    id: number;
    name: string;
    description: string;
  }[];
  count: number;
}

export interface SelectSpellsStep extends LevelUpStepBase {
    type: 'SELECT_SPELLS';
    // Add properties
}

export type LevelUpStep = 
  | SelectSubclassStep 
  | SelectFeatOrASIStep 
  | AddHPStep 
  | ChooseOptionalFeatureStep
  | SelectSpellsStep;

export interface LevelUpChoice {
  stepType: LevelUpStepType;
  subclassId?: number;
  type?: 'ASI' | 'FEAT';
  stats?: Stats;
  value?: number;
  method?: 'roll' | 'fixed';
  featureId?: string | number;
  selectedOptionId?: number;
  selectedSpellIds?: number[];
}

export interface LevelUpResponse {
  newLevel: number;
  className: string;
  steps: LevelUpStep[];
}

export interface LevelUpError {
  error: string;
}
</file>

<file path="tools/fix_spell_links.ts">
import fs from 'node:fs/promises';
import path from 'node:path';

type SpellEntry = {
  spell_id: number;
  eng_name: string;
};

type DictionaryJson = {
  SPELLS?: SpellEntry[];
};

function normalizeSpellName(name: string): string {
  return name
    .trim()
    .toLowerCase()
    .replace(/\u2019/g, "'") // curly apostrophe
    .replace(/\s+/g, ' ');
}

async function collectTsFiles(rootPath: string): Promise<string[]> {
  const files: string[] = [];

  async function walk(current: string) {
    const stat = await fs.stat(current);
    if (stat.isFile()) {
      if (current.endsWith('.ts')) files.push(current);
      return;
    }

    const entries = await fs.readdir(current, { withFileTypes: true });
    for (const entry of entries) {
      if (entry.name === 'node_modules' || entry.name === '.next' || entry.name === '.git') continue;
      await walk(path.join(current, entry.name));
    }
  }

  await walk(rootPath);
  return files;
}

async function loadSpellIdByNameMap(workspaceRoot: string): Promise<Map<string, number>> {
  const dictPath = path.join(workspaceRoot, 'src', 'lib', 'refs', 'dictionary.json');
  const raw = await fs.readFile(dictPath, 'utf8');
  const json = JSON.parse(raw) as DictionaryJson;

  if (!json.SPELLS || !Array.isArray(json.SPELLS)) {
    throw new Error(`No SPELLS[] found in ${dictPath}`);
  }

  const map = new Map<string, number>();
  for (const spell of json.SPELLS) {
    if (!spell?.eng_name || typeof spell.spell_id !== 'number') continue;
    const key = normalizeSpellName(spell.eng_name);
    if (!map.has(key)) map.set(key, spell.spell_id);
  }

  return map;
}

async function main() {
  const args = process.argv.slice(2);
  const write = args.includes('--write');
  const targetRoots = args.filter((a) => a !== '--write');

  const workspaceRoot = process.cwd();
  const spellIdByName = await loadSpellIdByNameMap(workspaceRoot);

  const roots = targetRoots.length ? targetRoots : [path.join(workspaceRoot, 'prisma', 'seed')];

  // <a href="/spell/1289">UA text [Detect Magic]</a>
  const anchorRe = /<a\s+href=("|')\/spell\/(\d+)\1>([^<]*?)\[(.*?)\]<\/a>/g;

  let totalChanges = 0;
  let totalAnchors = 0;
  let filesTouched = 0;

  for (const root of roots) {
    const resolvedRoot = path.isAbsolute(root) ? root : path.join(workspaceRoot, root);
    const tsFiles = await collectTsFiles(resolvedRoot);

    for (const filePath of tsFiles) {
      const original = await fs.readFile(filePath, 'utf8');

      let fileChanges = 0;
      const sampleChanges: Array<{ currentId: number; expectedId: number; name: string }> = [];
      const updated = original.replace(anchorRe, (full, quote, idStr, beforeBracket, engName) => {
        totalAnchors += 1;
        const currentId = Number(idStr);
        const normalizedName = normalizeSpellName(engName);
        const expectedId = spellIdByName.get(normalizedName);

        if (!expectedId) return full;
        if (expectedId === currentId) return full;

        fileChanges += 1;
        totalChanges += 1;
        if (!write && sampleChanges.length < 10) {
          sampleChanges.push({ currentId, expectedId, name: engName });
        }
        return `<a href=${quote}/spell/${expectedId}${quote}>${beforeBracket}[${engName}]</a>`;
      });

      if (fileChanges > 0) {
        filesTouched += 1;
        const rel = path.relative(workspaceRoot, filePath);
        if (write) {
          await fs.writeFile(filePath, updated, 'utf8');
          console.log(` ${rel}: fixed ${fileChanges} spell link(s)`);
        } else {
          console.log(` ${rel}: would fix ${fileChanges} spell link(s)`);
          for (const c of sampleChanges) {
            console.log(`   - ${c.name}: ${c.currentId} -> ${c.expectedId}`);
          }
        }
      }
    }
  }

  console.log(`\nScanned anchors: ${totalAnchors}`);
  console.log(`Total fixes: ${totalChanges}`);
  console.log(`Files touched: ${filesTouched}`);

  if (!write && totalChanges > 0) {
    console.log(`\nRun with --write to apply changes.`);
  }
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
</file>

<file path="check_connection.ts">
import { prisma } from './src/lib/prisma';

async function checkConnection() {
  const count = await prisma.pers.count();
  console.log(`Pers count: ${count}`);
}

checkConnection()
  .catch(e => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
</file>

<file path="check_pers_data.ts">
import "dotenv/config";

import { prisma } from "./src/lib/prisma";

async function checkPers() {
  const persIdArg = process.argv[2];
  const persId = persIdArg ? Number(persIdArg) : 3;

  if (!Number.isFinite(persId) || persId <= 0) {
    throw new Error(`Invalid persId: ${persIdArg}`);
  }

  const pers = await prisma.pers.findUnique({
    where: { persId },
    include: {
      class: true,
      race: true,
      background: true,
      skills: true,
      armors: {
        include: {
          armor: true
        }
      },
      weapons: {
        include: {
          weapon: true
        }
      },
      feats: {
        include: {
          feat: true,
          choices: {
            include: {
              choiceOption: true
            }
          }
        }
      },
      features: {
        include: {
          feature: true
        }
      },
      choiceOptions: true
    }
  });

  console.log(JSON.stringify(pers, null, 2));
}

checkPers()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "src/app/globals.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "iconLibrary": "lucide",
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "registries": {}
}
</file>

<file path="defined_features.txt">
Acid Resistance
Adrenaline Rush
Amorphous
Amphibious
Animal Enhancements
Animal Friendship
Arboreal Alertness
Arcane Lock
Armor of Agathys
Armored Casing
Artificer\
Artisan\
Astral Fire
Astral Knowledge
Astral Spark
Astral Trance
Bestial Instincts
Bite
Black Blood Healing
Blade Ward
Blessing of the Moon Weaver
Blessing of the Raven Queen
Branding Smite
Brave
Breath Weapon (Acid - Line)
Breath Weapon (Acid)
Breath Weapon (Cold - Cone)
Breath Weapon (Cold)
Breath Weapon (Fire - Cone)
Breath Weapon (Fire - Line)
Breath Weapon (Fire, Cone)
Breath Weapon (Fire, Line)
Breath Weapon (Lightning - Line)
Breath Weapon (Lightning)
Breath Weapon (Poison - Cone)
Breath Weapon (Poison)
Built for Success
Burning Hands
Call to the Wave
Cat\
Celestial Resistance
Celestial Revelation
Chameleon Carapace
Charge
Charm Person
Child of the Sea
Chromatic Warding
Claws
Constructed Resilience
Control Air and Water
Create or Destroy Water
Crown of Madness
Cunning Intuition
Dancing Lights
Darkness
Darkvision
Daunting Roar
Deathless Nature
Deductive Intuition
Detect Magic
Detect Thoughts
Dexterous Feet
Dhampir Deathless Nature
Disguise Self
Draconic Ancestry (Black)
Draconic Ancestry (Blue)
Draconic Ancestry (Brass)
Draconic Ancestry (Bronze)
Draconic Ancestry (Copper)
Draconic Ancestry (Gold)
Draconic Ancestry (Green)
Draconic Ancestry (Red)
Draconic Ancestry (Silver)
Draconic Ancestry (White)
Draconic Cry
Draconic Resistance
Drow Magic
Drow Weapon Training
Druidcraft
Dual Mind
Duergar Magic
Duergar Resilience
Dwarven Armor Training
Dwarven Combat Training
Dwarven Resilience
Dwarven Tool Proficiency
Dwarven Toughness
Earth Walk
Eerie Token
Elf Weapon Training
Emissary of the Sea
Enlarge/Reduce
Enthrall
Equine Build
Ever-Hospitable
Expert Duplication
Extra Language
Faerie Fire
Fairy Magic
Fearless
Feather Fall
Feline Agility
Fey Ancestry
Fey Gift
Fey Step
Fey Step (DMG)
Finder\
Firbolg Magic
Firearms Mastery
Flame Blade
Flaming Sphere
Flight
Fog Cloud
Fortune from the Many
Friend of the Sea
Friends
Fury of the Small
Gem Flight
Gift of the Svirfneblin
Gifted Scribe
Githyanki Psionics
Githzerai Psionics
Glide
Gnome Cunning
Gnomish Magic Resistance
Goring Rush
Guardian of the Depths
Guardian\
Gust of Wind
Hadozee Resilience
Halfling Nimbleness
Halfling Resilience
Hammering Horns
Hare-Trigger
Headwinds
Healing Hands
Healing Machine
Healing Touch
Hellish Rebuke
Hellish Resistance
Hex
Hex Magic
Hidden Step
High Elf Cantrip
Hippo Build
Hold Breath
Hooves
Horns
Hungry Jaws
Hunter\
Incisive Sense
Infernal Legacy
Infernal Legacy (Asmodeus)
Infernal Legacy (Baalzebul)
Infernal Legacy (Devil\
Infernal Legacy (Dispater)
Infernal Legacy (Fierna)
Infernal Legacy (Glasya)
Infernal Legacy (Hellfire)
Infernal Legacy (Levistus)
Infernal Legacy (Mammon)
Infernal Legacy (Mephistopheles)
Infernal Legacy (Zariel)
Ingenious
Innkeeper\
Integrated Protection
Intuition of the Voyager
Invisibility
Jump
Kalashtar Mental Discipline
Keen Senses
Keen Smell
Kender Aptitude
Kenku Recall
Knowledge from a Past Life
Labyrinthine Recall
Leonin Claws
Leporine Senses
Leviathan Will
Levitate
Light
Light Bearer
Lightning Resistance
Limited Amphibiousness
Limited Telepathy
Little Giant
Locathah Natural Armor
Long-Limbed
Loxodon Natural Armor
Loxodon Serenity
Lucky
Lucky Footwork
Mage Hand
Magic Resistance
Magical Detection
Magical Passage
Maker\
Mask of the Wild
Mechanical Nature
Medical Intuition
Menacing
Mental Discipline
Merge with Stone
Metallic Breath Weapon
Mimicry
Mind Link
Mingle with the Wind
Minor Illusion
Mirthful Leaps
Misty Step
Mountain Born
Natural Armor
Natural Illusionist
Natural Instinct
Natural Resilience
Naturally Stealthy
Nature\
Necrotic Resistance
Necrotic Shroud
Nimble
Nimble Escape
Nimbleness
Nondetection
Observant and Athletic
Partially Amphibious
Pass without Trace
Persuasive
Poison Immunity
Poison Resilience
Poison Spray
Poisonous Skin
Powerful Build
Primal Connection
Produce Flame
Psionic Fortitude
Psionic Mind
Psychic Resilience
Rabbit Hop
Radiant Consumption
Radiant Soul
Ram
Ray of Frost
Ray of Sickness
Reach to the Blaze
Relentless Endurance
Reveler
Savage Attacks
Scaled Body
Scribe\
Sea Elf Training
Searing Smite
Secondary Arms
Sentinel\
Sentry\
Serpentine Spellcasting
Severed from Dreams
Shape Self
Shape Shadows
Shape Water
Shapechanger
Shell Armor
Shell Defense
Shield
Shifting
Shifting: Beasthide
Shifting: Longtooth
Shifting: Swiftstride
Shifting: Wildhunt
Shocking Grasp
Silent Feathers
Silent Speech
Sleep
Sleepless
Sneaky
Speak with Small Beasts
Specialized Design
Speech of Beast and Leaf
Spells of the Mark (Detection)
Spells of the Mark (Finding)
Spells of the Mark (Handling)
Spells of the Mark (Healing)
Spells of the Mark (Hospitality)
Spells of the Mark (Making)
Spells of the Mark (Passage)
Spells of the Mark (Scribing)
Spells of the Mark (Sentinel)
Spells of the Mark (Shadow)
Spells of the Mark (Storm)
Spells of the Mark (Warding)
Spellsmith
Spider Climb
Standing Leap
Starlight Step
Stone Camouflage
Stone\
Stonecunning
Storm\
Stout Resilience
Suggestion
Sunlight Sensitivity
Superior Darkvision
Superior Darkvision (Deep Gnome)
Superior Darkvision (Drow)
Superior Darkvision (Duergar)
Surprise Attack
Svirfneblin Camouflage
Talons
Taunt
Telepathic Insight
Tenser\
Thaumaturgy
The Bigger They Are
Thri-kreen Telepathy
Tinker
Tireless Precision
Trance
Trunk
Unending Breath
Vampiric Bite
Vedalken Dispassion
Vicious Mockery
Vigilant Guardian
Warder\
Wards and Seals
Warforged Specialized Design
Water Breathing
Water Dependency
Water Walk
Wild Intuition
Wind Caller
Windwright\
Winged Tiefling
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
</file>

<file path="postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="referenced_features.txt">
Breath Weapon (Acid - Line)
Breath Weapon (Cold - Cone)
Breath Weapon (Fire - Cone)
Breath Weapon (Fire - Line)
Breath Weapon (Lightning - Line)
Breath Weapon (Poison - Cone)
Child of the Sea
Draconic Ancestry (Black)
Draconic Ancestry (Blue)
Draconic Ancestry (Brass)
Draconic Ancestry (Bronze)
Draconic Ancestry (Copper)
Draconic Ancestry (Gold)
Draconic Ancestry (Green)
Draconic Ancestry (Red)
Draconic Ancestry (Silver)
Draconic Ancestry (White)
Drow Magic
Elf Weapon Training
Fleet of Foot
High Elf Cantrip
Mask of the Wild
Necrotic Shroud
Radiant Consumption
Radiant Soul
Shifting: Beasthide
Shifting: Longtooth
Shifting: Swiftstride
Shifting: Wildhunt
</file>

<file path="test_pg.js">
const { Pool } = require('pg');
require('dotenv').config();

const pool = new Pool({ connectionString: process.env.DATABASE_URL });

async function test() {
  console.log('Connecting to:', process.env.DATABASE_URL.replace(/:[^:@]+@/, ':***@'));
  try {
    const start = Date.now();
    const client = await pool.connect();
    console.log('Connected in', Date.now() - start, 'ms');
    const res = await client.query('SELECT NOW()');
    console.log('Query result:', res.rows[0]);
    client.release();
  } catch (err) {
    console.error('Connection error:', err.message);
    console.error(err);
  } finally {
    await pool.end();
  }
}

test();
</file>

<file path="todo">
        .  
</file>

<file path=".cursor/rules/ukr-translation.mdc">
---
alwaysApply: true
---
/**
 *         prettier,     Prisma     '   .
*    \n\n    (      )
* 
 * #    (D&D 5e)
 *
 * ##  :
 * -     "".
 * -  proficiency      .
 * -    :
 *   - "as a bonus action"   
 *   - "as an action"  
 *   - "as reaction"  
 *   - Dash  
 *   - Disengage  
 *   - Hide  
 *   - Proficiency Bonus   
 *   - Proficiency  
 *   - spell slots   
 *   - cantrip  
 *   - spell known / prepared  ,    / ,   
 *   - Infusion  
 *   - Artificer's Spellcasting   
 *   - Magical Tinkering   
 *   - Infuse Item    
*    - Stealth - 
*    - Perception - 
*    - Investigation - 
 *
 * ##     :
 *         :
 * -      ,  (    ):
 *   "  [Magic Missile]"
 * -       givesSpells   eng_name   .
 *
 * ##  :
 * - shortDescription: ,   ,    (     ,   ,      -   (Huge, 15x15 .)).
 * - description:   ,      D&D UA ,   .
 * -      "+", : "+2"  "+26".
 * - : "3 per day"  "3   ".
 *
 * ## :
 * -      - (     ).
 * - -     (" ", " ").
 *
 * ---
 *
 * ##  :
 * -    , NPC, ,         ( ,      ).
 * -        Wizards of the Coast.    
 * -           .
 *
 * ---
 *
 * #    :
 * {
 *   "name": " ",
 *   "engName": "Magical Tinkering",
 *   "shortDescription": "         .",
 *   "description": "  1 ,     .         , -    .       .",
 *   "displayType": [FeatureDisplayType.ACTIVE],
 * }
 *
 * #   :
 * givesSpells: [
 *   {
 *     "spell_id": 1352,
 *     "eng_name": "Mage Hand",
 *     "name": "  [Mage Hand]"
 *   }
 * ]
 *
 */


 #       
[
  {
    "spell_id": 1073,
    "eng_name": "Animal shapes",
    "name": "  [Animal shapes]"
  },
  {
    "spell_id": 1084,
    "eng_name": "Incendiary Cloud",
    "name": "  [Incendiary Cloud]"
  },
  {
    "spell_id": 1194,
    "eng_name": "Conjure Minor Elementals",
    "name": "'   [Conjure Minor Elementals]"
  },
  {
    "spell_id": 1347,
    "eng_name": "Guidance",
    "name": " [Guidance]"
  },
  {
    "spell_id": 1344,
    "eng_name": "Message",
    "name": " [Message]"
  },
  {
    "spell_id": 1177,
    "eng_name": "Phantasmal Killer",
    "name": "  [Phantasmal Killer]"
  },
  {
    "spell_id": 1350,
    "eng_name": "Dancing Lights",
    "name": "  [Dancing Lights]"
  },
  {
    "spell_id": 1322,
    "eng_name": "Feather Fall",
    "name": " ' [Feather Fall]"
  },
  {
    "spell_id": 1043,
    "eng_name": "Thunderwave",
    "name": "  [Thunderwave]"
  },
  {
    "spell_id": 1068,
    "eng_name": "Wish",
    "name": " [Wish]"
  },
  {
    "spell_id": 1066,
    "eng_name": "Prismatic Wall",
    "name": "  [Prismatic Wall]"
  },
  {
    "spell_id": 1307,
    "eng_name": "Jump",
    "name": " [Jump]"
  },
  {
    "spell_id": 1552,
    "eng_name": "Conjure Barrage",
    "name": "  [Conjure Barrage]"
  },
  {
    "spell_id": 1553,
    "eng_name": "Crusader's Mantle",
    "name": "  [Crusader's Mantle]"
  },
  {
    "spell_id": 1136,
    "eng_name": "True Seeing",
    "name": "  [True Seeing]"
  },
  {
    "spell_id": 1085,
    "eng_name": "Glibness",
    "name": " [Glibness]"
  },
  {
    "spell_id": 1088,
    "eng_name": "Teleport",
    "name": " [Teleport]"
  },
  {
    "spell_id": 1250,
    "eng_name": "Darkvision",
    "name": "  [Darkvision]"
  },
  {
    "spell_id": 1161,
    "eng_name": "Mass Cure Wounds",
    "name": "   [Mass Cure Wounds]"
  },
  {
    "spell_id": 1547,
    "eng_name": "Hail of Thorns",
    "name": "  [Hail of Thorns]"
  },
  {
    "spell_id": 1548,
    "eng_name": "Beast Sense",
    "name": "  [Beast Sense]"
  },
  {
    "spell_id": 1554,
    "eng_name": "Lightning Arrow",
    "name": "  [Lightning Arrow]"
  },
  {
    "spell_id": 1041,
    "eng_name": "Faerie fire",
    "name": "  [Faerie fire]"
  },
  {
    "spell_id": 1556,
    "eng_name": "Grasping Vine",
    "name": "  [Grasping Vine]"
  },
  {
    "spell_id": 1561,
    "eng_name": "Telepathy",
    "name": " [Telepathy]"
  },
  {
    "spell_id": 1316,
    "eng_name": "Identify",
    "name": " [Identify]"
  },
  {
    "spell_id": 1311,
    "eng_name": "Grease",
    "name": " [Grease]"
  },
  {
    "spell_id": 1332,
    "eng_name": "Disguise Self",
    "name": " [Disguise Self]"
  },
  {
    "spell_id": 1306,
    "eng_name": "Alarm",
    "name": " [Alarm]"
  },
  {
    "spell_id": 1269,
    "eng_name": "Enhance Ability",
    "name": "  [Enhance Ability]"
  },
  {
    "spell_id": 1258,
    "eng_name": "Heat Metal",
    "name": "  [Heat Metal]"
  },
  {
    "spell_id": 1046,
    "eng_name": "Detect Poison and Disease",
    "name": "    [Detect Poison and Disease]"
  },
  {
    "spell_id": 1221,
    "eng_name": "Fly",
    "name": " [Fly]"
  },
  {
    "spell_id": 1491,
    "eng_name": "Elemental Weapon",
    "name": "  [Elemental Weapon]"
  },
  {
    "spell_id": 1211,
    "eng_name": "Create Food and Water",
    "name": "    [Create Food and Water]"
  },
  {
    "spell_id": 1184,
    "eng_name": "Freedom of Movement",
    "name": "  [Freedom of Movement]"
  },
  {
    "spell_id": 1555,
    "eng_name": "Aura of Purity",
    "name": "  [Aura of Purity]"
  },
  {
    "spell_id": 1327,
    "eng_name": "Expeditious Retreat",
    "name": "  [Expeditious Retreat]"
  },
  {
    "spell_id": 1206,
    "eng_name": "Water Walk",
    "name": "   [Water Walk]"
  },
  {
    "spell_id": 1277,
    "eng_name": "Suggestion",
    "name": " [Suggestion]"
  },
  {
    "spell_id": 1345,
    "eng_name": "Poison Spray",
    "name": "  [Poison Spray]"
  },
  {
    "spell_id": 1346,
    "eng_name": "Resistance",
    "name": " [Resistance]"
  },
  {
    "spell_id": 1457,
    "eng_name": "Staggering Smite",
    "name": "  [Staggering Smite]"
  },
  {
    "spell_id": 1048,
    "eng_name": "Detect evil and good",
    "name": "    [Detect evil and good]"
  },
  {
    "spell_id": 1453,
    "eng_name": "Wrathful Smite",
    "name": "  [Wrathful Smite]"
  },
  {
    "spell_id": 1141,
    "eng_name": "Wall of Stone",
    "name": "   [Wall of Stone]"
  },
  {
    "spell_id": 1363,
    "eng_name": "Flame blade",
    "name": "  [Flame blade]"
  },
  {
    "spell_id": 1057,
    "eng_name": "Vampiric Touch",
    "name": "  [Vampiric Touch]"
  },
  {
    "spell_id": 1049,
    "eng_name": "Illusory Script",
    "name": "  [Illusory Script]"
  },
  {
    "spell_id": 1044,
    "eng_name": "Bless",
    "name": " [Bless]"
  },
  {
    "spell_id": 1495,
    "eng_name": "Compelled Duel",
    "name": "   [Compelled Duel]"
  },
  {
    "spell_id": 1052,
    "eng_name": "Shocking Grasp",
    "name": "  [Shocking Grasp]"
  },
  {
    "spell_id": 1062,
    "eng_name": "Foresight",
    "name": " [Foresight]"
  },
  {
    "spell_id": 1047,
    "eng_name": "Heroism",
    "name": " [Heroism]"
  },
  {
    "spell_id": 1496,
    "eng_name": "Dissonant Whispers",
    "name": "  [Dissonant Whispers]"
  },
  {
    "spell_id": 1157,
    "eng_name": "Raise Dead",
    "name": "  [Raise Dead]"
  },
  {
    "spell_id": 1053,
    "eng_name": "Produce Flame",
    "name": "  [Produce Flame]"
  },
  {
    "spell_id": 1054,
    "eng_name": "True Strike",
    "name": "  [True Strike]"
  },
  {
    "spell_id": 1149,
    "eng_name": "Dominate Person",
    "name": "  [Dominate Person]"
  },
  {
    "spell_id": 1500,
    "eng_name": "Arms of Hadar",
    "name": "  [Arms of Hadar]"
  },
  {
    "spell_id": 1144,
    "eng_name": "Scrying",
    "name": " [Scrying]"
  },
  {
    "spell_id": 1139,
    "eng_name": "Telekinesis",
    "name": " [Telekinesis]"
  },
  {
    "spell_id": 1070,
    "eng_name": "True Polymorph",
    "name": "  [True Polymorph]"
  },
  {
    "spell_id": 1281,
    "eng_name": "Lesser Restoration",
    "name": "  [Lesser Restoration]"
  },
  {
    "spell_id": 1186,
    "eng_name": "Compulsion",
    "name": " [Compulsion]"
  },
  {
    "spell_id": 1181,
    "eng_name": "Wall of Fire",
    "name": "  [Wall of Fire]"
  },
  {
    "spell_id": 1241,
    "eng_name": "Water Breathing",
    "name": "  [Water Breathing]"
  },
  {
    "spell_id": 1190,
    "eng_name": "Ice Storm",
    "name": "  [Ice Storm]"
  },
  {
    "spell_id": 1055,
    "eng_name": "Light",
    "name": " [Light]"
  },
  {
    "spell_id": 1497,
    "eng_name": "Armor of Agathys",
    "name": "  [Armor of Agathys]"
  },
  {
    "spell_id": 1308,
    "eng_name": "Create or Destroy Water",
    "name": "    [Create or Destroy Water]"
  },
  {
    "spell_id": 1056,
    "eng_name": "Sacred Flame",
    "name": " ' [Sacred Flame]"
  },
  {
    "spell_id": 1296,
    "eng_name": "Mirror Image",
    "name": " [Mirror Image]"
  },
  {
    "spell_id": 1058,
    "eng_name": "Power Word Kill",
    "name": " :  [Power Word Kill]"
  },
  {
    "spell_id": 1271,
    "eng_name": "Flaming Sphere",
    "name": "  [Flaming Sphere]"
  },
  {
    "spell_id": 1080,
    "eng_name": "Maze",
    "name": " [Maze]"
  },
  {
    "spell_id": 1338,
    "eng_name": "Inflict Wounds",
    "name": "  [Inflict Wounds]"
  },
  {
    "spell_id": 1530,
    "eng_name": "Power Word Heal",
    "name": " :  [Power Word Heal]"
  },
  {
    "spell_id": 1242,
    "eng_name": "Daylight",
    "name": "  [Daylight]"
  },
  {
    "spell_id": 1501,
    "eng_name": "Crown of Madness",
    "name": "  [Crown of Madness]"
  },
  {
    "spell_id": 1278,
    "eng_name": "Moonbeam",
    "name": "  [Moonbeam]"
  },
  {
    "spell_id": 1260,
    "eng_name": "Spike Growth",
    "name": "  [Spike Growth]"
  },
  {
    "spell_id": 1276,
    "eng_name": "Invisibility",
    "name": " [Invisibility]"
  },
  {
    "spell_id": 1249,
    "eng_name": "Darkness",
    "name": " [Darkness]"
  },
  {
    "spell_id": 1231,
    "eng_name": "Magic Circle",
    "name": "  [Magic Circle]"
  },
  {
    "spell_id": 1503,
    "eng_name": "Chromatic Orb",
    "name": "  [Chromatic Orb]"
  },
  {
    "spell_id": 1509,
    "eng_name": "Nystul's Magic Aura",
    "name": "   [Nystul's Magic Aura]"
  },
  {
    "spell_id": 1155,
    "eng_name": "Hallow",
    "name": " [Hallow]"
  },
  {
    "spell_id": 1229,
    "eng_name": "Beacon of Hope",
    "name": "  [Beacon of Hope]"
  },
  {
    "spell_id": 1518,
    "eng_name": "Otiluke's Resilient Sphere",
    "name": "   [Otiluke's Resilient Sphere]"
  },
  {
    "spell_id": 1191,
    "eng_name": "Control Water",
    "name": "  [Control Water]"
  },
  {
    "spell_id": 1522,
    "eng_name": "Rary's Telepathic Bond",
    "name": " '  [Rary's Telepathic Bond]"
  },
  {
    "spell_id": 1504,
    "eng_name": "Tenser's Floating Disk",
    "name": "   [Tenser's Floating Disk]"
  },
  {
    "spell_id": 1513,
    "eng_name": "Leomund's Tiny Hut",
    "name": "   [Leomund's Tiny Hut]"
  },
  {
    "spell_id": 1505,
    "eng_name": "Witch Bolt",
    "name": "  [Witch Bolt]"
  },
  {
    "spell_id": 1506,
    "eng_name": "Cloud of Daggers",
    "name": "  [Cloud of Daggers]"
  },
  {
    "spell_id": 1510,
    "eng_name": "Aura of Vitality",
    "name": "  [Aura of Vitality]"
  },
  {
    "spell_id": 1524,
    "eng_name": "Arcane Gate",
    "name": "  [Arcane Gate]"
  },
  {
    "spell_id": 1529,
    "eng_name": "Tsunami",
    "name": " [Tsunami]"
  },
  {
    "spell_id": 1515,
    "eng_name": "Evard's Black Tentacles",
    "name": "   [Evard's Black Tentacles]"
  },
  {
    "spell_id": 1520,
    "eng_name": "Conjure Volley",
    "name": "  [Conjure Volley]"
  },
  {
    "spell_id": 1521,
    "eng_name": "Destructive Wave",
    "name": "  [Destructive Wave]"
  },
  {
    "spell_id": 1511,
    "eng_name": "Feign Death",
    "name": "  [Feign Death]"
  },
  {
    "spell_id": 1528,
    "eng_name": "Mordenkainen's Magnificent Mansion",
    "name": "   [Mordenkainen's Magnificent Mansion]"
  },
  {
    "spell_id": 1060,
    "eng_name": "Meteor Swarm",
    "name": "  [Meteor Swarm]"
  },
  {
    "spell_id": 1537,
    "eng_name": "Mordenkainen's Sword",
    "name": "  [Mordenkainen's Sword]"
  },
  {
    "spell_id": 1272,
    "eng_name": "Spider Climb",
    "name": "  [Spider Climb]"
  },
  {
    "spell_id": 1302,
    "eng_name": "Shield",
    "name": " [Shield]"
  },
  {
    "spell_id": 1283,
    "eng_name": "Magic Weapon",
    "name": "  [Magic Weapon]"
  },
  {
    "spell_id": 1295,
    "eng_name": "Continual Flame",
    "name": " ' [Continual Flame]"
  },
  {
    "spell_id": 1312,
    "eng_name": "Longstrider",
    "name": " [Longstrider]"
  },
  {
    "spell_id": 1352,
    "eng_name": "Mage Hand",
    "name": "  [Mage Hand]"
  },
  {
    "spell_id": 1353,
    "eng_name": "Mending",
    "name": " [Mending]"
  },
  {
    "spell_id": 1061,
    "eng_name": "Shapechange",
    "name": " [Shapechange]"
  },
  {
    "spell_id": 1063,
    "eng_name": "Mass Heal",
    "name": "  [Mass Heal]"
  },
  {
    "spell_id": 1064,
    "eng_name": "Time Stop",
    "name": "  [Time Stop]"
  },
  {
    "spell_id": 1065,
    "eng_name": "Weird",
    "name": " [Weird]"
  },
  {
    "spell_id": 1069,
    "eng_name": "Astral Projection",
    "name": "  [Astral Projection]"
  },
  {
    "spell_id": 1071,
    "eng_name": "True Resurrection",
    "name": "  [True Resurrection]"
  },
  {
    "spell_id": 1072,
    "eng_name": "Mind Blank",
    "name": "  [Mind Blank]"
  },
  {
    "spell_id": 1313,
    "eng_name": "Sanctuary",
    "name": " [Sanctuary]"
  },
  {
    "spell_id": 1074,
    "eng_name": "Sunburst",
    "name": "  [Sunburst]"
  },
  {
    "spell_id": 1076,
    "eng_name": "Feeblemind",
    "name": " [Feeblemind]"
  },
  {
    "spell_id": 1263,
    "eng_name": "Locate Animals or Plants",
    "name": "    [Locate Animals or Plants]"
  },
  {
    "spell_id": 1078,
    "eng_name": "Dominate Monster",
    "name": "  [Dominate Monster]"
  },
  {
    "spell_id": 1137,
    "eng_name": "Flesh to Stone",
    "name": "    [Flesh to Stone]"
  },
  {
    "spell_id": 1081,
    "eng_name": "Control Weather",
    "name": "  [Control Weather]"
  },
  {
    "spell_id": 1082,
    "eng_name": "Clone",
    "name": " [Clone]"
  },
  {
    "spell_id": 1104,
    "eng_name": "Prismatic Spray",
    "name": "  [Prismatic Spray]"
  },
  {
    "spell_id": 1095,
    "eng_name": "Project Image",
    "name": "  [Project Image]"
  },
  {
    "spell_id": 1087,
    "eng_name": "Sequester",
    "name": " [Sequester]"
  },
  {
    "spell_id": 1089,
    "eng_name": "Mirage Arcane",
    "name": "  [Mirage Arcane]"
  },
  {
    "spell_id": 1204,
    "eng_name": "Greater Invisibility",
    "name": "  [Greater Invisibility]"
  },
  {
    "spell_id": 1092,
    "eng_name": "Forcecage",
    "name": "  [Forcecage]"
  },
  {
    "spell_id": 1094,
    "eng_name": "Regenerate",
    "name": " [Regenerate]"
  },
  {
    "spell_id": 1098,
    "eng_name": "Reverse Gravity",
    "name": "  [Reverse Gravity]"
  },
  {
    "spell_id": 1100,
    "eng_name": "Etherealness",
    "name": " [Etherealness]"
  },
  {
    "spell_id": 1040,
    "eng_name": "Fire Bolt",
    "name": "  [Fire Bolt]"
  },
  {
    "spell_id": 1101,
    "eng_name": "Resurrection",
    "name": " [Resurrection]"
  },
  {
    "spell_id": 1102,
    "eng_name": "Fire Storm",
    "name": "  [Fire Storm]"
  },
  {
    "spell_id": 1134,
    "eng_name": "Guards and Wards",
    "name": "   [Guards and Wards]"
  },
  {
    "spell_id": 1106,
    "eng_name": "Arcane Sword",
    "name": "  [Arcane Sword]"
  },
  {
    "spell_id": 1107,
    "eng_name": "Harm",
    "name": " [Harm]"
  },
  {
    "spell_id": 1108,
    "eng_name": "Globe of Invulnerability",
    "name": "  [Globe of Invulnerability]"
  },
  {
    "spell_id": 1109,
    "eng_name": "Wall of Thorns",
    "name": "  [Wall of Thorns]"
  },
  {
    "spell_id": 1116,
    "eng_name": "Eyebite",
    "name": "  [Eyebite]"
  },
  {
    "spell_id": 1131,
    "eng_name": "Heal",
    "name": " [Heal]"
  },
  {
    "spell_id": 1111,
    "eng_name": "Create Undead",
    "name": "  [Create Undead]"
  },
  {
    "spell_id": 1113,
    "eng_name": "Word of Recall",
    "name": "  [Word of Recall]"
  },
  {
    "spell_id": 1115,
    "eng_name": "Disintegrate",
    "name": " [Disintegrate]"
  },
  {
    "spell_id": 1117,
    "eng_name": "Wind Walk",
    "name": "   [Wind Walk]"
  },
  {
    "spell_id": 1042,
    "eng_name": "Divine Favor",
    "name": "  [Divine Favor]"
  },
  {
    "spell_id": 1121,
    "eng_name": "Transport via Plants",
    "name": "   [Transport via Plants]"
  },
  {
    "spell_id": 1122,
    "eng_name": "Contingency",
    "name": " [Contingency]"
  },
  {
    "spell_id": 1135,
    "eng_name": "Heroes' Feast",
    "name": "  [Heroes' Feast]"
  },
  {
    "spell_id": 1129,
    "eng_name": "Circle of Death",
    "name": "  [Circle of Death]"
  },
  {
    "spell_id": 1130,
    "eng_name": "Blade Barrier",
    "name": " ' [Blade Barrier]"
  },
  {
    "spell_id": 1132,
    "eng_name": "Forbiddance",
    "name": " [Forbiddance]"
  },
  {
    "spell_id": 1133,
    "eng_name": "Conjure Fey",
    "name": "'  [Conjure Fey]"
  },
  {
    "spell_id": 1140,
    "eng_name": "Creation",
    "name": " [Creation]"
  },
  {
    "spell_id": 1143,
    "eng_name": "Hold Monster",
    "name": "  [Hold Monster]"
  },
  {
    "spell_id": 1168,
    "eng_name": "Contact Other Plane",
    "name": "'    [Contact Other Plane]"
  },
  {
    "spell_id": 1147,
    "eng_name": "Dispel Evil and Good",
    "name": "    [Dispel Evil and Good]"
  },
  {
    "spell_id": 1150,
    "eng_name": "Awaken",
    "name": " [Awaken]"
  },
  {
    "spell_id": 1152,
    "eng_name": "Seeming",
    "name": " [Seeming]"
  },
  {
    "spell_id": 1154,
    "eng_name": "Mislead",
    "name": " [Mislead]"
  },
  {
    "spell_id": 1153,
    "eng_name": "Planar Binding",
    "name": "  [Planar Binding]"
  },
  {
    "spell_id": 1158,
    "eng_name": "Geas",
    "name": " [Geas]"
  },
  {
    "spell_id": 1159,
    "eng_name": "Antilife shell",
    "name": "   [Antilife shell]"
  },
  {
    "spell_id": 1164,
    "eng_name": "Legend Lore",
    "name": "  [Legend Lore]"
  },
  {
    "spell_id": 1163,
    "eng_name": "Teleportation Circle",
    "name": "  [Teleportation Circle]"
  },
  {
    "spell_id": 1304,
    "eng_name": "False life",
    "name": "  [False life]"
  },
  {
    "spell_id": 1171,
    "eng_name": "Tree Stride",
    "name": "  [Tree Stride]"
  },
  {
    "spell_id": 1170,
    "eng_name": "Conjure Elemental",
    "name": "'  [Conjure Elemental]"
  },
  {
    "spell_id": 1176,
    "eng_name": "Stone Shape",
    "name": "  [Stone Shape]"
  },
  {
    "spell_id": 1178,
    "eng_name": "Hallucinatory Terrain",
    "name": "  [Hallucinatory Terrain]"
  },
  {
    "spell_id": 1174,
    "eng_name": "Arcane Hand",
    "name": "  [Arcane Hand]"
  },
  {
    "spell_id": 1156,
    "eng_name": "Animate objects",
    "name": "  [Animate objects]"
  },
  {
    "spell_id": 1195,
    "eng_name": "Conjure Woodland Beings",
    "name": "'   [Conjure Woodland Beings]"
  },
  {
    "spell_id": 1192,
    "eng_name": "Stoneskin",
    "name": "'  [Stoneskin]"
  },
  {
    "spell_id": 1203,
    "eng_name": "Guardian of Faith",
    "name": "  [Guardian of Faith]"
  },
  {
    "spell_id": 1188,
    "eng_name": "Locate Creature",
    "name": "  [Locate Creature]"
  },
  {
    "spell_id": 1200,
    "eng_name": "Fire Shield",
    "name": "  [Fire Shield]"
  },
  {
    "spell_id": 1196,
    "eng_name": "Dimension Door",
    "name": "   [Dimension Door]"
  },
  {
    "spell_id": 1198,
    "eng_name": "Divination",
    "name": " [Divination]"
  },
  {
    "spell_id": 1207,
    "eng_name": "phantom steed",
    "name": "  [phantom steed]"
  },
  {
    "spell_id": 1201,
    "eng_name": "Fabricate",
    "name": " [Fabricate]"
  },
  {
    "spell_id": 1202,
    "eng_name": "Banishment",
    "name": " [Banishment]"
  },
  {
    "spell_id": 1209,
    "eng_name": "Wind Wall",
    "name": "  [Wind Wall]"
  },
  {
    "spell_id": 1212,
    "eng_name": "Stinking Cloud",
    "name": "  [Stinking Cloud]"
  },
  {
    "spell_id": 1210,
    "eng_name": "Fear",
    "name": " [Fear]"
  },
  {
    "spell_id": 1215,
    "eng_name": "Speak with Dead",
    "name": "   [Speak with Dead]"
  },
  {
    "spell_id": 1270,
    "eng_name": "Pass without Trace",
    "name": "   [Pass without Trace]"
  },
  {
    "spell_id": 1305,
    "eng_name": "Fog Cloud",
    "name": "  [Fog Cloud]"
  },
  {
    "spell_id": 1357,
    "eng_name": "Thaumaturgy",
    "name": " [Thaumaturgy]"
  },
  {
    "spell_id": 1224,
    "eng_name": "Nondetection",
    "name": " [Nondetection]"
  },
  {
    "spell_id": 1220,
    "eng_name": "Sending",
    "name": " [Sending]"
  },
  {
    "spell_id": 1219,
    "eng_name": "Haste",
    "name": " [Haste]"
  },
  {
    "spell_id": 1251,
    "eng_name": "Animal messenger",
    "name": "- [Animal messenger]"
  },
  {
    "spell_id": 1227,
    "eng_name": "Tongues",
    "name": " [Tongues]"
  },
  {
    "spell_id": 1225,
    "eng_name": "Call Lightning",
    "name": "  [Call Lightning]"
  },
  {
    "spell_id": 1236,
    "eng_name": "Protection from Energy",
    "name": "   [Protection from Energy]"
  },
  {
    "spell_id": 1238,
    "eng_name": "Sleet Storm",
    "name": " [Sleet Storm]"
  },
  {
    "spell_id": 1239,
    "eng_name": "Conjure Animals",
    "name": "'  [Conjure Animals]"
  },
  {
    "spell_id": 1243,
    "eng_name": "Hypnotic Pattern",
    "name": "  [Hypnotic Pattern]"
  },
  {
    "spell_id": 1252,
    "eng_name": "Branding Smite",
    "name": "  [Branding Smite]"
  },
  {
    "spell_id": 1248,
    "eng_name": "Silence",
    "name": " [Silence]"
  },
  {
    "spell_id": 1253,
    "eng_name": "Knock",
    "name": " [Knock]"
  },
  {
    "spell_id": 1256,
    "eng_name": "Scorching Ray",
    "name": "  [Scorching Ray]"
  },
  {
    "spell_id": 1254,
    "eng_name": "Hold Person",
    "name": "  [Hold Person]"
  },
  {
    "spell_id": 1265,
    "eng_name": "Locate Object",
    "name": "  [Locate Object]"
  },
  {
    "spell_id": 1261,
    "eng_name": "Augury",
    "name": " [Augury]"
  },
  {
    "spell_id": 1262,
    "eng_name": "Ray of Enfeeblement",
    "name": "  [Ray of Enfeeblement]"
  },
  {
    "spell_id": 1266,
    "eng_name": "Find Traps",
    "name": "  [Find Traps]"
  },
  {
    "spell_id": 1274,
    "eng_name": "Warding Bond",
    "name": " ' [Warding Bond]"
  },
  {
    "spell_id": 1286,
    "eng_name": "Melf's Acid arrow",
    "name": "   [Melf's Acid arrow]"
  },
  {
    "spell_id": 1287,
    "eng_name": "Zone of Truth",
    "name": "  [Zone of Truth]"
  },
  {
    "spell_id": 1292,
    "eng_name": "Spiritual Weapon",
    "name": "  [Spiritual Weapon]"
  },
  {
    "spell_id": 1288,
    "eng_name": "Alter self",
    "name": "  [Alter self]"
  },
  {
    "spell_id": 1297,
    "eng_name": "Detect Thoughts",
    "name": "  [Detect Thoughts]"
  },
  {
    "spell_id": 1300,
    "eng_name": "Arcane Lock",
    "name": "  [Arcane Lock]"
  },
  {
    "spell_id": 1294,
    "eng_name": "Shatter",
    "name": " [Shatter]"
  },
  {
    "spell_id": 1315,
    "eng_name": "Comprehend Languages",
    "name": "  [Comprehend Languages]"
  },
  {
    "spell_id": 1310,
    "eng_name": "Sleep",
    "name": " [Sleep]"
  },
  {
    "spell_id": 1320,
    "eng_name": "Hellish Rebuke",
    "name": "  [Hellish Rebuke]"
  },
  {
    "spell_id": 1323,
    "eng_name": "Purify Food and Drink",
    "name": "    [Purify Food and Drink]"
  },
  {
    "spell_id": 1493,
    "eng_name": "Bigby's Hand",
    "name": "  [Bigby's Hand]"
  },
  {
    "spell_id": 1494,
    "eng_name": "Friends",
    "name": " [Friends]"
  },
  {
    "spell_id": 1318,
    "eng_name": "Charm Person",
    "name": "  [Charm Person]"
  },
  {
    "spell_id": 1317,
    "eng_name": "Speak with Animals",
    "name": "   [Speak with Animals]"
  },
  {
    "spell_id": 1355,
    "eng_name": "Acid splash",
    "name": "  [Acid splash]"
  },
  {
    "spell_id": 1097,
    "eng_name": "Finger of Death",
    "name": "  [Finger of Death]"
  },
  {
    "spell_id": 1326,
    "eng_name": "Mage Armor",
    "name": "  [Mage Armor]"
  },
  {
    "spell_id": 1328,
    "eng_name": "Unseen Servant",
    "name": "  [Unseen Servant]"
  },
  {
    "spell_id": 1257,
    "eng_name": "Blur",
    "name": " [Blur]"
  },
  {
    "spell_id": 1329,
    "eng_name": "Command",
    "name": " [Command]"
  },
  {
    "spell_id": 1340,
    "eng_name": "Goodberry",
    "name": " [Goodberry]"
  },
  {
    "spell_id": 1341,
    "eng_name": "Druidcraft",
    "name": "  [Druidcraft]"
  },
  {
    "spell_id": 1336,
    "eng_name": "Bane",
    "name": " [Bane]"
  },
  {
    "spell_id": 1386,
    "eng_name": "Skywrite",
    "name": "  [Skywrite]"
  },
  {
    "spell_id": 1412,
    "eng_name": "Frostbite",
    "name": " [Frostbite]"
  },
  {
    "spell_id": 1379,
    "eng_name": "Snare",
    "name": " [Snare]"
  },
  {
    "spell_id": 1383,
    "eng_name": "Warding Wind",
    "name": "  [Warding Wind]"
  },
  {
    "spell_id": 1403,
    "eng_name": "Life Transference",
    "name": "  [Life Transference]"
  },
  {
    "spell_id": 1399,
    "eng_name": "Enemies Abound",
    "name": "  [Enemies Abound]"
  },
  {
    "spell_id": 1435,
    "eng_name": "Negative Energy Flood",
    "name": "   [Negative Energy Flood]"
  },
  {
    "spell_id": 1401,
    "eng_name": "Tiny Servant",
    "name": "  [Tiny Servant]"
  },
  {
    "spell_id": 1400,
    "eng_name": "Catnap",
    "name": " [Catnap]"
  },
  {
    "spell_id": 1404,
    "eng_name": "Wall of Sand",
    "name": "  [Wall of Sand]"
  },
  {
    "spell_id": 1415,
    "eng_name": "Magic Stone",
    "name": "  [Magic Stone]"
  },
  {
    "spell_id": 1423,
    "eng_name": "Charm Monster",
    "name": "  [Charm Monster]"
  },
  {
    "spell_id": 1417,
    "eng_name": "Guardian of Nature",
    "name": "  [Guardian of Nature]"
  },
  {
    "spell_id": 1431,
    "eng_name": "Control Winds",
    "name": "  [Control Winds]"
  },
  {
    "spell_id": 1126,
    "eng_name": "Magic Jar",
    "name": "  [Magic Jar]"
  },
  {
    "spell_id": 1426,
    "eng_name": "Storm Sphere",
    "name": "  [Storm Sphere]"
  },
  {
    "spell_id": 1434,
    "eng_name": "Skill Empowerment",
    "name": "  [Skill Empowerment]"
  },
  {
    "spell_id": 1459,
    "eng_name": "Beast Bond",
    "name": "  [Beast Bond]"
  },
  {
    "spell_id": 1416,
    "eng_name": "Gust",
    "name": " [Gust]"
  },
  {
    "spell_id": 1419,
    "eng_name": "Watery Sphere",
    "name": "  [Watery Sphere]"
  },
  {
    "spell_id": 1420,
    "eng_name": "Vitriolic Sphere",
    "name": "  [Vitriolic Sphere]"
  },
  {
    "spell_id": 1230,
    "eng_name": "Mass Healing Word",
    "name": "   [Mass Healing Word]"
  },
  {
    "spell_id": 1437,
    "eng_name": "Holy Weapon",
    "name": "  [Holy Weapon]"
  },
  {
    "spell_id": 1432,
    "eng_name": "Infernal Calling",
    "name": "  [Infernal Calling]"
  },
  {
    "spell_id": 1440,
    "eng_name": "Wall of Light",
    "name": "  [Wall of Light]"
  },
  {
    "spell_id": 1433,
    "eng_name": "Transmute Rock",
    "name": "  [Transmute Rock]"
  },
  {
    "spell_id": 1436,
    "eng_name": "Dawn",
    "name": " [Dawn]"
  },
  {
    "spell_id": 1441,
    "eng_name": "Danse Macabre",
    "name": "  [Danse Macabre]"
  },
  {
    "spell_id": 1463,
    "eng_name": "Zephyr Strike",
    "name": "  [Zephyr Strike]"
  },
  {
    "spell_id": 1354,
    "eng_name": "Shillelagh",
    "name": " [Shillelagh]"
  },
  {
    "spell_id": 1473,
    "eng_name": "Scatter",
    "name": " [Scatter]"
  },
  {
    "spell_id": 1475,
    "eng_name": "Tenser's Transformation",
    "name": "  [Tenser's Transformation]"
  },
  {
    "spell_id": 1474,
    "eng_name": "Create Homunculus",
    "name": "  [Create Homunculus]"
  },
  {
    "spell_id": 1476,
    "eng_name": "Whirlwind",
    "name": " [Whirlwind]"
  },
  {
    "spell_id": 1468,
    "eng_name": "Druid Grove",
    "name": "  [Druid Grove]"
  },
  {
    "spell_id": 1472,
    "eng_name": "Primordial Ward",
    "name": "  [Primordial Ward]"
  },
  {
    "spell_id": 1469,
    "eng_name": "Bones of the Earth",
    "name": "  [Bones of the Earth]"
  },
  {
    "spell_id": 1471,
    "eng_name": "Mental Prison",
    "name": " ' [Mental Prison]"
  },
  {
    "spell_id": 1477,
    "eng_name": "Power Word Pain",
    "name": " :  [Power Word Pain]"
  },
  {
    "spell_id": 1479,
    "eng_name": "Abi-Dalzim's Horrid Wilting",
    "name": " ' - [Abi-Dalzim's Horrid Wilting]"
  },
  {
    "spell_id": 1445,
    "eng_name": "Blade Ward",
    "name": "   [Blade Ward]"
  },
  {
    "spell_id": 1356,
    "eng_name": "Vicious Mockery",
    "name": "  [Vicious Mockery]"
  },
  {
    "spell_id": 1364,
    "eng_name": "Booming Blade",
    "name": "  [Booming Blade]"
  },
  {
    "spell_id": 1448,
    "eng_name": "Summon Construct",
    "name": "  [Summon Construct]"
  },
  {
    "spell_id": 1560,
    "eng_name": "Fizban's Platinum Shield",
    "name": "   [Fizban's Platinum Shield]"
  },
  {
    "spell_id": 1293,
    "eng_name": "Barkskin",
    "name": "  [Barkskin]"
  },
  {
    "spell_id": 1533,
    "eng_name": "Dark Star",
    "name": "  [Dark Star]"
  },
  {
    "spell_id": 1454,
    "eng_name": "Thunderous Smite",
    "name": "  [Thunderous Smite]"
  },
  {
    "spell_id": 1456,
    "eng_name": "Blinding Smite",
    "name": "  [Blinding Smite]"
  },
  {
    "spell_id": 1245,
    "eng_name": "Revivify",
    "name": " [Revivify]"
  },
  {
    "spell_id": 1514,
    "eng_name": "Aura of Life",
    "name": "  [Aura of Life]"
  },
  {
    "spell_id": 1193,
    "eng_name": "Death Ward",
    "name": "   [Death Ward]"
  },
  {
    "spell_id": 1543,
    "eng_name": "Wristpocket",
    "name": "  [Wristpocket]"
  },
  {
    "spell_id": 1369,
    "eng_name": "Infestation",
    "name": " [Infestation]"
  },
  {
    "spell_id": 1370,
    "eng_name": "Primal Savagery",
    "name": "  [Primal Savagery]"
  },
  {
    "spell_id": 1546,
    "eng_name": "Sapping Sting",
    "name": "  [Sapping Sting]"
  },
  {
    "spell_id": 1371,
    "eng_name": "Toll the Dead",
    "name": "  [Toll the Dead]"
  },
  {
    "spell_id": 1372,
    "eng_name": "Lightning Lure",
    "name": "  [Lightning Lure]"
  },
  {
    "spell_id": 1373,
    "eng_name": "Mind Sliver",
    "name": "  [Mind Sliver]"
  },
  {
    "spell_id": 1374,
    "eng_name": "Sword Burst",
    "name": "  [Sword Burst]"
  },
  {
    "spell_id": 1376,
    "eng_name": "Cause Fear",
    "name": "  [Cause Fear]"
  },
  {
    "spell_id": 1551,
    "eng_name": "Ashardalon's Stride",
    "name": "  [Ashardalon's Stride]"
  },
  {
    "spell_id": 1091,
    "eng_name": "Symbol",
    "name": " [Symbol]"
  },
  {
    "spell_id": 1385,
    "eng_name": "Maximilian's Earthen Grasp",
    "name": "   [Maximilian's Earthen Grasp]"
  },
  {
    "spell_id": 1389,
    "eng_name": "Earthbind",
    "name": "  [Earthbind]"
  },
  {
    "spell_id": 1381,
    "eng_name": "Shadow Blade",
    "name": "  [Shadow Blade]"
  },
  {
    "spell_id": 1422,
    "eng_name": "Find Greater Steed",
    "name": "   [Find Greater Steed]"
  },
  {
    "spell_id": 1391,
    "eng_name": "Mind Spike",
    "name": "  [Mind Spike]"
  },
  {
    "spell_id": 1390,
    "eng_name": "Pyrotechnics",
    "name": " [Pyrotechnics]"
  },
  {
    "spell_id": 1299,
    "eng_name": "See Invisibility",
    "name": "  [See Invisibility]"
  },
  {
    "spell_id": 1397,
    "eng_name": "Wall of Water",
    "name": "  [Wall of Water]"
  },
  {
    "spell_id": 1519,
    "eng_name": "Raulothim's Psychic Lance",
    "name": "   [Raulothim's Psychic Lance]"
  },
  {
    "spell_id": 1394,
    "eng_name": "Tasha's Mind Whip",
    "name": "   [Tasha's Mind Whip]"
  },
  {
    "spell_id": 1395,
    "eng_name": "Erupting Earth",
    "name": "  [Erupting Earth]"
  },
  {
    "spell_id": 1406,
    "eng_name": "Tidal Wave",
    "name": "  [Tidal Wave]"
  },
  {
    "spell_id": 1222,
    "eng_name": "Glyph of Warding",
    "name": "  [Glyph of Warding]"
  },
  {
    "spell_id": 1405,
    "eng_name": "Flame Arrows",
    "name": "  [Flame Arrows]"
  },
  {
    "spell_id": 1451,
    "eng_name": "Summon Celestial",
    "name": "  [Summon Celestial]"
  },
  {
    "spell_id": 1408,
    "eng_name": "Intellect Fortress",
    "name": "  [Intellect Fortress]"
  },
  {
    "spell_id": 1427,
    "eng_name": "Maelstrom",
    "name": " [Maelstrom]"
  },
  {
    "spell_id": 1460,
    "eng_name": "Catapult",
    "name": " [Catapult]"
  },
  {
    "spell_id": 1410,
    "eng_name": "Thunderclap",
    "name": "  [Thunderclap]"
  },
  {
    "spell_id": 1442,
    "eng_name": "Steel Wind Strike",
    "name": "   [Steel Wind Strike]"
  },
  {
    "spell_id": 1429,
    "eng_name": "Far Step",
    "name": "  [Far Step]"
  },
  {
    "spell_id": 1446,
    "eng_name": "Summon Shadowspawn",
    "name": "   [Summon Shadowspawn]"
  },
  {
    "spell_id": 1462,
    "eng_name": "Earth Tremor",
    "name": "  [Earth Tremor]"
  },
  {
    "spell_id": 1301,
    "eng_name": "Shield of Faith",
    "name": "  [Shield of Faith]"
  },
  {
    "spell_id": 1483,
    "eng_name": "Mass Polymorph",
    "name": "  [Mass Polymorph]"
  },
  {
    "spell_id": 1478,
    "eng_name": "Temple of the Gods",
    "name": "  [Temple of the Gods]"
  },
  {
    "spell_id": 1482,
    "eng_name": "Maddening Darkness",
    "name": "  [Maddening Darkness]"
  },
  {
    "spell_id": 1480,
    "eng_name": "Illusory Dragon",
    "name": "  [Illusory Dragon]"
  },
  {
    "spell_id": 1481,
    "eng_name": "Mighty Fortress",
    "name": "  [Mighty Fortress]"
  },
  {
    "spell_id": 1484,
    "eng_name": "Invulnerability",
    "name": " [Invulnerability]"
  },
  {
    "spell_id": 1447,
    "eng_name": "Summon Undead",
    "name": "  [Summon Undead]"
  },
  {
    "spell_id": 1488,
    "eng_name": "Tasha's Otherworldly Guise",
    "name": "   [Tasha's Otherworldly Guise]"
  },
  {
    "spell_id": 1450,
    "eng_name": "Summon Aberration",
    "name": "  [Summon Aberration]"
  },
  {
    "spell_id": 1489,
    "eng_name": "Dream of the Blue Veil",
    "name": "   [Dream of the Blue Veil]"
  },
  {
    "spell_id": 1444,
    "eng_name": "Summon Fey",
    "name": "  [Summon Fey]"
  },
  {
    "spell_id": 1409,
    "eng_name": "Control Flames",
    "name": "   [Control Flames]"
  },
  {
    "spell_id": 1449,
    "eng_name": "Summon Elemental",
    "name": "  [Summon Elemental]"
  },
  {
    "spell_id": 1508,
    "eng_name": "Nathair's Mischief",
    "name": "  [Nathair's Mischief]"
  },
  {
    "spell_id": 1059,
    "eng_name": "Imprisonment",
    "name": "' [Imprisonment]"
  },
  {
    "spell_id": 1536,
    "eng_name": "Gravity Fissure",
    "name": "  [Gravity Fissure]"
  },
  {
    "spell_id": 1531,
    "eng_name": "Time Ravage",
    "name": "  [Time Ravage]"
  },
  {
    "spell_id": 1534,
    "eng_name": "Reality Break",
    "name": "  [Reality Break]"
  },
  {
    "spell_id": 1393,
    "eng_name": "Summon Beast",
    "name": "  [Summon Beast]"
  },
  {
    "spell_id": 1539,
    "eng_name": "Gravity Sinkhole",
    "name": "  [Gravity Sinkhole]"
  },
  {
    "spell_id": 1234,
    "eng_name": "Remove Curse",
    "name": "  [Remove Curse]"
  },
  {
    "spell_id": 1247,
    "eng_name": "Misty Step",
    "name": "  [Misty Step]"
  },
  {
    "spell_id": 1324,
    "eng_name": "Tasha's Hideous Laughter",
    "name": "   [Tasha's Hideous Laughter]"
  },
  {
    "spell_id": 1337,
    "eng_name": "Protection from Evil and Good",
    "name": "     [Protection from Evil and Good]"
  },
  {
    "spell_id": 1086,
    "eng_name": "Antimagic field",
    "name": "  [Antimagic field]"
  },
  {
    "spell_id": 1359,
    "eng_name": "Thorn whip",
    "name": "  [Thorn whip]"
  },
  {
    "spell_id": 1120,
    "eng_name": "Planar Ally",
    "name": "  [Planar Ally]"
  },
  {
    "spell_id": 1050,
    "eng_name": "Prestidigitation",
    "name": " [Prestidigitation]"
  },
  {
    "spell_id": 1549,
    "eng_name": "Cordon of Arrows",
    "name": "  [Cordon of Arrows]"
  },
  {
    "spell_id": 1558,
    "eng_name": "Swift Quiver",
    "name": "  [Swift Quiver]"
  },
  {
    "spell_id": 1557,
    "eng_name": "Circle of Power",
    "name": "  [Circle of Power]"
  },
  {
    "spell_id": 1333,
    "eng_name": "Magic missile",
    "name": "  [Magic missile]"
  },
  {
    "spell_id": 1362,
    "eng_name": "hex",
    "name": " [hex]"
  },
  {
    "spell_id": 1279,
    "eng_name": "Rope Trick",
    "name": "  [Rope Trick]"
  },
  {
    "spell_id": 1045,
    "eng_name": "Detect Magic",
    "name": "  [Detect Magic]"
  },
  {
    "spell_id": 1559,
    "eng_name": "Drawmij's Instant Summons",
    "name": "   [Drawmij's Instant Summons]"
  },
  {
    "spell_id": 1291,
    "eng_name": "Protection from Poison",
    "name": "   [Protection from Poison]"
  },
  {
    "spell_id": 1289,
    "eng_name": "Enlarge/Reduce",
    "name": "/ [Enlarge/Reduce]"
  },
  {
    "spell_id": 1259,
    "eng_name": "Aid",
    "name": " [Aid]"
  },
  {
    "spell_id": 1216,
    "eng_name": "Dispel Magic",
    "name": "  [Dispel Magic]"
  },
  {
    "spell_id": 1228,
    "eng_name": "Blink",
    "name": " [Blink]"
  },
  {
    "spell_id": 1492,
    "eng_name": "Mordenkainen's Faithful Hound",
    "name": "   [Mordenkainen's Faithful Hound]"
  },
  {
    "spell_id": 1275,
    "eng_name": "Gentle Repose",
    "name": "  [Gentle Repose]"
  },
  {
    "spell_id": 1334,
    "eng_name": "Cure Wounds",
    "name": "  [Cure Wounds]"
  },
  {
    "spell_id": 1343,
    "eng_name": "Eldritch Blast",
    "name": "  [Eldritch Blast]"
  },
  {
    "spell_id": 1455,
    "eng_name": "Searing Smite",
    "name": "  [Searing Smite]"
  },
  {
    "spell_id": 1458,
    "eng_name": "Banishing Smite",
    "name": "  [Banishing Smite]"
  },
  {
    "spell_id": 1051,
    "eng_name": "Storm of Vengeance",
    "name": "  [Storm of Vengeance]"
  },
  {
    "spell_id": 1339,
    "eng_name": "Animal friendship",
    "name": "   [Animal friendship]"
  },
  {
    "spell_id": 1165,
    "eng_name": "Modify Memory",
    "name": "  [Modify Memory]"
  },
  {
    "spell_id": 1167,
    "eng_name": "Commune",
    "name": " [Commune]"
  },
  {
    "spell_id": 1151,
    "eng_name": "Flame Strike",
    "name": "'  [Flame Strike]"
  },
  {
    "spell_id": 1067,
    "eng_name": "Gate",
    "name": " [Gate]"
  },
  {
    "spell_id": 1172,
    "eng_name": "Cloudkill",
    "name": "  [Cloudkill]"
  },
  {
    "spell_id": 1331,
    "eng_name": "Hunter's Mark",
    "name": "  [Hunter's Mark]"
  },
  {
    "spell_id": 1499,
    "eng_name": "Ray of Sickness",
    "name": "  [Ray of Sickness]"
  },
  {
    "spell_id": 1298,
    "eng_name": "Calm Emotions",
    "name": "  [Calm Emotions]"
  },
  {
    "spell_id": 1498,
    "eng_name": "Ensnaring Strike",
    "name": "  [Ensnaring Strike]"
  },
  {
    "spell_id": 1208,
    "eng_name": "Slow",
    "name": " [Slow]"
  },
  {
    "spell_id": 1146,
    "eng_name": "Dream",
    "name": " [Dream]"
  },
  {
    "spell_id": 1217,
    "eng_name": "Animate dead",
    "name": "  [Animate dead]"
  },
  {
    "spell_id": 1502,
    "eng_name": "Phantasmal Force",
    "name": "  [Phantasmal Force]"
  },
  {
    "spell_id": 1517,
    "eng_name": "Mordenkainen's Private Sanctum",
    "name": "   [Mordenkainen's Private Sanctum]"
  },
  {
    "spell_id": 1516,
    "eng_name": "Leomund's Secret Chest",
    "name": "   [Leomund's Secret Chest]"
  },
  {
    "spell_id": 1525,
    "eng_name": "Otiluke's Freezing Sphere",
    "name": "   [Otiluke's Freezing Sphere]"
  },
  {
    "spell_id": 1507,
    "eng_name": "Levitate",
    "name": " [Levitate]"
  },
  {
    "spell_id": 1512,
    "eng_name": "Hunger of Hadar",
    "name": "  [Hunger of Hadar]"
  },
  {
    "spell_id": 1526,
    "eng_name": "Otto's Irresistible Dance",
    "name": "   [Otto's Irresistible Dance]"
  },
  {
    "spell_id": 1213,
    "eng_name": "Plant Growth",
    "name": "  [Plant Growth]"
  },
  {
    "spell_id": 1244,
    "eng_name": "Gaseous Form",
    "name": "  [Gaseous Form]"
  },
  {
    "spell_id": 1145,
    "eng_name": "Passwall",
    "name": "  [Passwall]"
  },
  {
    "spell_id": 1319,
    "eng_name": "Find Familiar",
    "name": "  [Find Familiar]"
  },
  {
    "spell_id": 1342,
    "eng_name": "Ray of Frost",
    "name": "  [Ray of Frost]"
  },
  {
    "spell_id": 1348,
    "eng_name": "Chill Touch",
    "name": "  [Chill Touch]"
  },
  {
    "spell_id": 1358,
    "eng_name": "Antipathy/Sympathy",
    "name": "/ [Antipathy/Sympathy]"
  },
  {
    "spell_id": 1075,
    "eng_name": "Power Word Stun",
    "name": " :  [Power Word Stun]"
  },
  {
    "spell_id": 1162,
    "eng_name": "Cone of Cold",
    "name": "  [Cone of Cold]"
  },
  {
    "spell_id": 1077,
    "eng_name": "Holy aura",
    "name": "  [Holy aura]"
  },
  {
    "spell_id": 1079,
    "eng_name": "Demiplane",
    "name": " [Demiplane]"
  },
  {
    "spell_id": 1083,
    "eng_name": "Earthquake",
    "name": " [Earthquake]"
  },
  {
    "spell_id": 1470,
    "eng_name": "Soul Cage",
    "name": "  [Soul Cage]"
  },
  {
    "spell_id": 1090,
    "eng_name": "Simulacrum",
    "name": " [Simulacrum]"
  },
  {
    "spell_id": 1096,
    "eng_name": "Plane Shift",
    "name": "  [Plane Shift]"
  },
  {
    "spell_id": 1099,
    "eng_name": "Conjure Celestial",
    "name": "  [Conjure Celestial]"
  },
  {
    "spell_id": 1103,
    "eng_name": "Delayed Blast Fireball",
    "name": "   [Delayed Blast Fireball]"
  },
  {
    "spell_id": 1118,
    "eng_name": "Programmed Illusion",
    "name": "  [Programmed Illusion]"
  },
  {
    "spell_id": 1105,
    "eng_name": "Divine Word",
    "name": "  [Divine Word]"
  },
  {
    "spell_id": 1280,
    "eng_name": "Prayer of Healing",
    "name": "  [Prayer of Healing]"
  },
  {
    "spell_id": 1110,
    "eng_name": "Wall of Ice",
    "name": "  [Wall of Ice]"
  },
  {
    "spell_id": 1112,
    "eng_name": "Sunbeam",
    "name": "  [Sunbeam]"
  },
  {
    "spell_id": 1114,
    "eng_name": "Move Earth",
    "name": "  [Move Earth]"
  },
  {
    "spell_id": 1349,
    "eng_name": "Spare the Dying",
    "name": "   [Spare the Dying]"
  },
  {
    "spell_id": 1119,
    "eng_name": "Find the Path",
    "name": "  [Find the Path]"
  },
  {
    "spell_id": 1125,
    "eng_name": "Mass Suggestion",
    "name": "  [Mass Suggestion]"
  },
  {
    "spell_id": 1127,
    "eng_name": "Chain Lightning",
    "name": "  [Chain Lightning]"
  },
  {
    "spell_id": 1142,
    "eng_name": "Wall of Force",
    "name": "  [Wall of Force]"
  },
  {
    "spell_id": 1148,
    "eng_name": "Reincarnate",
    "name": " [Reincarnate]"
  },
  {
    "spell_id": 1160,
    "eng_name": "Insect Plague",
    "name": "  [Insect Plague]"
  },
  {
    "spell_id": 1166,
    "eng_name": "Commune with Nature",
    "name": "   [Commune with Nature]"
  },
  {
    "spell_id": 1169,
    "eng_name": "Contagion",
    "name": " [Contagion]"
  },
  {
    "spell_id": 1179,
    "eng_name": "Blight",
    "name": " [Blight]"
  },
  {
    "spell_id": 1185,
    "eng_name": "Dominate Beast",
    "name": "  [Dominate Beast]"
  },
  {
    "spell_id": 1183,
    "eng_name": "Confusion",
    "name": " [Confusion]"
  },
  {
    "spell_id": 1189,
    "eng_name": "Polymorph",
    "name": " [Polymorph]"
  },
  {
    "spell_id": 1197,
    "eng_name": "Giant Insect",
    "name": "  [Giant Insect]"
  },
  {
    "spell_id": 1205,
    "eng_name": "Arcane eye",
    "name": "  [Arcane eye]"
  },
  {
    "spell_id": 1303,
    "eng_name": "healing word",
    "name": "  [healing word]"
  },
  {
    "spell_id": 1214,
    "eng_name": "Speak with Plants",
    "name": "   [Speak with Plants]"
  },
  {
    "spell_id": 1218,
    "eng_name": "Clairvoyance",
    "name": " [Clairvoyance]"
  },
  {
    "spell_id": 1223,
    "eng_name": "Major Image",
    "name": "  [Major Image]"
  },
  {
    "spell_id": 1226,
    "eng_name": "Bestow Curse",
    "name": "  [Bestow Curse]"
  },
  {
    "spell_id": 1237,
    "eng_name": "Lightning Bolt",
    "name": "  [Lightning Bolt]"
  },
  {
    "spell_id": 1233,
    "eng_name": "Counterspell",
    "name": " [Counterspell]"
  },
  {
    "spell_id": 1235,
    "eng_name": "Meld into Stone",
    "name": "   [Meld into Stone]"
  },
  {
    "spell_id": 1240,
    "eng_name": "Spirit Guardians",
    "name": "  [Spirit Guardians]"
  },
  {
    "spell_id": 1246,
    "eng_name": "Fireball",
    "name": " [Fireball]"
  },
  {
    "spell_id": 1255,
    "eng_name": "Blindness/Deafness",
    "name": "/ [Blindness/Deafness]"
  },
  {
    "spell_id": 1273,
    "eng_name": "Web",
    "name": " [Web]"
  },
  {
    "spell_id": 1309,
    "eng_name": "Guiding Bolt",
    "name": "  [Guiding Bolt]"
  },
  {
    "spell_id": 1264,
    "eng_name": "Find Steed",
    "name": "  [Find Steed]"
  },
  {
    "spell_id": 1267,
    "eng_name": "Gust of Wind",
    "name": "  [Gust of Wind]"
  },
  {
    "spell_id": 1282,
    "eng_name": "Magic Mouth",
    "name": "  [Magic Mouth]"
  },
  {
    "spell_id": 1290,
    "eng_name": "Enthrall",
    "name": "  [Enthrall]"
  },
  {
    "spell_id": 1173,
    "eng_name": "Greater Restoration",
    "name": "  [Greater Restoration]"
  },
  {
    "spell_id": 1321,
    "eng_name": "Burning Hands",
    "name": "  [Burning Hands]"
  },
  {
    "spell_id": 1325,
    "eng_name": "Entangle",
    "name": " [Entangle]"
  },
  {
    "spell_id": 1351,
    "eng_name": "Minor Illusion",
    "name": "  [Minor Illusion]"
  },
  {
    "spell_id": 1330,
    "eng_name": "Silent Image",
    "name": "  [Silent Image]"
  },
  {
    "spell_id": 1335,
    "eng_name": "Color Spray",
    "name": "  [Color Spray]"
  },
  {
    "spell_id": 1388,
    "eng_name": "Dust Devil",
    "name": "  [Dust Devil]"
  },
  {
    "spell_id": 1421,
    "eng_name": "Sickening Radiance",
    "name": "  [Sickening Radiance]"
  },
  {
    "spell_id": 1418,
    "eng_name": "Summon Greater Demon",
    "name": "   [Summon Greater Demon]"
  },
  {
    "spell_id": 1411,
    "eng_name": "Mold Earth",
    "name": "  [Mold Earth]"
  },
  {
    "spell_id": 1424,
    "eng_name": "Elemental Bane",
    "name": "  [Elemental Bane]"
  },
  {
    "spell_id": 1414,
    "eng_name": "Shape Water",
    "name": "  [Shape Water]"
  },
  {
    "spell_id": 1428,
    "eng_name": "Wrath of Nature",
    "name": "  [Wrath of Nature]"
  },
  {
    "spell_id": 1425,
    "eng_name": "Shadow of Moil",
    "name": "  [Shadow of Moil]"
  },
  {
    "spell_id": 1430,
    "eng_name": "Enervation",
    "name": " [Enervation]"
  },
  {
    "spell_id": 1438,
    "eng_name": "Synaptic Static",
    "name": "  [Synaptic Static]"
  },
  {
    "spell_id": 1439,
    "eng_name": "Immolation",
    "name": " [Immolation]"
  },
  {
    "spell_id": 1465,
    "eng_name": "Investiture of Flame",
    "name": "  [Investiture of Flame]"
  },
  {
    "spell_id": 1466,
    "eng_name": "Investiture of Stone",
    "name": "  [Investiture of Stone]"
  },
  {
    "spell_id": 1467,
    "eng_name": "Investiture of Ice",
    "name": "  [Investiture of Ice]"
  },
  {
    "spell_id": 1486,
    "eng_name": "Crown of Stars",
    "name": "  [Crown of Stars]"
  },
  {
    "spell_id": 1485,
    "eng_name": "Psychic Scream",
    "name": "  [Psychic Scream]"
  },
  {
    "spell_id": 1382,
    "eng_name": "Tasha's Caustic Brew",
    "name": "   [Tasha's Caustic Brew]"
  },
  {
    "spell_id": 1487,
    "eng_name": "Summon Fiend",
    "name": "  [Summon Fiend]"
  },
  {
    "spell_id": 1550,
    "eng_name": "Rime's Binding Ice",
    "name": "   [Rime's Binding Ice]"
  },
  {
    "spell_id": 1538,
    "eng_name": "Temporal Shunt",
    "name": "  [Temporal Shunt]"
  },
  {
    "spell_id": 1452,
    "eng_name": "Absorb Elements",
    "name": "  [Absorb Elements]"
  },
  {
    "spell_id": 1540,
    "eng_name": "Pulse Wave",
    "name": "  [Pulse Wave]"
  },
  {
    "spell_id": 1542,
    "eng_name": "Immovable Object",
    "name": " ' [Immovable Object]"
  },
  {
    "spell_id": 1541,
    "eng_name": "Fortune's Favor",
    "name": "  [Fortune's Favor]"
  },
  {
    "spell_id": 1377,
    "eng_name": "Ceremony",
    "name": " [Ceremony]"
  },
  {
    "spell_id": 1545,
    "eng_name": "Gift of Alacrity",
    "name": "  [Gift of Alacrity]"
  },
  {
    "spell_id": 1375,
    "eng_name": "Word of Radiance",
    "name": "  [Word of Radiance]"
  },
  {
    "spell_id": 1544,
    "eng_name": "Magnify Gravity",
    "name": "  [Magnify Gravity]"
  },
  {
    "spell_id": 1378,
    "eng_name": "Chaos Bolt",
    "name": "  [Chaos Bolt]"
  },
  {
    "spell_id": 1384,
    "eng_name": "Healing Spirit",
    "name": "  [Healing Spirit]"
  },
  {
    "spell_id": 1380,
    "eng_name": "Dragon's Breath",
    "name": "  [Dragon's Breath]"
  },
  {
    "spell_id": 1387,
    "eng_name": "Aganazzar's Scorcher",
    "name": "  [Aganazzar's Scorcher]"
  },
  {
    "spell_id": 1392,
    "eng_name": "Snilloc's Snowball Swarm",
    "name": "   [Snilloc's Snowball Swarm]"
  },
  {
    "spell_id": 1396,
    "eng_name": "Summon Lesser Demons",
    "name": "   [Summon Lesser Demons]"
  },
  {
    "spell_id": 1365,
    "eng_name": "Green-Flame Blade",
    "name": "   [Green-Flame Blade]"
  },
  {
    "spell_id": 1398,
    "eng_name": "Thunder Step",
    "name": "  [Thunder Step]"
  },
  {
    "spell_id": 1402,
    "eng_name": "Melf's Minute Meteors",
    "name": "   [Melf's Minute Meteors]"
  },
  {
    "spell_id": 1461,
    "eng_name": "Ice Knife",
    "name": "  [Ice Knife]"
  },
  {
    "spell_id": 1413,
    "eng_name": "Create Bonfire",
    "name": "  [Create Bonfire]"
  },
  {
    "spell_id": 1464,
    "eng_name": "Investiture of Wind",
    "name": "  [Investiture of Wind]"
  },
  {
    "spell_id": 1443,
    "eng_name": "Spirit Shroud",
    "name": "  [Spirit Shroud]"
  },
  {
    "spell_id": 1490,
    "eng_name": "Blade of Disaster",
    "name": "  [Blade of Disaster]"
  },
  {
    "spell_id": 1523,
    "eng_name": "Summon Draconic Spirit",
    "name": "   [Summon Draconic Spirit]"
  },
  {
    "spell_id": 1527,
    "eng_name": "Draconic Transformation",
    "name": "  [Draconic Transformation]"
  },
  {
    "spell_id": 1532,
    "eng_name": "Ravenous Void",
    "name": "  [Ravenous Void]"
  },
  {
    "spell_id": 1535,
    "eng_name": "Tether Essence",
    "name": "'  [Tether Essence]"
  }
]
</file>

<file path="prisma/enums/Races.prisma">
enum Races {
  AASIMAR_2024
  DRAGONBORN_2024
  DWARF_2024
  ELF_2024
  GNOME_2024
  GOLIATH_2024
  HALFLING_2024
  HUMAN_2024
  ORC_2024
  TIEFLING_2024
  DRAGONBORN_2014
  DWARF_2014
  ELF_2014
  GNOME_2014
  HALF_ELF_2014
  HALF_ORC_2014
  HALFLING_2014
  HUMAN_2014
  TIEFLING_2014
  CENTAUR_GGTR
  LOXODON_GGTR
  MINOTAUR_GGTR
  SIMIC_HYBRID_GGTR
  VEDALKEN_GGTR
  VERDAN_AI
  KALASHTAR_EBERRON
  WARFORGED_EBERRON
  LEONIN_MOOT
  SATYR_MOOT
  DHAMPIR_VRGTR
  HEXBLOOD_VRGTR
  REBORN_VRGTR
  OWLIN_SACOC
  AARAKOCRA_MPMM
  AASIMAR_MPMM
  BUGBEAR_MPMM
  CENTAUR_MPMM
  CHANGELING_MPMM
  DEEP_GNOME_MPMM
  DUERGAR_MPMM
  ELADRIN_MPMM
  FAIRY_MPMM
  FIRBOLG_MPMM
  GENASI_AIR_MPMM
  GENASI_EARTH_MPMM
  GENASI_FIRE_MPMM
  GENASI_WATER_MPMM
  GITHYANKI_MPMM
  GITHZERAI_MPMM
  GOBLIN_MPMM
  GOLIATH_MPMM
  HARENGON_MPMM
  HOBGOBLIN_MPMM
  KENKU_MPMM
  KOBOLD_MPMM
  LIZARDFOLK_MPMM
  MINOTAUR_MPMM
  ORC_MPMM
  SATYR_MPMM
  SEA_ELF_MPMM
  SHADAR_KAI_MPMM
  SHIFTER_MPMM
  TABAXI_MPMM
  TORTLE_MPMM
  TRITON_MPMM
  YUAN_TI_MPMM
  ASTRAL_ELF_SPELLJAMMER
  AUTOGNOME_SPELLJAMMER
  GIFF_SPELLJAMMER
  HADOZEE_SPELLJAMMER
  PLASMOID_SPELLJAMMER
  THRI_KREEN_SPELLJAMMER
  KENDER_DRAGONLANCE
  GRUNG_OGA
  LOCATHAH_LR

  // Fizban's Treasury of Dragons
  DRAGONBORN_CHROMATIC
  DRAGONBORN_METALLIC
  DRAGONBORN_GEM
}
</file>

<file path="prisma/models/choices/ChoiceOptionFeature.prisma">
model ChoiceOptionFeature {
  optionFeatureId Int @id @default(autoincrement()) @map("option_feature_id")
  choiceOptionId  Int @map("option_id")
  featureId       Int @map("feature_id")

  option  ChoiceOption @relation(fields: [choiceOptionId], references: [choiceOptionId], onDelete: Cascade)
  feature Feature      @relation(fields: [featureId], references: [featureId], onDelete: Cascade)

  @@map("choice_option_feature")
}
</file>

<file path="prisma/models/classes/Class.prisma">
// Enums    -     


model Class {
  classId Int     @id @default(autoincrement()) @map("class_id")
  name    Classes @unique @map("eng_name")
  sortOrder Int   @default(999) @map("sort_order")

  hitDie Int @map("hit_die")

  primaryCastingStat Ability?         @map("primary_casting_stat")
  spellcastingType   SpellcastingType @default(NONE) @map("spellcasting_type")

  abilityScoreUpLevels Int[] @default([4, 8, 12, 16, 19]) @map("ability_score_up_levels")

  subclassLevel Int @default(3) @map("subclass_level")

  /// [MulticlassReqs]
  multiclassReqs Json // {choice: ['STR', 'DEX'], score: 13}}

  armorProficiencies         ArmorType[] @default([]) @map("armor_proficiencies")
  /// [WeaponProficiencies]
  weaponProficiencies        Json?       @map("weapon_proficiencies")
  /// [WeaponProficienciesSpecial]
  weaponProficienciesSpecial Json?       @map("weapon_proficiencies_special")

  savingThrows           Ability[]      @map("saving_throws")
  /// [SkillProficiencies]
  skillProficiencies     Json?          @map("skill_proficiencies")
  toolProficiencies      ToolCategory[] @default([]) @map("tool_proficiencies")
  toolToChooseCount      Int?           @map("tool_to_choose_count")
  languagesToChooseCount Int            @default(0) @map("languages_to_choose_count")
  languages              Language[]     @default([])

  subclasses                  Subclass[]
  features                    ClassFeature[]
  specialSpellSlotProgression Json?                          @map("special_spell_slot_progression")
  perses                      Pers[]
  persMulticlasses            PersMulticlass[]
  startingEquipmentOption     ClassStartingEquipmentOption[]
  classChoiceOptions          ClassChoiceOption[]
  classOptionalFeatures       ClassOptionalFeature[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("class")
}
</file>

<file path="prisma/models/classes/ClassChoiceOption.prisma">
model ClassChoiceOption {
  optionId       Int @id @default(autoincrement()) @map("option_id")
  classId        Int @map("class_id")
  choiceOptionId Int @map("choice_option_id")

  levelsGranted Int[] @map("levels_granted")

  choiceOption ChoiceOption @relation(fields: [choiceOptionId], references: [choiceOptionId], onDelete: Cascade)
  class        Class        @relation(fields: [classId], references: [classId], onDelete: Cascade)

  @@unique([classId, choiceOptionId], name: "unique_class_choice")
  @@map("class_choice_option")
}
</file>

<file path="prisma/models/classes/ClassOptionalFeature.prisma">
model ClassOptionalFeature {
  optionalFeatureId Int  @id @default(autoincrement()) @map("option_feature_id")
  featureId         Int? @map("feature_id")
  classId           Int  @map("class_id")

  seedIndex Int @map("seed_index") @default(0)

  grantedOnLevels Int[]

  replacesFightingStyle Boolean?
  replacesManeuver      Boolean?
  replacesInvocation    Boolean? @map("replaces_invocation")

  title String? @db.VarChar(100)

  prerequisites Json?

  perses  Pers[]
  class   Class    @relation(fields: [classId], references: [classId], onDelete: Cascade)
  feature Feature? @relation("GrantedFeature", fields: [featureId], references: [featureId], onDelete: Cascade)

  replacesFeatures          ClassOptionalFeatureReplacesFeature[]
  appearsOnlyIfChoicesTaken ChoiceOption[]

  @@unique([seedIndex])
  @@map("class_optional_feature")
}
</file>

<file path="prisma/models/classes/ClassStartingEquipmentOption.prisma">
model ClassStartingEquipmentOption {
  optionId Int @id @default(autoincrement()) @map("option_id")
  classId  Int @map("class_id")
  seedIndex Int @map("seed_index") @default(0)

  choiceGroup Int    @map("choice_group")
  option      String @db.Char(1)

  weaponId        Int?    @map("weapon_id")
  armorId         Int?    @map("armor_id")
  equipmentPackId Int?    @map("equipment_pack_id")
  item            String?

  quantity Int @default(1)

  chooseAnyArmor Boolean    @default(false) @map("choose_any_armor")
  armorType      ArmorType? @map("armor_type")

  chooseAnyWeapon Boolean     @default(false) @map("choose_any_weapon")
  weaponType      WeaponType? @map("weapon_type")
  weaponCount     Int         @default(1) @map("weapon_count")

  description String? @db.Text

  class         Class          @relation(fields: [classId], references: [classId], onDelete: Cascade)
  weapon        Weapon?        @relation(fields: [weaponId], references: [weaponId])
  armor         Armor?         @relation(fields: [armorId], references: [armorId])
  equipmentPack EquipmentPack? @relation(fields: [equipmentPackId], references: [equipmentPackId])

  @@unique([seedIndex])
  @@index([classId, choiceGroup, option])
  @@map("class_starting_equipment_option")
}
</file>

<file path="prisma/models/classes/Subclass.prisma">
model Subclass {
  subclassId  Int     @id @default(autoincrement()) @map("subclass_id")
  classId     Int     @map("class_id")
  name        Subclasses @map("name")
  description String? @db.Text

  primaryCastingStat Ability?         @map("primary_casting_stat")
  spellcastingType   SpellcastingType @default(NONE) @map("spellcasting_type")
  grantsSpells       Boolean          @default(false) @map("grants_spells")
  expandedSpells     Spell[]          @relation("SubclassExpandedSpells")

  languagesToChooseCount Int            @default(0) @map("languages_to_choose_count")
  languages              Language[]     @default([])
  toolProficiencies      ToolCategory[] @default([]) @map("tool_proficiencies")
  toolToChooseCount      Int?           @map("tool_to_choose_count")

  class            Class             @relation(fields: [classId], references: [classId], onDelete: Cascade)
  features         SubclassFeature[]
  subclassChoiceOptions SubclassChoiceOption[]
  perses           Pers[]
  persMulticlasses PersMulticlass[]

  @@unique([classId, name])
  @@map("subclass")
}
</file>

<file path="prisma/models/classes/SubclassChoiceOption.prisma">
model SubclassChoiceOption {
  optionId       Int @id @default(autoincrement()) @map("option_id")
  subclassId     Int @map("subclass_id")
  choiceOptionId Int @map("choice_option_id")

  levelsGranted Int[] @map("levels_granted")

  choiceOption ChoiceOption @relation(fields: [choiceOptionId], references: [choiceOptionId], onDelete: Cascade)
  subclass     Subclass     @relation(fields: [subclassId], references: [subclassId], onDelete: Cascade)

  @@unique([subclassId, choiceOptionId], name: "unique_subclass_choice")
  @@map("subclass_choice_option")
}
</file>

<file path="prisma/models/feats/FeatChoiceOption.prisma">
model FeatChoiceOption {
  optionId       Int @id @default(autoincrement()) @map("option_id")
  featId         Int @map("feat_id")
  choiceOptionId Int @map("choice_option_id")

  choiceOption ChoiceOption @relation(fields: [choiceOptionId], references: [choiceOptionId], onDelete: Cascade)
  feat         Feat         @relation(fields: [featId], references: [featId], onDelete: Cascade)

  @@unique([featId, choiceOptionId], name: "unique_feat_choice")
  @@map("feat_choice_option")
}
</file>

<file path="prisma/models/features/Feature.prisma">
model Feature {
  featureId Int @id @unique @default(autoincrement()) @map("feature_id")

  name             String  @db.VarChar(100)
  engName          String  @unique @map("eng_name") @db.VarChar(100)
  description      String  @db.Text
  shortDescription String? @map("short_description") @db.Text

  modifiesAC Json? @map("modifies_ac")
  givesAC    Int?  @map("gives_ac") // simple +1 +2

  requiresArmorForACBonus   Boolean? @map("requires_armor_for_ac_bonus")
  noArmorOrShieldForACBonus Boolean? @map("no_armor_or_shield_for_ac_bonus")

  givesSTR Int? @map("gives_str")
  givesCON Int? @map("gives_con")

  bonusToAttackRoll                 Int? @map("bonus_to_attack_roll")
  bonusToRangedAttackRoll           Int? @map("bonus_to_ranged_attack_roll")
  bonusToRangedDamage               Int? @map("bonus_to_ranged_damage")
  bonusToMeleeDamage                Int? @map("bonus_to_melee_damage")
  bonusToMeleeOneHandedWeaponDamage Int? @map("bonus_to_melee_one_handed_weapon_damage")
  bonusToThrownDamage               Int? @map("thrown_damage_boost")

  bonusToSavingThrows Json? @map("bonus_to_saving_throws")

  givesManeuvres       Boolean? @default(false) @map("gives_maneuvres")
  superiorityDiceCount Int?     @map("superiority_dice_count")

  modifiesUnarmed Boolean? @map("modified_unarmed")
  unarmedDamage   String?  @map("unarmed_damage") // '16 / 18'

  /// [SkillProficiencies]
  skillProficiencies Json?     @map("skill_proficiencies")
  savingThrows       Ability[] @map("saving_throws")
  skillExpertises    Json?     @map("skill_expertises")

  limitedUsesPer                     RestType? @map("limited_uses_per")
  usesCount                          Int?      @map("uses_count")
  usesCountSpecial                   Json?     @map("uses_count_special")
  usesCountDependsOnProficiencyBonus Boolean   @default(false) @map("uses_count_depends_on_proficiency_bonus")

  invocationsCount Int? @map("invocations_count")

  languagesToChooseCount Int @default(0) @map("languages_to_choose_count")

  givesSpells Spell[]

  displayType FeatureDisplayType[] @map("display_type")

  classFeatures    ClassFeature[]
  subclassFeatures SubclassFeature[]

  raceTraits                    RaceTrait[]
  subraceTraits                 SubraceTrait[]
  raceVariantTraits             RaceVariantTrait[]
  raceChoiceOptionTraits        RaceChoiceOptionTrait[]
  choiceOptionFeatures          ChoiceOptionFeature[]
  classOptionalFeatures         ClassOptionalFeature[]                @relation("GrantedFeature")
  replacedByOptionalFeatures    ClassOptionalFeatureReplacesFeature[] @relation("ReplacedByOptionalFeatures")
  subracesReplacingFeatures     Subrace[]                             @relation("SubraceReplacingFeature")
  raceVariantsReplacingFeatures RaceVariant[]                         @relation("RaceVariantReplacingFeature")

  grantsByFeat Feat[] @relation("FeatGrantsFeature")

  infusions Infusion[]

  persFeatures PersFeature[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("feature")
}
</file>

<file path="prisma/models/pers/PersFeatChoice.prisma">
model PersFeatChoice {
  persFeatChoiceId Int @id @default(autoincrement()) @map("pers_feat_choice_id")
  persFeatId       Int @map("pers_feat_id")
  choiceOptionId   Int @map("choice_option_id")

  persFeat     PersFeat     @relation(fields: [persFeatId], references: [persFeatId], onDelete: Cascade)
  choiceOption ChoiceOption @relation(fields: [choiceOptionId], references: [choiceOptionId], onDelete: Cascade)

  @@unique([persFeatId, choiceOptionId], name: "unique_pers_feat_choice")
  @@map("pers_feat_choice")
}
</file>

<file path="prisma/models/pers/PersFeature.prisma">
model PersFeature {
  persFeatureId Int @id @default(autoincrement()) @map("pers_feature_id")
  persId        Int @map("pers_id")
  featureId     Int @map("feature_id")

  usesRemaining Int? @map("uses_remaining")

  feature Feature @relation(fields: [featureId], references: [featureId], onDelete: Cascade)
  pers    Pers    @relation(fields: [persId], references: [persId], onDelete: Cascade)

  @@unique([persId, featureId])
  @@map("pers_feature")
}
</file>

<file path="prisma/models/pers/PersInfusion.prisma">
model PersInfusion {
  persInfusionId Int @id @default(autoincrement()) @map("pers_infusion_id")
  persId         Int @map("pers_id")
  infusionId     Int @map("infusion_id")

  // '    
  persWeaponId    Int? @map("pers_weapon_id")
  persArmorId     Int? @map("pers_armor_id")
  persMagicItemId Int? @map("pers_magic_item_id")

  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at")

  pers      Pers           @relation(fields: [persId], references: [persId], onDelete: Cascade)
  infusion  Infusion       @relation(fields: [infusionId], references: [infusionId], onDelete: Cascade)
  weapon    PersWeapon?    @relation(fields: [persWeaponId], references: [persWeaponId], onDelete: Cascade)
  armor     PersArmor?     @relation(fields: [persArmorId], references: [persArmorId], onDelete: Cascade)
  magicItem PersMagicItem? @relation(fields: [persMagicItemId], references: [persMagicItemId], onDelete: Cascade)

  @@map("pers_infusion")
}
</file>

<file path="prisma/models/pers/PersMagicItem.prisma">
model PersMagicItem {
  persMagicItemId Int @id @default(autoincrement()) @map("pers_magic_item_id")
  persId          Int @map("pers_id")
  magicItemId     Int @map("magic_item_id")

  pers      Pers      @relation(fields: [persId], references: [persId], onDelete: Cascade)
  magicItem MagicItem @relation(fields: [magicItemId], references: [magicItemId], onDelete: Cascade)

  // Opposite side of PersInfusion.magicItem
  infusions PersInfusion[]

  @@map("pers_magic_item")
}
</file>

<file path="prisma/models/pers/PersMulticlass.prisma">
model PersMulticlass {
  persMulticlassId Int  @id @default(autoincrement()) @map("pers_multiclass_id")
  persId           Int  @map("pers_id")
  classId          Int  @map("class_id")
  subclassId       Int? @map("subclass_id")
  classLevel       Int  @map("class_level")

  pers     Pers      @relation(fields: [persId], references: [persId], onDelete: Cascade)
  class    Class     @relation(fields: [classId], references: [classId], onDelete: Cascade)
  subclass Subclass? @relation(fields: [subclassId], references: [subclassId], onDelete: Cascade)

  @@unique([persId, classId])
  @@map("pers_multiclass")
}
</file>

<file path="prisma/models/pers/PersSkill.prisma">
model PersSkill {
  persSkillId     Int                  @id @default(autoincrement()) @map("pers_skill_id")
  skillId         Int                  @map("skill_id")
  persId          Int                  @map("pers_id")
  proficiencyType SkillProficiencyType @default(NONE) @map("proficiency_type")
  customModifier  Int?                 @map("custom_modifier")
  name            Skills

  pers Pers @relation(fields: [persId], references: [persId], onDelete: Cascade)

  @@unique([persId, name])
  @@map("pers_skill")
}
</file>

<file path="prisma/models/pers/PersSpell.prisma">
model PersSpell {
  persSpellId    Int       @id @default(autoincrement()) @map("pers_spell_id")
  persId         Int       @map("pers_id")
  spellId        Int       @map("spell_id")
  learnedAtLevel Int       @map("learned_at_level")

  isPrepared     Boolean   @default(false) @map("is_prepared")
  
  origin         SpellOrigin @default(MANUAL)
  
  sourceId       Int?      @map("source_id")
  sourceName     String?   @map("source_name")
  notes          String?
  
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  pers    Pers    @relation(fields: [persId], references: [persId], onDelete: Cascade)
  spell   Spell   @relation(fields: [spellId], references: [spellId], onDelete: Cascade)

  @@unique([persId, spellId])
  @@index([persId])
  @@index([origin])
  @@map("pers_spell")
}
</file>

<file path="prisma/models/races/Race.prisma">
model Race {
  raceId      Int    @id @default(autoincrement()) @map("race_id")
  name        Races  @unique
  size        Size[] @default([MEDIUM])
  speed       Int    @default(30)
  burrowSpeed Int    @default(0) @map("burrow_speed")
  flightSpeed Int    @default(0) @map("flight_speed")
  swimSpeed   Int    @default(0) @map("swim_speed")
  climbSpeed  Int    @default(0) @map("climb_speed")
  ac          Json?
  sortOrder   Int    @default(999) @map("sort_order")

  source Source @default(PHB)

  languages              Language[] @default([COMMON])
  languagesToChooseCount Int        @default(0) @map("languages_to_choose_count")

  /// [RaceASI]
  ASI                 Json        @map("asi") // {WIS: 2, ANY: 1}
  /// [ToolProficiencies]
  toolProficiencies   Json?       @map("tool_proficiencies")
  toolToChooseCount   Int?        @map("tool_to_choose_count")
  /// [SkillProficiencies]
  skillProficiencies  Json?       @map("skill_proficiencies")
  /// [WeaponProficiencies]
  weaponProficiencies Json?       @map("weapon_proficiencies")
  armorProficiencies  ArmorType[] @default([]) @map("armor_proficiencies")

  subraces          Subrace[]
  perses            Pers[]
  raceChoiceOptions RaceChoiceOption[]
  raceVariants      RaceVariant[]

  traits RaceTrait[]

  @@map("race")
}
</file>

<file path="prisma/models/races/RaceChoiceOption.prisma">
model RaceChoiceOption {
  optionId  Int  @id @default(autoincrement()) @map("option_id")
  raceId    Int  @map("race_id")
  subraceId Int? @map("subrace_id")

  choiceGroupName String  @map("choice_group_name")
  optionName      String  @map("option_name")
  description     String? @db.Text

  selectMultiple Boolean @default(false) @map("select_multiple")
  maxSelection   Int     @default(1) @map("max_selection")

  traits                 RaceChoiceOptionTrait[]
  /// [RaceASI]
  ASI                    Json?                   @map("asi")
  /// [SkillProficiencies]
  skillProficiencies     Json?                   @map("skill_proficiencies")
  languages              Language[]              @default([]) @map("languages")
  languagesToChooseCount Int                     @default(0) @map("languages_to_choose_count")
  modifiesSpeed          Int?                    @map("modifies_speed")

  race    Race     @relation(fields: [raceId], references: [raceId], onDelete: Cascade)
  subrace Subrace? @relation(fields: [subraceId], references: [subraceId], onDelete: Cascade)
  perses  Pers[]

  @@unique([raceId, subraceId, choiceGroupName, optionName])
  @@map("race_choice_option")
}
</file>

<file path="prisma/models/races/RaceChoiceOptionTrait.prisma">
model RaceChoiceOptionTrait {
  raceChoiceOptionTraitId Int @id @default(autoincrement()) @map("race_choice_option_trait_id")
  optionId                Int @map("option_id")
  featureId               Int @map("feature_id")

  feature          Feature          @relation(fields: [featureId], references: [featureId], onDelete: Cascade)
  raceChoiceOption RaceChoiceOption @relation(fields: [optionId], references: [optionId], onDelete: Cascade)

  @@map("race_choice_option_trait")
}
</file>

<file path="prisma/models/races/RaceTrait.prisma">
model RaceTrait {
  raceTraitId Int @id @default(autoincrement()) @map("race_trait_id")
  raceId      Int @map("race_id")
  featureId   Int @map("feature_id")

  feature Feature @relation(fields: [featureId], references: [featureId], onDelete: Cascade)
  race    Race    @relation(fields: [raceId], references: [raceId], onDelete: Cascade)

  @@map("race_trait")
}
</file>

<file path="prisma/models/races/RaceVariant.prisma">
model RaceVariant {
  raceVariantId Int @id @default(autoincrement()) @map("race_variant_id")
  raceId        Int @map("race_id")

  name             Variants
  source           Source
  replacesFeatures Feature[]          @relation("RaceVariantReplacingFeature")
  traits           RaceVariantTrait[]

  exclusivityGroup     String? @map("exclusivity_group")
  /// [RaceASI]
  overridesRaceASI     Json    @map("overrides_race_asi")
  overridesRaceSpeed   Int?    @map("overrides_race_speed")
  overridesFlightSpeed Int?    @map("overrides_flight_speed")

  race   Race   @relation(fields: [raceId], references: [raceId], onDelete: Cascade)
  perses Pers[]

  @@map("race_variant")
}
</file>

<file path="prisma/models/spells/Spell.prisma">
model Spell {
  spellId          Int     @id @default(autoincrement()) @map("spell_id")
  name             String  @unique(map: "unique_names") @db.VarChar(255)
  engName          String  @unique @map("eng_name") @db.VarChar(255)
  level            Int
  school           String? @db.VarChar(255)
  castingTime      String  @map("casting_time") @db.VarChar(255)
  range            String  @db.VarChar(255)
  components       String? @db.VarChar(500)

  persSpells       PersSpell[]
  duration         String  @db.VarChar(255)
  description      String  @db.Text
  hasRitual        String? @map("has_ritual") @db.VarChar
  hasConcentration String? @map("has_concentration") @db.VarChar
  source           Source  @default(PHB)

  characterSpells CharacterSpells[]
  spellClasses    SpellClasses[]
  spellRaces      SpellRaces[]
  spellbookSpells SpellbookSpells[]
  subclasses      Subclass[]        @relation("SubclassExpandedSpells")
  perses          Pers[]
  features        Feature[]
  magicItems      MagicItem[]

  @@map("spell")
}
</file>

<file path="prisma/seed/helpers/featureDisplayType.ts">
import { FeatureDisplayType, Prisma } from "@prisma/client";

export type SeedDisplayType = FeatureDisplayType | FeatureDisplayType[];

export type SeedFeatureCreateInput = Omit<Prisma.FeatureCreateInput, "displayType"> & {
    displayType?: SeedDisplayType;
};

function stripHtml(input: string): string {
    return input.replace(/<[^>]*>/g, "");
}

function deriveShortDescription(description: string): string {
    const text = stripHtml(description || "").trim();
    if (!text) return "";

    const firstLine = text.split(/\n+/)[0]?.trim() ?? "";
    const sentenceMatch = firstLine.match(/^(.+?[.!?])\s/);
    const base = (sentenceMatch?.[1] ?? firstLine).trim();

    const limit = 100;
    if (base.length <= limit) return base;
    return base.slice(0, limit - 1).trimEnd() + "";
}

export function normalizeFeatureCreateInput(input: SeedFeatureCreateInput): Prisma.FeatureCreateInput {
    const raw = input.displayType;

    const displayType = Array.isArray(raw)
        ? raw
        : raw
            ? [raw]
            : [FeatureDisplayType.PASSIVE];

    const existingShort = (input as any).shortDescription as string | null | undefined;
    const description = String((input as any).description ?? "");
    const shortDescription = (existingShort ?? "").trim() ? existingShort : deriveShortDescription(description) || null;

    return {
        ...input,
        displayType,
        shortDescription,
    };
}
</file>

<file path="prisma/seed/armorSeed.ts">
import { PrismaClient, Prisma, ArmorCategory, ArmorType } from "@prisma/client";

export const seedArmor = async (prisma: PrismaClient) => {
    console.log('Seeding armor...')

    const armors: Prisma.ArmorCreateInput[] = [
        // ==================== LIGHT ARMOR ====================
        {
            name: ArmorCategory.PADDED,
            armorType: ArmorType.LIGHT,
            baseAC: 11,
            strengthReq: null,
            stealthDisadvantage: true
        },
        {
            name: ArmorCategory.LEATHER,
            armorType: ArmorType.LIGHT,
            baseAC: 11,
            strengthReq: null,
            stealthDisadvantage: false
        },
        {
            name: ArmorCategory.STUDDED_LEATHER,
            armorType: ArmorType.LIGHT,
            baseAC: 12,
            strengthReq: null,
            stealthDisadvantage: false
        },

        // ==================== MEDIUM ARMOR ====================
        {
            name: ArmorCategory.HIDE,
            armorType: ArmorType.MEDIUM,
            baseAC: 12,
            strengthReq: null,
            stealthDisadvantage: false
        },
        {
            name: ArmorCategory.CHAIN_SHIRT,
            armorType: ArmorType.MEDIUM,
            baseAC: 13,
            strengthReq: null,
            stealthDisadvantage: false
        },
        {
            name: ArmorCategory.SCALE_MAIL,
            armorType: ArmorType.MEDIUM,
            baseAC: 14,
            strengthReq: null,
            stealthDisadvantage: true
        },
        {
            name: ArmorCategory.BREASTPLATE,
            armorType: ArmorType.MEDIUM,
            baseAC: 14,
            strengthReq: null,
            stealthDisadvantage: false
        },
        {
            name: ArmorCategory.HALF_PLATE,
            armorType: ArmorType.MEDIUM,
            baseAC: 15,
            strengthReq: null,
            stealthDisadvantage: true
        },

        // ==================== HEAVY ARMOR ====================
        {
            name: ArmorCategory.RING_MAIL,
            armorType: ArmorType.HEAVY,
            baseAC: 14,
            strengthReq: null,
            stealthDisadvantage: true
        },
        {
            name: ArmorCategory.CHAIN_MAIL,
            armorType: ArmorType.HEAVY,
            baseAC: 16,
            strengthReq: 13,
            stealthDisadvantage: true
        },
        {
            name: ArmorCategory.SPLINT,
            armorType: ArmorType.HEAVY,
            baseAC: 17,
            strengthReq: 15,
            stealthDisadvantage: true
        },
        {
            name: ArmorCategory.PLATE,
            armorType: ArmorType.HEAVY,
            baseAC: 18,
            strengthReq: 15,
            stealthDisadvantage: true
        },

        // ==================== SHIELD ====================
        {
            name: ArmorCategory.SHIELD,
            armorType: ArmorType.SHIELD,
            baseAC: 2,
            strengthReq: null,
            stealthDisadvantage: false
        },
    ]

    for (const armor of armors) {
        await prisma.armor.upsert({
            where: {name: armor.name},
            update: armor,
            create: armor
        })
    }

    console.log(` Seeded ${armors.length} armor pieces`)
}
</file>

<file path="prisma/seed/backgroundSeed.ts">
import { PrismaClient, BackgroundCategory, ToolCategory, Skills, Source, Prisma } from "@prisma/client";

export const seedBackground = async (prisma: PrismaClient) => {
    console.log('Seeding backgrounds...')

    const backgrounds: Prisma.BackgroundCreateInput[] = [
        {
            name: BackgroundCategory.ACOLYTE,
            skillProficiencies: [Skills.INSIGHT, Skills.RELIGION],
            languagesToChooseCount: 2,
            items: [
                { name: ' ', quantity: 1 },
                { name: '   ', quantity: 1 },
                { name: ' ', quantity: 5 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 15 }            ],
            specialAbilityName: ' ',
            description: '  ,    ,    ,       .            ,      ,     -  ,   . ,    ,   (  )    .\n\n    \'   ,     ,    .    ,    ,       ,  ,     .    ,       ,  ,  ,    ,            .'
        },
        {
            name: BackgroundCategory.CHARLATAN,
            skillProficiencies: [Skills.DECEPTION, Skills.SLEIGHT_OF_HAND],
            toolProficiencies: [ToolCategory.DISGUISE_KIT, ToolCategory.FORGERY_KIT],
            items: [
                { name: ' ', quantity: 1 },
                { name: '  ', quantity: 1 },
                {
                    name: '  (,  ,  ,  )',
                    quantity: 1
                },
                { name: '', quantity: 15 }            ],
            specialAbilityName: ' ',
            description: '    ,   ,    ,      .  ,    ,      ,      ,   .'
        },
        {
            name: BackgroundCategory.CRIMINAL,
            skillProficiencies: [Skills.DECEPTION, Skills.STEALTH],
            toolProficiencies: [ToolCategory.GAMING_SET, ToolCategory.THIEVES_TOOLS],
            items: [
                { name: '', quantity: 1 },
                { name: '    ', quantity: 1 },
                { name: '', quantity: 15 }            ],
            specialAbilityName: ' ',
            description: '      ,    \'    .  ,         ; ,           ,    ,        ,   .'
        },
        {
            name: BackgroundCategory.SPY,
            skillProficiencies: [Skills.DECEPTION, Skills.STEALTH],
            toolProficiencies: [ToolCategory.GAMING_SET, ToolCategory.THIEVES_TOOLS],
            items: [
                { name: '', quantity: 1 },
                { name: '    ', quantity: 1 },
                { name: '', quantity: 15 }            ],
            specialAbilityName: ' ',
            description: '      ,    \'      .  ,         ; ,           ,    ,        ,   .'
        },
        {
            name: BackgroundCategory.ENTERTAINER,
            skillProficiencies: [Skills.ACROBATICS, Skills.PERFORMANCE],
            toolProficiencies: [ToolCategory.DISGUISE_KIT, ToolCategory.MUSICAL_INSTRUMENT],
            items: [
                { name: '  ( )', quantity: 1 },
                { name: '   ( ,     )', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 15 }            ],
            specialAbilityName: '  ',
            description: '      ,     ,     ,       .              (   ),   .  ,       .      ,   ,      .'
        },
        {
            name: BackgroundCategory.GLADIATOR,
            skillProficiencies: [Skills.ACROBATICS, Skills.PERFORMANCE],
            toolProficiencies: [ToolCategory.DISGUISE_KIT, ToolCategory.MUSICAL_INSTRUMENT],
            items: [
                { name: '  ( )', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: '  (  )', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 15 }            ],
            specialAbilityName: '  ',
            description: '       ,       .              (   ).  ,       .      ,   ,      .'
        },
        {
            name: BackgroundCategory.FOLK_HERO,
            skillProficiencies: [Skills.ANIMAL_HANDLING, Skills.SURVIVAL],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS, ToolCategory.VEHICLES_LAND],
            items: [
                { name: '  ( )', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }            ],
            specialAbilityName: ' ',
            description: '     ,     .    ,   ,     ,       .       - ,   ,       .'
        },
        {
            name: BackgroundCategory.GUILD_ARTISAN,
            skillProficiencies: [Skills.INSIGHT, Skills.PERSUASION],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS],
            languagesToChooseCount: 1,
            items: [
                { name: '  ( )', quantity: 1 },
                { name: '-  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 15 }            ],
            specialAbilityName: '  ',
            description: '     ,      ,   .         ,  ,    ,    .              ,          ,   .'
        },
        {
            name: BackgroundCategory.GUILD_MERCHANT,
            skillProficiencies: [Skills.INSIGHT, Skills.PERSUASION],
            toolProficiencies: [ToolCategory.NAVIGATORS_TOOLS],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '-  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '   ()', quantity: 1 },
                { name: '', quantity: 15 }            ],
            specialAbilityName: '  ',
            description: '     ,      ,   .         ,  ,    ,    .              ,          ,   .         .'
        },
        {
            name: BackgroundCategory.HERMIT,
            skillProficiencies: [Skills.MEDICINE, Skills.RELIGION],
            toolProficiencies: [ToolCategory.HERBALISM_KIT],
            languagesToChooseCount: 1,
            items: [
                { name: '    ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 5 }
            ],
            specialAbilityName: '',
            description: '            .         .       , ,       .    ,      .    ,   ,     ,    .'
        },
        {
            name: BackgroundCategory.NOBLE,
            skillProficiencies: [Skills.HISTORY, Skills.PERSUASION],
            toolProficiencies: [ToolCategory.GAMING_SET],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '-', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: '', quantity: 25 }
            ],
            specialAbilityName: ' ',
            description: '         .     ,   ,       .    ,       ,              .       ,  .'
        },
        {
            name: BackgroundCategory.KNIGHT,
            skillProficiencies: [Skills.HISTORY, Skills.PERSUASION],
            toolProficiencies: [ToolCategory.GAMING_SET],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '-', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: '', quantity: 25 }
            ],
            specialAbilityName: '',
            description: ' ,    ,     -   ,   .     ,             .      ,    .  - ,     ,    ,      .'
        },
        {
            name: BackgroundCategory.OUTLANDER,
            skillProficiencies: [Skills.ATHLETICS, Skills.SURVIVAL],
            toolProficiencies: [ToolCategory.MUSICAL_INSTRUMENT],
            languagesToChooseCount: 1,
            items: [
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '   ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }            ],
            specialAbilityName: '',
            description: '   \'    ,        ,      .  ,            \'   ,  ,    ,  ,  .'
        },
        {
            name: BackgroundCategory.SAGE,
            skillProficiencies: [Skills.ARCANA, Skills.HISTORY],
            languagesToChooseCount: 2,
            items: [
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '     ,      ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }            ],
            specialAbilityName: '',
            description: '       ,      ,   ,        .      , ,       ,   .  DM  ,  ,   ,     ,      .'
        },
        {
            name: BackgroundCategory.SAILOR,
            skillProficiencies: [Skills.ATHLETICS, Skills.PERCEPTION],
            toolProficiencies: [ToolCategory.NAVIGATORS_TOOLS, ToolCategory.VEHICLES_WATER],
            items: [
                { name: '   ()', quantity: 1 },
                { name: '  (50 )', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }            ],
            specialAbilityName: '  ',
            description: ' ,             -.     ,   ,    ,     .     ,         ,    .            ,       .'
        },
        {
            name: BackgroundCategory.PIRATE,
            skillProficiencies: [Skills.ATHLETICS, Skills.PERCEPTION],
            toolProficiencies: [ToolCategory.NAVIGATORS_TOOLS, ToolCategory.VEHICLES_WATER],
            items: [
                { name: '   ()', quantity: 1 },
                { name: '  (50 )', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }            ],
            specialAbilityName: ' ',
            description: '        .      ,       ,              ,          .'
        },
        {
            name: BackgroundCategory.SOLDIER,
            skillProficiencies: [Skills.ATHLETICS, Skills.INTIMIDATION],
            toolProficiencies: [ToolCategory.GAMING_SET, ToolCategory.VEHICLES_LAND],
            items: [
                { name: ' ', quantity: 1 },
                { name: '   ', quantity: 1 },
                { name: '       ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }            ],
            specialAbilityName: ' ',
            description: '          . ,     ,          ,     .     ,    ,     ,            .'
        },
        {
            name: BackgroundCategory.URCHIN,
            skillProficiencies: [Skills.SLEIGHT_OF_HAND, Skills.STEALTH],
            toolProficiencies: [ToolCategory.DISGUISE_KIT, ToolCategory.THIEVES_TOOLS],
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ,  ', quantity: 1 },
                { name: '  ()', quantity: 1 },
                { name: '  \'  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }],
            specialAbilityName: ' ',
            description: '             ,    .     ,  ( ,   )    -      ,     .'
        },
        {
            name: BackgroundCategory.ANTHROPOLOGIST,
            source: Source.XGTE,
            skillProficiencies: [Skills.INSIGHT, Skills.RELIGION],
            languagesToChooseCount: 2,
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '   ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '    ,      ,     .  ,               .'
        },
        {
            name: BackgroundCategory.ARCHAEOLOGIST,
            source: Source.XGTE,
            skillProficiencies: [Skills.HISTORY, Skills.SURVIVAL],
            toolProficiencies: [ToolCategory.CARTOGRAPHERS_TOOLS, ToolCategory.NAVIGATORS_TOOLS], // :  Navigator's
            languagesToChooseCount: 1,
            items: [
                { name: '\'    ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '   ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: '', quantity: 25 }],
            specialAbilityName: ' ',
            description: '      ,         .  ,            .'
        },
        {
            name: BackgroundCategory.CITY_WATCH,
            source: Source.SCAG,
            skillProficiencies: [Skills.ATHLETICS, Skills.INSIGHT],
            languagesToChooseCount: 2,
            items: [
                { name: '  ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 10 }],
            specialAbilityName: ' ',
            description: '                 .                   .'
        },
        {
            name: BackgroundCategory.CLAN_CRAFTER,
            source: Source.SCAG,
            skillProficiencies: [Skills.HISTORY, Skills.INSIGHT],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS],
            languagesToChooseCount: 1,
            items: [
                { name: '  ( )', quantity: 1 },
                { name: '    ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 5 },
                { name: '  10 ', quantity: 1 }
            ],
            specialAbilityName: ' ',
            description: '     ,     ,    .           ,    .        ,  .'
        },
        {
            name: BackgroundCategory.CLOISTERED_SCHOLAR,
            source: Source.SCAG,
            skillProficiencies: [Skills.HISTORY, Skills.RELIGION],
            languagesToChooseCount: 2,
            items: [
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '    ', quantity: 1 },
                { name: ' ', quantity: 1 }, // 
                { name: '', quantity: 10 }],
            specialAbilityName: '  ',
            description: '         ,      ,   .        ,               .'
        },
        {
            name: BackgroundCategory.COURTIER,
            source: Source.SCAG,
            skillProficiencies: [Skills.INSIGHT, Skills.PERSUASION],
            languagesToChooseCount: 2,
            items: [
                { name: ' ', quantity: 1 },
                { name: '', quantity: 5 }],
            specialAbilityName: ' ',
            description: '  ,      ,       .  ,      ,    .          .'
        },
        {
            name: BackgroundCategory.FACTION_AGENT,
            source: Source.SCAG,
            skillProficiencies: [Skills.INSIGHT, Skills.PERSUASION],
            languagesToChooseCount: 2,
            items: [
                { name: '   ', quantity: 1 },
                { name: '    ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 15 }],
            specialAbilityName: ' ',
            description: '   ,         .       ,       .          ,       .'
        },
        {
            name: BackgroundCategory.FAR_TRAVELER,
            source: Source.SCAG,
            skillProficiencies: [Skills.INSIGHT, Skills.PERCEPTION],
            toolProficiencies: [ToolCategory.MUSICAL_INSTRUMENT], // :  !
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '    ', quantity: 1 },
                { name: '    ', quantity: 1 },
                { name: '    (10 )', quantity: 1 },
                { name: '', quantity: 5 }],
            specialAbilityName: ' ',
            description: '  ,         .          .            ,       .      \'.'
        },
        {
            name: BackgroundCategory.INHERITOR,
            source: Source.SCAG,
            skillProficiencies: [Skills.SURVIVAL, Skills.RELIGION],
            toolProficiencies: [ToolCategory.GAMING_SET], // :  !
            languagesToChooseCount: 1,
            items: [
                { name: ' ( )', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '    ', quantity: 1 },
                { name: '', quantity: 15 }],
            specialAbilityName: '',
            description: '   ,      .    , ,    ,          .      ,   ,   ,     .'
        },
        {
            name: BackgroundCategory.INVESTIGATOR,
            source: Source.SCAG,
            skillProficiencies: [Skills.INSIGHT, Skills.INVESTIGATION],
            languagesToChooseCount: 2,
            items: [
                { name: '', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 10 }],
            specialAbilityName: ' ',
            description: '                 .                   .          .'
        },
        {
            name: BackgroundCategory.KNIGHT_OF_THE_ORDER,
            source: Source.SCAG,
            skillProficiencies: [Skills.ATHLETICS, Skills.PERSUASION],
            toolProficiencies: [ToolCategory.GAMING_SET], // :  !
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '- ', quantity: 1 },
                { name: '    ', quantity: 1 },
                { name: '', quantity: 10 }],
            specialAbilityName: ' ',
            description: '      ,     .    , ,    ,    .            ,           .'
        },
        {
            name: BackgroundCategory.MERCENARY_VETERAN,
            source: Source.SCAG,
            skillProficiencies: [Skills.ATHLETICS, Skills.PERSUASION],
            toolProficiencies: [ToolCategory.GAMING_SET, ToolCategory.VEHICLES_LAND],
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '       ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '     ,  ,   .       ,      ,   .       .'
        },
        {
            name: BackgroundCategory.URBAN_BOUNTY_HUNTER,
            source: Source.SCAG,
            skillProficiencies: [Skills.DECEPTION, Skills.INSIGHT],
            toolProficiencies: [ToolCategory.GAMING_SET, ToolCategory.MUSICAL_INSTRUMENT, ToolCategory.THIEVES_TOOLS], // :  ,   2   
            items: [
                { name: ' ', quantity: 1 },
                { name: '', quantity: 20 }
            ],
            specialAbilityName: '  ',
            description: '          .  ,      ,       .             .'
        },
        {
            name: BackgroundCategory.UTHGARDT_TRIBE_MEMBER,
            source: Source.SCAG,
            skillProficiencies: [Skills.ATHLETICS, Skills.SURVIVAL],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS, ToolCategory.MUSICAL_INSTRUMENT], // :   
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '   ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '        ,   .       ,        .          ,     .'
        },
        {
            name: BackgroundCategory.WATERDHAVIAN_NOBLE,
            source: Source.SCAG,
            skillProficiencies: [Skills.HISTORY, Skills.PERSUASION],
            toolProficiencies: [ToolCategory.GAMING_SET, ToolCategory.MUSICAL_INSTRUMENT], // :   
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '-', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: '', quantity: 20 }
            ],
            specialAbilityName: '   ',
            description: '               .          .  \'         .'
        },
        {
            name: BackgroundCategory.FISHER,
            source: Source.SCAG,
            skillProficiencies: [Skills.HISTORY, Skills.SURVIVAL],
            toolProficiencies: [ToolCategory.FISHING_TACKLE], // !
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '    ,    ,      .                ,    .'
        },
        {
            name: BackgroundCategory.SHIPWRIGHT,
            source: Source.SCAG,
            skillProficiencies: [Skills.HISTORY, Skills.PERCEPTION],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS, ToolCategory.VEHICLES_WATER],
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: '  ',
            description: '    ,      ,    .                 .'
        },
        {
            name: BackgroundCategory.SMUGGLER,
            source: Source.SCAG,
            skillProficiencies: [Skills.ATHLETICS, Skills.DECEPTION],
            toolProficiencies: [ToolCategory.VEHICLES_WATER],
            items: [
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 15 }
            ],
            specialAbilityName: '   ',
            description: '      ,      .     ,         ,   ,      .'
        },
        {
            name: BackgroundCategory.MARINE,
            source: Source.SCAG,
            skillProficiencies: [Skills.ATHLETICS, Skills.SURVIVAL],
            toolProficiencies: [ToolCategory.VEHICLES_LAND, ToolCategory.VEHICLES_WATER],
            items: [
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '    ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: '',
            description: '          .          ,            .'
        },
        {
            name: BackgroundCategory.AZORIUS_FUNCTIONARY,
            source: Source.GGTR,
            skillProficiencies: [Skills.INSIGHT, Skills.INTIMIDATION],
            languagesToChooseCount: 2,
            items: [
                { name: ' ', quantity: 1 },
                { name: '   ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '   ,              .     ,     .          .'
        },
        {
            name: BackgroundCategory.BOROS_LEGIONNAIRE,
            source: Source.GGTR,
            skillProficiencies: [Skills.ATHLETICS, Skills.INTIMIDATION],
            toolProficiencies: [ToolCategory.GAMING_SET, ToolCategory.VEHICLES_LAND],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '   ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '        .    ,     ,      \'.        .'
        },
        {
            name: BackgroundCategory.DIMIR_OPERATIVE,
            source: Source.GGTR,
            skillProficiencies: [Skills.DECEPTION, Skills.STEALTH],
            toolProficiencies: [ToolCategory.DISGUISE_KIT],
            languagesToChooseCount: 1,
            items: [
                { name: '     ', quantity: 3 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '         .              .          .'
        },
        {
            name: BackgroundCategory.GOLGARI_AGENT,
            source: Source.GGTR,
            skillProficiencies: [Skills.NATURE, Skills.SURVIVAL],
            toolProficiencies: [ToolCategory.POISONERS_KIT],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '           .         .          .'
        },
        {
            name: BackgroundCategory.GRUUL_ANARCH,
            source: Source.GGTR,
            skillProficiencies: [Skills.ANIMAL_HANDLING, Skills.ATHLETICS],
            toolProficiencies: [ToolCategory.HERBALISM_KIT],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '          .               .          .'
        },
        {
            name: BackgroundCategory.IZZET_ENGINEER,
            source: Source.GGTR,
            skillProficiencies: [Skills.ARCANA, Skills.INVESTIGATION],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '             .          .        .'
        },
        {
            name: BackgroundCategory.ORZHOV_REPRESENTATIVE,
            source: Source.GGTR,
            skillProficiencies: [Skills.INTIMIDATION, Skills.RELIGION],
            toolProficiencies: [ToolCategory.JEWELERS_TOOLS], // !
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: '\' ',
            description: '    \'      ,      .      \'   .    ,     .'
        },
        {
            name: BackgroundCategory.RAKDOS_CULTIST,
            source: Source.GGTR,
            skillProficiencies: [Skills.ACROBATICS, Skills.PERFORMANCE],
            toolProficiencies: [ToolCategory.MUSICAL_INSTRUMENT],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '      ,    .         ,     .           .'
        },
        {
            name: BackgroundCategory.SELESNYA_INITIATE,
            source: Source.GGTR,
            skillProficiencies: [Skills.NATURE, Skills.PERSUASION],
            toolProficiencies: [ToolCategory.HERBALISM_KIT], // :  ARTISAN_TOOLS
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 5 }
            ],
            specialAbilityName: ' ',
            description: '      ,    ,      .       \'.          .'
        },
        {
            name: BackgroundCategory.SIMIC_SCIENTIST,
            source: Source.GGTR,
            skillProficiencies: [Skills.ARCANA, Skills.MEDICINE],
            toolProficiencies: [ToolCategory.HERBALISM_KIT],
            languagesToChooseCount: 2,
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: '',
            description: '            .       ,   .         .'
        },
        {
            name: BackgroundCategory.GRINNER,
            source: Source.EGTW,
            skillProficiencies: [Skills.DECEPTION, Skills.PERFORMANCE],
            toolProficiencies: [ToolCategory.DISGUISE_KIT, ToolCategory.MUSICAL_INSTRUMENT], // 
            items: [
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '   Golden Grin', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 15 }
            ],
            specialAbilityName: ' ',
            description: '  Golden Grin,      -  .             .        .'
        },
        {
            name: BackgroundCategory.VOLSTRUCKER_AGENT,
            source: Source.EGTW,
            skillProficiencies: [Skills.DECEPTION, Skills.STEALTH],
            toolProficiencies: [ToolCategory.POISONERS_KIT],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '   ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '  ,      .               .         .'
        },
        {
            name: BackgroundCategory.ATHLETE,
            source: Source.MOOT,
            skillProficiencies: [Skills.ACROBATICS, Skills.ATHLETICS],
            toolProficiencies: [ToolCategory.VEHICLES_LAND],
            languagesToChooseCount: 1,
            items: [
                { name: '    ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '        .           .            ,   .'
        },
        {
            name: BackgroundCategory.LOREHOLD_STUDENT,
            source: Source.SACOC,
            skillProficiencies: [Skills.HISTORY, Skills.RELIGION],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 15 }
            ],
            specialAbilityName: ' ',
            description: '  ,           .       .          .'
        },
        {
            name: BackgroundCategory.PRISMARI_STUDENT,
            source: Source.SACOC,
            skillProficiencies: [Skills.ACROBATICS, Skills.PERFORMANCE],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS, ToolCategory.MUSICAL_INSTRUMENT], // 
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '         .             .         .'
        },
        {
            name: BackgroundCategory.QUANDRIX_STUDENT,
            source: Source.SACOC,
            skillProficiencies: [Skills.ARCANA, Skills.NATURE],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 15 }
            ],
            specialAbilityName: ' ',
            description: '           .         .           .'
        },
        {
            name: BackgroundCategory.SILVERQUILL_STUDENT,
            source: Source.SACOC,
            skillProficiencies: [Skills.INTIMIDATION, Skills.PERSUASION],
            languagesToChooseCount: 2,
            items: [
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 15 }
            ],
            specialAbilityName: ' ',
            description: '   ,      .    ,        .          .'
        },
        {
            name: BackgroundCategory.WITHERBLOOM_STUDENT,
            source: Source.SACOC,
            skillProficiencies: [Skills.NATURE, Skills.SURVIVAL],
            toolProficiencies: [ToolCategory.HERBALISM_KIT],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 15 }
            ],
            specialAbilityName: '   ',
            description: '          .      ,    .           .'
        },
        {
            name: BackgroundCategory.ASTRAL_DRIFTER,
            source: Source.SPELLJAMMER, //    source
            skillProficiencies: [Skills.INSIGHT, Skills.RELIGION],
            languagesToChooseCount: 2,
            items: [
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '         .        ,        .         .'
        },
        {
            name: BackgroundCategory.FACELESS,
            source: Source.BGDIA, // Baldur's Gate: Descent into Avernus
            skillProficiencies: [Skills.DECEPTION, Skills.INTIMIDATION],
            toolProficiencies: [ToolCategory.DISGUISE_KIT],
            languagesToChooseCount: 1,
            items: [
                { name: '  ', quantity: 1 },
                { name: '   ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '  ,     .      ,       .    \'   ,     .      .'
        },
        {
            name: BackgroundCategory.FAILED_MERCHANT,
            source: Source.AI, // Acquisitions Incorporated
            skillProficiencies: [Skills.INVESTIGATION, Skills.PERSUASION],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '  ,         .          .         .'
        },
        {
            name: BackgroundCategory.FEYLOST,
            source: Source.WBTW, // Wild Beyond the Witchlight
            skillProficiencies: [Skills.DECEPTION, Skills.SURVIVAL],
            toolProficiencies: [ToolCategory.MUSICAL_INSTRUMENT],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 3 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 8 }
            ],
            specialAbilityName: ' \'',
            description: '       \'   .   ,      ,      - -   ,   .       .'
        },
        {
            name: BackgroundCategory.GAMBLER,
            source: Source.AI,
            skillProficiencies: [Skills.DECEPTION, Skills.INSIGHT],
            toolProficiencies: [ToolCategory.GAMING_SET],
            items: [
                { name: '   ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 15 }
            ],
            specialAbilityName: '  ',
            description: '        .  ,      -       .   ,   ,    ,   .'
        },
        {
            name: BackgroundCategory.HAUNTED_ONE,
            source: Source.COS, // Curse of Strahd
            skillProficiencies: [Skills.ARCANA, Skills.INVESTIGATION],
            languagesToChooseCount: 2,
            items: [
                { name: '', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 3 },
                { name: '  ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '   ', quantity: 1 },
                { name: '', quantity: 3 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: 'sp', quantity: 1 }
            ],
            specialAbilityName: ' ',
            description: ',     ,  ,        .     , ,     ,     .        .'
        },
        {
            name: BackgroundCategory.PLAINTIFF,
            source: Source.AI,
            skillProficiencies: [Skills.MEDICINE, Skills.PERSUASION],
            toolProficiencies: [], //  tool proficiencies
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '', quantity: 20 }
            ],
            specialAbilityName: '  ',
            description: '       .          .       .        .'
        },
        {
            name: BackgroundCategory.RIVAL_INTERN,
            source: Source.AI,
            skillProficiencies: [Skills.HISTORY, Skills.INVESTIGATION],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '            .  ,             .'
        },
        {
            name: BackgroundCategory.WILDSPACER,
            source: Source.SPELLJAMMER, // Spelljammer
            skillProficiencies: [Skills.ATHLETICS, Skills.SURVIVAL],
            toolProficiencies: [ToolCategory.NAVIGATORS_TOOLS, ToolCategory.VEHICLES_WATER], // 
            items: [
                { name: '   ()', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '           .            .        .'
        },
        {
            name: BackgroundCategory.WITCHLIGHT_HAND,
            source: Source.WBTW,
            skillProficiencies: [Skills.PERFORMANCE, Skills.SLEIGHT_OF_HAND],
            toolProficiencies: [ToolCategory.DISGUISE_KIT, ToolCategory.MUSICAL_INSTRUMENT], // 
            languagesToChooseCount: 1,
            items: [
                { name: '     ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 8 }
            ],
            specialAbilityName: ' ',
            description: '            .          ,           \'  .'
        },
        {
            name: BackgroundCategory.KNIGHT_OF_SOLAMNIA,
            source: Source.DRAGONLANCE,
            skillProficiencies: [Skills.ATHLETICS, Skills.SURVIVAL],
            toolProficiencies: [ToolCategory.MUSICAL_INSTRUMENT],
            languagesToChooseCount: 1,
            items: [
                { name: ' ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '  ,  \'       ,    .    ,   ,     .        .'
        },
        {
            name: BackgroundCategory.MAGE_OF_HIGH_SORCERY,
            source: Source.DRAGONLANCE,
            skillProficiencies: [Skills.ARCANA, Skills.HISTORY],
            languagesToChooseCount: 2,
            items: [
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 10 }
            ],
            specialAbilityName: ' ',
            description: '          .        ,      .         .'
        },
        {
            name: BackgroundCategory.HOUSE_AGENT,
            source: Source.EBERRON,
            skillProficiencies: [Skills.INVESTIGATION, Skills.PERSUASION],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS],
            languagesToChooseCount: 1, // !
            items: [
                { name: '  ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 20 }
            ],
            specialAbilityName: ' ',
            description: '   ,         .        ,     ,    .      .'
        },
        {
            name: BackgroundCategory.ARTISAN_2024,
            source: Source.PHB_2024,
            skillProficiencies: [Skills.INVESTIGATION, Skills.PERSUASION],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS],
            items: [
                { name: '  ( )', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 32 }
            ],
            specialAbilityName: ' ',
            description: '        .       ,    ,    .    ,       - .'
        },
        {
            name: BackgroundCategory.CHARLATAN_2024,
            source: Source.PHB_2024,
            skillProficiencies: [Skills.DECEPTION, Skills.SLEIGHT_OF_HAND],
            toolProficiencies: [ToolCategory.FORGERY_KIT],
            items: [
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 15 }
            ],
            specialAbilityName: ' ',
            description: '   ,  ,    .        ,  .           .'
        },
        {
            name: BackgroundCategory.CRIMINAL_2024,
            source: Source.PHB_2024,
            skillProficiencies: [Skills.SLEIGHT_OF_HAND, Skills.STEALTH],
            toolProficiencies: [ToolCategory.THIEVES_TOOLS],
            items: [
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 16 }
            ],
            specialAbilityName: ' ',
            description: '       .  ,   ,        ,   .  \'          .'
        },
        {
            name: BackgroundCategory.ENTERTAINER_2024,
            source: Source.PHB_2024,
            skillProficiencies: [Skills.ACROBATICS, Skills.PERFORMANCE],
            toolProficiencies: [ToolCategory.MUSICAL_INSTRUMENT],
            items: [
                { name: '  ( )', quantity: 1 },
                { name: '', quantity: 2 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 11 }
            ],
            specialAbilityName: '  ',
            description: '       ,   .       ,       .       .'
        },
        {
            name: BackgroundCategory.FARMER_2024,
            source: Source.PHB_2024,
            skillProficiencies: [Skills.ANIMAL_HANDLING, Skills.NATURE],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS],
            items: [
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 10 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 30 }
            ],
            specialAbilityName: ' ',
            description: '       ,         .            .          .'
        },
        {
            name: BackgroundCategory.GUARD_2024,
            source: Source.PHB_2024,
            skillProficiencies: [Skills.ATHLETICS, Skills.PERCEPTION],
            toolProficiencies: [ToolCategory.GAMING_SET],
            items: [
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 20 },
                { name: '  ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 12 }
            ],
            specialAbilityName: ' ',
            description: '            .          .           .'
        },
        {
            name: BackgroundCategory.GUIDE_2024,
            source: Source.PHB_2024,
            skillProficiencies: [Skills.STEALTH, Skills.SURVIVAL],
            toolProficiencies: [ToolCategory.NAVIGATORS_TOOLS],
            items: [
                { name: ' ', quantity: 1 },
                { name: '', quantity: 20 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 3 }
            ],
            specialAbilityName: ' ',
            description: '              .   ,     .       .'
        },
        {
            name: BackgroundCategory.HERMIT_2024,
            source: Source.PHB_2024,
            skillProficiencies: [Skills.MEDICINE, Skills.RELIGION],
            toolProficiencies: [ToolCategory.HERBALISM_KIT],
            items: [
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ()', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 3 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 16 }
            ],
            specialAbilityName: '',
            description: '        -  ,     .           .      .'
        },
        {
            name: BackgroundCategory.MERCHANT_2024,
            source: Source.PHB_2024,
            skillProficiencies: [Skills.ANIMAL_HANDLING, Skills.PERSUASION],
            toolProficiencies: [ToolCategory.NAVIGATORS_TOOLS],
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 22 }
            ],
            specialAbilityName: ' ',
            description: '         .        ,      .         .'
        },
        {
            name: BackgroundCategory.NOBLE_2024,
            source: Source.PHB_2024,
            skillProficiencies: [Skills.HISTORY, Skills.PERSUASION],
            toolProficiencies: [ToolCategory.GAMING_SET],
            items: [
                { name: '  ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: '', quantity: 29 }
            ],
            specialAbilityName: ' ',
            description: '        .      ,        .    ,   .'
        },
        {
            name: BackgroundCategory.SAGE_2024,
            source: Source.PHB_2024,
            skillProficiencies: [Skills.ARCANA, Skills.HISTORY],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS],
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ()', quantity: 1 },
                { name: '', quantity: 8 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 8 }
            ],
            specialAbilityName: '',
            description: '    ,  ,    - , , .          .        .'
        },
        {
            name: BackgroundCategory.SAILOR_2024,
            source: Source.PHB_2024,
            skillProficiencies: [Skills.ATHLETICS, Skills.PERCEPTION],
            toolProficiencies: [ToolCategory.NAVIGATORS_TOOLS],
            items: [
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '  (50 )', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 14 }
            ],
            specialAbilityName: '  ',
            description: '          ,  .           .       .'
        },
        {
            name: BackgroundCategory.SCRIBE_2024,
            source: Source.PHB_2024,
            skillProficiencies: [Skills.INVESTIGATION, Skills.PERCEPTION],
            toolProficiencies: [ToolCategory.ARTISAN_TOOLS],
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 23 }
            ],
            specialAbilityName: ' ',
            description: '          ,   .          .        .'
        },
        {
            name: BackgroundCategory.SOLDIER_2024,
            source: Source.PHB_2024,
            skillProficiencies: [Skills.ATHLETICS, Skills.INTIMIDATION],
            toolProficiencies: [ToolCategory.GAMING_SET],
            items: [
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 20 },
                { name: '  ', quantity: 1 },
                { name: '  ', quantity: 1 },
                { name: '', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 14 }
            ],
            specialAbilityName: ' ',
            description: '       .           ,     .      .'
        },
        {
            name: BackgroundCategory.WAYFARER_2024,
            source: Source.PHB_2024,
            skillProficiencies: [Skills.INSIGHT, Skills.STEALTH],
            toolProficiencies: [ToolCategory.THIEVES_TOOLS],
            items: [
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: ' ', quantity: 1 },
                { name: '', quantity: 16 }
            ],
            specialAbilityName: '',
            description: '       ,     .         ,     .       .'
        },
        {
            name: BackgroundCategory.CUSTOM,
            skillProficiencies: [],
            items: [],
            specialAbilityName: ' ',
            description: '   DM,    ,       .         .'
        }
    ];

    //     upsert
    for (const background of backgrounds) {
        await prisma.background.upsert({
            where: { name: background.name },
            update: background,
            create: background
        })
    }

    console.log(`  ${backgrounds.length} ! `)
}
</file>

<file path="prisma/seed/infusionFeaturesSeed.ts">
import { FeatureDisplayType, PrismaClient, RestType } from "@prisma/client"
import { normalizeFeatureCreateInput, type SeedFeatureCreateInput } from "./helpers/featureDisplayType"

export const seedInfusionFeatures = async ( prisma: PrismaClient ) => {
	console.log( '  Feature  ...' )
	const features: SeedFeatureCreateInput[] = [
		{
			name: '  ',
			engName: 'Infusion: Enhanced Arcane Focus',
			description: '   //. +1    ;   . +2  10 .',
			shortDescription: '+1 ( 10 . +2)   ;  1/2 ',
			displayType: [FeatureDisplayType.PASSIVE],
		},
		{
			name: ' ',
			engName: 'Infusion: Enhanced Defense',
			description: '+1   / ( 10  +2).',
			shortDescription: '+1   ( 10 . +2)',
			displayType: [FeatureDisplayType.PASSIVE],
		},
		{
			name: ' ',
			engName: 'Infusion: Enhanced Weapon',
			description: '+1      ( 10  +2).',
			shortDescription: '+1  / ( 10 . +2)',
			displayType: [FeatureDisplayType.PASSIVE],
		},
		{
			name: ' ',
			engName: 'Infusion: Returning Weapon',
			description: '+1  /;      .',
			shortDescription: '+1  /;   ',
			displayType: [FeatureDisplayType.PASSIVE],
		},
		{
			name: ' ',
			engName: 'Infusion: Repeating Shot',
			description: '+1  /;      .',
			shortDescription: '+1;  ;  ',
			displayType: [FeatureDisplayType.PASSIVE],
		},
		{
			name: ' ',
			engName: 'Infusion: Radiant Weapon',
			description: '+1  /; ;   .',
			shortDescription: '+1; ;  ',
			displayType: [FeatureDisplayType.PASSIVE],
		},
		{
			name: ' ',
			engName: 'Infusion: Mind Sharpener',
			description: '     ( ).',
			shortDescription: '  ',
			displayType: [FeatureDisplayType.PASSIVE],
		},
		{
			name: '  ',
			engName: 'Infusion: Armor of Magical Strength',
			description: '       .  :    =    (  = ,    ).',
			shortDescription: '   ; .  . ',
			displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.BONUSACTION],
		},
		{
			name: '  ',
			engName: 'Infusion: Spell-Refueling Ring',
			description: '  :      3   .',
			shortDescription: ':    3 . (1/)',
			displayType: [FeatureDisplayType.ACTION],
			limitedUsesPer: RestType.DAY,
			usesCount: 1,
		},
		{
			name: ' ',
			engName: 'Infusion: Repulsion Shield',
			description: '+1  ; 4  ( 14).      15 .',
			shortDescription: '+1  ;   ()',
			displayType: [FeatureDisplayType.REACTION],
		},
		{
			name: ' ',
			engName: 'Infusion: Resistant Armor',
			description: '     (, , , , , , , , , ).',
			shortDescription: '    ',
			displayType: [FeatureDisplayType.PASSIVE],
		},
		{
			name: '  ',
			engName: 'Infusion: Boots of the Winding Path',
			description: '    15   ,    .',
			shortDescription: ' :   15 ',
			displayType: [FeatureDisplayType.BONUSACTION],
		},
		{
			name: ' ',
			engName: 'Infusion: Helm of Awareness',
			description: '  ;    ,   .',
			shortDescription: '  ;  ',
			displayType: [FeatureDisplayType.PASSIVE],
		},
		{
			name: ' ',
			engName: 'Infusion: Arcane Propulsion Armor',
			description: '+5   ; - 18 ,  20/60, ;      ;   .',
			shortDescription: '+5 ;  18  (20/60), ',
			displayType: [FeatureDisplayType.PASSIVE],
		},
		{
			name: '-',
			engName: 'Infusion: Homunculus Servant',
			description: ' -.     .',
			shortDescription: ' -',
			displayType: [FeatureDisplayType.PASSIVE],
		},
	]

	for ( const f of features ) {
		const normalized = normalizeFeatureCreateInput(f)
		await prisma.feature.upsert( {
			where: { engName: normalized.engName },
			update: {},
			create: normalized,
		} )
	}
	console.log( ` / infusion features: ${features.length}` )
}
</file>

<file path="prisma/seed/magicItemSeed.ts">
import { ItemRarity, MagicItemType, Prisma, PrismaClient, WeaponCategory } from "@prisma/client"

export const seedMagicItems = async ( prisma: PrismaClient ) => {
    console.log( '     Replicate Magic Item...' )
    const items: Prisma.MagicItemCreateInput[] = [
        // 2nd-level replicables
        {
            name: '  [Bag of Holding]',
            engName: 'Bag of Holding',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '      ,    ,  2       4  .     500 ,    64  .   15 ,    .      .   ,   ,    ,       .     ,     ,     ,       .\n\n        ,   10,     ( 1 ),    .\n\n     ,     [Handy Haversack],   [Portable Hole]   ,       <a href="/spell/1067"> [Gate]</a>   .  \' ,       . -    10           .   .        .',
            shortDescription: ' :  500  / 64 . ',
            requiresAttunement: false,
        },
        {
            name: '   [Cap of Water Breathing]',
            engName: 'Cap of Water Breathing',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '      ,      ,      .       .    ,       ,        .',
            shortDescription: '    ',
            requiresAttunement: false,
        },
        {
            name: '  [Goggles of Night]',
            engName: 'Goggles of Night',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '     ,      60 .     ,       60 .',
            shortDescription: ' 60  ( +60 )',
            requiresAttunement: false,
        },
        {
            name: '  [Prosthetic Limb]',
            engName: 'Prosthetic Limb',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.COMMON,
            description: '      , , ,  .   ,     ,   .        ,        .  ,   .',
            shortDescription: '  ',
            requiresAttunement: true,
        },
        {
            name: '  [Rope of Climbing]',
            engName: 'Rope of Climbing',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: ' 60-    3      3000 .           ,  .             .     10    ,   ,   , , \'  , \'    \'.\n\n    \' ,   \'    1   .   \',    50          .\n\n      \',     10   .    20  20 .   1   5 ,    1 .      0,  .',
            shortDescription: '   \'  ',
            requiresAttunement: false,
        },
        {
            name: '  [Sending Stones]',
            engName: 'Sending Stones',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '  \' ,    ,   ,       .     ,      <a href="/spell/1220"> [Sending]</a> .     .       , ,   ,      .  ,   <a href="/spell/1220"> [Sending]</a>   ,         .       ,   .',
            shortDescription: ' : <a href="/spell/1220"> [Sending]</a> 1 /',
            requiresAttunement: false,
            givesSpells: {
                connect: [{ engName: 'Sending' }]
            },
        },
        {
            name: '   [Wand of Magic Detection]',
            engName: 'Wand of Magic Detection',
            itemType: MagicItemType.WAND,
            rarity: ItemRarity.UNCOMMON,
            description: '   3 .    ,    1  ,    <a href="/spell/1045">  [Detect Magic]</a>  .   13     .',
            shortDescription: '3 : <a href="/spell/1045">  [Detect Magic]</a> ( 13/)',
            requiresAttunement: false,
            givesSpells: {
                connect: [{ engName: 'Detect Magic' }]
            },
        },
        {
            name: '  [Wand of Secrets]',
            engName: 'Wand of Secrets',
            itemType: MagicItemType.WAND,
            rarity: ItemRarity.UNCOMMON,
            description: '  3 .    ,     1   ,          30   ,        \'.   13     .',
            shortDescription: '3 :   /  30  ( 13/)',
            requiresAttunement: false,
        },
        // 6th-level replicables
        {
            name: '  [Boots of Elvenkind]',
            engName: 'Boots of Elvenkind',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '    ,     ,   ,    .        ().',
            shortDescription: ' ,    ()',
            requiresAttunement: false,
        },
        {
            name: '  [Cloak of Elvenkind]',
            engName: 'Cloak of Elvenkind',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '       ,   (), ,   ,  ,        (), ,  ,    ,   .      .',
            shortDescription: ' :     ,   ',
            requiresAttunement: true,
        },
        {
            name: ' - [Cloak of the Manta Ray]',
            engName: 'Cloak of the Manta Ray',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '       ,     ,      60 .      .',
            shortDescription: ' :   ,   60 ',
            requiresAttunement: false,
        },
        {
            name: '  [Eyes of Charming]',
            engName: 'Eyes of Charming',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '     .   3 .    ,    1  ,    <a href="/spell/1318">  [Charm Person]</a> (  13)     30   ,  ,        .        .',
            shortDescription: '3 : <a href="/spell/1318">  [Charm Person]</a>  13 (  )',
            requiresAttunement: true,
            givesSpells: {
                connect: [{ engName: 'Charm Person' }]
            },
        },
        {
            name: '  [Gloves of Thievery]',
            engName: 'Gloves of Thievery',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '   ,   .    ,    +5    ( )   ,    .',
            shortDescription: '+5      ',
            requiresAttunement: false,
        },
        {
            name: '  [Lantern of Revealing]',
            engName: 'Lantern of Revealing',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: ' ,          30       30 .    \'  ,      .               .',
            shortDescription: '   ',
            requiresAttunement: false,
        },
        {
            name: '  [Pipes of Haunting]',
            engName: 'Pipes of Haunting',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '  ****  ,    .   3 .         1 ,   ,  .     30   ,    ,       15      1 .   ,    ,      ,   .          ,      . ,   ,       24 .   13     .',
            shortDescription: '3 :    30   15 ( 13/)',
            requiresAttunement: false,
        },
        {
            name: '    [Ring of Water Walking]',
            engName: 'Ring of Water Walking',
            itemType: MagicItemType.RING,
            rarity: ItemRarity.UNCOMMON,
            description: '    ,       -  ,    .',
            shortDescription: '  ',
            requiresAttunement: false,
            givesSpells: {
                connect: [{ engName: 'Water Walk' }]
            },
        },

        // 10th-level replicables
        {
            name: '    [Boots of Striding and Springing]',
            engName: 'Boots of Striding and Springing',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '    ,     30 ,     ,     ,       .  ,     ,  ,      ,      .',
            shortDescription: ' . 30  (   ),  ',
            requiresAttunement: true,
        },
        {
            name: '   [Boots of the Winterlands]',
            engName: 'Boots of the Winterlands',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.RARE,
            description: '    ,    :      ;    ,    ;       45 C    (  73 C  )  -  .',
            shortDescription: '  ,    (/)',
            requiresAttunement: true,
        },
        {
            name: '  [Bracers of Archery]',
            engName: 'Bracers of Archery',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '    ,  **** ,     +2       ,   .',
            shortDescription: ' , +2   ',
            requiresAttunement: true,

            weaponProficienciesSpecial: {
                specific: [
                    WeaponCategory.SHORTBOW,
                    WeaponCategory.LONGBOW,
                ]
            },
            bonusToRangedDamage: 2,
        },
        {
            name: '  [Brooch of Shielding]',
            engName: 'Brooch of Shielding',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '    ,       ,         <a href="/spell/1333">  [Magic Missile]</a>.',
            shortDescription: '    ,   <a href="/spell/1333">  [Magic Missile]</a>',
            requiresAttunement: true,
            givesSpells: {
                connect: [{ engName: 'Magic Missile' }]
            },
        },
        {
            name: '  [Cloak of Protection]',
            engName: 'Cloak of Protection',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '   +1    ,     .',
            shortDescription: '+1     ',
            requiresAttunement: true,

            bonusToAC: 1,
            bonusToSavingThrows: {
                abilities: ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'],
                bonus: 1,
            },
        },
        {
            name: '  [Eyes of the Eagle]',
            engName: 'Eyes of the Eagle',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '     .    ,       (),    .              \'  ,  2   .',
            shortDescription: '   (),     ',
            requiresAttunement: true,
        },
        {
            name: '  [Gauntlets of Ogre Power]',
            engName: 'Gauntlets of Ogre Power',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '    19,     .      ,     19    .',
            shortDescription: ' = 19',
            requiresAttunement: true,
        },
        {
            name: '   [Gloves of Missile Snaring]',
            engName: 'Gloves of Missile Snaring',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: ' , ,       .       ,    .      ,       110 +   ,  ,      .      0,    ,    ,        .',
            shortDescription: ':      110+,   0',
            requiresAttunement: true,
        },
        {
            name: '    [Gloves of Swimming and Climbing]',
            engName: 'Gloves of Swimming and Climbing',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '    ,        ,     +5    (),     .',
            shortDescription: '/   , +5   (/)',
            requiresAttunement: true,
        },
        {
            name: '  [Hat of Disguise]',
            engName: 'Hat of Disguise',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '    ,      <a href="/spell/1332"> [Disguise Self]</a>   .  ,   .',
            shortDescription: '<a href="/spell/1332"> [Disguise Self]</a> ',
            requiresAttunement: true,
            givesSpells: {
                connect: [{ engName: 'Disguise Self' }]
            },
        },
        {
            name: '\'  [Headband of Intellect]',
            engName: 'Headband of Intellect',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '    19,     \'.      ,     19  .',
            shortDescription: ' = 19',
            requiresAttunement: true,
        },
        {
            name: '  [Helm of Telepathy]',
            engName: 'Helm of Telepathy',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.RARE,
            description: '    ,      <a href="/spell/1297">  [Detect Thoughts]</a> (  13).      ,     ,     ,    .            .    ,       <a href="/spell/1277"> [Suggestion]</a> (  13)    ,      .    <a href="/spell/1277"> [Suggestion]</a>  ,      ,     .',
            shortDescription: '<a href="/spell/1297">  [Detect Thoughts]</a> , <a href="/spell/1277"> [Suggestion]</a> 1/  13',
            requiresAttunement: true,
            givesSpells: {
                connect: [{ engName: 'Detect Thoughts' }, { engName: 'Suggestion' }]
            },
        },
        {
            name: '  [Medallion of Thoughts]',
            engName: 'Medallion of Thoughts',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '  3 .    ,     1 ,    <a href="/spell/1297">  [Detect Thoughts]</a> (  13).   13     .',
            shortDescription: '3 : <a href="/spell/1297">  [Detect Thoughts]</a>  13 ( 13/)',
            requiresAttunement: true,
            givesSpells: {
                connect: [{ engName: 'Detect Thoughts' }]
            },
        },
        {
            name: '  [Necklace of Adaptation]',
            engName: 'Necklace of Adaptation',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '    ,      - ,      ,       (    <a href="/spell/1172">  [Cloudkill]</a>  <a href="/spell/1212">  [Stinking Cloud]</a>,      ).',
            shortDescription: '  - ,   /',
            requiresAttunement: true,
            givesSpells: {
                connect: [{ engName: 'Cloudkill' }, { engName: 'Stinking Cloud' }]
            },
        },
        {
            name: '   [Periapt of Wound Closure]',
            engName: 'Periapt of Wound Closure',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '    ,   ,      .  , ,     \'   -,    -.',
            shortDescription: '  ,     \'',
            requiresAttunement: true,
        },
        {
            name: '  [Pipes of the Sewers]',
            engName: 'Pipes of the Sewers',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '  ****  ,    .     ,              ,          .\n\n  3 .       ****,    ** **    1  3 ,     (   )    ,  ,          ,      (  ).      ,   .        ,       .   13     .\n\n,   ,       ,     30 ,     ,      ****   **** .    ,             24 .    ,  -            ,         ****.     .       ,  ,       .            ,      ,    ,          24 .',
            shortDescription: '    30    ',
            requiresAttunement: true,
        },
        {
            name: '  [Quiver of Ehlonna]',
            engName: 'Quiver of Ehlonna',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '      \'   ,      ,       2 .      60 ,    .     18    \'.     6  \',   ,    .    -   ,         .',
            shortDescription: ' : 60 , 18 , 6  ',
            requiresAttunement: false,
        },
        {
            name: '  [Ring of Jumping]',
            engName: 'Ring of Jumping',
            itemType: MagicItemType.RING,
            rarity: ItemRarity.UNCOMMON,
            description: '    ,      <a href="/spell/1307"> [Jump]</a>  .',
            shortDescription: ': <a href="/spell/1307"> [Jump]</a>  ',
            requiresAttunement: true,
            givesSpells: {
                connect: [{ engName: 'Jump' }]
            },
        },
        {
            name: '   [Ring of Mind Shielding]',
            engName: 'Ring of Mind Shielding',
            itemType: MagicItemType.RING,
            rarity: ItemRarity.UNCOMMON,
            description: '    ,    ,       , ,   ,       .      ,     .      ,     ,    ,      .   ,   ,     ,     .         .     ,      - ,   .       .',
            shortDescription: '   ,   ',
            requiresAttunement: true,
        },
        {
            name: '   [Slippers of Spider Climbing]',
            engName: 'Slippers of Spider Climbing',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '    ,    ,          ,   .    ,     .           ,      .',
            shortDescription: '  =  ,   ',
            requiresAttunement: true,
        },
        {
            name: '  [Ventilating Lungs]',
            engName: 'Ventilating Lungs',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.RARE,
            description: '         ,      .      ,      ,  .         ,         .\n\n    -  ,   ,        -  ( ),         ,   ,    <a href="/spell/1172">  [Cloudkill]</a>,  <a href="/spell/1212">  [Stinking Cloud]</a>,     .\n\n     ,   ,     <a href="/spell/1267">  [Gust of Wind]</a> (  15)  .           .\n\n     ,    \' .',
            shortDescription: '  ,   , <a href="/spell/1267">  [Gust of Wind]</a> 1/',
            requiresAttunement: true,
            givesSpells: {
                connect: [{ engName: 'Gust of Wind' }]
            },
        },

        {
            name: '  [Winged Boots]',
            engName: 'Winged Boots',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.UNCOMMON,
            description: '    ,    ,     .        4 ,      ,      1  .   ,   ,     30   ,   . \n\n   2      12 ,     .',
            shortDescription: '  =    4 /',
            requiresAttunement: true,
        },

        // 14th-level replicables
        {
            name: ' \' [Amulet of Health]',
            engName: 'Amulet of Health',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.RARE,
            description: '    19,     .      ,     19    .',
            shortDescription: ' = 19',
            requiresAttunement: true,
        },
        {
            name: '   [Arcane Propulsion Arm]',
            engName: 'Arcane Propulsion Arm',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.VERY_RARE,
            description: '    -   .     ,         \',   ,       ,   .\n\n  ,    :\n\n       .\n\n     ,   ,      .       .\n\n      ,   .   18         "".       20     60 .         ,        .',
            shortDescription: ' :   18,  ',
            requiresAttunement: true,
        },
        {
            name: '    [Belt of Hill Giant Strength]',
            engName: 'Belt of Hill Giant Strength',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.RARE,
            description: '    ,      21.      ,     21    .',
            shortDescription: ' = 21',
            requiresAttunement: true,
        },
        {
            name: '  [Boots of Levitation]',
            engName: 'Boots of Levitation',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.RARE,
            description: '    ,      <a href="/spell/1507"> [Levitate]</a>   .',
            shortDescription: '<a href="/spell/1507"> [Levitate]</a>   ',
            requiresAttunement: true,
            givesSpells: {
                connect: [{ engName: 'Levitate' }]
            },
        },
        {
            name: '  [Boots of Speed]',
            engName: 'Boots of Speed',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.RARE,
            description: '    ,      \'  .    ,     ,  - ,      ,     .     \'   ,   .         10 ,   ,      .',
            shortDescription: ' :  ,     (10 /)',
            requiresAttunement: true,
        },
        {
            name: '  [Bracers of Defense]',
            engName: 'Bracers of Defense',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.RARE,
            description: '    ,    +2  ,         .',

            bonusToAC: 2,
            noArmorOrShieldForACBonus: true,

            shortDescription: '+2   ( /)',
            requiresAttunement: true,
        },
        {
            name: '  [Cloak of the Bat]',
            engName: 'Cloak of the Bat',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.RARE,
            description: '    ,       ().                     40 .   -                  ,     .\n\n         ,     <a href=\"/spell/1189\"> [Polymorph]</a>  ,   .           ,   .        .  ,     ,  .     ,          .           .',
            shortDescription: '  ,  40   ,    1/',
            requiresAttunement: true,
            givesSpells: {
                connect: [{ engName: 'Polymorph' }]
            },
        },

        {
            name: '  [Dimensional Shackles]',
            engName: 'Dimensional Shackles',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.RARE,
            description: '        .  ,        (5   5   10   10 ).       ,      -   ,        .        .   - ,       ,    ,   . ,   30 ,              30.',
            shortDescription: '    ',
            requiresAttunement: false,
        },
        {
            name: '  [Gem of Seeing]',
            engName: 'Gem of Seeing',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.RARE,
            description: '   3 .          1 .   10        120 ,     .   13     .',
            shortDescription: '3 :   120   10  ( 13/)',
            requiresAttunement: true,
        },
        {
            name: '  [Horn of Blasting]',
            engName: 'Horn of Blasting',
            itemType: MagicItemType.WONDROUS_ITEM,
            rarity: ItemRarity.RARE,
            description: '           ,       30 ,    600  .           15.      56       1 .          .   \',     ,       106    56.  ,    ,  20% ,   .   ,   106     .',
            shortDescription: ' 30 : 56   15, 20%  ',
            requiresAttunement: false,
        },
        {
            name: '   [Ring of Free Action]',
            engName: 'Ring of Free Action',
            itemType: MagicItemType.RING,
            rarity: ItemRarity.RARE,
            description: '    ,       .  ,      ,       .',
            shortDescription: '  ,   /',
            requiresAttunement: true,
        },
        {
            name: '  [Ring of Protection]',
            engName: 'Ring of Protection',
            itemType: MagicItemType.RING,
            rarity: ItemRarity.RARE,
            description: '   +1    ,     .',
            shortDescription: '+1     ',
            requiresAttunement: true,

            bonusToAC: 1,
            bonusToSavingThrows: {
                abilities: ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'],
                bonus: 1,
            },
        },
        {
            name: '  [Ring of the Ram]',
            engName: 'Ring of the Ram',
            itemType: MagicItemType.RING,
            rarity: ItemRarity.RARE,
            description: '   3    13     .    ,      1  3  ,    ,       60   .             +7.         210       5   . \n\n,     1  3   ,    \',       60   ,      .       +5    .',
            shortDescription: '3 :  +7 210   ,  5  ( 13/)',
            requiresAttunement: true,
        },
    ]

    for ( const item of items ) {
        await prisma.magicItem.upsert( {
            where: { engName: item.engName },
            update: {},
            create: item,
        } )
    }
    console.log( ` /  : ${items.length}` )
}
</file>

<file path="src/app/api/auth/[...nextauth]/route.ts">
import { handlers } from "@/lib/auth"
export const { GET, POST } = handlers
export const runtime = 'nodejs'
</file>

<file path="src/components/ui/badge.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return <div className={cn(badgeVariants({ variant }), className)} {...props} />
}

export { Badge, badgeVariants }
</file>

<file path="src/components/ui/checkbox.tsx">
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "grid place-content-center peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator className={cn("grid place-content-center text-current")}>
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }
</file>

<file path="src/components/ui/input.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }
</file>

<file path="src/components/ui/label.tsx">
import * as React from "react"

const Label = React.forwardRef<HTMLLabelElement, React.LabelHTMLAttributes<HTMLLabelElement>>(({ className, ...props }, ref) => (
  <label ref={ref} className={className} {...props} />
))
Label.displayName = "Label"

export { Label }
</file>

<file path="src/components/ui/sonner.tsx">
"use client"

import * as React from "react"
import { useTheme } from "next-themes"
import { Toaster as Sonner } from "sonner"

type ToasterProps = React.ComponentProps<typeof Sonner>

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      toastOptions={{
        classNames: {
          toast:
            "group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",
          description: "group-[.toast]:text-muted-foreground",
          actionButton:
            "group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",
          cancelButton:
            "group-[.toast]:bg-muted group-[.toast]:text-muted-foreground",
        },
      }}
      {...props}
    />
  )
}

export { Toaster }
</file>

<file path="src/components/ui/switch.tsx">
"use client"

import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0"
      )}
    />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }
</file>

<file path="src/components/ui/tabs.tsx">
import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"
import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="src/lib/actions/levelup.ts">
"use server";

import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { FeatPrisma } from "@/lib/types/model-types";
import { createCharacterSnapshot } from "./snapshot-actions";

export async function getLevelUpInfo(persId: number) {
  const session = await auth();
  if (!session?.user?.email) return { error: "Unauthorized" };

  const pers = await prisma.pers.findUnique({
    where: { persId },
    include: {
      class: true,
      subclass: true,
      multiclasses: {
        include: {
          class: true,
          subclass: true,
        },
      },
      race: true,
      subrace: true,
    },
  });

  if (!pers) return { error: "Character not found" };

  const nextLevel = pers.level + 1;
  if (nextLevel > 20) return { error: "Max level reached" };

  const [classes, feats] = await Promise.all([
    prisma.class.findMany({
      include: {
        subclasses: {
          include: {
            features: { include: { feature: true } },
            subclassChoiceOptions: {
              include: {
                choiceOption: {
                  include: {
                    features: { include: { feature: true } },
                  },
                },
              },
            },
            expandedSpells: true,
          },
        },
        startingEquipmentOption: {
          include: {
            equipmentPack: true,
            weapon: true,
            armor: true,
          },
        },
        classChoiceOptions: {
          include: {
            choiceOption: {
              include: {
                features: { include: { feature: true } },
              },
            },
          },
        },
        classOptionalFeatures: {
          include: {
            feature: true,
            replacesFeatures: { include: { replacedFeature: true } },
            appearsOnlyIfChoicesTaken: true,
          },
        },
        features: { include: { feature: true } },
      },
      orderBy: [{ sortOrder: "asc" }, { classId: "asc" }],
    }),
    prisma.feat.findMany({
      include: {
        grantsFeature: true,
        featChoiceOptions: {
          include: {
            choiceOption: {
              include: {
                features: { include: { feature: true } },
              },
            },
          },
        },
      },
      orderBy: [{ name: "asc" }],
    }) as unknown as Promise<FeatPrisma[]>,
  ]);

  const currentClass = classes.find((c) => c.classId === pers.classId);
  const currentSubclass =
    currentClass?.subclasses?.find((s) => s.subclassId === pers.subclassId) ?? null;

  const needsSubclass = !pers.subclassId && nextLevel >= (currentClass?.subclassLevel ?? 3);
  const isASILevel = (currentClass?.abilityScoreUpLevels ?? []).includes(nextLevel);

  const newClassFeatures = (currentClass?.features ?? []).filter((f) => f.levelGranted === nextLevel);
  const newSubclassFeatures = (currentSubclass?.features ?? []).filter((f) => f.levelGranted === nextLevel);

  const classChoiceGroups: Record<string, (typeof currentClass extends undefined ? never : NonNullable<typeof currentClass>["classChoiceOptions"][number])[]> = {} as any;
  const classChoiceOptions = (currentClass?.classChoiceOptions ?? []).filter((opt) =>
    (opt.levelsGranted ?? []).includes(nextLevel)
  );
  for (const opt of classChoiceOptions) {
    const key = opt.choiceOption?.groupName || "";
    if (!classChoiceGroups[key]) classChoiceGroups[key] = [];
    classChoiceGroups[key].push(opt as any);
  }

  const subclassChoiceGroups: Record<string, (typeof currentSubclass extends null ? never : NonNullable<typeof currentSubclass>["subclassChoiceOptions"][number])[]> = {} as any;
  const subclassChoiceOptions = (currentSubclass?.subclassChoiceOptions ?? []).filter((opt) =>
    (opt.levelsGranted ?? []).includes(nextLevel)
  );
  for (const opt of subclassChoiceOptions) {
    const key = opt.choiceOption?.groupName || "";
    if (!subclassChoiceGroups[key]) subclassChoiceGroups[key] = [];
    subclassChoiceGroups[key].push(opt as any);
  }

  return {
    pers,
    nextLevel,
    needsSubclass,
    isASILevel,
    newClassFeatures,
    newSubclassFeatures,
    classChoiceGroups,
    subclassChoiceGroups,
    classes,
    feats,
  };
}

export async function levelUpCharacter(persId: number, data: any) {
    const session = await auth();
    if (!session?.user?.email) return { error: "Unauthorized" };

    try {
    const info = await getLevelUpInfo(persId);
    if ("error" in info) return info;

    const { pers, classes } = info;

    const nextLevel = pers.level + 1;
    if (nextLevel > 20) return { error: "Max level reached" };

    const levelUpPath = data?.levelUpPath === "MULTICLASS" ? "MULTICLASS" : "EXISTING";
    const selectedClassId = Number(data?.classId);
    if (!Number.isFinite(selectedClassId)) return { error: "   " };

    const ownedClassIds = new Set<number>([pers.classId, ...(pers.multiclasses || []).map((m) => m.classId)]);
    const hasClassAlready = ownedClassIds.has(selectedClassId);
    if (levelUpPath === "EXISTING" && !hasClassAlready) {
      return { error: "    .  ." };
    }
    if (levelUpPath === "MULTICLASS" && hasClassAlready) {
      return { error: "   .   ." };
    }

    const selectedClass = (classes as any[]).find((c) => c.classId === selectedClassId);
    if (!selectedClass) return { error: "  " };

    const multiclassRow = (pers.multiclasses || []).find((m) => m.classId === selectedClassId) ?? null;
    const mainClassLevel = (() => {
      const extras = (pers.multiclasses || []).reduce((acc, m) => acc + (m.classLevel || 0), 0);
      const computed = pers.level - extras;
      return computed > 0 ? computed : 1;
    })();

    const classLevelBefore = levelUpPath === "MULTICLASS"
      ? 0
      : selectedClassId === pers.classId
        ? mainClassLevel
        : multiclassRow?.classLevel ?? 0;
    const classLevelAfter = classLevelBefore + 1;

    // ===== 1) Stats =====
    const newStats = {
      str: pers.str,
      dex: pers.dex,
      con: pers.con,
      int: pers.int,
      wis: pers.wis,
      cha: pers.cha,
    };

    const abilityToStatKey: Record<string, keyof typeof newStats> = {
      STR: "str",
      DEX: "dex",
      CON: "con",
      INT: "int",
      WIS: "wis",
      CHA: "cha",
    };

    if (Array.isArray(data?.customAsi)) {
      for (const asi of data.customAsi as Array<{ ability?: string; value?: string }>) {
        const ability = String(asi?.ability || "");
        const key = abilityToStatKey[ability];
        const delta = Number(asi?.value);
        if (!key) continue;
        if (!Number.isFinite(delta) || (delta !== 1 && delta !== 2)) continue;
        newStats[key] += delta;
      }
    }

    // ===== 2) Feat + feat choices =====
    const featId = data?.featId ? Number(data.featId) : undefined;
    const featChoiceSelections = (data?.featChoiceSelections || {}) as Record<string, number>;
    const featChoiceOptionIds = Object.values(featChoiceSelections)
      .map((v) => Number(v))
      .filter((v) => Number.isFinite(v));

    let featFeatureIds: number[] = [];
    let featGrantedASI: any = null;

    if (featId) {
      const feat = await prisma.feat.findUnique({
        where: { featId },
        include: {
          grantsFeature: true,
        },
      });

      if (!feat) return { error: "  " };
      featFeatureIds = feat.grantsFeature.map((f) => f.featureId);
      featGrantedASI = feat.grantedASI as any;

      if (featGrantedASI?.basic?.simple) {
        for (const [ability, bonus] of Object.entries(featGrantedASI.basic.simple as Record<string, unknown>)) {
          const key = abilityToStatKey[String(ability)];
          const delta = Number(bonus);
          if (!key) continue;
          if (!Number.isFinite(delta)) continue;
          newStats[key] += delta;
        }
      }
    }

    // ===== 3) HP increase (from wizard) =====
    const hpIncreaseFromWizard = Number(data?.levelUpHpIncrease);
    const hpIncrease = Number.isFinite(hpIncreaseFromWizard)
      ? Math.max(0, Math.trunc(hpIncreaseFromWizard))
      : (() => {
        // fallback: average
        const conMod = Math.floor((newStats.con - 10) / 2);
        return Math.floor(pers.class.hitDie / 2) + 1 + conMod;
      })();

    const newMaxHp = pers.maxHp + hpIncrease;
    const newCurrentHp = pers.currentHp + hpIncrease;

    // ===== 4) Subclass selection for the selected class =====
    const chosenSubclassIdRaw = data?.subclassId ? Number(data.subclassId) : undefined;
    const existingSubclassIdForClass =
      selectedClassId === pers.classId ? pers.subclassId ?? undefined : multiclassRow?.subclassId ?? undefined;

    const subclassIdForSelectedClass = chosenSubclassIdRaw ?? existingSubclassIdForClass;
    if (subclassIdForSelectedClass) {
      const belongs = (selectedClass.subclasses || []).some((s: any) => s.subclassId === subclassIdForSelectedClass);
      if (!belongs) return { error: "    " };
    }

    const selectedSubclass = subclassIdForSelectedClass
      ? (selectedClass.subclasses || []).find((s: any) => s.subclassId === subclassIdForSelectedClass) ?? null
      : null;

    // ===== 5) Features + choices =====
    const featuresToAdd = new Set<number>();
    const choiceOptionIds: number[] = [];

    // Class features for THIS class level
    for (const cf of (selectedClass.features || [])) {
      if (cf.levelGranted === classLevelAfter) featuresToAdd.add(cf.featureId);
    }

    // Subclass features for THIS class level
    if (selectedSubclass) {
      for (const sf of (selectedSubclass.features || [])) {
        if (sf.levelGranted === classLevelAfter) featuresToAdd.add(sf.featureId);
      }
    }

    // Feat features
    for (const fid of featFeatureIds) featuresToAdd.add(fid);

    const processChoiceSelections = async (selections: Record<string, number> | undefined) => {
      if (!selections) return;
      for (const optionIdRaw of Object.values(selections)) {
        const optionId = Number(optionIdRaw);
        if (!Number.isFinite(optionId)) continue;
        choiceOptionIds.push(optionId);
        const choiceFeatures = await prisma.choiceOptionFeature.findMany({
          where: { choiceOptionId: optionId },
          select: { featureId: true },
        });
        for (const f of choiceFeatures) featuresToAdd.add(f.featureId);
      }
    };

    await processChoiceSelections(data?.classChoiceSelections as Record<string, number> | undefined);
    await processChoiceSelections(data?.subclassChoiceSelections as Record<string, number> | undefined);
    await processChoiceSelections(featChoiceSelections);

    // Optional class features (replacements)
    const optionalSelections = (data?.classOptionalFeatureSelections || {}) as Record<string, boolean>;
    const acceptedOptionalIds = Object.entries(optionalSelections)
      .filter(([, accepted]) => accepted === true)
      .map(([id]) => Number(id))
      .filter((id) => Number.isFinite(id));

    const optionalReplacedFeatureIds = new Set<number>();
    const optionalGrantedFeatureIds = new Set<number>();
    if (acceptedOptionalIds.length) {
      const optionalRecords = await prisma.classOptionalFeature.findMany({
        where: { optionalFeatureId: { in: acceptedOptionalIds } },
        include: {
          replacesFeatures: true,
        },
      });

      for (const opt of optionalRecords) {
        if (opt.featureId) optionalGrantedFeatureIds.add(opt.featureId);
        for (const rep of opt.replacesFeatures) {
          optionalReplacedFeatureIds.add(rep.replacedFeatureId);
        }
      }
    }

    for (const fid of optionalGrantedFeatureIds) featuresToAdd.add(fid);

    // ===== 6) Persist =====
    await prisma.$transaction(async (tx) => {
      // Create snapshot before changes
      await createCharacterSnapshot(persId);

      // multiclass row update/create
      if (levelUpPath === "MULTICLASS") {
        await tx.persMulticlass.create({
          data: {
            persId,
            classId: selectedClassId,
            classLevel: 1,
            subclassId: subclassIdForSelectedClass ?? null,
          },
        });
      } else if (selectedClassId !== pers.classId) {
        // existing multiclass
        await tx.persMulticlass.update({
          where: { persId_classId: { persId, classId: selectedClassId } },
          data: {
            classLevel: classLevelAfter,
            ...(chosenSubclassIdRaw ? { subclassId: chosenSubclassIdRaw } : {}),
          },
        });
      }

      // create or update PersFeat and its choices
      let persFeatId: number | null = null;
      if (featId) {
        const created = await tx.persFeat.upsert({
          where: { featId_persId: { featId, persId } },
          update: {},
          create: { featId, persId },
          select: { persFeatId: true },
        });
        persFeatId = created.persFeatId;
      }

      if (persFeatId && featChoiceOptionIds.length) {
        await tx.persFeatChoice.createMany({
          data: featChoiceOptionIds.map((choiceOptionId) => ({
            persFeatId: persFeatId as number,
            choiceOptionId,
          })),
          skipDuplicates: true,
        });
      }

      // Update Pers core
      await tx.pers.update({
        where: { persId },
        data: {
          level: nextLevel,
          maxHp: newMaxHp,
          currentHp: newCurrentHp,
          ...(selectedClassId === pers.classId
            ? { subclassId: chosenSubclassIdRaw ?? pers.subclassId ?? null }
            : {}),
          ...newStats,
          choiceOptions: choiceOptionIds.length
            ? {
              connect: choiceOptionIds.map((id) => ({ choiceOptionId: id })),
            }
            : undefined,
          classOptionalFeatures: acceptedOptionalIds.length
            ? {
              connect: acceptedOptionalIds.map((optionalFeatureId) => ({ optionalFeatureId })),
            }
            : undefined,
        },
      });

      // Remove replaced features
      if (optionalReplacedFeatureIds.size > 0) {
        await tx.persFeature.deleteMany({
          where: {
            persId,
            featureId: { in: Array.from(optionalReplacedFeatureIds) },
          },
        });
      }

      // Add features
      if (featuresToAdd.size > 0) {
        await tx.persFeature.createMany({
          data: Array.from(featuresToAdd).map((featureId) => ({ persId, featureId })),
          skipDuplicates: true,
        });
      }
    });

    return { success: true };
    } catch (e) {
        console.error(e);
        return { error: "Failed to level up" };
    }
}
</file>

<file path="src/lib/actions/spell-actions.ts">
'use server';

import { auth } from "@/lib/auth";
import { prisma } from '@/lib/prisma';
import { SpellOrigin } from '@prisma/client';
import { revalidatePath } from 'next/cache';

/**
 * Strict: Learn spells during Level-Up
 *   Level-Up    .
 *  origin = CLASS.
 */
export async function learnClassSpells({
  persId,
  spellIds,
  level,
}: {
  persId: number;
  spellIds: number[];
  level: number;
}) {
  try {
    console.log(` Learning ${spellIds.length} class spells for persId=${persId}`);

    //  transaction,    ,  
    await prisma.$transaction(
      spellIds.map((spellId) =>
        prisma.persSpell.create({
          data: {
            persId,
            spellId,
            learnedAtLevel: level,
            origin: SpellOrigin.CLASS,
          },
        })
      )
    );
    
    return { success: true };
  } catch (error) {
    console.error('Failed to learn class spells:', error);
    //    (  ),  ,   
    return { success: false, error: '   ' };
  }
}

/**
 * Flexible: Add manual spell (DM/Player)
 *   ,  .
 *  origin = MANUAL.
 */
export async function addManualSpell({
  persId,
  spellId,
  notes,
}: {
  persId: number;
  spellId: number;
  notes?: string;
}) {
  try {
    await prisma.persSpell.create({
      data: {
        persId,
        spellId,
        learnedAtLevel: 0, // Manual doesn't really have a level requirement
        origin: SpellOrigin.MANUAL,
        notes,
      },
    });

    revalidatePath(`/character/${persId}`);
    return { success: true };
  } catch (error) {
    console.error('Failed to add manual spell:', error);
    return { success: false, error: '   ' };
  }
}

export type SpellForModal = {
  spellId: number;
  name: string;
  engName: string;
  level: number;
  school: string | null;
  castingTime: string;
  duration: string;
  range: string;
  components: string | null;
  description: string;
  source: string;
  hasRitual: string | null;
  hasConcentration: string | null;
  spellClasses: { className: string }[];
  spellRaces: { raceName: string | null }[];
};

export async function getSpellForModal(spellIdOrSlug: string): Promise<SpellForModal | null> {
  const trimmed = (spellIdOrSlug ?? "").trim();
  if (!trimmed) return null;

  const asNumber = Number(trimmed);
  const byId = Number.isFinite(asNumber) ? Math.trunc(asNumber) : null;

  const spell = await prisma.spell.findFirst({
    where: {
      OR: [
        ...(byId ? ([{ spellId: byId }] as const) : []),
        { engName: trimmed },
        { name: trimmed },
      ],
    },
    select: {
      spellId: true,
      name: true,
      engName: true,
      level: true,
      school: true,
      castingTime: true,
      duration: true,
      range: true,
      components: true,
      description: true,
      source: true,
      hasRitual: true,
      hasConcentration: true,
      spellClasses: { select: { className: true } },
      spellRaces: { select: { raceName: true } },
    },
  });

  if (!spell) return null;

  return {
    ...spell,
    source: String(spell.source),
  };
}

export async function toggleSpellForPers({
  persId,
  spellId,
}: {
  persId: number;
  spellId: number;
}): Promise<{ success: true; added: boolean } | { success: false; error: string }> {
  const session = await auth();
  if (!session?.user?.email) return { success: false, error: " " };

  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
    select: { id: true },
  });

  if (!user) return { success: false, error: "  " };

  const pers = await prisma.pers.findUnique({
    where: { persId },
    select: { persId: true, userId: true },
  });

  if (!pers || pers.userId !== user.id) {
    return { success: false, error: "   " };
  }

  const existing = await prisma.persSpell.findUnique({
    where: {
      persId_spellId: {
        persId,
        spellId,
      },
    },
    select: { persSpellId: true },
  });

  if (existing) {
    await prisma.persSpell.delete({
      where: { persSpellId: existing.persSpellId },
    });

    revalidatePath(`/pers/${persId}`);
    return { success: true, added: false };
  }

  await prisma.persSpell.create({
    data: {
      persId,
      spellId,
      learnedAtLevel: 0,
      origin: SpellOrigin.MANUAL,
    },
  });

  revalidatePath(`/pers/${persId}`);
  return { success: true, added: true };
}

export async function removeSpellFromPers({
  persId,
  spellId,
}: {
  persId: number;
  spellId: number;
}): Promise<{ success: true } | { success: false; error: string }> {
  const session = await auth();
  if (!session?.user?.email) return { success: false, error: " " };

  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
    select: { id: true },
  });

  if (!user) return { success: false, error: "  " };

  const pers = await prisma.pers.findUnique({
    where: { persId },
    select: { persId: true, userId: true },
  });

  if (!pers || pers.userId !== user.id) {
    return { success: false, error: "   " };
  }

  await prisma.persSpell.deleteMany({
    where: { persId, spellId },
  });

  revalidatePath(`/pers/${persId}`);
  return { success: true };
}

export async function setSpellPrepared({
  persId,
  spellId,
  isPrepared,
}: {
  persId: number;
  spellId: number;
  isPrepared: boolean;
}): Promise<{ success: true; isPrepared: boolean } | { success: false; error: string }> {
  const session = await auth();
  if (!session?.user?.email) return { success: false, error: " " };

  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
    select: { id: true },
  });
  if (!user) return { success: false, error: "  " };

  const pers = await prisma.pers.findUnique({
    where: { persId },
    select: { persId: true, userId: true },
  });
  if (!pers || pers.userId !== user.id) {
    return { success: false, error: "   " };
  }

  const updated = await prisma.persSpell.update({
    where: {
      persId_spellId: {
        persId,
        spellId,
      },
    },
    data: {
      isPrepared: Boolean(isPrepared),
    },
    select: { isPrepared: true },
  });

  revalidatePath(`/character/${persId}`);
  return { success: true, isPrepared: updated.isPrepared };
}

export async function getSpellsList() {
  const spells = await prisma.spell.findMany({
    select: {
      spellId: true,
      name: true,
      engName: true,
      level: true,
      school: true,
    },
    orderBy: [
      { level: 'asc' },
      { name: 'asc' },
    ],
  });
  return spells;
}
</file>

<file path="src/lib/components/characterCreator/RaceChoiceOptionsForm.tsx">
"use client";

import { useEffect, useMemo, useRef } from "react";
import { useStepForm } from "@/hooks/useStepForm";
import { raceChoiceOptionsSchema } from "@/lib/zod/schemas/persCreateSchema";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import clsx from "clsx";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import type { RaceI } from "@/lib/types/model-types";
import { FormattedDescription } from "@/components/ui/FormattedDescription";

interface Props {
  race?: RaceI | null;
  subraceId?: number | null;
  formId: string;
  onNextDisabledChange?: (disabled: boolean) => void;
}

type RaceWithChoices = RaceI & { raceChoiceOptions?: RaceChoiceOptionLike[] };

type RaceChoiceOptionLike = {
  optionId: number;
  subraceId?: number | null;
  choiceGroupName: string;
  optionName: string;
  description?: string | null;
  selectMultiple?: boolean;
  maxSelection?: number;
};

const RaceChoiceOptionsForm = ({ race, subraceId, formId, onNextDisabledChange }: Props) => {
  const { updateFormData, nextStep } = usePersFormStore();

  const { form, onSubmit } = useStepForm(raceChoiceOptionsSchema, (data) => {
    updateFormData({ raceChoiceSelections: data.raceChoiceSelections });
    nextStep();
  });

  const watchedSelections = form.watch("raceChoiceSelections");
  const selections = useMemo(() => watchedSelections || {}, [watchedSelections]);
  const prevDisabledRef = useRef<boolean | undefined>(undefined);

  const optionsToUse = useMemo(() => {
    const raw = ((race as RaceWithChoices | null | undefined)?.raceChoiceOptions || []) as RaceChoiceOptionLike[];

    return raw.filter((opt) => {
      const optSubraceId = opt.subraceId ?? null;
      if (!optSubraceId) return true;
      if (!subraceId) return false;
      return optSubraceId === subraceId;
    });
  }, [race, subraceId]);

  const groupedOptions = useMemo(() => {
    const groups: Record<string, RaceChoiceOptionLike[]> = {};
    optionsToUse.forEach((opt) => {
      const key = opt.choiceGroupName || " ";
      if (!groups[key]) groups[key] = [];
      groups[key].push(opt);
    });

    return Object.entries(groups).map(([groupName, options]) => ({
      groupName,
      options: options.sort((a, b) => a.optionId - b.optionId),
    }));
  }, [optionsToUse]);

  useEffect(() => {
    let disabled: boolean;

    if (!race) {
      disabled = true;
    } else if (groupedOptions.length === 0) {
      disabled = false;
    } else {
      disabled = groupedOptions.some(({ groupName }) => selections[groupName] === undefined);
    }

    if (prevDisabledRef.current !== disabled) {
      prevDisabledRef.current = disabled;
      onNextDisabledChange?.(disabled);
    }
  }, [race, groupedOptions, selections, onNextDisabledChange]);

  useEffect(() => {
    updateFormData({ raceChoiceSelections: selections });
  }, [selections, updateFormData]);

  const selectOption = (groupName: string, optionId: number) => {
    const next = { ...(selections || {}), [groupName]: optionId };
    form.setValue("raceChoiceSelections", next, { shouldDirty: true });
  };

  if (!race) {
    return (
      <Card className="p-4 text-center text-slate-200">
          .
      </Card>
    );
  }

  if (!groupedOptions.length) {
    return (
      <Card className="p-4 text-center text-slate-200">
             .   .
      </Card>
    );
  }

  return (
    <form id={formId} onSubmit={onSubmit} className="space-y-4">
      <div className="space-y-1 text-center">
        <h2 className="font-rpg-display text-3xl font-semibold uppercase tracking-widest text-slate-200 sm:text-4xl">
           
        </h2>
        <p className="text-sm text-slate-400">
           1    .
        </p>
      </div>

      <div className="space-y-4">
        {groupedOptions.map(({ groupName, options }) => (
          <Card key={groupName}>
            <CardContent className="space-y-3 p-4">
              <div className="flex items-center justify-between gap-3">
                <div>
                  <p className="text-xs uppercase tracking-[0.14em] text-slate-400"></p>
                  <p className="text-base font-semibold text-white">{groupName}</p>
                </div>
                <Badge variant="outline" className="border-white/15 bg-white/5 text-slate-200">
                   1
                </Badge>
              </div>

              <div className="grid gap-3 sm:grid-cols-2">
                {options.map((opt) => {
                  const selected = selections[groupName] === opt.optionId;

                  return (
                    <Card
                      key={opt.optionId}
                      className={clsx(
                        "glass-card cursor-pointer transition-all duration-200",
                        selected ? "glass-active" : ""
                      )}
                      onClick={() => selectOption(groupName, opt.optionId)}
                    >
                      <CardContent className="flex h-full flex-col gap-2 p-3 sm:p-4">
                        <div className="flex items-center justify-between gap-2">
                          <p className="truncate text-sm font-semibold text-white">{opt.optionName}</p>
                          <Badge
                            variant={selected ? "secondary" : "outline"}
                            className={clsx(
                              "border-white/15 bg-white/5 text-slate-200",
                              selected && "text-slate-100"
                            )}
                          >
                            {selected ? "" : ""}
                          </Badge>
                        </div>

                        {opt.description ? (
                          <FormattedDescription
                            content={opt.description}
                            className="text-sm text-slate-200/90"
                          />
                        ) : null}
                      </CardContent>
                    </Card>
                  );
                })}
              </div>
            </CardContent>
          </Card>
        ))}
      </div>
    </form>
  );
};

export default RaceChoiceOptionsForm;
</file>

<file path="src/lib/components/characterSheet/slides/MagicSlide.tsx">
"use client";

import { PersWithRelations } from "@/lib/actions/pers";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { formatModifier } from "@/lib/logic/utils";
import { Check, Sparkles, Trash2 } from "lucide-react";
import { useEffect, useMemo, useState, useTransition } from "react";
import { SPELL_SLOT_PROGRESSION } from "@/lib/refs/static";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { spellSchoolTranslations } from "@/lib/refs/translation";
import { removeSpellFromPers, setSpellPrepared } from "@/lib/actions/spell-actions";
import { spendPactSlot, spendSpellSlot, restorePactSlot, restoreSpellSlot } from "@/lib/actions/spell-slots";
import { useRouter } from "next/navigation";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { calculateSpellAttack, calculateSpellDC } from "@/lib/logic/bonus-calculator";
import ModifyStatModal, { ModifyConfig } from "../ModifyStatModal";
import { Ability } from "@prisma/client";
import { calculateCasterLevel } from "@/lib/logic/spell-logic";
import AddSpellDialog from "../AddSpellDialog";

interface MagicSlideProps {
  pers: PersWithRelations;
  onPersUpdate: (next: PersWithRelations) => void;
  isReadOnly?: boolean;
}

export default function MagicSlide({ pers, onPersUpdate, isReadOnly }: MagicSlideProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();

  const [confirmDeleteSpellId, setConfirmDeleteSpellId] = useState<number | null>(null);
  const [removingSpellIds, setRemovingSpellIds] = useState<Set<number>>(() => new Set());

  const [localPers, setLocalPers] = useState<PersWithRelations>(pers);
  const [modifyConfig, setModifyConfig] = useState<ModifyConfig | null>(null);

  useEffect(() => {
    setLocalPers(pers);
  }, [pers]);

  const spellcastingAbility = localPers.class?.primaryCastingStat;
  
  const spellAttackBonus = useMemo(() => {
    if (!spellcastingAbility) return 0;
    return calculateSpellAttack(localPers, spellcastingAbility as Ability);
  }, [localPers, spellcastingAbility]);

  const spellSaveDC = useMemo(() => {
    if (!spellcastingAbility) return 8;
    return calculateSpellDC(localPers, spellcastingAbility as Ability);
  }, [localPers, spellcastingAbility]);

  const [localPersSpells, setLocalPersSpells] = useState(() => (localPers as any).persSpells ?? []);
  const [spellQuery, setSpellQuery] = useState("");

  // If data refreshes from server, keep local list in sync.
  useEffect(() => {
    setLocalPersSpells((localPers as any).persSpells ?? []);
  }, [localPers]);

  const [localCurrentSlots, setLocalCurrentSlots] = useState<number[]>(() => {
    const raw = (pers.currentSpellSlots ?? []) as number[];
    return Array.from({ length: 9 }, (_, idx) => {
      const v = raw[idx];
      return Number.isFinite(v) ? Math.max(0, Math.trunc(v)) : 0;
    });
  });

  const [localPactSlots, setLocalPactSlots] = useState<number>(() => {
    const v = (pers as any).currentPactSlots;
    return Number.isFinite(v) ? Math.max(0, Math.trunc(v)) : 0;
  });

  useEffect(() => {
    const raw = (localPers.currentSpellSlots ?? []) as number[];
    setLocalCurrentSlots(
      Array.from({ length: 9 }, (_, idx) => {
        const v = raw[idx];
        return Number.isFinite(v) ? Math.max(0, Math.trunc(v)) : 0;
      })
    );
    const pact = (localPers as any).currentPactSlots;
    setLocalPactSlots(Number.isFinite(pact) ? Math.max(0, Math.trunc(pact)) : 0);
  }, [localPers.currentSpellSlots, (localPers as any).currentPactSlots]);

  const caster = useMemo(() => calculateCasterLevel(localPers as any), [localPers]);

  const maxSlots = useMemo(() => {
    const level = Math.max(0, Math.min(20, Math.trunc(caster.casterLevel || 0)));
    if (level <= 0) return Array.from({ length: 9 }, () => 0);
    const row = (SPELL_SLOT_PROGRESSION as any).FULL?.[level] as number[] | undefined;
    if (!Array.isArray(row)) return Array.from({ length: 9 }, () => 0);
    return Array.from({ length: 9 }, (_, idx) => {
      const v = row[idx];
      return Number.isFinite(v) ? Math.max(0, Math.trunc(v)) : 0;
    });
  }, [caster.casterLevel]);

  const pactInfo = useMemo(() => {
    const pactLevel = Math.max(0, Math.min(20, Math.trunc(caster.pactLevel || 0)));
    const pact = (SPELL_SLOT_PROGRESSION as any).PACT?.[pactLevel] as { slots: number; level: number } | undefined;
    if (!pact || pactLevel <= 0) return null;
    return {
      max: Math.max(0, Math.trunc(pact.slots)),
      slotLevel: Math.max(1, Math.min(9, Math.trunc(pact.level))),
    };
  }, [caster.pactLevel]);

  const spellsByLevel = useMemo(() => {
    const query = spellQuery.trim().toLowerCase();
    const source = (localPersSpells as any[]).filter((ps) => {
      if (!query) return true;
      const name = String(ps?.spell?.name ?? "").toLowerCase();
      return name.includes(query);
    });

    const byLevel: Record<number, any[]> = {};
    for (const ps of source) {
      const level = Number(ps?.spell?.level ?? 0);
      if (!byLevel[level]) byLevel[level] = [];
      byLevel[level].push(ps);
    }

    for (const [k, list] of Object.entries(byLevel)) {
      byLevel[Number(k)] = list.sort((a, b) => {
        const aName = String(a?.spell?.name ?? "");
        const bName = String(b?.spell?.name ?? "");
        return aName.localeCompare(bName, "uk", { sensitivity: "base" });
      });
    }

    return byLevel;
  }, [localPersSpells, spellQuery]);

  const levels = useMemo(() => {
    return Object.keys(spellsByLevel)
      .map((k) => Number(k))
      .filter((n) => Number.isFinite(n))
      .sort((a, b) => a - b);
  }, [spellsByLevel]);

  const openSpell = (spellId: number) => {
    if (typeof window === "undefined") return;
    const url = new URL(window.location.href);
    url.searchParams.set("spell", String(spellId));
    window.history.pushState({}, "", url);
    window.dispatchEvent(new CustomEvent("spell:open", { detail: { spellId: String(spellId) } }));
    window.dispatchEvent(new Event("locationchange"));
  };

  return (
    <div
      className="h-full overflow-y-auto p-4 space-y-4"
      onClick={() => {
        setConfirmDeleteSpellId(null);
      }}
    >
      <AddSpellDialog 
        pers={localPers} 
        onPersUpdate={(next) => {
            setLocalPers(next);
            onPersUpdate(next);
        }} 
        isReadOnly={isReadOnly} 
      />

      {/* Spell Stats */}
      <div className="grid grid-cols-2 gap-2">
        <Card 
            className={"glass-card bg-fuchsia-500/20 border-fuchsia-400/40 transition " + (!isReadOnly ? "cursor-pointer hover:bg-fuchsia-500/30 active:scale-[0.98]" : "")}
            onClick={(e) => {
                e.stopPropagation();
                if (!isReadOnly) setModifyConfig({ type: "simple", field: "spellAttack" });
            }}
        >
          <CardContent className="p-3 text-center">
            <div className="text-[10px] font-bold uppercase tracking-wide text-fuchsia-300"> </div>
            <div className="text-2xl font-bold text-fuchsia-50 drop-shadow-[0_0_8px_rgba(217,70,239,0.4)]">{formatModifier(spellAttackBonus)}</div>
          </CardContent>
        </Card>
        <Card 
            className={"glass-card bg-fuchsia-500/20 border-fuchsia-400/40 transition " + (!isReadOnly ? "cursor-pointer hover:bg-fuchsia-500/30 active:scale-[0.98]" : "")}
            onClick={(e) => {
                e.stopPropagation();
                if (!isReadOnly) setModifyConfig({ type: "simple", field: "spellDC" });
            }}
        >
          <CardContent className="p-3 text-center">
            <div className="text-[10px] font-bold uppercase tracking-wide text-fuchsia-300">DC </div>
            <div className="text-2xl font-bold text-fuchsia-50 drop-shadow-[0_0_8px_rgba(217,70,239,0.4)]">{spellSaveDC}</div>
          </CardContent>
        </Card>
      </div>

      {/* Spell Slots */}
      <Card className="glass-card bg-white/5 border-purple-300/20">
        <CardHeader className="pb-3">
          <CardTitle className="text-lg flex items-center gap-2 text-purple-50">
            <span className="uppercase tracking-wide text-indigo-300"></span>
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-3 gap-2">
            {Array.from({ length: 9 }, (_, idx) => {
              const level = idx + 1;
              const cur = localCurrentSlots[idx] ?? 0;
              const max = maxSlots[idx] ?? 0;
              
              const canSpend = cur > 0;
              const canRestore = cur < max;

              return (
                <DropdownMenu key={level}>
                  <DropdownMenuTrigger asChild>
                    <button
                      type="button"
                      disabled={isPending || max <= 0 || isReadOnly}
                      title={isReadOnly ? " " : max > 0 ? ",   " : " "}
                      className={
                        "rounded-lg border border-white/10 bg-white/5 px-3 py-2 text-center transition " +
                        (max > 0 && !isReadOnly ? "hover:bg-white/10 cursor-pointer" : "opacity-70 cursor-not-allowed")
                      }
                    >
                      <div className="text-[10px] uppercase tracking-[0.16em] text-slate-400">{level}-</div>
                      <div className="text-sm font-semibold text-slate-50">
                        {cur}/{max}
                      </div>
                    </button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="center" className="bg-slate-900/95 border-white/10 text-slate-100 backdrop-blur-md">
                    <DropdownMenuItem 
                      disabled={!canSpend || isPending}
                      className="focus:bg-white/10 focus:text-slate-50 cursor-pointer"
                      onClick={(e) => {
                        if (!canSpend) return;
                        setLocalCurrentSlots((prev) => {
                          const next = prev.slice();
                          next[idx] = Math.max(0, (next[idx] ?? 0) - 1);
                          return next;
                        });
                        startTransition(async () => {
                          const res = await spendSpellSlot(localPers.persId, level);
                          if (!res.success) {
                            router.refresh();
                            return;
                          }
                          setLocalCurrentSlots(
                            Array.from({ length: 9 }, (_, j) => {
                              const v = res.currentSpellSlots[j];
                              return Number.isFinite(v) ? Math.max(0, Math.trunc(v)) : 0;
                            })
                          );
                          router.refresh();
                        });
                      }}
                    >
                      
                    </DropdownMenuItem>
                    <DropdownMenuItem 
                      disabled={!canRestore || isPending}
                      className="focus:bg-white/10 focus:text-slate-50 cursor-pointer"
                      onClick={(e) => {
                        if (!canRestore) return;
                        setLocalCurrentSlots((prev) => {
                          const next = prev.slice();
                          next[idx] = Math.min(max, (next[idx] ?? 0) + 1);
                          return next;
                        });
                        startTransition(async () => {
                          const res = await restoreSpellSlot(localPers.persId, level);
                          if (!res.success) {
                            router.refresh();
                            return;
                          }
                          setLocalCurrentSlots(
                            Array.from({ length: 9 }, (_, j) => {
                              const v = res.currentSpellSlots[j];
                              return Number.isFinite(v) ? Math.max(0, Math.trunc(v)) : 0;
                            })
                          );
                          router.refresh();
                        });
                      }}
                    >
                      
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
              );
            })}
          </div>

          {pactInfo ? (
            <div className="mt-3 rounded-lg border border-white/10 bg-white/5 px-3 py-2 flex items-center justify-between">
              <div>
                <div className="text-[10px] uppercase tracking-[0.16em] text-slate-400"> </div>
                <div className="text-sm font-semibold text-slate-50">
                  {localPactSlots}/{pactInfo.max}   : {pactInfo.slotLevel}
                </div>
              </div>
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button
                    type="button"
                    size="sm"
                    variant="secondary"
                    disabled={isPending || isReadOnly}
                    title={isReadOnly ? " " : ",     "}
                  >
                    
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end" className="bg-slate-900/95 border-white/10 text-slate-100 backdrop-blur-md">
                  <DropdownMenuItem
                    disabled={localPactSlots <= 0 || isPending}
                    className="focus:bg-white/10 focus:text-slate-50 cursor-pointer"
                    onClick={(e) => {
                      if (!pactInfo || localPactSlots <= 0) return;
                      setLocalPactSlots((v) => Math.max(0, v - 1));
                      startTransition(async () => {
                        const res = await spendPactSlot(localPers.persId);
                        if (!res.success) {
                          router.refresh();
                          return;
                        }
                        setLocalPactSlots(Math.max(0, Math.trunc(res.currentPactSlots)));
                        router.refresh();
                      });
                    }}
                  >
                    
                  </DropdownMenuItem>
                  <DropdownMenuItem
                    disabled={localPactSlots >= pactInfo.max || isPending}
                    className="focus:bg-white/10 focus:text-slate-50 cursor-pointer"
                    onClick={(e) => {
                      if (!pactInfo || localPactSlots >= pactInfo.max) return;
                      setLocalPactSlots((v) => Math.min(pactInfo.max, v + 1));
                      startTransition(async () => {
                        const res = await restorePactSlot(localPers.persId);
                        if (!res.success) {
                          router.refresh();
                          return;
                        }
                        setLocalPactSlots(Math.max(0, Math.trunc(res.currentPactSlots)));
                        router.refresh();
                      });
                    }}
                  >
                    
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            </div>
          ) : null}
        </CardContent>
      </Card>

      {/* Spell List */}
      <Card className="glass-card bg-white/5 border-purple-300/20">
        <CardHeader className="pb-3">
          <CardTitle className="text-lg flex items-center gap-2 text-purple-50">
            <Sparkles className="w-5 h-5" />
            <span className="uppercase tracking-wide text-indigo-300"></span>
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          <Input
            value={spellQuery}
            onChange={(e) => setSpellQuery(e.target.value)}
            placeholder=" "
            className="bg-white/5 border-white/10 text-slate-100 placeholder:text-slate-400"
          />

          {levels.map((level) => {
            const list = spellsByLevel[level] ?? [];
            if (!list.length) return null;

            return (
              <Card key={level} className="border-white/10 bg-white/5">
                <CardHeader className="pb-2 py-3 bg-white/5">
                  <CardTitle className="text-base flex justify-between items-center">
                    <span>{level === 0 ? "" : ` ${level}`}</span>
                  </CardTitle>
                </CardHeader>
                <CardContent className="p-0">
                  {list.map((ps: any, i: number) => {
                    const spell = ps?.spell;
                    const spellId = Number(spell?.spellId);
                    const isLast = i === list.length - 1;
                    const isConfirming = Number.isFinite(spellId) && confirmDeleteSpellId === spellId;
                    const isRemoving = Number.isFinite(spellId) && removingSpellIds.has(spellId);
                    const prepared = Boolean(ps?.isPrepared);
                    const canPrepare = Number(spell?.level ?? 0) > 0;

                    return (
                      <div
                        key={ps?.persSpellId ?? `${spellId}-${i}`}
                        className={
                          "w-full overflow-hidden p-3 transition-all duration-200 hover:bg-white/5 " +
                          (isLast ? "" : "border-b border-white/10 ") +
                          (isRemoving ? "opacity-0 translate-x-2 max-h-0 py-0" : "opacity-100 translate-x-0 max-h-24")
                        }
                      >
                        <div className="flex items-center justify-between gap-2">
                          <button
                            type="button"
                            className="flex-1 min-w-0 max-w-[70%] text-left"
                            onClick={() => {
                              if (Number.isFinite(spellId)) openSpell(spellId);
                            }}
                          >
                            <div className="font-medium text-slate-50 truncate">{spell?.name ?? ""}</div>
                            <div className="text-xs text-slate-300/70 truncate">
                              {(spellSchoolTranslations as any)[spell?.school] || spell?.school || ""}  {spell?.castingTime ?? ""}  {spell?.range ?? ""}
                            </div>
                          </button>

                          <div className="flex items-center gap-2 shrink-0">
                            <Button
                              type="button"
                              size="icon"
                              variant="ghost"
                              aria-label={prepared ? " " : "  "}
                              disabled={isPending || !Number.isFinite(spellId) || isRemoving || !canPrepare || isReadOnly}
                              title={
                                isReadOnly
                                  ? " "
                                  : canPrepare
                                  ? "    ,   ()  "
                                  : "   "
                              }
                              className={
                                "h-9 w-9 border transition-colors " +
                                (prepared
                                  ? "border-emerald-400/40 bg-emerald-500/20 text-emerald-200 hover:bg-emerald-500/30"
                                  : "border-white/10 bg-white/5 text-slate-200 hover:bg-white/10")
                              }
                              onClick={(e) => {
                                e.stopPropagation();
                                if (!Number.isFinite(spellId) || isRemoving || !canPrepare || isReadOnly) return;
                                const nextPrepared = !prepared;
                                // ... rest of onClick

                                setLocalPersSpells((prev: any[]) =>
                                  prev.map((x) => {
                                    const xSpellId = Number(x?.spellId ?? x?.spell?.spellId);
                                    if (xSpellId !== spellId) return x;
                                    return { ...x, isPrepared: nextPrepared };
                                  })
                                );

                                startTransition(async () => {
                                  const res = await setSpellPrepared({
                                    persId: localPers.persId,
                                    spellId,
                                    isPrepared: nextPrepared,
                                  });
                                  if (!res.success) {
                                    router.refresh();
                                    return;
                                  }
                                  setLocalPersSpells((prev: any[]) =>
                                    prev.map((x) => {
                                      const xSpellId = Number(x?.spellId ?? x?.spell?.spellId);
                                      if (xSpellId !== spellId) return x;
                                      return { ...x, isPrepared: res.isPrepared };
                                    })
                                  );
                                  router.refresh();
                                });
                              }}
                            >
                              <Check className="h-4 w-4" />
                            </Button>

                            <Button
                            type="button"
                            size="icon"
                            variant="ghost"
                            aria-label={isConfirming ? " " : " "}
                            disabled={isPending || !Number.isFinite(spellId) || isRemoving || isReadOnly}
                            className={
                              "h-9 w-9 shrink-0 border transition-colors " +
                              (isConfirming
                                ? "border-red-400/40 bg-red-500/20 text-red-200 hover:bg-red-500/30"
                                : "border-white/10 bg-white/5 text-slate-200 hover:bg-white/10")
                            }
                            onClick={(e) => {
                              e.stopPropagation();
                              if (!Number.isFinite(spellId) || isRemoving || isReadOnly) return;

                              if (!isConfirming) {
                                setConfirmDeleteSpellId(spellId);
                                return;
                              }

                              // Confirmed: animate out, then remove.
                              startTransition(async () => {
                                const res = await removeSpellFromPers({ persId: localPers.persId, spellId });
                                if (!res.success) return;

                                setRemovingSpellIds((prev) => {
                                  const next = new Set(prev);
                                  next.add(spellId);
                                  return next;
                                });

                                window.setTimeout(() => {
                                  setLocalPersSpells((prev: any[]) =>
                                    prev.filter((x) => Number(x?.spellId ?? x?.spell?.spellId) !== spellId)
                                  );
                                  setRemovingSpellIds((prev) => {
                                    const next = new Set(prev);
                                    next.delete(spellId);
                                    return next;
                                  });
                                  setConfirmDeleteSpellId(null);
                                  router.refresh();
                                }, 200);
                              });
                            }}
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </CardContent>
              </Card>
            );
          })}

          {levels.length === 0 && (
            <div className="text-purple-300/60 text-sm text-center py-8">
              {spellQuery.trim() ? "  " : " "}
            </div>
          )}
        </CardContent>
      </Card>

      <ModifyStatModal 
        open={modifyConfig !== null}
        onOpenChange={(open) => !open && setModifyConfig(null)}
        pers={localPers}
        onPersUpdate={(next) => {
            setLocalPers(next);
            onPersUpdate(next);
        }}
        config={modifyConfig}
      />
    </div>
  );
}
</file>

<file path="src/lib/components/characterSheet/StatsPage.tsx">
"use client";

import { PersWithRelations } from "@/lib/actions/pers";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { getAbilityMod, formatModifier, getProficiencyBonus, skillAbilityMap } from "@/lib/logic/utils";
import { Badge } from "@/components/ui/badge";
import { Skills } from "@prisma/client";

export default function StatsPage({ pers }: { pers: PersWithRelations }) {
  const pb = getProficiencyBonus(pers.level);

  // Group all skills by ability score
  const skillsByAbility = {
    STR: [
      { skill: Skills.ATHLETICS, name: "" }
    ],
    DEX: [
      { skill: Skills.ACROBATICS, name: "" },
      { skill: Skills.SLEIGHT_OF_HAND, name: " " },
      { skill: Skills.STEALTH, name: "" }
    ],
    INT: [
      { skill: Skills.ARCANA, name: "" },
      { skill: Skills.HISTORY, name: "" },
      { skill: Skills.INVESTIGATION, name: "" },
      { skill: Skills.NATURE, name: "" },
      { skill: Skills.RELIGION, name: "" }
    ],
    WIS: [
      { skill: Skills.ANIMAL_HANDLING, name: "  " },
      { skill: Skills.INSIGHT, name: " " },
      { skill: Skills.MEDICINE, name: "" },
      { skill: Skills.PERCEPTION, name: "" },
      { skill: Skills.SURVIVAL, name: "" }
    ],
    CHA: [
      { skill: Skills.DECEPTION, name: "" },
      { skill: Skills.INTIMIDATION, name: "" },
      { skill: Skills.PERFORMANCE, name: "" },
      { skill: Skills.PERSUASION, name: "" }
    ]
  };

  const abilityGroups = [
    { ability: "STR", name: "", score: pers.str },
    { ability: "DEX", name: "", score: pers.dex },
    { ability: "INT", name: "", score: pers.int },
    { ability: "WIS", name: "", score: pers.wis },
    { ability: "CHA", name: "", score: pers.cha }
  ] as const;

  const getSkillProficiency = (skillName: Skills) => {
    const persSkill = pers.skills.find(ps => ps.name === skillName);
    return persSkill?.proficiencyType || 'NONE';
  };

  const calculateSkillModifier = (skillName: Skills, abilityScore: number) => {
    const abilityMod = getAbilityMod(abilityScore);
    const proficiency = getSkillProficiency(skillName);
    let total = abilityMod;
    if (proficiency === 'PROFICIENT') total += pb;
    if (proficiency === 'EXPERTISE') total += pb * 2;
    return { total, proficiency };
  };

  return (
    <div className="space-y-3">
      {abilityGroups.map(({ ability, name, score }) => (
        <Card key={ability} className="bg-white/10 border-purple-300/30 backdrop-blur">
          <CardHeader className="pb-3">
            <CardTitle className="text-base flex items-center justify-between text-purple-50">
              <span>{name}</span>
              <span className="text-2xl font-bold text-purple-200">{formatModifier(getAbilityMod(score))}</span>
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-1">
            {skillsByAbility[ability as keyof typeof skillsByAbility].map(({ skill, name: skillName }) => {
              const { total, proficiency } = calculateSkillModifier(skill, score);
              const isProficient = proficiency !== 'NONE';
              
              return (
                <div 
                  key={skill} 
                  className={`flex justify-between items-center border-b border-purple-400/20 last:border-0 py-1.5 ${!isProficient ? 'opacity-40' : ''}`}
                >
                  <span className="text-sm text-purple-100">{skillName}</span>
                  <div className="flex items-center gap-2">
                    <span className="font-bold text-sm text-purple-200">{formatModifier(total)}</span>
                    {proficiency !== 'NONE' && (
                      <Badge variant="secondary" className="text-[10px] h-5 px-1.5 bg-purple-500/30 text-purple-100 border-purple-400/30">
                        {proficiency === 'EXPERTISE' ? '' : ''}
                      </Badge>
                    )}
                  </div>
                </div>
              );
            })}
          </CardContent>
        </Card>
      ))}
    </div>
  );
}
</file>

<file path="src/lib/components/icons/Logo.tsx">
import Image from "next/image";

export const Logo = ({ className }: { className?: string }) => {
  const sizeClassName = className ?? "h-10 w-10";

  return (
    <div className={`relative overflow-hidden ${sizeClassName}`}>
      <Image
        src="/images/logo-new.png"
        alt="logo"
        fill
        style={{  //     style  className  
          objectFit: 'contain'
        }}
        sizes="40px"  // ,   ,     
      />
    </div>
  )
}
</file>

<file path="src/lib/hooks/useMediaQuery.ts">
'use client';

import { useSyncExternalStore } from 'react';

export function useMediaQuery(query: string): boolean {
  const subscribe = (onStoreChange: () => void) => {
    const media = window.matchMedia(query);
    const listener = () => onStoreChange();

    media.addEventListener('change', listener);
    return () => media.removeEventListener('change', listener);
  };

  const getSnapshot = () => window.matchMedia(query).matches;
  const getServerSnapshot = () => false;

  return useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot);
}
</file>

<file path="src/lib/logic/spell-logic.ts">
import { Classes, SpellcastingType } from "@prisma/client";

export type SpellcastingClassLevel = {
  classLevel: number;
  class?: {
    name?: Classes | string | null;
    spellcastingType?: SpellcastingType | null;
  } | null;
  subclass?: {
    spellcastingType?: SpellcastingType | null;
  } | null;
};

export type SpellcastingPersLike = {
  level: number;
  class?: { name?: Classes | string | null; spellcastingType?: SpellcastingType | null } | null;
  subclass?: { spellcastingType?: SpellcastingType | null } | null;
  multiclasses?: Array<{
    classLevel: number;
    class?: { name?: Classes | string | null; spellcastingType?: SpellcastingType | null } | null;
    subclass?: { spellcastingType?: SpellcastingType | null } | null;
  }>;
};

export type CasterLevelResult = {
  casterLevel: number; // for standard multiclass spell slots (FULL table)
  pactLevel: number; // total warlock levels (for PACT)
};

function toInt(value: unknown, fallback: number) {
  const n = typeof value === "number" ? value : Number(value);
  return Number.isFinite(n) ? Math.trunc(n) : fallback;
}

function clamp(value: number, min: number, max: number) {
  return Math.min(max, Math.max(min, value));
}

function isArtificer(className: unknown) {
  return typeof className === "string" && className.startsWith("ARTIFICER");
}

function effectiveSpellcastingType(entry: SpellcastingClassLevel): SpellcastingType {
  const clsType = entry.class?.spellcastingType ?? SpellcastingType.NONE;
  if (clsType && clsType !== SpellcastingType.NONE) return clsType;

  const subType = entry.subclass?.spellcastingType ?? SpellcastingType.NONE;
  if (subType && subType !== SpellcastingType.NONE) return subType;

  return SpellcastingType.NONE;
}

/**
 * DnD 5e multiclass caster level calculation.
 * - Full: +level
 * - Half: +floor(level/2)
 * - Third: +floor(level/3)
 * - Artificer: +ceil(level/2)
 * - Pact: tracked separately as pactLevel (does not add to casterLevel)
 */
export function calculateCasterLevel(pers: SpellcastingPersLike): CasterLevelResult {
  const multiclasses = Array.isArray(pers.multiclasses) ? pers.multiclasses : [];

  const multiclassLevels = multiclasses.reduce((acc, m) => acc + toInt(m?.classLevel, 0), 0);
  const mainLevel = clamp(toInt(pers.level, 1) - multiclassLevels, 1, 20);

  const entries: SpellcastingClassLevel[] = [
    {
      classLevel: mainLevel,
      class: pers.class ?? null,
      subclass: pers.subclass ?? null,
    },
    ...multiclasses.map((m) => ({
      classLevel: clamp(toInt(m?.classLevel, 1), 1, 20),
      class: m.class ?? null,
      subclass: m.subclass ?? null,
    })),
  ];

  let casterLevel = 0;
  let pactLevel = 0;

  for (const entry of entries) {
    const level = clamp(toInt(entry.classLevel, 1), 1, 20);
    const type = effectiveSpellcastingType(entry);
    const className = entry.class?.name ?? null;

    if (type === SpellcastingType.PACT) {
      pactLevel += level;
      continue;
    }

    if (isArtificer(className)) {
      casterLevel += Math.ceil(level / 2);
      continue;
    }

    switch (type) {
      case SpellcastingType.FULL:
        casterLevel += level;
        break;
      case SpellcastingType.HALF:
        casterLevel += Math.floor(level / 2);
        break;
      case SpellcastingType.THIRD:
        casterLevel += Math.floor(level / 3);
        break;
      default:
        break;
    }
  }

  return {
    casterLevel: clamp(casterLevel, 0, 20),
    pactLevel: clamp(pactLevel, 0, 20),
  };
}
</file>

<file path="src/lib/refs/dictionary.json">
{
  "DND_DICTIONARY": {
    "attributes": {
      "strength": "",
      "dexterity": "",
      "constitution": "",
      "intelligence": "",
      "wisdom": "",
      "charisma": ""
    },
    "skills": {
      "acrobatics": "",
      "animalHandling": "  ",
      "arcana": "",
      "athletics": "",
      "deception": "",
      "history": "",
      "insight": " ",
      "intimidation": "",
      "investigation": "",
      "medicine": "",
      "nature": "",
      "perception": "",
      "performance": "",
      "persuasion": "",
      "religion": "",
      "sleightOfHand": " ",
      "stealth": "",
      "survival": ""
    },
    "classes": {
      "artificer": "",
      "barbarian": "",
      "bard": "",
      "cleric": "",
      "druid": "",
      "fighter": "",
      "monk": "",
      "paladin": "",
      "ranger": "",
      "rogue": "",
      "sorcerer": "",
      "warlock": "",
      "wizard": ""
    },
    "races": {
      "dragonborn": "",
      "dwarf": "",
      "elf": "",
      "gnome": "",
      "half-elf": "",
      "half-orc": "",
      "halfling": "",
      "human": "",
      "tiefling": ""
    },
    "rules": {
      "proficiency": "",
      "proficiencyBonus": " ",
      "you_are_proficient_in": "  ()",
      "savingThrow": "",
      "skillCheck": " ",
      "spell": "",
      "cantrip": "",
      "range": "",
      "duration": "",
      "concentration": "",
      "castTime": " ",
      "component": "",
      "verbal": "",
      "somatic": "",
      "material": "",
      "infusion": "",
      "turn": "",
      "round": "",
      "action": "",
      "asAnAction": "",
      "bonusAction": " ",
      "asABonusAction": " ",
      "reaction": "",
      "withReaction": "",
      "speedOrMovement": "",
      "initiative": "",
      "attackRoll": " ",
      "damage": "",
      "damageRoll": " ",
      "criticalHit": " ",
      "armorClass": " ",
      "hitPoint": "   ",
      "advantage": "  ",
      "disadvantage": "  ",
      "trait": "",
      "with this trait": " ",
      "Ability": " (   , ,   )",
      "Stats": " (   , ,   )"
    },
    "conditions": {
      "blinded": "",
      "charmed": "",
      "deafened": "",
      "exhaustion": "",
      "frightened": "",
      "grappled": "",
      "incapacitated": "",
      "invisible": "",
      "paralyzed": "",
      "petrified": "'",
      "poisoned": "",
      "prone": "",
      "restrained": "",
      "stunned": "",
      "unconscious": ""
    },
    "alignments": {

      "lawfulGood": " ",
      "alignment": "",
      "neutralGood": " ",
      "chaoticGood": " ",
      "lawfulNeutral": " ",
      "trueNeutral": " ",
      "chaoticNeutral": " ",
      "lawfulEvil": " ",
      "neutralEvil": " ",
      "chaoticEvil": " "
    },
    "damageTypes": {
      "acid": "",
      "bludgeoning": "",
      "cold": "  ",
      "fire": "  ",
      "force": " ",
      "lightning": "  ",
      "necrotic": "",
      "piercing": "",
      "poison": "  ",
      "psychic": "",
      "radiant": " ( )",
      "slashing": "",
      "thunder": "  "
    },
    "creatureSizes": {
      "tiny": "",
      "small": "",
      "medium": "",
      "large": "",
      "huge": "",
      "gargantuan": ""
    },
    "spellSchools": {
      "abjuration": "",
      "conjuration": "",
      "divination": "",
      "enchantment": "",
      "evocation": "",
      "illusion": "",
      "necromancy": "",
      "transmutation": ""
    },
    "generalTerms": {
      "difficultyClass": " ",
      "DC": "",
      "natural20": " 20",
      "natural1": " 1",
      "abilityCheck": " ",
      "contest": "",
      "cover": "",
      "halfCover": " ",
      "threeQuartersCover": "  ",
      "fullCover": " ",
      "inspiration": "",
      "deathSavingThrow": "  ",
      "stabilize": "",
      "dying": "",
      "level": "",
      "experience": "",
      "experiencePoints": " ",
      "spellSlot": " "
    },
    "dice": {
      "d4": "4",
      "d6": "6",
      "d8": "8",
      "d10": "10",
      "d12": "12",
      "d20": "20",
      "d100": "100",
      "roll": "",
      "diceRoll": " "
    },
    "classFeatures": {
      "subclass": "",
      "archetype": "",
      "path": "",
      "circle": "",
      "domain": "",
      "patron": "",
      "school": "",
      "tradition": "",
      "oath": "",
      "conclave": "",
      "college": "",
      "metamagic": "",
      "fontOfMagic": " ",
      "sorcerousRestoration": " ",
      "sorcerousVersatility": " ",
      "magicalGuidance": " ",
      "carefulSpell": " ",
      "distantSpell": " ",
      "empoweredSpell": " ",
      "extendedSpell": " ",
      "heightenedSpell": " ",
      "quickenedSpell": " ",
      "subtleSpell": " ",
      "twinnedSpell": " "
    },
    "additionalRaces": {
      "aasimar": "",
      "goliath": "",
      "tabaxi": "",
      "kenku": "",
      "firbolg": "",
      "triton": "",
      "aarakocra": "",
      "genasi": "",
      "airGenasi": " ",
      "earthGenasi": " ",
      "fireGenasi": " ",
      "waterGenasi": " ",
      "goblin": "",
      "hobgoblin": "",
      "bugbear": "",
      "kobold": ""
    },
    "equipment": {
      "weapon": "",
      "armor": "  ",
      "armorClass": " ",
      "AC": "",
      "shield": "",
      "lightArmor": " ",
      "mediumArmor": " ",
      "heavyArmor": " ",
      "simpleWeapon": " ",
      "martialWeapon": " ",
      "melee": "",
      "ranged": "",
      "ammunition": ""
    },
    "restAndRecovery": {
      "hitDice": " '",
      "hitDie": " '",
      "temporaryHP": " ",
      "healing": "",
      "resurrection": "",
      "revivify": ""
    },
    "environments": {
      "terrain": "",
      "difficultTerrain": " ",
      "light": "  ",
      "brightLight": " ",
      "dimLight": " ",
      "darkness": "",
      "vision": "",
      "blindsight": "",
      "darkvision": "",
      "truesight": " ",
      "tremorsense": ""
    },
    "magicItemTypes": {
      "attunement": "",
      "common": "",
      "uncommon": "",
      "rare": "",
      "veryRare": " ",
      "legendary": "",
      "wondrousItem": " ",
      "potion": "",
      "scroll": "",
      "rod": "",
      "staff": "",
      "wand": "",
      "ring": ""
    },
    "distanceAndTime": {
      "feet": "",
      "ft": "",
      "mile": "",
      "shortRest": " ",
      "longRest": " ",
      "minute": "",
      "instant": "",
      "instantaneous": ""
    },
    "combatActions": {
      "dash": "",
      "disengage": "",
      "dodge": "",
      "help": "",
      "hide": "",
      "search": "",
      "useObject": " ",
      "ready": " ",
      "grapple": "",
      "shove": "",
      "opportunityAttack": " "
    }
  },
  "SPELLS": [
    {
      "spell_id": 1073,
      "eng_name": "Animal shapes",
      "name": "  [Animal shapes]"
    },
    {
      "spell_id": 1084,
      "eng_name": "Incendiary Cloud",
      "name": "  [Incendiary Cloud]"
    },
    {
      "spell_id": 1194,
      "eng_name": "Conjure Minor Elementals",
      "name": "'   [Conjure Minor Elementals]"
    },
    {
      "spell_id": 1347,
      "eng_name": "Guidance",
      "name": " [Guidance]"
    },
    {
      "spell_id": 1344,
      "eng_name": "Message",
      "name": " [Message]"
    },
    {
      "spell_id": 1177,
      "eng_name": "Phantasmal Killer",
      "name": "  [Phantasmal Killer]"
    },
    {
      "spell_id": 1350,
      "eng_name": "Dancing Lights",
      "name": "  [Dancing Lights]"
    },
    {
      "spell_id": 1322,
      "eng_name": "Feather Fall",
      "name": " ' [Feather Fall]"
    },
    {
      "spell_id": 1043,
      "eng_name": "Thunderwave",
      "name": "  [Thunderwave]"
    },
    {
      "spell_id": 1068,
      "eng_name": "Wish",
      "name": " [Wish]"
    },
    {
      "spell_id": 1066,
      "eng_name": "Prismatic Wall",
      "name": "  [Prismatic Wall]"
    },
    {
      "spell_id": 1307,
      "eng_name": "Jump",
      "name": " [Jump]"
    },
    {
      "spell_id": 1552,
      "eng_name": "Conjure Barrage",
      "name": "  [Conjure Barrage]"
    },
    {
      "spell_id": 1553,
      "eng_name": "Crusader's Mantle",
      "name": "  [Crusader's Mantle]"
    },
    {
      "spell_id": 1136,
      "eng_name": "True Seeing",
      "name": "  [True Seeing]"
    },
    {
      "spell_id": 1085,
      "eng_name": "Glibness",
      "name": " [Glibness]"
    },
    {
      "spell_id": 1088,
      "eng_name": "Teleport",
      "name": " [Teleport]"
    },
    {
      "spell_id": 1250,
      "eng_name": "Darkvision",
      "name": "  [Darkvision]"
    },
    {
      "spell_id": 1161,
      "eng_name": "Mass Cure Wounds",
      "name": "   [Mass Cure Wounds]"
    },
    {
      "spell_id": 1547,
      "eng_name": "Hail of Thorns",
      "name": "  [Hail of Thorns]"
    },
    {
      "spell_id": 1548,
      "eng_name": "Beast Sense",
      "name": "  [Beast Sense]"
    },
    {
      "spell_id": 1554,
      "eng_name": "Lightning Arrow",
      "name": "  [Lightning Arrow]"
    },
    {
      "spell_id": 1041,
      "eng_name": "Faerie fire",
      "name": "  [Faerie fire]"
    },
    {
      "spell_id": 1556,
      "eng_name": "Grasping Vine",
      "name": "  [Grasping Vine]"
    },
    {
      "spell_id": 1561,
      "eng_name": "Telepathy",
      "name": " [Telepathy]"
    },
    {
      "spell_id": 1316,
      "eng_name": "Identify",
      "name": " [Identify]"
    },
    {
      "spell_id": 1311,
      "eng_name": "Grease",
      "name": " [Grease]"
    },
    {
      "spell_id": 1332,
      "eng_name": "Disguise Self",
      "name": " [Disguise Self]"
    },
    {
      "spell_id": 1306,
      "eng_name": "Alarm",
      "name": " [Alarm]"
    },
    {
      "spell_id": 1269,
      "eng_name": "Enhance Ability",
      "name": "  [Enhance Ability]"
    },
    {
      "spell_id": 1258,
      "eng_name": "Heat Metal",
      "name": "  [Heat Metal]"
    },
    {
      "spell_id": 1046,
      "eng_name": "Detect Poison and Disease",
      "name": "    [Detect Poison and Disease]"
    },
    {
      "spell_id": 1221,
      "eng_name": "Fly",
      "name": " [Fly]"
    },
    {
      "spell_id": 1491,
      "eng_name": "Elemental Weapon",
      "name": "  [Elemental Weapon]"
    },
    {
      "spell_id": 1211,
      "eng_name": "Create Food and Water",
      "name": "    [Create Food and Water]"
    },
    {
      "spell_id": 1184,
      "eng_name": "Freedom of Movement",
      "name": "  [Freedom of Movement]"
    },
    {
      "spell_id": 1555,
      "eng_name": "Aura of Purity",
      "name": "  [Aura of Purity]"
    },
    {
      "spell_id": 1327,
      "eng_name": "Expeditious Retreat",
      "name": "  [Expeditious Retreat]"
    },
    {
      "spell_id": 1206,
      "eng_name": "Water Walk",
      "name": "   [Water Walk]"
    },
    {
      "spell_id": 1277,
      "eng_name": "Suggestion",
      "name": " [Suggestion]"
    },
    {
      "spell_id": 1345,
      "eng_name": "Poison Spray",
      "name": "  [Poison Spray]"
    },
    {
      "spell_id": 1346,
      "eng_name": "Resistance",
      "name": " [Resistance]"
    },
    {
      "spell_id": 1457,
      "eng_name": "Staggering Smite",
      "name": "  [Staggering Smite]"
    },
    {
      "spell_id": 1048,
      "eng_name": "Detect evil and good",
      "name": "    [Detect evil and good]"
    },
    {
      "spell_id": 1453,
      "eng_name": "Wrathful Smite",
      "name": "  [Wrathful Smite]"
    },
    {
      "spell_id": 1141,
      "eng_name": "Wall of Stone",
      "name": "   [Wall of Stone]"
    },
    {
      "spell_id": 1363,
      "eng_name": "Flame blade",
      "name": "  [Flame blade]"
    },
    {
      "spell_id": 1057,
      "eng_name": "Vampiric Touch",
      "name": "  [Vampiric Touch]"
    },
    {
      "spell_id": 1049,
      "eng_name": "Illusory Script",
      "name": "  [Illusory Script]"
    },
    {
      "spell_id": 1044,
      "eng_name": "Bless",
      "name": " [Bless]"
    },
    {
      "spell_id": 1495,
      "eng_name": "Compelled Duel",
      "name": "   [Compelled Duel]"
    },
    {
      "spell_id": 1052,
      "eng_name": "Shocking Grasp",
      "name": "  [Shocking Grasp]"
    },
    {
      "spell_id": 1062,
      "eng_name": "Foresight",
      "name": " [Foresight]"
    },
    {
      "spell_id": 1047,
      "eng_name": "Heroism",
      "name": " [Heroism]"
    },
    {
      "spell_id": 1496,
      "eng_name": "Dissonant Whispers",
      "name": "  [Dissonant Whispers]"
    },
    {
      "spell_id": 1157,
      "eng_name": "Raise Dead",
      "name": "  [Raise Dead]"
    },
    {
      "spell_id": 1053,
      "eng_name": "Produce Flame",
      "name": "  [Produce Flame]"
    },
    {
      "spell_id": 1054,
      "eng_name": "True Strike",
      "name": "  [True Strike]"
    },
    {
      "spell_id": 1149,
      "eng_name": "Dominate Person",
      "name": "  [Dominate Person]"
    },
    {
      "spell_id": 1500,
      "eng_name": "Arms of Hadar",
      "name": "  [Arms of Hadar]"
    },
    {
      "spell_id": 1144,
      "eng_name": "Scrying",
      "name": " [Scrying]"
    },
    {
      "spell_id": 1139,
      "eng_name": "Telekinesis",
      "name": " [Telekinesis]"
    },
    {
      "spell_id": 1070,
      "eng_name": "True Polymorph",
      "name": "  [True Polymorph]"
    },
    {
      "spell_id": 1281,
      "eng_name": "Lesser Restoration",
      "name": "  [Lesser Restoration]"
    },
    {
      "spell_id": 1186,
      "eng_name": "Compulsion",
      "name": " [Compulsion]"
    },
    {
      "spell_id": 1181,
      "eng_name": "Wall of Fire",
      "name": "  [Wall of Fire]"
    },
    {
      "spell_id": 1241,
      "eng_name": "Water Breathing",
      "name": "  [Water Breathing]"
    },
    {
      "spell_id": 1190,
      "eng_name": "Ice Storm",
      "name": "  [Ice Storm]"
    },
    {
      "spell_id": 1055,
      "eng_name": "Light",
      "name": " [Light]"
    },
    {
      "spell_id": 1497,
      "eng_name": "Armor of Agathys",
      "name": "  [Armor of Agathys]"
    },
    {
      "spell_id": 1308,
      "eng_name": "Create or Destroy Water",
      "name": "    [Create or Destroy Water]"
    },
    {
      "spell_id": 1056,
      "eng_name": "Sacred Flame",
      "name": " ' [Sacred Flame]"
    },
    {
      "spell_id": 1296,
      "eng_name": "Mirror Image",
      "name": " [Mirror Image]"
    },
    {
      "spell_id": 1058,
      "eng_name": "Power Word Kill",
      "name": " :  [Power Word Kill]"
    },
    {
      "spell_id": 1271,
      "eng_name": "Flaming Sphere",
      "name": "  [Flaming Sphere]"
    },
    {
      "spell_id": 1080,
      "eng_name": "Maze",
      "name": " [Maze]"
    },
    {
      "spell_id": 1338,
      "eng_name": "Inflict Wounds",
      "name": "  [Inflict Wounds]"
    },
    {
      "spell_id": 1530,
      "eng_name": "Power Word Heal",
      "name": " :  [Power Word Heal]"
    },
    {
      "spell_id": 1242,
      "eng_name": "Daylight",
      "name": "  [Daylight]"
    },
    {
      "spell_id": 1501,
      "eng_name": "Crown of Madness",
      "name": "  [Crown of Madness]"
    },
    {
      "spell_id": 1278,
      "eng_name": "Moonbeam",
      "name": "  [Moonbeam]"
    },
    {
      "spell_id": 1260,
      "eng_name": "Spike Growth",
      "name": "  [Spike Growth]"
    },
    {
      "spell_id": 1276,
      "eng_name": "Invisibility",
      "name": " [Invisibility]"
    },
    {
      "spell_id": 1249,
      "eng_name": "Darkness",
      "name": " [Darkness]"
    },
    {
      "spell_id": 1231,
      "eng_name": "Magic Circle",
      "name": "  [Magic Circle]"
    },
    {
      "spell_id": 1503,
      "eng_name": "Chromatic Orb",
      "name": "  [Chromatic Orb]"
    },
    {
      "spell_id": 1509,
      "eng_name": "Nystul's Magic Aura",
      "name": "   [Nystul's Magic Aura]"
    },
    {
      "spell_id": 1155,
      "eng_name": "Hallow",
      "name": " [Hallow]"
    },
    {
      "spell_id": 1229,
      "eng_name": "Beacon of Hope",
      "name": "  [Beacon of Hope]"
    },
    {
      "spell_id": 1518,
      "eng_name": "Otiluke's Resilient Sphere",
      "name": "   [Otiluke's Resilient Sphere]"
    },
    {
      "spell_id": 1191,
      "eng_name": "Control Water",
      "name": "  [Control Water]"
    },
    {
      "spell_id": 1522,
      "eng_name": "Rary's Telepathic Bond",
      "name": " '  [Rary's Telepathic Bond]"
    },
    {
      "spell_id": 1504,
      "eng_name": "Tenser's Floating Disk",
      "name": "   [Tenser's Floating Disk]"
    },
    {
      "spell_id": 1513,
      "eng_name": "Leomund's Tiny Hut",
      "name": "   [Leomund's Tiny Hut]"
    },
    {
      "spell_id": 1505,
      "eng_name": "Witch Bolt",
      "name": "  [Witch Bolt]"
    },
    {
      "spell_id": 1506,
      "eng_name": "Cloud of Daggers",
      "name": "  [Cloud of Daggers]"
    },
    {
      "spell_id": 1510,
      "eng_name": "Aura of Vitality",
      "name": "  [Aura of Vitality]"
    },
    {
      "spell_id": 1524,
      "eng_name": "Arcane Gate",
      "name": "  [Arcane Gate]"
    },
    {
      "spell_id": 1529,
      "eng_name": "Tsunami",
      "name": " [Tsunami]"
    },
    {
      "spell_id": 1515,
      "eng_name": "Evard's Black Tentacles",
      "name": "   [Evard's Black Tentacles]"
    },
    {
      "spell_id": 1520,
      "eng_name": "Conjure Volley",
      "name": "  [Conjure Volley]"
    },
    {
      "spell_id": 1521,
      "eng_name": "Destructive Wave",
      "name": "  [Destructive Wave]"
    },
    {
      "spell_id": 1511,
      "eng_name": "Feign Death",
      "name": "  [Feign Death]"
    },
    {
      "spell_id": 1528,
      "eng_name": "Mordenkainen's Magnificent Mansion",
      "name": "   [Mordenkainen's Magnificent Mansion]"
    },
    {
      "spell_id": 1060,
      "eng_name": "Meteor Swarm",
      "name": "  [Meteor Swarm]"
    },
    {
      "spell_id": 1537,
      "eng_name": "Mordenkainen's Sword",
      "name": "  [Mordenkainen's Sword]"
    },
    {
      "spell_id": 1272,
      "eng_name": "Spider Climb",
      "name": "  [Spider Climb]"
    },
    {
      "spell_id": 1302,
      "eng_name": "Shield",
      "name": " [Shield]"
    },
    {
      "spell_id": 1283,
      "eng_name": "Magic Weapon",
      "name": "  [Magic Weapon]"
    },
    {
      "spell_id": 1295,
      "eng_name": "Continual Flame",
      "name": " ' [Continual Flame]"
    },
    {
      "spell_id": 1312,
      "eng_name": "Longstrider",
      "name": " [Longstrider]"
    },
    {
      "spell_id": 1352,
      "eng_name": "Mage Hand",
      "name": "  [Mage Hand]"
    },
    {
      "spell_id": 1353,
      "eng_name": "Mending",
      "name": " [Mending]"
    },
    {
      "spell_id": 1061,
      "eng_name": "Shapechange",
      "name": " [Shapechange]"
    },
    {
      "spell_id": 1063,
      "eng_name": "Mass Heal",
      "name": "  [Mass Heal]"
    },
    {
      "spell_id": 1064,
      "eng_name": "Time Stop",
      "name": "  [Time Stop]"
    },
    {
      "spell_id": 1065,
      "eng_name": "Weird",
      "name": " [Weird]"
    },
    {
      "spell_id": 1069,
      "eng_name": "Astral Projection",
      "name": "  [Astral Projection]"
    },
    {
      "spell_id": 1071,
      "eng_name": "True Resurrection",
      "name": "  [True Resurrection]"
    },
    {
      "spell_id": 1072,
      "eng_name": "Mind Blank",
      "name": "  [Mind Blank]"
    },
    {
      "spell_id": 1313,
      "eng_name": "Sanctuary",
      "name": " [Sanctuary]"
    },
    {
      "spell_id": 1074,
      "eng_name": "Sunburst",
      "name": "  [Sunburst]"
    },
    {
      "spell_id": 1076,
      "eng_name": "Feeblemind",
      "name": " [Feeblemind]"
    },
    {
      "spell_id": 1263,
      "eng_name": "Locate Animals or Plants",
      "name": "    [Locate Animals or Plants]"
    },
    {
      "spell_id": 1078,
      "eng_name": "Dominate Monster",
      "name": "  [Dominate Monster]"
    },
    {
      "spell_id": 1137,
      "eng_name": "Flesh to Stone",
      "name": "    [Flesh to Stone]"
    },
    {
      "spell_id": 1081,
      "eng_name": "Control Weather",
      "name": "  [Control Weather]"
    },
    {
      "spell_id": 1082,
      "eng_name": "Clone",
      "name": " [Clone]"
    },
    {
      "spell_id": 1104,
      "eng_name": "Prismatic Spray",
      "name": "  [Prismatic Spray]"
    },
    {
      "spell_id": 1095,
      "eng_name": "Project Image",
      "name": "  [Project Image]"
    },
    {
      "spell_id": 1087,
      "eng_name": "Sequester",
      "name": " [Sequester]"
    },
    {
      "spell_id": 1089,
      "eng_name": "Mirage Arcane",
      "name": "  [Mirage Arcane]"
    },
    {
      "spell_id": 1204,
      "eng_name": "Greater Invisibility",
      "name": "  [Greater Invisibility]"
    },
    {
      "spell_id": 1092,
      "eng_name": "Forcecage",
      "name": "  [Forcecage]"
    },
    {
      "spell_id": 1094,
      "eng_name": "Regenerate",
      "name": " [Regenerate]"
    },
    {
      "spell_id": 1098,
      "eng_name": "Reverse Gravity",
      "name": "  [Reverse Gravity]"
    },
    {
      "spell_id": 1100,
      "eng_name": "Etherealness",
      "name": " [Etherealness]"
    },
    {
      "spell_id": 1040,
      "eng_name": "Fire Bolt",
      "name": "  [Fire Bolt]"
    },
    {
      "spell_id": 1101,
      "eng_name": "Resurrection",
      "name": " [Resurrection]"
    },
    {
      "spell_id": 1102,
      "eng_name": "Fire Storm",
      "name": "  [Fire Storm]"
    },
    {
      "spell_id": 1134,
      "eng_name": "Guards and Wards",
      "name": "   [Guards and Wards]"
    },
    {
      "spell_id": 1106,
      "eng_name": "Arcane Sword",
      "name": "  [Arcane Sword]"
    },
    {
      "spell_id": 1107,
      "eng_name": "Harm",
      "name": " [Harm]"
    },
    {
      "spell_id": 1108,
      "eng_name": "Globe of Invulnerability",
      "name": "  [Globe of Invulnerability]"
    },
    {
      "spell_id": 1109,
      "eng_name": "Wall of Thorns",
      "name": "  [Wall of Thorns]"
    },
    {
      "spell_id": 1116,
      "eng_name": "Eyebite",
      "name": "  [Eyebite]"
    },
    {
      "spell_id": 1131,
      "eng_name": "Heal",
      "name": " [Heal]"
    },
    {
      "spell_id": 1111,
      "eng_name": "Create Undead",
      "name": "  [Create Undead]"
    },
    {
      "spell_id": 1113,
      "eng_name": "Word of Recall",
      "name": "  [Word of Recall]"
    },
    {
      "spell_id": 1115,
      "eng_name": "Disintegrate",
      "name": " [Disintegrate]"
    },
    {
      "spell_id": 1117,
      "eng_name": "Wind Walk",
      "name": "   [Wind Walk]"
    },
    {
      "spell_id": 1042,
      "eng_name": "Divine Favor",
      "name": "  [Divine Favor]"
    },
    {
      "spell_id": 1121,
      "eng_name": "Transport via Plants",
      "name": "   [Transport via Plants]"
    },
    {
      "spell_id": 1122,
      "eng_name": "Contingency",
      "name": " [Contingency]"
    },
    {
      "spell_id": 1135,
      "eng_name": "Heroes' Feast",
      "name": "  [Heroes' Feast]"
    },
    {
      "spell_id": 1129,
      "eng_name": "Circle of Death",
      "name": "  [Circle of Death]"
    },
    {
      "spell_id": 1130,
      "eng_name": "Blade Barrier",
      "name": " ' [Blade Barrier]"
    },
    {
      "spell_id": 1132,
      "eng_name": "Forbiddance",
      "name": " [Forbiddance]"
    },
    {
      "spell_id": 1133,
      "eng_name": "Conjure Fey",
      "name": "'  [Conjure Fey]"
    },
    {
      "spell_id": 1140,
      "eng_name": "Creation",
      "name": " [Creation]"
    },
    {
      "spell_id": 1143,
      "eng_name": "Hold Monster",
      "name": "  [Hold Monster]"
    },
    {
      "spell_id": 1168,
      "eng_name": "Contact Other Plane",
      "name": "'    [Contact Other Plane]"
    },
    {
      "spell_id": 1147,
      "eng_name": "Dispel Evil and Good",
      "name": "    [Dispel Evil and Good]"
    },
    {
      "spell_id": 1150,
      "eng_name": "Awaken",
      "name": " [Awaken]"
    },
    {
      "spell_id": 1152,
      "eng_name": "Seeming",
      "name": " [Seeming]"
    },
    {
      "spell_id": 1154,
      "eng_name": "Mislead",
      "name": " [Mislead]"
    },
    {
      "spell_id": 1153,
      "eng_name": "Planar Binding",
      "name": "  [Planar Binding]"
    },
    {
      "spell_id": 1158,
      "eng_name": "Geas",
      "name": " [Geas]"
    },
    {
      "spell_id": 1159,
      "eng_name": "Antilife shell",
      "name": "   [Antilife shell]"
    },
    {
      "spell_id": 1164,
      "eng_name": "Legend Lore",
      "name": "  [Legend Lore]"
    },
    {
      "spell_id": 1163,
      "eng_name": "Teleportation Circle",
      "name": "  [Teleportation Circle]"
    },
    {
      "spell_id": 1304,
      "eng_name": "False life",
      "name": "  [False life]"
    },
    {
      "spell_id": 1171,
      "eng_name": "Tree Stride",
      "name": "  [Tree Stride]"
    },
    {
      "spell_id": 1170,
      "eng_name": "Conjure Elemental",
      "name": "'  [Conjure Elemental]"
    },
    {
      "spell_id": 1176,
      "eng_name": "Stone Shape",
      "name": "  [Stone Shape]"
    },
    {
      "spell_id": 1178,
      "eng_name": "Hallucinatory Terrain",
      "name": "  [Hallucinatory Terrain]"
    },
    {
      "spell_id": 1174,
      "eng_name": "Arcane Hand",
      "name": "  [Arcane Hand]"
    },
    {
      "spell_id": 1156,
      "eng_name": "Animate objects",
      "name": "  [Animate objects]"
    },
    {
      "spell_id": 1195,
      "eng_name": "Conjure Woodland Beings",
      "name": "'   [Conjure Woodland Beings]"
    },
    {
      "spell_id": 1192,
      "eng_name": "Stoneskin",
      "name": "'  [Stoneskin]"
    },
    {
      "spell_id": 1203,
      "eng_name": "Guardian of Faith",
      "name": "  [Guardian of Faith]"
    },
    {
      "spell_id": 1188,
      "eng_name": "Locate Creature",
      "name": "  [Locate Creature]"
    },
    {
      "spell_id": 1200,
      "eng_name": "Fire Shield",
      "name": "  [Fire Shield]"
    },
    {
      "spell_id": 1196,
      "eng_name": "Dimension Door",
      "name": "   [Dimension Door]"
    },
    {
      "spell_id": 1198,
      "eng_name": "Divination",
      "name": " [Divination]"
    },
    {
      "spell_id": 1207,
      "eng_name": "phantom steed",
      "name": "  [phantom steed]"
    },
    {
      "spell_id": 1201,
      "eng_name": "Fabricate",
      "name": " [Fabricate]"
    },
    {
      "spell_id": 1202,
      "eng_name": "Banishment",
      "name": " [Banishment]"
    },
    {
      "spell_id": 1209,
      "eng_name": "Wind Wall",
      "name": "  [Wind Wall]"
    },
    {
      "spell_id": 1212,
      "eng_name": "Stinking Cloud",
      "name": "  [Stinking Cloud]"
    },
    {
      "spell_id": 1210,
      "eng_name": "Fear",
      "name": " [Fear]"
    },
    {
      "spell_id": 1215,
      "eng_name": "Speak with Dead",
      "name": "   [Speak with Dead]"
    },
    {
      "spell_id": 1270,
      "eng_name": "Pass without Trace",
      "name": "   [Pass without Trace]"
    },
    {
      "spell_id": 1305,
      "eng_name": "Fog Cloud",
      "name": "  [Fog Cloud]"
    },
    {
      "spell_id": 1357,
      "eng_name": "Thaumaturgy",
      "name": " [Thaumaturgy]"
    },
    {
      "spell_id": 1224,
      "eng_name": "Nondetection",
      "name": " [Nondetection]"
    },
    {
      "spell_id": 1220,
      "eng_name": "Sending",
      "name": " [Sending]"
    },
    {
      "spell_id": 1219,
      "eng_name": "Haste",
      "name": " [Haste]"
    },
    {
      "spell_id": 1251,
      "eng_name": "Animal messenger",
      "name": "- [Animal messenger]"
    },
    {
      "spell_id": 1227,
      "eng_name": "Tongues",
      "name": " [Tongues]"
    },
    {
      "spell_id": 1225,
      "eng_name": "Call Lightning",
      "name": "  [Call Lightning]"
    },
    {
      "spell_id": 1236,
      "eng_name": "Protection from Energy",
      "name": "   [Protection from Energy]"
    },
    {
      "spell_id": 1238,
      "eng_name": "Sleet Storm",
      "name": " [Sleet Storm]"
    },
    {
      "spell_id": 1239,
      "eng_name": "Conjure Animals",
      "name": "'  [Conjure Animals]"
    },
    {
      "spell_id": 1243,
      "eng_name": "Hypnotic Pattern",
      "name": "  [Hypnotic Pattern]"
    },
    {
      "spell_id": 1252,
      "eng_name": "Branding Smite",
      "name": "  [Branding Smite]"
    },
    {
      "spell_id": 1248,
      "eng_name": "Silence",
      "name": " [Silence]"
    },
    {
      "spell_id": 1253,
      "eng_name": "Knock",
      "name": " [Knock]"
    },
    {
      "spell_id": 1256,
      "eng_name": "Scorching Ray",
      "name": "  [Scorching Ray]"
    },
    {
      "spell_id": 1254,
      "eng_name": "Hold Person",
      "name": "  [Hold Person]"
    },
    {
      "spell_id": 1265,
      "eng_name": "Locate Object",
      "name": "  [Locate Object]"
    },
    {
      "spell_id": 1261,
      "eng_name": "Augury",
      "name": " [Augury]"
    },
    {
      "spell_id": 1262,
      "eng_name": "Ray of Enfeeblement",
      "name": "  [Ray of Enfeeblement]"
    },
    {
      "spell_id": 1266,
      "eng_name": "Find Traps",
      "name": "  [Find Traps]"
    },
    {
      "spell_id": 1274,
      "eng_name": "Warding Bond",
      "name": " ' [Warding Bond]"
    },
    {
      "spell_id": 1286,
      "eng_name": "Melf's Acid arrow",
      "name": "   [Melf's Acid arrow]"
    },
    {
      "spell_id": 1287,
      "eng_name": "Zone of Truth",
      "name": "  [Zone of Truth]"
    },
    {
      "spell_id": 1292,
      "eng_name": "Spiritual Weapon",
      "name": "  [Spiritual Weapon]"
    },
    {
      "spell_id": 1288,
      "eng_name": "Alter self",
      "name": "  [Alter self]"
    },
    {
      "spell_id": 1297,
      "eng_name": "Detect Thoughts",
      "name": "  [Detect Thoughts]"
    },
    {
      "spell_id": 1300,
      "eng_name": "Arcane Lock",
      "name": "  [Arcane Lock]"
    },
    {
      "spell_id": 1294,
      "eng_name": "Shatter",
      "name": " [Shatter]"
    },
    {
      "spell_id": 1315,
      "eng_name": "Comprehend Languages",
      "name": "  [Comprehend Languages]"
    },
    {
      "spell_id": 1310,
      "eng_name": "Sleep",
      "name": " [Sleep]"
    },
    {
      "spell_id": 1320,
      "eng_name": "Hellish Rebuke",
      "name": "  [Hellish Rebuke]"
    },
    {
      "spell_id": 1323,
      "eng_name": "Purify Food and Drink",
      "name": "    [Purify Food and Drink]"
    },
    {
      "spell_id": 1493,
      "eng_name": "Bigby's Hand",
      "name": "  [Bigby's Hand]"
    },
    {
      "spell_id": 1494,
      "eng_name": "Friends",
      "name": " [Friends]"
    },
    {
      "spell_id": 1318,
      "eng_name": "Charm Person",
      "name": "  [Charm Person]"
    },
    {
      "spell_id": 1317,
      "eng_name": "Speak with Animals",
      "name": "   [Speak with Animals]"
    },
    {
      "spell_id": 1355,
      "eng_name": "Acid splash",
      "name": "  [Acid splash]"
    },
    {
      "spell_id": 1097,
      "eng_name": "Finger of Death",
      "name": "  [Finger of Death]"
    },
    {
      "spell_id": 1326,
      "eng_name": "Mage Armor",
      "name": "  [Mage Armor]"
    },
    {
      "spell_id": 1328,
      "eng_name": "Unseen Servant",
      "name": "  [Unseen Servant]"
    },
    {
      "spell_id": 1257,
      "eng_name": "Blur",
      "name": " [Blur]"
    },
    {
      "spell_id": 1329,
      "eng_name": "Command",
      "name": " [Command]"
    },
    {
      "spell_id": 1340,
      "eng_name": "Goodberry",
      "name": " [Goodberry]"
    },
    {
      "spell_id": 1341,
      "eng_name": "Druidcraft",
      "name": "  [Druidcraft]"
    },
    {
      "spell_id": 1336,
      "eng_name": "Bane",
      "name": " [Bane]"
    },
    {
      "spell_id": 1386,
      "eng_name": "Skywrite",
      "name": "  [Skywrite]"
    },
    {
      "spell_id": 1412,
      "eng_name": "Frostbite",
      "name": " [Frostbite]"
    },
    {
      "spell_id": 1379,
      "eng_name": "Snare",
      "name": " [Snare]"
    },
    {
      "spell_id": 1383,
      "eng_name": "Warding Wind",
      "name": "  [Warding Wind]"
    },
    {
      "spell_id": 1403,
      "eng_name": "Life Transference",
      "name": "  [Life Transference]"
    },
    {
      "spell_id": 1399,
      "eng_name": "Enemies Abound",
      "name": "  [Enemies Abound]"
    },
    {
      "spell_id": 1435,
      "eng_name": "Negative Energy Flood",
      "name": "   [Negative Energy Flood]"
    },
    {
      "spell_id": 1401,
      "eng_name": "Tiny Servant",
      "name": "  [Tiny Servant]"
    },
    {
      "spell_id": 1400,
      "eng_name": "Catnap",
      "name": " [Catnap]"
    },
    {
      "spell_id": 1404,
      "eng_name": "Wall of Sand",
      "name": "  [Wall of Sand]"
    },
    {
      "spell_id": 1415,
      "eng_name": "Magic Stone",
      "name": "  [Magic Stone]"
    },
    {
      "spell_id": 1423,
      "eng_name": "Charm Monster",
      "name": "  [Charm Monster]"
    },
    {
      "spell_id": 1417,
      "eng_name": "Guardian of Nature",
      "name": "  [Guardian of Nature]"
    },
    {
      "spell_id": 1431,
      "eng_name": "Control Winds",
      "name": "  [Control Winds]"
    },
    {
      "spell_id": 1126,
      "eng_name": "Magic Jar",
      "name": "  [Magic Jar]"
    },
    {
      "spell_id": 1426,
      "eng_name": "Storm Sphere",
      "name": "  [Storm Sphere]"
    },
    {
      "spell_id": 1434,
      "eng_name": "Skill Empowerment",
      "name": "  [Skill Empowerment]"
    },
    {
      "spell_id": 1459,
      "eng_name": "Beast Bond",
      "name": "  [Beast Bond]"
    },
    {
      "spell_id": 1416,
      "eng_name": "Gust",
      "name": " [Gust]"
    },
    {
      "spell_id": 1419,
      "eng_name": "Watery Sphere",
      "name": "  [Watery Sphere]"
    },
    {
      "spell_id": 1420,
      "eng_name": "Vitriolic Sphere",
      "name": "  [Vitriolic Sphere]"
    },
    {
      "spell_id": 1230,
      "eng_name": "Mass Healing Word",
      "name": "   [Mass Healing Word]"
    },
    {
      "spell_id": 1437,
      "eng_name": "Holy Weapon",
      "name": "  [Holy Weapon]"
    },
    {
      "spell_id": 1432,
      "eng_name": "Infernal Calling",
      "name": "  [Infernal Calling]"
    },
    {
      "spell_id": 1440,
      "eng_name": "Wall of Light",
      "name": "  [Wall of Light]"
    },
    {
      "spell_id": 1433,
      "eng_name": "Transmute Rock",
      "name": "  [Transmute Rock]"
    },
    {
      "spell_id": 1436,
      "eng_name": "Dawn",
      "name": " [Dawn]"
    },
    {
      "spell_id": 1441,
      "eng_name": "Danse Macabre",
      "name": "  [Danse Macabre]"
    },
    {
      "spell_id": 1463,
      "eng_name": "Zephyr Strike",
      "name": "  [Zephyr Strike]"
    },
    {
      "spell_id": 1354,
      "eng_name": "Shillelagh",
      "name": " [Shillelagh]"
    },
    {
      "spell_id": 1473,
      "eng_name": "Scatter",
      "name": " [Scatter]"
    },
    {
      "spell_id": 1475,
      "eng_name": "Tenser's Transformation",
      "name": "  [Tenser's Transformation]"
    },
    {
      "spell_id": 1474,
      "eng_name": "Create Homunculus",
      "name": "  [Create Homunculus]"
    },
    {
      "spell_id": 1476,
      "eng_name": "Whirlwind",
      "name": " [Whirlwind]"
    },
    {
      "spell_id": 1468,
      "eng_name": "Druid Grove",
      "name": "  [Druid Grove]"
    },
    {
      "spell_id": 1472,
      "eng_name": "Primordial Ward",
      "name": "  [Primordial Ward]"
    },
    {
      "spell_id": 1469,
      "eng_name": "Bones of the Earth",
      "name": "  [Bones of the Earth]"
    },
    {
      "spell_id": 1471,
      "eng_name": "Mental Prison",
      "name": " ' [Mental Prison]"
    },
    {
      "spell_id": 1477,
      "eng_name": "Power Word Pain",
      "name": " :  [Power Word Pain]"
    },
    {
      "spell_id": 1479,
      "eng_name": "Abi-Dalzim's Horrid Wilting",
      "name": " ' - [Abi-Dalzim's Horrid Wilting]"
    },
    {
      "spell_id": 1445,
      "eng_name": "Blade Ward",
      "name": "   [Blade Ward]"
    },
    {
      "spell_id": 1356,
      "eng_name": "Vicious Mockery",
      "name": "  [Vicious Mockery]"
    },
    {
      "spell_id": 1364,
      "eng_name": "Booming Blade",
      "name": "  [Booming Blade]"
    },
    {
      "spell_id": 1448,
      "eng_name": "Summon Construct",
      "name": "  [Summon Construct]"
    },
    {
      "spell_id": 1560,
      "eng_name": "Fizban's Platinum Shield",
      "name": "   [Fizban's Platinum Shield]"
    },
    {
      "spell_id": 1293,
      "eng_name": "Barkskin",
      "name": "  [Barkskin]"
    },
    {
      "spell_id": 1533,
      "eng_name": "Dark Star",
      "name": "  [Dark Star]"
    },
    {
      "spell_id": 1454,
      "eng_name": "Thunderous Smite",
      "name": "  [Thunderous Smite]"
    },
    {
      "spell_id": 1456,
      "eng_name": "Blinding Smite",
      "name": "  [Blinding Smite]"
    },
    {
      "spell_id": 1245,
      "eng_name": "Revivify",
      "name": " [Revivify]"
    },
    {
      "spell_id": 1514,
      "eng_name": "Aura of Life",
      "name": "  [Aura of Life]"
    },
    {
      "spell_id": 1193,
      "eng_name": "Death Ward",
      "name": "   [Death Ward]"
    },
    {
      "spell_id": 1543,
      "eng_name": "Wristpocket",
      "name": "  [Wristpocket]"
    },
    {
      "spell_id": 1369,
      "eng_name": "Infestation",
      "name": " [Infestation]"
    },
    {
      "spell_id": 1370,
      "eng_name": "Primal Savagery",
      "name": "  [Primal Savagery]"
    },
    {
      "spell_id": 1546,
      "eng_name": "Sapping Sting",
      "name": "  [Sapping Sting]"
    },
    {
      "spell_id": 1371,
      "eng_name": "Toll the Dead",
      "name": "  [Toll the Dead]"
    },
    {
      "spell_id": 1372,
      "eng_name": "Lightning Lure",
      "name": "  [Lightning Lure]"
    },
    {
      "spell_id": 1373,
      "eng_name": "Mind Sliver",
      "name": "  [Mind Sliver]"
    },
    {
      "spell_id": 1374,
      "eng_name": "Sword Burst",
      "name": "  [Sword Burst]"
    },
    {
      "spell_id": 1376,
      "eng_name": "Cause Fear",
      "name": "  [Cause Fear]"
    },
    {
      "spell_id": 1551,
      "eng_name": "Ashardalon's Stride",
      "name": "  [Ashardalon's Stride]"
    },
    {
      "spell_id": 1091,
      "eng_name": "Symbol",
      "name": " [Symbol]"
    },
    {
      "spell_id": 1385,
      "eng_name": "Maximilian's Earthen Grasp",
      "name": "   [Maximilian's Earthen Grasp]"
    },
    {
      "spell_id": 1389,
      "eng_name": "Earthbind",
      "name": "  [Earthbind]"
    },
    {
      "spell_id": 1381,
      "eng_name": "Shadow Blade",
      "name": "  [Shadow Blade]"
    },
    {
      "spell_id": 1422,
      "eng_name": "Find Greater Steed",
      "name": "   [Find Greater Steed]"
    },
    {
      "spell_id": 1391,
      "eng_name": "Mind Spike",
      "name": "  [Mind Spike]"
    },
    {
      "spell_id": 1390,
      "eng_name": "Pyrotechnics",
      "name": " [Pyrotechnics]"
    },
    {
      "spell_id": 1299,
      "eng_name": "See Invisibility",
      "name": "  [See Invisibility]"
    },
    {
      "spell_id": 1397,
      "eng_name": "Wall of Water",
      "name": "  [Wall of Water]"
    },
    {
      "spell_id": 1519,
      "eng_name": "Raulothim's Psychic Lance",
      "name": "   [Raulothim's Psychic Lance]"
    },
    {
      "spell_id": 1394,
      "eng_name": "Tasha's Mind Whip",
      "name": "   [Tasha's Mind Whip]"
    },
    {
      "spell_id": 1395,
      "eng_name": "Erupting Earth",
      "name": "  [Erupting Earth]"
    },
    {
      "spell_id": 1406,
      "eng_name": "Tidal Wave",
      "name": "  [Tidal Wave]"
    },
    {
      "spell_id": 1222,
      "eng_name": "Glyph of Warding",
      "name": "  [Glyph of Warding]"
    },
    {
      "spell_id": 1405,
      "eng_name": "Flame Arrows",
      "name": "  [Flame Arrows]"
    },
    {
      "spell_id": 1451,
      "eng_name": "Summon Celestial",
      "name": "  [Summon Celestial]"
    },
    {
      "spell_id": 1408,
      "eng_name": "Intellect Fortress",
      "name": "  [Intellect Fortress]"
    },
    {
      "spell_id": 1427,
      "eng_name": "Maelstrom",
      "name": " [Maelstrom]"
    },
    {
      "spell_id": 1460,
      "eng_name": "Catapult",
      "name": " [Catapult]"
    },
    {
      "spell_id": 1410,
      "eng_name": "Thunderclap",
      "name": "  [Thunderclap]"
    },
    {
      "spell_id": 1442,
      "eng_name": "Steel Wind Strike",
      "name": "   [Steel Wind Strike]"
    },
    {
      "spell_id": 1429,
      "eng_name": "Far Step",
      "name": "  [Far Step]"
    },
    {
      "spell_id": 1446,
      "eng_name": "Summon Shadowspawn",
      "name": "   [Summon Shadowspawn]"
    },
    {
      "spell_id": 1462,
      "eng_name": "Earth Tremor",
      "name": "  [Earth Tremor]"
    },
    {
      "spell_id": 1301,
      "eng_name": "Shield of Faith",
      "name": "  [Shield of Faith]"
    },
    {
      "spell_id": 1483,
      "eng_name": "Mass Polymorph",
      "name": "  [Mass Polymorph]"
    },
    {
      "spell_id": 1478,
      "eng_name": "Temple of the Gods",
      "name": "  [Temple of the Gods]"
    },
    {
      "spell_id": 1482,
      "eng_name": "Maddening Darkness",
      "name": "  [Maddening Darkness]"
    },
    {
      "spell_id": 1480,
      "eng_name": "Illusory Dragon",
      "name": "  [Illusory Dragon]"
    },
    {
      "spell_id": 1481,
      "eng_name": "Mighty Fortress",
      "name": "  [Mighty Fortress]"
    },
    {
      "spell_id": 1484,
      "eng_name": "Invulnerability",
      "name": " [Invulnerability]"
    },
    {
      "spell_id": 1447,
      "eng_name": "Summon Undead",
      "name": "  [Summon Undead]"
    },
    {
      "spell_id": 1488,
      "eng_name": "Tasha's Otherworldly Guise",
      "name": "   [Tasha's Otherworldly Guise]"
    },
    {
      "spell_id": 1450,
      "eng_name": "Summon Aberration",
      "name": "  [Summon Aberration]"
    },
    {
      "spell_id": 1489,
      "eng_name": "Dream of the Blue Veil",
      "name": "   [Dream of the Blue Veil]"
    },
    {
      "spell_id": 1444,
      "eng_name": "Summon Fey",
      "name": "  [Summon Fey]"
    },
    {
      "spell_id": 1409,
      "eng_name": "Control Flames",
      "name": "   [Control Flames]"
    },
    {
      "spell_id": 1449,
      "eng_name": "Summon Elemental",
      "name": "  [Summon Elemental]"
    },
    {
      "spell_id": 1508,
      "eng_name": "Nathair's Mischief",
      "name": "  [Nathair's Mischief]"
    },
    {
      "spell_id": 1059,
      "eng_name": "Imprisonment",
      "name": "' [Imprisonment]"
    },
    {
      "spell_id": 1536,
      "eng_name": "Gravity Fissure",
      "name": "  [Gravity Fissure]"
    },
    {
      "spell_id": 1531,
      "eng_name": "Time Ravage",
      "name": "  [Time Ravage]"
    },
    {
      "spell_id": 1534,
      "eng_name": "Reality Break",
      "name": "  [Reality Break]"
    },
    {
      "spell_id": 1393,
      "eng_name": "Summon Beast",
      "name": "  [Summon Beast]"
    },
    {
      "spell_id": 1539,
      "eng_name": "Gravity Sinkhole",
      "name": "  [Gravity Sinkhole]"
    },
    {
      "spell_id": 1234,
      "eng_name": "Remove Curse",
      "name": "  [Remove Curse]"
    },
    {
      "spell_id": 1247,
      "eng_name": "Misty Step",
      "name": "  [Misty Step]"
    },
    {
      "spell_id": 1324,
      "eng_name": "Tasha's Hideous Laughter",
      "name": "   [Tasha's Hideous Laughter]"
    },
    {
      "spell_id": 1337,
      "eng_name": "Protection from Evil and Good",
      "name": "     [Protection from Evil and Good]"
    },
    {
      "spell_id": 1086,
      "eng_name": "Antimagic field",
      "name": "  [Antimagic field]"
    },
    {
      "spell_id": 1359,
      "eng_name": "Thorn whip",
      "name": "  [Thorn whip]"
    },
    {
      "spell_id": 1120,
      "eng_name": "Planar Ally",
      "name": "  [Planar Ally]"
    },
    {
      "spell_id": 1050,
      "eng_name": "Prestidigitation",
      "name": " [Prestidigitation]"
    },
    {
      "spell_id": 1549,
      "eng_name": "Cordon of Arrows",
      "name": "  [Cordon of Arrows]"
    },
    {
      "spell_id": 1558,
      "eng_name": "Swift Quiver",
      "name": "  [Swift Quiver]"
    },
    {
      "spell_id": 1557,
      "eng_name": "Circle of Power",
      "name": "  [Circle of Power]"
    },
    {
      "spell_id": 1333,
      "eng_name": "Magic missile",
      "name": "  [Magic missile]"
    },
    {
      "spell_id": 1362,
      "eng_name": "hex",
      "name": " [hex]"
    },
    {
      "spell_id": 1279,
      "eng_name": "Rope Trick",
      "name": "  [Rope Trick]"
    },
    {
      "spell_id": 1045,
      "eng_name": "Detect Magic",
      "name": "  [Detect Magic]"
    },
    {
      "spell_id": 1559,
      "eng_name": "Drawmij's Instant Summons",
      "name": "   [Drawmij's Instant Summons]"
    },
    {
      "spell_id": 1291,
      "eng_name": "Protection from Poison",
      "name": "   [Protection from Poison]"
    },
    {
      "spell_id": 1289,
      "eng_name": "Enlarge/Reduce",
      "name": "/ [Enlarge/Reduce]"
    },
    {
      "spell_id": 1259,
      "eng_name": "Aid",
      "name": " [Aid]"
    },
    {
      "spell_id": 1216,
      "eng_name": "Dispel Magic",
      "name": "  [Dispel Magic]"
    },
    {
      "spell_id": 1228,
      "eng_name": "Blink",
      "name": " [Blink]"
    },
    {
      "spell_id": 1492,
      "eng_name": "Mordenkainen's Faithful Hound",
      "name": "   [Mordenkainen's Faithful Hound]"
    },
    {
      "spell_id": 1275,
      "eng_name": "Gentle Repose",
      "name": "  [Gentle Repose]"
    },
    {
      "spell_id": 1334,
      "eng_name": "Cure Wounds",
      "name": "  [Cure Wounds]"
    },
    {
      "spell_id": 1343,
      "eng_name": "Eldritch Blast",
      "name": "  [Eldritch Blast]"
    },
    {
      "spell_id": 1455,
      "eng_name": "Searing Smite",
      "name": "  [Searing Smite]"
    },
    {
      "spell_id": 1458,
      "eng_name": "Banishing Smite",
      "name": "  [Banishing Smite]"
    },
    {
      "spell_id": 1051,
      "eng_name": "Storm of Vengeance",
      "name": "  [Storm of Vengeance]"
    },
    {
      "spell_id": 1339,
      "eng_name": "Animal friendship",
      "name": "   [Animal friendship]"
    },
    {
      "spell_id": 1165,
      "eng_name": "Modify Memory",
      "name": "  [Modify Memory]"
    },
    {
      "spell_id": 1167,
      "eng_name": "Commune",
      "name": " [Commune]"
    },
    {
      "spell_id": 1151,
      "eng_name": "Flame Strike",
      "name": "'  [Flame Strike]"
    },
    {
      "spell_id": 1067,
      "eng_name": "Gate",
      "name": " [Gate]"
    },
    {
      "spell_id": 1172,
      "eng_name": "Cloudkill",
      "name": "  [Cloudkill]"
    },
    {
      "spell_id": 1331,
      "eng_name": "Hunter's Mark",
      "name": "  [Hunter's Mark]"
    },
    {
      "spell_id": 1499,
      "eng_name": "Ray of Sickness",
      "name": "  [Ray of Sickness]"
    },
    {
      "spell_id": 1298,
      "eng_name": "Calm Emotions",
      "name": "  [Calm Emotions]"
    },
    {
      "spell_id": 1498,
      "eng_name": "Ensnaring Strike",
      "name": "  [Ensnaring Strike]"
    },
    {
      "spell_id": 1208,
      "eng_name": "Slow",
      "name": " [Slow]"
    },
    {
      "spell_id": 1146,
      "eng_name": "Dream",
      "name": " [Dream]"
    },
    {
      "spell_id": 1217,
      "eng_name": "Animate dead",
      "name": "  [Animate dead]"
    },
    {
      "spell_id": 1502,
      "eng_name": "Phantasmal Force",
      "name": "  [Phantasmal Force]"
    },
    {
      "spell_id": 1517,
      "eng_name": "Mordenkainen's Private Sanctum",
      "name": "   [Mordenkainen's Private Sanctum]"
    },
    {
      "spell_id": 1516,
      "eng_name": "Leomund's Secret Chest",
      "name": "   [Leomund's Secret Chest]"
    },
    {
      "spell_id": 1525,
      "eng_name": "Otiluke's Freezing Sphere",
      "name": "   [Otiluke's Freezing Sphere]"
    },
    {
      "spell_id": 1507,
      "eng_name": "Levitate",
      "name": " [Levitate]"
    },
    {
      "spell_id": 1512,
      "eng_name": "Hunger of Hadar",
      "name": "  [Hunger of Hadar]"
    },
    {
      "spell_id": 1526,
      "eng_name": "Otto's Irresistible Dance",
      "name": "   [Otto's Irresistible Dance]"
    },
    {
      "spell_id": 1213,
      "eng_name": "Plant Growth",
      "name": "  [Plant Growth]"
    },
    {
      "spell_id": 1244,
      "eng_name": "Gaseous Form",
      "name": "  [Gaseous Form]"
    },
    {
      "spell_id": 1145,
      "eng_name": "Passwall",
      "name": "  [Passwall]"
    },
    {
      "spell_id": 1319,
      "eng_name": "Find Familiar",
      "name": "  [Find Familiar]"
    },
    {
      "spell_id": 1342,
      "eng_name": "Ray of Frost",
      "name": "  [Ray of Frost]"
    },
    {
      "spell_id": 1348,
      "eng_name": "Chill Touch",
      "name": "  [Chill Touch]"
    },
    {
      "spell_id": 1358,
      "eng_name": "Antipathy/Sympathy",
      "name": "/ [Antipathy/Sympathy]"
    },
    {
      "spell_id": 1075,
      "eng_name": "Power Word Stun",
      "name": " :  [Power Word Stun]"
    },
    {
      "spell_id": 1162,
      "eng_name": "Cone of Cold",
      "name": "  [Cone of Cold]"
    },
    {
      "spell_id": 1077,
      "eng_name": "Holy aura",
      "name": "  [Holy aura]"
    },
    {
      "spell_id": 1079,
      "eng_name": "Demiplane",
      "name": " [Demiplane]"
    },
    {
      "spell_id": 1083,
      "eng_name": "Earthquake",
      "name": " [Earthquake]"
    },
    {
      "spell_id": 1470,
      "eng_name": "Soul Cage",
      "name": "  [Soul Cage]"
    },
    {
      "spell_id": 1090,
      "eng_name": "Simulacrum",
      "name": " [Simulacrum]"
    },
    {
      "spell_id": 1096,
      "eng_name": "Plane Shift",
      "name": "  [Plane Shift]"
    },
    {
      "spell_id": 1099,
      "eng_name": "Conjure Celestial",
      "name": "  [Conjure Celestial]"
    },
    {
      "spell_id": 1103,
      "eng_name": "Delayed Blast Fireball",
      "name": "   [Delayed Blast Fireball]"
    },
    {
      "spell_id": 1118,
      "eng_name": "Programmed Illusion",
      "name": "  [Programmed Illusion]"
    },
    {
      "spell_id": 1105,
      "eng_name": "Divine Word",
      "name": "  [Divine Word]"
    },
    {
      "spell_id": 1280,
      "eng_name": "Prayer of Healing",
      "name": "  [Prayer of Healing]"
    },
    {
      "spell_id": 1110,
      "eng_name": "Wall of Ice",
      "name": "  [Wall of Ice]"
    },
    {
      "spell_id": 1112,
      "eng_name": "Sunbeam",
      "name": "  [Sunbeam]"
    },
    {
      "spell_id": 1114,
      "eng_name": "Move Earth",
      "name": "  [Move Earth]"
    },
    {
      "spell_id": 1349,
      "eng_name": "Spare the Dying",
      "name": "   [Spare the Dying]"
    },
    {
      "spell_id": 1119,
      "eng_name": "Find the Path",
      "name": "  [Find the Path]"
    },
    {
      "spell_id": 1125,
      "eng_name": "Mass Suggestion",
      "name": "  [Mass Suggestion]"
    },
    {
      "spell_id": 1127,
      "eng_name": "Chain Lightning",
      "name": "  [Chain Lightning]"
    },
    {
      "spell_id": 1142,
      "eng_name": "Wall of Force",
      "name": "  [Wall of Force]"
    },
    {
      "spell_id": 1148,
      "eng_name": "Reincarnate",
      "name": " [Reincarnate]"
    },
    {
      "spell_id": 1160,
      "eng_name": "Insect Plague",
      "name": "  [Insect Plague]"
    },
    {
      "spell_id": 1166,
      "eng_name": "Commune with Nature",
      "name": "   [Commune with Nature]"
    },
    {
      "spell_id": 1169,
      "eng_name": "Contagion",
      "name": " [Contagion]"
    },
    {
      "spell_id": 1179,
      "eng_name": "Blight",
      "name": " [Blight]"
    },
    {
      "spell_id": 1185,
      "eng_name": "Dominate Beast",
      "name": "  [Dominate Beast]"
    },
    {
      "spell_id": 1183,
      "eng_name": "Confusion",
      "name": " [Confusion]"
    },
    {
      "spell_id": 1189,
      "eng_name": "Polymorph",
      "name": " [Polymorph]"
    },
    {
      "spell_id": 1197,
      "eng_name": "Giant Insect",
      "name": "  [Giant Insect]"
    },
    {
      "spell_id": 1205,
      "eng_name": "Arcane eye",
      "name": "  [Arcane eye]"
    },
    {
      "spell_id": 1303,
      "eng_name": "healing word",
      "name": "  [healing word]"
    },
    {
      "spell_id": 1214,
      "eng_name": "Speak with Plants",
      "name": "   [Speak with Plants]"
    },
    {
      "spell_id": 1218,
      "eng_name": "Clairvoyance",
      "name": " [Clairvoyance]"
    },
    {
      "spell_id": 1223,
      "eng_name": "Major Image",
      "name": "  [Major Image]"
    },
    {
      "spell_id": 1226,
      "eng_name": "Bestow Curse",
      "name": "  [Bestow Curse]"
    },
    {
      "spell_id": 1237,
      "eng_name": "Lightning Bolt",
      "name": "  [Lightning Bolt]"
    },
    {
      "spell_id": 1233,
      "eng_name": "Counterspell",
      "name": " [Counterspell]"
    },
    {
      "spell_id": 1235,
      "eng_name": "Meld into Stone",
      "name": "   [Meld into Stone]"
    },
    {
      "spell_id": 1240,
      "eng_name": "Spirit Guardians",
      "name": "  [Spirit Guardians]"
    },
    {
      "spell_id": 1246,
      "eng_name": "Fireball",
      "name": " [Fireball]"
    },
    {
      "spell_id": 1255,
      "eng_name": "Blindness/Deafness",
      "name": "/ [Blindness/Deafness]"
    },
    {
      "spell_id": 1273,
      "eng_name": "Web",
      "name": " [Web]"
    },
    {
      "spell_id": 1309,
      "eng_name": "Guiding Bolt",
      "name": "  [Guiding Bolt]"
    },
    {
      "spell_id": 1264,
      "eng_name": "Find Steed",
      "name": "  [Find Steed]"
    },
    {
      "spell_id": 1267,
      "eng_name": "Gust of Wind",
      "name": "  [Gust of Wind]"
    },
    {
      "spell_id": 1282,
      "eng_name": "Magic Mouth",
      "name": "  [Magic Mouth]"
    },
    {
      "spell_id": 1290,
      "eng_name": "Enthrall",
      "name": "  [Enthrall]"
    },
    {
      "spell_id": 1173,
      "eng_name": "Greater Restoration",
      "name": "  [Greater Restoration]"
    },
    {
      "spell_id": 1321,
      "eng_name": "Burning Hands",
      "name": "  [Burning Hands]"
    },
    {
      "spell_id": 1325,
      "eng_name": "Entangle",
      "name": " [Entangle]"
    },
    {
      "spell_id": 1351,
      "eng_name": "Minor Illusion",
      "name": "  [Minor Illusion]"
    },
    {
      "spell_id": 1330,
      "eng_name": "Silent Image",
      "name": "  [Silent Image]"
    },
    {
      "spell_id": 1335,
      "eng_name": "Color Spray",
      "name": "  [Color Spray]"
    },
    {
      "spell_id": 1388,
      "eng_name": "Dust Devil",
      "name": "  [Dust Devil]"
    },
    {
      "spell_id": 1421,
      "eng_name": "Sickening Radiance",
      "name": "  [Sickening Radiance]"
    },
    {
      "spell_id": 1418,
      "eng_name": "Summon Greater Demon",
      "name": "   [Summon Greater Demon]"
    },
    {
      "spell_id": 1411,
      "eng_name": "Mold Earth",
      "name": "  [Mold Earth]"
    },
    {
      "spell_id": 1424,
      "eng_name": "Elemental Bane",
      "name": "  [Elemental Bane]"
    },
    {
      "spell_id": 1414,
      "eng_name": "Shape Water",
      "name": "  [Shape Water]"
    },
    {
      "spell_id": 1428,
      "eng_name": "Wrath of Nature",
      "name": "  [Wrath of Nature]"
    },
    {
      "spell_id": 1425,
      "eng_name": "Shadow of Moil",
      "name": "  [Shadow of Moil]"
    },
    {
      "spell_id": 1430,
      "eng_name": "Enervation",
      "name": " [Enervation]"
    },
    {
      "spell_id": 1438,
      "eng_name": "Synaptic Static",
      "name": "  [Synaptic Static]"
    },
    {
      "spell_id": 1439,
      "eng_name": "Immolation",
      "name": " [Immolation]"
    },
    {
      "spell_id": 1465,
      "eng_name": "Investiture of Flame",
      "name": "  [Investiture of Flame]"
    },
    {
      "spell_id": 1466,
      "eng_name": "Investiture of Stone",
      "name": "  [Investiture of Stone]"
    },
    {
      "spell_id": 1467,
      "eng_name": "Investiture of Ice",
      "name": "  [Investiture of Ice]"
    },
    {
      "spell_id": 1486,
      "eng_name": "Crown of Stars",
      "name": "  [Crown of Stars]"
    },
    {
      "spell_id": 1485,
      "eng_name": "Psychic Scream",
      "name": "  [Psychic Scream]"
    },
    {
      "spell_id": 1382,
      "eng_name": "Tasha's Caustic Brew",
      "name": "   [Tasha's Caustic Brew]"
    },
    {
      "spell_id": 1487,
      "eng_name": "Summon Fiend",
      "name": "  [Summon Fiend]"
    },
    {
      "spell_id": 1550,
      "eng_name": "Rime's Binding Ice",
      "name": "   [Rime's Binding Ice]"
    },
    {
      "spell_id": 1538,
      "eng_name": "Temporal Shunt",
      "name": "  [Temporal Shunt]"
    },
    {
      "spell_id": 1452,
      "eng_name": "Absorb Elements",
      "name": "  [Absorb Elements]"
    },
    {
      "spell_id": 1540,
      "eng_name": "Pulse Wave",
      "name": "  [Pulse Wave]"
    },
    {
      "spell_id": 1542,
      "eng_name": "Immovable Object",
      "name": " ' [Immovable Object]"
    },
    {
      "spell_id": 1541,
      "eng_name": "Fortune's Favor",
      "name": "  [Fortune's Favor]"
    },
    {
      "spell_id": 1377,
      "eng_name": "Ceremony",
      "name": " [Ceremony]"
    },
    {
      "spell_id": 1545,
      "eng_name": "Gift of Alacrity",
      "name": "  [Gift of Alacrity]"
    },
    {
      "spell_id": 1375,
      "eng_name": "Word of Radiance",
      "name": "  [Word of Radiance]"
    },
    {
      "spell_id": 1544,
      "eng_name": "Magnify Gravity",
      "name": "  [Magnify Gravity]"
    },
    {
      "spell_id": 1378,
      "eng_name": "Chaos Bolt",
      "name": "  [Chaos Bolt]"
    },
    {
      "spell_id": 1384,
      "eng_name": "Healing Spirit",
      "name": "  [Healing Spirit]"
    },
    {
      "spell_id": 1380,
      "eng_name": "Dragon's Breath",
      "name": "  [Dragon's Breath]"
    },
    {
      "spell_id": 1387,
      "eng_name": "Aganazzar's Scorcher",
      "name": "  [Aganazzar's Scorcher]"
    },
    {
      "spell_id": 1392,
      "eng_name": "Snilloc's Snowball Swarm",
      "name": "   [Snilloc's Snowball Swarm]"
    },
    {
      "spell_id": 1396,
      "eng_name": "Summon Lesser Demons",
      "name": "   [Summon Lesser Demons]"
    },
    {
      "spell_id": 1365,
      "eng_name": "Green-Flame Blade",
      "name": "   [Green-Flame Blade]"
    },
    {
      "spell_id": 1398,
      "eng_name": "Thunder Step",
      "name": "  [Thunder Step]"
    },
    {
      "spell_id": 1402,
      "eng_name": "Melf's Minute Meteors",
      "name": "   [Melf's Minute Meteors]"
    },
    {
      "spell_id": 1461,
      "eng_name": "Ice Knife",
      "name": "  [Ice Knife]"
    },
    {
      "spell_id": 1413,
      "eng_name": "Create Bonfire",
      "name": "  [Create Bonfire]"
    },
    {
      "spell_id": 1464,
      "eng_name": "Investiture of Wind",
      "name": "  [Investiture of Wind]"
    },
    {
      "spell_id": 1443,
      "eng_name": "Spirit Shroud",
      "name": "  [Spirit Shroud]"
    },
    {
      "spell_id": 1490,
      "eng_name": "Blade of Disaster",
      "name": "  [Blade of Disaster]"
    },
    {
      "spell_id": 1523,
      "eng_name": "Summon Draconic Spirit",
      "name": "   [Summon Draconic Spirit]"
    },
    {
      "spell_id": 1527,
      "eng_name": "Draconic Transformation",
      "name": "  [Draconic Transformation]"
    },
    {
      "spell_id": 1532,
      "eng_name": "Ravenous Void",
      "name": "  [Ravenous Void]"
    },
    {
      "spell_id": 1535,
      "eng_name": "Tether Essence",
      "name": "'  [Tether Essence]"
    }
  ]
}
</file>

<file path="src/lib/refs/dictionary.ts">
export const DND_DICTIONARY = {
    attributes: {
        strength: "",
        dexterity: "",
        constitution: "",
        intelligence: "",
        wisdom: "",
        charisma: ""
    },
    skills: {
        acrobatics: "",
        animalHandling: "  ",
        arcana: "",
        athletics: "",
        deception: "",
        history: "",
        insight: " ",
        intimidation: "",
        investigation: "",
        medicine: "",
        nature: "",
        perception: "",
        performance: "",
        persuasion: "",
        religion: "",
        sleightOfHand: " ",
        stealth: "",
        survival: ""
    },
    classes: {
        artificer: "",
        barbarian: "",
        bard: "",
        cleric: "",
        druid: "",
        fighter: "",
        monk: "",
        paladin: "",
        ranger: "",
        rogue: "",
        sorcerer: "",
        warlock: "",
        wizard: ""
    },
    races: {
        dragonborn: "",
        dwarf: "",
        elf: "",
        gnome: "",
        "half-elf": "",
        "half-orc": "",
        halfling: "",
        human: "",
        tiefling: ""
    },
    rules: {
        proficiency: "",
        proficiencyBonus: " ",
        savingThrow: "",
        skillCheck: " ",
        spell: "",
        cantrip: "",
        range: "",
        duration: "",
        concentration: "",
        castTime: " ",
        component: "",
        verbal: "",
        somatic: "",
        material: "",
        infusion: "",
        turn: "",
        round: "",
        action: "",
        "as an action": "",
        bonusAction: " ",
        "as a bonus action": " ",
        reaction: "",
        "with reaction": "",
        "speed or movement": "",
        initiative: "",
        attackRoll: " ",
        damage: "",
        damageRoll: " ",
        criticalHit: " ",
        armorClass: " ",
        hitPoint: "   ",
        advantage: "  ",
        disadvantage: "  "
    },
    conditions: {
        blinded: "",
        charmed: "",
        deafened: "",
        exhaustion: "",
        frightened: "",
        grappled: "",
        incapacitated: "",
        invisible: "",
        paralyzed: "",
        petrified: "'",
        poisoned: "",
        prone: "",
        restrained: "",
        stunned: "",
        unconscious: ""
    },
    alignments: {
        lawfulGood: " ",
        neutralGood: " ",
        chaoticGood: " ",
        lawfulNeutral: " ",
        trueNeutral: " ",
        chaoticNeutral: " ",
        lawfulEvil: " ",
        neutralEvil: " ",
        chaoticEvil: " "
    },
    damageTypes: {
        acid: "",
        bludgeoning: "",
        cold: "  ",
        fire: "  ",
        force: " ",
        lightning: "  ",
        necrotic: "",
        piercing: "",
        poison: "  ",
        psychic: "",
        radiant: " ( )",
        slashing: "",
        thunder: "  "
    },
    creatureSizes: {
        tiny: "",
        small: "",
        medium: "",
        large: "",
        huge: "",
        gargantuan: ""
    },
    spellSchools: {
        abjuration: "",
        conjuration: "",
        divination: "",
        enchantment: "",
        evocation: "",
        illusion: "",
        necromancy: "",
        transmutation: ""
    },
    generalTerms: {
        difficultyClass: " ",
        DC: "",
        natural20: " 20",
        natural1: " 1",
        abilityCheck: " ",
        contest: "",
        cover: "",
        halfCover: " ",
        threeQuartersCover: "  ",
        fullCover: " ",
        inspiration: "",
        deathSavingThrow: "  ",
        stabilize: "",
        dying: "",
        level: "",
        experience: "",
        experiencePoints: " "
    },

    dice: {
        d4: "4",
        d6: "6",
        d8: "8",
        d10: "10",
        d12: "12",
        d20: "20",
        d100: "100",
        roll: "",
        diceRoll: " "
    },

    classFeatures: {
        subclass: "",
        archetype: "",
        path: "",
        circle: "",
        domain: "",
        patron: "",
        school: "",
        tradition: "",
        oath: "",
        conclave: "",
        college: "",
        metamagic: "",
        fontOfMagic: " ",
        sorcerousRestoration: " ",
        sorcerousVersatility: " ",
        magicalGuidance: " ",
        carefulSpell: " ",
        distantSpell: " ",
        empoweredSpell: " ",
        extendedSpell: " ",
        heightenedSpell: " ",
        quickenedSpell: " ",
        subtleSpell: " ",
        twinnedSpell: " "
    },

    additionalRaces: {
        aasimar: "",
        goliath: "",
        tabaxi: "",
        kenku: "",
        firbolg: "",
        triton: "",
        aarakocra: "",
        genasi: "",
        "air genasi": " ",
        "earth genasi": " ",
        "fire genasi": " ",
        "water genasi": " ",
        goblin: "",
        hobgoblin: "",
        bugbear: "", // Bugbear - ,  =  + 
        kobold: ""
    },

    equipment: {
        weapon: "",
        armor: "  ",
        armorClass: " ",
        AC: "",
        shield: "",
        lightArmor: " ",
        mediumArmor: " ",
        heavyArmor: " ",
        simpleWeapon: " ",
        martialWeapon: " ",
        melee: "", //     
        ranged: "", //     
        ammunition: ""
    },

    restAndRecovery: {
        hitDice: " '",
        hitDie: " '",
        temporaryHP: " ",
        healing: "",
        resurrection: "",
        revivify: ""
    },

    environments: {
        terrain: "",
        difficultTerrain: " ",
        light: "  ",
        brightLight: " ",
        dimLight: " ",
        darkness: "",
        vision: "",
        blindsight: "",
        darkvision: "",
        truesight: " ",
        tremorsense: ""
    },

    magicItemTypes: {
        attunement: "",
        common: "",
        uncommon: "",
        rare: "",
        veryRare: " ",
        legendary: "",
        wondrousItem: " ",
        potion: "",
        scroll: "",
        rod: "",
        staff: "",
        wand: "",
        ring: ""
    },

    distanceAndTime: {
        feet: "",
        ft: "",
        mile: "",
        shortRest: " ",
        longRest: " ",
        minute: "",
        instant: "",
        instantaneous: ""
    },

    combatActions: {
        dash: "",
        disengage: "",
        dodge: "",
        help: "",
        hide: "",
        search: "",
        useObject: " ",
        ready: " ",
        grapple: "",
        shove: "",
        opportunityAttack: " "
    }

};

//  :      (\n\n)  .
//  proficiency      .
//     "".


// #       .  givesSpells '   engName
export const spells = [
    {
        "spell_id": 1073,
        "eng_name": "Animal shapes",
        "name": "  [Animal shapes]"
    },
    {
        "spell_id": 1084,
        "eng_name": "Incendiary Cloud",
        "name": "  [Incendiary Cloud]"
    },
    {
        "spell_id": 1194,
        "eng_name": "Conjure Minor Elementals",
        "name": "'   [Conjure Minor Elementals]"
    },
    {
        "spell_id": 1347,
        "eng_name": "Guidance",
        "name": " [Guidance]"
    },
    {
        "spell_id": 1344,
        "eng_name": "Message",
        "name": " [Message]"
    },
    {
        "spell_id": 1177,
        "eng_name": "Phantasmal Killer",
        "name": "  [Phantasmal Killer]"
    },
    {
        "spell_id": 1350,
        "eng_name": "Dancing Lights",
        "name": "  [Dancing Lights]"
    },
    {
        "spell_id": 1322,
        "eng_name": "Feather Fall",
        "name": " ' [Feather Fall]"
    },
    {
        "spell_id": 1043,
        "eng_name": "Thunderwave",
        "name": "  [Thunderwave]"
    },
    {
        "spell_id": 1068,
        "eng_name": "Wish",
        "name": " [Wish]"
    },
    {
        "spell_id": 1066,
        "eng_name": "Prismatic Wall",
        "name": "  [Prismatic Wall]"
    },
    {
        "spell_id": 1307,
        "eng_name": "Jump",
        "name": " [Jump]"
    },
    {
        "spell_id": 1552,
        "eng_name": "Conjure Barrage",
        "name": "  [Conjure Barrage]"
    },
    {
        "spell_id": 1553,
        "eng_name": "Crusader's Mantle",
        "name": "  [Crusader's Mantle]"
    },
    {
        "spell_id": 1136,
        "eng_name": "True Seeing",
        "name": "  [True Seeing]"
    },
    {
        "spell_id": 1085,
        "eng_name": "Glibness",
        "name": " [Glibness]"
    },
    {
        "spell_id": 1088,
        "eng_name": "Teleport",
        "name": " [Teleport]"
    },
    {
        "spell_id": 1250,
        "eng_name": "Darkvision",
        "name": "  [Darkvision]"
    },
    {
        "spell_id": 1161,
        "eng_name": "Mass Cure Wounds",
        "name": "   [Mass Cure Wounds]"
    },
    {
        "spell_id": 1547,
        "eng_name": "Hail of Thorns",
        "name": "  [Hail of Thorns]"
    },
    {
        "spell_id": 1548,
        "eng_name": "Beast Sense",
        "name": "  [Beast Sense]"
    },
    {
        "spell_id": 1554,
        "eng_name": "Lightning Arrow",
        "name": "  [Lightning Arrow]"
    },
    {
        "spell_id": 1041,
        "eng_name": "Faerie fire",
        "name": "  [Faerie fire]"
    },
    {
        "spell_id": 1556,
        "eng_name": "Grasping Vine",
        "name": "  [Grasping Vine]"
    },
    {
        "spell_id": 1561,
        "eng_name": "Telepathy",
        "name": " [Telepathy]"
    },
    {
        "spell_id": 1316,
        "eng_name": "Identify",
        "name": " [Identify]"
    },
    {
        "spell_id": 1311,
        "eng_name": "Grease",
        "name": " [Grease]"
    },
    {
        "spell_id": 1332,
        "eng_name": "Disguise Self",
        "name": " [Disguise Self]"
    },
    {
        "spell_id": 1306,
        "eng_name": "Alarm",
        "name": " [Alarm]"
    },
    {
        "spell_id": 1269,
        "eng_name": "Enhance Ability",
        "name": "  [Enhance Ability]"
    },
    {
        "spell_id": 1258,
        "eng_name": "Heat Metal",
        "name": "  [Heat Metal]"
    },
    {
        "spell_id": 1046,
        "eng_name": "Detect Poison and Disease",
        "name": "    [Detect Poison and Disease]"
    },
    {
        "spell_id": 1221,
        "eng_name": "Fly",
        "name": " [Fly]"
    },
    {
        "spell_id": 1491,
        "eng_name": "Elemental Weapon",
        "name": "  [Elemental Weapon]"
    },
    {
        "spell_id": 1211,
        "eng_name": "Create Food and Water",
        "name": "    [Create Food and Water]"
    },
    {
        "spell_id": 1184,
        "eng_name": "Freedom of Movement",
        "name": "  [Freedom of Movement]"
    },
    {
        "spell_id": 1555,
        "eng_name": "Aura of Purity",
        "name": "  [Aura of Purity]"
    },
    {
        "spell_id": 1327,
        "eng_name": "Expeditious Retreat",
        "name": "  [Expeditious Retreat]"
    },
    {
        "spell_id": 1206,
        "eng_name": "Water Walk",
        "name": "   [Water Walk]"
    },
    {
        "spell_id": 1277,
        "eng_name": "Suggestion",
        "name": " [Suggestion]"
    },
    {
        "spell_id": 1345,
        "eng_name": "Poison Spray",
        "name": "  [Poison Spray]"
    },
    {
        "spell_id": 1346,
        "eng_name": "Resistance",
        "name": " [Resistance]"
    },
    {
        "spell_id": 1457,
        "eng_name": "Staggering Smite",
        "name": "  [Staggering Smite]"
    },
    {
        "spell_id": 1048,
        "eng_name": "Detect evil and good",
        "name": "    [Detect evil and good]"
    },
    {
        "spell_id": 1453,
        "eng_name": "Wrathful Smite",
        "name": "  [Wrathful Smite]"
    },
    {
        "spell_id": 1141,
        "eng_name": "Wall of Stone",
        "name": "   [Wall of Stone]"
    },
    {
        "spell_id": 1363,
        "eng_name": "Flame blade",
        "name": "  [Flame blade]"
    },
    {
        "spell_id": 1057,
        "eng_name": "Vampiric Touch",
        "name": "  [Vampiric Touch]"
    },
    {
        "spell_id": 1049,
        "eng_name": "Illusory Script",
        "name": "  [Illusory Script]"
    },
    {
        "spell_id": 1044,
        "eng_name": "Bless",
        "name": " [Bless]"
    },
    {
        "spell_id": 1495,
        "eng_name": "Compelled Duel",
        "name": "   [Compelled Duel]"
    },
    {
        "spell_id": 1052,
        "eng_name": "Shocking Grasp",
        "name": "  [Shocking Grasp]"
    },
    {
        "spell_id": 1062,
        "eng_name": "Foresight",
        "name": " [Foresight]"
    },
    {
        "spell_id": 1047,
        "eng_name": "Heroism",
        "name": " [Heroism]"
    },
    {
        "spell_id": 1496,
        "eng_name": "Dissonant Whispers",
        "name": "  [Dissonant Whispers]"
    },
    {
        "spell_id": 1157,
        "eng_name": "Raise Dead",
        "name": "  [Raise Dead]"
    },
    {
        "spell_id": 1053,
        "eng_name": "Produce Flame",
        "name": "  [Produce Flame]"
    },
    {
        "spell_id": 1054,
        "eng_name": "True Strike",
        "name": "  [True Strike]"
    },
    {
        "spell_id": 1149,
        "eng_name": "Dominate Person",
        "name": "  [Dominate Person]"
    },
    {
        "spell_id": 1500,
        "eng_name": "Arms of Hadar",
        "name": "  [Arms of Hadar]"
    },
    {
        "spell_id": 1144,
        "eng_name": "Scrying",
        "name": " [Scrying]"
    },
    {
        "spell_id": 1139,
        "eng_name": "Telekinesis",
        "name": " [Telekinesis]"
    },
    {
        "spell_id": 1070,
        "eng_name": "True Polymorph",
        "name": "  [True Polymorph]"
    },
    {
        "spell_id": 1281,
        "eng_name": "Lesser Restoration",
        "name": "  [Lesser Restoration]"
    },
    {
        "spell_id": 1186,
        "eng_name": "Compulsion",
        "name": " [Compulsion]"
    },
    {
        "spell_id": 1181,
        "eng_name": "Wall of Fire",
        "name": "  [Wall of Fire]"
    },
    {
        "spell_id": 1241,
        "eng_name": "Water Breathing",
        "name": "  [Water Breathing]"
    },
    {
        "spell_id": 1190,
        "eng_name": "Ice Storm",
        "name": "  [Ice Storm]"
    },
    {
        "spell_id": 1055,
        "eng_name": "Light",
        "name": " [Light]"
    },
    {
        "spell_id": 1497,
        "eng_name": "Armor of Agathys",
        "name": "  [Armor of Agathys]"
    },
    {
        "spell_id": 1308,
        "eng_name": "Create or Destroy Water",
        "name": "    [Create or Destroy Water]"
    },
    {
        "spell_id": 1056,
        "eng_name": "Sacred Flame",
        "name": " ' [Sacred Flame]"
    },
    {
        "spell_id": 1296,
        "eng_name": "Mirror Image",
        "name": " [Mirror Image]"
    },
    {
        "spell_id": 1058,
        "eng_name": "Power Word Kill",
        "name": " :  [Power Word Kill]"
    },
    {
        "spell_id": 1271,
        "eng_name": "Flaming Sphere",
        "name": "  [Flaming Sphere]"
    },
    {
        "spell_id": 1080,
        "eng_name": "Maze",
        "name": " [Maze]"
    },
    {
        "spell_id": 1338,
        "eng_name": "Inflict Wounds",
        "name": "  [Inflict Wounds]"
    },
    {
        "spell_id": 1530,
        "eng_name": "Power Word Heal",
        "name": " :  [Power Word Heal]"
    },
    {
        "spell_id": 1242,
        "eng_name": "Daylight",
        "name": "  [Daylight]"
    },
    {
        "spell_id": 1501,
        "eng_name": "Crown of Madness",
        "name": "  [Crown of Madness]"
    },
    {
        "spell_id": 1278,
        "eng_name": "Moonbeam",
        "name": "  [Moonbeam]"
    },
    {
        "spell_id": 1260,
        "eng_name": "Spike Growth",
        "name": "  [Spike Growth]"
    },
    {
        "spell_id": 1276,
        "eng_name": "Invisibility",
        "name": " [Invisibility]"
    },
    {
        "spell_id": 1249,
        "eng_name": "Darkness",
        "name": " [Darkness]"
    },
    {
        "spell_id": 1231,
        "eng_name": "Magic Circle",
        "name": "  [Magic Circle]"
    },
    {
        "spell_id": 1503,
        "eng_name": "Chromatic Orb",
        "name": "  [Chromatic Orb]"
    },
    {
        "spell_id": 1509,
        "eng_name": "Nystul's Magic Aura",
        "name": "   [Nystul's Magic Aura]"
    },
    {
        "spell_id": 1155,
        "eng_name": "Hallow",
        "name": " [Hallow]"
    },
    {
        "spell_id": 1229,
        "eng_name": "Beacon of Hope",
        "name": "  [Beacon of Hope]"
    },
    {
        "spell_id": 1518,
        "eng_name": "Otiluke's Resilient Sphere",
        "name": "   [Otiluke's Resilient Sphere]"
    },
    {
        "spell_id": 1191,
        "eng_name": "Control Water",
        "name": "  [Control Water]"
    },
    {
        "spell_id": 1522,
        "eng_name": "Rary's Telepathic Bond",
        "name": " '  [Rary's Telepathic Bond]"
    },
    {
        "spell_id": 1504,
        "eng_name": "Tenser's Floating Disk",
        "name": "   [Tenser's Floating Disk]"
    },
    {
        "spell_id": 1513,
        "eng_name": "Leomund's Tiny Hut",
        "name": "   [Leomund's Tiny Hut]"
    },
    {
        "spell_id": 1505,
        "eng_name": "Witch Bolt",
        "name": "  [Witch Bolt]"
    },
    {
        "spell_id": 1506,
        "eng_name": "Cloud of Daggers",
        "name": "  [Cloud of Daggers]"
    },
    {
        "spell_id": 1510,
        "eng_name": "Aura of Vitality",
        "name": "  [Aura of Vitality]"
    },
    {
        "spell_id": 1524,
        "eng_name": "Arcane Gate",
        "name": "  [Arcane Gate]"
    },
    {
        "spell_id": 1529,
        "eng_name": "Tsunami",
        "name": " [Tsunami]"
    },
    {
        "spell_id": 1515,
        "eng_name": "Evard's Black Tentacles",
        "name": "   [Evard's Black Tentacles]"
    },
    {
        "spell_id": 1520,
        "eng_name": "Conjure Volley",
        "name": "  [Conjure Volley]"
    },
    {
        "spell_id": 1521,
        "eng_name": "Destructive Wave",
        "name": "  [Destructive Wave]"
    },
    {
        "spell_id": 1511,
        "eng_name": "Feign Death",
        "name": "  [Feign Death]"
    },
    {
        "spell_id": 1528,
        "eng_name": "Mordenkainen's Magnificent Mansion",
        "name": "   [Mordenkainen's Magnificent Mansion]"
    },
    {
        "spell_id": 1060,
        "eng_name": "Meteor Swarm",
        "name": "  [Meteor Swarm]"
    },
    {
        "spell_id": 1537,
        "eng_name": "Mordenkainen's Sword",
        "name": "  [Mordenkainen's Sword]"
    },
    {
        "spell_id": 1272,
        "eng_name": "Spider Climb",
        "name": "  [Spider Climb]"
    },
    {
        "spell_id": 1302,
        "eng_name": "Shield",
        "name": " [Shield]"
    },
    {
        "spell_id": 1283,
        "eng_name": "Magic Weapon",
        "name": "  [Magic Weapon]"
    },
    {
        "spell_id": 1295,
        "eng_name": "Continual Flame",
        "name": " ' [Continual Flame]"
    },
    {
        "spell_id": 1312,
        "eng_name": "Longstrider",
        "name": " [Longstrider]"
    },
    {
        "spell_id": 1352,
        "eng_name": "Mage Hand",
        "name": "  [Mage Hand]"
    },
    {
        "spell_id": 1353,
        "eng_name": "Mending",
        "name": " [Mending]"
    },
    {
        "spell_id": 1061,
        "eng_name": "Shapechange",
        "name": " [Shapechange]"
    },
    {
        "spell_id": 1063,
        "eng_name": "Mass Heal",
        "name": "  [Mass Heal]"
    },
    {
        "spell_id": 1064,
        "eng_name": "Time Stop",
        "name": "  [Time Stop]"
    },
    {
        "spell_id": 1065,
        "eng_name": "Weird",
        "name": " [Weird]"
    },
    {
        "spell_id": 1069,
        "eng_name": "Astral Projection",
        "name": "  [Astral Projection]"
    },
    {
        "spell_id": 1071,
        "eng_name": "True Resurrection",
        "name": "  [True Resurrection]"
    },
    {
        "spell_id": 1072,
        "eng_name": "Mind Blank",
        "name": "  [Mind Blank]"
    },
    {
        "spell_id": 1313,
        "eng_name": "Sanctuary",
        "name": " [Sanctuary]"
    },
    {
        "spell_id": 1074,
        "eng_name": "Sunburst",
        "name": "  [Sunburst]"
    },
    {
        "spell_id": 1076,
        "eng_name": "Feeblemind",
        "name": " [Feeblemind]"
    },
    {
        "spell_id": 1263,
        "eng_name": "Locate Animals or Plants",
        "name": "    [Locate Animals or Plants]"
    },
    {
        "spell_id": 1078,
        "eng_name": "Dominate Monster",
        "name": "  [Dominate Monster]"
    },
    {
        "spell_id": 1137,
        "eng_name": "Flesh to Stone",
        "name": "    [Flesh to Stone]"
    },
    {
        "spell_id": 1081,
        "eng_name": "Control Weather",
        "name": "  [Control Weather]"
    },
    {
        "spell_id": 1082,
        "eng_name": "Clone",
        "name": " [Clone]"
    },
    {
        "spell_id": 1104,
        "eng_name": "Prismatic Spray",
        "name": "  [Prismatic Spray]"
    },
    {
        "spell_id": 1095,
        "eng_name": "Project Image",
        "name": "  [Project Image]"
    },
    {
        "spell_id": 1087,
        "eng_name": "Sequester",
        "name": " [Sequester]"
    },
    {
        "spell_id": 1089,
        "eng_name": "Mirage Arcane",
        "name": "  [Mirage Arcane]"
    },
    {
        "spell_id": 1204,
        "eng_name": "Greater Invisibility",
        "name": "  [Greater Invisibility]"
    },
    {
        "spell_id": 1092,
        "eng_name": "Forcecage",
        "name": "  [Forcecage]"
    },
    {
        "spell_id": 1094,
        "eng_name": "Regenerate",
        "name": " [Regenerate]"
    },
    {
        "spell_id": 1098,
        "eng_name": "Reverse Gravity",
        "name": "  [Reverse Gravity]"
    },
    {
        "spell_id": 1100,
        "eng_name": "Etherealness",
        "name": " [Etherealness]"
    },
    {
        "spell_id": 1040,
        "eng_name": "Fire Bolt",
        "name": "  [Fire Bolt]"
    },
    {
        "spell_id": 1101,
        "eng_name": "Resurrection",
        "name": " [Resurrection]"
    },
    {
        "spell_id": 1102,
        "eng_name": "Fire Storm",
        "name": "  [Fire Storm]"
    },
    {
        "spell_id": 1134,
        "eng_name": "Guards and Wards",
        "name": "   [Guards and Wards]"
    },
    {
        "spell_id": 1106,
        "eng_name": "Arcane Sword",
        "name": "  [Arcane Sword]"
    },
    {
        "spell_id": 1107,
        "eng_name": "Harm",
        "name": " [Harm]"
    },
    {
        "spell_id": 1108,
        "eng_name": "Globe of Invulnerability",
        "name": "  [Globe of Invulnerability]"
    },
    {
        "spell_id": 1109,
        "eng_name": "Wall of Thorns",
        "name": "  [Wall of Thorns]"
    },
    {
        "spell_id": 1116,
        "eng_name": "Eyebite",
        "name": "  [Eyebite]"
    },
    {
        "spell_id": 1131,
        "eng_name": "Heal",
        "name": " [Heal]"
    },
    {
        "spell_id": 1111,
        "eng_name": "Create Undead",
        "name": "  [Create Undead]"
    },
    {
        "spell_id": 1113,
        "eng_name": "Word of Recall",
        "name": "  [Word of Recall]"
    },
    {
        "spell_id": 1115,
        "eng_name": "Disintegrate",
        "name": " [Disintegrate]"
    },
    {
        "spell_id": 1117,
        "eng_name": "Wind Walk",
        "name": "   [Wind Walk]"
    },
    {
        "spell_id": 1042,
        "eng_name": "Divine Favor",
        "name": "  [Divine Favor]"
    },
    {
        "spell_id": 1121,
        "eng_name": "Transport via Plants",
        "name": "   [Transport via Plants]"
    },
    {
        "spell_id": 1122,
        "eng_name": "Contingency",
        "name": " [Contingency]"
    },
    {
        "spell_id": 1135,
        "eng_name": "Heroes' Feast",
        "name": "  [Heroes' Feast]"
    },
    {
        "spell_id": 1129,
        "eng_name": "Circle of Death",
        "name": "  [Circle of Death]"
    },
    {
        "spell_id": 1130,
        "eng_name": "Blade Barrier",
        "name": " ' [Blade Barrier]"
    },
    {
        "spell_id": 1132,
        "eng_name": "Forbiddance",
        "name": " [Forbiddance]"
    },
    {
        "spell_id": 1133,
        "eng_name": "Conjure Fey",
        "name": "'  [Conjure Fey]"
    },
    {
        "spell_id": 1140,
        "eng_name": "Creation",
        "name": " [Creation]"
    },
    {
        "spell_id": 1143,
        "eng_name": "Hold Monster",
        "name": "  [Hold Monster]"
    },
    {
        "spell_id": 1168,
        "eng_name": "Contact Other Plane",
        "name": "'    [Contact Other Plane]"
    },
    {
        "spell_id": 1147,
        "eng_name": "Dispel Evil and Good",
        "name": "    [Dispel Evil and Good]"
    },
    {
        "spell_id": 1150,
        "eng_name": "Awaken",
        "name": " [Awaken]"
    },
    {
        "spell_id": 1152,
        "eng_name": "Seeming",
        "name": " [Seeming]"
    },
    {
        "spell_id": 1154,
        "eng_name": "Mislead",
        "name": " [Mislead]"
    },
    {
        "spell_id": 1153,
        "eng_name": "Planar Binding",
        "name": "  [Planar Binding]"
    },
    {
        "spell_id": 1158,
        "eng_name": "Geas",
        "name": " [Geas]"
    },
    {
        "spell_id": 1159,
        "eng_name": "Antilife shell",
        "name": "   [Antilife shell]"
    },
    {
        "spell_id": 1164,
        "eng_name": "Legend Lore",
        "name": "  [Legend Lore]"
    },
    {
        "spell_id": 1163,
        "eng_name": "Teleportation Circle",
        "name": "  [Teleportation Circle]"
    },
    {
        "spell_id": 1304,
        "eng_name": "False life",
        "name": "  [False life]"
    },
    {
        "spell_id": 1171,
        "eng_name": "Tree Stride",
        "name": "  [Tree Stride]"
    },
    {
        "spell_id": 1170,
        "eng_name": "Conjure Elemental",
        "name": "'  [Conjure Elemental]"
    },
    {
        "spell_id": 1176,
        "eng_name": "Stone Shape",
        "name": "  [Stone Shape]"
    },
    {
        "spell_id": 1178,
        "eng_name": "Hallucinatory Terrain",
        "name": "  [Hallucinatory Terrain]"
    },
    {
        "spell_id": 1174,
        "eng_name": "Arcane Hand",
        "name": "  [Arcane Hand]"
    },
    {
        "spell_id": 1156,
        "eng_name": "Animate objects",
        "name": "  [Animate objects]"
    },
    {
        "spell_id": 1195,
        "eng_name": "Conjure Woodland Beings",
        "name": "'   [Conjure Woodland Beings]"
    },
    {
        "spell_id": 1192,
        "eng_name": "Stoneskin",
        "name": "'  [Stoneskin]"
    },
    {
        "spell_id": 1203,
        "eng_name": "Guardian of Faith",
        "name": "  [Guardian of Faith]"
    },
    {
        "spell_id": 1188,
        "eng_name": "Locate Creature",
        "name": "  [Locate Creature]"
    },
    {
        "spell_id": 1200,
        "eng_name": "Fire Shield",
        "name": "  [Fire Shield]"
    },
    {
        "spell_id": 1196,
        "eng_name": "Dimension Door",
        "name": "   [Dimension Door]"
    },
    {
        "spell_id": 1198,
        "eng_name": "Divination",
        "name": " [Divination]"
    },
    {
        "spell_id": 1207,
        "eng_name": "phantom steed",
        "name": "  [phantom steed]"
    },
    {
        "spell_id": 1201,
        "eng_name": "Fabricate",
        "name": " [Fabricate]"
    },
    {
        "spell_id": 1202,
        "eng_name": "Banishment",
        "name": " [Banishment]"
    },
    {
        "spell_id": 1209,
        "eng_name": "Wind Wall",
        "name": "  [Wind Wall]"
    },
    {
        "spell_id": 1212,
        "eng_name": "Stinking Cloud",
        "name": "  [Stinking Cloud]"
    },
    {
        "spell_id": 1210,
        "eng_name": "Fear",
        "name": " [Fear]"
    },
    {
        "spell_id": 1215,
        "eng_name": "Speak with Dead",
        "name": "   [Speak with Dead]"
    },
    {
        "spell_id": 1270,
        "eng_name": "Pass without Trace",
        "name": "   [Pass without Trace]"
    },
    {
        "spell_id": 1305,
        "eng_name": "Fog Cloud",
        "name": "  [Fog Cloud]"
    },
    {
        "spell_id": 1357,
        "eng_name": "Thaumaturgy",
        "name": " [Thaumaturgy]"
    },
    {
        "spell_id": 1224,
        "eng_name": "Nondetection",
        "name": " [Nondetection]"
    },
    {
        "spell_id": 1220,
        "eng_name": "Sending",
        "name": " [Sending]"
    },
    {
        "spell_id": 1219,
        "eng_name": "Haste",
        "name": " [Haste]"
    },
    {
        "spell_id": 1251,
        "eng_name": "Animal messenger",
        "name": "- [Animal messenger]"
    },
    {
        "spell_id": 1227,
        "eng_name": "Tongues",
        "name": " [Tongues]"
    },
    {
        "spell_id": 1225,
        "eng_name": "Call Lightning",
        "name": "  [Call Lightning]"
    },
    {
        "spell_id": 1236,
        "eng_name": "Protection from Energy",
        "name": "   [Protection from Energy]"
    },
    {
        "spell_id": 1238,
        "eng_name": "Sleet Storm",
        "name": " [Sleet Storm]"
    },
    {
        "spell_id": 1239,
        "eng_name": "Conjure Animals",
        "name": "'  [Conjure Animals]"
    },
    {
        "spell_id": 1243,
        "eng_name": "Hypnotic Pattern",
        "name": "  [Hypnotic Pattern]"
    },
    {
        "spell_id": 1252,
        "eng_name": "Branding Smite",
        "name": "  [Branding Smite]"
    },
    {
        "spell_id": 1248,
        "eng_name": "Silence",
        "name": " [Silence]"
    },
    {
        "spell_id": 1253,
        "eng_name": "Knock",
        "name": " [Knock]"
    },
    {
        "spell_id": 1256,
        "eng_name": "Scorching Ray",
        "name": "  [Scorching Ray]"
    },
    {
        "spell_id": 1254,
        "eng_name": "Hold Person",
        "name": "  [Hold Person]"
    },
    {
        "spell_id": 1265,
        "eng_name": "Locate Object",
        "name": "  [Locate Object]"
    },
    {
        "spell_id": 1261,
        "eng_name": "Augury",
        "name": " [Augury]"
    },
    {
        "spell_id": 1262,
        "eng_name": "Ray of Enfeeblement",
        "name": "  [Ray of Enfeeblement]"
    },
    {
        "spell_id": 1266,
        "eng_name": "Find Traps",
        "name": "  [Find Traps]"
    },
    {
        "spell_id": 1274,
        "eng_name": "Warding Bond",
        "name": " ' [Warding Bond]"
    },
    {
        "spell_id": 1286,
        "eng_name": "Melf's Acid arrow",
        "name": "   [Melf's Acid arrow]"
    },
    {
        "spell_id": 1287,
        "eng_name": "Zone of Truth",
        "name": "  [Zone of Truth]"
    },
    {
        "spell_id": 1292,
        "eng_name": "Spiritual Weapon",
        "name": "  [Spiritual Weapon]"
    },
    {
        "spell_id": 1288,
        "eng_name": "Alter self",
        "name": "  [Alter self]"
    },
    {
        "spell_id": 1297,
        "eng_name": "Detect Thoughts",
        "name": "  [Detect Thoughts]"
    },
    {
        "spell_id": 1300,
        "eng_name": "Arcane Lock",
        "name": "  [Arcane Lock]"
    },
    {
        "spell_id": 1294,
        "eng_name": "Shatter",
        "name": " [Shatter]"
    },
    {
        "spell_id": 1315,
        "eng_name": "Comprehend Languages",
        "name": "  [Comprehend Languages]"
    },
    {
        "spell_id": 1310,
        "eng_name": "Sleep",
        "name": " [Sleep]"
    },
    {
        "spell_id": 1320,
        "eng_name": "Hellish Rebuke",
        "name": "  [Hellish Rebuke]"
    },
    {
        "spell_id": 1323,
        "eng_name": "Purify Food and Drink",
        "name": "    [Purify Food and Drink]"
    },
    {
        "spell_id": 1493,
        "eng_name": "Bigby's Hand",
        "name": "  [Bigby's Hand]"
    },
    {
        "spell_id": 1494,
        "eng_name": "Friends",
        "name": " [Friends]"
    },
    {
        "spell_id": 1318,
        "eng_name": "Charm Person",
        "name": "  [Charm Person]"
    },
    {
        "spell_id": 1317,
        "eng_name": "Speak with Animals",
        "name": "   [Speak with Animals]"
    },
    {
        "spell_id": 1355,
        "eng_name": "Acid splash",
        "name": "  [Acid splash]"
    },
    {
        "spell_id": 1097,
        "eng_name": "Finger of Death",
        "name": "  [Finger of Death]"
    },
    {
        "spell_id": 1326,
        "eng_name": "Mage Armor",
        "name": "  [Mage Armor]"
    },
    {
        "spell_id": 1328,
        "eng_name": "Unseen Servant",
        "name": "  [Unseen Servant]"
    },
    {
        "spell_id": 1257,
        "eng_name": "Blur",
        "name": " [Blur]"
    },
    {
        "spell_id": 1329,
        "eng_name": "Command",
        "name": " [Command]"
    },
    {
        "spell_id": 1340,
        "eng_name": "Goodberry",
        "name": " [Goodberry]"
    },
    {
        "spell_id": 1341,
        "eng_name": "Druidcraft",
        "name": "  [Druidcraft]"
    },
    {
        "spell_id": 1336,
        "eng_name": "Bane",
        "name": " [Bane]"
    },
    {
        "spell_id": 1386,
        "eng_name": "Skywrite",
        "name": "  [Skywrite]"
    },
    {
        "spell_id": 1412,
        "eng_name": "Frostbite",
        "name": " [Frostbite]"
    },
    {
        "spell_id": 1379,
        "eng_name": "Snare",
        "name": " [Snare]"
    },
    {
        "spell_id": 1383,
        "eng_name": "Warding Wind",
        "name": "  [Warding Wind]"
    },
    {
        "spell_id": 1403,
        "eng_name": "Life Transference",
        "name": "  [Life Transference]"
    },
    {
        "spell_id": 1399,
        "eng_name": "Enemies Abound",
        "name": "  [Enemies Abound]"
    },
    {
        "spell_id": 1435,
        "eng_name": "Negative Energy Flood",
        "name": "   [Negative Energy Flood]"
    },
    {
        "spell_id": 1401,
        "eng_name": "Tiny Servant",
        "name": "  [Tiny Servant]"
    },
    {
        "spell_id": 1400,
        "eng_name": "Catnap",
        "name": " [Catnap]"
    },
    {
        "spell_id": 1404,
        "eng_name": "Wall of Sand",
        "name": "  [Wall of Sand]"
    },
    {
        "spell_id": 1415,
        "eng_name": "Magic Stone",
        "name": "  [Magic Stone]"
    },
    {
        "spell_id": 1423,
        "eng_name": "Charm Monster",
        "name": "  [Charm Monster]"
    },
    {
        "spell_id": 1417,
        "eng_name": "Guardian of Nature",
        "name": "  [Guardian of Nature]"
    },
    {
        "spell_id": 1431,
        "eng_name": "Control Winds",
        "name": "  [Control Winds]"
    },
    {
        "spell_id": 1126,
        "eng_name": "Magic Jar",
        "name": "  [Magic Jar]"
    },
    {
        "spell_id": 1426,
        "eng_name": "Storm Sphere",
        "name": "  [Storm Sphere]"
    },
    {
        "spell_id": 1434,
        "eng_name": "Skill Empowerment",
        "name": "  [Skill Empowerment]"
    },
    {
        "spell_id": 1459,
        "eng_name": "Beast Bond",
        "name": "  [Beast Bond]"
    },
    {
        "spell_id": 1416,
        "eng_name": "Gust",
        "name": " [Gust]"
    },
    {
        "spell_id": 1419,
        "eng_name": "Watery Sphere",
        "name": "  [Watery Sphere]"
    },
    {
        "spell_id": 1420,
        "eng_name": "Vitriolic Sphere",
        "name": "  [Vitriolic Sphere]"
    },
    {
        "spell_id": 1230,
        "eng_name": "Mass Healing Word",
        "name": "   [Mass Healing Word]"
    },
    {
        "spell_id": 1437,
        "eng_name": "Holy Weapon",
        "name": "  [Holy Weapon]"
    },
    {
        "spell_id": 1432,
        "eng_name": "Infernal Calling",
        "name": "  [Infernal Calling]"
    },
    {
        "spell_id": 1440,
        "eng_name": "Wall of Light",
        "name": "  [Wall of Light]"
    },
    {
        "spell_id": 1433,
        "eng_name": "Transmute Rock",
        "name": "  [Transmute Rock]"
    },
    {
        "spell_id": 1436,
        "eng_name": "Dawn",
        "name": " [Dawn]"
    },
    {
        "spell_id": 1441,
        "eng_name": "Danse Macabre",
        "name": "  [Danse Macabre]"
    },
    {
        "spell_id": 1463,
        "eng_name": "Zephyr Strike",
        "name": "  [Zephyr Strike]"
    },
    {
        "spell_id": 1354,
        "eng_name": "Shillelagh",
        "name": " [Shillelagh]"
    },
    {
        "spell_id": 1473,
        "eng_name": "Scatter",
        "name": " [Scatter]"
    },
    {
        "spell_id": 1475,
        "eng_name": "Tenser's Transformation",
        "name": "  [Tenser's Transformation]"
    },
    {
        "spell_id": 1474,
        "eng_name": "Create Homunculus",
        "name": "  [Create Homunculus]"
    },
    {
        "spell_id": 1476,
        "eng_name": "Whirlwind",
        "name": " [Whirlwind]"
    },
    {
        "spell_id": 1468,
        "eng_name": "Druid Grove",
        "name": "  [Druid Grove]"
    },
    {
        "spell_id": 1472,
        "eng_name": "Primordial Ward",
        "name": "  [Primordial Ward]"
    },
    {
        "spell_id": 1469,
        "eng_name": "Bones of the Earth",
        "name": "  [Bones of the Earth]"
    },
    {
        "spell_id": 1471,
        "eng_name": "Mental Prison",
        "name": " ' [Mental Prison]"
    },
    {
        "spell_id": 1477,
        "eng_name": "Power Word Pain",
        "name": " :  [Power Word Pain]"
    },
    {
        "spell_id": 1479,
        "eng_name": "Abi-Dalzim's Horrid Wilting",
        "name": " ' - [Abi-Dalzim's Horrid Wilting]"
    },
    {
        "spell_id": 1445,
        "eng_name": "Blade Ward",
        "name": "   [Blade Ward]"
    },
    {
        "spell_id": 1356,
        "eng_name": "Vicious Mockery",
        "name": "  [Vicious Mockery]"
    },
    {
        "spell_id": 1364,
        "eng_name": "Booming Blade",
        "name": "  [Booming Blade]"
    },
    {
        "spell_id": 1448,
        "eng_name": "Summon Construct",
        "name": "  [Summon Construct]"
    },
    {
        "spell_id": 1560,
        "eng_name": "Fizban's Platinum Shield",
        "name": "   [Fizban's Platinum Shield]"
    },
    {
        "spell_id": 1293,
        "eng_name": "Barkskin",
        "name": "  [Barkskin]"
    },
    {
        "spell_id": 1533,
        "eng_name": "Dark Star",
        "name": "  [Dark Star]"
    },
    {
        "spell_id": 1454,
        "eng_name": "Thunderous Smite",
        "name": "  [Thunderous Smite]"
    },
    {
        "spell_id": 1456,
        "eng_name": "Blinding Smite",
        "name": "  [Blinding Smite]"
    },
    {
        "spell_id": 1245,
        "eng_name": "Revivify",
        "name": " [Revivify]"
    },
    {
        "spell_id": 1514,
        "eng_name": "Aura of Life",
        "name": "  [Aura of Life]"
    },
    {
        "spell_id": 1193,
        "eng_name": "Death Ward",
        "name": "   [Death Ward]"
    },
    {
        "spell_id": 1543,
        "eng_name": "Wristpocket",
        "name": "  [Wristpocket]"
    },
    {
        "spell_id": 1369,
        "eng_name": "Infestation",
        "name": " [Infestation]"
    },
    {
        "spell_id": 1370,
        "eng_name": "Primal Savagery",
        "name": "  [Primal Savagery]"
    },
    {
        "spell_id": 1546,
        "eng_name": "Sapping Sting",
        "name": "  [Sapping Sting]"
    },
    {
        "spell_id": 1371,
        "eng_name": "Toll the Dead",
        "name": "  [Toll the Dead]"
    },
    {
        "spell_id": 1372,
        "eng_name": "Lightning Lure",
        "name": "  [Lightning Lure]"
    },
    {
        "spell_id": 1373,
        "eng_name": "Mind Sliver",
        "name": "  [Mind Sliver]"
    },
    {
        "spell_id": 1374,
        "eng_name": "Sword Burst",
        "name": "  [Sword Burst]"
    },
    {
        "spell_id": 1376,
        "eng_name": "Cause Fear",
        "name": "  [Cause Fear]"
    },
    {
        "spell_id": 1551,
        "eng_name": "Ashardalon's Stride",
        "name": "  [Ashardalon's Stride]"
    },
    {
        "spell_id": 1091,
        "eng_name": "Symbol",
        "name": " [Symbol]"
    },
    {
        "spell_id": 1385,
        "eng_name": "Maximilian's Earthen Grasp",
        "name": "   [Maximilian's Earthen Grasp]"
    },
    {
        "spell_id": 1389,
        "eng_name": "Earthbind",
        "name": "  [Earthbind]"
    },
    {
        "spell_id": 1381,
        "eng_name": "Shadow Blade",
        "name": "  [Shadow Blade]"
    },
    {
        "spell_id": 1422,
        "eng_name": "Find Greater Steed",
        "name": "   [Find Greater Steed]"
    },
    {
        "spell_id": 1391,
        "eng_name": "Mind Spike",
        "name": "  [Mind Spike]"
    },
    {
        "spell_id": 1390,
        "eng_name": "Pyrotechnics",
        "name": " [Pyrotechnics]"
    },
    {
        "spell_id": 1299,
        "eng_name": "See Invisibility",
        "name": "  [See Invisibility]"
    },
    {
        "spell_id": 1397,
        "eng_name": "Wall of Water",
        "name": "  [Wall of Water]"
    },
    {
        "spell_id": 1519,
        "eng_name": "Raulothim's Psychic Lance",
        "name": "   [Raulothim's Psychic Lance]"
    },
    {
        "spell_id": 1394,
        "eng_name": "Tasha's Mind Whip",
        "name": "   [Tasha's Mind Whip]"
    },
    {
        "spell_id": 1395,
        "eng_name": "Erupting Earth",
        "name": "  [Erupting Earth]"
    },
    {
        "spell_id": 1406,
        "eng_name": "Tidal Wave",
        "name": "  [Tidal Wave]"
    },
    {
        "spell_id": 1222,
        "eng_name": "Glyph of Warding",
        "name": "  [Glyph of Warding]"
    },
    {
        "spell_id": 1405,
        "eng_name": "Flame Arrows",
        "name": "  [Flame Arrows]"
    },
    {
        "spell_id": 1451,
        "eng_name": "Summon Celestial",
        "name": "  [Summon Celestial]"
    },
    {
        "spell_id": 1408,
        "eng_name": "Intellect Fortress",
        "name": "  [Intellect Fortress]"
    },
    {
        "spell_id": 1427,
        "eng_name": "Maelstrom",
        "name": " [Maelstrom]"
    },
    {
        "spell_id": 1460,
        "eng_name": "Catapult",
        "name": " [Catapult]"
    },
    {
        "spell_id": 1410,
        "eng_name": "Thunderclap",
        "name": "  [Thunderclap]"
    },
    {
        "spell_id": 1442,
        "eng_name": "Steel Wind Strike",
        "name": "   [Steel Wind Strike]"
    },
    {
        "spell_id": 1429,
        "eng_name": "Far Step",
        "name": "  [Far Step]"
    },
    {
        "spell_id": 1446,
        "eng_name": "Summon Shadowspawn",
        "name": "   [Summon Shadowspawn]"
    },
    {
        "spell_id": 1462,
        "eng_name": "Earth Tremor",
        "name": "  [Earth Tremor]"
    },
    {
        "spell_id": 1301,
        "eng_name": "Shield of Faith",
        "name": "  [Shield of Faith]"
    },
    {
        "spell_id": 1483,
        "eng_name": "Mass Polymorph",
        "name": "  [Mass Polymorph]"
    },
    {
        "spell_id": 1478,
        "eng_name": "Temple of the Gods",
        "name": "  [Temple of the Gods]"
    },
    {
        "spell_id": 1482,
        "eng_name": "Maddening Darkness",
        "name": "  [Maddening Darkness]"
    },
    {
        "spell_id": 1480,
        "eng_name": "Illusory Dragon",
        "name": "  [Illusory Dragon]"
    },
    {
        "spell_id": 1481,
        "eng_name": "Mighty Fortress",
        "name": "  [Mighty Fortress]"
    },
    {
        "spell_id": 1484,
        "eng_name": "Invulnerability",
        "name": " [Invulnerability]"
    },
    {
        "spell_id": 1447,
        "eng_name": "Summon Undead",
        "name": "  [Summon Undead]"
    },
    {
        "spell_id": 1488,
        "eng_name": "Tasha's Otherworldly Guise",
        "name": "   [Tasha's Otherworldly Guise]"
    },
    {
        "spell_id": 1450,
        "eng_name": "Summon Aberration",
        "name": "  [Summon Aberration]"
    },
    {
        "spell_id": 1489,
        "eng_name": "Dream of the Blue Veil",
        "name": "   [Dream of the Blue Veil]"
    },
    {
        "spell_id": 1444,
        "eng_name": "Summon Fey",
        "name": "  [Summon Fey]"
    },
    {
        "spell_id": 1409,
        "eng_name": "Control Flames",
        "name": "   [Control Flames]"
    },
    {
        "spell_id": 1449,
        "eng_name": "Summon Elemental",
        "name": "  [Summon Elemental]"
    },
    {
        "spell_id": 1508,
        "eng_name": "Nathair's Mischief",
        "name": "  [Nathair's Mischief]"
    },
    {
        "spell_id": 1059,
        "eng_name": "Imprisonment",
        "name": "' [Imprisonment]"
    },
    {
        "spell_id": 1536,
        "eng_name": "Gravity Fissure",
        "name": "  [Gravity Fissure]"
    },
    {
        "spell_id": 1531,
        "eng_name": "Time Ravage",
        "name": "  [Time Ravage]"
    },
    {
        "spell_id": 1534,
        "eng_name": "Reality Break",
        "name": "  [Reality Break]"
    },
    {
        "spell_id": 1393,
        "eng_name": "Summon Beast",
        "name": "  [Summon Beast]"
    },
    {
        "spell_id": 1539,
        "eng_name": "Gravity Sinkhole",
        "name": "  [Gravity Sinkhole]"
    },
    {
        "spell_id": 1234,
        "eng_name": "Remove Curse",
        "name": "  [Remove Curse]"
    },
    {
        "spell_id": 1247,
        "eng_name": "Misty Step",
        "name": "  [Misty Step]"
    },
    {
        "spell_id": 1324,
        "eng_name": "Tasha's Hideous Laughter",
        "name": "   [Tasha's Hideous Laughter]"
    },
    {
        "spell_id": 1337,
        "eng_name": "Protection from Evil and Good",
        "name": "     [Protection from Evil and Good]"
    },
    {
        "spell_id": 1086,
        "eng_name": "Antimagic field",
        "name": "  [Antimagic field]"
    },
    {
        "spell_id": 1359,
        "eng_name": "Thorn whip",
        "name": "  [Thorn whip]"
    },
    {
        "spell_id": 1120,
        "eng_name": "Planar Ally",
        "name": "  [Planar Ally]"
    },
    {
        "spell_id": 1050,
        "eng_name": "Prestidigitation",
        "name": " [Prestidigitation]"
    },
    {
        "spell_id": 1549,
        "eng_name": "Cordon of Arrows",
        "name": "  [Cordon of Arrows]"
    },
    {
        "spell_id": 1558,
        "eng_name": "Swift Quiver",
        "name": "  [Swift Quiver]"
    },
    {
        "spell_id": 1557,
        "eng_name": "Circle of Power",
        "name": "  [Circle of Power]"
    },
    {
        "spell_id": 1333,
        "eng_name": "Magic missile",
        "name": "  [Magic missile]"
    },
    {
        "spell_id": 1362,
        "eng_name": "hex",
        "name": " [hex]"
    },
    {
        "spell_id": 1279,
        "eng_name": "Rope Trick",
        "name": "  [Rope Trick]"
    },
    {
        "spell_id": 1045,
        "eng_name": "Detect Magic",
        "name": "  [Detect Magic]"
    },
    {
        "spell_id": 1559,
        "eng_name": "Drawmij's Instant Summons",
        "name": "   [Drawmij's Instant Summons]"
    },
    {
        "spell_id": 1291,
        "eng_name": "Protection from Poison",
        "name": "   [Protection from Poison]"
    },
    {
        "spell_id": 1289,
        "eng_name": "Enlarge/Reduce",
        "name": "/ [Enlarge/Reduce]"
    },
    {
        "spell_id": 1259,
        "eng_name": "Aid",
        "name": " [Aid]"
    },
    {
        "spell_id": 1216,
        "eng_name": "Dispel Magic",
        "name": "  [Dispel Magic]"
    },
    {
        "spell_id": 1228,
        "eng_name": "Blink",
        "name": " [Blink]"
    },
    {
        "spell_id": 1492,
        "eng_name": "Mordenkainen's Faithful Hound",
        "name": "   [Mordenkainen's Faithful Hound]"
    },
    {
        "spell_id": 1275,
        "eng_name": "Gentle Repose",
        "name": "  [Gentle Repose]"
    },
    {
        "spell_id": 1334,
        "eng_name": "Cure Wounds",
        "name": "  [Cure Wounds]"
    },
    {
        "spell_id": 1343,
        "eng_name": "Eldritch Blast",
        "name": "  [Eldritch Blast]"
    },
    {
        "spell_id": 1455,
        "eng_name": "Searing Smite",
        "name": "  [Searing Smite]"
    },
    {
        "spell_id": 1458,
        "eng_name": "Banishing Smite",
        "name": "  [Banishing Smite]"
    },
    {
        "spell_id": 1051,
        "eng_name": "Storm of Vengeance",
        "name": "  [Storm of Vengeance]"
    },
    {
        "spell_id": 1339,
        "eng_name": "Animal friendship",
        "name": "   [Animal friendship]"
    },
    {
        "spell_id": 1165,
        "eng_name": "Modify Memory",
        "name": "  [Modify Memory]"
    },
    {
        "spell_id": 1167,
        "eng_name": "Commune",
        "name": " [Commune]"
    },
    {
        "spell_id": 1151,
        "eng_name": "Flame Strike",
        "name": "'  [Flame Strike]"
    },
    {
        "spell_id": 1067,
        "eng_name": "Gate",
        "name": " [Gate]"
    },
    {
        "spell_id": 1172,
        "eng_name": "Cloudkill",
        "name": "  [Cloudkill]"
    },
    {
        "spell_id": 1331,
        "eng_name": "Hunter's Mark",
        "name": "  [Hunter's Mark]"
    },
    {
        "spell_id": 1499,
        "eng_name": "Ray of Sickness",
        "name": "  [Ray of Sickness]"
    },
    {
        "spell_id": 1298,
        "eng_name": "Calm Emotions",
        "name": "  [Calm Emotions]"
    },
    {
        "spell_id": 1498,
        "eng_name": "Ensnaring Strike",
        "name": "  [Ensnaring Strike]"
    },
    {
        "spell_id": 1208,
        "eng_name": "Slow",
        "name": " [Slow]"
    },
    {
        "spell_id": 1146,
        "eng_name": "Dream",
        "name": " [Dream]"
    },
    {
        "spell_id": 1217,
        "eng_name": "Animate dead",
        "name": "  [Animate dead]"
    },
    {
        "spell_id": 1502,
        "eng_name": "Phantasmal Force",
        "name": "  [Phantasmal Force]"
    },
    {
        "spell_id": 1517,
        "eng_name": "Mordenkainen's Private Sanctum",
        "name": "   [Mordenkainen's Private Sanctum]"
    },
    {
        "spell_id": 1516,
        "eng_name": "Leomund's Secret Chest",
        "name": "   [Leomund's Secret Chest]"
    },
    {
        "spell_id": 1525,
        "eng_name": "Otiluke's Freezing Sphere",
        "name": "   [Otiluke's Freezing Sphere]"
    },
    {
        "spell_id": 1507,
        "eng_name": "Levitate",
        "name": " [Levitate]"
    },
    {
        "spell_id": 1512,
        "eng_name": "Hunger of Hadar",
        "name": "  [Hunger of Hadar]"
    },
    {
        "spell_id": 1526,
        "eng_name": "Otto's Irresistible Dance",
        "name": "   [Otto's Irresistible Dance]"
    },
    {
        "spell_id": 1213,
        "eng_name": "Plant Growth",
        "name": "  [Plant Growth]"
    },
    {
        "spell_id": 1244,
        "eng_name": "Gaseous Form",
        "name": "  [Gaseous Form]"
    },
    {
        "spell_id": 1145,
        "eng_name": "Passwall",
        "name": "  [Passwall]"
    },
    {
        "spell_id": 1319,
        "eng_name": "Find Familiar",
        "name": "  [Find Familiar]"
    },
    {
        "spell_id": 1342,
        "eng_name": "Ray of Frost",
        "name": "  [Ray of Frost]"
    },
    {
        "spell_id": 1348,
        "eng_name": "Chill Touch",
        "name": "  [Chill Touch]"
    },
    {
        "spell_id": 1358,
        "eng_name": "Antipathy/Sympathy",
        "name": "/ [Antipathy/Sympathy]"
    },
    {
        "spell_id": 1075,
        "eng_name": "Power Word Stun",
        "name": " :  [Power Word Stun]"
    },
    {
        "spell_id": 1162,
        "eng_name": "Cone of Cold",
        "name": "  [Cone of Cold]"
    },
    {
        "spell_id": 1077,
        "eng_name": "Holy aura",
        "name": "  [Holy aura]"
    },
    {
        "spell_id": 1079,
        "eng_name": "Demiplane",
        "name": " [Demiplane]"
    },
    {
        "spell_id": 1083,
        "eng_name": "Earthquake",
        "name": " [Earthquake]"
    },
    {
        "spell_id": 1470,
        "eng_name": "Soul Cage",
        "name": "  [Soul Cage]"
    },
    {
        "spell_id": 1090,
        "eng_name": "Simulacrum",
        "name": " [Simulacrum]"
    },
    {
        "spell_id": 1096,
        "eng_name": "Plane Shift",
        "name": "  [Plane Shift]"
    },
    {
        "spell_id": 1099,
        "eng_name": "Conjure Celestial",
        "name": "  [Conjure Celestial]"
    },
    {
        "spell_id": 1103,
        "eng_name": "Delayed Blast Fireball",
        "name": "   [Delayed Blast Fireball]"
    },
    {
        "spell_id": 1118,
        "eng_name": "Programmed Illusion",
        "name": "  [Programmed Illusion]"
    },
    {
        "spell_id": 1105,
        "eng_name": "Divine Word",
        "name": "  [Divine Word]"
    },
    {
        "spell_id": 1280,
        "eng_name": "Prayer of Healing",
        "name": "  [Prayer of Healing]"
    },
    {
        "spell_id": 1110,
        "eng_name": "Wall of Ice",
        "name": "  [Wall of Ice]"
    },
    {
        "spell_id": 1112,
        "eng_name": "Sunbeam",
        "name": "  [Sunbeam]"
    },
    {
        "spell_id": 1114,
        "eng_name": "Move Earth",
        "name": "  [Move Earth]"
    },
    {
        "spell_id": 1349,
        "eng_name": "Spare the Dying",
        "name": "   [Spare the Dying]"
    },
    {
        "spell_id": 1119,
        "eng_name": "Find the Path",
        "name": "  [Find the Path]"
    },
    {
        "spell_id": 1125,
        "eng_name": "Mass Suggestion",
        "name": "  [Mass Suggestion]"
    },
    {
        "spell_id": 1127,
        "eng_name": "Chain Lightning",
        "name": "  [Chain Lightning]"
    },
    {
        "spell_id": 1142,
        "eng_name": "Wall of Force",
        "name": "  [Wall of Force]"
    },
    {
        "spell_id": 1148,
        "eng_name": "Reincarnate",
        "name": " [Reincarnate]"
    },
    {
        "spell_id": 1160,
        "eng_name": "Insect Plague",
        "name": "  [Insect Plague]"
    },
    {
        "spell_id": 1166,
        "eng_name": "Commune with Nature",
        "name": "   [Commune with Nature]"
    },
    {
        "spell_id": 1169,
        "eng_name": "Contagion",
        "name": " [Contagion]"
    },
    {
        "spell_id": 1179,
        "eng_name": "Blight",
        "name": " [Blight]"
    },
    {
        "spell_id": 1185,
        "eng_name": "Dominate Beast",
        "name": "  [Dominate Beast]"
    },
    {
        "spell_id": 1183,
        "eng_name": "Confusion",
        "name": " [Confusion]"
    },
    {
        "spell_id": 1189,
        "eng_name": "Polymorph",
        "name": " [Polymorph]"
    },
    {
        "spell_id": 1197,
        "eng_name": "Giant Insect",
        "name": "  [Giant Insect]"
    },
    {
        "spell_id": 1205,
        "eng_name": "Arcane eye",
        "name": "  [Arcane eye]"
    },
    {
        "spell_id": 1303,
        "eng_name": "healing word",
        "name": "  [healing word]"
    },
    {
        "spell_id": 1214,
        "eng_name": "Speak with Plants",
        "name": "   [Speak with Plants]"
    },
    {
        "spell_id": 1218,
        "eng_name": "Clairvoyance",
        "name": " [Clairvoyance]"
    },
    {
        "spell_id": 1223,
        "eng_name": "Major Image",
        "name": "  [Major Image]"
    },
    {
        "spell_id": 1226,
        "eng_name": "Bestow Curse",
        "name": "  [Bestow Curse]"
    },
    {
        "spell_id": 1237,
        "eng_name": "Lightning Bolt",
        "name": "  [Lightning Bolt]"
    },
    {
        "spell_id": 1233,
        "eng_name": "Counterspell",
        "name": " [Counterspell]"
    },
    {
        "spell_id": 1235,
        "eng_name": "Meld into Stone",
        "name": "   [Meld into Stone]"
    },
    {
        "spell_id": 1240,
        "eng_name": "Spirit Guardians",
        "name": "  [Spirit Guardians]"
    },
    {
        "spell_id": 1246,
        "eng_name": "Fireball",
        "name": " [Fireball]"
    },
    {
        "spell_id": 1255,
        "eng_name": "Blindness/Deafness",
        "name": "/ [Blindness/Deafness]"
    },
    {
        "spell_id": 1273,
        "eng_name": "Web",
        "name": " [Web]"
    },
    {
        "spell_id": 1309,
        "eng_name": "Guiding Bolt",
        "name": "  [Guiding Bolt]"
    },
    {
        "spell_id": 1264,
        "eng_name": "Find Steed",
        "name": "  [Find Steed]"
    },
    {
        "spell_id": 1267,
        "eng_name": "Gust of Wind",
        "name": "  [Gust of Wind]"
    },
    {
        "spell_id": 1282,
        "eng_name": "Magic Mouth",
        "name": "  [Magic Mouth]"
    },
    {
        "spell_id": 1290,
        "eng_name": "Enthrall",
        "name": "  [Enthrall]"
    },
    {
        "spell_id": 1173,
        "eng_name": "Greater Restoration",
        "name": "  [Greater Restoration]"
    },
    {
        "spell_id": 1321,
        "eng_name": "Burning Hands",
        "name": "  [Burning Hands]"
    },
    {
        "spell_id": 1325,
        "eng_name": "Entangle",
        "name": " [Entangle]"
    },
    {
        "spell_id": 1351,
        "eng_name": "Minor Illusion",
        "name": "  [Minor Illusion]"
    },
    {
        "spell_id": 1330,
        "eng_name": "Silent Image",
        "name": "  [Silent Image]"
    },
    {
        "spell_id": 1335,
        "eng_name": "Color Spray",
        "name": "  [Color Spray]"
    },
    {
        "spell_id": 1388,
        "eng_name": "Dust Devil",
        "name": "  [Dust Devil]"
    },
    {
        "spell_id": 1421,
        "eng_name": "Sickening Radiance",
        "name": "  [Sickening Radiance]"
    },
    {
        "spell_id": 1418,
        "eng_name": "Summon Greater Demon",
        "name": "   [Summon Greater Demon]"
    },
    {
        "spell_id": 1411,
        "eng_name": "Mold Earth",
        "name": "  [Mold Earth]"
    },
    {
        "spell_id": 1424,
        "eng_name": "Elemental Bane",
        "name": "  [Elemental Bane]"
    },
    {
        "spell_id": 1414,
        "eng_name": "Shape Water",
        "name": "  [Shape Water]"
    },
    {
        "spell_id": 1428,
        "eng_name": "Wrath of Nature",
        "name": "  [Wrath of Nature]"
    },
    {
        "spell_id": 1425,
        "eng_name": "Shadow of Moil",
        "name": "  [Shadow of Moil]"
    },
    {
        "spell_id": 1430,
        "eng_name": "Enervation",
        "name": " [Enervation]"
    },
    {
        "spell_id": 1438,
        "eng_name": "Synaptic Static",
        "name": "  [Synaptic Static]"
    },
    {
        "spell_id": 1439,
        "eng_name": "Immolation",
        "name": " [Immolation]"
    },
    {
        "spell_id": 1465,
        "eng_name": "Investiture of Flame",
        "name": "  [Investiture of Flame]"
    },
    {
        "spell_id": 1466,
        "eng_name": "Investiture of Stone",
        "name": "  [Investiture of Stone]"
    },
    {
        "spell_id": 1467,
        "eng_name": "Investiture of Ice",
        "name": "  [Investiture of Ice]"
    },
    {
        "spell_id": 1486,
        "eng_name": "Crown of Stars",
        "name": "  [Crown of Stars]"
    },
    {
        "spell_id": 1485,
        "eng_name": "Psychic Scream",
        "name": "  [Psychic Scream]"
    },
    {
        "spell_id": 1382,
        "eng_name": "Tasha's Caustic Brew",
        "name": "   [Tasha's Caustic Brew]"
    },
    {
        "spell_id": 1487,
        "eng_name": "Summon Fiend",
        "name": "  [Summon Fiend]"
    },
    {
        "spell_id": 1550,
        "eng_name": "Rime's Binding Ice",
        "name": "   [Rime's Binding Ice]"
    },
    {
        "spell_id": 1538,
        "eng_name": "Temporal Shunt",
        "name": "  [Temporal Shunt]"
    },
    {
        "spell_id": 1452,
        "eng_name": "Absorb Elements",
        "name": "  [Absorb Elements]"
    },
    {
        "spell_id": 1540,
        "eng_name": "Pulse Wave",
        "name": "  [Pulse Wave]"
    },
    {
        "spell_id": 1542,
        "eng_name": "Immovable Object",
        "name": " ' [Immovable Object]"
    },
    {
        "spell_id": 1541,
        "eng_name": "Fortune's Favor",
        "name": "  [Fortune's Favor]"
    },
    {
        "spell_id": 1377,
        "eng_name": "Ceremony",
        "name": " [Ceremony]"
    },
    {
        "spell_id": 1545,
        "eng_name": "Gift of Alacrity",
        "name": "  [Gift of Alacrity]"
    },
    {
        "spell_id": 1375,
        "eng_name": "Word of Radiance",
        "name": "  [Word of Radiance]"
    },
    {
        "spell_id": 1544,
        "eng_name": "Magnify Gravity",
        "name": "  [Magnify Gravity]"
    },
    {
        "spell_id": 1378,
        "eng_name": "Chaos Bolt",
        "name": "  [Chaos Bolt]"
    },
    {
        "spell_id": 1384,
        "eng_name": "Healing Spirit",
        "name": "  [Healing Spirit]"
    },
    {
        "spell_id": 1380,
        "eng_name": "Dragon's Breath",
        "name": "  [Dragon's Breath]"
    },
    {
        "spell_id": 1387,
        "eng_name": "Aganazzar's Scorcher",
        "name": "  [Aganazzar's Scorcher]"
    },
    {
        "spell_id": 1392,
        "eng_name": "Snilloc's Snowball Swarm",
        "name": "   [Snilloc's Snowball Swarm]"
    },
    {
        "spell_id": 1396,
        "eng_name": "Summon Lesser Demons",
        "name": "   [Summon Lesser Demons]"
    },
    {
        "spell_id": 1365,
        "eng_name": "Green-Flame Blade",
        "name": "   [Green-Flame Blade]"
    },
    {
        "spell_id": 1398,
        "eng_name": "Thunder Step",
        "name": "  [Thunder Step]"
    },
    {
        "spell_id": 1402,
        "eng_name": "Melf's Minute Meteors",
        "name": "   [Melf's Minute Meteors]"
    },
    {
        "spell_id": 1461,
        "eng_name": "Ice Knife",
        "name": "  [Ice Knife]"
    },
    {
        "spell_id": 1413,
        "eng_name": "Create Bonfire",
        "name": "  [Create Bonfire]"
    },
    {
        "spell_id": 1464,
        "eng_name": "Investiture of Wind",
        "name": "  [Investiture of Wind]"
    },
    {
        "spell_id": 1443,
        "eng_name": "Spirit Shroud",
        "name": "  [Spirit Shroud]"
    },
    {
        "spell_id": 1490,
        "eng_name": "Blade of Disaster",
        "name": "  [Blade of Disaster]"
    },
    {
        "spell_id": 1523,
        "eng_name": "Summon Draconic Spirit",
        "name": "   [Summon Draconic Spirit]"
    },
    {
        "spell_id": 1527,
        "eng_name": "Draconic Transformation",
        "name": "  [Draconic Transformation]"
    },
    {
        "spell_id": 1532,
        "eng_name": "Ravenous Void",
        "name": "  [Ravenous Void]"
    },
    {
        "spell_id": 1535,
        "eng_name": "Tether Essence",
        "name": "'  [Tether Essence]"
    }
]
</file>

<file path="src/lib/types/enums.ts">
export const SkillsEnum = [
  "ATHLETICS",
  "ACROBATICS",
  "SLEIGHT_OF_HAND",
  "STEALTH",
  "ARCANA",
  "HISTORY",
  "INVESTIGATION",
  "NATURE",
  "RELIGION",
  "ANIMAL_HANDLING",
  "INSIGHT",
  "MEDICINE",
  "PERCEPTION",
  "SURVIVAL",
  "DECEPTION",
  "INTIMIDATION",
  "PERFORMANCE",
  "PERSUASION",
] as const

export type Skill = typeof SkillsEnum[number]

export const WeaponKinds = [
  "meleeSimple",
  "meleeMartial",
  "rangedSimple",
  "rangedMartial",
  "firearmsAdditional"
] as const;

export type WeaponKindType = typeof WeaponKinds[number];
</file>

<file path="src/lib/prisma.ts">
import { PrismaClient } from "@prisma/client";
import { PrismaPg } from "@prisma/adapter-pg";
import { Pool } from "pg";

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
}

const pool = new Pool({ connectionString: process.env.DATABASE_URL });
const adapter = new PrismaPg(pool);

export const prisma =
  globalForPrisma.prisma ??
  new PrismaClient({
    adapter,
    log: ['error', 'warn']
  })

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;
</file>

<file path="tailwind.config.ts">
import type { Config } from "tailwindcss";
import tailwindcssAnimate from "tailwindcss-animate";

const config: Config = {
  darkMode: ["class"],
  content: [
    "./src/app/**/*.{js,ts,jsx,tsx}",
    "./src/components/**/*.{js,ts,jsx,tsx}",
    "./src/lib/**/*.{js,ts,jsx,tsx}",
  ],
  safelist: [
    "bg-violet-700",
    "bg-violet-900",
    "hover:bg-violet-700",
    "hover:bg-violet-800",
    "border-slate-700",
    "border-slate-800",
  ],
  theme: {
    extend: {
      fontFamily: {
        sans: ["var(--font-inter)", "ui-sans-serif", "system-ui", "sans-serif"],
        mono: [
          "var(--font-jetbrains-mono)",
          "ui-monospace",
          "SFMono-Regular",
          "Menlo",
          "Monaco",
          "Consolas",
          "Liberation Mono",
          "Courier New",
          "monospace",
        ],
        "rpg-display": [
          "var(--font-rpg-display)",
          "var(--font-cinzel)",
          "ui-serif",
          "Georgia",
          "Cambria",
          "Times New Roman",
          "serif",
        ],
      },
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      colors: {
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        chart: {
          1: "hsl(var(--chart-1))",
          2: "hsl(var(--chart-2))",
          3: "hsl(var(--chart-3))",
          4: "hsl(var(--chart-4))",
          5: "hsl(var(--chart-5))",
        },
      },
    },
  },
  plugins: [tailwindcssAnimate],
};

export default config;
</file>

<file path="prisma/enums/Subraces.prisma">
enum Subraces {
  DWARF_HILL_2014
  DWARF_MOUNTAIN_2014
  DWARF_DUERGAR_GRAY_SCAG
  ELF_HIGH_2014
  ELF_WOOD_2014
  ELF_DARK_DROW_2014
  ELF_ELADRIN_DMG
  ELF_ELADRIN_MPMM
  ELF_SHADAR_KAI_MPMM
  ELF_SEA_MTOF
  ELF_PALLID_EGTW
  GNOME_FOREST_2014
  GNOME_ROCK_2014
  GNOME_DEEP_SCAG
  HALFLING_LIGHTFOOT_2014
  HALFLING_STOUT_2014
  HALFLING_GHOSTWISE_SCAG
  DRAGONBORN_BLACK
  DRAGONBORN_BLUE
  DRAGONBORN_BRASS
  DRAGONBORN_BRONZE
  DRAGONBORN_COPPER
  DRAGONBORN_GOLD
  DRAGONBORN_GREEN
  DRAGONBORN_RED
  DRAGONBORN_SILVER
  DRAGONBORN_WHITE
  DRAGONBORN_DRACONBLOOD
  DRAGONBORN_RAVENITE
  AASIMAR_PROTECTOR
  AASIMAR_SCOURGE
  AASIMAR_FALLEN
  SHIFTER_BEASTHIDE
  SHIFTER_LONGTOOTH
  SHIFTER_SWIFTSTRIDE
  SHIFTER_WILDHUNT
}
</file>

<file path="prisma/enums/Variants.prisma">
enum Variants {
  HALF_ELF_VARIANT_HIGH_DESCENT_SCAG
  HALF_ELF_VARIANT_WOOD_DESCENT_SCAG
  HALF_ELF_VARIANT_DROW_DESCENT_SCAG
  HALF_ELF_VARIANT_AQUATIC_DESCENT_SCAG
  HALF_ELF_VARIANT
  // Tiefling SCAG Bloodlines
  TIEFLING_ASMODEUS
  TIEFLING_BAALZEBUL
  TIEFLING_DISPATER
  TIEFLING_FIERNA
  TIEFLING_GLASYA
  TIEFLING_LEVISTUS
  TIEFLING_MAMMON
  TIEFLING_MEPHISTOPHELES
  TIEFLING_ZARIEL
  // Tiefling MTOF Variants
  TIEFLING_VARIANT_FERAL_SCAG
  TIEFLING_VARIANT_DEVILS_TONGUE_SCAG
  TIEFLING_VARIANT_HELLFIRE_SCAG
  TIEFLING_VARIANT_WINGED_SCAG
  // Human Variant
  HUMAN_VARIANT
  // Half-Elf Dragonmarks (Eberron)
  HALF_ELF_MARK_OF_DETECTION_EBERRON
  HALF_ELF_MARK_OF_STORM_EBERRON
  // Dwarf Dragonmarks (Eberron)
  DWARF_MARK_OF_WARDING_EBERRON
  // Halfling Dragonmarks (Eberron)
  HALFLING_MARK_OF_HEALING_EBERRON
  HALFLING_MARK_OF_HOSPITALITY_EBERRON
  // Gnome Dragonmarks (EBERRON)
  GNOME_MARK_OF_SCRIBING_EBERRON
  // Human Dragonmarks (EBERRON)
  HUMAN_MARK_OF_FINDING_EBERRON
  HUMAN_MARK_OF_HANDLING_EBERRON
  HUMAN_MARK_OF_MAKING_EBERRON
  HUMAN_MARK_OF_PASSAGE_EBERRON
  HUMAN_MARK_OF_SENTINEL_EBERRON
  // Elf Dragonmarks (EBERRON)
  ELF_MARK_OF_SHADOW_EBERRON

  HALF_ORC_MARK_OF_FINDING_EBERRON
}
</file>

<file path="prisma/models/accounts/Account.prisma">
model Account {
  accountId         Int    @id @default(autoincrement()) @map("account_id")
  userId            Int    @map("user_id")
  type              String
  provider          String
  providerAccountId String    @map("provider_account_id")

  refresh_token String? @map("refresh_token") @db.Text
  access_token  String? @map("access_token") @db.Text
  expires_at    Int?    @map("expires_at")
  token_type    String? @map("token_type")
  scope        String?
  id_token      String? @map("id_token") @db.Text
  session_state String? @map("session_state")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("account")
}
</file>

<file path="prisma/models/choices/ChoiceOption.prisma">
model ChoiceOption {
  choiceOptionId Int @id @default(autoincrement()) @map("option_id")

  groupName     String @map("group_name") @db.VarChar(100)
  optionName    String @map("option_name") @db.VarChar(100)
  optionNameEng String @unique @map("option_name_eng") @db.VarChar(100)
  prerequisites Json? // {pact: 'pact'}

  features           ChoiceOptionFeature[]
  classChoiceOptions ClassChoiceOption[]
  subclassChoiceOptions SubclassChoiceOption[]
  featChoiceOptions  FeatChoiceOption[]
  perses             Pers[]
  persFeatChoices    PersFeatChoice[]

  classOptionalFeatures ClassOptionalFeature[]

  @@map("choice_option")
}
</file>

<file path="prisma/models/classes/ClassFeature.prisma">
model ClassFeature {
  classFeatureId Int @id @default(autoincrement()) @map("class_feature_id")
  classId        Int @map("class_id")
  featureId      Int @map("feature_id")

  levelGranted     Int     @map("level_granted")
  grantsSpellSlots Boolean @default(false) @map("grants_spell_slots")
  
  mechanicType FeatureMechanic @default(PASSIVE) @map("mechanic_type")
  
  mechanicMetadata Json? @map("mechanic_metadata")
  
  displayOrder Int @default(0) @map("display_order")
  
  mechanicDescription String? @map("mechanic_description") @db.Text

  feature Feature @relation(fields: [featureId], references: [featureId], onDelete: Cascade)
  class   Class   @relation(fields: [classId], references: [classId], onDelete: Cascade)

  @@index([classId, levelGranted])
  @@index([mechanicType])
  @@map("class_feature")
}
</file>

<file path="prisma/models/classes/SubclassFeature.prisma">
model SubclassFeature {
  subclassFeatureId Int @id @default(autoincrement()) @map("subclass_feature_id")
  subclassId        Int @map("subclass_id")
  featureId         Int @map("feature_id")

  levelGranted Int @map("level_granted")

  grantsSpellSlots Boolean @default(false) @map("grants_spell_slots")

  feature  Feature  @relation(fields: [featureId], references: [featureId], onDelete: Cascade)
  subclass Subclass @relation(fields: [subclassId], references: [subclassId], onDelete: Cascade)

  @@unique([subclassId, featureId])
  @@map("subclass_feature")
}
</file>

<file path="prisma/models/feats/Feat.prisma">
model Feat {
  featId      Int      @id @default(autoincrement()) @map("feat_id")
  name        Feats    @unique // enum    
  engName     String   @map("eng_name")
  source      Source   @default(PHB)
  
  description     String  @db.Text
  shortDescription String @map("short_description") @db.Text
  
  // 
  prerequisiteAbilityScore Json?   @map("prerequisite_ability_score") // {STR: 13}
  prerequisiteLevel        Int?    @map("prerequisite_level")
  prerequisiteProficiency  Json?   @map("prerequisite_proficiency") // {armor: ["MEDIUM"]}
  prerequisiteSpellcasting Boolean @default(false) @map("prerequisite_spellcasting")
  prerequisiteFeat         String? @map("prerequisite_feat") //   
  
  //   ( )
  raceRestriction    Races[]    @default([]) @map("race_restriction")
  subraceRestriction Subraces[] @default([]) @map("subrace_restriction")
  
  //   
  /// [FeatASI]
  grantedASI              Json?       @map("granted_asi") // {STR: 1, DEX: 1}  {ANY: 1}
  grantedSkillCount       Int         @default(0) @map("granted_skill_count")
  /// [SkillProficiencies]
  grantedSkills           Json?       @map("granted_skills")
  grantedLanguageCount    Int         @default(0) @map("granted_language_count")
  grantedLanguages        Language[]  @default([]) @map("granted_languages")
  /// [ToolProficiencies]
  grantedToolProficiencies Json?      @map("granted_tool_proficiencies")
  /// [WeaponProficiencies]
  grantedWeaponProficiencies Json?   @map("granted_weapon_proficiencies")
  grantedArmorProficiencies  ArmorType[] @default([]) @map("granted_armor_proficiencies")
  
  //  
  grantsFeature Feature[] @relation("FeatGrantsFeature")
  
  // '
  perses PersFeat[]
  featChoiceOptions FeatChoiceOption[]
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("feat")
}
</file>

<file path="prisma/models/items/MagicItem.prisma">
model MagicItem {
  magicItemId Int    @id @default(autoincrement()) @map("magic_item_id")
  name        String @db.VarChar(100)

  engName  String        @unique @map("eng_name") @db.VarChar(100)
  itemType MagicItemType @map("item_type")
  rarity   ItemRarity

  description      String  @db.Text
  shortDescription String? @map("short_description") @db.Text

  requiresAttunement Boolean @default(false) @map("requires_attunement")

  bonusToRangedDamage Int? @map("bonus_to_ranged_damage")
  bonusToAC           Int? @map("bonus_to_ac")

  bonusToSavingThrows       Json?    @map("bonus_to_saving_throws")
  noArmorOrShieldForACBonus Boolean? @map("no_armor_or_shield_for_ac_bonus")

  /// [WeaponProficiencies]
  weaponProficiencies        Json? @map("weapon_proficiencies")
  /// [WeaponProficienciesSpecial]
  weaponProficienciesSpecial Json? @map("weapon_proficiencies_special")

  persMagicItems PersMagicItem[]

  // Opposite side of Infusion.replicatedMagicItem
  replicatedByInfusions Infusion[]

  givesSpells Spell[]

  @@map("magic_item")
}
</file>

<file path="prisma/models/items/Weapon.prisma">
model Weapon {
  weaponId Int            @id @default(autoincrement()) @map("weapon_id")
  name     WeaponCategory @unique

  damage     String
  damageType DamageType @map("damage_type")
  weaponType WeaponType @map("weapon_type")
  sortOrder  Int        @default(999) @map("sort_order")

  isRanged Boolean @map("is_ranged") @default(false)
  isAdditional Boolean @map("is_additional") @default(false)

  properties WeaponProperty[]

  versatileDamage String? @map("versatile_damage")

  normalRange Int? @map("normal_range")
  longRange   Int? @map("long_range")

  persWeapons                  PersWeapon[]
  classStartingEquipmentOption ClassStartingEquipmentOption[]

  @@map("weapon")
}
</file>

<file path="prisma/models/pers/PersFeat.prisma">
model PersFeat {
  persFeatId Int @id @default(autoincrement()) @map("pers_feat_id")
  featId     Int @map("feat_id")
  persId     Int @map("pers_id")

  feat Feat @relation(fields: [featId], references: [featId], onDelete: Cascade)
  pers Pers @relation(fields: [persId], references: [persId], onDelete: Cascade)

  choices PersFeatChoice[]

  @@unique([featId, persId])
  @@map("pers_feat")
}
</file>

<file path="prisma/models/races/RaceVariantTrait.prisma">
model RaceVariantTrait {
  raceVariantTraitId Int @id @default(autoincrement()) @map("race_variant_trait_id")
  raceVariantId      Int @map("race_variant_id")
  featureId          Int @map("feature_id")

  feature     Feature     @relation(fields: [featureId], references: [featureId], onDelete: Cascade)
  raceVariant RaceVariant @relation(fields: [raceVariantId], references: [raceVariantId], onDelete: Cascade)

  @@unique([raceVariantId, featureId])
  @@map("race_variant_trait")
}
</file>

<file path="prisma/models/races/Subrace.prisma">
model Subrace {
  subraceId     Int      @id @default(autoincrement()) @map("subrace_id")
  raceId        Int      @map("race_id")
  name          Subraces @unique
  speedModifier Int?     @map("speed_modifier")
  swimSpeed     Int?     @map("swim_speed")
  flightSpeed   Int?     @map("flight_speed")
  source        Source   @default(PHB)

  replacesASI      Boolean   @default(false) @map("replaces_asi")
  replacesFeatures Feature[] @relation("SubraceReplacingFeature")

  additionalASI          Json?      @map("additional_asi")
  additionalLanguages    Language[] @default([]) @map("additional_languages")
  languagesToChooseCount Int        @default(0) @map("languages_to_choose_count")
  cantripToChooseCount   Int        @default(0) @map("cantrip_to_choose_count")

  /// [ToolProficiencies]
  toolProficiencies   Json?       @map("tool_proficiencies")
  toolToChooseCount   Int?        @map("tool_to_choose_count")
  /// [SkillProficiencies]
  skillProficiencies  Json?       @map("skill_proficiencies")
  /// [WeaponProficiencies]
  weaponProficiencies Json?       @map("weapon_proficiencies")
  armorProficiencies  ArmorType[] @default([]) @map("armor_proficiencies")

  race              Race               @relation(fields: [raceId], references: [raceId], onDelete: Cascade)
  perses            Pers[]
  raceChoiceOptions RaceChoiceOption[]

  traits SubraceTrait[]

  @@map("subrace")
}
</file>

<file path="prisma/models/races/SubraceTrait.prisma">
model SubraceTrait {
  subraceTraitId Int @id @default(autoincrement()) @map("subrace_trait_id")
  subraceId      Int @map("subrace_id")
  featureId      Int @map("feature_id")

  feature Feature @relation(fields: [featureId], references: [featureId], onDelete: Cascade)
  subrace Subrace @relation(fields: [subraceId], references: [subraceId], onDelete: Cascade)

  @@unique([subraceId, featureId])
  @@map("subrace_trait")
}
</file>

<file path="prisma/seed/classChoiceOptionSeed.ts">
import { Classes, Prisma, PrismaClient } from "@prisma/client";

export const seedClassChoiceOptions = async (prisma: PrismaClient) => {
    console.log('  \'    ...')

    const options: Prisma.ClassChoiceOptionCreateInput[] = [
        // ===    ===
        {
            levelsGranted: [1],
            choiceOption: { connect: { optionNameEng: 'Archery' } },
            class: { connect: { name: Classes.FIGHTER_2014 } }
        },
        {
            levelsGranted: [2],
            choiceOption: { connect: { optionNameEng: 'Archery' } },
            class: { connect: { name: Classes.RANGER_2014 } }
        },

        // ===   ===
        {
            levelsGranted: [1],
            choiceOption: { connect: { optionNameEng: 'Blind Fighting' } },
            class: { connect: { name: Classes.FIGHTER_2014 } }
        },
        {
            levelsGranted: [2],
            choiceOption: { connect: { optionNameEng: 'Blind Fighting' } },
            class: { connect: { name: Classes.PALADIN_2014 } }
        },
        {
            levelsGranted: [2],
            choiceOption: { connect: { optionNameEng: 'Blind Fighting' } },
            class: { connect: { name: Classes.RANGER_2014 } }
        },

        // ===  ===
        {
            levelsGranted: [1],
            choiceOption: { connect: { optionNameEng: 'Defense' } },
            class: { connect: { name: Classes.FIGHTER_2014 } }
        },
        {
            levelsGranted: [2],
            choiceOption: { connect: { optionNameEng: 'Defense' } },
            class: { connect: { name: Classes.PALADIN_2014 } }
        },
        {
            levelsGranted: [2],
            choiceOption: { connect: { optionNameEng: 'Defense' } },
            class: { connect: { name: Classes.RANGER_2014 } }
        },

        // ===  ===
        {
            levelsGranted: [1],
            choiceOption: { connect: { optionNameEng: 'Dueling' } },
            class: { connect: { name: Classes.FIGHTER_2014 } }
        },
        {
            levelsGranted: [2],
            choiceOption: { connect: { optionNameEng: 'Dueling' } },
            class: { connect: { name: Classes.PALADIN_2014 } }
        },
        {
            levelsGranted: [2],
            choiceOption: { connect: { optionNameEng: 'Dueling' } },
            class: { connect: { name: Classes.RANGER_2014 } }
        },

        // ===    ===
        {
            levelsGranted: [1],
            choiceOption: { connect: { optionNameEng: 'Great Weapon Fighting' } },
            class: { connect: { name: Classes.FIGHTER_2014 } }
        },
        {
            levelsGranted: [2],
            choiceOption: { connect: { optionNameEng: 'Great Weapon Fighting' } },
            class: { connect: { name: Classes.PALADIN_2014 } }
        },

        // ===  ===
        {
            levelsGranted: [1],
            choiceOption: { connect: { optionNameEng: 'Interception' } },
            class: { connect: { name: Classes.FIGHTER_2014 } }
        },
        {
            levelsGranted: [2],
            choiceOption: { connect: { optionNameEng: 'Interception' } },
            class: { connect: { name: Classes.PALADIN_2014 } }
        },

        // ===  ===
        {
            levelsGranted: [1],
            choiceOption: { connect: { optionNameEng: 'Protection' } },
            class: { connect: { name: Classes.FIGHTER_2014 } }
        },
        {
            levelsGranted: [2],
            choiceOption: { connect: { optionNameEng: 'Protection' } },
            class: { connect: { name: Classes.PALADIN_2014 } }
        },

        // ===   ( Fighter) ===
        {
            levelsGranted: [1],
            choiceOption: { connect: { optionNameEng: 'Superior Technique' } },
            class: { connect: { name: Classes.FIGHTER_2014 } }
        },

        // ===    ===
        {
            levelsGranted: [1],
            choiceOption: { connect: { optionNameEng: 'Thrown Weapon Fighting' } },
            class: { connect: { name: Classes.FIGHTER_2014 } }
        },
        {
            levelsGranted: [2],
            choiceOption: { connect: { optionNameEng: 'Thrown Weapon Fighting' } },
            class: { connect: { name: Classes.RANGER_2014 } }
        },

        // ===    ===
        {
            levelsGranted: [1],
            choiceOption: { connect: { optionNameEng: 'Two-Weapon Fighting' } },
            class: { connect: { name: Classes.FIGHTER_2014 } }
        },
        {
            levelsGranted: [2],
            choiceOption: { connect: { optionNameEng: 'Two-Weapon Fighting' } },
            class: { connect: { name: Classes.RANGER_2014 } }
        },

        // ===   ( Fighter) ===
        {
            levelsGranted: [1],
            choiceOption: { connect: { optionNameEng: 'Unarmed Fighting' } },
            class: { connect: { name: Classes.FIGHTER_2014 } }
        },

        // ===   ( Ranger) ===
        {
            levelsGranted: [2],
            choiceOption: { connect: { optionNameEng: 'Druidic Warrior' } },
            class: { connect: { name: Classes.RANGER_2014 } }
        },

        // ===   ( Paladin) ===
        {
            levelsGranted: [2],
            choiceOption: { connect: { optionNameEng: 'Blessed Warrior' } },
            class: { connect: { name: Classes.PALADIN_2014 } }
        },

        // ===   (Ranger ) ===
        {
            levelsGranted: [1],
            choiceOption: { connect: { optionNameEng: 'Favored Foe' } },
            class: { connect: { name: Classes.RANGER_2014 } }
        },

        // ===   (Ranger ) ===
        {
            levelsGranted: [1],
            choiceOption: { connect: { optionNameEng: 'Favored Enemy' } },
            class: { connect: { name: Classes.RANGER_2014 } }
        },


        {
            levelsGranted: [1],
            choiceOption: { connect: { optionNameEng: 'Deft Explorer - Canny' } },
            class: { connect: { name: Classes.RANGER_2014 } }
        },
        {
            levelsGranted: [1],
            choiceOption: { connect: { optionNameEng: 'Natural Explorer' } },
            class: { connect: { name: Classes.RANGER_2014 } }
        },

        {
            levelsGranted: [3],
            choiceOption: { connect: { optionNameEng: 'Primal Awareness' } },
            class: { connect: { name: Classes.RANGER_2014 } }
        },
        {
            levelsGranted: [3],
            choiceOption: { connect: { optionNameEng: 'Primeval Awareness' } },
            class: { connect: { name: Classes.RANGER_2014 } }
        },


        {
            levelsGranted: [10],
            choiceOption: { connect: { optionNameEng: 'Nature\'s Veil' } },
            class: { connect: { name: Classes.RANGER_2014 } }
        },
        {
            levelsGranted: [10],
            choiceOption: { connect: { optionNameEng: 'Hide in Plain Sight' } },
            class: { connect: { name: Classes.RANGER_2014 } }
        },



        // ===== WARLOCK PACT BOONS (3 ) =====

        {
            levelsGranted: [3],
            choiceOption: { connect: { optionNameEng: 'Pact of the Blade' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [3],
            choiceOption: { connect: { optionNameEng: 'Pact of the Chain' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [3],
            choiceOption: { connect: { optionNameEng: 'Pact of the Tome' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [3],
            choiceOption: { connect: { optionNameEng: 'Pact of the Talisman' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },




        // ===== WARLOCK ELDRITCH INVOCATIONS - XGE & TCE =====

//  2 (  ,   )
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Aspect of the Moon' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },

//  2 (  ,   )
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Investment of the Chain Master' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },

//  2 (  ,   )
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Rebuke of the Talisman' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },

//  5
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Cloak of Flies' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Maddening Hex' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Far Scribe' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Undying Servitude' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },

//  7
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Ghostly Gaze' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Relentless Hex' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Protection of the Talisman' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },

//  9
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Gift of the Protectors' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },

//  12
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Bond of the Talisman' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },

        // ===== WARLOCK ELDRITCH INVOCATIONS =====

//  2 -     prereq
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Agonizing Blast' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Armor of Shadows' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Beguiling Influence' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Beast Speech' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Devil\'s Sight' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Eldritch Sight' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Eldritch Mind' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Eldritch Spear' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Eyes of the Rune Keeper' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Fiendish Vigor' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Gaze of Two Minds' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Mask of Many Faces' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Misty Visions' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Repelling Blast' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Grasp of Hadar' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Lance of Lethargy' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },

//  3 -  Voice of the Chain Master (  Pact of the Chain)
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Voice of the Chain Master' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Book of Ancient Secrets' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },

//  5
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Thirsting Blade' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Sign of Ill Omen' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Improved Pact Weapon' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Gift of the Depths' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Gift of the Ever-Living Ones' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Eldritch Smite' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Tomb of Levistus' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },

//  7
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Sculptor of Flesh' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'One with Shadows' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Trickster\'s Escape' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },

//  9
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Ascendant Step' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Whispers of the Grave' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Otherworldly Leap' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Minions of Chaos' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },

//  12
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Lifedrinker' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },

//  15
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Visions of Distant Realms' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Master of Myriad Forms' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Shrouded in Shadow' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Witch Sight' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },
        {
            levelsGranted: [2, 5, 7, 9, 12, 15, 18],
            choiceOption: { connect: { optionNameEng: 'Chains of Carceri' } },
            class: { connect: { name: Classes.WARLOCK_2014 } }
        },

        // ===== SORCERER METAMAGIC =====
        {
            levelsGranted: [3, 10, 17],
            choiceOption: { connect: { optionNameEng: 'Careful Spell' } },
            class: { connect: { name: Classes.SORCERER_2014 } }
        },
        {
            levelsGranted: [3, 10, 17],
            choiceOption: { connect: { optionNameEng: 'Distant Spell' } },
            class: { connect: { name: Classes.SORCERER_2014 } }
        },
        {
            levelsGranted: [3, 10, 17],
            choiceOption: { connect: { optionNameEng: 'Empowered Spell' } },
            class: { connect: { name: Classes.SORCERER_2014 } }
        },
        {
            levelsGranted: [3, 10, 17],
            choiceOption: { connect: { optionNameEng: 'Extended Spell' } },
            class: { connect: { name: Classes.SORCERER_2014 } }
        },
        {
            levelsGranted: [3, 10, 17],
            choiceOption: { connect: { optionNameEng: 'Heightened Spell' } },
            class: { connect: { name: Classes.SORCERER_2014 } }
        },
        {
            levelsGranted: [3, 10, 17],
            choiceOption: { connect: { optionNameEng: 'Quickened Spell' } },
            class: { connect: { name: Classes.SORCERER_2014 } }
        },
        {
            levelsGranted: [3, 10, 17],
            choiceOption: { connect: { optionNameEng: 'Subtle Spell' } },
            class: { connect: { name: Classes.SORCERER_2014 } }
        },
        {
            levelsGranted: [3, 10, 17],
            choiceOption: { connect: { optionNameEng: 'Twinned Spell' } },
            class: { connect: { name: Classes.SORCERER_2014 } }
        },
        {
            levelsGranted: [3, 10, 17],
            choiceOption: { connect: { optionNameEng: 'Seeking Spell' } },
            class: { connect: { name: Classes.SORCERER_2014 } }
        },
        {
            levelsGranted: [3, 10, 17],
            choiceOption: { connect: { optionNameEng: 'Transmuted Spell' } },
            class: { connect: { name: Classes.SORCERER_2014 } }
        },

    ];

    const classes = await prisma.class.findMany();
    const choiceOptions = await prisma.choiceOption.findMany();

    const classMap = Object.fromEntries(classes.map(c => [c.name, c.classId]));
    const optionMap = Object.fromEntries(choiceOptions.map(o => [o.optionNameEng, o.choiceOptionId]));

    for (const opt of options) {
        const className = opt.class?.connect?.name;
        const optionNameEng = opt.choiceOption?.connect?.optionNameEng;

        if (!className) {
            throw new Error("Seed option is missing class.connect.name");
        }
        if (!optionNameEng) {
            throw new Error("Seed option is missing choiceOption.connect.optionNameEng");
        }

        const classId = classMap[className];
        const choiceOptionId = optionMap[optionNameEng];

        if (!classId) {
            throw new Error(`Class not found for name=${className}`);
        }
        if (!choiceOptionId) {
            throw new Error(`ChoiceOption not found for optionNameEng=${optionNameEng}`);
        }

        await prisma.classChoiceOption.upsert({
            where: {
                unique_class_choice: { classId, choiceOptionId },
            },
            update: {
                levelsGranted: opt.levelsGranted,
            },
            create: {
                classId,
                choiceOptionId,
                levelsGranted: opt.levelsGranted,
            },
        });
    }

    console.log('  \'   :', options.length)
}
</file>

<file path="prisma/seed/raceChoiceOptionSeed.ts">
import { PrismaClient, Races } from "@prisma/client";

export const seedRaceChoiceOptions = async (prisma: PrismaClient) => {
    console.log('    ...');
    console.log('   Half-Elf Versatility...');

    const dragonborn = await prisma.race.findFirst({ where: { name: Races.DRAGONBORN_2014 } });
    if (!dragonborn) {
        throw new Error("Dragonborn race not found");
    }

    const dragonbornChromatic = await prisma.race.findFirst({ where: { name: Races.DRAGONBORN_CHROMATIC } });
    if (!dragonbornChromatic) {
        throw new Error("Dragonborn (Chromatic) race not found");
    }

    const dragonbornMetallic = await prisma.race.findFirst({ where: { name: Races.DRAGONBORN_METALLIC } });
    if (!dragonbornMetallic) {
        throw new Error("Dragonborn (Metallic) race not found");
    }

    const dragonbornGem = await prisma.race.findFirst({ where: { name: Races.DRAGONBORN_GEM } });
    if (!dragonbornGem) {
        throw new Error("Dragonborn (Gem) race not found");
    }

    const halfElf = await prisma.race.findFirst({ where: { name: Races.HALF_ELF_2014 } });
    if (!halfElf) {
        throw new Error("Half-Elf race not found");
    }

    const aasimar = await prisma.race.findFirst({ where: { name: Races.AASIMAR_MPMM } });
    if (!aasimar) {
        throw new Error("Aasimar race not found");
    }

    const shifter = await prisma.race.findFirst({ where: { name: Races.SHIFTER_MPMM } });
    if (!shifter) {
        throw new Error("Shifter race not found");
    }

    const connectFeature = (engName: string) => ({ feature: { connect: { engName } } });

    const choices = [
        // ============ DRAGONBORN ANCESTRY ============
        // Black Dragon
        {
            raceId: dragonborn.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  5x30  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Draconic Ancestry (Black)'),
                    connectFeature('Breath Weapon (Acid - Line)')
                ]
            }
        },
        // Blue Dragon
        {
            raceId: dragonborn.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  5x30  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Draconic Ancestry (Blue)'),
                    connectFeature('Breath Weapon (Lightning - Line)')
                ]
            }
        },
        // Brass Dragon
        {
            raceId: dragonborn.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  5x30  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Draconic Ancestry (Brass)'),
                    connectFeature('Breath Weapon (Fire - Line)')
                ]
            }
        },
        // Bronze Dragon
        {
            raceId: dragonborn.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  5x30  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Draconic Ancestry (Bronze)'),
                    connectFeature('Breath Weapon (Lightning - Line)')
                ]
            }
        },
        // Copper Dragon
        {
            raceId: dragonborn.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  5x30  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Draconic Ancestry (Copper)'),
                    connectFeature('Breath Weapon (Acid - Line)')
                ]
            }
        },
        // Gold Dragon
        {
            raceId: dragonborn.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  15  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Draconic Ancestry (Gold)'),
                    connectFeature('Breath Weapon (Fire - Cone)')
                ]
            }
        },
        // Green Dragon
        {
            raceId: dragonborn.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  15  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Draconic Ancestry (Green)'),
                    connectFeature('Breath Weapon (Poison - Cone)')
                ]
            }
        },
        // Red Dragon
        {
            raceId: dragonborn.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  15  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Draconic Ancestry (Red)'),
                    connectFeature('Breath Weapon (Fire - Cone)')
                ]
            }
        },
        // Silver Dragon
        {
            raceId: dragonborn.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  15  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Draconic Ancestry (Silver)'),
                    connectFeature('Breath Weapon (Cold - Cone)')
                ]
            }
        },
        // White Dragon
        {
            raceId: dragonborn.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  15  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Draconic Ancestry (White)'),
                    connectFeature('Breath Weapon (Cold - Cone)')
                ]
            }
        },

        // ============ DRAGONBORN (CHROMATIC) ANCESTRY (FTOD) ============
        {
            raceId: dragonbornChromatic.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  5x30  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Breath Weapon (Acid - Line)'),
                    connectFeature('Draconic Ancestry (Black)')
                ]
            }
        },
        {
            raceId: dragonbornChromatic.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  5x30  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Breath Weapon (Lightning - Line)'),
                    connectFeature('Draconic Ancestry (Blue)')
                ]
            }
        },
        {
            raceId: dragonbornChromatic.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  15  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Breath Weapon (Poison - Cone)'),
                    connectFeature('Draconic Ancestry (Green)')
                ]
            }
        },
        {
            raceId: dragonbornChromatic.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  15  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Breath Weapon (Fire - Cone)'),
                    connectFeature('Draconic Ancestry (Red)')
                ]
            }
        },
        {
            raceId: dragonbornChromatic.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  15  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Breath Weapon (Cold - Cone)'),
                    connectFeature('Draconic Ancestry (White)')
                ]
            }
        },

        // ============ DRAGONBORN (METALLIC) ANCESTRY (FTOD) ============
        {
            raceId: dragonbornMetallic.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  5x30  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Breath Weapon (Fire - Line)'),
                    connectFeature('Draconic Ancestry (Brass)')
                ]
            }
        },
        {
            raceId: dragonbornMetallic.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  5x30  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Breath Weapon (Lightning - Line)'),
                    connectFeature('Draconic Ancestry (Bronze)')
                ]
            }
        },
        {
            raceId: dragonbornMetallic.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  5x30  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Breath Weapon (Acid - Line)'),
                    connectFeature('Draconic Ancestry (Copper)')
                ]
            }
        },
        {
            raceId: dragonbornMetallic.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  15  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Breath Weapon (Fire - Cone)'),
                    connectFeature('Draconic Ancestry (Gold)')
                ]
            }
        },
        {
            raceId: dragonbornMetallic.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  15  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Breath Weapon (Cold - Cone)'),
                    connectFeature('Draconic Ancestry (Silver)')
                ]
            }
        },

        // ============ DRAGONBORN (GEM) ANCESTRY (FTOD) ============
        {
            raceId: dragonbornGem.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  15  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Breath Weapon (Force - Cone)'),
                    connectFeature('Draconic Ancestry (Amethyst)')
                ]
            }
        },
        {
            raceId: dragonbornGem.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  15  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Breath Weapon (Radiant - Cone)'),
                    connectFeature('Draconic Ancestry (Crystal)')
                ]
            }
        },
        {
            raceId: dragonbornGem.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  15  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Breath Weapon (Psychic - Cone)'),
                    connectFeature('Draconic Ancestry (Emerald)')
                ]
            }
        },
        {
            raceId: dragonbornGem.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  15  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Breath Weapon (Thunder - Cone)'),
                    connectFeature('Draconic Ancestry (Sapphire)')
                ]
            }
        },
        {
            raceId: dragonbornGem.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            description: " : .   :  15  ( ).",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Breath Weapon (Necrotic - Cone)'),
                    connectFeature('Draconic Ancestry (Topaz)')
                ]
            }
        },

        // ============ HALF-ELF VERSATILITY (SCAG) ============
        // Skill Versatility ( PHB  -   )
        {
            raceId: halfElf.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            legacy: { choiceGroupName: "Half-Elf Versatility", optionName: "Skill Versatility" },
            description: "       .",
            selectMultiple: false,
            maxSelection: 1,
            skillProficiencies: {
                choiceCount: 2,
                options: ["ANY", "ANY"]
            }
        },
        // Elf Weapon Training
        {
            raceId: halfElf.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: "  ",
            legacy: { choiceGroupName: "Half-Elf Versatility", optionName: "Elf Weapon Training" },
            description: "   ,  ,     .",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Elf Weapon Training')
                ]
            }
        },
        // Cantrip (High Elf)
        {
            raceId: halfElf.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: "",
            legacy: { choiceGroupName: "Half-Elf Versatility", optionName: "Cantrip" },
            description: "          .       .",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('High Elf Cantrip')
                ]
            }
        },
        // Fleet of Foot
        {
            raceId: halfElf.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: "",
            legacy: { choiceGroupName: "Half-Elf Versatility", optionName: "Fleet of Foot" },
            description: "      35 .",
            selectMultiple: false,
            maxSelection: 1,
            modifiesSpeed: 5,
            traits: {
                create: [
                    connectFeature('Fleet of Foot')
                ]
            }
        },
        // Mask of the Wild
        {
            raceId: halfElf.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: "   ",
            legacy: { choiceGroupName: "Half-Elf Versatility", optionName: "Mask of the Wild" },
            description: "        ,   ,  , ,     .",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Mask of the Wild')
                ]
            }
        },
        // Drow Magic
        {
            raceId: halfElf.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            legacy: { choiceGroupName: "Half-Elf Versatility", optionName: "Drow Magic" },
            description: '   <a href="/spell/1350">  [Dancing Lights]</a>.    3- ,     <a href="/spell/1041">  [Faerie Fire]</a>.    5- ,      <a href="/spell/1249"> [Darkness]</a>.        .',
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Drow Magic')
                ]
            }
        },
        // Swim Speed
        {
            raceId: halfElf.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            legacy: { choiceGroupName: "Half-Elf Versatility", optionName: "Swim Speed" },
            description: "    30 .",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Child of the Sea')
                ]
            }
        },

        // ============ AASIMAR CELESTIAL REVELATION ============
        {
            raceId: aasimar.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            legacy: { choiceGroupName: " ", optionName: "Necrotic Shroud" },
            description: " :  + 110  .",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Necrotic Shroud')
                ]
            }
        },
        {
            raceId: aasimar.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            legacy: { choiceGroupName: " ", optionName: "Radiant Consumption" },
            description: " :    + 110  .",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Radiant Consumption')
                ]
            }
        },
        {
            raceId: aasimar.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            legacy: { choiceGroupName: " ", optionName: "Radiant Soul" },
            description: " :  30  + 110  .",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Radiant Soul')
                ]
            }
        },

        // ============ SHIFTER SHIFTING FORMS ============
        {
            raceId: shifter.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            legacy: { choiceGroupName: " ", optionName: "Beasthide" },
            description: " : 16+   +  +1.",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Shifting: Beasthide')
                ]
            }
        },
        {
            raceId: shifter.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            legacy: { choiceGroupName: " ", optionName: "Longtooth" },
            description: " : 16+   +  16+.",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Shifting: Longtooth')
                ]
            }
        },
        {
            raceId: shifter.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            legacy: { choiceGroupName: " ", optionName: "Swiftstride" },
            description: " : 16+   +  +10 .",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Shifting: Swiftstride')
                ]
            }
        },
        {
            raceId: shifter.raceId,
            subraceId: null,
            choiceGroupName: " ",
            optionName: " ",
            legacy: { choiceGroupName: " ", optionName: "Wildhunt" },
            description: " : 16+   +   .",
            selectMultiple: false,
            maxSelection: 1,
            traits: {
                create: [
                    connectFeature('Shifting: Wildhunt')
                ]
            }
        }
    ];

    for (const choice of choices) {
        const { traits, legacy, ...data } = choice as any;
        
        let existing = await prisma.raceChoiceOption.findFirst({
            where: {
                raceId: data.raceId,
                subraceId: data.subraceId,
                choiceGroupName: data.choiceGroupName,
                optionName: data.optionName
            }
        });

        // Backwards-compatible lookup: if an older DB has English group/option names, update that row in-place.
        if (!existing && legacy?.choiceGroupName && legacy?.optionName) {
            existing = await prisma.raceChoiceOption.findFirst({
                where: {
                    raceId: data.raceId,
                    subraceId: data.subraceId,
                    choiceGroupName: legacy.choiceGroupName,
                    optionName: legacy.optionName,
                }
            });
        }

        if (existing) {
            //     
            await prisma.raceChoiceOption.update({
                where: { optionId: existing.optionId },
                data: {
                    ...data,
                    traits: {
                        deleteMany: {},
                        create: traits?.create
                    }
                }
            });
        } else {
            //  
            await prisma.raceChoiceOption.create({
                data: {
                    ...(data as any),
                    ...(traits ? { traits } : {}),
                }
            });
        }
    }

    console.log(`  ${choices.length}    (Dragonborn, Half-Elf, Aasimar, Shifter)!`);
}
</file>

<file path="prisma/seed/subraceFeatureSeed.ts">
import { PrismaClient, FeatureDisplayType, RestType, Prisma } from "@prisma/client";
import { normalizeFeatureCreateInput, type SeedFeatureCreateInput } from "./helpers/featureDisplayType";

export const seedSubraceFeatures = async (prisma: PrismaClient) => {
    console.log('   ...')

    const features: SeedFeatureCreateInput[] = [
        // ============ ELF SUBRACE FEATURES ============

        // --- WOOD ELF ---
        {
            name: '   ',
            engName: 'Mask of the Wild',
            description: '   ,       ,  , ,     .',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '',
            engName: 'Fleet of Foot',
            description: '      35 .',
            shortDescription: ' 35 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // --- DROW ---
        {
            name: '  ()',
            engName: 'Superior Darkvision (Drow)',
            description: '    120 .',
            shortDescription: ' 120 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '   ',
            engName: 'Sunlight Sensitivity',
            description: '          (<a href="/skills/perception"> [Perception]</a>),    ,  ,     ,    ,     .',
            shortDescription: '  /  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Drow Magic',
            description: '   <a href="/spell/1350">  [Dancing Lights]</a>.    3- ,       <a href="/spell/1041">  [Faerie Fire]</a>.    5- ,        <a href="/spell/1249"> [Darkness]</a>.             ,     .       .',
            shortDescription: '  [Dancing Lights],   [Faerie Fire],  [Darkness]',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Dancing Lights' },
                    { engName: 'Faerie Fire' },
                    { engName: 'Darkness' }
                ]
            }
        },
        {
            name: '  ',
            engName: 'Drow Weapon Training',
            description: '  ,     .',
            shortDescription: ' , . , . ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // --- ELADRIN (DMG) ---
        {
            name: '  (DMG)',
            engName: 'Fey Step (DMG)',
            description: '    <a href="/spell/1247">  [Misty Step]</a>  ,   .     ,      .',
            shortDescription: '  [Misty Step]    ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1,
            givesSpells: {
                connect: [
                    { engName: 'Misty Step' }
                ]
            }
        },

        // --- SEA ELF ---
        {
            name: ' ',
            engName: 'Child of the Sea',
            description: '    30 ,       .',
            shortDescription: ' 30 , ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Friend of the Sea',
            description: '   ,     - ,     .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // --- SHADAR-KAI ---
        {
            name: '  ',
            engName: 'Necrotic Resistance',
            description: '     .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  ',
            engName: 'Blessing of the Raven Queen',
            description: '         30    ,   .       ,     ,     ,    .\\n\\n  3- ,        ,      .       .        .',
            shortDescription: ' 30  +     ( 3- )',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true
        },

        // --- PALLID ELF ---
        {
            name: ' ',
            engName: 'Incisive Sense',
            description: '      [Investigation]    [Insight].',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  ',
            engName: 'Blessing of the Moon Weaver',
            description: '   <a href="/spell/1055"> [Light]</a>.    3- ,       <a href="/spell/1310"> [Sleep]</a>.    5- ,        <a href="/spell/1276"> [Invisibility]</a>.             ,     .       .',
            shortDescription: ', , ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Light' },
                    { engName: 'Sleep' },
                    { engName: 'Invisibility' }
                ]
            }
        },

        // --- HIGH ELF EXTRA ---
        {
            name: '  ',
            engName: 'High Elf Cantrip',
            description: '          .       .',
            shortDescription: '1  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Extra Language',
            description: '  ,         .',
            shortDescription: '+1 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // ============ DWARF SUBRACE FEATURES ============

        // --- HILL DWARF ---
        {
            name: ' ',
            engName: 'Dwarven Toughness',
            description: '  -   1,     1  ,    .',
            shortDescription: '+1 HP  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // --- MOUNTAIN DWARF ---
        {
            name: '  ',
            engName: 'Dwarven Armor Training',
            description: '     .',
            shortDescription: '    ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // --- DUERGAR (GRAY DWARF) ---
        {
            name: '  ()',
            engName: 'Superior Darkvision (Duergar)',
            description: '    120 .',
            shortDescription: ' 120 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Duergar Resilience',
            description: '         ,     .',
            shortDescription: '    ,   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Duergar Magic',
            description: '   3- ,       <a href="/spell/1289">/ [Enlarge/Reduce]</a>  .    5- ,        <a href="/spell/1276"> [Invisibility]</a>  .             ,     .       .',
            shortDescription: '/   (  )',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Enlarge/Reduce' },
                    { engName: 'Invisibility' }
                ]
            }
        },

        // ============ HALFLING SUBRACE FEATURES ============

        // --- LIGHTFOOT HALFLING ---
        {
            name: ' ',
            engName: 'Naturally Stealthy',
            description: '   ,      ,        .',
            shortDescription: '    ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // --- STOUT HALFLING ---
        {
            name: ' ',
            engName: 'Stout Resilience',
            description: '           .',
            shortDescription: '     +   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // --- GHOSTWISE HALFLING ---
        {
            name: ' ',
            engName: 'Silent Speech',
            description: '     -    30   .   ,       .         .',
            shortDescription: ' 30  (  )',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // ============ GNOME SUBRACE FEATURES ============

        // --- FOREST GNOME ---
        {
            name: ' ',
            engName: 'Natural Illusionist',
            description: '   <a href="/spell/1351">  [Minor Illusion]</a>.       .',
            shortDescription: '   [Minor Illusion]',
            displayType: [FeatureDisplayType.PASSIVE],
            givesSpells: {
                connect: [
                    { engName: 'Minor Illusion' }
                ]
            }
        },
        {
            name: '   ',
            engName: 'Speak with Small Beasts',
            description: '               .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // --- ROCK GNOME ---
        {
            name: ' ',
            engName: 'Artificer\'s Lore',
            description: '     ( [History]), \'   ,  \'   ,        -  ,    .',
            shortDescription: '     / ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '-',
            engName: 'Tinker',
            description: '    ( ).   ,    1      10 ,      ( 5).     24  (    1    )      ,   ;        .         .    ,     :  , ,  .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // --- DEEP GNOME (SVIRFNEBLIN) ---
        {
            name: '  ( )',
            engName: 'Superior Darkvision (Deep Gnome)',
            description: '    120 .',
            shortDescription: ' 120 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '\' ',
            engName: 'Stone Camouflage',
            description: '      ( [Stealth]),    \' .',
            shortDescription: '    \' ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // ============ DRAGONBORN (FIZBAN'S) SUBRACE FEATURES ============

        // --- CHROMATIC DRAGONBORN ---
        {
            name: ' ',
            engName: 'Chromatic Warding',
            description: '  5- ,        ,     ,    .    10      ,     .        , , ,     (       ).          ,     .',
            shortDescription: '  (    )',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },

        // --- METALLIC DRAGONBORN ---
        {
            name: ' ',
            engName: 'Metallic Breath Weapon',
            description: ' 5-       .     Breath Weapon,      Breath Weapon,       15 .          ( = 8 +    +   ).         .',
            shortDescription: '  ( 15 )',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.SHORT_REST
        },

        // --- GEM DRAGONBORN ---
        {
            name: ' ',
            engName: 'Psionic Mind',
            description: '     - ,      30   .       ,       .',
            shortDescription: ' 30 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Gem Flight',
            description: '  5- ,     ,     ,      30 .    1 .          ,     .',
            shortDescription: '  30  (1 )',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        }
    ];

    for (const feature of features) {
        try {
            const normalized = normalizeFeatureCreateInput(feature);
            await prisma.feature.upsert({
                where: { engName: normalized.engName },
                update: normalized,
                create: normalized,
            });
        } catch (error) {
            console.error('    :', feature.name);
            console.error(' Feature :', JSON.stringify(feature, null, 2));
            console.error(' Error:', error);

            if (error instanceof Prisma.PrismaClientKnownRequestError) {
                console.error(' Prisma Error Code:', error.code);
                console.error(' Meta:', error.meta);

                if (error.code === 'P2025') {
                    console.error('   record(s)  connect:', error.meta?.cause);
                }
            }
        }
    }

    console.log(`  ${features.length}  !`)
}
</file>

<file path="src/components/level-up/StepRenderer.tsx">
'use client';

import React from 'react';
import { useCharacterStore } from '@/store/character-store';
import { cn } from '@/lib/utils';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Label } from '@/components/ui/label';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ScrollArea } from '@/components/ui/scroll-area';
import { 
  SelectSubclassStep, 
  SelectFeatOrASIStep, 
  AddHPStep, 
  ChooseOptionalFeatureStep,
  LevelUpStep,
  LevelUpChoice
} from '@/types/character-flow';
import { translateValue } from '@/lib/components/characterCreator/infoUtils';
import { FormattedDescription } from '@/components/ui/FormattedDescription';
import { InfoDialog, InfoSectionTitle } from "@/lib/components/characterCreator/EntityInfoDialog";
import { subclassTranslations } from '@/lib/refs/translation';

// 
// INDIVIDUAL STEP RENDERERS
// 

/**
 * 1 SELECT_SUBCLASS Renderer
 */
const SubclassSelectionGrid: React.FC<{ step: SelectSubclassStep }> = ({ step }) => {
  const addChoice = useCharacterStore((s) => s.addChoice);
  const choices = useCharacterStore((s) => s.choices);

  const selectedId = (choices.find((c) => c.stepType === 'SELECT_SUBCLASS') as LevelUpChoice)?.subclassId;

  return (
    <div className="space-y-4">
      <div className="mb-6">
        <h3 className="text-lg font-semibold text-foreground">
          {translateValue(step.className)}   
        </h3>
        <p className="text-sm text-muted-foreground">
           {step.level}-    ,    .
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {step.options.map((subclass) => {
          const sName = subclassTranslations[subclass.name as keyof typeof subclassTranslations] || subclass.name;
          return (
            <div key={subclass.id} className="relative group/card">
              <Card 
                className={`cursor-pointer transition-all border-2 backdrop-blur-xl bg-white/5 border-white/10 ${
                  selectedId === subclass.id ? 'border-primary ring-1 ring-primary/30 bg-primary/10' : 'hover:bg-white/10 hover:border-white/20'
                }`}
                onClick={() => addChoice({ stepType: 'SELECT_SUBCLASS', subclassId: subclass.id })}
              >
                <CardHeader>
                  <CardTitle className="text-lg font-semibold text-slate-100">{sName}</CardTitle>
                </CardHeader>
                <CardContent>
                  <FormattedDescription
                    content={String(subclass.description || '')}
                    className="text-sm text-slate-400 line-clamp-3"
                  />
                </CardContent>
              </Card>
              
              <InfoDialog title={sName} triggerLabel=" ">
                  <InfoSectionTitle></InfoSectionTitle>
                  <FormattedDescription content={String(subclass.description || '')} className="text-sm text-slate-300" />
              </InfoDialog>
            </div>
          );
        })}
      </div>
    </div>
  );
};

/**
 * 2 SELECT_FEAT_OR_ASI Renderer
 */
const FeatAsiTabs: React.FC<{ step: SelectFeatOrASIStep }> = () => {
    const addChoice = useCharacterStore((s) => s.addChoice);
    // Simplified for brevity
    return (
        <div className="space-y-4">
            <h3 className="text-lg font-semibold">   </h3>
            <Tabs defaultValue="asi">
                <TabsList className="grid w-full grid-cols-2">
                    <TabsTrigger value="asi"> (+2)</TabsTrigger>
                    <TabsTrigger value="feat"> (Feat)</TabsTrigger>
                </TabsList>
                <TabsContent value="asi" className="p-4 border rounded-md">
                    <p className="text-sm text-muted-foreground mb-4">
                            +2    +1.
                    </p>
                    {/* ASI Logic would go here */}
                    <Button onClick={() => addChoice({ stepType: 'SELECT_FEAT_OR_ASI', type: 'ASI', stats: { STR: 2 } })}>
                         +2   ()
                    </Button>
                </TabsContent>
                <TabsContent value="feat" className="p-4 border rounded-md">
                    <p>   .</p>
                </TabsContent>
            </Tabs>
        </div>
    );
};

/**
 * 3 ADD_HP Renderer
 */
const HpRoller: React.FC<{ step: AddHPStep }> = ({ step }) => {
    const addChoice = useCharacterStore((s) => s.addChoice);
    const choices = useCharacterStore((s) => s.choices);
    const choice = choices.find(c => c.stepType === 'ADD_HP') as LevelUpChoice;

    const fixedHp = Math.floor(step.hitDie / 2) + 1;

    return (
        <div className="space-y-6 max-w-md mx-auto">
            <div className="text-center">
                <h3 className="text-xl font-bold mb-2">&apos; (HP)</h3>
                <p className="text-muted-foreground">
                     : d{step.hitDie}
                </p>
            </div>

            <RadioGroup 
                defaultValue="fixed" 
                onValueChange={(val) => {
                    const value = val === 'fixed' ? fixedHp : Math.floor(Math.random() * step.hitDie) + 1; // Mock roll
                    addChoice({ stepType: 'ADD_HP', value, method: val as 'fixed' | 'roll' });
                }}
            >
                <div className="flex items-center space-x-2 border p-4 rounded-lg cursor-pointer hover:bg-accent">
                    <RadioGroupItem value="fixed" id="fixed" />
                    <Label htmlFor="fixed" className="flex-1 cursor-pointer">
                        <span className="font-bold block"> : {fixedHp}</span>
                        <span className="text-xs text-muted-foreground"> </span>
                    </Label>
                </div>
                <div className="flex items-center space-x-2 border p-4 rounded-lg cursor-pointer hover:bg-accent">
                    <RadioGroupItem value="roll" id="roll" />
                    <Label htmlFor="roll" className="flex-1 cursor-pointer">
                        <span className="font-bold block">  (d{step.hitDie})</span>
                        <span className="text-xs text-muted-foreground">!</span>
                    </Label>
                </div>
            </RadioGroup>
            
            {choice && (
                <div className="text-center p-4 bg-primary/10 rounded-lg animate-in fade-in">
                    <span className="text-2xl font-bold text-primary">+{choice.value} HP</span>
                </div>
            )}
        </div>
    );
};

/**
 * 4 CHOOSE_OPTIONAL_FEATURE Renderer (Fighting Styles etc)
 */
const OptionalFeatureGrid: React.FC<{ step: ChooseOptionalFeatureStep }> = ({ step }) => {
    const addChoice = useCharacterStore((s) => s.addChoice);
    const choices = useCharacterStore((s) => s.choices);
    const selectedId = (choices.find((c) => c.stepType === 'CHOOSE_OPTIONAL_FEATURE' && c.featureId === step.featureId) as LevelUpChoice)?.selectedOptionId;

    return (
        <div className="space-y-4">
             <div className="mb-6">
                <h3 className="text-lg font-semibold">{step.title}</h3>
                <FormattedDescription
                  content={String(step.description || '')}
                  className="text-sm text-muted-foreground"
                />
            </div>
            <ScrollArea className="h-[400px] pr-4">
                <div className="grid grid-cols-1 gap-3">
                    {step.options.map((opt) => (
                        <Card 
                            key={opt.id}
                            className={cn(
                                "cursor-pointer transition-all border-2 backdrop-blur-xl bg-white/5 border-white/10",
                                selectedId === opt.id ? 'border-primary ring-1 ring-primary/30 bg-primary/10' : 'hover:bg-white/10 hover:border-white/20'
                            )}
                            onClick={() => addChoice({ stepType: 'CHOOSE_OPTIONAL_FEATURE', featureId: step.featureId, selectedOptionId: opt.id })}
                        >
                            <CardHeader className="p-4">
                                <CardTitle className="text-base text-slate-100">{opt.name}</CardTitle>
                            </CardHeader>
                            <CardContent className="p-4 pt-0">
                              <FormattedDescription
                                content={String(opt.description || '')}
                                className="text-sm text-slate-400"
                              />
                            </CardContent>
                        </Card>
                    ))}
                </div>
            </ScrollArea>
        </div>
    );
}


// 
// MAIN RENDERER SWITCH
// 

export const StepRenderer: React.FC<{ step: LevelUpStep }> = ({ step }) => {
  switch (step.type) {
    case 'SELECT_SUBCLASS':
      return <SubclassSelectionGrid step={step} />;
    
    case 'SELECT_FEAT_OR_ASI':
      return <FeatAsiTabs step={step} />;

    case 'ADD_HP':
      return <HpRoller step={step} />;
      
    case 'CHOOSE_OPTIONAL_FEATURE':
        return <OptionalFeatureGrid step={step} />;

    default:
      return (
        <div className="p-4 border border-dashed rounded-lg text-center text-muted-foreground">
            : {(step as LevelUpStep).type}
        </div>
      );
  }
};
</file>

<file path="src/domain/pers/Pers.ts">
import { Ability, Skills as Skill } from "@prisma/client";
import { AbilityScores } from "./AbilityScores";
import { HitPoints } from "./HitPoints";
import { Money } from "./Money";
import { PersClass } from "./PersClass";
import { Race } from "./Race";
import { Background } from "./Background";
import { AbilitySchema } from "./CreatePersInput.schema";
import { CharacterNotes } from "./CharacterNotes";

export class Pers {
  constructor(
    readonly persId: number,
    readonly userId: number,

    private name: string,
    private level: number,

    private race: Race,
    private persClass: PersClass,
    private background: Background,

    private abilityScores: AbilityScores,
    private hitPoints: HitPoints,
    private money: Money,

    private skills: Skill[],

    private additionalSaveProficiencies: Ability[],

    private equipment: any,

    private notes: CharacterNotes,

    readonly createdAt: Date,
    private updatedAt: Date,

    private miscSaveBonuses?: Record<AbilitySchema, number>,
  ) {
    if (level < 1) {
      throw new Error("Character level must be >= 1");
    }
  }

  /* ======  ====== */

  levelUp() {
    this.level += 1;
    this.updatedAt = new Date();
  }

  rename(newName: string) {
    if (!newName.trim()) {
      throw new Error("Name cannot be empty");
    }
    this.name = newName;
  }

  getSnapshot() {
    return {
      name: this.name,
      level: this.level,
      race: this.race,
      class: this.persClass,
    };
  }
}
</file>

<file path="src/domain/pers/PersFactory.ts">
import { CreatePersInput } from "./CreatePersInput.schema";
import { Pers } from "./Pers";

export class PersFactory {
    static create(_input: CreatePersInput): Pers {
        return null as any;
    }
}
</file>

<file path="src/lib/actions/character.ts">
"use server";

import { prisma } from "@/lib/prisma";
import { fullCharacterSchema, PersFormData } from "@/lib/zod/schemas/persCreateSchema";
import { auth } from "@/lib/auth";
import { SkillProficiencyType, Skills } from "@prisma/client";
import { revalidatePath } from "next/cache";

type UnknownRecord = Record<string, unknown>;

function isRecord(value: unknown): value is UnknownRecord {
  return typeof value === "object" && value !== null && !Array.isArray(value);
}

function getChildRecord(value: unknown, key: string): UnknownRecord | null {
  if (!isRecord(value)) return null;
  const child = value[key];
  return isRecord(child) ? child : null;
}

function getSimpleBonuses(asi: unknown): Record<string, number> {
  const basic = getChildRecord(asi, "basic");
  const simple = getChildRecord(basic, "simple");
  if (!simple) return {};

  const out: Record<string, number> = {};
  for (const [ability, rawBonus] of Object.entries(simple)) {
    const bonus =
      typeof rawBonus === "number"
        ? rawBonus
        : typeof rawBonus === "string"
          ? Number(rawBonus)
          : NaN;
    if (Number.isFinite(bonus)) out[ability] = bonus;
  }
  return out;
}

export async function createCharacter(data: PersFormData) {
  const session = await auth();

  if (!session || !session.user || !session.user.email) {
    return { error: "Unauthorized" };
  }

  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
  });

  if (!user) {
    return { error: "User not found" };
  }

  const validation = fullCharacterSchema.safeParse(data);

  if (!validation.success) {
    return { error: "Validation failed", details: validation.error.flatten() };
  }

  const validData = validation.data;

  // Calculate Ability Scores
  const scores: Record<string, number> = {
    STR: 10, DEX: 10, CON: 10, INT: 10, WIS: 10, CHA: 10
  };

  if (validData.asiSystem === 'POINT_BUY') {
    validData.asi.forEach(s => scores[s.ability] = s.value);
  } else if (validData.asiSystem === 'SIMPLE') {
    validData.simpleAsi.forEach(s => scores[s.ability] = s.value);
  } else if (validData.asiSystem === 'CUSTOM' && validData.customAsi) {
    validData.customAsi.forEach(s => scores[s.ability] = Number(s.value));
  }

  // Apply Racial Bonuses if needed (This logic might be complex depending on how the form sends data)
  // The form seems to handle the final calculation or at least the base assignment.
  // However, usually the form sends the *base* score and the *bonuses* separately or combined.
  // Looking at the schema, `asi` seems to be the base scores from the calculator.
  // Racial bonuses might need to be added if they are not already included.
  // BUT, for now, let's assume the user sees the final score or the form handles it.
  // Wait, `asiSchema` has `racialBonusChoiceSchema`. This implies bonuses are separate.
  
  // Let's fetch the race to be sure about fixed bonuses.
  const race = await prisma.race.findUnique({ where: { raceId: validData.raceId } });
  if (!race) return { error: "Race not found" };

  let effectiveASI: unknown = race.ASI;

  if (validData.raceVariantId) {
      const variant = await prisma.raceVariant.findUnique({ where: { raceVariantId: validData.raceVariantId } });
      if (variant && variant.overridesRaceASI) {
          effectiveASI = variant.overridesRaceASI;
      }
  }

  // Apply fixed racial bonuses
  {
    const bonuses = getSimpleBonuses(effectiveASI);
    Object.entries(bonuses).forEach(([ability, bonus]) => {
      if (scores[ability]) scores[ability] += bonus;
    });
  }

  // Apply chosen racial bonuses
  if (validData.racialBonusChoiceSchema) {
      const choices = validData.isDefaultASI 
          ? validData.racialBonusChoiceSchema.basicChoices 
          : validData.racialBonusChoiceSchema.tashaChoices;
      
      choices?.forEach(choice => {
          choice.selectedAbilities.forEach(ability => {
             if (scores[ability]) scores[ability] += 1; // Usually +1
          });
      });
  }
  
  // Apply Subrace bonuses
  if (validData.subraceId) {
      const subrace = await prisma.subrace.findUnique({ where: { subraceId: validData.subraceId } });
      if (subrace) {
          const bonuses = getSimpleBonuses(subrace.additionalASI);
          Object.entries(bonuses).forEach(([ability, bonus]) => {
            if (scores[ability]) scores[ability] += bonus;
          });
          // Subrace choices? Usually subraces have fixed bonuses, but some might have choices.
          // The schema handles choices generically.
      }
  }
  
  // Apply Feat bonuses (if any)
  if (validData.featId) {
      const feat = await prisma.feat.findUnique({ where: { featId: validData.featId } });
      if (feat) {
          const bonuses = getSimpleBonuses(feat.grantedASI);
          Object.entries(bonuses).forEach(([ability, bonus]) => {
            if (scores[ability]) scores[ability] += bonus;
          });
      }
  }

  // Prepare Skills
  const allSkills = new Set<string>(validData.skills);

  // From Schema
  if (validData.skillsSchema) {
      if (validData.skillsSchema.isTasha) {
          validData.skillsSchema.tashaChoices.forEach(s => allSkills.add(s));
      } else {
          validData.skillsSchema.basicChoices.race.forEach(s => allSkills.add(s));
          validData.skillsSchema.basicChoices.selectedClass.forEach(s => allSkills.add(s));
      }
  }

  // From Race (Fixed)
  if (race && race.skillProficiencies && Array.isArray(race.skillProficiencies)) {
      (race.skillProficiencies as string[]).forEach(s => allSkills.add(s));
  }
  
  // From Background (Fixed)
  const background = await prisma.background.findUnique({ where: { backgroundId: validData.backgroundId } });
  if (background && background.skillProficiencies && Array.isArray(background.skillProficiencies)) {
      (background.skillProficiencies as string[]).forEach(s => allSkills.add(s));
  }

  // From Feat (if selected) - now processed AFTER base skills
  if (validData.featId) {
    const feat = await prisma.feat.findUnique({ 
      where: { featId: validData.featId },
      include: { 
        featChoiceOptions: { 
          include: { choiceOption: true } 
        } 
      }
    });
    
    if (feat) {
      // Direct skill grants from feat
      if (feat.grantedSkills && Array.isArray(feat.grantedSkills)) {
        (feat.grantedSkills as string[]).forEach(s => allSkills.add(s));
      }
      
      // Skills from feat choice options (e.g., Skill Expert)
      if (validData.featChoiceSelections) {
        for (const choiceOptionId of Object.values(validData.featChoiceSelections)) {
          const featChoice = feat.featChoiceOptions?.find(
            fco => fco.choiceOptionId === Number(choiceOptionId)
          );
          
          if (featChoice?.choiceOption) {
            // Check if this choice option grants a skill
            // The groupName might contain "Skill Proficiency" or similar
            const option = featChoice.choiceOption;
            
            // If the choice option has a direct skill reference
            if (option.optionName && Object.values(Skills).includes(option.optionName as Skills)) {
              allSkills.add(option.optionName);
            }
          }
        }
      }
    }
  }

  // 1. Prepare Features
  const featuresToConnect: { featureId: number }[] = [];
  
  const classFeatures = await prisma.classFeature.findMany({
    where: { classId: validData.classId, levelGranted: 1 },
    select: { featureId: true }
  });
  featuresToConnect.push(...classFeatures.map(f => ({ featureId: f.featureId })));

  const raceFeatures = await prisma.raceTrait.findMany({
    where: { raceId: validData.raceId },
    select: { featureId: true }
  });
  featuresToConnect.push(...raceFeatures.map(f => ({ featureId: f.featureId })));

  if (validData.subraceId) {
    const subraceFeatures = await prisma.subraceTrait.findMany({
      where: { subraceId: validData.subraceId },
      select: { featureId: true }
    });
    featuresToConnect.push(...subraceFeatures.map(f => ({ featureId: f.featureId })));
  }

  if (validData.subclassId) {
    const subclassFeatures = await prisma.subclassFeature.findMany({
      where: { subclassId: validData.subclassId, levelGranted: 1 },
      select: { featureId: true }
    });
    featuresToConnect.push(...subclassFeatures.map(f => ({ featureId: f.featureId })));
  }

  // Deduplicate feature ids (PersFeature has @@unique([persId, featureId]))
  const uniqueFeatureIds = Array.from(
    new Set(featuresToConnect.map((f) => f.featureId))
  ).filter((id) => Number.isFinite(id));

  // 2. Prepare Equipment
  const weaponsToCreate: { weaponId: number }[] = [];
  const armorsToCreate: { armorId: number }[] = [];
  const customEquipmentLines: string[] = [];

  if (validData.equipmentSchema) {
      const { choiceGroupToId, anyWeaponSelection } = validData.equipmentSchema;

      // Choice Groups
      for (const ids of Object.values(choiceGroupToId)) {
          for (const id of ids) {
              const opt = await prisma.classStartingEquipmentOption.findUnique({
                  where: { optionId: id },
                    include: { equipmentPack: true }
              });
              if (opt) {
                  if (opt.weaponId) weaponsToCreate.push({ weaponId: opt.weaponId });
                  if (opt.armorId) armorsToCreate.push({ armorId: opt.armorId });
                  if (opt.equipmentPack && Array.isArray(opt.equipmentPack.items)) {
                      for (const item of opt.equipmentPack.items as unknown[]) {
                        if (!isRecord(item)) continue;
                        const name = typeof item.name === "string" ? item.name : null;
                        const quantity =
                          typeof item.quantity === "number"
                            ? item.quantity
                            : typeof item.quantity === "string"
                              ? Number(item.quantity)
                              : NaN;

                        if (name && Number.isFinite(quantity)) {
                          customEquipmentLines.push(`${name} x${quantity}`);
                        }
                      }
                  }
              }
          }
      }

      // Any Weapon
      for (const ids of Object.values(anyWeaponSelection)) {
          ids.forEach(id => weaponsToCreate.push({ weaponId: id }));
      }
  }

  // 3. Prepare Choices
  const choiceOptionsToConnect: { choiceOptionId: number }[] = [];
  
  Object.values(validData.classChoiceSelections).forEach(id => choiceOptionsToConnect.push({ choiceOptionId: id }));
  Object.values(validData.subclassChoiceSelections).forEach(id => choiceOptionsToConnect.push({ choiceOptionId: id }));

  // Avoid duplicates when connecting many-to-many choice options
  const uniqueChoiceOptionsToConnect = Array.from(
    new Map(choiceOptionsToConnect.map((c) => [c.choiceOptionId, c])).values()
  ).filter((c) => Number.isFinite(c.choiceOptionId) && c.choiceOptionId > 0);

  const raceChoiceOptionIds = Array.from(
    new Set(
      Object.values(validData.raceChoiceSelections ?? {})
        .map((id) => Number(id))
        .filter((id) => Number.isFinite(id) && id > 0)
    )
  );


  try {
    const newPers = await prisma.$transaction(async (tx) => {
      const createdPers = await tx.pers.create({
        data: {
          userId: user.id,
          name: validData.name,
          raceId: validData.raceId,
          subraceId: validData.subraceId,
          classId: validData.classId,
          subclassId: validData.subclassId,
          backgroundId: validData.backgroundId,

          str: scores.STR,
          dex: scores.DEX,
          con: scores.CON,
          int: scores.INT,
          wis: scores.WIS,
          cha: scores.CHA,

          // Placeholder, updated below once we know class hit die
          currentHp: 10,
          maxHp: 10,

          customEquipment: customEquipmentLines.join("\n"),

          raceVariants: validData.raceVariantId
            ? {
                connect: { raceVariantId: validData.raceVariantId },
              }
            : undefined,

          raceChoiceOptions:
            raceChoiceOptionIds.length > 0
              ? {
                  connect: raceChoiceOptionIds.map((optionId) => ({ optionId })),
                }
              : undefined,

          features:
            uniqueFeatureIds.length > 0
              ? {
                  createMany: {
                    data: uniqueFeatureIds.map((featureId) => ({ featureId })),
                    skipDuplicates: true,
                  },
                }
              : undefined,
          choiceOptions:
            uniqueChoiceOptionsToConnect.length > 0
              ? {
                  connect: uniqueChoiceOptionsToConnect,
                }
              : undefined,
        },
      });

      // Save Feat + Feat choices AFTER Pers exists
      if (validData.featId) {
        const persFeat = await tx.persFeat.create({
          data: {
            persId: createdPers.persId,
            featId: validData.featId,
          },
        });

        const entries = Object.entries(validData.featChoiceSelections ?? {});
        if (entries.length > 0) {
          await tx.persFeatChoice.createMany({
            data: entries
              .map(([, choiceOptionId]) => Number(choiceOptionId))
              .filter((choiceOptionId) => Number.isFinite(choiceOptionId) && choiceOptionId > 0)
              .map((choiceOptionId) => ({
                persFeatId: persFeat.persFeatId,
                choiceOptionId,
              })),
            skipDuplicates: true,
          });
        }
      }

      // Save skills AFTER Pers exists (createMany + skipDuplicates)
      const skillRows = Array.from(allSkills)
        .filter((skillName) => Object.values(Skills).includes(skillName as Skills))
        .map((skillName) => {
          const skillEnum = skillName as Skills;
          const skillIndex = Object.values(Skills).indexOf(skillEnum);
          return {
            persId: createdPers.persId,
            name: skillEnum,
            skillId: skillIndex + 1,
            proficiencyType: SkillProficiencyType.PROFICIENT,
          };
        })
        .filter((row) => row.skillId > 0);

      if (skillRows.length > 0) {
        await tx.persSkill.createMany({
          data: skillRows,
          skipDuplicates: true,
        });
      }

      // Update expertise skills (upsert so it's safe even if missing)
      const expertiseSkills = validData.expertiseSchema?.expertises ?? [];
      for (const skillEnum of expertiseSkills) {
        const skillIndex = Object.values(Skills).indexOf(skillEnum);
        await tx.persSkill.upsert({
          where: {
            persId_name: {
              persId: createdPers.persId,
              name: skillEnum,
            },
          },
          update: {
            proficiencyType: SkillProficiencyType.EXPERTISE,
          },
          create: {
            persId: createdPers.persId,
            name: skillEnum,
            skillId: skillIndex + 1,
            proficiencyType: SkillProficiencyType.EXPERTISE,
          },
        });
      }

      // Save weapons AFTER Pers exists
      if (weaponsToCreate.length > 0) {
        await tx.persWeapon.createMany({
          data: weaponsToCreate.map((w) => ({
            persId: createdPers.persId,
            weaponId: w.weaponId,
          })),
          skipDuplicates: true,
        });
      }

      // Save armors AFTER Pers exists
      if (armorsToCreate.length > 0) {
        await tx.persArmor.createMany({
          data: armorsToCreate.map((a) => ({
            persId: createdPers.persId,
            armorId: a.armorId,
            equipped: false,
          })),
          skipDuplicates: true,
        });
      }

      // Update HP based on Class and CON mod
      const cls = await tx.class.findUnique({ where: { classId: validData.classId } });
      if (cls) {
        const conMod = Math.floor((scores.CON - 10) / 2);
        const hitDie = cls.hitDie;
        const maxHp = hitDie + conMod;
        await tx.pers.update({
          where: { persId: createdPers.persId },
          data: {
            maxHp,
            currentHp: maxHp,
          },
        });
      }

      return createdPers;
    });

    revalidatePath("/pers");
    return { success: true, persId: newPers.persId };
  } catch (error) {
    console.error("Error creating character:", error);
    return { error: "Database error" };
  }
}
</file>

<file path="src/lib/actions/pers.ts">
"use server";

import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { FeatureDisplayType, RestType } from "@prisma/client";

export async function getUserPerses() {
  const session = await auth();
  if (!session?.user?.email) {
    return [];
  }

  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
  });

  if (!user) return [];

  return prisma.pers.findMany({
    where: { 
      userId: user.id,
      OR: [
        { isSnapshot: false },
        { isSnapshot: true, isActive: true }
      ]
    },
    include: {
      race: true,
      class: true,
      background: true,
    },
    orderBy: { updatedAt: 'desc' }
  });
}

export async function getUserPersesSpellIndex() {
    const session = await auth();
    if (!session?.user?.email) {
        return [];
    }

    const user = await prisma.user.findUnique({
        where: { email: session.user.email },
    });

    if (!user) return [];

    const perses = await prisma.pers.findMany({
        where: { userId: user.id },
        select: {
            persId: true,
            name: true,
            persSpells: {
                select: {
                    spellId: true,
                },
            },
        },
        orderBy: { updatedAt: "desc" },
    });

    return perses.map((p) => ({
        persId: p.persId,
        name: p.name,
        spellIds: p.persSpells.map((s) => s.spellId),
    }));
}

export async function getPersById(id: number) {
    const session = await auth();
    if (!session?.user?.email) return null;

    const pers = await prisma.pers.findUnique({
        where: { persId: id },
        include: {
            race: {
                include: {
                    traits: {
                        include: {
                            feature: true
                        }
                    }
                }
            },
            subrace: {
                include: {
                    traits: {
                        include: {
                            feature: true
                        }
                    }
                }
            },
            class: {
                include: {
                    features: {
                        include: {
                            feature: true
                        }
                    }
                }
            },
            subclass: {
                include: {
                    features: {
                        include: {
                            feature: true
                        }
                    }
                }
            },
            multiclasses: {
                include: {
                    class: {
                        include: {
                            features: {
                                include: {
                                    feature: true,
                                },
                            },
                        },
                    },
                    subclass: {
                        include: {
                            features: {
                                include: {
                                    feature: true,
                                },
                            },
                        },
                    },
                },
            },
            background: true,
            skills: true,
            feats: { 
                include: { 
                    feat: true,
                    choices: {
                        include: {
                            choiceOption: true,
                        }
                    }
                } 
            },
            raceVariants: {
                include: {
                    traits: {
                        include: {
                            feature: true,
                        },
                    },
                },
            },
            features: { include: { feature: true } },
            choiceOptions: true,
            raceChoiceOptions: true,
            spells: true,
            persSpells: {
                include: {
                    spell: true,
                },
                orderBy: [
                    { spell: { level: "asc" } },
                    { spell: { name: "asc" } },
                ],
            },
            weapons: { include: { weapon: true } },
            armors: { include: { armor: true } },
            user: true,
        }
    });
    
    if (!pers) return null;

    // Check ownership
    const user = await prisma.user.findUnique({ where: { email: session.user.email } });
    if (pers.userId !== user?.id) {
        // Allow viewing if we decide to share, but for now restrict
        // return null; 
        // Actually, for debugging/demo, let's allow it if it's just a fetch, 
        // but strictly speaking we should restrict.
        // The user asked for "current user's perses", so let's enforce ownership for the sheet too.
        if (pers.userId !== user?.id) return null;
    }

    return pers;
}

export type PersWithRelations = NonNullable<Awaited<ReturnType<typeof getPersById>>>;
export type PersWeaponWithWeapon = PersWithRelations['weapons'][number];
export type PersArmorWithArmor = PersWithRelations['armors'][number];

export type FeatureSource = "CLASS" | "SUBCLASS" | "RACE" | "SUBRACE" | "BACKGROUND" | "FEAT" | "PERS" | "CHOICE" | "RACE_CHOICE";

export type CharacterFeatureGroupKey = "passive" | "actions" | "bonusActions" | "reactions";

export interface CharacterFeatureItem {
    key: string;
    featureId?: number;
    name: string;
    shortDescription?: string | null;
    description: string;
    displayTypes: FeatureDisplayType[];
    primaryType: FeatureDisplayType;
    source: FeatureSource;
    sourceName: string;
    usesRemaining?: number | null;
    usesPer?: number | null;
    restType?: RestType | null;
}

export type CharacterFeaturesGroupedResult = Record<CharacterFeatureGroupKey, CharacterFeatureItem[]>;

function normalizeDisplayTypes(input: unknown): FeatureDisplayType[] {
    if (Array.isArray(input)) {
        const values = input.filter(Boolean) as FeatureDisplayType[];
        return values.length > 0 ? values : [FeatureDisplayType.PASSIVE];
    }
    if (typeof input === "string" && input.length > 0) {
        return [input as FeatureDisplayType];
    }
    return [FeatureDisplayType.PASSIVE];
}

function getPrimaryDisplayType(displayTypes: FeatureDisplayType[]): FeatureDisplayType {
    const normalized = normalizeDisplayTypes(displayTypes);
    // Priority: ACTION > BONUSACTION > REACTION > PASSIVE
    if (normalized.includes(FeatureDisplayType.ACTION)) return FeatureDisplayType.ACTION;
    if (normalized.includes(FeatureDisplayType.BONUSACTION)) return FeatureDisplayType.BONUSACTION;
    if (normalized.includes(FeatureDisplayType.REACTION)) return FeatureDisplayType.REACTION;
    return FeatureDisplayType.PASSIVE;
}

function toPrimaryGroupKey(primaryType: FeatureDisplayType): CharacterFeatureGroupKey {
    switch (primaryType) {
        case FeatureDisplayType.ACTION:
            return "actions";
        case FeatureDisplayType.BONUSACTION:
            return "bonusActions";
        case FeatureDisplayType.REACTION:
            return "reactions";
        default:
            return "passive";
    }
}

export async function getCharacterFeaturesGrouped(persId: number): Promise<CharacterFeaturesGroupedResult | null> {
    const session = await auth();
    if (!session?.user?.email) return null;

    const user = await prisma.user.findUnique({
        where: { email: session.user.email },
    });
    if (!user) return null;

    const pers = await prisma.pers.findUnique({
        where: { persId },
        include: {
            features: { include: { feature: true } },
            feats: {
                include: {
                    feat: true,
                    choices: {
                        include: {
                            choiceOption: true,
                        },
                    },
                },
            },
            choiceOptions: true,
            raceChoiceOptions: true,
            user: true,
        },
    });

    if (!pers) return null;
    if (pers.userId !== user.id) return null;

    const buckets: CharacterFeaturesGroupedResult = {
        passive: [],
        actions: [],
        bonusActions: [],
        reactions: [],
    };

    const proficiencyBonus = (level: number) => {
        if (!Number.isFinite(level) || level <= 0) return 2;
        return 2 + Math.floor((level - 1) / 4);
    };

    const push = (item: Omit<CharacterFeatureItem, "primaryType" | "displayTypes"> & { displayTypes: FeatureDisplayType[] }) => {
        const displayTypes = normalizeDisplayTypes(item.displayTypes);
        const primaryType = getPrimaryDisplayType(displayTypes);
        const key = toPrimaryGroupKey(primaryType);
        buckets[key].push({
            ...item,
            displayTypes,
            primaryType,
        });
    };

    // 1) Explicit pers_feature (usually level-up granted)
    for (const pf of pers.features) {
        const f = pf.feature;

        const usesPer = (() => {
            if (f.usesCountDependsOnProficiencyBonus) return proficiencyBonus(pers.level);
            if (typeof f.usesCount === "number") return f.usesCount;
            return null;
        })();

        push({
            key: `PERS:feature:${f.featureId}`,
            featureId: f.featureId,
            name: f.name,
            shortDescription: f.shortDescription ?? null,
            description: f.description,
            displayTypes: normalizeDisplayTypes(f.displayType),
            source: "PERS",
            sourceName: f.name,
            usesRemaining: pf.usesRemaining ?? null,
            usesPer,
            restType: f.limitedUsesPer ?? null,
        });
    }

    // 2) Choice options stored directly on pers
    for (const co of pers.choiceOptions ?? []) {
        const sourceName = co.groupName;
        push({
            key: `CHOICE:${co.groupName}:option:${co.choiceOptionId}`,
            name: co.optionName,
            description: `${co.groupName}: ${co.optionName}`,
            displayTypes: [FeatureDisplayType.PASSIVE],
            source: "CHOICE",
            sourceName,
        });
    }
    for (const rco of pers.raceChoiceOptions ?? []) {
        const sourceName = rco.choiceGroupName;
        push({
            key: `RACE_CHOICE:${rco.choiceGroupName}:option:${rco.optionId}`,
            name: rco.optionName,
            description: rco.description || `${rco.choiceGroupName}: ${rco.optionName}`,
            displayTypes: [FeatureDisplayType.PASSIVE],
            source: "RACE_CHOICE",
            sourceName,
        });
    }

    // 3) Feats + their selected feat choice options
    for (const pf of pers.feats ?? []) {
        const featName = pf.feat.name;
        const displayTypes = [FeatureDisplayType.PASSIVE];

        // If a feat has no explicit choices, still show it as a single item
        if (!pf.choices || pf.choices.length === 0) {
            push({
                key: `FEAT:${pf.featId}`,
                name: featName,
                description: pf.feat.description,
                displayTypes,
                source: "FEAT",
                sourceName: featName,
            });
            continue;
        }

        for (const choice of pf.choices) {
            if (!choice.choiceOption) continue;
            push({
                key: `FEAT:${pf.featId}:choice:${choice.choiceOptionId}`,
                name: choice.choiceOption.optionName,
                description: `${choice.choiceOption.groupName}: ${choice.choiceOption.optionName}`,
                displayTypes,
                source: "FEAT",
                sourceName: featName,
            });
        }
    }

    return buckets;
}
</file>

<file path="src/lib/components/auth/GoogleOneTap.tsx">
"use client";

import { signIn, useSession } from "next-auth/react";
import { useCallback, useEffect, useRef, useState } from "react";
import Script from "next/script";

type GsiInitConfig = {
  client_id: string;
  callback: (response: { credential?: string }) => void;
  context?: "signin" | "signup" | "use";
  ux_mode?: "popup" | "redirect";
  auto_select?: boolean;
  use_fedcm_for_prompt?: boolean;
  cancel_on_tap_outside?: boolean;
  itp_support?: boolean;
};

interface GsiPromptNotification {
  isNotDisplayed: () => boolean;
  getNotDisplayedReason: () => string;
  isSkippedMoment: () => boolean;
  getSkippedReason: () => string;
  isDismissedMoment: () => boolean;
  getDismissedReason: () => string;
}

interface GsiId {
  initialize: (config: GsiInitConfig) => void;
  prompt: (cb?: (n: GsiPromptNotification) => void) => void;
  cancel: () => void;
  disableAutoSelect: () => void;
}

declare global {
  interface Window {
    google?: { accounts: { id: GsiId } };
    __gsiInit?: boolean;
    __gsiInFlight: boolean;
  }
}

export default function GoogleOneTap() {
  const { data: session, status } = useSession();
  const [ ready, setReady ] = useState(false);
  const initialized = useRef(false);

  const handleCredentialResponse = useCallback(async (response: { credential?: string }) => {
    const idToken = response?.credential;
    if (!idToken) {
      console.error("No credential received");
      return;
    }

    try {
      const result = await signIn("google-onetap", {
        id_token: idToken,
        redirect: false,
      });

      if (result?.error) {
        console.error("Sing in error", result.error);
      }

    } catch (error) {
      console.error("Sing in failed", error);
    }
  }, []);

  const init = useCallback(() => {
    if (!window.google || session || status === 'loading') return;
    if (initialized.current || window.__gsiInit || window.__gsiInFlight) return;

    try {
      window.google.accounts.id.initialize({
        client_id: process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID!,
        callback: handleCredentialResponse,
        context: "signin",
        ux_mode: "popup",
        auto_select: false,
        use_fedcm_for_prompt: false,
        cancel_on_tap_outside: true,
        itp_support: true,
      });
      initialized.current = true;
      window.__gsiInit = true;
      window.__gsiInFlight = true;

      window.google.accounts.id.prompt(() => {
        window.__gsiInFlight = false;
      });
    } catch {
      initialized.current = false;
      window.__gsiInit = false
      setTimeout(init, 800);
    }
  }, [session, status, handleCredentialResponse]);

  useEffect(() => {
    if (ready && !session && status !== 'loading') init();
  }, [ready, init, session, status])

  useEffect(() => {
    if (session && window.google) {
      window.google.accounts.id.cancel();
      window.google.accounts.id.disableAutoSelect();
      initialized.current = false;
      window.__gsiInit = false;
      window.__gsiInFlight = false;
    }
  }, [session]);

  useEffect(() => {
    return () => {
      if (window.google) {
        window.google.accounts.id.cancel();
      }
    }
  }, [])

  return (
    <Script
      src="https://accounts.google.com/gsi/client"
      async
      defer
      strategy="afterInteractive"
      onLoad={ () => setReady(true) }
      onError={(e) => {
        console.error("Failed to load Google GSI script:", e)
      }}
    />
  );
}
</file>

<file path="src/lib/components/characterCreator/ExpertiseForm.tsx">
"use client";

import clsx from "clsx";
import { useStepForm } from "@/hooks/useStepForm";
import { expertiseSchema } from "@/lib/zod/schemas/persCreateSchema";
import { ClassI, BackgroundI, RaceI } from "@/lib/types/model-types";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import { useEffect, useMemo } from "react";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Check } from "lucide-react";
import { engEnumSkills } from "@/lib/refs/translation";
import { Skills } from "@prisma/client";

interface Props {
  selectedClass: ClassI;
  race: RaceI;
  background: BackgroundI;
  formId: string;
  onNextDisabledChange?: (disabled: boolean) => void;
}

export const ExpertiseForm = ({ selectedClass, formId, onNextDisabledChange }: Props) => {
  const { formData, updateFormData, nextStep } = usePersFormStore();
  
  const { form, onSubmit } = useStepForm(expertiseSchema, (data) => {
    updateFormData({ expertiseSchema: data });
    nextStep();
  });
  
  const expertiseFeature = useMemo(() => 
    selectedClass.features.find(f => 
      f.levelGranted === 1 && 
      (f.feature.skillExpertises as { count?: number } | undefined)?.count && 
      ((f.feature.skillExpertises as { count?: number } | undefined)?.count || 0) > 0
    ), [selectedClass]);

  const expertiseCount = (expertiseFeature?.feature.skillExpertises as { count?: number })?.count || 0;
  
  const selectedExpertises = form.watch("expertises") || [];

  // Get ONLY currently selected skills from formData
  const availableProficiencies = useMemo(() => {
    const skills = new Set<string>();
    
    // From SkillsForm selections (formData.skills)
    if (formData.skills && Array.isArray(formData.skills)) {
      formData.skills.forEach(skill => {
        if (Object.values(Skills).includes(skill as Skills)) {
          skills.add(skill);
        }
      });
    }
    
    // From skillsSchema (Tasha or basic choices)
    if (formData.skillsSchema) {
      if (formData.skillsSchema.isTasha) {
        formData.skillsSchema.tashaChoices?.forEach(skill => skills.add(skill));
      } else {
        formData.skillsSchema.basicChoices?.race?.forEach(skill => skills.add(skill));
        formData.skillsSchema.basicChoices?.selectedClass?.forEach(skill => skills.add(skill));
      }
    }
    
    return Array.from(skills);
  }, [formData.skills, formData.skillsSchema]);

  useEffect(() => {
    // Expertise selection is optional: user may proceed with fewer than the max.
    onNextDisabledChange?.(false);
  }, [selectedExpertises, expertiseCount, onNextDisabledChange]);

  const toggleExpertise = (skill: string) => {
    const current = form.getValues("expertises") || [];
    if (current.includes(skill as Skills)) {
      const newVal = current.filter(s => s !== skill);
      form.setValue("expertises", newVal);
      updateFormData({ expertiseSchema: { expertises: newVal } });
    } else {
      if (current.length < expertiseCount) {
        const newVal = [...current, skill as Skills];
        form.setValue("expertises", newVal);
        updateFormData({ expertiseSchema: { expertises: newVal } });
      }
    }
  };

  if (!expertiseFeature) return null;

  // Show warning if no skills selected yet

  return (
    <form id={formId} onSubmit={onSubmit} className="space-y-6">
      {availableProficiencies.length === 0 ? (
        <Card className="border-yellow-500/50">
          <div className="p-6 text-center">
            <p className="text-yellow-400 mb-2">   !</p>
            <p className="text-sm text-slate-400">
                      &quot;&quot;.
            </p>
          </div>
        </Card>
      ) : null}

      <div className="space-y-2 text-center">
        <h2 className="font-rpg-display text-3xl font-semibold uppercase tracking-widest text-slate-200 sm:text-4xl">
          
        </h2>
        <p className="text-sm text-slate-400">
           {expertiseCount} ,      (  ).
        </p>
        <p className="text-xs text-amber-400 mt-1">
                ,    !
        </p>
      </div>

      {availableProficiencies.length > 0 ? (
        <div className="grid gap-2 sm:grid-cols-2 md:grid-cols-3">
          {availableProficiencies.map((skill) => {
            const isSelected = selectedExpertises.includes(skill as Skills);
            const isMaxReached = selectedExpertises.length >= expertiseCount;
            const isDisabled = !isSelected && isMaxReached;
            const active = isSelected;
            const skillTranslation = engEnumSkills.find(s => s.eng === skill)?.ukr || skill;

            return (
              <Button
                key={skill}
                type="button"
                variant="outline"
                disabled={isDisabled}
                className={clsx(
                  "justify-between border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white",
                  active && "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100",
                  isDisabled && "opacity-60"
                )}
                onClick={() => !isDisabled && toggleExpertise(skill)}
              >
                <span>{skillTranslation}</span>
                {active && <Check className="h-4 w-4" />}
              </Button>
            );
          })}
        </div>
      ) : null}
    </form>
  );
};
</file>

<file path="src/lib/components/characterCreator/FeatChoiceOptionsForm.tsx">
"use client";

import { useEffect, useMemo, useRef } from "react";
import { useStepForm } from "@/hooks/useStepForm";
import { featChoiceOptionsSchema } from "@/lib/zod/schemas/persCreateSchema";
import { FeatPrisma } from "@/lib/types/model-types";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Check } from "lucide-react";
import { useWatch } from "react-hook-form";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import { Skills } from "@prisma/client";
import { SkillsEnum } from "@/lib/types/enums";
import { engEnumSkills, expertiseTranslations } from "@/lib/refs/translation";
import { translateValue } from "@/lib/components/characterCreator/infoUtils";

interface Props {
  selectedFeat?: FeatPrisma | null;
  formId: string;
  onNextDisabledChange?: (disabled: boolean) => void;
}

type Group = {
  groupName: string;
  options: NonNullable<FeatPrisma["featChoiceOptions"]>;
  pickCount: number;
  isSkill: boolean;
  isExpertise: boolean;
};

/**
 * Extracts skill enum value from optionNameEng
 * Handles formats like "Skill Expert Proficiency (ATHLETICS)" -> "ATHLETICS"
 * @param optionNameEng - The English option name
 * @returns The skill enum value or original string
 */
const extractSkillFromOptionName = (optionNameEng: string): string => {
  // Try to extract skill from parentheses
  const match = optionNameEng.match(/\(([A-Z_]+)\)$/);
  if (match) {
    return match[1];
  }
  return optionNameEng;
};

/**
 * Determines if all options in a group are skills
 * @param options - Array of feat choice options
 * @returns true if all options are from Skills enum
 */
const isSkillGroup = (options: NonNullable<FeatPrisma["featChoiceOptions"]>): boolean => {
  return options.every(opt => {
    // Extract skill name from optionNameEng before checking
    const skillName = extractSkillFromOptionName(opt.choiceOption.optionNameEng);
    return (SkillsEnum as readonly string[]).includes(skillName);
  });
};

/**
 * Determines if a group represents expertise choices based on its name
 * @param groupName - The name of the choice group
 * @returns true if group name contains expertise-related keywords
 */
const isExpertiseGroup = (groupName: string): boolean => {
  const lowerName = groupName.toLowerCase();
  return lowerName.includes('expertise') || 
         lowerName.includes('') ||
         lowerName.includes('expert');
};

const FeatChoiceOptionsForm = ({ selectedFeat, formId, onNextDisabledChange }: Props) => {
  const { formData, updateFormData, nextStep } = usePersFormStore();
  
  const { form, onSubmit: baseOnSubmit } = useStepForm(featChoiceOptionsSchema, (data) => {
    updateFormData({ featChoiceSelections: data.featChoiceSelections });
    nextStep();
  });
  
  const watchedSelections = useWatch({
    control: form.control,
    name: "featChoiceSelections",
  });
  const selections = useMemo(
    () => ((watchedSelections ?? {}) as Record<string, number>),
    [watchedSelections]
  );
  const prevDisabledRef = useRef<boolean | undefined>(undefined);

  /**
   * Gets all skills the character has from SkillsForm
   * Handles both Tasha's mode and basic mode
   */
  const existingSkills = useMemo(() => {
    const skills = new Set<string>();
    
    // Primary source: flat skills array from SkillsForm
    if (formData.skills && Array.isArray(formData.skills)) {
      formData.skills.forEach(skill => {
        if (Object.values(Skills).includes(skill as Skills)) {
          skills.add(skill);
        }
      });
    }
    
    return Array.from(skills);
  }, [formData.skills]);

  /**
   * Gets all expertises the character already has from ExpertiseForm
   */
  const existingExpertises = useMemo(() => {
    const expertises = new Set<string>();
    
    if (formData.expertiseSchema?.expertises) {
      formData.expertiseSchema.expertises.forEach(exp => expertises.add(exp));
    }
    
    return Array.from(expertises);
  }, [formData.expertiseSchema]);

  const optionsToUse = useMemo(() => selectedFeat?.featChoiceOptions || [], [selectedFeat]);

  const groupedChoices = useMemo<Group[]>(() => {
    const groups = new Map<string, NonNullable<FeatPrisma["featChoiceOptions"]>>();

    for (const fco of optionsToUse) {
      const groupName = fco.choiceOption.groupName || "";
      const bucket = groups.get(groupName) ?? [];
      bucket.push(fco);
      groups.set(groupName, bucket);
    }

    return Array.from(groups.entries()).map(([groupName, options]) => ({
      groupName,
      options,
      pickCount: 1,
      isSkill: isSkillGroup(options),
      isExpertise: isExpertiseGroup(groupName),
    }));
  }, [optionsToUse]);

  /**
   * Gets skills selected in THIS form (for live expertise updates)
   * Only includes skill groups that are NOT expertise groups
   */
  const selectedSkillsInForm = useMemo(() => {
    const skills = new Set<string>();
    groupedChoices.forEach(group => {
      // Only look at skill groups that are NOT expertise groups
      if (group.isSkill && !group.isExpertise) {
        const selectedOptionId = selections[group.groupName];
        if (selectedOptionId) {
          const option = group.options.find(opt => opt.choiceOptionId === selectedOptionId);
          if (option) {
            // Extract skill name from optionNameEng (e.g., "Skill Expert Proficiency (ATHLETICS)" -> "ATHLETICS")
            const skillName = extractSkillFromOptionName(option.choiceOption.optionNameEng);
            skills.add(skillName);
          }
        }
      }
    });
    
    return Array.from(skills);
  }, [groupedChoices, selections]);
  
  /**
   * Combined list of ALL skills available for expertise selection
   * Includes both existing skills from SkillsForm AND skills just selected in this form
   */
  const allAvailableSkillsForExpertise = useMemo(() => {
    const combined = new Set<string>([
      ...existingSkills,
      ...selectedSkillsInForm
    ]);
    
    return Array.from(combined);
  }, [existingSkills, selectedSkillsInForm]);

  /**
   * Gets all selected option names across all groups (to prevent duplicates)
   * For expertise groups, only track selections from OTHER expertise groups
   */
  const allSelectedOptions = useMemo(() => {
    const selected = new Set<string>();
    Object.entries(selections).forEach(([groupName, optionId]) => {
      groupedChoices.forEach(group => {
        if (group.groupName === groupName) {
          const option = group.options.find(opt => opt.choiceOptionId === optionId);
          if (option) {
            // For skill groups, extract the actual skill name
            if (group.isSkill || group.isExpertise) {
              const skillName = extractSkillFromOptionName(option.choiceOption.optionNameEng);
              selected.add(skillName);
            } else {
              selected.add(option.choiceOption.optionNameEng);
            }
          }
        }
      });
    });
    return Array.from(selected);
  }, [selections, groupedChoices]);

  /**
   * Gets selected expertises from THIS form (to prevent duplicate expertises)
   */
  const selectedExpertisesInForm = useMemo(() => {
    const expertises = new Set<string>();
    Object.entries(selections).forEach(([groupName, optionId]) => {
      const group = groupedChoices.find(g => g.groupName === groupName);
      if (group?.isExpertise && group?.isSkill) {
        const option = group.options.find(opt => opt.choiceOptionId === optionId);
        if (option) {
          const skillName = extractSkillFromOptionName(option.choiceOption.optionNameEng);
          expertises.add(skillName);
        }
      }
    });
    return Array.from(expertises);
  }, [selections, groupedChoices]);

  useEffect(() => {
    let disabled: boolean;
    if (!selectedFeat) {
      disabled = true;
    } else if (groupedChoices.length === 0) {
      disabled = false;
    } else {
      disabled = groupedChoices.some((g) => !selections[g.groupName]);
    }

    if (prevDisabledRef.current !== disabled) {
      prevDisabledRef.current = disabled;
      onNextDisabledChange?.(disabled);
    }
  }, [selectedFeat, groupedChoices, selections, onNextDisabledChange]);

  const selectOption = (groupName: string, optionId: number) => {
    const next = { ...(selections || {}), [groupName]: optionId };
    form.setValue("featChoiceSelections", next, {
      shouldDirty: true,
      shouldTouch: true,
      shouldValidate: true,
    });
  };

  /**
   * Determines if an option should be disabled based on skill/expertise rules
   * @param group - The group containing the option
   * @param opt - The specific option to check
   * @returns Object with disabled status and optional reason
   */
  const isOptionDisabled = (group: Group, opt: NonNullable<FeatPrisma["featChoiceOptions"]>[0]): { disabled: boolean; reason?: string } => {
    // Extract the actual skill name from optionNameEng
    const optionName = extractSkillFromOptionName(opt.choiceOption.optionNameEng);
    const isSelected = selections[group.groupName] === opt.choiceOptionId;
    
    // If this is a SKILL group (not expertise)
    if (group.isSkill && !group.isExpertise) {
      // Already have this skill from previous steps?
      if (existingSkills.includes(optionName)) {
        return { disabled: true, reason: ' ' };
      }
      // Already selected in another NON-EXPERTISE group in this form?
      if (!isSelected && allSelectedOptions.includes(optionName)) {
        // Check if it's selected in another skill (non-expertise) group
        const isInOtherSkillGroup = groupedChoices.some(g => 
          g.isSkill && !g.isExpertise && 
          g.groupName !== group.groupName &&
          selections[g.groupName] !== undefined &&
          g.options.some(o => 
            o.choiceOptionId === selections[g.groupName] &&
            extractSkillFromOptionName(o.choiceOption.optionNameEng) === optionName
          )
        );
        if (isInOtherSkillGroup) {
          return { disabled: true, reason: ' ' };
        }
      }
    }
    
    // If this is an EXPERTISE group
    if (group.isExpertise && group.isSkill) {
      // Can only pick expertise if we have the skill (from existing OR just selected in this form)
      const hasSkill = allAvailableSkillsForExpertise.includes(optionName);
      
      if (!hasSkill) {
        return { disabled: true, reason: ' ' };
      }
      
      // Already have expertise in this?
      if (existingExpertises.includes(optionName)) {
        return { disabled: true, reason: ' ' };
      }
      
      // Already selected as expertise in ANOTHER expertise group in this form?
      if (!isSelected && selectedExpertisesInForm.includes(optionName)) {
        return { disabled: true, reason: ' ' };
      }
    }
    
    return { disabled: false };
  };

  if (!selectedFeat) {
    return (
      <Card className="p-4 text-center text-slate-200">
          .
      </Card>
    );
  }

  if (groupedChoices.length === 0) {
    return (
      <Card className="p-4 text-center text-slate-200">
             .   .
      </Card>
    );
  }

  return (
    <form id={formId} onSubmit={baseOnSubmit} className="space-y-4">
      <div className="space-y-1 text-center">
        <p className="text-sm font-semibold text-slate-300"></p>
        <h2 className="font-rpg-display text-3xl font-semibold uppercase tracking-widest text-slate-200 sm:text-4xl"> </h2>
        <p className="text-sm text-slate-400"> &quot;{translateValue(selectedFeat.name)}&quot;  .</p>
      </div>

      <div className="space-y-4">
        {groupedChoices.map((group) => (
          <Card
            key={group.groupName}
            className=""
          >
            <CardContent className="space-y-3 p-4">
              <div className="flex items-center justify-between gap-3">
                <div>
                  <p className="text-xs uppercase tracking-[0.14em] text-slate-400"></p>
                  <p className="text-base font-semibold text-white">{group.groupName}</p>
                </div>
                <Badge variant="outline" className="border-white/15 bg-white/5 text-slate-200">
                   {group.pickCount}
                </Badge>
              </div>

              {group.isExpertise && group.isSkill && (
                <p className="text-xs text-amber-400">
                        ,    !
                </p>
              )}

              <div className="grid gap-2 sm:grid-cols-2">
                {group.options.map((opt) => {
                  const optionId = opt.choiceOptionId;
                  const optionNameEng = opt.choiceOption.optionNameEng;
                  const isSelected = selections[group.groupName] === optionId;
                  const { disabled, reason } = isOptionDisabled(group, opt);
                  
                  // Get Ukrainian translation for skills/expertises
                  let label = opt.choiceOption.optionName;
                  if (group.isSkill || group.isExpertise) {
                    // Extract skill name and translate it
                    const skillName = extractSkillFromOptionName(optionNameEng);
                    const skillTranslation = engEnumSkills.find(s => s.eng === skillName)?.ukr 
                      || expertiseTranslations[skillName as Skills];
                    label = skillTranslation || label || skillName;
                  } else {
                    label = label || optionNameEng;
                  }

                  return (
                    <Button
                      key={optionId}
                      type="button"
                      variant="outline"
                      disabled={disabled && !isSelected}
                      className={`justify-between border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white ${
                        isSelected ? "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100" : ""
                      } ${disabled && !isSelected ? "opacity-60 cursor-not-allowed" : ""}`}
                      onClick={() => !disabled && selectOption(group.groupName, optionId)}
                    >
                      <span className="flex items-center gap-2">
                        {label}
                        {disabled && reason && (
                          <span className="text-xs opacity-70">({reason})</span>
                        )}
                      </span>
                      {isSelected && <Check className="h-4 w-4" />}
                    </Button>
                  );
                })}
              </div>
            </CardContent>
          </Card>
        ))}
      </div>
    </form>
  );
};

export default FeatChoiceOptionsForm;
</file>

<file path="src/lib/components/characterCreator/SubclassChoiceOptionsForm.tsx">
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { SubclassI } from "@/lib/types/model-types";
import { useStepForm } from "@/hooks/useStepForm";
import { subclassSchema } from "@/lib/zod/schemas/persCreateSchema";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { ControlledInfoDialog, InfoSectionTitle } from "@/lib/components/characterCreator/EntityInfoDialog";
import clsx from "clsx";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import { Button } from "@/components/ui/button";
import { HelpCircle } from "lucide-react";
import { FormattedDescription } from "@/components/ui/FormattedDescription";

interface Props {
  selectedSubclass?: SubclassI | null;
  availableOptions?: SubclassI["subclassChoiceOptions"];
  formId: string;
  onNextDisabledChange?: (disabled: boolean) => void;
}

const previewTextFromFeatures = (
  features?: SubclassI["subclassChoiceOptions"][number]["choiceOption"]["features"]
) => {
  const stripMarkdownPreview = (value: string) => {
    return value
      .replace(/\r\n/g, "\n")
      .replace(/<a\s+[^>]*>(.*?)<\/a>/gi, "$1")
      .replace(/<[^>]+>/g, " ")
      .replace(/\[([^\]]+)\]\(([^)]+)\)/g, "$1")
      .replace(/`{1,3}([^`]+)`{1,3}/g, "$1")
      .replace(/\*\*([^*]+)\*\*/g, "$1")
      .replace(/__([^_]+)__/g, "$1")
      .replace(/\*([^*]+)\*/g, "$1")
      .replace(/_([^_]+)_/g, "$1")
      .replace(/^#{1,6}\s+/gm, "")
      .replace(/^>\s?/gm, "")
      .replace(/^\s*[-*+]\s+/gm, "")
      .replace(/^\s*\d+\.\s+/gm, "")
      .replace(/\s+/g, " ")
      .trim();
  };

  const list = (features || []).map((x) => x.feature).filter(Boolean) as any[];
  const first = list.find((f) => (f.shortDescription || f.description) && String(f.shortDescription || f.description).trim());
  if (!first) return "";
  return stripMarkdownPreview(String(first.shortDescription || first.description));
};

const SubclassChoiceOptionsForm = ({ selectedSubclass, availableOptions, formId, onNextDisabledChange }: Props) => {
  const { updateFormData, nextStep } = usePersFormStore();

  const [infoOpen, setInfoOpen] = useState(false);
  const [infoTitle, setInfoTitle] = useState<string>("");
  const [infoFeatures, setInfoFeatures] = useState<Array<{ name: string; description: string; shortDescription?: string | null }>>([]);
  
  const { form, onSubmit } = useStepForm(subclassSchema, (data) => {
    updateFormData({ subclassChoiceSelections: data.subclassChoiceSelections });
    nextStep();
  });
  
  const selections = form.watch("subclassChoiceSelections") || {};
  const prevDisabledRef = useRef<boolean | undefined>(undefined);

  const optionsToUse = useMemo(() => {
      if (availableOptions) return availableOptions;
      // Default to level 1 if not specified (though subclasses usually start at 1, 2, or 3)
      // For creation flow, we might need to check the class's subclass level, but usually this form is shown when subclass is active.
      // Let's assume for creation flow we show all options granted at the subclass level?
      // Or maybe we just show all options?
      // In creation flow, we usually pick subclass at level 1, 2 or 3.
      // If we are at that level, we should show options for that level.
      // But `levelsGranted` might be higher.
      // For now, let's filter for level 1 as a default fallback, or just return all if we assume the parent filters.
      // Actually, let's stick to the pattern:
      return (selectedSubclass?.subclassChoiceOptions || []).filter((opt) => (opt.levelsGranted || []).includes(1));
  }, [selectedSubclass, availableOptions]);

  const groupedOptions = useMemo(() => {
    const groups: Record<string, typeof optionsToUse> = {};
    optionsToUse.forEach((opt) => {
      const key = opt.choiceOption.groupName || "";
      if (!groups[key]) groups[key] = [];
      groups[key].push(opt);
    });
    return Object.entries(groups).map(([groupName, options]) => ({ groupName, options }));
  }, [optionsToUse]);

  useEffect(() => {
    let disabled: boolean;

    if (groupedOptions.length === 0) {
      disabled = false;
    } else {
      const allGroupsSelected = groupedOptions.every(({ groupName }) => {
        const selectedOptionId = selections[groupName];
        return selectedOptionId !== undefined;
      });
      disabled = !allGroupsSelected;
    }

    if (prevDisabledRef.current !== disabled) {
      onNextDisabledChange?.(disabled);
      prevDisabledRef.current = disabled;
    }
  }, [groupedOptions, selections, onNextDisabledChange]);

  useEffect(() => {
    updateFormData({ subclassChoiceSelections: selections });
  }, [selections, updateFormData]);

  const selectOption = (groupName: string, optionId: number) => {
    const next = { ...(selections || {}), [groupName]: optionId };
    form.setValue("subclassChoiceSelections", next, { shouldDirty: true, shouldTouch: true, shouldValidate: true });
  };

  const openFeaturesInfo = (
    title: string,
    features?: SubclassI["subclassChoiceOptions"][number]["choiceOption"]["features"]
  ) => {
    const normalized = (features || [])
      .map((item) => item.feature)
      .filter(Boolean)
      .map((feat) => ({
        name: String((feat as any).name ?? ""),
        description: String((feat as any).description ?? ""),
        shortDescription: (feat as any).shortDescription ?? null,
      }))
      .filter((f) => f.name.trim() || f.description.trim() || (f.shortDescription ?? "").toString().trim());

    setInfoTitle(title);
    setInfoFeatures(normalized);
    setInfoOpen(true);
  };

  if (groupedOptions.length === 0) {
    return <div className="text-center text-muted-foreground py-4">       .</div>;
  }

  return (
    <form id={formId} onSubmit={onSubmit} className="space-y-6">
      {groupedOptions.map(({ groupName, options }) => (
        <div key={groupName} className="space-y-3">
          <InfoSectionTitle>{groupName}</InfoSectionTitle>
          <div className="grid grid-cols-1 gap-3">
            {options.map((opt) => {
              const isSelected = selections[groupName] === opt.choiceOption.choiceOptionId;
              const preview = previewTextFromFeatures(opt.choiceOption.features);

              return (
                <Card
                  key={opt.choiceOption.choiceOptionId}
                  className={clsx(
                    "glass-card cursor-pointer transition-all duration-200",
                    isSelected && "glass-active"
                  )}
                  onClick={() => selectOption(groupName, opt.choiceOption.choiceOptionId)}
                >
                  <CardContent className="relative flex items-start justify-between gap-4 p-4">
                    <div className="min-w-0 flex-1">
                      <div className="flex items-start justify-between gap-3">
                        <div className="min-w-0">
                          <div className="truncate text-lg font-semibold text-white">
                            {opt.choiceOption.optionName}
                          </div>
                          {preview && (
                            <div className="mt-1 line-clamp-2 text-sm text-slate-300">
                              {preview}
                            </div>
                          )}
                        </div>

                        <Button
                          type="button"
                          size="icon"
                          variant="ghost"
                          className="h-8 w-8 text-slate-300 hover:text-white"
                          data-stop-card-click
                          onClick={(e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            openFeaturesInfo(opt.choiceOption.optionName, opt.choiceOption.features);
                          }}
                          aria-label={`: ${opt.choiceOption.optionName}`}
                        >
                          <HelpCircle className="h-5 w-5" />
                        </Button>
                      </div>

                      <div className="mt-3 flex flex-wrap gap-2">
                        {isSelected ? (
                          <Badge className="bg-emerald-500/10 text-emerald-200"></Badge>
                        ) : (
                          <Badge variant="secondary">,  </Badge>
                        )}
                      </div>
                    </div>
                  </CardContent>
                </Card>
              );
            })}
          </div>
        </div>
      ))}

      <ControlledInfoDialog
        open={infoOpen}
        onOpenChange={setInfoOpen}
        title={infoTitle}
      >
        <div className="space-y-4">
          {infoFeatures.length === 0 ? (
            <p className="text-sm text-slate-300">   .</p>
          ) : (
            infoFeatures.map((f) => (
              <div key={f.name} className="glass-panel border-gradient-rpg rounded-lg px-3 py-2.5">
                <div className="flex items-center justify-between gap-3">
                  <p className="text-sm font-semibold text-white">{f.name}</p>
                </div>
                {f.description && (
                  <FormattedDescription
                    content={f.description}
                    className="mt-2 text-slate-200/90"
                  />
                )}
              </div>
            ))
          )}
        </div>
      </ControlledInfoDialog>
    </form>
  );
};

export default SubclassChoiceOptionsForm;
</file>

<file path="src/lib/components/characterSheet/slides/MainStatsSlide.tsx">
"use client";

import { PersWithRelations } from "@/lib/actions/pers";
import { Card, CardContent } from "@/components/ui/card";
import { getAbilityMod, formatModifier, getProficiencyBonus } from "@/lib/logic/utils";
import { Ability, Classes } from "@prisma/client";
import { attributesUkrShort, classTranslations } from "@/lib/refs/translation";
import { Heart, Shield, Sword, Edit3 } from "lucide-react";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { useEffect, useMemo, useState, useTransition, useCallback } from "react";
import { useRouter } from "next/navigation";
import { applyHpChange, reviveCharacter, setDeathSaves } from "@/lib/actions/combat-actions";
import { updateCharacterAction } from "@/lib/actions/update-character";
import { LanguageTranslations } from "@/lib/refs/translation";
import { useModalBackButton } from "@/hooks/useModalBackButton";
import { toast } from "sonner";
import ModifyStatModal, { ModifyConfig } from "@/lib/components/characterSheet/ModifyStatModal";
import {
  hasStatBonuses,
  hasSimpleBonus,
  calculateFinalAC,
  calculateFinalSpeed,
  calculateFinalInitiative,
  calculateFinalProficiency,
  calculateFinalStat,
  calculateFinalModifier,
  calculateFinalSave,
  getStatBonus,
  getModifierBonus,
  getSaveBonus,
  getSimpleBonus,
} from "@/lib/logic/bonus-calculator";

interface MainStatsSlideProps {
  pers: PersWithRelations;
  onPersUpdate?: (next: PersWithRelations) => void;
  isReadOnly?: boolean;
}

export default function MainStatsSlide({ pers, onPersUpdate, isReadOnly }: MainStatsSlideProps) {
  const router = useRouter();
  const [isHpPending, startHpTransition] = useTransition();
  const [isDetailsPending, startDetailsTransition] = useTransition();

  // Bonus modification modal state
  const [modifyOpen, setModifyOpen] = useState(false);
  const [modifyConfig, setModifyConfig] = useState<ModifyConfig | null>(null);

  // Helper to open modify modal
  const openModify = useCallback((config: ModifyConfig) => {
    setModifyConfig(config);
    setModifyOpen(true);
  }, []);

  // Helper for pers updates
  const handlePersUpdate = useCallback((next: PersWithRelations) => {
    onPersUpdate?.(next);
  }, [onPersUpdate]);

  const [hpOpen, setHpOpen] = useState(false);
  const [hpMode, setHpMode] = useState<"damage" | "heal" | "temp">("damage");
  const [hpAmount, setHpAmount] = useState<string>("");

  const [localCurrentHp, setLocalCurrentHp] = useState<number>(() => pers.currentHp);
  const [localTempHp, setLocalTempHp] = useState<number>(() => (pers as any).tempHp ?? 0);
  const [localMaxHp, setLocalMaxHp] = useState<number>(() => pers.maxHp);
  const [deathSuccesses, setDeathSuccesses] = useState<number>(() => (pers as any).deathSaveSuccesses ?? 0);
  const [deathFailures, setDeathFailures] = useState<number>(() => (pers as any).deathSaveFailures ?? 0);
  const [isDead, setIsDead] = useState<boolean>(() => Boolean((pers as any).isDead));

  const [detailsOpen, setDetailsOpen] = useState(false);
  const [languagesOpen, setLanguagesOpen] = useState(false);
  const [didInitDetails, setDidInitDetails] = useState(false);

  useModalBackButton(hpOpen, () => setHpOpen(false));
  useModalBackButton(languagesOpen, () => setLanguagesOpen(false));

  const [draftProficiencies, setDraftProficiencies] = useState<string>(() => String((pers as any).customProficiencies ?? ""));
  const [draftLanguages, setDraftLanguages] = useState<string>(() => String((pers as any).customLanguagesKnown ?? ""));
  const [draftTraits, setDraftTraits] = useState<string>(() => String(pers.personalityTraits ?? ""));
  const [draftIdeals, setDraftIdeals] = useState<string>(() => String(pers.ideals ?? ""));
  const [draftBonds, setDraftBonds] = useState<string>(() => String(pers.bonds ?? ""));
  const [draftFlaws, setDraftFlaws] = useState<string>(() => String(pers.flaws ?? ""));
  const [draftBackstory, setDraftBackstory] = useState<string>(() => String(pers.backstory ?? ""));
  const [draftNotes, setDraftNotes] = useState<string>(() => String(pers.notes ?? ""));
  const [draftAlignment, setDraftAlignment] = useState<string>(() => String((pers as any).alignment ?? ""));
  const [draftXp, setDraftXp] = useState<string>(() => String((pers as any).xp ?? 0));
  const [draftCp, setDraftCp] = useState<string>(() => String((pers as any).cp ?? "0"));
  const [draftEp, setDraftEp] = useState<string>(() => String((pers as any).ep ?? "0"));
  const [draftSp, setDraftSp] = useState<string>(() => String((pers as any).sp ?? "0"));
  const [draftGp, setDraftGp] = useState<string>(() => String((pers as any).gp ?? "0"));
  const [draftPp, setDraftPp] = useState<string>(() => String((pers as any).pp ?? "0"));

  const [selectedLanguages, setSelectedLanguages] = useState<Set<string>>(() => {
    const raw = String((pers as any).customLanguagesKnown ?? "");
    const tokens = raw
      .split(/[\n,]/g)
      .map((s) => s.trim())
      .filter(Boolean);
    return new Set(tokens);
  });

  useEffect(() => {
    setLocalCurrentHp(pers.currentHp);
    setLocalTempHp(Number.isFinite((pers as any).tempHp) ? Math.max(0, Math.trunc((pers as any).tempHp)) : 0);
    setLocalMaxHp(pers.maxHp);
    setDeathSuccesses(Number.isFinite((pers as any).deathSaveSuccesses) ? Math.max(0, Math.trunc((pers as any).deathSaveSuccesses)) : 0);
    setDeathFailures(Number.isFinite((pers as any).deathSaveFailures) ? Math.max(0, Math.trunc((pers as any).deathSaveFailures)) : 0);
    setIsDead(Boolean((pers as any).isDead));

    // Keep Detailed Info in sync if server data refreshes
    setDraftProficiencies(String((pers as any).customProficiencies ?? ""));
    setDraftLanguages(String((pers as any).customLanguagesKnown ?? ""));
    setDraftTraits(String(pers.personalityTraits ?? ""));
    setDraftIdeals(String(pers.ideals ?? ""));
    setDraftBonds(String(pers.bonds ?? ""));
    setDraftFlaws(String(pers.flaws ?? ""));
    setDraftBackstory(String(pers.backstory ?? ""));
    setDraftNotes(String(pers.notes ?? ""));
    setDraftAlignment(String((pers as any).alignment ?? ""));
    setDraftXp(String((pers as any).xp ?? 0));
    setDraftCp(String((pers as any).cp ?? "0"));
    setDraftEp(String((pers as any).ep ?? "0"));
    setDraftSp(String((pers as any).sp ?? "0"));
    setDraftGp(String((pers as any).gp ?? "0"));
    setDraftPp(String((pers as any).pp ?? "0"));
    setSelectedLanguages(() => {
      const raw = String((pers as any).customLanguagesKnown ?? "");
      const tokens = raw
        .split(/[\n,]/g)
        .map((s) => s.trim())
        .filter(Boolean);
      return new Set(tokens);
    });
    setDidInitDetails(true);
  }, [pers]);

  useEffect(() => {
    if (!didInitDetails) return;

    const isDirty =
      draftProficiencies !== String((pers as any).customProficiencies ?? "") ||
      draftLanguages !== String((pers as any).customLanguagesKnown ?? "") ||
      draftTraits !== String(pers.personalityTraits ?? "") ||
      draftIdeals !== String(pers.ideals ?? "") ||
      draftBonds !== String(pers.bonds ?? "") ||
      draftFlaws !== String(pers.flaws ?? "") ||
      draftBackstory !== String(pers.backstory ?? "") ||
      draftNotes !== String(pers.notes ?? "") ||
      draftAlignment !== String((pers as any).alignment ?? "") ||
      draftXp !== String((pers as any).xp ?? 0) ||
      draftCp !== String((pers as any).cp ?? "0") ||
      draftEp !== String((pers as any).ep ?? "0") ||
      draftSp !== String((pers as any).sp ?? "0") ||
      draftGp !== String((pers as any).gp ?? "0") ||
      draftPp !== String((pers as any).pp ?? "0");

    if (!isDirty) return;

    const handle = window.setTimeout(() => {
      // Save in background; don't block HP modal UX.
      startDetailsTransition(async () => {
        await updateCharacterAction({
          persId: pers.persId,
          data: {
            customProficiencies: draftProficiencies,
            customLanguagesKnown: draftLanguages,
            personalityTraits: draftTraits,
            ideals: draftIdeals,
            bonds: draftBonds,
            flaws: draftFlaws,
            backstory: draftBackstory,
            notes: draftNotes,
            alignment: draftAlignment,
            xp: parseInt(draftXp) || 0,
            cp: draftCp,
            ep: draftEp,
            sp: draftSp,
            gp: draftGp,
            pp: draftPp,
          },
        });
      });
    }, 2000);

    return () => window.clearTimeout(handle);
  }, [
    didInitDetails,
    draftProficiencies,
    draftLanguages,
    draftTraits,
    draftIdeals,
    draftBonds,
    draftFlaws,
    draftBackstory,
    draftNotes,
    draftAlignment,
    draftXp,
    draftCp,
    draftEp,
    draftSp,
    draftGp,
    draftPp,
    pers.persId,
    startDetailsTransition,
  ]);

  const pb = getProficiencyBonus(pers.level);
  
  // Calculate hit dice info per class
  const hitDiceInfo = useMemo(() => {
    const result: Array<{ className: string; current: number; max: number; hitDie: number }> = [];
    
    // Calculate main class level
    const multiclassLevelSum = pers.multiclasses?.reduce((acc, mc) => acc + mc.classLevel, 0) ?? 0;
    const mainClassLevel = pers.level - multiclassLevelSum;
    
    // Get stored hit dice or default to max
    const storedHitDice = (pers as unknown as { currentHitDice?: Record<string, number> }).currentHitDice ?? {};
    
    // Main class
    const mainClassName = classTranslations[pers.class.name as Classes] ?? pers.class.name;
    const mainCurrent = typeof storedHitDice[String(pers.class.classId)] === 'number'
      ? storedHitDice[String(pers.class.classId)]
      : mainClassLevel;
    result.push({
      className: mainClassName,
      current: Math.min(mainCurrent, mainClassLevel),
      max: mainClassLevel,
      hitDie: pers.class.hitDie,
    });
    
    // Multiclasses
    for (const mc of pers.multiclasses ?? []) {
      const mcClassName = classTranslations[mc.class.name as unknown as Classes] ?? '';
      const mcCurrent = typeof storedHitDice[String(mc.classId)] === 'number'
        ? storedHitDice[String(mc.classId)]
        : mc.classLevel;
      result.push({
        className: mcClassName,
        current: Math.min(mcCurrent, mc.classLevel),
        max: mc.classLevel,
        hitDie: mc.class.hitDie,
      });
    }
    
    return result;
  }, [pers]);
  
  // Format hit dice for display
  const hitDiceDisplay = useMemo(() => {
    if (hitDiceInfo.length === 1) {
      const hd = hitDiceInfo[0];
      return `${hd.current}/${hd.max} d${hd.hitDie}`;
    }
    // Multiclass: show each class separately
    return hitDiceInfo.map(hd => `${hd.current}/${hd.max}d${hd.hitDie}`).join(' | ');
  }, [hitDiceInfo]);

  // Get saving throw proficiencies
  const savingThrows: Ability[] = pers.class.savingThrows ?? [];

  const attributes = [
    { name: attributesUkrShort.STR, fullName: "", score: pers.str, key: "str", borderColor: "border-red-500/40" },
    { name: attributesUkrShort.DEX, fullName: "", score: pers.dex, key: "dex", borderColor: "border-green-500/40" },
    { name: attributesUkrShort.CON, fullName: "", score: pers.con, key: "con", borderColor: "border-orange-500/40" },
    { name: attributesUkrShort.INT, fullName: "", score: pers.int, key: "int", borderColor: "border-blue-500/40" },
    { name: attributesUkrShort.WIS, fullName: "", score: pers.wis, key: "wis", borderColor: "border-purple-500/40" },
    { name: attributesUkrShort.CHA, fullName: "", score: pers.cha, key: "cha", borderColor: "border-pink-500/40" },
  ] as const;

  const abilityByKey: Record<(typeof attributes)[number]["key"], Ability> = {
    str: Ability.STR,
    dex: Ability.DEX,
    con: Ability.CON,
    int: Ability.INT,
    wis: Ability.WIS,
    cha: Ability.CHA,
  };

  const hpTitle = useMemo(() => {
    if (isDead) return " ";
    if (localCurrentHp <= 0) return "0 HP   ";
    return "'";
  }, [isDead, localCurrentHp]);

  const applyHp = () => {
    setHpOpen(false);
    const amount = Math.max(0, Math.trunc(Number(hpAmount)));
    if (!Number.isFinite(amount) || amount <= 0) return;

    // Optimistic update (mirror server logic in applyHpChange)
    const prev = {
      currentHp: localCurrentHp,
      tempHp: localTempHp,
      maxHp: localMaxHp,
      deathSaveSuccesses: deathSuccesses,
      deathSaveFailures: deathFailures,
      isDead,
    };

    const maxHp = Math.max(1, Math.trunc(Number(localMaxHp) || 1));
    const curHp = Math.max(0, Math.trunc(Number(localCurrentHp) || 0));
    const curTemp = Math.max(0, Math.trunc(Number(localTempHp) || 0));

    let nextHp = curHp;
    let nextTemp = curTemp;

    if (hpMode === "damage") {
      const dmgToTemp = Math.min(nextTemp, amount);
      nextTemp -= dmgToTemp;
      const remaining = amount - dmgToTemp;
      nextHp = Math.max(0, nextHp - remaining);
    } else if (hpMode === "heal") {
      nextHp = Math.min(maxHp, nextHp + amount);
    } else if (hpMode === "temp") {
      nextTemp = Math.max(nextTemp, amount);
    }

    const clearsDeath = nextHp > 0;

    setLocalCurrentHp(nextHp);
    setLocalTempHp(nextTemp);
    setLocalMaxHp(maxHp);
    if (clearsDeath) {
      setDeathSuccesses(0);
      setDeathFailures(0);
      setIsDead(false);
    }
    setHpAmount("");

    startHpTransition(async () => {
      const res = await applyHpChange({ persId: pers.persId, mode: hpMode, amount });
      if (!res.success) {
        // Rollback on failure
        setLocalCurrentHp(prev.currentHp);
        setLocalTempHp(prev.tempHp);
        setLocalMaxHp(prev.maxHp);
        setDeathSuccesses(prev.deathSaveSuccesses);
        setDeathFailures(prev.deathSaveFailures);
        setIsDead(prev.isDead);
        toast.error("   HP", { description: res.error });
        router.refresh();
        return;
      }
      setLocalCurrentHp(res.currentHp);
      setLocalTempHp(res.tempHp);
      setLocalMaxHp(res.maxHp);
      setDeathSuccesses(res.deathSaveSuccesses);
      setDeathFailures(res.deathSaveFailures);
      setIsDead(res.isDead);
      router.refresh();
    });
  };

  const setSaves = (nextSuccess: number, nextFail: number) => {
    const s = Math.max(0, Math.min(3, Math.trunc(nextSuccess)));
    const f = Math.max(0, Math.min(3, Math.trunc(nextFail)));

    // Optimistic update (mirror server logic in setDeathSaves)
    const prev = {
      currentHp: localCurrentHp,
      deathSaveSuccesses: deathSuccesses,
      deathSaveFailures: deathFailures,
      isDead,
    };

    if (isDead) {
      setDeathSuccesses(s);
      setDeathFailures(f);
    } else if (s >= 3) {
      setLocalCurrentHp(1);
      setDeathSuccesses(0);
      setDeathFailures(0);
      setIsDead(false);
    } else if (f >= 3) {
      setDeathSuccesses(s);
      setDeathFailures(f);
      setIsDead(true);
    } else {
      setDeathSuccesses(s);
      setDeathFailures(f);
    }

    startHpTransition(async () => {
      const res = await setDeathSaves({ persId: pers.persId, successes: s, failures: f });
      if (!res.success) {
        // Rollback on failure
        setLocalCurrentHp(prev.currentHp);
        setDeathSuccesses(prev.deathSaveSuccesses);
        setDeathFailures(prev.deathSaveFailures);
        setIsDead(prev.isDead);
        toast.error("    ", { description: res.error });
        router.refresh();
        return;
      }
      setLocalCurrentHp(res.currentHp);
      setDeathSuccesses(res.deathSaveSuccesses);
      setDeathFailures(res.deathSaveFailures);
      setIsDead(res.isDead);
      router.refresh();
    });
  };

  const CircleRow = ({
    count,
    onChange,
    tone,
    label,
  }: {
    count: number;
    onChange: (next: number) => void;
    tone: "emerald" | "rose";
    label: string;
  }) => {
    return (
      <div className="space-y-1">
        <div className="text-[10px] uppercase tracking-[0.16em] text-slate-400">{label}</div>
        <div className="flex items-center gap-2">
          {Array.from({ length: 3 }, (_, idx) => {
            const filled = idx < count;
            return (
              <button
                key={idx}
                type="button"
                disabled={isHpPending}
                onClick={() => {
                  const next = filled && idx === count - 1 ? idx : idx + 1;
                  onChange(next);
                }}
                className={
                  "h-8 w-8 rounded-full border transition " +
                  (filled
                    ? tone === "emerald"
                      ? "border-emerald-400/50 bg-emerald-500/25"
                      : "border-rose-400/50 bg-rose-500/25"
                    : "border-white/10 bg-white/5 hover:bg-white/10")
                }
                aria-label={`${label}: ${idx + 1}`}
                title=",  "
              />
            );
          })}
        </div>
      </div>
    );
  };

  return (
    <div className="h-full flex flex-col gap-4 p-4">
      {/* HERO SECTION: Combat Stats (HP, AC, Initiative) */}
      <div className="grid grid-cols-3 gap-2">
        <button 
          type="button" 
          onClick={() => !isReadOnly && openModify({ type: 'simple', field: 'ac' })} 
          className={`text-left ${isReadOnly ? 'cursor-default' : ''}`}
        >
          <Card className={`glass-card bg-indigo-500/15 border-indigo-500/40 h-24 ${!isReadOnly ? 'hover:bg-indigo-500/25 transition' : ''} ${hasSimpleBonus(pers, 'ac') ? 'ring-1 ring-indigo-400/50' : ''}`}>
            <CardContent className="p-2 flex flex-col items-center justify-center h-full">
              <div className="text-[9px] font-bold uppercase tracking-wide text-indigo-300"> </div>
              <div className="text-3xl font-bold text-white mt-1">{calculateFinalAC(pers)}</div>
              <Shield className="w-4 h-4 text-indigo-400 opacity-60 mt-1" />
            </CardContent>
          </Card>
        </button>

        <button 
          type="button" 
          onClick={() => !isReadOnly && setHpOpen(true)} 
          className={`text-left ${isReadOnly ? 'cursor-default' : ''}`}
        >
          <Card className={`glass-card bg-rose-500/20 border-rose-500/50 h-24 ${!isReadOnly ? 'hover:bg-rose-500/25 transition' : ''}`}>
            <CardContent className="p-2 flex flex-col items-center justify-center h-full">
              <div className="text-[9px] font-bold uppercase tracking-wide text-rose-300 text-center">{hpTitle}</div>
              <div className="text-4xl font-black text-white mt-1">{localCurrentHp}</div>
              <div className="text-[11px] text-rose-400">/ {localMaxHp}</div>
              {localTempHp > 0 ? (
                <div className="text-[9px] text-slate-200/80">.: +{localTempHp}</div>
              ) : null}
            </CardContent>
          </Card>
        </button>

        <button 
          type="button" 
          onClick={() => !isReadOnly && openModify({ type: 'simple', field: 'initiative' })} 
          className={`text-left ${isReadOnly ? 'cursor-default' : ''}`}
        >
          <Card className={`glass-card bg-emerald-500/15 border-emerald-500/40 h-24 ${!isReadOnly ? 'hover:bg-emerald-500/25 transition' : ''} ${hasSimpleBonus(pers, 'initiative') ? 'ring-1 ring-emerald-400/50' : ''}`}>
            <CardContent className="p-2 flex flex-col items-center justify-center h-full">
              <div className="text-[9px] font-bold uppercase tracking-wide text-emerald-300"></div>
              <div className="text-3xl font-bold text-white mt-1">{formatModifier(calculateFinalInitiative(pers))}</div>
            </CardContent>
          </Card>
        </button>
      </div>

      {/* SECONDARY STATS ROW: Speed, Hit Dice, Proficiency */}
      <div className="grid grid-cols-3 gap-2">
        <button 
          type="button" 
          onClick={() => !isReadOnly && openModify({ type: 'simple', field: 'speed' })} 
          className={`text-left ${isReadOnly ? 'cursor-default' : ''}`}
        >
          <Card className={`glass-card bg-cyan-500/15 border-cyan-400/40 h-16 ${!isReadOnly ? 'hover:bg-cyan-500/25 transition' : ''} ${hasSimpleBonus(pers, 'speed') ? 'ring-1 ring-cyan-400/50' : ''}`}>
            <CardContent className="p-2 flex flex-col items-center justify-center h-full">
              <div className="text-[9px] font-bold uppercase tracking-wide text-cyan-300"></div>
              <div className="text-xl font-bold text-cyan-50">{calculateFinalSpeed(pers)}</div>
            </CardContent>
          </Card>
        </button>
        <Card className="glass-card bg-amber-500/15 border-amber-400/40 h-16">
          <CardContent className="p-2 flex flex-col items-center justify-center h-full">
            <div className="text-[9px] font-bold uppercase tracking-wide text-amber-300"> </div>
            <div className="text-lg font-bold text-amber-50 text-center leading-tight">{hitDiceDisplay}</div>
          </CardContent>
        </Card>
        <button 
          type="button" 
          onClick={() => !isReadOnly && openModify({ type: 'simple', field: 'proficiency' })} 
          className={`text-left ${isReadOnly ? 'cursor-default' : ''}`}
        >
          <Card className={`glass-card bg-indigo-500/15 border-indigo-400/40 h-16 ${!isReadOnly ? 'hover:bg-indigo-500/25 transition' : ''} ${hasSimpleBonus(pers, 'proficiency') ? 'ring-1 ring-indigo-400/50' : ''}`}>
            <CardContent className="p-2 flex flex-col items-center justify-center h-full">
              <div className="text-[9px] font-bold uppercase tracking-wide text-indigo-300"></div>
              <div className="text-xl font-bold text-indigo-50">{formatModifier(calculateFinalProficiency(pers))}</div>
            </CardContent>
          </Card>
        </button>
      </div>

      {/* ABILITY SCORES GRID (Perfectly Balanced Layout) */}
      <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
        {attributes.map((attr) => {
          const ability = abilityByKey[attr.key];
          const hasSaveProficiency = savingThrows.includes(ability);

          return (
            <button
              key={attr.name}
              type="button"
              onClick={() => !isReadOnly && openModify({ type: 'stat', ability: abilityByKey[attr.key] })}
              className={`text-left ${isReadOnly ? 'cursor-default' : ''}`}
            >
              <Card className={`glass-card bg-slate-900/60 ${attr.borderColor} border h-14 ${!isReadOnly ? 'hover:bg-slate-800/60 transition' : ''} ${hasStatBonuses(pers, abilityByKey[attr.key]) ? 'ring-1 ring-white/30' : ''}`}>
                <CardContent className="h-full px-1 py-1 grid grid-cols-[1fr_auto_1fr] items-center gap-0">
                  {/* Left: Ability Name & Score */}
                  <div className="flex flex-col items-center justify-center gap-0">
                    <span className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">{attr.name}</span>
                    <span className="text-[9px] font-mono text-slate-500">
                      {calculateFinalStat(pers, abilityByKey[attr.key])}
                    </span>
                  </div>

                  {/* Center: Modifier (Main Focus) */}
                  <div className="flex items-center justify-center w-6">
                    <span className="text-2xl font-black text-white tracking-tight">
                      {formatModifier(calculateFinalModifier(pers, abilityByKey[attr.key]))}
                    </span>
                  </div>

                  {/* Right: Saving Throw */}
                  <div className="flex flex-col items-center justify-center gap-0.5">
                    <span className="text-[8px] text-slate-500 uppercase tracking-tighter"></span>
                    <div className="flex items-center gap-1">
                      <span className={`text-xs font-bold ${
                        hasSaveProficiency ? "text-indigo-400" : "text-slate-400"
                      }`}>
                        {formatModifier(calculateFinalSave(pers, abilityByKey[attr.key], savingThrows))}
                      </span>
                      {hasSaveProficiency && (
                        <div className="w-1.5 h-1.5 rounded-full bg-indigo-500 shadow-[0_0_5px_rgba(99,102,241,0.5)]" />
                      )}
                    </div>
                  </div>
                </CardContent>
              </Card>
            </button>
          );
        })}
      </div>

      <Dialog open={hpOpen} onOpenChange={setHpOpen}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="text-lg"> </DialogTitle>
          </DialogHeader>

          <div className="space-y-3">
            <div className="rounded-lg border border-white/10 bg-slate-900/40 p-3">
              <div className="text-xs text-slate-300">: <span className="font-semibold text-slate-50">{localCurrentHp}</span> / {localMaxHp}</div>
              <div className="text-xs text-slate-300">: <span className="font-semibold text-slate-50">{localTempHp}</span></div>
            </div>

            <div className="flex items-center gap-2">
              <Button
                type="button"
                variant={hpMode === "damage" ? "default" : "secondary"}
                disabled={isHpPending}
                onClick={() => setHpMode("damage")}
                className={hpMode === "damage" ? "bg-rose-500/30 border text-slate-200 border-rose-400/40 hover:bg-rose-500/50" : "hover:bg-rose-500/50"}
              >
                <Sword className="h-4 w-4 mr-2" />
                
              </Button>
              <Button
                type="button"
                variant={hpMode === "heal" ? "default" : "secondary"}
                disabled={isHpPending}
                onClick={() => setHpMode("heal")}
                className={hpMode === "heal" ? "bg-emerald-500/25 border border-emerald-400/40 text-slate-200 hover:bg-emerald-500/50" : "hover:bg-emerald-500/50"}
              >
                <Heart className="h-4 w-4 mr-2" />
                
              </Button>
              <Button
                type="button"
                variant={hpMode === "temp" ? "default" : "secondary"}
                disabled={isHpPending}
                onClick={() => setHpMode("temp")}
                className={hpMode === "temp" ? "bg-blue-500/25 border border-blue-400/40 text-slate-200 hover:bg-blue-500/50" : "hover:bg-blue-500/50"}
              >
                <Shield className="h-4 w-4 mr-2" />
                .
              </Button>
            </div>

            <div className="space-y-2">
              <Input
                inputMode="numeric"
                pattern="[0-9]*"
                placeholder=" "
                value={hpAmount}
                onChange={(e) => setHpAmount(e.target.value)}
                disabled={isHpPending}
              />
              <Button type="button" onClick={applyHp} disabled={isHpPending || !hpAmount || Number(hpAmount) <= 0} className="w-full bg-slate-300 hover:bg-slate-200 text-slate-900">
                
              </Button>
            </div>

            {localCurrentHp <= 0 ? (
              <div className="rounded-lg border border-white/10 bg-slate-900/40 p-3 space-y-3">
                <div className="text-[10px] uppercase tracking-[0.16em] text-slate-400"> </div>
                <div className="grid grid-cols-2 gap-3">
                  <CircleRow
                    count={deathSuccesses}
                    tone="emerald"
                    label=""
                    onChange={(next) => {
                      setSaves(next, deathFailures);
                    }}
                  />
                  <CircleRow
                    count={deathFailures}
                    tone="rose"
                    label=""
                    onChange={(next) => {
                      setSaves(deathSuccesses, next);
                    }}
                  />
                </div>
                {isDead && (
                <div className="flex items-center justify-center">
                    <Button
                    type="button"
                    variant="destructive"
                    disabled={isHpPending}
                    onClick={() => {
                      const prev = {
                        currentHp: localCurrentHp,
                        deathSaveSuccesses: deathSuccesses,
                        deathSaveFailures: deathFailures,
                        isDead,
                      };

                      // Optimistic revive
                      setLocalCurrentHp(1);
                      setDeathSuccesses(0);
                      setDeathFailures(0);
                      setIsDead(false);

                      startHpTransition(async () => {
                        const res = await reviveCharacter({ persId: pers.persId });
                        if (!res.success) {
                          // Rollback on failure
                          setLocalCurrentHp(prev.currentHp);
                          setDeathSuccesses(prev.deathSaveSuccesses);
                          setDeathFailures(prev.deathSaveFailures);
                          setIsDead(prev.isDead);
                          toast.error("   ", { description: res.error });
                          router.refresh();
                          return;
                        }
                        setLocalCurrentHp(res.currentHp);
                        setDeathSuccesses(res.deathSaveSuccesses);
                        setDeathFailures(res.deathSaveFailures);
                        setIsDead(res.isDead);
                        router.refresh();
                      });
                    }}
                    className="flex justify-center items-center"
                  >
                     (1 HP)
                  </Button>
                </div>
                  
                )}
              </div>
            ) : null}
          </div>
        </DialogContent>
      </Dialog>

      <div className="mt-auto">
        <Button
          type="button"
          variant="secondary"
          className="w-full"
          onClick={() => setDetailsOpen((v) => !v)}
        >
           
        </Button>

        {detailsOpen ? (
          <div className="mt-3 rounded-xl border border-white/10 bg-slate-900/40 p-3 space-y-3">
            {/* Alignment & XP */}
            <div className="grid grid-cols-2 gap-3">
              <div className="space-y-1">
                <div className="text-xs font-semibold text-slate-200"></div>
                <Input
                  value={draftAlignment}
                  onChange={(e) => setDraftAlignment(e.target.value)}
                  disabled={isDetailsPending || isReadOnly}
                  className="bg-slate-950/40 border-white/10 text-slate-100"
                  placeholder={isReadOnly ? "" : ".:  "}
                  maxLength={100}
                />
              </div>
              <div className="space-y-1">
                <div className="text-xs font-semibold text-slate-200"> (XP)</div>
                <Input
                  type="number"
                  inputMode="numeric"
                  value={draftXp}
                  onChange={(e) => setDraftXp(e.target.value)}
                  disabled={isDetailsPending || isReadOnly}
                  className="bg-slate-950/40 border-white/10 text-slate-100"
                  placeholder="0"
                  min={0}
                />
              </div>
            </div>

            {/* Coins */}
            <div className="space-y-1">
              <div className="text-xs font-semibold text-slate-200"></div>
              <div className="grid grid-cols-5 gap-2">
                <div className="space-y-0.5">
                  <div className="text-[10px] text-center text-amber-600 font-bold">CP</div>
                  <Input
                    type="number"
                    inputMode="numeric"
                    value={draftCp}
                    onChange={(e) => setDraftCp(e.target.value)}
                    disabled={isDetailsPending || isReadOnly}
                    className="bg-slate-950/40 border-white/10 text-slate-100 text-center text-sm px-1"
                    min={0}
                  />
                </div>
                <div className="space-y-0.5">
                  <div className="text-[10px] text-center text-slate-400 font-bold">EP</div>
                  <Input
                    type="number"
                    inputMode="numeric"
                    value={draftEp}
                    onChange={(e) => setDraftEp(e.target.value)}
                    disabled={isDetailsPending || isReadOnly}
                    className="bg-slate-950/40 border-white/10 text-slate-100 text-center text-sm px-1"
                    min={0}
                  />
                </div>
                <div className="space-y-0.5">
                  <div className="text-[10px] text-center text-slate-300 font-bold">SP</div>
                  <Input
                    type="number"
                    inputMode="numeric"
                    value={draftSp}
                    onChange={(e) => setDraftSp(e.target.value)}
                    disabled={isDetailsPending || isReadOnly}
                    className="bg-slate-950/40 border-white/10 text-slate-100 text-center text-sm px-1"
                    min={0}
                  />
                </div>
                <div className="space-y-0.5">
                  <div className="text-[10px] text-center text-yellow-400 font-bold">GP</div>
                  <Input
                    type="number"
                    inputMode="numeric"
                    value={draftGp}
                    onChange={(e) => setDraftGp(e.target.value)}
                    disabled={isDetailsPending || isReadOnly}
                    className="bg-slate-950/40 border-white/10 text-slate-100 text-center text-sm px-1"
                    min={0}
                  />
                </div>
                <div className="space-y-0.5">
                  <div className="text-[10px] text-center text-cyan-300 font-bold">PP</div>
                  <Input
                    type="number"
                    inputMode="numeric"
                    value={draftPp}
                    onChange={(e) => setDraftPp(e.target.value)}
                    disabled={isDetailsPending || isReadOnly}
                    className="bg-slate-950/40 border-white/10 text-slate-100 text-center text-sm px-1"
                    min={0}
                  />
                </div>
              </div>
            </div>

            <div className="space-y-1">
              <div className="text-xs font-semibold text-slate-200"> (//)</div>
              <textarea
                value={draftProficiencies}
                onChange={(e) => setDraftProficiencies(e.target.value)}
                disabled={isDetailsPending || isReadOnly}
                className="w-full min-h-[64px] rounded-md border border-white/10 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 outline-none focus:ring-1 focus:ring-white/20"
                placeholder={isReadOnly ? "" : ".: / ,  ,  "}
              />
            </div>

            <div className="space-y-1">
              <div className="flex items-center justify-between gap-2">
                <div className="text-xs font-semibold text-slate-200"></div>
                <Button type="button" size="sm" variant="secondary" onClick={() => setLanguagesOpen(true)}>
                   
                </Button>
              </div>
              <textarea
                value={draftLanguages}
                onChange={(e) => setDraftLanguages(e.target.value)}
                disabled={isDetailsPending || isReadOnly}
                className="w-full min-h-[56px] rounded-md border border-white/10 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 outline-none focus:ring-1 focus:ring-white/20"
                placeholder={isReadOnly ? "" : ".: , "}
              />
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div className="space-y-1">
                <div className="text-xs font-semibold text-slate-200"> </div>
                <textarea
                  value={draftTraits}
                  onChange={(e) => setDraftTraits(e.target.value)}
                  disabled={isDetailsPending}
                  className="w-full min-h-[64px] rounded-md border border-white/10 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 outline-none focus:ring-1 focus:ring-white/20"
                />
              </div>
              <div className="space-y-1">
                <div className="text-xs font-semibold text-slate-200"></div>
                <textarea
                  value={draftIdeals}
                  onChange={(e) => setDraftIdeals(e.target.value)}
                  disabled={isDetailsPending}
                  className="w-full min-h-[64px] rounded-md border border-white/10 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 outline-none focus:ring-1 focus:ring-white/20"
                />
              </div>
              <div className="space-y-1">
                <div className="text-xs font-semibold text-slate-200"></div>
                <textarea
                  value={draftBonds}
                  onChange={(e) => setDraftBonds(e.target.value)}
                  disabled={isDetailsPending}
                  className="w-full min-h-[64px] rounded-md border border-white/10 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 outline-none focus:ring-1 focus:ring-white/20"
                />
              </div>
              <div className="space-y-1">
                <div className="text-xs font-semibold text-slate-200"></div>
                <textarea
                  value={draftFlaws}
                  onChange={(e) => setDraftFlaws(e.target.value)}
                  disabled={isDetailsPending}
                  className="w-full min-h-[64px] rounded-md border border-white/10 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 outline-none focus:ring-1 focus:ring-white/20"
                />
              </div>
            </div>

            <div className="space-y-1">
              <div className="text-xs font-semibold text-slate-200"></div>
              <textarea
                value={draftBackstory}
                onChange={(e) => setDraftBackstory(e.target.value)}
                disabled={isDetailsPending}
                className="w-full min-h-[120px] rounded-md border border-white/10 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 outline-none focus:ring-1 focus:ring-white/20"
              />
            </div>

            <div className="space-y-1">
              <div className="text-xs font-semibold text-slate-200"></div>
              <textarea
                value={draftNotes}
                onChange={(e) => setDraftNotes(e.target.value)}
                disabled={isDetailsPending}
                className="w-full min-h-[120px] rounded-md border border-white/10 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 outline-none focus:ring-1 focus:ring-white/20"
              />
            </div>
          </div>
        ) : null}
      </div>

      <Dialog open={languagesOpen} onOpenChange={setLanguagesOpen}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="text-lg"></DialogTitle>
          </DialogHeader>

          <div className="max-h-[50vh] overflow-y-auto space-y-2">
            {Object.entries(LanguageTranslations).map(([key, label]) => {
              const checked = selectedLanguages.has(label) || selectedLanguages.has(key);
              return (
                <label key={key} className="flex items-center gap-2 rounded-md border border-white/10 bg-white/5 px-3 py-2">
                  <input
                    type="checkbox"
                    checked={checked}
                    onChange={(e) => {
                      setSelectedLanguages((prev) => {
                        const next = new Set(prev);
                        if (e.target.checked) next.add(label);
                        else next.delete(label);
                        return next;
                      });
                    }}
                  />
                  <span className="text-sm text-slate-100">{label}</span>
                </label>
              );
            })}
          </div>

          <div className="flex items-center justify-end gap-2">
            <Button type="button" variant="secondary" onClick={() => setLanguagesOpen(false)}>
              
            </Button>
            <Button
              type="button"
              onClick={() => {
                const list = Array.from(selectedLanguages);
                const text = list.join(", ");
                setDraftLanguages(text);
                setLanguagesOpen(false);
              }}
            >
              
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Modify Stat Modal */}
      <ModifyStatModal
        open={modifyOpen}
        onOpenChange={setModifyOpen}
        pers={pers}
        onPersUpdate={handlePersUpdate}
        config={modifyConfig}
      />
    </div>
  );
}
</file>

<file path="src/lib/components/characterSheet/slides/SkillsSlide.tsx">
"use client";

import { useState, useCallback } from "react";
import { PersWithRelations } from "@/lib/actions/pers";
import { formatModifier } from "@/lib/logic/utils";
import { Skills } from "@prisma/client";
import { ModifyConfig } from "../ModifyStatModal";
import ModifyStatModal from "../ModifyStatModal";
import {
  calculateFinalSkill,
  hasSkillBonus,
} from "@/lib/logic/bonus-calculator";
import { bonusTranslations, skillTranslations } from "@/lib/refs/translation";

interface SkillsSlideProps {
  pers: PersWithRelations;
  onPersUpdate?: (next: PersWithRelations) => void;
  isReadOnly?: boolean;
}

export default function SkillsSlide({ pers, onPersUpdate, isReadOnly }: SkillsSlideProps) {
  // Bonus modification modal state
  const [modifyOpen, setModifyOpen] = useState(false);
  const [modifyConfig, setModifyConfig] = useState<ModifyConfig | null>(null);

  // Helper to open modify modal
  const openModify = useCallback((skill: Skills) => {
    setModifyConfig({ type: 'skill', skill });
    setModifyOpen(true);
  }, []);

  // Helper for pers updates
  const handlePersUpdate = useCallback((next: PersWithRelations) => {
    onPersUpdate?.(next);
  }, [onPersUpdate]);

  const allSkills = [
    // STR
    { ability: "STR", skill: Skills.ATHLETICS },
    // DEX
    { ability: "DEX", skill: Skills.ACROBATICS },
    { ability: "DEX", skill: Skills.SLEIGHT_OF_HAND },
    { ability: "DEX", skill: Skills.STEALTH },
    // INT
    { ability: "INT", skill: Skills.ARCANA },
    { ability: "INT", skill: Skills.HISTORY },
    { ability: "INT", skill: Skills.INVESTIGATION },
    { ability: "INT", skill: Skills.NATURE },
    { ability: "INT", skill: Skills.RELIGION },
    // WIS
    { ability: "WIS", skill: Skills.ANIMAL_HANDLING },
    { ability: "WIS", skill: Skills.INSIGHT },
    { ability: "WIS", skill: Skills.MEDICINE },
    { ability: "WIS", skill: Skills.PERCEPTION },
    { ability: "WIS", skill: Skills.SURVIVAL },
    // CHA
    { ability: "CHA", skill: Skills.DECEPTION },
    { ability: "CHA", skill: Skills.INTIMIDATION },
    { ability: "CHA", skill: Skills.PERFORMANCE },
    { ability: "CHA", skill: Skills.PERSUASION },
  ];

  let lastAbility = "";

  return (
    <div className="h-full p-4">
      <div className="space-y-0">
        {allSkills.map((skillInfo) => {
          const { total, proficiency } = calculateFinalSkill(pers, skillInfo.skill);
          const isProficient = proficiency !== "NONE";
          const hasBonus = hasSkillBonus(pers, skillInfo.skill);
          const showHeader = lastAbility !== skillInfo.ability;
          if (showHeader) lastAbility = skillInfo.ability;

          return (
            <div key={skillInfo.skill}>
              {showHeader && (
                <div className="text-[10px] font-bold uppercase tracking-wider text-indigo-400/80 mt-3 mb-1 px-2">
                  {bonusTranslations.statNames[skillInfo.ability as keyof typeof bonusTranslations.statNames]}
                </div>
              )}
              <button
                type="button"
                onClick={() => !isReadOnly && openModify(skillInfo.skill)}
                className={`w-full text-left ${isReadOnly ? 'cursor-default' : ''}`}
              >
                <div
                  className={`flex justify-between items-center h-8 px-3 rounded transition-all hover:bg-white/5 ${
                    isProficient
                      ? "bg-cyan-500/10 border-l-2 border-cyan-400/60"
                      : "bg-slate-800/25 border-l-2 border-slate-700/40"
                  } ${hasBonus ? "ring-1 ring-amber-400/40" : ""}`}
                >
                  <div className="flex items-center gap-2">
                    {proficiency === "EXPERTISE" && (
                      <div className="w-1.5 h-1.5 rounded-full bg-amber-400 shadow-[0_0_4px_rgba(251,191,36,0.8)]" />
                    )}
                    {proficiency === "PROFICIENT" && (
                      <div className="w-1.5 h-1.5 rounded-full bg-cyan-400 shadow-[0_0_4px_rgba(34,211,238,0.6)]" />
                    )}
                    <span
                      className={`text-sm transition ${
                        isProficient ? "text-slate-50 opacity-100 font-medium" : "text-slate-300/80"
                      }`}
                    >
                      {skillTranslations[skillInfo.skill] ?? skillInfo.skill}
                    </span>
                  </div>
                  <span
                    className={`text-sm font-bold transition ${
                      proficiency === "EXPERTISE"
                        ? "text-amber-300 opacity-100"
                        : proficiency === "PROFICIENT"
                          ? "text-cyan-300 opacity-100"
                          : "text-slate-300/70"
                    }`}
                  >
                    {formatModifier(total)}
                  </span>
                </div>
              </button>
            </div>
          );
        })}
      </div>

      {/* Modify Skill Modal */}
      <ModifyStatModal
        open={modifyOpen}
        onOpenChange={setModifyOpen}
        pers={pers}
        onPersUpdate={handlePersUpdate}
        config={modifyConfig}
      />
    </div>
  );
}
</file>

<file path="src/lib/components/characterSheet/CharacterSheet.tsx">
"use client";

import { useEffect, useState } from "react";
import { PersWithRelations } from "@/lib/actions/pers";
import CharacterCarousel from "./CharacterCarousel";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { ArrowUpCircle } from "lucide-react";
import { CharacterFeaturesGroupedResult } from "@/lib/actions/pers";
import RestButton from "./RestButton";
import { Badge } from "@/components/ui/badge";
import { ShareDialog } from "./ShareDialog";
import { useParams, useRouter } from "next/navigation";
import { copyPersByToken } from "@/lib/actions/share-actions";
import { Copy } from "lucide-react";
import { toast } from "sonner";
import { useTransition } from "react";
import PrintCharacterDialog from "./PrintCharacterDialog";

interface CharacterSheetProps {
  pers: PersWithRelations;
  groupedFeatures: CharacterFeaturesGroupedResult | null;
  isPublicView?: boolean;
}

export default function CharacterSheet({ pers, groupedFeatures, isPublicView }: CharacterSheetProps) {
  const [localPers, setLocalPers] = useState<PersWithRelations>(pers);
  const isReadOnly = isPublicView || pers.isSnapshot;
  const params = useParams();
  const router = useRouter();
  const [isCopyPending, startCopyTransition] = useTransition();

  useEffect(() => {
    setLocalPers(pers);
  }, [pers]);

  const handleCopyToProfile = () => {
    const token = params?.token as string;
    if (!token) return;

    startCopyTransition(async () => {
        const result = await copyPersByToken(token);
        if (result.success && result.persId) {
            toast.success("    !");
            router.push(`/pers/${result.persId}`);
        } else {
            toast.error(result.error || "   ");
        }
    });
  };

  return (
    <div className="h-screen w-full bg-slate-900 flex flex-col">
      <div className="p-3 px-4 border-b border-white/10 flex justify-between items-center bg-slate-900/70 backdrop-blur sticky top-0 z-20">
           <div className="flex items-center gap-3">
             <div>
               <div className="font-bold text-base md:text-lg text-slate-50">{localPers.name}</div>
               <div className="text-xs text-slate-300/80"> {localPers.level}</div>
             </div>
             {isReadOnly && (
               <Badge variant="outline" className="bg-amber-500/10 text-amber-500 border-amber-500/20">
                 {isPublicView ? "  " : `:  ${pers.snapshotLevel || pers.level}`}
               </Badge>
             )}
           </div>
           <div className="flex items-center gap-2">
               {isPublicView && (
                   <Button 
                       size="sm" 
                       variant="secondary" 
                       className="h-8 gap-2 bg-emerald-600/20 hover:bg-emerald-600/30 border-emerald-500/30 text-emerald-400"
                       onClick={handleCopyToProfile}
                       disabled={isCopyPending}
                   >
                       <Copy className="w-4 h-4" />
                       <span className="hidden sm:inline">  </span>
                   </Button>
               )}
              {!isPublicView && (
              <PrintCharacterDialog
                persId={localPers.persId}
                characterName={localPers.name ?? "character"}
                disabled={isCopyPending}
              />
              )}
               {!isReadOnly && <ShareDialog persId={localPers.persId} initialToken={localPers.shareToken} />}
               {!isReadOnly && <RestButton pers={localPers} onPersUpdate={setLocalPers} />}
               {!isReadOnly && (
                 <Link href={`/pers/${localPers.persId}/levelup`}>
                     <Button size="sm" variant="secondary" className="h-8 gap-2 bg-indigo-600/20 hover:bg-indigo-600/30 border-indigo-500/30">
                         <ArrowUpCircle className="w-4 h-4" />
                         <span className="hidden sm:inline"> </span>
                     </Button>
                 </Link>
               )}
           </div>
       </div>
      
      <div className="flex-1 overflow-hidden">
        <CharacterCarousel pers={localPers} onPersUpdate={setLocalPers} groupedFeatures={groupedFeatures} isReadOnly={isReadOnly} />
      </div>
    </div>
  );
}
</file>

<file path="src/lib/components/characterSheet/CombatPage.tsx">
"use client";

import { useState } from "react";
import { PersWithRelations, PersWeaponWithWeapon, PersArmorWithArmor } from "@/lib/actions/pers";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { getAbilityMod, formatModifier, getProficiencyBonus } from "@/lib/logic/utils";
// bonus-calculator imports removed if only used for removed stats
import { 
  weaponTranslations, 
  damageTypeTranslations, 
  armorTypeTranslations, 
  armorTranslations 
} from "@/lib/refs/translation";
import { Sword, Shield, Settings2 } from "lucide-react";
import AddWeaponDialog from "./AddWeaponDialog";
import AddArmorDialog from "./AddArmorDialog";
import WeaponCustomizeModal from "./WeaponCustomizeModal";
import ArmorCustomizeModal from "./ArmorCustomizeModal";
import { Button } from "@/components/ui/button";
import { updateShieldStatus } from "@/lib/actions/equipment-actions";
import { Switch } from "@/components/ui/switch";
import { Label } from "@/components/ui/label";
import { toast } from "sonner";

export default function CombatPage({ pers, isReadOnly }: { pers: PersWithRelations, isReadOnly?: boolean }) {
// Redundant stats removed

  const [selectedWeapon, setSelectedWeapon] = useState<PersWeaponWithWeapon | null>(null);
  const [selectedArmor, setSelectedArmor] = useState<PersArmorWithArmor | null>(null);

  const handleShieldToggle = async (val: boolean) => {
    const res = await updateShieldStatus(pers.persId, { wearsShield: val });
    if (res.success) {
      toast.success(val ? " " : " ");
    } else {
      toast.error(res.error);
    }
  };

  const getAttackBonus = (pw: PersWeaponWithWeapon) => {
    const ability = (pw.customDamageAbility?.toLowerCase() || (pw.weapon?.isRanged ? "dex" : "str")) as any;
    const mod = getAbilityMod(pers[ability as keyof typeof pers] as number);
    const attackBonus = (pw.isProficient ? getProficiencyBonus(pers.level) : 0) + mod + (pw.attackBonus || 0);
    return attackBonus;
  };

  const getDamageBonus = (pw: PersWeaponWithWeapon) => {
    const ability = (pw.customDamageAbility?.toLowerCase() || (pw.weapon?.isRanged ? "dex" : "str")) as any;
    const mod = getAbilityMod(pers[ability as keyof typeof pers] as number);
    const damageBonus = mod + ((pw.customDamageBonus as number) || 0);
    return damageBonus;
  };

  return (
    <div className="space-y-4 pb-8">
      {/* Redundant stats grid removed - they are already visible in global stats and header */}

      {/* Weapons Section */}
      <Card className="bg-slate-900/50 border-white/10 overflow-hidden">
        <CardHeader className="p-4 flex flex-row items-center justify-between border-b border-white/5 bg-white/5">
          <CardTitle className="text-base font-bold flex items-center gap-2 text-indigo-300 uppercase tracking-wider">
            <Sword className="w-5 h-5" />
              
          </CardTitle>
          {!isReadOnly && <AddWeaponDialog persId={pers.persId} />}
        </CardHeader>
        <CardContent className="p-2 space-y-2">
          {pers.weapons.length > 0 ? (
            pers.weapons.map((pw) => (
              <div 
                key={pw.persWeaponId}
                className="flex items-center justify-between p-3 rounded-lg border border-white/5 bg-slate-800/40 hover:bg-slate-800/60 transition group"
              >
                <div className="flex-1 min-w-0">
                  <div className="font-bold text-slate-50 flex items-center gap-2">
                    <span className="truncate">{pw.overrideName || (weaponTranslations[pw.weapon?.name as keyof typeof weaponTranslations] || pw.weapon?.name)}</span>
                    {pw.isMagical && <span className="text-[10px] bg-amber-500/20 text-amber-300 px-1.5 py-0.5 rounded border border-amber-500/30 flex-shrink-0">MAG</span>}
                  </div>
                  <div className="text-xs text-slate-400 flex items-center gap-2 mt-0.5">
                    <span className="text-amber-400 font-bold text-sm">
                      {pw.customDamageDice || pw.weapon?.damage}{formatModifier(getDamageBonus(pw))}
                    </span>
                    <span className="text-slate-600"></span>
                    <span className="truncate">
                      {damageTypeTranslations[pw.weapon?.damageType as keyof typeof damageTypeTranslations] || pw.weapon?.damageType}
                    </span>
                  </div>
                </div>

                <div className="flex items-center gap-3 sm:gap-4 ml-2">
                  <div className="text-center">
                    <div className="text-xl font-black text-slate-50 leading-none">{formatModifier(getAttackBonus(pw))}</div>
                    <div className="text-[9px] uppercase font-bold text-slate-500 mt-0.5"></div>
                  </div>
                  {!isReadOnly && (
                    <Button 
                      variant="ghost" 
                      size="icon" 
                      className="h-8 w-8 text-slate-500 hover:text-indigo-400 transition-colors"
                      onClick={(e) => {
                          e.stopPropagation();
                          setSelectedWeapon(pw as PersWeaponWithWeapon);
                      }}
                    >
                      <Settings2 className="w-4 h-4" />
                    </Button>
                  )}
                </div>
              </div>
            ))
          ) : (
            <div className="text-center py-6 text-slate-500 text-sm">  </div>
          )}
        </CardContent>
      </Card>

      {/* Armor Section */}
      <Card className="bg-slate-900/50 border-white/10 overflow-hidden">
        <CardHeader className="p-4 flex flex-row items-center justify-between border-b border-white/5 bg-white/5">
          <CardTitle className="text-base font-bold flex items-center gap-2 text-indigo-300 uppercase tracking-wider">
            <Shield className="w-5 h-5" />
              
          </CardTitle>
          {!isReadOnly && <AddArmorDialog persId={pers.persId} />}
        </CardHeader>
        <CardContent className="p-2 space-y-4">
          <div className="space-y-2">
            {pers.armors.length > 0 ? (
              pers.armors.map((pa) => (
                <div 
                  key={pa.persArmorId}
                  className={`flex items-center justify-between p-3 rounded-lg border transition ${
                    pa.equipped 
                      ? 'bg-indigo-500/10 border-indigo-500/30' 
                      : 'bg-slate-800/40 border-white/5 opacity-70 hover:opacity-100'
                  }`}
                >
                  <div className="flex-1">
                    <div className="font-bold text-slate-50 flex items-center gap-2">
                      {armorTranslations[pa.armor?.name as keyof typeof armorTranslations] || pa.armor?.name || " "}
                      {pa.equipped && <span className="text-[10px] bg-indigo-500 text-white px-1.5 py-0.5 rounded uppercase font-bold"></span>}
                    </div>
                    <div className="text-xs text-slate-400">
                      {armorTypeTranslations[pa.armor?.armorType as keyof typeof armorTypeTranslations] || pa.armor?.armorType}
                      {pa.miscACBonus && pa.miscACBonus !== 0 && `  ${formatModifier(pa.miscACBonus)} `}
                    </div>
                  </div>

                  <div className="flex items-center gap-3 sm:gap-4 ml-2">
                    <div className="text-center">
                      <div className="text-[10px] uppercase font-bold text-slate-500 line-height-none mb-0.5">. </div>
                      <div className="text-xl font-black text-slate-50 leading-none">
                        {pa.overrideBaseAC ?? pa.armor?.baseAC}
                      </div>
                    </div>
                  {!isReadOnly && (
                    <Button 
                      variant="ghost" 
                      size="icon" 
                      className="h-8 w-8 text-slate-500 hover:text-indigo-400 transition-colors"
                      onClick={(e) => {
                          e.stopPropagation();
                          setSelectedArmor(pa as PersArmorWithArmor);
                      }}
                    >
                      <Settings2 className="w-4 h-4" />
                    </Button>
                  )}
                  </div>
                </div>
              ))
            ) : (
              <div className="text-center py-4 text-slate-500 text-sm">  </div>
            )}
          </div>

          {/* Shield Toggle */}
          <div className="flex items-center justify-between p-4 rounded-xl bg-slate-800/60 border border-white/10">
            <div className="flex items-center gap-3">
              <div className={`p-2 rounded-lg ${pers.wearsShield ? 'bg-indigo-500 text-white' : 'bg-white/5 text-slate-400'}`}>
                <Shield className="w-5 h-5" />
              </div>
              <div>
                <Label className="font-bold text-slate-50"> </Label>
                <p className="text-xs text-slate-400"> +2   ( )</p>
              </div>
            </div>
            <Switch 
              checked={pers.wearsShield} 
              onCheckedChange={!isReadOnly ? handleShieldToggle : undefined}
              disabled={isReadOnly}
            />
          </div>
        </CardContent>
      </Card>

      {/* Modals */}
      {selectedWeapon && (
        <WeaponCustomizeModal 
          persWeapon={selectedWeapon as any} 
          open={!!selectedWeapon} 
          onOpenChange={(open) => !open && setSelectedWeapon(null)} 
        />
      )}
      {selectedArmor && (
        <ArmorCustomizeModal 
          persArmor={selectedArmor as any} 
          open={!!selectedArmor} 
          onOpenChange={(open) => !open && setSelectedArmor(null)} 
        />
      )}
    </div>
  );
}
</file>

<file path="src/lib/components/characterSheet/FeaturesPage.tsx">
"use client";

import { PersWithRelations } from "@/lib/actions/pers";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { raceTranslations, classTranslations, subclassTranslations, subraceTranslations, backgroundTranslations, featTranslations } from "@/lib/refs/translation";
import { useState, useTransition } from "react";
import { InfoDialog, InfoGrid, InfoPill, InfoSectionTitle } from "@/lib/components/characterCreator/EntityInfoDialog";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { FormattedDescription } from "@/components/ui/FormattedDescription";
import { useModalBackButton } from "@/hooks/useModalBackButton";
import { FeatureDisplayType, RestType } from "@prisma/client";
import { spendFeatureUse, restoreFeatureUse } from "@/lib/actions/feature-uses";
import { toast } from "sonner";
import { Minus, Plus, Info } from "lucide-react";
import { getProficiencyBonus } from "@/lib/logic/utils";

const stripMarkdownPreview = (value: string) => {
  return value
    .replace(/\r\n/g, "\n")
    .replace(/<a\s+[^>]*>(.*?)<\/a>/gi, "$1")
    .replace(/<[^>]+>/g, " ")
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, "$1")
    .replace(/`{1,3}([^`]+)`{1,3}/g, "$1")
    .replace(/\*\*([^*]+)\*\*/g, "$1")
    .replace(/__([^_]+)__/g, "$1")
    .replace(/\*([^*]+)\*/g, "$1")
    .replace(/_([^_]+)_/g, "$1")
    .replace(/^#{1,6}\s+/gm, "")
    .replace(/^>\s?/gm, "")
    .replace(/^\s*[-*+]\s+/gm, "")
    .replace(/^\s*\d+\.\s+/gm, "")
    .replace(/\s+/g, " ")
    .trim();
};

interface FeatureItem {
  featureId: number;
  name: string;
  description: string;
  shortDescription?: string | null;
  displayType: FeatureDisplayType[];
  limitedUsesPer: RestType | null;
  usesCount: number | null;
  usesRemaining: number | null;
  source: string;
}

export default function FeaturesPage({ pers }: { pers: PersWithRelations }) {
  const [selectedFeature, setSelectedFeature] = useState<{ name: string; description: string } | null>(null);
  const [isPending, startTransition] = useTransition();

  useModalBackButton(!!selectedFeature, () => setSelectedFeature(null));
  
  const raceName = raceTranslations[pers.race.name as keyof typeof raceTranslations] || pers.race.name;
  const className = classTranslations[pers.class.name as keyof typeof classTranslations] || pers.class.name;
  const subclassName = pers.subclass ? (subclassTranslations[pers.subclass.name as keyof typeof subclassTranslations] || pers.subclass.name) : null;
  const subraceName = pers.subrace ? (subraceTranslations[pers.subrace.name as keyof typeof subraceTranslations] || pers.subrace.name) : null;
  const backgroundName = backgroundTranslations[pers.background.name as keyof typeof backgroundTranslations] || pers.background.name;

  // Collect all features from various sources
  const featureMap = new Map<number, FeatureItem>();

  // Helper to add/update feature in map
  const addFeature = (f: any, source: string, pf?: any) => {
    if (!f) return;
    const existing = featureMap.get(f.featureId);
    
    // If we have a PersFeature (pf), it takes priority for usesRemaining
    const usesRemaining = pf ? pf.usesRemaining : (existing?.usesRemaining ?? null);
    
    // Calculate max uses if it depends on proficiency
    let maxUses = f.usesCount;
    if (f.usesCountDependsOnProficiencyBonus) {
        maxUses = getProficiencyBonus(pers.level);
    }

    featureMap.set(f.featureId, {
      featureId: f.featureId,
      name: f.name,
      description: f.description,
      shortDescription: f.shortDescription,
      displayType: f.displayType || [],
      limitedUsesPer: f.limitedUsesPer,
      usesCount: maxUses,
      usesRemaining: usesRemaining,
      source: existing ? `${existing.source}, ${source}` : source
    });
  };

  // Base Class Features
  pers.class.features.forEach(cf => addFeature(cf.feature, 'class'));
  
  // Subclass Features
  if (pers.subclass) {
    pers.subclass.features.forEach(sf => addFeature(sf.feature, 'subclass'));
  }

  // Race Traits
  pers.race.traits.forEach(rt => addFeature(rt.feature, 'race'));
  
  // Subrace Traits
  if (pers.subrace) {
    pers.subrace.traits.forEach(st => addFeature(st.feature, 'subrace'));
  }

  // Pers Features (includes choices and manually added)
  pers.features.forEach(pf => addFeature(pf.feature, 'feature', pf));

  // Feats
  pers.feats.forEach(pf => {
    // A feat itself might not be into featureMap if it doesn't have a linked Feature entity in the same way,
    // but the model shows Feat has grantsByFeat relation.
    // For now, let's keep the existing logic for feats as they are usually passive names.
  });

  const allFeatures = Array.from(featureMap.values());

  // Filter and group
  const classResources = allFeatures.filter(f => f.displayType.includes(FeatureDisplayType.CLASS_RESOURCE));
  const otherFeatures = allFeatures.filter(f => !f.displayType.includes(FeatureDisplayType.CLASS_RESOURCE) && !f.displayType.includes(FeatureDisplayType.HIDDEN));

  const handleSpend = (featureId: number) => {
    startTransition(async () => {
      const res = await spendFeatureUse({ persId: pers.persId, featureId });
      if (res.success) {
        // revalidatePath handles UI update
      } else {
        toast.error(res.error);
      }
    });
  };

  const handleRestore = (featureId: number) => {
    startTransition(async () => {
      const res = await restoreFeatureUse({ persId: pers.persId, featureId });
      if (res.success) {
          // revalidatePath handles UI update
      } else {
          toast.error(res.error);
      }
    });
  };

  return (
    <div className="h-full flex flex-col space-y-4 pb-10">
      {/* Entity Grid - 2 columns */}
      <div className="grid grid-cols-2 gap-2">
        <EntityCard 
          title={className} 
          subtitle={subclassName || undefined}
          type="class"
          entity={pers.class}
          subEntity={pers.subclass}
          persLevel={pers.level}
        />
        <EntityCard 
          title={raceName} 
          subtitle={subraceName || undefined}
          type="race"
          entity={pers.race}
          subEntity={pers.subrace}
          persLevel={pers.level}
        />
        <div className="col-span-2">
            <EntityCard 
                title={backgroundName}
                type="background"
                entity={pers.background}
                persLevel={pers.level}
            />
        </div>
      </div>

      {/* Class Resources Section */}
      {classResources.length > 0 && (
        <div className="space-y-2">
          <h3 className="text-sm font-bold text-purple-300 uppercase tracking-wider px-1"> </h3>
          <div className="grid grid-cols-1 gap-2">
            {classResources.map(feature => (
              <ResourceCard 
                key={feature.featureId} 
                feature={feature} 
                onSpend={() => handleSpend(feature.featureId)}
                onRestore={() => handleRestore(feature.featureId)}
                onInfo={() => setSelectedFeature(feature)}
                isPending={isPending}
              />
            ))}
          </div>
        </div>
      )}

      {/* Other Features List */}
      <div className="space-y-2">
        <h3 className="text-sm font-bold text-purple-300 uppercase tracking-wider px-1">  </h3>
        <div className="space-y-2">
          {otherFeatures.sort((a, b) => a.name.localeCompare(b.name)).map((feature) => (
            <FeatureCard 
              key={feature.featureId} 
              feature={feature} 
              onSpend={() => handleSpend(feature.featureId)}
              onRestore={() => handleRestore(feature.featureId)}
              onClick={() => setSelectedFeature(feature)}
              isPending={isPending}
            />
          ))}
          
          {/* Add feats that aren't in featureMap */}
          {pers.feats.map(pf => (
            <button
              key={pf.persFeatId}
              onClick={() => setSelectedFeature({ 
                name: featTranslations[pf.feat.name as keyof typeof featTranslations] || pf.feat.name, 
                description: pf.feat.description 
              })}
              className="w-full text-left px-4 py-3 rounded-xl border border-amber-400/20 bg-amber-900/10 hover:bg-amber-800/20 hover:border-amber-400/40 transition group"
            >
              <div className="flex justify-between items-center">
                <span className="font-bold text-amber-100">{featTranslations[pf.feat.name as keyof typeof featTranslations] || pf.feat.name}</span>
                <span className="text-[10px] bg-amber-500/20 text-amber-300 px-2 py-0.5 rounded uppercase font-bold tracking-tighter"></span>
              </div>
            </button>
          ))}
        </div>
      </div>

      {/* Feature Detail Modal */}
      <Dialog open={!!selectedFeature} onOpenChange={() => setSelectedFeature(null)}>
        <DialogContent className="max-w-2xl border border-purple-400/30 bg-purple-950/95 backdrop-blur text-purple-50">
          <DialogHeader>
            <DialogTitle className="text-xl font-semibold text-purple-100">{selectedFeature?.name}</DialogTitle>
          </DialogHeader>
          <div className="max-h-96 overflow-y-auto pr-2 custom-scrollbar">
            {selectedFeature?.description ? (
              <FormattedDescription
                content={selectedFeature.description}
                className="text-sm text-purple-200"
              />
            ) : null}
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}

function ResourceCard({ feature, onSpend, onRestore, onInfo, isPending }: { 
    feature: FeatureItem, 
    onSpend: () => void, 
    onRestore: () => void,
    onInfo: () => void,
    isPending: boolean
}) {
    const hasTracker = feature.limitedUsesPer && feature.usesCount !== null;

    return (
        <Card className="bg-purple-900/20 border-purple-500/30 backdrop-blur-sm overflow-hidden border-l-4 border-l-purple-500">
            <CardContent className="p-3 flex items-center justify-between gap-3">
                <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2">
                        <div className="font-bold text-purple-50 truncate">{feature.name}</div>
                        <button onClick={onInfo} className="p-1 rounded-full hover:bg-white/10 text-purple-400 transition">
                            <Info className="w-3.5 h-3.5" />
                        </button>
                    </div>
                    {feature.shortDescription && (
                        <div className="text-[11px] text-purple-300/80 truncate">
                            {stripMarkdownPreview(feature.shortDescription)}
                        </div>
                    )}
                </div>

                {hasTracker && (
                    <div className="flex items-center gap-2 bg-black/20 rounded-lg p-1 border border-white/5">
                        <Button 
                            variant="ghost" 
                            size="icon" 
                            className="h-7 w-7 rounded-md hover:bg-white/10 text-purple-300" 
                            onClick={onSpend}
                            disabled={isPending || (feature.usesRemaining ?? 0) <= 0}
                        >
                            <Minus className="w-4 h-4" />
                        </Button>
                        <div className="px-2 text-center min-w-[3rem]">
                            <div className="text-xs font-bold text-white leading-none">
                                {feature.usesRemaining ?? feature.usesCount} / {feature.usesCount}
                            </div>
                            <div className="text-[8px] uppercase font-bold text-purple-400 mt-0.5">uses</div>
                        </div>
                        <Button 
                            variant="ghost" 
                            size="icon" 
                            className="h-7 w-7 rounded-md hover:bg-white/10 text-purple-300" 
                            onClick={onRestore}
                            disabled={isPending || (feature.usesRemaining ?? 0) >= (feature.usesCount ?? 0)}
                        >
                            <Plus className="w-4 h-4" />
                        </Button>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}

function FeatureCard({ feature, onSpend, onRestore, onClick, isPending }: { 
    feature: FeatureItem, 
    onSpend: () => void, 
    onRestore: () => void,
    onClick: () => void,
    isPending: boolean
}) {
  const hasTracker = feature.limitedUsesPer && feature.usesCount !== null;
  const isClass = feature.source.includes('class') || feature.source.includes('subclass');

  return (
    <div 
      className={`p-4 rounded-xl border transition group animate-in fade-in slide-in-from-bottom-2 ${
        isClass 
          ? 'bg-purple-900/10 border-purple-500/20 hover:border-purple-500/40' 
          : 'bg-slate-900/30 border-white/10 hover:border-white/20'
      }`}
    >
        <div className="flex items-start justify-between gap-3">
            <div className="flex-1 min-w-0 cursor-pointer" onClick={onClick}>
                <div className="flex items-center gap-2 mb-1">
                    <span className="font-bold text-slate-100 group-hover:text-purple-200 transition">{feature.name}</span>
                    <span className={`text-[10px] px-1.5 py-0.5 rounded uppercase font-bold tracking-tight ${
                        isClass ? 'bg-purple-500/20 text-purple-300 border border-purple-500/30' : 'bg-slate-500/20 text-slate-400 border border-slate-500/30'
                    }`}>
                        {isClass ? '' : ''}
                    </span>
                </div>
                {feature.shortDescription ? (
                    <div className="text-xs text-slate-400 line-clamp-2">
                        {stripMarkdownPreview(feature.shortDescription)}
                    </div>
                ) : (
                    <div className="text-[10px] italic text-slate-500">  ...</div>
                )}
            </div>

            {hasTracker && (
                <div className="flex flex-col items-center gap-1.5 bg-black/30 rounded-xl p-1.5 border border-white/5 shrink-0">
                    <div className="flex items-center gap-1">
                        <Button 
                            variant="ghost" 
                            size="icon" 
                            className="h-6 w-6 rounded-lg hover:bg-white/10 text-white" 
                            onClick={(e) => { e.stopPropagation(); onSpend(); }}
                            disabled={isPending || (feature.usesRemaining ?? 0) <= 0}
                        >
                            <Minus className="w-3 h-3" />
                        </Button>
                        <div className="px-1 text-center min-w-[2.5rem]">
                            <span className="text-xs font-black text-white">
                                {feature.usesRemaining ?? feature.usesCount} / {feature.usesCount}
                            </span>
                        </div>
                        <Button 
                            variant="ghost" 
                            size="icon" 
                            className="h-6 w-6 rounded-lg hover:bg-white/10 text-white" 
                            onClick={(e) => { e.stopPropagation(); onRestore(); }}
                            disabled={isPending || (feature.usesRemaining ?? 0) >= (feature.usesCount ?? 0)}
                        >
                            <Plus className="w-3 h-3" />
                        </Button>
                    </div>
                </div>
            )}
        </div>
    </div>
  );
}

interface EntityCardProps {
  title: string;
  subtitle?: string;
  type: 'class' | 'race' | 'background';
  entity: any;
  subEntity?: any;
  persLevel: number;
}

function EntityCard({ title, subtitle, type, entity, subEntity, persLevel }: EntityCardProps) {
  return (
    <Card className="relative bg-white/5 border-white/10 backdrop-blur hover:bg-white/10 hover:border-purple-500/30 transition cursor-pointer group overflow-hidden">
      <CardContent className="p-3">
        <div className="font-bold text-sm text-purple-100">{title}</div>
        {subtitle && <div className="text-[10px] text-purple-400 uppercase font-bold mt-0.5">{subtitle}</div>}
      </CardContent>
      
      {/* Info Dialog */}
      {type === 'class' && (
        <InfoDialog title={title} subtitle={subtitle} triggerLabel={`  ${title}`}>
          <InfoGrid>
            <InfoPill label=" " value={`d${entity.hitDie}`} />
            <InfoPill label="  " value={` ${entity.subclassLevel}`} />
          </InfoGrid>
          
          {entity.features && entity.features.length > 0 && (
            <>
              <InfoSectionTitle> </InfoSectionTitle>
              <div className="space-y-2">
                {entity.features.filter((f: any) => !f.feature.displayType.includes(FeatureDisplayType.HIDDEN)).map((f: any, idx: number) => {
                  const isUnlocked = f.level <= persLevel;
                  return (
                    <div 
                      key={idx} 
                      className={`p-3 rounded-lg border ${
                        isUnlocked 
                          ? 'border-green-500/50 bg-green-900/20' 
                          : 'border-slate-800/50 bg-slate-900/30 opacity-60'
                      }`}
                    >
                      <div className="flex justify-between items-start mb-1">
                        <span className="font-semibold text-sm">{f.feature.name}</span>
                        <span className="text-xs text-slate-400"> {f.level}</span>
                      </div>
                      <FormattedDescription content={String(f.feature.description || "")} className="text-xs text-slate-300" />
                    </div>
                  );
                })}
              </div>
            </>
          )}
          
          {subEntity && subEntity.features && (
            <>
              <InfoSectionTitle> </InfoSectionTitle>
              <div className="space-y-2">
                {subEntity.features.filter((f: any) => !f.feature.displayType.includes(FeatureDisplayType.HIDDEN)).map((f: any, idx: number) => {
                  const isUnlocked = f.level <= persLevel;
                  return (
                    <div 
                      key={idx} 
                      className={`p-3 rounded-lg border ${
                        isUnlocked 
                          ? 'border-blue-500/50 bg-blue-900/20' 
                          : 'border-slate-800/50 bg-slate-900/30 opacity-60'
                      }`}
                    >
                      <div className="flex justify-between items-start mb-1">
                        <span className="font-semibold text-sm">{f.feature.name}</span>
                        <span className="text-xs text-slate-400"> {f.level}</span>
                      </div>
                      <FormattedDescription content={String(f.feature.description || "")} className="text-xs text-slate-300" />
                    </div>
                  );
                })}
              </div>
            </>
          )}
        </InfoDialog>
      )}
      
      {type === 'race' && (
        <InfoDialog title={title} subtitle={subtitle} triggerLabel={`  ${title}`}>
          {entity.traits && entity.traits.length > 0 && (
            <>
              <InfoSectionTitle> </InfoSectionTitle>
              <div className="space-y-2">
                {entity.traits.filter((t: any) => !t.feature.displayType.includes(FeatureDisplayType.HIDDEN)).map((t: any, idx: number) => (
                  <div key={idx} className="p-3 rounded-lg border border-slate-800/50 bg-slate-900/30">
                    <span className="font-semibold text-sm block mb-1">{t.feature.name}</span>
                    <FormattedDescription content={String(t.feature.description || "")} className="text-xs text-slate-300" />
                  </div>
                ))}
              </div>
            </>
          )}
          
          {subEntity && subEntity.traits && (
            <>
              <InfoSectionTitle> </InfoSectionTitle>
              <div className="space-y-2">
                {subEntity.traits.filter((t: any) => !t.feature.displayType.includes(FeatureDisplayType.HIDDEN)).map((t: any, idx: number) => (
                  <div key={idx} className="p-3 rounded-lg border border-slate-800/50 bg-slate-900/30">
                    <span className="font-semibold text-sm block mb-1">{t.feature.name}</span>
                    <FormattedDescription content={String(t.feature.description || "")} className="text-xs text-slate-300" />
                  </div>
                ))}
              </div>
            </>
          )}
        </InfoDialog>
      )}
      
      {type === 'background' && (
        <InfoDialog title={title} triggerLabel={`  ${title}`}>
          {entity.description && (
            <FormattedDescription content={String(entity.description)} className="text-sm text-slate-300" />
          )}
        </InfoDialog>
      )}
    </Card>
  );
}
</file>

<file path="src/lib/components/characterSheet/SpellsPage.tsx">
"use client";

import { PersWithRelations } from "@/lib/actions/pers";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { spellSchoolTranslations } from "@/lib/refs/translation";
import { usePathname, useRouter, useSearchParams } from "next/navigation";
import { calculateCasterLevel } from "@/lib/logic/spell-logic";
import { SPELL_SLOT_PROGRESSION } from "@/lib/refs/static";
import { spendSpellSlot, restoreSpellSlot, spendPactSlot, restorePactSlot } from "@/lib/actions/spell-slots";
import { useTransition } from "react";
import { toast } from "sonner";
import { cn } from "@/lib/utils";

export default function SpellsPage({ pers }: { pers: PersWithRelations }) {
    const router = useRouter();
    const pathname = usePathname();
    const searchParams = useSearchParams();
    const [isPending, startTransition] = useTransition();

    const caster = calculateCasterLevel(pers as any);
    const casterLevel = caster.casterLevel;
    const pactLevel = caster.pactLevel;

    const maxSlotsRow = (SPELL_SLOT_PROGRESSION.FULL as any)[casterLevel] || [0, 0, 0, 0, 0, 0, 0, 0, 0];
    const currentSlots = Array.isArray(pers.currentSpellSlots) ? (pers.currentSpellSlots as number[]) : [0, 0, 0, 0, 0, 0, 0, 0, 0];

    const pactSlotInfo = (SPELL_SLOT_PROGRESSION.PACT as any)[pactLevel];
    const maxPactSlots = pactSlotInfo?.slots || 0;
    const pactSlotLevel = pactSlotInfo?.level || 0;
    const currentPactSlots = typeof pers.currentPactSlots === 'number' ? pers.currentPactSlots : 0;

    const spellsByLevel = pers.spells.reduce((acc, ps) => {
        const level = ps.level;
        if (!acc[level]) acc[level] = [];
        acc[level].push(ps);
        return acc;
    }, {} as Record<number, typeof pers.spells>);

    const levels = Object.keys(spellsByLevel).map(Number).sort((a, b) => a - b);
    // Ensure levels with slots are shown even if no spells are known at that level
    for (let i = 1; i <= 9; i++) {
        if (maxSlotsRow[i - 1] > 0 && !levels.includes(i)) {
            levels.push(i);
        }
    }
    // Also check pact slots
    if (pactSlotLevel > 0 && !levels.includes(pactSlotLevel)) {
        levels.push(pactSlotLevel);
    }
    levels.sort((a, b) => a - b);

    const handleToggleSlot = (level: number, isSpent: boolean) => {
        startTransition(async () => {
            const res = isSpent 
                ? await restoreSpellSlot(pers.persId, level)
                : await spendSpellSlot(pers.persId, level);
            if (!res.success) toast.error(res.error);
        });
    };

    const handleTogglePactSlot = (isSpent: boolean) => {
        startTransition(async () => {
            const res = isSpent
                ? await restorePactSlot(pers.persId)
                : await spendPactSlot(pers.persId);
            if (!res.success) toast.error(res.error);
        });
    };

    return (
        <div className="space-y-4 pb-20">
            {/* Pact Slots (if any) */}
            {maxPactSlots > 0 && (
                <Card className="bg-indigo-900/2 border-indigo-500/30 overflow-hidden border-l-4 border-l-indigo-500">
                    <CardHeader className="py-3 px-4 flex flex-row items-center justify-between bg-indigo-500/5">
                        <div className="flex items-center gap-2">
                            <CardTitle className="text-sm font-bold text-indigo-100 uppercase tracking-tight"> </CardTitle>
                            <Badge variant="secondary" className="bg-indigo-500/20 text-indigo-300 border-indigo-500/30"> {pactSlotLevel}</Badge>
                        </div>
                        <div className="text-xs font-bold text-indigo-300">{currentPactSlots} / {maxPactSlots}</div>
                    </CardHeader>
                    <CardContent className="p-3">
                        <div className="flex flex-wrap gap-2">
                            {Array.from({ length: maxPactSlots }).map((_, i) => {
                                const isAvailable = i < currentPactSlots;
                                return (
                                    <button
                                        key={i}
                                        disabled={isPending}
                                        onClick={() => handleTogglePactSlot(!isAvailable)}
                                        className={cn(
                                            "w-8 h-8 rounded-lg border-2 transition-all duration-300 flex items-center justify-center",
                                            isAvailable 
                                                ? "bg-indigo-500 border-indigo-400 shadow-[0_0_10px_rgba(99,102,241,0.4)]" 
                                                : "bg-slate-900/50 border-white/10 opacity-40 hover:opacity-100"
                                        )}
                                    >
                                        <div className={cn("w-2 h-2 rounded-full", isAvailable ? "bg-white" : "bg-white/20")} />
                                    </button>
                                );
                            })}
                        </div>
                    </CardContent>
                </Card>
            )}

            {levels.map(level => {
                const max = maxSlotsRow[level - 1] || 0;
                const current = currentSlots[level - 1] || 0;
                const hasSlots = max > 0;

                return (
                    <Card key={level} className="bg-slate-900/50 border-white/10 overflow-hidden">
                        <CardHeader className="pb-2 py-3 bg-white/5">
                            <CardTitle className="text-base flex justify-between items-center group">
                                <span className="font-bold text-slate-100">
                                    {level === 0 ? "" : ` ${level}`}
                                </span>
                                {level > 0 && hasSlots && (
                                    <div className="flex items-center gap-3">
                                        <div className="text-[10px] font-black text-slate-500 uppercase tracking-widest hidden sm:block"></div>
                                        <div className="flex gap-1">
                                            {Array.from({ length: max }).map((_, i) => {
                                                const isAvailable = i < current;
                                                return (
                                                    <button
                                                        key={i}
                                                        disabled={isPending}
                                                        onClick={() => handleToggleSlot(level, !isAvailable)}
                                                        className={cn(
                                                            "w-5 h-5 rounded border transition-all duration-200 flex items-center justify-center",
                                                            isAvailable 
                                                                ? "bg-indigo-500 border-indigo-400" 
                                                                : "bg-slate-800 border-white/10 opacity-30 hover:opacity-100"
                                                        )}
                                                    >
                                                        {isAvailable && <div className="w-1 h-1 bg-white rounded-full" />}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                        <span className="text-xs font-bold text-indigo-300 ml-2">{current} / {max}</span>
                                    </div>
                                )}
                            </CardTitle>
                        </CardHeader>
                        <CardContent className="p-0">
                            {spellsByLevel[level] && spellsByLevel[level].length > 0 ? (
                                spellsByLevel[level].map((spell, i) => (
                                    <button
                                        key={spell.spellId}
                                        type="button"
                                        className={cn(
                                            "w-full text-left p-3 transition-colors hover:bg-indigo-500/5 border-white/5",
                                            i !== spellsByLevel[level].length - 1 && "border-b"
                                        )}
                                        onClick={() => {
                                            const next = new URLSearchParams(searchParams.toString());
                                            next.set("spell", String(spell.spellId));
                                            const query = next.toString();
                                            router.push(`${pathname}${query ? `?${query}` : ""}`, { scroll: false });
                                        }}
                                    >
                                        <div className="font-bold text-slate-100 text-sm group-hover:text-indigo-200 transition">{spell.name}</div>
                                        <div className="text-[10px] text-slate-400 mt-0.5 flex items-center gap-2">
                                            <span className="bg-white/5 px-1.5 py-0.5 rounded text-indigo-300">
                                                {spellSchoolTranslations[spell.school as keyof typeof spellSchoolTranslations] || spell.school}
                                            </span>
                                            <span></span>
                                            <span>{spell.castingTime}</span>
                                            <span></span>
                                            <span>{spell.range}</span>
                                        </div>
                                    </button>
                                ))
                            ) : (
                                level > 0 && <div className="p-4 text-center text-xs text-slate-500 italic">    </div>
                            )}
                        </CardContent>
                    </Card>
                );
            })}

            {levels.length === 0 && (
                <div className="text-center text-slate-500 py-12 flex flex-col items-center gap-3">
                    <div className="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center text-slate-600">
                        <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                           <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <span>  </span>
                </div>
            )}
        </div>
    );
}
</file>

<file path="src/lib/components/levelUp/LevelUpASIForm.tsx">
"use client";

import { useEffect, useMemo, useRef, useState } from "react";

import { Ability } from "@prisma/client";

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Check } from "lucide-react";

import { usePersFormStore } from "@/lib/stores/persFormStore";
import FeatsForm from "@/lib/components/characterCreator/FeatsForm";
import FeatChoiceOptionsForm from "@/lib/components/characterCreator/FeatChoiceOptionsForm";
import type { FeatPrisma } from "@/lib/types/model-types";
import { attributesUkrShort } from "@/lib/refs/translation";

interface Props {
  feats: FeatPrisma[];
  formId: string;
  onNextDisabledChange?: (disabled: boolean) => void;
}

type ChoiceType = "ASI" | "FEAT";
type AsiMap = Partial<Record<Ability, 0 | 1 | 2>>;

const ABILITIES = Object.values(Ability);

const normalizeAsi = (customAsi: unknown): AsiMap => {
  const map: AsiMap = {};
  if (!Array.isArray(customAsi)) return map;
  for (const entry of customAsi as Array<{ ability?: string; value?: string }>) {
    const ability = entry?.ability as Ability | undefined;
    const value = Number(entry?.value);
    if (!ability || !ABILITIES.includes(ability)) continue;
    if (!Number.isFinite(value) || (value !== 1 && value !== 2)) continue;
    map[ability] = value as 1 | 2;
  }
  return map;
};

const toCustomAsi = (asi: AsiMap) => {
  return Object.entries(asi)
    .filter(([, value]) => value && value > 0)
    .map(([ability, value]) => ({ ability, value: String(value) }));
};

export default function LevelUpASIForm({ feats, formId, onNextDisabledChange }: Props) {
  const { updateFormData, formData } = usePersFormStore();
  const [choiceType, setChoiceType] = useState<ChoiceType>("ASI");
  const [featFormDisabled, setFeatFormDisabled] = useState(true);
  const [featOptionsDisabled, setFeatOptionsDisabled] = useState(false);
  const prevDisabledRef = useRef<boolean | undefined>(undefined);

  const asiMap = useMemo(() => normalizeAsi(formData.customAsi), [formData.customAsi]);
  const totalAsi = useMemo(
    () => Object.values(asiMap).reduce<number>((acc, val) => acc + (val ?? 0), 0),
    [asiMap]
  );

  const selectedFeat = useMemo(() => {
    const id = formData.featId ? Number(formData.featId) : undefined;
    if (!id) return null;
    return feats.find((f) => f.featId === id) ?? null;
  }, [feats, formData.featId]);

  const featHasChoices = useMemo(
    () => Boolean(selectedFeat?.featChoiceOptions?.length),
    [selectedFeat]
  );

  useEffect(() => {
    // Keep store coherent when switching mode.
    if (choiceType === "ASI") {
      updateFormData({
        featId: undefined,
        featChoiceSelections: {},
      });
    } else {
      updateFormData({
        customAsi: [],
      });
    }
  }, [choiceType, updateFormData]);

  useEffect(() => {
    const asiValid = choiceType === "ASI" ? totalAsi === 2 : true;
    const featValid =
      choiceType === "FEAT"
        ? !featFormDisabled && (!featHasChoices || !featOptionsDisabled)
        : true;

    const disabled = !(asiValid && featValid);

    if (prevDisabledRef.current !== disabled) {
      prevDisabledRef.current = disabled;
      onNextDisabledChange?.(disabled);
    }
  }, [choiceType, totalAsi, featFormDisabled, featOptionsDisabled, featHasChoices, onNextDisabledChange]);

  const setAsiValue = (ability: Ability, value: 1 | 2) => {
    const current = asiMap[ability] ?? 0;
    const currentTotal = totalAsi;

    // Toggle off.
    if (current === value) {
      const next: AsiMap = { ...asiMap, [ability]: 0 };
      updateFormData({ customAsi: toCustomAsi(next) as any });
      return;
    }

    // If user sets +2, clear others (DnD: either +2 or +1/+1).
    if (value === 2) {
      const next: AsiMap = { [ability]: 2 };
      updateFormData({ customAsi: toCustomAsi(next) as any });
      return;
    }

    // value === 1
    if (currentTotal >= 2 && current === 0) return;

    // If currently +2 on this ability, downgrade to +1.
    const next: AsiMap = { ...asiMap };
    next[ability] = 1;

    // If there is another +2 elsewhere, downgrade that to 0.
    for (const a of ABILITIES) {
      if (a !== ability && (next[a] ?? 0) === 2) next[a] = 0;
    }

    // Enforce total <= 2
    const nextTotal = Object.values(next).reduce<number>((acc, v) => acc + (v ?? 0), 0);
    if (nextTotal > 2) return;

    updateFormData({ customAsi: toCustomAsi(next) as any });
  };

  const isDisabledButton = (ability: Ability, value: 1 | 2) => {
    if (choiceType !== "ASI") return true;
    const current = asiMap[ability] ?? 0;
    if (current === value) return false;
    if (value === 2) {
      // Allow switching to +2 any time.
      return false;
    }
    // value === 1
    return totalAsi >= 2 && current === 0;
  };

  return (
    <div className="space-y-4">
      <Card className="glass-card">
        <CardHeader>
          <CardTitle></CardTitle>
        </CardHeader>
        <CardContent className="flex flex-wrap gap-2">
          <Button
            type="button"
            variant="outline"
            className={
              "border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white " +
              (choiceType === "ASI" ? "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100" : "")
            }
            onClick={() => setChoiceType("ASI")}
          >
             
          </Button>
          <Button
            type="button"
            variant="outline"
            className={
              "border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white " +
              (choiceType === "FEAT" ? "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100" : "")
            }
            onClick={() => setChoiceType("FEAT")}
          >
              (Feat)
          </Button>
        </CardContent>
      </Card>

      {choiceType === "ASI" ? (
        <Card className="glass-card">
          <CardHeader>
            <CardTitle> (+2  +1/+1)</CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            <div className="flex flex-wrap items-center justify-between gap-2">
              <p className="text-sm text-slate-300">
                 <span className="font-semibold text-slate-100">2</span> .
              </p>
              <Badge variant="outline" className="border-white/15 bg-white/5 text-slate-100">
                : {totalAsi}/2
              </Badge>
            </div>

            <div className="grid gap-2 sm:grid-cols-2">
              {ABILITIES.map((ability) => {
                const attr = attributesUkrShort[ability];
                const current = asiMap[ability] ?? 0;

                return (
                  <div
                    key={ability}
                    className="glass-panel border-gradient-rpg flex items-center justify-between gap-3 rounded-xl p-3"
                  >
                    <div>
                      <p className="text-sm font-semibold text-white">{attr}</p>
                      <p className="text-xs text-slate-400">{ability}</p>
                    </div>

                    <div className="flex items-center gap-2">
                      <Button
                        type="button"
                        variant={current === 1 ? "secondary" : "outline"}
                        size="sm"
                        className={
                          "border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white " +
                          (current === 1 ? "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100" : "")
                        }
                        disabled={isDisabledButton(ability, 1)}
                        onClick={() => setAsiValue(ability, 1)}
                      >
                        +1 {current === 1 ? <Check className="ml-2 h-4 w-4" /> : null}
                      </Button>

                      <Button
                        type="button"
                        variant={current === 2 ? "secondary" : "outline"}
                        size="sm"
                        className={
                          "border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white " +
                          (current === 2 ? "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100" : "")
                        }
                        disabled={isDisabledButton(ability, 2)}
                        onClick={() => setAsiValue(ability, 2)}
                      >
                        +2 {current === 2 ? <Check className="ml-2 h-4 w-4" /> : null}
                      </Button>
                    </div>
                  </div>
                );
              })}
            </div>
          </CardContent>
        </Card>
      ) : (
        <div className="space-y-4">
          <FeatsForm feats={feats as any} formId={`${formId}-feat`} onNextDisabledChange={setFeatFormDisabled} />

          {featHasChoices ? (
            <FeatChoiceOptionsForm
              selectedFeat={selectedFeat as any}
              formId={`${formId}-feat-options`}
              onNextDisabledChange={setFeatOptionsDisabled}
            />
          ) : null}
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/lib/components/levelUp/LevelUpWizard.tsx">
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import type { ReactNode } from "react";
import { getLevelUpInfo, levelUpCharacter } from "@/lib/actions/levelup";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { FormattedDescription } from "@/components/ui/FormattedDescription";
import { toast } from "sonner";
import { useRouter } from "next/navigation";
import { ChevronLeft, ChevronRight, Check } from "lucide-react";
import SubclassForm from "@/lib/components/characterCreator/SubclassForm";
import ClassChoiceOptionsForm from "@/lib/components/characterCreator/ClassChoiceOptionsForm";
import SubclassChoiceOptionsForm from "@/lib/components/characterCreator/SubclassChoiceOptionsForm";
import LevelUpASIForm from "@/lib/components/levelUp/LevelUpASIForm";
import ClassesForm from "@/lib/components/characterCreator/ClassesForm";
import OptionalFeaturesForm from "@/lib/components/levelUp/OptionalFeaturesForm";
import LevelUpHPStep from "@/lib/components/levelUp/LevelUpHPStep";
import clsx from "clsx";
import { classTranslations, classTranslationsEng, attributesUkrShort, sourceTranslations } from "@/lib/refs/translation";
import { Ability, FeatureDisplayType, SpellcastingType } from "@prisma/client";
import { ClassI } from "@/lib/types/model-types";
import { InfoDialog, InfoGrid, InfoPill, InfoSectionTitle } from "@/lib/components/characterCreator/EntityInfoDialog";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { FeatureCard, ResourceCard } from "@/lib/components/characterSheet/shared/FeatureCards";
import {
  formatAbilityList,
  formatArmorProficiencies,
  formatLanguages,
  formatMulticlassReqs,
  formatSkillProficiencies,
  formatToolProficiencies,
  formatWeaponProficiencies,
  prettifyEnum,
} from "@/lib/components/characterCreator/infoUtils";

const SPELLCASTING_LABELS: Record<SpellcastingType, string> = {
  NONE: " ",
  FULL: " ",
  HALF: " ",
  THIRD: " ",
  PACT: " ",
};

type LevelUpInfo = Awaited<ReturnType<typeof getLevelUpInfo>>;

interface Props {
  info: LevelUpInfo;
}

export default function LevelUpWizard({ info }: Props) {
  const { resetForm, formData } = usePersFormStore();
  const [currentStep, setCurrentStep] = useState(0);
  const [nextDisabled, setNextDisabled] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const router = useRouter();
    const prevDisabledRef = useRef<boolean | undefined>(undefined);

  // Initialize store
  useEffect(() => {
      resetForm();
      // We don't need to load old data for new choices, 
      // but we might need to load existing choices to prevent duplicates if we were editing.
      // For Level Up, we start fresh.
  }, [resetForm]);

    const isError = "error" in info;
    const pers = isError ? null : info.pers;
    const nextLevel = isError ? 0 : info.nextLevel;
    const classes = useMemo(() => info?.classes || [], [info?.classes]);
    const feats = useMemo(() => info?.feats || [], [info?.feats]);

    const existingClassIds = useMemo(() => {
        const ids = new Set<number>();
        if (!pers) return ids;
        ids.add(pers.classId);
        (pers.multiclasses || []).forEach((m: any) => ids.add(m.classId));
        return ids;
    }, [pers]);

    const mainClassLevel = useMemo(() => {
        if (!pers) return 0;
        const extras = (pers.multiclasses || []).reduce((acc: number, m: any) => acc + (m.classLevel || 0), 0);
        const computed = pers.level - extras;
        return computed > 0 ? computed : 1;
    }, [pers]);

    const selectedClassId = useMemo(() => {
        const raw = formData.classId;
        const id = typeof raw === "number" ? raw : typeof raw === "string" ? Number(raw) : NaN;
        return Number.isFinite(id) ? id : undefined;
    }, [formData.classId]);

    const selectedClass = useMemo(() => {
        if (!selectedClassId) return null;
        return (classes as unknown as ClassI[]).find((c) => c.classId === selectedClassId) ?? null;
    }, [classes, selectedClassId]);

    const selectedClassName = useMemo(() => {
        if (!selectedClass) return "";
        return classTranslations[selectedClass.name] || classTranslationsEng[selectedClass.name] || selectedClass.name;
    }, [selectedClass]);

    const selectedMulticlassRow = useMemo(() => {
        if (!pers || !selectedClassId) return null;
        return (pers.multiclasses || []).find((m: any) => m.classId === selectedClassId) ?? null;
    }, [pers, selectedClassId]);

    const classLevelBefore = useMemo(() => {
        if (!pers || !selectedClassId) return 0;
        if (selectedClassId === pers.classId) return mainClassLevel;
        if (selectedMulticlassRow) return selectedMulticlassRow.classLevel;
        return 0;
    }, [pers, selectedClassId, mainClassLevel, selectedMulticlassRow]);

    const classLevelAfter = useMemo(() => {
        if (!selectedClassId) return 0;
        return classLevelBefore + 1;
    }, [selectedClassId, classLevelBefore]);

    const currentSubclassIdForSelectedClass = useMemo(() => {
        if (!pers || !selectedClassId) return undefined;
        if (selectedClassId === pers.classId) return pers.subclassId ?? undefined;
        return selectedMulticlassRow?.subclassId ?? undefined;
    }, [pers, selectedClassId, selectedMulticlassRow]);

    const effectiveSubclassId = useMemo(() => {
        const fromStore = formData.subclassId ? Number(formData.subclassId) : undefined;
        return fromStore ?? currentSubclassIdForSelectedClass;
    }, [formData.subclassId, currentSubclassIdForSelectedClass]);

    const effectiveSubclass = useMemo(() => {
        if (!selectedClass || !effectiveSubclassId) return null;
        return selectedClass.subclasses?.find((s) => s.subclassId === effectiveSubclassId) ?? null;
    }, [selectedClass, effectiveSubclassId]);

    const needsSubclass = useMemo(() => {
        if (!selectedClass || !selectedClassId) return false;
        const hasSubclassAlready = Boolean(currentSubclassIdForSelectedClass);
        if (hasSubclassAlready) return false;
        return selectedClass.subclassLevel === classLevelAfter;
    }, [selectedClass, selectedClassId, currentSubclassIdForSelectedClass, classLevelAfter]);

    const isASILevel = useMemo(() => {
        if (!selectedClass) return false;
        return (selectedClass.abilityScoreUpLevels || []).includes(classLevelAfter);
    }, [selectedClass, classLevelAfter]);

    const classChoiceGroups = useMemo(() => {
        if (!selectedClass) return {} as Record<string, any[]>;
        const options = (selectedClass.classChoiceOptions || []).filter((opt) => (opt.levelsGranted || []).includes(classLevelAfter));
        return options.reduce((acc, opt) => {
            const group = opt.choiceOption.groupName;
            if (!acc[group]) acc[group] = [];
            acc[group].push(opt);
            return acc;
        }, {} as Record<string, typeof options>);
    }, [selectedClass, classLevelAfter]);

    const subclassChoiceGroups = useMemo(() => {
        if (!effectiveSubclass) return {} as Record<string, any[]>;
        const options = (effectiveSubclass.subclassChoiceOptions || []).filter((opt) => (opt.levelsGranted || []).includes(classLevelAfter));
        return options.reduce((acc, opt) => {
            const group = opt.choiceOption.groupName;
            if (!acc[group]) acc[group] = [];
            acc[group].push(opt);
            return acc;
        }, {} as Record<string, typeof options>);
    }, [effectiveSubclass, classLevelAfter]);

    const newClassFeatures = useMemo(() => {
        if (!selectedClass) return [] as any[];
        return (selectedClass.features || []).filter((f) => f.levelGranted === classLevelAfter);
    }, [selectedClass, classLevelAfter]);

    const newSubclassFeatures = useMemo(() => {
        if (!effectiveSubclass) return [] as any[];
        return (effectiveSubclass.features || []).filter((f) => f.levelGranted === classLevelAfter);
    }, [effectiveSubclass, classLevelAfter]);

    const eligibleMulticlassClasses = useMemo(() => {
        if (!pers) return [] as ClassI[];
        const baseStats = {
            STR: pers.str,
            DEX: pers.dex,
            CON: pers.con,
            INT: pers.int,
            WIS: pers.wis,
            CHA: pers.cha,
        } as Record<Ability, number>;

        const meetsReqs = (cls: ClassI) => {
            const reqs = cls.multiclassReqs;
            if (!reqs?.required?.length) return true;
            const score = reqs.score ?? 13;
            return reqs.required.every((a) => (baseStats[a] ?? 0) >= score);
        };

    return (classes as unknown as ClassI[])
      .filter((c) => !existingClassIds.has(c.classId))
      .filter(meetsReqs);
  }, [classes, existingClassIds, pers]);

    const steps = useMemo(() => {
        const result: Array<{ id: string; title: string; initialDisabled: boolean; component: ReactNode }> = [];

        if (isError || !pers) {
            result.push({
                id: "error",
                title: "",
                initialDisabled: true,
                component: (
                    <Card className="glass-card">
                        <CardHeader>
                            <CardTitle></CardTitle>
                        </CardHeader>
                        <CardContent className="text-slate-200">{isError ? (info as any).error : ""}</CardContent>
                    </Card>
                ),
            });
            return result;
        }

    result.push({
            id: "path",
            title: "",
            initialDisabled: true,
            component: (
                <PathStep
                    pers={pers}
                    classes={classes as unknown as ClassI[]}
                    eligibleMulticlassClasses={eligibleMulticlassClasses}
                    mainClassLevel={mainClassLevel}
                    onNextDisabledChange={(disabled) => {
                        if (prevDisabledRef.current !== disabled) {
                            prevDisabledRef.current = disabled;
                            setNextDisabled(disabled);
                        }
                    }}
                />
            ),
        });

    if (!selectedClassId || !selectedClass) return result;

    result.push({
            id: "summary",
            title: "",
            initialDisabled: false,
            component: (
                <SummaryStep
                    totalLevel={nextLevel}
                    className={selectedClassName}
                    classLevelAfter={classLevelAfter}
                    newClassFeatures={newClassFeatures}
                    newSubclassFeatures={newSubclassFeatures}
                />
            ),
        });

    if (needsSubclass) {
      result.push({
                id: "subclass",
                title: "",
                initialDisabled: true,
                component: (
                    <SubclassForm cls={selectedClass as unknown as ClassI} formId="subclass-form" onNextDisabledChange={setNextDisabled} />
                ),
      });
    }

        if (Object.keys(classChoiceGroups).length > 0) {
            result.push({
                id: "class-choices",
                title: " ",
                initialDisabled: true,
                component: (
                    <ClassChoiceOptionsForm
                        availableOptions={Object.values(classChoiceGroups).flat()}
                        formId="class-choice-form"
                        onNextDisabledChange={setNextDisabled}
                    />
                ),
            });
        }

        if (Object.keys(subclassChoiceGroups).length > 0) {
            result.push({
                id: "subclass-choices",
                title: " ",
                initialDisabled: true,
                component: (
                    <SubclassChoiceOptionsForm
                        availableOptions={Object.values(subclassChoiceGroups).flat()}
                        formId="subclass-choice-form"
                        onNextDisabledChange={setNextDisabled}
                    />
                ),
            });
        }

        if (isASILevel) {
            result.push({
                id: "asi",
                title: "",
                initialDisabled: true,
                component: <LevelUpASIForm feats={feats as any} formId="asi-form" onNextDisabledChange={setNextDisabled} />,
            });
        }

        const hasOptional = Boolean(
            (selectedClass.classOptionalFeatures || []).some((opt) => (opt.grantedOnLevels || []).includes(classLevelAfter))
        );
        if (hasOptional) {
            result.push({
                id: "optional",
                title: "",
                initialDisabled: true,
                component: (
                    <OptionalFeaturesForm
                        selectedClass={selectedClass}
                        classLevel={classLevelAfter}
                        formId="optional-features"
                        onNextDisabledChange={setNextDisabled}
                    />
                ),
            });
        }

        result.push({
            id: "hp",
            title: "HP",
            initialDisabled: true,
            component: (
                <LevelUpHPStep
                    hitDie={selectedClass.hitDie}
                    baseStats={{
                        str: pers.str,
                        dex: pers.dex,
                        con: pers.con,
                        int: pers.int,
                        wis: pers.wis,
                        cha: pers.cha,
                    }}
                    feats={feats as any}
                    formId="hp-form"
                    onNextDisabledChange={setNextDisabled}
                />
            ),
        });

        result.push({
            id: "confirm",
            title: "",
            initialDisabled: false,
            component: (
                <ConfirmStep
                    totalLevel={nextLevel}
                    className={selectedClassName}
                    classLevelAfter={classLevelAfter}
                    formData={formData}
                />
            ),
        });

        return result;
    }, [
        classChoiceGroups,
        classLevelAfter,
        classes,
        eligibleMulticlassClasses,
        feats,
        formData,
        isASILevel,
                isError,
        mainClassLevel,
        needsSubclass,
        newClassFeatures,
        newSubclassFeatures,
        nextLevel,
                pers,
        selectedClass,
        selectedClassId,
        selectedClassName,
        subclassChoiceGroups,
                info,
    ]);

    const currentStepId = steps[currentStep]?.id;

    useEffect(() => {
        const initial = steps[currentStep]?.initialDisabled ?? true;
        setNextDisabled(initial);
        prevDisabledRef.current = undefined;
    }, [currentStep, currentStepId]);

  const handleNext = async () => {
      if (currentStep < steps.length - 1) {
          setCurrentStep(prev => prev + 1);
          const next = steps[currentStep + 1];
          setNextDisabled(next?.initialDisabled ?? true);
      } else {
          // Submit
          setIsSubmitting(true);
          try {
              if (!pers) throw new Error("Missing pers");
              const result = await levelUpCharacter(pers.persId, formData);
              if ('error' in result) {
                  toast.error(result.error);
              } else {
                  toast.success(" !");
                  router.push(`/pers/${pers.persId}`);
              }
          } catch {
              toast.error("  ");
          } finally {
              setIsSubmitting(false);
          }
      }
  };

  const handlePrev = () => {
      if (currentStep > 0) {
          setCurrentStep(prev => prev - 1);
          const prev = steps[currentStep - 1];
          setNextDisabled(prev?.initialDisabled ?? true);
      }
  };

  const CurrentComponent = steps[currentStep].component;

  return (
    <div className="container mx-auto py-8 px-4 max-w-3xl">
        <div className="mb-8">
            <h1 className="font-sans text-2xl font-light tracking-wide text-slate-100 mb-2">   {nextLevel}</h1>
            <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                {steps.map((s, i) => (
                    <div key={s.id} className={`flex items-center whitespace-nowrap text-sm ${i === currentStep ? 'text-cyan-400 font-medium' : 'text-slate-500'}`}>
                        <div className={`w-6 h-6 rounded-full flex items-center justify-center border mr-2 ${i === currentStep ? 'border-cyan-400 bg-cyan-400/10 text-cyan-400' : 'border-slate-800'}`}>
                            {i + 1}
                        </div>
                        {s.title}
                        {i < steps.length - 1 && <div className="mx-2 h-[1px] w-4 bg-white/5" />}
                    </div>
                ))}
            </div>
        </div>

        <div className="mb-8 min-h-[300px]">
            {CurrentComponent}
        </div>

        <div className="flex justify-between">
            <Button variant="outline" onClick={handlePrev} disabled={currentStep === 0 || isSubmitting}>
                <ChevronLeft className="mr-2 h-4 w-4" /> 
            </Button>
            <Button onClick={handleNext} disabled={nextDisabled || isSubmitting}>
                {currentStep === steps.length - 1 ? (
                    isSubmitting ? "..." : " "
                ) : (
                    <> <ChevronRight className="ml-2 h-4 w-4" /></>
                )}
            </Button>
        </div>
    </div>
  );
}
function SummaryStep({
    totalLevel,
    className,
    classLevelAfter,
    newClassFeatures,
    newSubclassFeatures,
}: {
    totalLevel: number;
    className: string;
    classLevelAfter: number;
    newClassFeatures: any[];
    newSubclassFeatures: any[];
}) {
    const [selectedFeature, setSelectedFeature] = useState<{name: string, description: string} | null>(null);

    return (
        <Card className="glass-card backdrop-blur-xl border-white/10 bg-white/5">
            <CardHeader>
                <CardTitle className="text-xl font-light tracking-wide text-slate-100">  {totalLevel}- !</CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
                <div className="glass-panel border-gradient-rpg rounded-xl p-4 bg-white/5 border-white/10">
                    <p className="text-[10px] uppercase tracking-widest text-slate-400 mb-1"> :</p>
                    <p className="text-lg font-semibold text-white">
                        {className} ( {classLevelAfter})
                    </p>
                </div>

                {newClassFeatures.length > 0 ? (
                    <div className="space-y-3">
                        <h3 className="text-xs font-bold uppercase tracking-widest text-slate-400 px-1">  :</h3>
                        <div className="grid grid-cols-1 gap-2">
                            {newClassFeatures.map((f: any) => {
                                const featureData = {
                                    ...f.feature,
                                    source: "class",
                                    sourceName: className
                                };
                                const isResource = f.feature?.displayType?.includes(FeatureDisplayType.CLASS_RESOURCE) || 
                                                 f.feature?.displayType?.includes(FeatureDisplayType.RESOURCE);

                                if (isResource) {
                                    return (
                                        <ResourceCard 
                                            key={f.featureId} 
                                            feature={featureData}
                                            onInfo={() => setSelectedFeature({ name: f.feature?.name, description: f.feature?.description })}
                                            isReadOnly={true}
                                        />
                                    );
                                }

                                return (
                                    <FeatureCard 
                                        key={f.featureId} 
                                        feature={featureData}
                                        onClick={() => setSelectedFeature({ name: f.feature?.name, description: f.feature?.description })}
                                        isReadOnly={true}
                                    />
                                );
                            })}
                        </div>
                    </div>
                ) : null}

                {newSubclassFeatures.length > 0 ? (
                    <div className="space-y-3">
                        <h3 className="text-xs font-bold uppercase tracking-widest text-slate-400 px-1">  :</h3>
                        <div className="grid grid-cols-1 gap-2">
                            {newSubclassFeatures.map((f: any) => {
                                const featureData = {
                                    ...f.feature,
                                    source: "subclass",
                                    sourceName: className
                                };
                                const isResource = f.feature?.displayType?.includes(FeatureDisplayType.CLASS_RESOURCE) || 
                                                 f.feature?.displayType?.includes(FeatureDisplayType.RESOURCE);

                                if (isResource) {
                                    return (
                                        <ResourceCard 
                                            key={f.featureId} 
                                            feature={featureData}
                                            onInfo={() => setSelectedFeature({ name: f.feature?.name, description: f.feature?.description })}
                                            isReadOnly={true}
                                        />
                                    );
                                }

                                return (
                                    <FeatureCard 
                                        key={f.featureId} 
                                        feature={featureData}
                                        onClick={() => setSelectedFeature({ name: f.feature?.name, description: f.feature?.description })}
                                        isReadOnly={true}
                                    />
                                );
                            })}
                        </div>
                    </div>
                ) : null}
            </CardContent>

            <Dialog open={!!selectedFeature} onOpenChange={() => setSelectedFeature(null)}>
                <DialogContent className="max-w-xl border-white/10 bg-slate-900/95 backdrop-blur text-slate-100">
                    <DialogHeader>
                        <DialogTitle className="text-xl font-semibold tracking-wide font-rpg-display uppercase">{selectedFeature?.name}</DialogTitle>
                    </DialogHeader>
                    <div className="max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                        {selectedFeature?.description && (
                            <FormattedDescription content={selectedFeature.description} className="text-sm text-slate-300 leading-relaxed" />
                        )}
                    </div>
                </DialogContent>
            </Dialog>
        </Card>
    );
}

function ConfirmStep({
    totalLevel,
    className,
    classLevelAfter,
    formData,
}: {
    totalLevel: number;
    className: string;
    classLevelAfter: number;
    formData: any;
}) {
    const asiChosen = Array.isArray(formData.customAsi) && formData.customAsi.length > 0;
    const featChosen = Boolean(formData.featId);
    const optionalChosen =
        formData.classOptionalFeatureSelections &&
        Object.values(formData.classOptionalFeatureSelections as Record<string, boolean>).some((v) => v === true);

    return (
        <Card className="glass-card backdrop-blur-xl border-white/10 bg-white/5">
            <CardHeader>
                <CardTitle className="text-xl font-light tracking-wide text-slate-100"> </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
                <div className="glass-panel border-gradient-rpg rounded-xl p-4 bg-white/5 border-white/10">
                    <p className="text-[10px] uppercase tracking-widest text-slate-400 mb-1">  :</p>
                    <p className="text-lg font-semibold text-white">{totalLevel}</p>
                    <p className="text-[10px] uppercase tracking-widest text-slate-400 mt-2 mb-1">:</p>
                    <p className="text-lg font-semibold text-white">{className} ( {classLevelAfter})</p>
                </div>

                <div className="space-y-2">
                    {formData.subclassId ? (
                        <div className="flex items-center gap-2">
                            <Check className="h-4 w-4 text-emerald-400" />
                            <span className="text-sm text-slate-200"> </span>
                        </div>
                    ) : null}

                    {Object.keys(formData.classChoiceSelections || {}).length > 0 ? (
                        <div className="flex items-center gap-2">
                            <Check className="h-4 w-4 text-emerald-400" />
                            <span className="text-sm text-slate-200">  </span>
                        </div>
                    ) : null}

                    {Object.keys(formData.subclassChoiceSelections || {}).length > 0 ? (
                        <div className="flex items-center gap-2">
                            <Check className="h-4 w-4 text-emerald-400" />
                            <span className="text-sm text-slate-200">  </span>
                        </div>
                    ) : null}

                    {asiChosen ? (
                        <div className="flex items-center gap-2">
                            <Check className="h-4 w-4 text-emerald-400" />
                            <span className="text-sm text-slate-200"> </span>
                        </div>
                    ) : null}

                    {featChosen ? (
                        <div className="flex items-center gap-2">
                            <Check className="h-4 w-4 text-emerald-400" />
                            <span className="text-sm text-slate-200"> </span>
                        </div>
                    ) : null}

                    {optionalChosen ? (
                        <div className="flex items-center gap-2">
                            <Check className="h-4 w-4 text-emerald-400" />
                            <span className="text-sm text-slate-200">  </span>
                        </div>
                    ) : null}

                    {typeof formData.levelUpHpIncrease === "number" ? (
                        <div className="flex items-center gap-2">
                            <Check className="h-4 w-4 text-emerald-400" />
                            <span className="text-sm text-slate-200"> HP: +{formData.levelUpHpIncrease}</span>
                        </div>
                    ) : null}
                </div>
            </CardContent>
        </Card>
    );
}

function PathStep({
    pers,
    classes,
    eligibleMulticlassClasses,
    mainClassLevel,
    onNextDisabledChange,
}: {
    pers: any;
    classes: ClassI[];
    eligibleMulticlassClasses: ClassI[];
    mainClassLevel: number;
    onNextDisabledChange?: (disabled: boolean) => void;
}) {
    const { formData, updateFormData } = usePersFormStore();

    const levelUpPath = formData.levelUpPath as "EXISTING" | "MULTICLASS" | undefined;
    const chosenClassId = useMemo(() => {
        const raw = formData.classId;
        const id = typeof raw === "number" ? raw : typeof raw === "string" ? Number(raw) : NaN;
        return Number.isFinite(id) ? id : undefined;
    }, [formData.classId]);

    const existingEntries = useMemo(() => {
        const entries: Array<{ classId: number; classLevel: number; isMain: boolean }> = [];
        entries.push({ classId: pers.classId, classLevel: mainClassLevel, isMain: true });
        (pers.multiclasses || []).forEach((m: any) => {
            entries.push({ classId: m.classId, classLevel: m.classLevel, isMain: false });
        });
        return entries;
    }, [pers.classId, pers.multiclasses, mainClassLevel]);

    const getClassName = (classId: number) => {
        const cls = classes.find((c) => c.classId === classId);
        if (!cls) return ` #${classId}`;
        return classTranslations[cls.name] || classTranslationsEng[cls.name] || cls.name;
    };

    useEffect(() => {
        const disabled = !levelUpPath || !chosenClassId;
        onNextDisabledChange?.(disabled);
    }, [levelUpPath, chosenClassId, onNextDisabledChange]);

    const resetLevelUpChoices = () => {
        updateFormData({
            subclassId: undefined,
            classChoiceSelections: {},
            subclassChoiceSelections: {},
            classOptionalFeatureSelections: {},
            customAsi: [],
            featId: undefined,
            featChoiceSelections: {},
            levelUpHpIncrease: undefined,
        });
    };

    const selectPath = (path: "EXISTING" | "MULTICLASS") => {
        if (levelUpPath === path) return;
        updateFormData({ levelUpPath: path, classId: undefined });
        resetLevelUpChoices();
    };

    const selectExistingClass = (classId: number) => {
        updateFormData({ classId });
        resetLevelUpChoices();
    };

    const baseStats = {
        STR: pers.str,
        DEX: pers.dex,
        CON: pers.con,
        INT: pers.int,
        WIS: pers.wis,
        CHA: pers.cha,
    } as Record<Ability, number>;

    return (
        <div className="space-y-4">
            <Card className="glass-card">
                <CardHeader>
                    <CardTitle>:  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                    <div className="flex flex-wrap gap-2">
                        <Button
                            type="button"
                            variant="outline"
                            className={
                                "border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white " +
                                (levelUpPath === "EXISTING" ? "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100" : "")
                            }
                            onClick={() => selectPath("EXISTING")}
                        >
                               
                        </Button>
                        <Button
                            type="button"
                            variant="outline"
                            className={
                                "border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white " +
                                (levelUpPath === "MULTICLASS" ? "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100" : "")
                            }
                            onClick={() => selectPath("MULTICLASS")}
                        >
                               ()
                        </Button>
                    </div>

                    {levelUpPath === "EXISTING" ? (
                        <div className="space-y-3">
                            <p className="text-sm text-slate-400"> ,   +1 .</p>
                            <div className="grid gap-3 sm:grid-cols-2">
                                {existingEntries.map((entry) => {
                                    const isSelected = chosenClassId === entry.classId;
                                    const cls = classes.find(c => c.classId === entry.classId);
                                    return (
                                        <div key={entry.classId} className="relative group/card">
                                            <Card
                                                className={clsx(
                                                    "glass-card cursor-pointer backdrop-blur-xl transition hover:bg-white/10 active:scale-[0.98]",
                                                    isSelected ? "glass-active ring ring-cyan-500/30 border-cyan-500/50" : "border-white/10"
                                                )}
                                                onClick={() => selectExistingClass(entry.classId)}
                                            >
                                                <CardContent className="p-4">
                                                    <p className="text-lg font-semibold text-white">{getClassName(entry.classId)}</p>
                                                    <p className="text-xs text-slate-400"> : {entry.classLevel}</p>
                                                    {entry.isMain ? (
                                                        <p className="mt-1 text-[10px] font-bold uppercase tracking-widest text-cyan-500/70"> </p>
                                                    ) : null}
                                                </CardContent>
                                            </Card>
                                            
                                            {cls && (
                                                <InfoDialog title={getClassName(entry.classId)} triggerLabel=" ">
                                                    <InfoGrid>
                                                        <InfoPill label=" " value={`d${cls.hitDie}`} />
                                                        <InfoPill label="" value={SPELLCASTING_LABELS[cls.spellcastingType] ?? ""} />
                                                        <InfoPill label="  " value={` ${cls.subclassLevel}`} />
                                                        <InfoPill label="" value={formatAbilityList(cls.savingThrows)} />
                                                        <InfoPill label="" value={formatSkillProficiencies(cls.skillProficiencies)} />
                                                        <InfoPill label="" value={formatToolProficiencies(cls.toolProficiencies, cls.toolToChooseCount)} />
                                                        <InfoPill label="" value={formatWeaponProficiencies(cls.weaponProficiencies)} />
                                                        <InfoPill label="" value={formatArmorProficiencies(cls.armorProficiencies)} />
                                                        <InfoPill label="" value={formatLanguages(cls.languages, cls.languagesToChooseCount)} />
                                                        <InfoPill label="" value={formatMulticlassReqs(cls.multiclassReqs)} />
                                                        {cls.primaryCastingStat ? (
                                                            <InfoPill label=" " value={attributesUkrShort[cls.primaryCastingStat]} />
                                                        ) : null}
                                                    </InfoGrid>

                                                    <div className="space-y-4 pt-4">
                                                        <InfoSectionTitle> </InfoSectionTitle>
                                                        {cls.features && cls.features.length > 0 ? (
                                                            <div className="space-y-2">
                                                                {[...cls.features]
                                                                    .sort((a, b) => (a.levelGranted || 0) - (b.levelGranted || 0))
                                                                    .map((f: any) => (
                                                                        <div key={f.classFeatureId} className="glass-panel border-gradient-rpg rounded-xl p-4 bg-white/5 border-white/10 shadow-inner">
                                                                            <div className="flex justify-between items-start mb-2">
                                                                                <span className="font-bold text-white">{f.feature?.name}</span>
                                                                                <Badge variant="outline" className="text-[10px] border-white/10 text-slate-400"> {f.levelGranted}</Badge>
                                                                            </div>
                                                                            <FormattedDescription content={f.feature?.description} className="text-sm text-slate-300 leading-relaxed" />
                                                                        </div>
                                                                    ))
                                                                }
                                                            </div>
                                                        ) : (
                                                            <p className="text-sm text-slate-400 italic">   .</p>
                                                        )}
                                                    </div>
                                                </InfoDialog>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    ) : null}

                    {levelUpPath === "MULTICLASS" ? (
                        <div className="space-y-3">
                            <p className="text-sm text-slate-400">
                                  ,      ( {" "}
                                <span className="font-semibold text-slate-200">13+</span>).
                            </p>

                            <div className="glass-panel border-gradient-rpg rounded-xl p-3 text-sm text-slate-300">
                                <p className="font-semibold text-slate-100"> </p>
                                <p className="mt-1 flex flex-wrap gap-x-3 gap-y-1">
                                    {Object.entries(baseStats).map(([k, v]) => (
                                        <span key={k}>
                                            {attributesUkrShort[k as Ability]}: <span className="text-slate-100">{v}</span>
                                        </span>
                                    ))}
                                </p>
                            </div>

                            {eligibleMulticlassClasses.length ? (
                                <ClassesForm
                                    classes={eligibleMulticlassClasses}
                                    formId="multiclass-classes-form"
                                    mode="wizard"
                                    onClassSelected={(classId) => {
                                        updateFormData({ classId });
                                        resetLevelUpChoices();
                                    }}
                                    onNextDisabledChange={onNextDisabledChange}
                                />
                            ) : (
                                <Card className="glass-card p-4 text-center text-slate-200">
                                         (  13+).
                                </Card>
                            )}
                        </div>
                    ) : null}
                </CardContent>
            </Card>
        </div>
    );
}
</file>

<file path="src/lib/components/ui/card.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "glass-card rounded-xl text-card-foreground",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "font-rpg-display font-semibold uppercase leading-none tracking-wider text-amber-50/90 drop-shadow-[0_2px_10px_rgba(99,102,241,0.25)]",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
</file>

<file path="src/lib/stores/persFormStore.ts">
import {PersFormData} from "@/lib/zod/schemas/persCreateSchema";
import {create} from "zustand";
import {createJSONStorage, persist} from "zustand/middleware";

interface FormStore {
  formData: Partial<PersFormData>
  currentStep: number
  prevRaceId: number | null
  totalSteps: number
  isHydrated: boolean

  updateFormData: (data: Partial<PersFormData>) => void
  setCurrentStep: (step: number) => void
  setTotalSteps: (total: number) => void
  resetForm: () => void;
  nextStep: () => void;
  prevStep: () => void;
  setPrevRaceId: (id: number) => void;
  setHydrated: (hydrated: boolean) => void;
}

export const usePersFormStore = create<FormStore>()(
  persist(
    (set) => ({
      formData: {},
      currentStep: 1,
      prevRaceId: null,
      totalSteps: 7,
      isHydrated: false,

      updateFormData: (data) =>
        set((state) => {
          const next = { ...state.formData, ...data };

          // avoid re-render loops when values are unchanged (deep-ish compare)
          const isEqualValue = (a: unknown, b: unknown) => {
            if (a === b) return true;
            if (typeof a === "object" && typeof b === "object") {
              try {
                return JSON.stringify(a) === JSON.stringify(b);
              } catch {
                return false;
              }
            }
            return false;
          };

          const changed = Object.keys(next).some((key) => {
            const k = key as keyof PersFormData;
            return !isEqualValue(state.formData[k], next[k]);
          });

          return changed ? { formData: next } : state;
        }),

      setCurrentStep: (step: number) => set({currentStep: step}),
      setTotalSteps: (total: number) => set({ totalSteps: total }),

      resetForm: () => set({formData: {}, currentStep: 1, prevRaceId: null, totalSteps: 7}),

      nextStep: () =>
        set((state) => ({
          currentStep: Math.min(state.currentStep + 1, state.totalSteps || 7)
        })),

      prevStep: () =>
        set((state) => ({
          currentStep: Math.max(state.currentStep - 1, 1)
        })),
      setPrevRaceId: (id: number) => set({ prevRaceId: id }),
      setHydrated: (hydrated: boolean) => set({ isHydrated: hydrated }),
    }),
    {
      name: "dnd-pers-form",
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({
        formData: state.formData,
        currentStep: state.currentStep,
        totalSteps: state.totalSteps,
      }),
      onRehydrateStorage: () => (state) => {
        // Called after state is hydrated from storage
        if (state) {
          state.setHydrated(true);
        }
      }
    }
  )
)
</file>

<file path="src/lib/types/model-types.ts">
// model-types.ts

// 1.    Prisma
import {
  Ability,
  Armor,
  ArmorType,
  Background,
  BackgroundCategory,
  Class,
  ClassFeature,
  ClassStartingEquipmentOption,
  DamageType,
  EquipmentPack,
  EquipmentPackCategory,
  Feat,
  Feature,
  Infusion,
  InfusionTargetType,
  ItemRarity,
  Language,
  MagicItem,
  MagicItemType,
  Pers,
  PersArmor,
  PersFeat,
  PersInfusion,
  PersMagicItem,
  PersSkill,
  PersWeapon,
  Prisma,
  Race,
  RaceChoiceOption,
  RaceVariant,
  RaceTrait,
  RestType,
  Skills,
  Source,
  Spell,
  Subclass,
  SubclassFeature,
  ToolCategory,
  Weapon,
  WeaponCategory,
  WeaponProperty,
  WeaponType,
  SubclassChoiceOption,
  ChoiceOption,
  ChoiceOptionFeature,
} from '@prisma/client';

//       enum Skill  
//          Skill  Skills
import { Skill } from './enums';

// ============================================================================
// 2. JSON-,      
// ============================================================================

// 2.1. Skill proficiencies

export type SkillProficienciesArray = Skills[];

export type SkillProficienciesChoice = {
  options: Skill[]; //  Skills[],     Prisma
  choiceCount: number;
  chooseAny?: boolean;
};

export type SkillProficiencies = SkillProficienciesArray | SkillProficienciesChoice;

// 2.2. Race ASI

type AbilityScoreMap = Partial<Record<Ability, number>>;

type AbilityGroup = {
  groupName: string;
  value: number;
  choiceCount: number;
  unique: boolean;
};

type FlexibleASIGroup = {
  groups: AbilityGroup[];
};

export type RaceASI = {
  basic?: {
    simple: AbilityScoreMap;      //  { STR: 2, CON: 1 }
    flexible?: FlexibleASIGroup;  //  
  };
  tasha?: {
    flexible: FlexibleASIGroup;
  };
};

// 2.3. Weapon / Tool proficiencies

export type WeaponProficiencies = {
  category?: WeaponCategory[];
  type?: WeaponType[];
};

export type WeaponProficienciesSpecial = {
  specific: WeaponCategory[];
};

export type ToolProficiencies = ToolCategory[];

// 2.4. Multiclass requirements

export type MulticlassReqs = {
  required: Ability[]; //     . 
  score: number;       //  13
};

// 2.5. AC  (Feature.modifiesAC / prerequisites / Race.ac)

// ,   prerequisites  AC:
export type ACPrerequisiteTag = 'UNARMORED' | 'NO_SHIELD';

//  1:
// modifiesAC: {
//   base: 10,
//   bonus: { stats: ['DEX', 'WIS'] },
//   prerequisites: ['UNARMORED', 'NO_SHIELD']
// }
export type ACStatBonus = {
  stats: Ability[];
};

export type ACBaseFormula = {
  base: number;
  bonus?: ACStatBonus | null;
  prerequisites?: ACPrerequisiteTag[];
};

//  2:
// modifiesAC: {
//   naturalArmor: { baseAC: 17, addsDex: false }
// }
export type NaturalArmorAC = {
  naturalArmor: {
    baseAC: number;
    addsDex: boolean;
  };
  prerequisites?: ACPrerequisiteTag[];
};

export type ModifiesAC = ACBaseFormula | NaturalArmorAC;

// Race.ac :
//
// ac: { base: 17, bonus: null }
// ac: { base: 13, bonus: Ability.DEX }
// ac: { consistentBonus: 1 }
export type RaceAC =
  | {
  base: number;
  bonus: Ability | null;
}
  | {
  consistentBonus: number;
};

// 2.6. Bonus to saving throws
//
// bonusToSavingThrows: {
//   abilities: ['STR', 'DEX', ...],
//   bonus: 1,
// }

export type BonusToSavingThrows = {
  abilities: Ability[];
  bonus: number;
};

// 2.7. SkillExpertises
//
// skillExpertises: {
//   chooseFromCurrentProficiencies: true,
//   count: 2
// }
//
// skillExpertises: {
//   chooseFromCurrentProficiencies: true
// }

export type SkillExpertises = {
  chooseFromCurrentProficiencies: boolean;
  count?: number;
};

// 2.8. usesCountSpecial   ,   

//  1:   
//
// usesCountSpecial: [
//   { lvl: 2, uses: 1 },
//   { lvl: 17, uses: 2 },
// ]
export type UsesCountPerLevel = {
  lvl: number;
  uses: number;
};

export type UsesCountSpecialArray = UsesCountPerLevel[];

//  2:   
//
// usesCountSpecial: {
//   type: 'FORMULA',
//   group: 'STAT_BASED',
//   base: 1,
//   stat: 'CHA',
//   operation: 'ADD',
// }
export type UsesCountFormulaGroup = 'STAT_BASED' | 'LEVEL_BASED';
export type UsesCountFormulaOperation = 'ADD' | 'MULTIPLY';

export type UsesCountSpecialFormulaStatBased = {
  type: 'FORMULA';
  group: 'STAT_BASED';
  base: number;
  stat: Ability;
  operation: UsesCountFormulaOperation;
};

//  3:   
//
// usesCountSpecial: {
//   type: 'FORMULA',
//   group: 'LEVEL_BASED',
//   multiplier: 5,
//   operation: 'MULTIPLY',
// }
export type UsesCountSpecialFormulaLevelBased = {
  type: 'FORMULA';
  group: 'LEVEL_BASED';
  multiplier: number;
  operation: UsesCountFormulaOperation;
};

//  4: STATIC_FROM_STAT
//
// usesCountSpecial: {
//   type: 'STATIC_FROM_STAT',
//   stat: 'CHA'
// }
export type UsesCountSpecialStaticFromStat = {
  type: 'STATIC_FROM_STAT';
  stat: Ability;
};

//  :
export type UsesCountSpecial =
  | UsesCountSpecialArray
  | UsesCountSpecialFormulaStatBased
  | UsesCountSpecialFormulaLevelBased
  | UsesCountSpecialStaticFromStat;

// 2.9. miscSaveBonuses
//
// miscSaveBonuses: Record<Ability, number>
export type MiscSaveBonuses = Partial<Record<Ability, number>>;

// 2.10. prerequisites
//
// prerequisites: { level: 5, pact: 'Pact of the Chain' }
// prerequisites: { level: 5 }
// prerequisites: ['UNARMORED']
// prerequisites: ['UNARMORED', 'NO_SHIELD']
// prerequisites: { subclass: 'BATTLE_MASTER' }

export type PrerequisiteSimpleTag = ACPrerequisiteTag;

export type PrerequisiteObject = {
  level?: number;
  pact?: string;
  subclass?: string;
};

export type Prerequisites = PrerequisiteSimpleTag[] | PrerequisiteObject;

// ============================================================================
// 3. Prisma payload  ( explicit include ,    findMany)
// ============================================================================

// 3.1. Race

export type RacePrisma = Prisma.RaceGetPayload<{
  include: {
    subraces: {
      include: {
        traits: {
          include: {
            feature: true;
          };
        };
      };
    };
    raceChoiceOptions: true;
    raceVariants: {
      include: {
        traits: {
          include: {
            feature: true;
          };
        };
      };
    };
    traits: {
      include: {
        feature: true;
      };
    };
  };
}>;

// 3.2. Class

export type ClassPrisma = Prisma.ClassGetPayload<{
  include: {
    subclasses: {
      include: {
        features: {
          include: {
            feature: true;
          };
        };
        expandedSpells: true;
        subclassChoiceOptions: {
          include: {
            choiceOption: {
              include: {
                features: {
                  include: {
                    feature: true;
                  };
                };
              };
            };
          };
        };
      };
    };
    startingEquipmentOption: {
      include: {
        weapon: true;
        armor: true;
        equipmentPack: true;
      };
    };
    classChoiceOptions: {
      include: {
        choiceOption: {
          include: {
            features: {
              include: {
                feature: true;
              };
            };
          };
        };
      };
    };
    classOptionalFeatures: {
      include: {
        feature: true;
        replacesFeatures: {
          include: {
            replacedFeature: true;
          };
        };
      };
    };
    features: {
      include: {
        feature: true;
      };
    };
  };
}>;

// 3.3. Background

export type BackgroundPrisma = Background;

// 3.4. Feature

export type FeaturePrisma = Prisma.FeatureGetPayload<{
  include: {
    classFeatures: {
      include: {
        class: true;
      };
    };
    subclassFeatures: {
      include: {
        subclass: true;
      };
    };
    raceTraits: {
      include: {
        race: true;
      };
    };
    subraceTraits: {
      include: {
        subrace: true;
      };
    };
    raceVariantTraits: {
      include: {
        raceVariant: true;
      };
    };
    raceChoiceOptionTraits: {
      include: {
        raceChoiceOption: true;
      };
    };
    choiceOptionFeatures: {
      include: {
        option: true;
      };
    };
    featFeatures: {
      include: {
        feat: true;
      };
    };
    infusions: true;
    givesSpells: true;
  };
}>;



// 3.6. MagicItem

export type MagicItemPrisma = Prisma.MagicItemGetPayload<{
  include: {
    persMagicItems: {
      include: {
        pers: true;
      };
    };
    givesSpells: true;
    replicatedByInfusions: true;
  };
}>;

// 3.7. Weapon / Armor / EquipmentPack

export type WeaponPrisma = Prisma.WeaponGetPayload<{
  include: {
    persWeapons: {
      include: {
        pers: true;
      };
    };
    classStartingEquipmentOption: true;
  };
}>;

export type ArmorPrisma = Prisma.ArmorGetPayload<{
  include: {
    persArmor: {
      include: {
        pers: true;
      };
    };
    classStartingEquipmentOption: true;
  };
}>;

export type EquipmentPackPrisma = Prisma.EquipmentPackGetPayload<{
  include: {
    classStartingEquipmentOptions: true;
  };
}>;

// 3.8. Pers ()

export type PersPrisma = Prisma.PersGetPayload<{
  include: {
    user: true;
    class: true;
    subclass: true;
    race: true;
    subrace: true;
    background: true;
    skills: true;
    multiclasses: {
      include: {
        class: true;
        subclass: true;
      };
    };
    features: {
      include: {
        feature: true;
      };
    };
    spells: true;
    feats: {
      include: {
        feat: true;
      };
    };
    armors: {
      include: {
        armor: true;
      };
    };
    weapons: {
      include: {
        weapon: true;
      };
    };
    magicItems: {
      include: {
        magicItem: true;
      };
    };
    raceVariants: true;
    raceChoiceOptions: true;
    choiceOptions: true;
    classOptionalFeatures: true;
    persInfusions: {
      include: {
        infusion: true;
        weapon: true;
        armor: true;
        magicItem: true;
      };
    };
  };
}>;

// 3.9. Spell

export type SpellPrisma = Prisma.SpellGetPayload<{
  include: {
    spellClasses: true;
    spellRaces: true;
    spellbookSpells: true;
    subclasses: true;
    perses: true;
    features: true;
    magicItems: true;
  };
}>;

// 3.10. Feat

export type FeatPrisma = Prisma.FeatGetPayload<{
  include: {
    grantsFeature: true;
    featChoiceOptions: {
      include: {
        choiceOption: {
          include: {
            features: {
              include: {
                feature: true;
              };
            };
          };
        };
      };
    };
  };
}>;

// ============================================================================
// 4.  I-*   JSON-
// ============================================================================

export type AbilityKey = keyof typeof Ability;

// 4.1. RaceI  Race + subraces +    JSON

export type RaceI = Omit<
  RacePrisma,
  'ASI' | 'skillProficiencies' | 'toolProficiencies' | 'weaponProficiencies' | 'ac'
> & {
  ASI: RaceASI;
  skillProficiencies: SkillProficiencies | null;
  toolProficiencies: ToolProficiencies | null;
  weaponProficiencies: WeaponProficiencies | null;
  ac: RaceAC | null;
};

// 4.2. ClassI  Class +   +  JSON-

export type ClassI = Omit<
  ClassPrisma,
  'skillProficiencies' | 'weaponProficiencies' | 'weaponProficienciesSpecial' | 'multiclassReqs'
> & {
  skillProficiencies: SkillProficiencies;
  weaponProficiencies: WeaponProficiencies;
  weaponProficienciesSpecial: WeaponProficienciesSpecial | null;
  multiclassReqs: MulticlassReqs;
};

// 4.3. BackgroundI  Background   skill/tool JSON

export interface BackgroundI
  extends Omit<BackgroundPrisma, 'skillProficiencies' | 'toolProficiencies'> {
  skillProficiencies: SkillProficiencies;
  toolProficiencies: ToolProficiencies;
}

// 4.4. FeatureI    JSON-,    

export interface FeatureI
  extends Omit<
    FeaturePrisma,
    'modifiesAC' | 'bonusToSavingThrows' | 'skillProficiencies' | 'skillExpertises' | 'usesCountSpecial'
  > {
  modifiesAC?: ModifiesAC | null;
  bonusToSavingThrows?: BonusToSavingThrows | null;
  skillProficiencies?: SkillProficiencies | null;
  skillExpertises?: SkillExpertises | null;
  usesCountSpecial?: UsesCountSpecial | null;
}

// 4.5. PersI   miscSaveBonuses

export interface PersI extends Omit<PersPrisma, 'miscSaveBonuses'> {
  miscSaveBonuses?: MiscSaveBonuses | null;
}

// 4.6. MagicItemI     weaponProficiencies JSON

export interface MagicItemI
  extends Omit<MagicItemPrisma, 'weaponProficiencies' | 'weaponProficienciesSpecial'> {
  weaponProficiencies?: WeaponProficiencies | null;
  weaponProficienciesSpecial?: WeaponProficienciesSpecial | null;
}

// ============================================================================
// 5.   alias' (   )
// ============================================================================

export interface SubclassI extends Subclass {
  subclassChoiceOptions: (SubclassChoiceOption & {
    choiceOption: ChoiceOption & {
      features: (ChoiceOptionFeature & {
        feature: Feature
      })[]
    }
  })[];
}

export type {
  Ability,
  Armor,
  ArmorType,
  Background,
  BackgroundCategory,
  Class,
  ClassFeature,
  ClassStartingEquipmentOption,
  DamageType,
  EquipmentPack,
  EquipmentPackCategory,
  Feat,
  Feature,
  Infusion,
  InfusionTargetType,
  ItemRarity,
  Language,
  MagicItem,
  MagicItemType,
  Pers,
  PersArmor,
  PersFeat,
  PersInfusion,
  PersMagicItem,
  PersSkill,
  PersWeapon,
  Race,
  RaceChoiceOption,
  RaceVariant,
  RaceTrait,
  RestType,
  Skills,
  Source,
  Spell,
  Subclass,
  SubclassFeature,
  ToolCategory,
  Weapon,
  WeaponCategory,
  WeaponProperty,
  WeaponType,
  SubclassChoiceOption,
  ChoiceOption,
  ChoiceOptionFeature,
};

// ============================================================================
// 6. Bonus Types for Custom Modifications
// ============================================================================

export type StatBonuses = Partial<Record<Ability, number>>;
export type SkillBonuses = Partial<Record<Skills, number>>;

export interface SimpleBonusValue {
  value: number;
}

export type SimpleBonusField = 'hp' | 'ac' | 'speed' | 'proficiency' | 'initiative' | 'spellAttack' | 'spellDC';

// PersWithBonuses - adds strongly typed bonus fields (overriding Json? from Prisma)
export type PersWithBonuses = Omit<
  Pers,
  'statBonuses' | 'statModifierBonuses' | 'saveBonuses' | 'skillBonuses' |
  'hpBonuses' | 'acBonuses' | 'speedBonuses' | 'proficiencyBonuses' |
  'initiativeBonuses' | 'spellAttackBonuses' | 'spellDCBonuses'
> & {
  statBonuses: StatBonuses | null;
  statModifierBonuses: StatBonuses | null;
  saveBonuses: StatBonuses | null;
  skillBonuses: SkillBonuses | null;
  hpBonuses: SimpleBonusValue | null;
  acBonuses: SimpleBonusValue | null;
  speedBonuses: SimpleBonusValue | null;
  proficiencyBonuses: SimpleBonusValue | null;
  initiativeBonuses: SimpleBonusValue | null;
  spellAttackBonuses: SimpleBonusValue | null;
  spellDCBonuses: SimpleBonusValue | null;
};

export type BonusType = 'stat' | 'statModifier' | 'save' | 'skill' | SimpleBonusField;
</file>

<file path="src/lib/auth.ts">
import NextAuth, { NextAuthConfig } from "next-auth"
import { OAuth2Client } from "google-auth-library";
import { PrismaAdapter } from "@auth/prisma-adapter";
import Google from "@auth/core/providers/google";
import Credentials from "@auth/core/providers/credentials";
import { prisma } from "@/lib/prisma";
import type { User } from "@prisma/client";

const googleClient = new OAuth2Client();

export const config = {
  secret: process.env.AUTH_SECRET,
  trustHost: true,
  adapter: PrismaAdapter(prisma),
  session: { strategy: "jwt" },
  providers: [
    Google({
      clientId: process.env.AUTH_GOOGLE_ID,
      clientSecret: process.env.AUTH_GOOGLE_SECRET,
    }),
    Credentials({
      id: "google-onetap",
      name: "Google One Tap",
      credentials: {
        id_token: { label: "ID Token", type: "text" },
      },
      async authorize(creds) {
        try {
          const idToken = creds?.id_token as string | undefined;
          if (!idToken) {
            console.error("No ID token provided");
            return null;
          }

          const ticket = await googleClient.verifyIdToken({
            idToken,
            audience: process.env.AUTH_GOOGLE_ID,
          });
          const payload = ticket.getPayload();
          if (!payload) {
            console.error("No payload in ticket");
            return null;
          }

          const sub = payload.sub;
          const email = payload.email;
          const email_verified = payload.email_verified;
          const name = payload.name ?? "";
          const picture = payload.picture ?? "";

          if (!sub || !email || email_verified !== true) {
            console.error("Invalid payload data", { sub, email, email_verified });
            return null;
          }
          let user: User | null = await prisma.account.findUnique({
            where: {
              provider_providerAccountId: {
                provider: "google",
                providerAccountId: sub,
              }
            },
            include: { user: true }
          }).then((acc) => acc?.user ?? null);
          if (!user) {
            user = await prisma.user.findUnique({
              where: { email }
            });

            if (!user) {
              user = await prisma.user.create({
                data: {
                  email,
                  name,
                  image: picture || null,
                  emailVerified: new Date(), 
                }
              });
            }
            await prisma.account.create({
              data: {
                userId: user.id,
                type: "oauth", 
                provider: "google",
                providerAccountId: sub,
              }
            });
          }

          if (!user) {
            return null;
          }

          return {
            id: String(user.id),
            email: user.email,
            name: user.name,
            image: user.image,
          };
        } catch (error) {
          console.error("Authorization error:", error);
          return null;
        }
      },
    }),
  ],

  callbacks: {
    async jwt({ token, user }) {
      if (user) token.userId = user.id as string;
      return token;
    },
    async session({ session, token }) {
      if (token?.userId) session.user.id = token.userId as string;
      return session;
    }
  },

  debug: process.env.NODE_ENV === "development",
} satisfies NextAuthConfig;

export const { auth, handlers, signIn, signOut } = NextAuth(config);
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

/src/generated/prisma

.idea
</file>

<file path="eslint.config.mjs">
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  {
    ignores: [
      "**/node_modules/**",
      "**/.next/**",
      "**/out/**",
      "**/build/**",
      "next-env.d.ts",
      "test_pg.js",
    ],
  },
  ...compat.extends("next/core-web-vitals", "next/typescript"),
  {
    rules: {
      '@typescript-eslint/no-explicit-any': 'warn',
      '@typescript-eslint/no-unused-vars': ['warn', { 
        argsIgnorePattern: '^_',
        varsIgnorePattern: '^_',
        caughtErrorsIgnorePattern: '^_'
      }],
    }
  },
];

export default eslintConfig;
</file>

<file path="prisma/models/pers/Pers.prisma">
model Pers {
  persId Int    @id @default(autoincrement()) @map("pers_id")
  userId Int    @map("user_id")
  name   String @db.VarChar(100)
  level  Int    @default(1)

  currentSpellSlots Int[] @default([]) @map("current_spell_slots")
  currentPactSlots  Int   @default(0) @map("current_pact_slots")

  classId    Int  @map("class_id")
  subclassId Int? @map("subclass_id")

  backgroundId Int @map("background_id")

  raceId    Int  @map("race_id")
  subraceId Int? @map("subrace_id")

  currentHp Int @map("current_hp")
  maxHp     Int @map("max_hp")
  tempHp    Int @default(0) @map("temp_hp")

  deathSaveSuccesses Int @default(0) @map("death_save_successes")
  deathSaveFailures  Int @default(0) @map("death_save_failures")
  isDead             Boolean @default(false) @map("is_dead")

  persSpells PersSpell[]

  raceCustom           String @default("") @map("race_custom") @db.VarChar(100)
  classCustom          String @default("") @map("class_custom") @db.VarChar(100)
  alignment            String @default("") @db.VarChar(100)
  xp                   Int    @default(0)
  customBackground     String @default("") @map("custom_background") @db.VarChar(100)
  customProficiencies  String @default("") @map("custom_proficiencies") @db.Text
  customFeatures       String @default("") @map("custom_features") @db.Text
  customLanguagesKnown String @default("") @map("custom_languages_known") @db.Text
  customEquipment      String @default("") @map("custom_equipment") @db.Text
  personalityTraits    String @default("") @map("personality_traits") @db.Text
  ideals               String @default("") @db.Text
  bonds                String @default("") @db.Text
  flaws                String @default("") @db.Text
  backstory            String @default("") @db.Text
  notes                String @default("") @db.Text

  str Int
  dex Int
  con Int
  int Int
  wis Int
  cha Int

  cp String @default("0")
  ep String @default("0")
  sp String @default("0")
  gp String @default("0")
  pp String @default("0")

  additionalSaveProficiencies Ability[] @default([]) @map("additional_save_proficiencies")
  miscSaveBonuses             Json?     @map("misc_save_bonuses")

  wearsShield           Boolean @default(false) @map("wears_shield")
  additionalShieldBonus Int     @default(0) @map("additional_shield_bonus")
  armorBonus            Int     @default(0) @map("armor_bonus")
  wearsNaturalArmor     Boolean @default(false) @map("wears_natural_armor")

  // Custom Bonuses (JSON for flexibility)
  statBonuses           Json? @map("statbonuses")
  statModifierBonuses   Json? @map("statmodifierbonuses")
  saveBonuses           Json? @map("savebonuses")
  skillBonuses          Json? @map("skillbonuses")
  hpBonuses             Json? @map("hpbonuses")
  acBonuses             Json? @map("acbonuses")
  speedBonuses          Json? @map("speedbonuses")
  proficiencyBonuses    Json? @map("proficiencybonuses")
  initiativeBonuses     Json? @map("initiativebonuses")
  spellAttackBonuses    Json? @map("spellattackbonuses")
  spellDCBonuses        Json? @map("spelldcbonuses")

  // Hit Dice Tracking
  currentHitDice Json? @map("currenthitdice")
  usedHitDice    Json? @map("usedhitdice")

  // Character History (Snapshots)
  parentPersId  Int?     @map("parentpersid")
  isSnapshot    Boolean  @default(false) @map("issnapshot")
  snapshotLevel Int?     @map("snapshotlevel")
  isActive      Boolean  @default(true) @map("isactive")

  // Sharing
  shareToken String? @unique @map("sharetoken")


  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  class      Class      @relation(fields: [classId], references: [classId], onDelete: Cascade)
  subclass   Subclass?  @relation(fields: [subclassId], references: [subclassId], onDelete: Cascade)
  race       Race       @relation(fields: [raceId], references: [raceId], onDelete: Cascade)
  subrace    Subrace?   @relation(fields: [subraceId], references: [subraceId], onDelete: Cascade)
  background Background @relation(fields: [backgroundId], references: [backgroundId], onDelete: Cascade)

  skills                PersSkill[]
  multiclasses          PersMulticlass[]
  features              PersFeature[]
  spells                Spell[]
  feats                 PersFeat[]
  armors                PersArmor[]
  weapons               PersWeapon[]
  magicItems            PersMagicItem[]
  raceVariants          RaceVariant[]
  raceChoiceOptions     RaceChoiceOption[]
  choiceOptions         ChoiceOption[]
  classOptionalFeatures ClassOptionalFeature[]

  // Opposite side of PersInfusion.pers
  persInfusions PersInfusion[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("pers")
}
</file>

<file path="prisma/models/pers/PersArmor.prisma">
model PersArmor {
  persArmorId Int @id @default(autoincrement()) @map("pers_armor_id")
  armorId     Int @map("armor_id")
  persId      Int @map("pers_id")

  overrideBaseAC Int?    @map("override_base_ac")
  miscACBonus    Int?    @map("misc_ac_bonus")
  isProficient   Boolean @default(true) @map("is_proficient")

  equipped Boolean @default(false)

  pers  Pers  @relation(fields: [persId], references: [persId], onDelete: Cascade)
  armor Armor @relation(fields: [armorId], references: [armorId], onDelete: Cascade)

  // Opposite side of PersInfusion.armor
  infusions PersInfusion[]

  // unique_pers_armor constraint removed to allow multiple same-type armors
  @@map("pers_armor")
}
</file>

<file path="prisma/models/pers/PersWeapon.prisma">
model PersWeapon {
  persWeaponId Int @id @default(autoincrement()) @map("pers_weapon_id")
  persId       Int @map("pers_id")
  weaponId     Int @map("weapon_id")

  overrideDamage        String?     @map("override_damage")
  attackBonus           Int?        @map("attack_bonus")
  overrideName          String?     @map("override_name")
  overrideNormalRange   Int?        @map("override_normal_range")
  overrideLongRange     Int?        @map("override_long_range")
  overrideDamageType    DamageType? @map("override_damage_type")
  overrideAttackAbility Ability?    @map("override_attack_ability")

  isProficient Boolean @default(true) @map("is_proficient")

  // Custom bonuses and damage customization
  customAttackBonus   Json?    @map("customattackbonus")
  customDamageBonus   Json?    @map("customdamagebonus")
  customDamageCount   Int?     @map("customdamagecount")
  customDamageDice    String?  @map("customdamagedice")
  customDamageAbility Ability? @map("customdamageability")
  isMagical           Boolean  @default(false) @map("ismagical")


  pers   Pers   @relation(fields: [persId], references: [persId], onDelete: Cascade)
  weapon Weapon @relation(fields: [weaponId], references: [weaponId], onDelete: Cascade)

  // Opposite side of PersInfusion.weapon
  infusions PersInfusion[]

  // unique_pers_weapon constraint removed to allow multiple same-type weapons
  @@map("pers_weapon")
}
</file>

<file path="prisma/seed/optionalFeatureSeed.ts">
import { Classes, Prisma, PrismaClient } from "@prisma/client";
import ClassOptionalFeatureCreateInput = Prisma.ClassOptionalFeatureCreateInput;

export const seedClassOptionalFeatures = async (prisma: PrismaClient) => {
    console.log('  \'  ...')

    const features: ClassOptionalFeatureCreateInput[] = [
        {
            title: '  ?',

            grantedOnLevels: [4, 6, 8, 12, 14, 16, 19],
            replacesFightingStyle: true,

            class: { connect: { name: Classes.FIGHTER_2014 } }
        },
        {
            title: ' ?',

            grantedOnLevels: [4, 6, 8, 12, 14, 16, 19],
            replacesManeuver: true,

            prerequisites: {
                subclass: 'BATTLE_MASTER'
            },

            class: { connect: { name: Classes.FIGHTER_2014 } }
        },
        // Barbarian - Primal Knowledge
        {
            title: '  ?',

            feature: { connect: { engName: "Primal Knowledge" } },
            grantedOnLevels: [3, 10],
            class: { connect: { name: Classes.BARBARIAN_2014 } }
        },
        // Barbarian - Instinctive Pounce
        {
            feature: { connect: { engName: "Instinctive Pounce" } },
            grantedOnLevels: [7],
            class: { connect: { name: Classes.BARBARIAN_2014 } }
        },


        //MONKKKKKKKKKKKKK
        {
            feature: { connect: { engName: "Dedicated Weapon" } },
            grantedOnLevels: [2],
            class: { connect: { name: Classes.MONK_2014 } }
        },

        {
            feature: { connect: { engName: "Ki-Fueled Attack" } },
            grantedOnLevels: [3],
            class: { connect: { name: Classes.MONK_2014 } }
        },
        {
            feature: { connect: { engName: "Quickened Healing" } },
            grantedOnLevels: [4],
            class: { connect: { name: Classes.MONK_2014 } }
        },
        {
            feature: { connect: { engName: "Focused Aim" } },
            grantedOnLevels: [5],
            class: { connect: { name: Classes.MONK_2014 } }
        },


        // ===== RANGER OPTIONAL FEATURES =====

// Deft Explorer ( Natural Explorer)
        {
            feature: { connect: { engName: "Deft Explorer - Roving" } },
            grantedOnLevels: [6],
            class: { connect: { name: Classes.RANGER_2014 } },

            appearsOnlyIfChoicesTaken: {
                connect: [
                    { optionNameEng: 'Deft Explorer - Canny' }
                ]
            }
        },
        {
            feature: { connect: { engName: "Deft Explorer - Tireless" } },
            grantedOnLevels: [10],
            class: { connect: { name: Classes.RANGER_2014 } },

            appearsOnlyIfChoicesTaken: {
                connect: [
                    { optionNameEng: 'Deft Explorer - Canny' }
                ]
            }
        },

// Martial Versatility
        {
            title: '  ?',

            grantedOnLevels: [4, 8, 12, 16, 19],
            replacesFightingStyle: true,
            class: { connect: { name: Classes.RANGER_2014 } }
        },

// Spellcasting Focus
        {
            feature: { connect: { engName: "Spellcasting Focus (Ranger)" } },
            grantedOnLevels: [2],
            class: { connect: { name: Classes.RANGER_2014 } }
        },

        // PALADIN


        // Harness Divine Power
        {
            feature: { connect: { engName: "Harness Divine Power" } },
            class: { connect: { name: Classes.PALADIN_2014 } },
            grantedOnLevels: [3, 7, 15],
        },

// Martial Versatility
        {
            title: '  ?',

            class: { connect: { name: Classes.PALADIN_2014 } },
            grantedOnLevels: [4, 8, 12, 16, 19], //   ASI
            replacesFightingStyle: true,
        },


        // ROGUEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE


        {
            class: { connect: { name: Classes.ROGUE_2014 } },
            grantedOnLevels: [3],
            feature: { connect: { engName: "Steady Aim" } },
        },


        // WARLOCKKKKKKKKKKKKKKKKKKKKKKKKK

        {
            title: '  ?',

            class: { connect: { name: Classes.WARLOCK_2014 } },
            grantedOnLevels: [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20],
            replacesInvocation: true,
        },

        // ===== SORCERER OPTIONALS =====
        {
            feature: { connect: { engName: "Magical Guidance" } },
            grantedOnLevels: [5],
            class: { connect: { name: Classes.SORCERER_2014 } },
        },
        {
            feature: { connect: { engName: "Sorcerous Versatility" } },
            grantedOnLevels: [4, 8, 12, 16, 19],
            class: { connect: { name: Classes.SORCERER_2014 } },
        },

        // ===== WIZARD OPTIONALS =====
        {
            feature: { connect: { engName: "Cantrip Formulas" } },
            grantedOnLevels: [3],
            class: { connect: { name: Classes.WIZARD_2014 } },
        },
    ]

    let seedIndex = 1;

    for (const feature of features) {
        await prisma.classOptionalFeature.upsert({
            where: { seedIndex },
            update: feature,
            create: {
                seedIndex,
                ...feature
            }
        })

        seedIndex++;
    }

    console.log('   :', features.length)
}
</file>

<file path="prisma/seed/raceVariantSeed.ts">
import { Prisma, PrismaClient, Variants, Source, Races } from "@prisma/client";

export const seedRaceVariants = async (prisma: PrismaClient) => {
    console.log('   ...');
    console.log('   Half-Elf ()...');
    console.log('   Dwarf ()...');
    console.log('   Halfling ()...');
    console.log('   Gnome ()...');
    console.log('   Elf ()...');
    console.log('   ...');

    const tiefling = await prisma.race.findFirst({ where: { name: Races.TIEFLING_2014 } });
    if (!tiefling) {
        throw new Error("Tiefling race not found");
    }

    const human = await prisma.race.findFirst({ where: { name: Races.HUMAN_2014 } });
    if (!human) {
        throw new Error("Human race not found");
    }

    // Get the PHB Infernal Legacy feature to replace
    const phbInfernalLegacy =await prisma.feature.findFirst({ where: { engName: 'Infernal Legacy' } });
    if (!phbInfernalLegacy) {
        throw new Error("PHB Infernal Legacy feature not found");
    }

    const halfElf = await prisma.race.findFirst({ where: { name: Races.HALF_ELF_2014 } });
    if (!halfElf) {
        throw new Error("Half-Elf race not found");
    }

    const dwarf = await prisma.race.findFirst({ where: { name: Races.DWARF_2014 } });
    if (!dwarf) {
        throw new Error("Dwarf race not found");
    }

    const halfling = await prisma.race.findFirst({ where: { name: Races.HALFLING_2014 } });
    if (!halfling) {
        throw new Error("Halfling race not found");
    }

    const gnome = await prisma.race.findFirst({ where: { name: Races.GNOME_2014 } });
    if (!gnome) {
        throw new Error("Gnome race not found");
    }

    const halfOrc = await prisma.race.findFirst({ where: { name: Races.HALF_ORC_2014 } });
    if (!halfOrc) {
        throw new Error("Half-Orc race not found");
    }

    const elf = await prisma.race.findFirst({ where: { name: Races.ELF_2014 } });
    if (!elf) {
        throw new Error("Elf race not found");
    }

    const connectFeature = (engName: string) => ({ feature: { connect: { engName } } });

    const variants = [
        // ============ HUMAN VARIANT (PHB) ============
        {
            raceId: human.raceId,
            name: Variants.HUMAN_VARIANT,
            source: Source.PHB,
            overridesRaceASI: {
                basic: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 2,
                                unique: true
                            }
                        ]
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 2,
                                unique: true
                            }
                        ]
                    }
                }
            },
            traits: {
                create: []
            }
        },

        // ============ SCAG BLOODLINES ============
        
        // Asmodeus (PHB default, explicit variant)
        {
            raceId: tiefling.raceId,
            name: Variants.TIEFLING_ASMODEUS,
            source: Source.SCAG,
            overridesRaceASI: { CHA: 2, INT: 1 },
            replacesFeatures: {
                connect: [{ featureId: phbInfernalLegacy.featureId }]
            },
            exclusivityGroup: "tiefling_bloodline",
            traits: {
                create: [
                    connectFeature('Infernal Legacy (Asmodeus)')
                ]
            }
        },
        
        // Baalzebul
        {
            raceId: tiefling.raceId,
            name: Variants.TIEFLING_BAALZEBUL,
            source: Source.SCAG,
            overridesRaceASI: { CHA: 2, INT: 1 },
            replacesFeatures: {
                connect: [{ featureId: phbInfernalLegacy.featureId }]
            },
            exclusivityGroup: "tiefling_bloodline",
            traits: {
                create: [
                    connectFeature('Infernal Legacy (Baalzebul)')
                ]
            }
        },
        
        // Dispater
        {
            raceId: tiefling.raceId,
            name: Variants.TIEFLING_DISPATER,
            source: Source.SCAG,
            overridesRaceASI: { CHA: 2, DEX: 1 },
            replacesFeatures: {
                connect: [{ featureId: phbInfernalLegacy.featureId }]
            },
            exclusivityGroup: "tiefling_bloodline",
            traits: {
                create: [
                    connectFeature('Infernal Legacy (Dispater)')
                ]
            }
        },
        
        // Fierna
        {
            raceId: tiefling.raceId,
            name: Variants.TIEFLING_FIERNA,
            source: Source.SCAG,
            overridesRaceASI: { CHA: 2, WIS: 1 },
            replacesFeatures: {
                connect: [{ featureId: phbInfernalLegacy.featureId }]
            },
            exclusivityGroup: "tiefling_bloodline",
            traits: {
                create: [
                    connectFeature('Infernal Legacy (Fierna)')
                ]
            }
        },
        
        // Glasya
        {
            raceId: tiefling.raceId,
            name: Variants.TIEFLING_GLASYA,
            source: Source.SCAG,
            overridesRaceASI: { CHA: 2, DEX: 1 },
            replacesFeatures: {
                connect: [{ featureId: phbInfernalLegacy.featureId }]
            },
            exclusivityGroup: "tiefling_bloodline",
            traits: {
                create: [
                    connectFeature('Infernal Legacy (Glasya)')
                ]
            }
        },
        
        // Levistus
        {
            raceId: tiefling.raceId,
            name: Variants.TIEFLING_LEVISTUS,
            source: Source.SCAG,
            overridesRaceASI: { CHA: 2, CON: 1 },
            replacesFeatures: {
                connect: [{ featureId: phbInfernalLegacy.featureId }]
            },
            exclusivityGroup: "tiefling_bloodline",
            traits: {
                create: [
                    connectFeature('Infernal Legacy (Levistus)')
                ]
            }
        },
        
        // Mammon
        {
            raceId: tiefling.raceId,
            name: Variants.TIEFLING_MAMMON,
            source: Source.SCAG,
            overridesRaceASI: { CHA: 2, INT: 1 },
            replacesFeatures: {
                connect: [{ featureId: phbInfernalLegacy.featureId }]
            },
            exclusivityGroup: "tiefling_bloodline",
            traits: {
                create: [
                    connectFeature('Infernal Legacy (Mammon)')
                ]
            }
        },
        
        // Mephistopheles
        {
            raceId: tiefling.raceId,
            name: Variants.TIEFLING_MEPHISTOPHELES,
            source: Source.SCAG,
            overridesRaceASI: { CHA: 2, INT: 1 },
            replacesFeatures: {
                connect: [{ featureId: phbInfernalLegacy.featureId }]
            },
            exclusivityGroup: "tiefling_bloodline",
            traits: {
                create: [
                    connectFeature('Infernal Legacy (Mephistopheles)')
                ]
            }
        },
        
        // Zariel
        {
            raceId: tiefling.raceId,
            name: Variants.TIEFLING_ZARIEL,
            source: Source.SCAG,
            overridesRaceASI: { CHA: 2, STR: 1 },
            replacesFeatures: {
                connect: [{ featureId: phbInfernalLegacy.featureId }]
            },
            exclusivityGroup: "tiefling_bloodline",
            traits: {
                create: [
                    connectFeature('Infernal Legacy (Zariel)')
                ]
            }
        },
        
        // ============ MTOF VARIANTS ============
        
        // Devil's Tongue
        {
            raceId: tiefling.raceId,
            name: Variants.TIEFLING_VARIANT_DEVILS_TONGUE_SCAG,
            source: Source.SCAG,
            overridesRaceASI: { CHA: 2, INT: 1 },
            replacesFeatures: {
                connect: [{ featureId: phbInfernalLegacy.featureId }]
            },
            exclusivityGroup: "tiefling_mtof_variant",
            traits: {
                create: [
                    connectFeature('Infernal Legacy (Devil\'s Tongue)')
                ]
            }
        },
        
        // Hellfire
        {
            raceId: tiefling.raceId,
            name: Variants.TIEFLING_VARIANT_HELLFIRE_SCAG,
            source: Source.SCAG,
            overridesRaceASI: { CHA: 2, INT: 1 },
            replacesFeatures: {
                connect: [{ featureId: phbInfernalLegacy.featureId }]
            },
            exclusivityGroup: "tiefling_mtof_variant",
            traits: {
                create: [
                    connectFeature('Infernal Legacy (Hellfire)')
                ]
            }
        },
        
        // Winged
        {
            raceId: tiefling.raceId,
            name: Variants.TIEFLING_VARIANT_WINGED_SCAG,
            source: Source.SCAG,
            overridesRaceASI: { CHA: 2, INT: 1 },
            overridesFlightSpeed: 30,
            replacesFeatures: {
                connect: [{ featureId: phbInfernalLegacy.featureId }]
            },
            exclusivityGroup: "tiefling_mtof_variant",
            traits: {
                create: [
                    connectFeature('Winged Tiefling')
                ]
            }
        },

        // ============ HALF-ELF DRAGONMARKS (EBERRON) ============
        
        // Mark of Detection
        {
            raceId: halfElf.raceId,
            name: Variants.HALF_ELF_MARK_OF_DETECTION_EBERRON,
            source: Source.EBERRON,
            overridesRaceASI: { CHA: 2, INT: 1 },
            traits: {
                create: [
                    connectFeature('Deductive Intuition'),
                    connectFeature('Magical Detection'),
                    connectFeature('Spells of the Mark (Detection)')
                ]
            }
        },
        
        // Mark of Storm
        {
            raceId: halfElf.raceId,
            name: Variants.HALF_ELF_MARK_OF_STORM_EBERRON,
            source: Source.EBERRON,
            overridesRaceASI: { CHA: 2, DEX: 1 },
            traits: {
                create: [
                    connectFeature('Windwright\'s Intuition'),
                    connectFeature('Storm\'s Boon'),
                    connectFeature('Headwinds'),
                    connectFeature('Spells of the Mark (Storm)')
                ]
            }
        },

        // ============ DWARF DRAGONMARK (EBERRON) ============
        
        // Mark of Warding
        {
            raceId: dwarf.raceId,
            name: Variants.DWARF_MARK_OF_WARDING_EBERRON,
            source: Source.EBERRON,
            overridesRaceASI: { CON: 2, INT: 1 },
            traits: {
                create: [
                    connectFeature('Warder\'s Intuition'),
                    connectFeature('Wards and Seals'),
                    connectFeature('Spells of the Mark (Warding)')
                ]
            }
        },

        // ============ HALFLING DRAGONMARKS (EBERRON) ============
        
        // Mark of Healing
        {
            raceId: halfling.raceId,
            name: Variants.HALFLING_MARK_OF_HEALING_EBERRON,
            source: Source.EBERRON,
            overridesRaceASI: { DEX: 2, WIS: 1 },
            traits: {
                create: [
                    connectFeature('Medical Intuition'),
                    connectFeature('Healing Touch'),
                    connectFeature('Spells of the Mark (Healing)')
                ]
            }
        },
        // Mark of Hospitality
        {
            raceId: halfling.raceId,
            name: Variants.HALFLING_MARK_OF_HOSPITALITY_EBERRON,
            source: Source.EBERRON,
            overridesRaceASI: { DEX: 2, CHA: 1 },
            traits: {
                create: [
                    connectFeature('Ever-Hospitable'),
                    connectFeature('Innkeeper\'s Magic'),
                    connectFeature('Spells of the Mark (Hospitality)')
                ]
            }
        },

        // ============ GNOME DRAGONMARKS (EBERRON) ============

        // Mark of Scribing
        {
            raceId: gnome.raceId,
            name: Variants.GNOME_MARK_OF_SCRIBING_EBERRON,
            source: Source.EBERRON,
            overridesRaceASI: { INT: 2, CHA: 1 },
            traits: {
                create: [
                    connectFeature('Gifted Scribe'),
                    connectFeature('Scribe\'s Insight'),
                    connectFeature('Spells of the Mark (Scribing)')
                ]
            }
        },

        // ============ HUMAN DRAGONMARKS (EBERRON) ============

        // Mark of Finding (Human)
        {
            raceId: human.raceId,
            name: Variants.HUMAN_MARK_OF_FINDING_EBERRON,
            source: Source.EBERRON,
            overridesRaceASI: { WIS: 2, CON: 1 },
            traits: {
                create: [
                    connectFeature('Hunter\'s Intuition'),
                    connectFeature('Finder\'s Magic'),
                    connectFeature('Spells of the Mark (Finding)')
                ]
            }
        },
        // Mark of Handling
        {
            raceId: human.raceId,
            name: Variants.HUMAN_MARK_OF_HANDLING_EBERRON,
            source: Source.EBERRON,
            overridesRaceASI: { WIS: 2, CHA: 1 }, // Using CHA as "one other" +1 for simplicity, or should I leave it empty? ASI in variants is usually fixed.
            traits: {
                create: [
                    connectFeature('Wild Intuition'),
                    connectFeature('Primal Connection'),
                    connectFeature('The Bigger They Are'),
                    connectFeature('Spells of the Mark (Handling)')
                ]
            }
        },
        // Mark of Making
        {
            raceId: human.raceId,
            name: Variants.HUMAN_MARK_OF_MAKING_EBERRON,
            source: Source.EBERRON,
            overridesRaceASI: { INT: 2, DEX: 1 }, // Using DEX as "one other" +1
            traits: {
                create: [
                    connectFeature('Artisan\'s Intuition'),
                    connectFeature('Maker\'s Gift'),
                    connectFeature('Spellsmith'),
                    connectFeature('Spells of the Mark (Making)')
                ]
            }
        },
        // Mark of Passage
        {
            raceId: human.raceId,
            name: Variants.HUMAN_MARK_OF_PASSAGE_EBERRON,
            source: Source.EBERRON,
            overridesRaceASI: { DEX: 2, INT: 1 }, // Using INT as "one other" +1
            traits: {
                create: [
                    connectFeature('Intuition of the Voyager'),
                    connectFeature('Magical Passage'),
                    connectFeature('Spells of the Mark (Passage)')
                ]
            }
        },
        // Mark of Sentinel
        {
            raceId: human.raceId,
            name: Variants.HUMAN_MARK_OF_SENTINEL_EBERRON,
            source: Source.EBERRON,
            overridesRaceASI: { CON: 2, WIS: 1 },
            traits: {
                create: [
                    connectFeature('Sentinel\'s Intuition'),
                    connectFeature('Guardian\'s Shield'),
                    connectFeature('Vigilant Guardian'),
                    connectFeature('Spells of the Mark (Sentinel)')
                ]
            }
        },

        // ============ HALF-ORC DRAGONMARKS (EBERRON) ============

        // Mark of Finding (Half-Orc)
        {
            raceId: halfOrc.raceId,
            name: Variants.HALF_ORC_MARK_OF_FINDING_EBERRON, 
            source: Source.EBERRON,
            overridesRaceASI: { WIS: 2, STR: 1 },
            traits: {
                create: [
                    connectFeature('Hunter\'s Intuition'),
                    connectFeature('Finder\'s Magic'),
                    connectFeature('Spells of the Mark (Finding)')
                ]
            }
        },

        // ============ ELF DRAGONMARKS (EBERRON) ============

        // Mark of Shadow
        {
            raceId: elf.raceId,
            name: Variants.ELF_MARK_OF_SHADOW_EBERRON,
            source: Source.EBERRON,
            overridesRaceASI: { DEX: 2, CHA: 1 },
            traits: {
                create: [
                    connectFeature('Cunning Intuition'),
                    connectFeature('Shape Shadows'),
                    connectFeature('Spells of the Mark (Shadow)')
                ]
            }
        }
    ];

    type TraitCreateItem = { feature: { connect: { engName: string } } };
    type VariantSeed = (typeof variants)[number];

    const extractTraitEngNames = (variant: VariantSeed): string[] => {
        const raw = variant.traits?.create;
        if (!raw || !Array.isArray(raw)) return [];
        return (raw as TraitCreateItem[])
            .map((x) => x.feature.connect.engName)
            .filter((x): x is string => typeof x === "string" && x.trim().length > 0);
    };

    const allTraitEngNames = Array.from(
        new Set(variants.flatMap((v) => extractTraitEngNames(v)))
    );

    const featuresByEngName = new Map<string, number>();
    if (allTraitEngNames.length) {
        const featureRows = await prisma.feature.findMany({
            where: { engName: { in: allTraitEngNames } },
            select: { featureId: true, engName: true },
        });
        for (const row of featureRows) featuresByEngName.set(row.engName, row.featureId);

        const missing = allTraitEngNames.filter((name) => !featuresByEngName.has(name));
        if (missing.length) {
            console.warn(
                ` seedRaceVariants: missing features by engName (traits will be skipped): ${missing.join(", ")}`
            );
        }
    }

    const resolveTraitFeatureIds = (variant: VariantSeed): number[] => {
        const ids = extractTraitEngNames(variant)
            .map((name) => featuresByEngName.get(name))
            .filter((x): x is number => typeof x === "number");
        return Array.from(new Set(ids));
    };

    const reconcileVariantTraits = async (raceVariantId: number, desiredFeatureIds: number[]) => {
        const desired = new Set<number>(desiredFeatureIds);

        const existing = await prisma.raceVariantTrait.findMany({
            where: { raceVariantId },
            select: { raceVariantTraitId: true, featureId: true },
        });

        // Remove accidental duplicates (same featureId multiple times)
        const seenFeatureIds = new Set<number>();
        const duplicateIds: number[] = [];
        for (const row of existing) {
            if (seenFeatureIds.has(row.featureId)) duplicateIds.push(row.raceVariantTraitId);
            else seenFeatureIds.add(row.featureId);
        }
        if (duplicateIds.length) {
            await prisma.raceVariantTrait.deleteMany({
                where: { raceVariantTraitId: { in: duplicateIds } },
            });
        }

        const existingFeatureIds = new Set(existing.map((x) => x.featureId));

        const toDelete = Array.from(existingFeatureIds).filter((fid) => !desired.has(fid));
        if (toDelete.length) {
            await prisma.raceVariantTrait.deleteMany({
                where: { raceVariantId, featureId: { in: toDelete } },
            });
        }

        const toCreate = Array.from(desired).filter((fid) => !existingFeatureIds.has(fid));
        if (toCreate.length) {
            await prisma.raceVariantTrait.createMany({
                data: toCreate.map((featureId) => ({ raceVariantId, featureId })),
            });
        }
    };

    for (const variant of variants) {
        const existing = await prisma.raceVariant.findFirst({
            where: { name: variant.name, raceId: variant.raceId }
        });

        const desiredTraitFeatureIds = resolveTraitFeatureIds(variant);
        const { traits: _traits, ...variantData } = variant;

        if (existing) {
            await prisma.raceVariant.update({
                where: { raceVariantId: existing.raceVariantId },
                data: variantData as unknown as Prisma.RaceVariantUpdateArgs["data"],
            });

            await reconcileVariantTraits(existing.raceVariantId, desiredTraitFeatureIds);
        } else {
            const created = await prisma.raceVariant.create({
                data: variantData as unknown as Prisma.RaceVariantCreateArgs["data"],
            });

            await reconcileVariantTraits(created.raceVariantId, desiredTraitFeatureIds);
        }
    }

    console.log(`  ${variants.length}  (, Half-Elf, Dwarf, Halfling, Gnome, Half-Orc, Elf, )!`);
}
</file>

<file path="prisma/seed/subraceSeed.ts">
import { PrismaClient, Subraces, Source, Races, Language, WeaponCategory, ArmorType } from "@prisma/client";

export const seedSubraces = async (prisma: PrismaClient) => {
    console.log('   ...');
    console.log('   ...');
    console.log('   ...');
    console.log('   ...');

    const elf = await prisma.race.findFirst({ where: { name: Races.ELF_2014 } });
    if (!elf) {
        throw new Error("Elf race not found");
    }

    const dwarf = await prisma.race.findFirst({ where: { name: Races.DWARF_2014 } });
    if (!dwarf) {
        throw new Error("Dwarf race not found");
    }

    const halfling = await prisma.race.findFirst({ where: { name: Races.HALFLING_2014 } });
    if (!halfling) {
        throw new Error("Halfling race not found");
    }

    const gnome = await prisma.race.findFirst({ where: { name: Races.GNOME_2014 } });
    if (!gnome) {
        throw new Error("Gnome race not found");
    }

    const MPMM_ASI = {
        tasha: {
            flexible: {
                groups: [
                    {
                        groupName: '+1  ',
                        value: 1,
                        choiceCount: 2,
                        unique: false
                    },
                    {
                        groupName: '+1  ',
                        value: 1,
                        choiceCount: 1,
                        unique: false
                    },
                ]
            },
        },
    };

        //    seed-  "subrace_trait"   .
        //  ,   subrace_trait_id    (subrace_id, feature_id).
        await prisma.$executeRaw`
                DELETE FROM "subrace_trait" a
                USING "subrace_trait" b
                WHERE a."subrace_id" = b."subrace_id"
                    AND a."feature_id" = b."feature_id"
                    AND a."subrace_trait_id" > b."subrace_trait_id";
        `

    const subraces = [
        // ============ HIGH ELF (PHB) ============
        {
            raceId: elf.raceId,
            name: Subraces.ELF_HIGH_2014,
            source: Source.PHB,
            additionalASI: { INT: 1 },
            languagesToChooseCount: 1, 
            weaponProficiencies: {
               category: [WeaponCategory.LONGSWORD, WeaponCategory.SHORTSWORD, WeaponCategory.SHORTBOW, WeaponCategory.LONGBOW]
            },
            traitEngNames: ['Elf Weapon Training', 'High Elf Cantrip', 'Extra Language']
        },
        // ============ WOOD ELF (PHB) ============
        {
            raceId: elf.raceId,
            name: Subraces.ELF_WOOD_2014,
            source: Source.PHB,
            additionalASI: { WIS: 1 },
            speedModifier: 5,
            weaponProficiencies: {
               category: [WeaponCategory.LONGSWORD, WeaponCategory.SHORTSWORD, WeaponCategory.SHORTBOW, WeaponCategory.LONGBOW]
            },
            traitEngNames: ['Elf Weapon Training', 'Mask of the Wild']
        },
        // ============ DROW (PHB) ============
        {
            raceId: elf.raceId,
            name: Subraces.ELF_DARK_DROW_2014,
            source: Source.PHB,
            additionalASI: { CHA: 1 },
            weaponProficiencies: {
               category: [WeaponCategory.RAPIER, WeaponCategory.SHORTSWORD, WeaponCategory.HAND_CROSSBOW]
            },
            traitEngNames: ['Superior Darkvision (Drow)', 'Sunlight Sensitivity', 'Drow Magic', 'Drow Weapon Training']
        },
        // ============ ELADRIN (DMG) ============
        {
            raceId: elf.raceId,
            name: Subraces.ELF_ELADRIN_DMG,
            source: Source.DMG,
            additionalASI: { INT: 1 },
            weaponProficiencies: {
               category: [WeaponCategory.LONGSWORD, WeaponCategory.SHORTSWORD, WeaponCategory.SHORTBOW, WeaponCategory.LONGBOW]
            },
            traitEngNames: ['Elf Weapon Training', 'Fey Step (DMG)']
        },
        // ============ ELADRIN (MPMM) ============
        {
            raceId: elf.raceId,
            name: Subraces.ELF_ELADRIN_MPMM,
            source: Source.MPMM,
            replacesASI: true,
            additionalASI: MPMM_ASI,
            traitEngNames: ['Fey Step']
        },
        // ============ SEA ELF (MTOF) ============
        {
            raceId: elf.raceId,
            name: Subraces.ELF_SEA_MTOF,
            source: Source.MTOF,
            additionalASI: { CON: 1 },
            swimSpeed: 30,
            weaponProficiencies: {
                category: [WeaponCategory.SPEAR, WeaponCategory.TRIDENT, WeaponCategory.LIGHT_CROSSBOW, WeaponCategory.NET]
            },
            additionalLanguages: [Language.AQUAN],
            traitEngNames: ['Child of the Sea', 'Friend of the Sea']
        },
        // ============ SHADAR-KAI (MPMM) ============
        {
            raceId: elf.raceId,
            name: Subraces.ELF_SHADAR_KAI_MPMM,
            source: Source.MPMM,
            replacesASI: true,
            additionalASI: MPMM_ASI,
            traitEngNames: ['Necrotic Resistance', 'Blessing of the Raven Queen', 'Keen Senses']
        },
        // ============ PALLID ELF (EGTW) ============
        {
            raceId: elf.raceId,
            name: Subraces.ELF_PALLID_EGTW,
            source: Source.EGTW,
            additionalASI: { WIS: 1 },
            traitEngNames: ['Incisive Sense', 'Blessing of the Moon Weaver']
        },
        
        // ============ HILL DWARF (PHB) ============
        {
            raceId: dwarf.raceId,
            name: Subraces.DWARF_HILL_2014,
            source: Source.PHB,
            additionalASI: { WIS: 1 },
            traitEngNames: ['Dwarven Toughness']
        },
        // ============ MOUNTAIN DWARF (PHB) ============
        {
            raceId: dwarf.raceId,
            name: Subraces.DWARF_MOUNTAIN_2014,
            source: Source.PHB,
            additionalASI: { STR: 2 },
            armorProficiencies: [ArmorType.LIGHT, ArmorType.MEDIUM],
            traitEngNames: ['Dwarven Armor Training']
        },
        // ============ DUERGAR (GRAY DWARF) (SCAG) ============
        {
            raceId: dwarf.raceId,
            name: Subraces.DWARF_DUERGAR_GRAY_SCAG,
            source: Source.SCAG,
            additionalASI: { STR: 1 },
            traitEngNames: ['Superior Darkvision (Duergar)', 'Duergar Resilience', 'Duergar Magic', 'Sunlight Sensitivity']
        },
        
        // ============ LIGHTFOOT HALFLING (PHB) ============
        {
            raceId: halfling.raceId,
            name: Subraces.HALFLING_LIGHTFOOT_2014,
            source: Source.PHB,
            additionalASI: { CHA: 1 },
            traitEngNames: ['Naturally Stealthy']
        },
        // ============ STOUT HALFLING (PHB) ============
        {
            raceId: halfling.raceId,
            name: Subraces.HALFLING_STOUT_2014,
            source: Source.PHB,
            additionalASI: { CON: 1 },
            traitEngNames: ['Stout Resilience']
        },
        // ============ GHOSTWISE HALFLING (SCAG) ============
        {
            raceId: halfling.raceId,
            name: Subraces.HALFLING_GHOSTWISE_SCAG,
            source: Source.SCAG,
            additionalASI: { WIS: 1 },
            traitEngNames: ['Silent Speech']
        },
        
        // ============ FOREST GNOME (PHB) ============
        {
            raceId: gnome.raceId,
            name: Subraces.GNOME_FOREST_2014,
            source: Source.PHB,
            additionalASI: { DEX: 1 },
            traitEngNames: ['Natural Illusionist', 'Speak with Small Beasts']
        },
        // ============ ROCK GNOME (PHB) ============
        {
            raceId: gnome.raceId,
            name: Subraces.GNOME_ROCK_2014,
            source: Source.PHB,
            additionalASI: { CON: 1 },
            toolProficiencies: {
                category: ["ARTISAN_TINKER"]
            },
            traitEngNames: ['Artificer\'s Lore', 'Tinker']
        },
        // ============ DEEP GNOME (SVIRFNEBLIN) (SCAG) ============
        {
            raceId: gnome.raceId,
            name: Subraces.GNOME_DEEP_SCAG,
            source: Source.SCAG,
            additionalASI: { DEX: 1 },
            traitEngNames: ['Superior Darkvision (Deep Gnome)', 'Stone Camouflage']
        },
        
    ];

    for (const subrace of subraces) {
        // traits  ,   seed     join-
        const { traitEngNames, ...subraceData } = subrace as any;

        const saved = await prisma.subrace.upsert({
            where: { name: subraceData.name },
            update: subraceData,
            create: subraceData
        });

        const desiredFeatureRows = await prisma.feature.findMany({
            where: { engName: { in: traitEngNames } },
            select: { featureId: true, engName: true }
        });

        const found = new Set(desiredFeatureRows.map(f => f.engName));
        for (const engName of traitEngNames) {
            if (!found.has(engName)) {
                console.warn(`      ${saved.name}: ${engName}`);
            }
        }

        const desiredFeatureIds = desiredFeatureRows.map(f => f.featureId);

        //  ,     
        await prisma.subraceTrait.deleteMany({
            where: {
                subraceId: saved.subraceId,
                ...(desiredFeatureIds.length
                    ? { NOT: { featureId: { in: desiredFeatureIds } } }
                    : {}),
            }
        });

        //   
        if (desiredFeatureIds.length) {
            const existing = await prisma.subraceTrait.findMany({
                where: { subraceId: saved.subraceId, featureId: { in: desiredFeatureIds } },
                select: { featureId: true }
            });
            const existingIds = new Set(existing.map(e => e.featureId));
            const toCreate = desiredFeatureIds
                .filter(featureId => !existingIds.has(featureId))
                .map(featureId => ({ subraceId: saved.subraceId, featureId }));

            if (toCreate.length) {
                await prisma.subraceTrait.createMany({ data: toCreate });
            }
        }
    }

    console.log(`  ${subraces.length}  (, , , , )!`);
}
</file>

<file path="prisma/seed/weaponSeed.ts">
import { PrismaClient, DamageType, Prisma, WeaponCategory, WeaponProperty, WeaponType } from "@prisma/client";

export const seedWeapons = async (prisma: PrismaClient) => {
    console.log('Seeding weapons...')

    const weapons: Prisma.WeaponCreateInput[] = [
        {
            name: WeaponCategory.CLUB,
            damage: '14',
            damageType: DamageType.BLUDGEONING,
            weaponType: WeaponType.SIMPLE_WEAPON,
            sortOrder: 1,
            properties: [WeaponProperty.LIGHT]
        },
        {
            name: WeaponCategory.DAGGER,
            damage: '14',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.SIMPLE_WEAPON,
            sortOrder: 2,
            properties: [WeaponProperty.FINESSE, WeaponProperty.LIGHT, WeaponProperty.THROWN],
            normalRange: 20,
            longRange: 60
        },
        {
            name: WeaponCategory.GREATCLUB,
            damage: '18',
            damageType: DamageType.BLUDGEONING,
            weaponType: WeaponType.SIMPLE_WEAPON,
            sortOrder: 3,
            properties: [WeaponProperty.TWO_HANDED],
        },
        {
            name: WeaponCategory.HANDAXE,
            damage: '16',
            damageType: DamageType.SLASHING,
            weaponType: WeaponType.SIMPLE_WEAPON,
            sortOrder: 4,
            properties: [WeaponProperty.LIGHT, WeaponProperty.THROWN],
            normalRange: 20,
            longRange: 60
        },
        {
            name: WeaponCategory.JAVELIN,
            damage: '16',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.SIMPLE_WEAPON,
            sortOrder: 5,
            properties: [WeaponProperty.THROWN],
            normalRange: 30,
            longRange: 120
        },
        {
            name: WeaponCategory.LIGHT_HAMMER,
            damage: '14',
            damageType: DamageType.BLUDGEONING,
            weaponType: WeaponType.SIMPLE_WEAPON,
            sortOrder: 6,
            properties: [WeaponProperty.LIGHT, WeaponProperty.THROWN],
            normalRange: 20,
            longRange: 60
        },
        {
            name: WeaponCategory.MACE,
            damage: '16',
            damageType: DamageType.BLUDGEONING,
            weaponType: WeaponType.SIMPLE_WEAPON,
            sortOrder: 7,
            properties: []
        },
        {
            name: WeaponCategory.QUARTERSTAFF,
            damage: '16',
            damageType: DamageType.BLUDGEONING,
            weaponType: WeaponType.SIMPLE_WEAPON,
            sortOrder: 8,
            properties: [WeaponProperty.VERSATILE],
            versatileDamage: '18'
        },
        {
            name: WeaponCategory.SICKLE,
            damage: '14',
            damageType: DamageType.SLASHING,
            weaponType: WeaponType.SIMPLE_WEAPON,
            sortOrder: 9,
            properties: [WeaponProperty.LIGHT]
        },
        {
            name: WeaponCategory.SPEAR,
            damage: '16',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.SIMPLE_WEAPON,
            sortOrder: 10,
            properties: [WeaponProperty.THROWN, WeaponProperty.VERSATILE],
            normalRange: 20,
            longRange: 60,
            versatileDamage: '18'
        },
        {
            name: WeaponCategory.UNARMED_STRIKE,
            damage: '1',
            damageType: DamageType.BLUDGEONING,
            weaponType: WeaponType.SIMPLE_WEAPON,
            sortOrder: 11,
            properties: []
        },

        // ==================== SIMPLE RANGED WEAPONS ====================
        {
            name: WeaponCategory.LIGHT_CROSSBOW,
            damage: '18',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.SIMPLE_WEAPON,
            sortOrder: 12,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.LOADING, WeaponProperty.TWO_HANDED],
            normalRange: 80,
            longRange: 320,
            isRanged: true,
        },
        {
            name: WeaponCategory.DART,
            damage: '14',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.SIMPLE_WEAPON,
            sortOrder: 13,
            properties: [WeaponProperty.FINESSE, WeaponProperty.THROWN],
            normalRange: 20,
            longRange: 60,
            isRanged: true
        },
        {
            name: WeaponCategory.SHORTBOW,
            damage: '16',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.SIMPLE_WEAPON,
            sortOrder: 14,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.TWO_HANDED],
            normalRange: 80,
            longRange: 320,
            isRanged: true
        },
        {
            name: WeaponCategory.SLING,
            damage: '14',
            damageType: DamageType.BLUDGEONING,
            weaponType: WeaponType.SIMPLE_WEAPON,
            sortOrder: 15,
            properties: [WeaponProperty.AMMUNITION],
            normalRange: 30,
            longRange: 120,
            isRanged: true
        },

        // ==================== MARTIAL MELEE WEAPONS ====================
        {
            name: WeaponCategory.BATTLEAXE,
            damage: '18',
            damageType: DamageType.SLASHING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 16,
            properties: [WeaponProperty.VERSATILE],
            versatileDamage: '110'
        },
        {
            name: WeaponCategory.FLAIL,
            damage: '18',
            damageType: DamageType.BLUDGEONING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 17,
            properties: []
        },
        {
            name: WeaponCategory.GLAIVE,
            damage: '110',
            damageType: DamageType.SLASHING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 18,
            properties: [WeaponProperty.HEAVY, WeaponProperty.REACH, WeaponProperty.TWO_HANDED]
        },
        {
            name: WeaponCategory.GREATAXE,
            damage: '112',
            damageType: DamageType.SLASHING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 19,
            properties: [WeaponProperty.HEAVY, WeaponProperty.TWO_HANDED]
        },
        {
            name: WeaponCategory.GREATSWORD,
            damage: '26',
            damageType: DamageType.SLASHING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 20,
            properties: [WeaponProperty.HEAVY, WeaponProperty.TWO_HANDED]
        },
        {
            name: WeaponCategory.HALBERD,
            damage: '110',
            damageType: DamageType.SLASHING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 21,
            properties: [WeaponProperty.HEAVY, WeaponProperty.REACH, WeaponProperty.TWO_HANDED]
        },
        {
            name: WeaponCategory.LANCE,
            damage: '112',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 22,
            properties: [WeaponProperty.REACH, WeaponProperty.SPECIAL]
        },
        {
            name: WeaponCategory.LONGSWORD,
            damage: '18',
            damageType: DamageType.SLASHING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 23,
            properties: [WeaponProperty.VERSATILE],
            versatileDamage: '110'
        },
        {
            name: WeaponCategory.MAUL,
            damage: '26',
            damageType: DamageType.BLUDGEONING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 24,
            properties: [WeaponProperty.HEAVY, WeaponProperty.TWO_HANDED]
        },
        {
            name: WeaponCategory.MORNINGSTAR,
            damage: '18',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 25,
            properties: []
        },
        {
            name: WeaponCategory.PIKE,
            damage: '110',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 26,
            properties: [WeaponProperty.HEAVY, WeaponProperty.REACH, WeaponProperty.TWO_HANDED]
        },
        {
            name: WeaponCategory.RAPIER,
            damage: '18',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 27,
            properties: [WeaponProperty.FINESSE]
        },
        {
            name: WeaponCategory.SCIMITAR,
            damage: '16',
            damageType: DamageType.SLASHING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 28,
            properties: [WeaponProperty.FINESSE, WeaponProperty.LIGHT]
        },
        {
            name: WeaponCategory.SHORTSWORD,
            damage: '16',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 29,
            properties: [WeaponProperty.FINESSE, WeaponProperty.LIGHT]
        },
        {
            name: WeaponCategory.TRIDENT,
            damage: '16',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 30,
            properties: [WeaponProperty.THROWN, WeaponProperty.VERSATILE],
            normalRange: 20,
            longRange: 60,
            versatileDamage: '18'
        },
        {
            name: WeaponCategory.WAR_PICK,
            damage: '18',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 31,
            properties: []
        },
        {
            name: WeaponCategory.WARHAMMER,
            damage: '18',
            damageType: DamageType.BLUDGEONING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 32,
            properties: [WeaponProperty.VERSATILE],
            versatileDamage: '110'
        },
        {
            name: WeaponCategory.WHIP,
            damage: '14',
            damageType: DamageType.SLASHING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 33,
            properties: [WeaponProperty.FINESSE, WeaponProperty.REACH]
        },

        // ==================== MARTIAL RANGED WEAPONS ====================
        {
            name: WeaponCategory.BLOWGUN,
            damage: '1',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 34,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.LOADING],
            normalRange: 25,
            longRange: 100,
            isRanged: true
        },
        {
            name: WeaponCategory.HAND_CROSSBOW,
            damage: '16',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 35,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.LIGHT, WeaponProperty.LOADING],
            normalRange: 30,
            longRange: 120,
            isRanged: true
        },
        {
            name: WeaponCategory.HEAVY_CROSSBOW,
            damage: '110',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 36,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.HEAVY, WeaponProperty.LOADING, WeaponProperty.TWO_HANDED],
            normalRange: 100,
            longRange: 400,
            isRanged: true
        },
        {
            name: WeaponCategory.LONGBOW,
            damage: '18',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 37,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.HEAVY, WeaponProperty.TWO_HANDED],
            normalRange: 150,
            longRange: 600,
            isRanged: true
        },
        {
            name: WeaponCategory.NET,
            damage: '0',
            damageType: DamageType.BLUDGEONING,
            weaponType: WeaponType.MARTIAL_WEAPON,
            sortOrder: 38,
            properties: [WeaponProperty.SPECIAL, WeaponProperty.THROWN],
            normalRange: 5,
            longRange: 15,
            isRanged: true
        },
        // ==================== RENAISSANCE FIREARMS ====================
        {
            name: WeaponCategory.PISTOL_RENAISSANCE,
            damage: '110',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.FIREARMS,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.LOADING],
            normalRange: 30,
            longRange: 90,
            isRanged: true
        },
        {
            name: WeaponCategory.MUSKET,
            damage: '112',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.FIREARMS,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.LOADING, WeaponProperty.TWO_HANDED],
            normalRange: 40,
            longRange: 120,
            isRanged: true
        },

        // ==================== MODERN FIREARMS ====================
        {
            name: WeaponCategory.PISTOL_AUTOMATIC,
            damage: '26',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.FIREARMS,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.RELOAD],
            normalRange: 50,
            longRange: 150,
            isRanged: true,
            isAdditional: true,
        },
        {
            name: WeaponCategory.REVOLVER,
            damage: '28',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.FIREARMS,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.RELOAD],
            normalRange: 40,
            longRange: 120,
            isRanged: true,
            isAdditional: true,
        },
        {
            name: WeaponCategory.RIFLE_HUNTING,
            damage: '210',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.FIREARMS,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.RELOAD, WeaponProperty.TWO_HANDED],
            normalRange: 80,
            longRange: 240,
            isRanged: true,
            isAdditional: true,
        },
        {
            name: WeaponCategory.RIFLE_AUTOMATIC,
            damage: '28',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.FIREARMS,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.BURST_FIRE, WeaponProperty.RELOAD, WeaponProperty.TWO_HANDED],
            normalRange: 80,
            longRange: 240,
            isRanged: true,
            isAdditional: true,
        },
        {
            name: WeaponCategory.SHOTGUN,
            damage: '28',
            damageType: DamageType.PIERCING,
            weaponType: WeaponType.FIREARMS,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.RELOAD, WeaponProperty.TWO_HANDED],
            normalRange: 30,
            longRange: 90,
            isRanged: true,
            isAdditional: true,
        },

        // ==================== FUTURISTIC FIREARMS ====================
        {
            name: WeaponCategory.LASER_PISTOL,
            damage: '36',
            damageType: DamageType.RADIANT,
            weaponType: WeaponType.FIREARMS,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.RELOAD],
            normalRange: 40,
            longRange: 120,
            isRanged: true,
            isAdditional: true,
        },
        {
            name: WeaponCategory.ANTIMATTER_RIFLE,
            damage: '68',
            damageType: DamageType.NECROTIC,
            weaponType: WeaponType.FIREARMS,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.RELOAD, WeaponProperty.TWO_HANDED],
            normalRange: 120,
            longRange: 360,
            isRanged: true,
            isAdditional: true,
        },
        {
            name: WeaponCategory.LASER_RIFLE,
            damage: '38',
            damageType: DamageType.RADIANT,
            weaponType: WeaponType.FIREARMS,
            properties: [WeaponProperty.AMMUNITION, WeaponProperty.RELOAD, WeaponProperty.TWO_HANDED],
            normalRange: 100,
            longRange: 300,
            isRanged: true,
            isAdditional: true,
        },
    ]

    for (const weapon of weapons) {
        await prisma.weapon.upsert({
            where: { name: weapon.name },
            update: weapon,
            create: weapon
        })
        await new Promise(resolve => setTimeout(resolve, 100));
    }

    console.log(` Seeded ${weapons.length} weapons`)
}
</file>

<file path="src/components/ui/card.tsx">
import * as React from "react"
import { cn } from "@/lib/utils"

const Card = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("glass-card rounded-xl text-card-foreground", className)} {...props} />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("flex flex-col space-y-1.5 p-6", className)} {...props} />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLHeadingElement>>(({ className, ...props }, ref) => (
  <h3
    ref={ref}
    className={cn(
      "font-rpg-display font-semibold uppercase leading-none tracking-wider text-slate-200",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLParagraphElement>>(({ className, ...props }, ref) => (
  <p ref={ref} className={cn("text-sm text-muted-foreground", className)} {...props} />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("flex items-center p-6 pt-0", className)} {...props} />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
</file>

<file path="src/components/ui/dialog.tsx">
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    data-rpg-dialog-overlay
    className={cn(
      "fixed inset-0 z-[9999] bg-slate-950/45 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    onPointerDown={() => {
      // Only suppress the click if dialogs are stacked.
      // Otherwise this will consume the first outside click and the dialog closes only on the second.
      const openDialogs = document.querySelectorAll(
        '[data-rpg-dialog-content][data-state="open"]'
      ).length;
      if (openDialogs <= 1) return;

      const handler = (event: MouseEvent) => {
        event.preventDefault();
        event.stopPropagation();
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        ;(event as any).stopImmediatePropagation?.();
        document.removeEventListener("click", handler, true);
      };

      document.addEventListener("click", handler, true);
      window.setTimeout(() => {
        document.removeEventListener("click", handler, true);
      }, 800);
    }}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

function isFromAnyDialogLayer(target: EventTarget | null) {
  if (!(target instanceof Element)) return false;
  return Boolean(target.closest("[data-rpg-dialog-content], [data-rpg-dialog-overlay]"));
}

function isFromAnyDialogContent(target: EventTarget | null) {
  if (!(target instanceof Element)) return false;
  return Boolean(target.closest("[data-rpg-dialog-content]"));
}

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content> & {
    showClose?: boolean;
    closeLabel?: string;
  }
>(
  (
    {
      className,
      children,
      showClose = true,
      closeLabel = "Close",
      onPointerDownOutside,
      onInteractOutside,
      onFocusOutside,
      ...props
    },
    ref
  ) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      data-rpg-dialog-content
      className={cn(
        "fixed left-[50%] top-[50%] z-[9999] grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 rounded-2xl border border-white/10 bg-gradient-to-b from-slate-950/28 to-slate-950/18 p-6 text-slate-50 backdrop-blur-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
        className
      )}
      onPointerDown={(e) => e.stopPropagation()}
      onClick={(e) => e.stopPropagation()}
      onPointerDownOutside={(e) => {
        // If another dialog is stacked on top, interactions with it should NOT dismiss this one.
        // Allow clicking the overlay to dismiss; only block clicks inside another dialog content.
        if (isFromAnyDialogContent(e.target)) e.preventDefault();
        onPointerDownOutside?.(e);
      }}
      onInteractOutside={(e) => {
        if (isFromAnyDialogContent(e.target)) e.preventDefault();
        onInteractOutside?.(e);
      }}
      onFocusOutside={(e) => {
        if (isFromAnyDialogContent(e.target)) e.preventDefault();
        onFocusOutside?.(e);
      }}
      {...props}
    >
      {children}
      {showClose ? (
        <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
          <X className="h-4 w-4" />
          <span className="sr-only">{closeLabel}</span>
        </DialogPrimitive.Close>
      ) : null}
    </DialogPrimitive.Content>
  </DialogPortal>
  )
)
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn("flex flex-col space-y-1.5 text-center sm:text-left", className)}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "font-rpg-display text-lg font-semibold uppercase leading-none tracking-wider text-slate-200",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogTrigger,
  DialogClose,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}
</file>

<file path="src/lib/components/auth/GoogleAuthDialog.tsx">
"use client";

import { useState } from "react";
import { signIn, useSession } from "next-auth/react";
import { toast } from "sonner";
import { Button } from "@/components/ui/button";
import { usePathname } from "next/navigation";
import { useModalBackButton } from "@/hooks/useModalBackButton";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Loader2, LogIn, ShieldCheck } from "lucide-react";

interface Props {
  open?: boolean;
  onOpenChange?: (open: boolean) => void;
  triggerLabel?: string;
  trigger?: React.ReactNode;
  callbackUrl?: string;
}

const GoogleAuthDialog = ({
  open,
  onOpenChange,
  triggerLabel = "",
  trigger,
  callbackUrl,
}: Props) => {
  const { data: session, status } = useSession();
  const pathname = usePathname();
  const [loading, setLoading] = useState(false);

  const [internalOpen, setInternalOpen] = useState(false);
  const shouldRenderTrigger = typeof open === "undefined";
  const effectiveOpen = typeof open === "boolean" ? open : internalOpen;
  const handleOpenChange = onOpenChange ?? setInternalOpen;

  useModalBackButton(effectiveOpen, () => handleOpenChange(false));

  const getCurrentUrl = () => {
    if (typeof window === "undefined") return pathname || "/";
    return `${window.location.pathname}${window.location.search}`;
  };

  const handleSignIn = async () => {
    setLoading(true);
    try {
      const result = await signIn("google", {
        redirect: false,
        callbackUrl: callbackUrl ?? getCurrentUrl(),
      });

      if (result?.error) {
        toast.error("  ", {
          description: "Google  .   .",
        });
        return;
      }

      if (result?.url) {
        window.location.href = result.url;
      } else {
        toast.success("!  .");
        handleOpenChange(false);
      }
    } catch {
      toast.error("  ", {
        description: "    .",
      });
    } finally {
      setLoading(false);
    }
  };

  return (
    <Dialog open={effectiveOpen} onOpenChange={handleOpenChange}>
      {trigger ? (
        <DialogTrigger asChild>{trigger}</DialogTrigger>
      ) : (
        shouldRenderTrigger && (
          <DialogTrigger asChild>
            <Button
              variant="secondary"
              size="sm"
              className="border border-slate-700/70 bg-white/5 text-white hover:bg-white/10"
            >
              <LogIn className="mr-2 h-4 w-4" />
              {triggerLabel}
            </Button>
          </DialogTrigger>
        )
      )}
      <DialogContent className="sm:max-w-[420px] border border-slate-800/70 bg-slate-950/90 backdrop-blur">
        <DialogHeader>
          <DialogTitle className="text-white">  Google</DialogTitle>
          <DialogDescription className="text-slate-400">
               .   Google    .
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-3">
          {session?.user ? (
            <div className="flex items-center justify-between rounded-lg border border-emerald-500/40 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-100">
              <span>    {session.user.email}</span>
              <ShieldCheck className="h-4 w-4" />
            </div>
          ) : (
            <div className="rounded-lg border border-slate-800/80 bg-slate-900/70 px-3 py-2 text-sm text-slate-300">
                      .
            </div>
          )}

          <Button
            onClick={handleSignIn}
            disabled={loading || status === "loading" || !!session}
            className="w-full bg-gradient-to-r from-indigo-500 via-blue-500 to-emerald-500 text-white shadow-lg shadow-indigo-500/20"
          >
            {loading ? (
              <>
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                &apos;...
              </>
            ) : session ? (
              "  "
            ) : (
              <>
                <span className="mr-2 flex h-5 w-5 items-center justify-center rounded-full bg-white text-[11px] font-semibold text-slate-900">
                  G
                </span>
                  Google
              </>
            )}
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
};

export default GoogleAuthDialog;
</file>

<file path="src/lib/components/characterCreator/FeatsForm.tsx">
"use client";

import { useStepForm } from "@/hooks/useStepForm";
import { featSchema } from "@/lib/zod/schemas/persCreateSchema";
import { Feat } from "@prisma/client";
import { Card, CardContent } from "@/components/ui/card";
import clsx from "clsx";
import { useEffect, useMemo, useState } from "react";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import { InfoDialog, InfoGrid, InfoPill } from "@/lib/components/characterCreator/EntityInfoDialog";
import { SourceBadge } from "@/lib/components/characterCreator/SourceBadge";
import { sourceTranslations, featTranslations } from "@/lib/refs/translation";
import {
  formatASI,
  formatLanguages,
  formatSkillProficiencies,
  formatToolProficiencies,
  formatWeaponProficiencies,
  formatArmorProficiencies,
} from "@/lib/components/characterCreator/infoUtils";
import { Input } from "@/components/ui/input";
import { Search, X } from "lucide-react";
import { Button } from "@/components/ui/button";
import { FormattedDescription } from "@/components/ui/FormattedDescription";

interface Props {
  feats: Feat[];
  formId: string;
  onNextDisabledChange?: (disabled: boolean) => void;
}

export const FeatsForm = ({ feats, formId, onNextDisabledChange }: Props) => {
  const { updateFormData, nextStep } = usePersFormStore();
  
  const { form, onSubmit } = useStepForm(featSchema, (data) => {
    updateFormData({ featId: data.featId });
    nextStep();
  });
  
  const chosenFeatId = form.watch("featId");
  const search = form.watch("featSearch");

  useEffect(() => {
    if (!chosenFeatId) {
      onNextDisabledChange?.(true);
      return;
    }
    onNextDisabledChange?.(false);
  }, [onNextDisabledChange, chosenFeatId]);

  const filteredFeats = useMemo(() => {
    const normalizedSearch = (search || "").toLowerCase().trim();
    if (!normalizedSearch) return feats;
    return feats.filter(f => 
      f.name.toLowerCase().includes(normalizedSearch) || 
      f.engName.toLowerCase().includes(normalizedSearch)
    );
  }, [feats, search]);

  const FeatInfoModal = ({ feat }: { feat: Feat }) => {
    const name = featTranslations[feat.name] ?? feat.name;
    return (
      <InfoDialog
        title={name}
        triggerLabel={`  ${name}`}
      >
        <InfoGrid>
          <InfoPill label="" value={sourceTranslations[feat.source] ?? feat.source} />
          <InfoPill label=" " value={formatASI(feat.grantedASI)} />
          <InfoPill
            label=""
            value={formatSkillProficiencies(feat.grantedSkills as any)}
          />
           <InfoPill
            label=""
            value={formatLanguages(feat.grantedLanguages, feat.grantedLanguageCount)}
          />
          <InfoPill
            label=""
            value={formatToolProficiencies(feat.grantedToolProficiencies as any)}
          />
           <InfoPill
            label=""
            value={formatWeaponProficiencies(feat.grantedWeaponProficiencies as any)}
          />
           <InfoPill
            label=""
            value={formatArmorProficiencies(feat.grantedArmorProficiencies)}
          />
          <div className="col-span-full">
             <FormattedDescription content={feat.description} className="text-sm text-slate-300" />
          </div>
        </InfoGrid>
      </InfoDialog>
    );
  };

  return (
    <form id={formId} onSubmit={onSubmit} className="w-full space-y-4">
      <div className="space-y-2 text-center">
        <h2 className="font-rpg-display text-3xl font-semibold uppercase tracking-widest text-slate-200 sm:text-4xl">
           
        </h2>
        <p className="text-sm text-slate-400">    </p>
      </div>

      <div className="glass-panel border-gradient-rpg rounded-xl p-3 sm:p-4">
        <div className="relative w-full">
            <Search className="pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-500" />
            <Input
              type="search"
              value={search}
              onChange={(e) => form.setValue("featSearch", e.target.value)}
              placeholder=" "
              className="h-10 border-white/10 bg-white/5 pl-9 pr-10 text-sm text-slate-100 placeholder:text-slate-400 focus-visible:ring-cyan-400/30"
            />
             {search && (
              <Button
                type="button"
                variant="ghost"
                size="icon"
                className="absolute right-1.5 top-1/2 h-7 w-7 -translate-y-1/2 text-slate-400 hover:text-white"
                onClick={() => form.setValue("featSearch", '')}
              >
                <X className="h-4 w-4" />
              </Button>
            )}
        </div>
      </div>

      <div className="grid gap-3 sm:grid-cols-2">
        {filteredFeats.map((feat) => {
          const name = featTranslations[feat.name] ?? feat.name;
          return (
          <Card
            key={feat.featId}
            className={clsx(
              "glass-card cursor-pointer transition-all duration-200",
              feat.featId === chosenFeatId && "glass-active"
            )}
            onClick={(e) => {
              if ((e.target as HTMLElement | null)?.closest?.('[data-stop-card-click]')) return;
              form.setValue("featId", feat.featId);
            }}
          >
            <CardContent className="relative flex items-center justify-between p-4">
              <FeatInfoModal feat={feat} />
              <div>
                <div className="text-lg font-semibold text-white">{name}</div>
                <div className="text-xs text-slate-400">{feat.engName}</div>
              </div>
              <SourceBadge code={feat.source} active={feat.featId === chosenFeatId} />
            </CardContent>
          </Card>
        )})}
      </div>
      <input
        type="hidden"
        {...form.register("featId", {
          setValueAs: (value) => {
            if (value === "" || value === undefined || value === null) return undefined;
            const num = typeof value === "number" ? value : Number(value);
            return Number.isFinite(num) ? num : undefined;
          },
        })}
      />
    </form>
  );
};

export default FeatsForm;
</file>

<file path="src/lib/components/characterCreator/NameForm.tsx">
"use client";

import { nameSchema } from "@/lib/zod/schemas/persCreateSchema";
import { useStepForm } from "@/hooks/useStepForm";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { raceTranslations, classTranslations, backgroundTranslations } from "@/lib/refs/translation";
import { BackgroundI, ClassI, RaceI, FeatPrisma } from "@/lib/types/model-types";
import { RaceVariant } from "@prisma/client";
import { useCharacterStats } from "@/hooks/useCharacterStats";
import { useFantasyNameGenerator } from "@/hooks/useFantasyNameGenerator";
import clsx from "clsx";
import { RefreshCw } from "lucide-react";

interface Props {
  formId: string;
  race?: RaceI;
  raceVariant?: RaceVariant | null;
  selectedClass?: ClassI;
  background?: BackgroundI;
  feat?: FeatPrisma | null;
  onSuccess?: () => void;
}

const SummaryCard = ({ label, value }: { label: string; value?: string }) => (
  <Card className="shadow-inner">
    <CardHeader className="pb-2">
      <CardDescription className="text-slate-400">{label}</CardDescription>
      <CardTitle className="text-white text-lg">{value ?? " "}</CardTitle>
    </CardHeader>
  </Card>
);

const StatsSummary = ({ stats }: { stats: ReturnType<typeof useCharacterStats> }) => {
  const attributes = [
    { key: 'STR', label: '' },
    { key: 'DEX', label: '' },
    { key: 'CON', label: '' },
    { key: 'INT', label: '' },
    { key: 'WIS', label: '' },
    { key: 'CHA', label: '' },
  ];

  return (
    <div className="grid grid-cols-3 gap-2 sm:grid-cols-6">
      {attributes.map((attr) => {
        const stat = stats[attr.key];
        return (
          <div key={attr.key} className="flex flex-col items-center rounded-lg border border-white/10 bg-white/5 p-2">
            <span className="text-[10px] font-bold uppercase text-slate-500">{attr.label}</span>
            <div className="flex items-baseline gap-1">
              <span className="text-xl font-bold text-white">{stat.total}</span>
              {stat.bonus > 0 && (
                <span
                  className="text-[10px] text-indigo-400"
                  title={`: ${stat.base}, : +${stat.bonus}`}
                >
                  (+{stat.bonus})
                </span>
              )}
            </div>
            <div className="flex items-center gap-1">
              <Badge variant="outline" className={clsx(
                "h-5 px-1 text-[10px]",
                stat.mod >= 0 ? "border-emerald-500/30 text-emerald-400" : "border-red-500/30 text-red-400"
              )}>
                {stat.mod >= 0 ? `+${stat.mod}` : stat.mod}
              </Badge>
            </div>
          </div>
        );
      })}
    </div>
  );
};

export const NameForm = ({ formId, race, raceVariant, selectedClass, background, feat, onSuccess }: Props) => {
  const { form, onSubmit } = useStepForm(nameSchema, onSuccess);
  const stats = useCharacterStats({ race, raceVariant, feat });
  const { currentName, generateName } = useFantasyNameGenerator();

  const raceName = race ? raceTranslations[race.name] : undefined;
  const className = selectedClass ? classTranslations[selectedClass.name] : undefined;
  const bgName = background ? backgroundTranslations[background.name] : undefined;

  return (
    <form id={formId} onSubmit={onSubmit} className="w-full space-y-4">
      <Card className="shadow-xl">
        <CardHeader>
          <CardTitle className="text-white">&apos; </CardTitle>
          <CardDescription className="text-slate-400">
                .
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="grid gap-3 md:grid-cols-3">
            <SummaryCard label="" value={raceName} />
            <SummaryCard label="" value={className} />
            <SummaryCard label="" value={bgName} />
          </div>

          <div className="space-y-2">
             <h3 className="text-sm font-medium text-slate-300"> </h3>
             <StatsSummary stats={stats} />
          </div>

          <div className="space-y-2">
            <label className="text-sm text-slate-300" htmlFor="name">&apos;</label>
            <div className="flex gap-2">
              <Input
                id="name"
                placeholder={currentName || ", "}
                {...form.register('name')}
                className="border-white/10 bg-white/5 text-white focus-visible:ring-cyan-400/30"
              />
              <Button
                type="button"
                variant="outline"
                size="icon"
                className="border-white/15 bg-white/5 text-slate-200 hover:bg-white/7"
                onClick={() => generateName()}
                title="  "
              >
                <RefreshCw className="h-4 w-4" />
              </Button>
              <Button
                type="button"
                variant="ghost"
                className="text-slate-200"
                onClick={() => form.setValue('name', currentName, { shouldDirty: true })}
                disabled={!currentName}
                title="  "
              >
                
              </Button>
            </div>
            {currentName ? (
              <p className="text-xs text-slate-500">
                : <span className="text-slate-300">{currentName}</span>
              </p>
            ) : null}
            <p className="text-xs text-slate-500"> &apos;       .</p>
          </div>
        </CardContent>
      </Card>
    </form>
  );
};

export default NameForm;
</file>

<file path="src/lib/components/characterCreator/RaceVariantsForm.tsx">
"use client";

import { useStepForm } from "@/hooks/useStepForm";
import { raceVariantSchema } from "@/lib/zod/schemas/persCreateSchema";
import { RaceI } from "@/lib/types/model-types";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import clsx from "clsx";
import { useEffect } from "react";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import { InfoDialog, InfoGrid, InfoPill, InfoSectionTitle } from "@/lib/components/characterCreator/EntityInfoDialog";
import { SourceBadge } from "@/lib/components/characterCreator/SourceBadge";
import { sourceTranslations, variantTranslations, variantTranslationsEng } from "@/lib/refs/translation";
import {
  formatASI,
  // formatRaceAC,
  formatSpeeds,
  translateValue,
} from "@/lib/components/characterCreator/infoUtils";
import { FormattedDescription } from "@/components/ui/FormattedDescription";

interface Props {
  race: RaceI;
  formId: string;
  onNextDisabledChange?: (disabled: boolean) => void;
}

export const RaceVariantsForm = ({ race, formId, onNextDisabledChange }: Props) => {
  const { updateFormData, nextStep } = usePersFormStore();
  
  const { form, onSubmit } = useStepForm(raceVariantSchema, (data) => {
    updateFormData({ raceVariantId: data.raceVariantId ?? null });
    nextStep();
  });
  
  const chosenVariantId = form.watch("raceVariantId");

  useEffect(() => {
    // Variant selection is optional  user can continue without choosing.
    onNextDisabledChange?.(false);
  }, [onNextDisabledChange]);

  const variants = race.raceVariants || [];

  const VariantInfoModal = ({ variant }: { variant: any }) => {
    const name = variantTranslations[variant.name] ?? variant.name;
    const rawTraits = variant.traits || [];
    const traitList = [...rawTraits].sort(
      (a: any, b: any) => (a.raceTraitId || 0) - (b.raceTraitId || 0)
    );

    return (
      <InfoDialog
        title={name}
        triggerLabel={`  ${name}`}
      >
        <InfoGrid>
          <InfoPill label="" value={sourceTranslations[variant.source] ?? variant.source} />
          {(variant.overridesRaceSpeed != null || variant.overridesFlightSpeed != null) ? (
            <InfoPill
              label=""
              value={formatSpeeds({
                speed: variant.overridesRaceSpeed,
                flightSpeed: variant.overridesFlightSpeed,
              })}
            />
          ) : null}
          <InfoPill label=" " value={formatASI(variant.overridesRaceASI)} />
          <div className="col-span-full">
             {variant.description ? (
               <FormattedDescription content={variant.description} className="text-sm text-slate-300" />
             ) : null}
          </div>
        </InfoGrid>

        <div className="space-y-2">
          <InfoSectionTitle></InfoSectionTitle>
          {traitList.length ? (
            traitList.map((trait: any) => (
              <div
                key={trait.raceTraitId || trait.feature.featureId}
                className="glass-panel border-gradient-rpg rounded-lg px-3 py-2.5"
              >
                <p className="text-sm font-semibold text-white">{trait.feature.name}</p>
                <FormattedDescription
                  content={trait.feature.description}
                  className="text-sm leading-relaxed text-slate-200/90"
                />
              </div>
            ))
          ) : (
            <p className="text-sm text-slate-400">      .</p>
          )}
        </div>
      </InfoDialog>
    );
  };

  return (
    <form id={formId} onSubmit={onSubmit} className="w-full space-y-4">
      <div className="space-y-2 text-center">
        <h2 className="font-rpg-display text-3xl font-semibold uppercase tracking-widest text-slate-200 sm:text-4xl">
            ()
        </h2>
        <p className="text-sm text-slate-400">  {translateValue(race.name)}</p>
      </div>
      <div className="grid gap-3 sm:grid-cols-2">
        {variants.map((rv) => {
          const name = variantTranslations[rv.name] ?? rv.name;
          const engName = variantTranslationsEng[rv.name] ?? rv.name;
          
          return (
          <Card
            key={rv.raceVariantId}
            className={clsx(
              "glass-card cursor-pointer transition-all duration-200",
              rv.raceVariantId === chosenVariantId && "glass-active"
            )}
            onClick={(e) => {
              if ((e.target as HTMLElement | null)?.closest?.('[data-stop-card-click]')) return;
              form.setValue("raceVariantId", rv.raceVariantId);
            }}
          >
            <CardContent className="relative flex items-center justify-between p-4">
              <VariantInfoModal variant={rv} />
              <div>
                <div className="text-lg font-semibold text-white">{name}</div>
                <div className="text-xs text-slate-400">{engName}</div>
              </div>
              <SourceBadge code={rv.source} active={rv.raceVariantId === chosenVariantId} />
            </CardContent>
          </Card>
        )})}
      </div>

      <div className="flex justify-center">
        <Button
          type="button"
          variant="outline"
          className="border-white/15 bg-white/5 text-slate-200 hover:bg-white/7"
          onClick={() => {
            form.setValue("raceVariantId", undefined);
            updateFormData({ raceVariantId: null });
            nextStep();
          }}
        >
          
        </Button>
      </div>

      <input
        type="hidden"
        {...form.register("raceVariantId", {
          setValueAs: (value) => {
            if (value === "" || value === undefined || value === null) return null;
            const num = typeof value === "number" ? value : Number(value);
            return Number.isFinite(num) ? num : null;
          },
        })}
      />
    </form>
  );
};

export default RaceVariantsForm;
</file>

<file path="src/lib/components/characterCreator/SourceBadge.tsx">
"use client";

import clsx from "clsx";
import { KeyboardEvent, SyntheticEvent, useEffect, useMemo, useRef, useState } from "react";
import { createPortal } from "react-dom";
import { X } from "lucide-react";

import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { sourceTranslations, sourceTranslationsEng } from "@/lib/refs/translation";

interface SourceBadgeProps {
  code?: string | null;
  active?: boolean;
  className?: string;
}

const getTranslation = (code?: string | null) => {
  if (!code) return { ua: undefined, en: undefined };

  const ua = Object.prototype.hasOwnProperty.call(sourceTranslations, code)
    ? (sourceTranslations as Record<string, string>)[code]
    : undefined;
  const en = Object.prototype.hasOwnProperty.call(sourceTranslationsEng, code)
    ? (sourceTranslationsEng as Record<string, string>)[code]
    : undefined;

  return { ua, en };
};

export const SourceBadge = ({ code, active, className }: SourceBadgeProps) => {
  const [open, setOpen] = useState(false);
  const wrapperRef = useRef<HTMLDivElement>(null);
  const badgeRef = useRef<HTMLSpanElement>(null);
  const [anchorRect, setAnchorRect] = useState<DOMRect | null>(null);

  const { ua, en } = useMemo(() => getTranslation(code), [code]);
  const label = code || "";
  const hintPrimary = ua || " ";
  const hintSecondary = en || (code ? code : "");

  useEffect(() => setOpen(false), [code]);

  useEffect(() => {
    if (!open) return;
    const handleOutside = (event: PointerEvent) => {
      if (!wrapperRef.current?.contains(event.target as Node)) {
        setOpen(false);
      }
    };

    document.addEventListener("pointerdown", handleOutside);
    return () => document.removeEventListener("pointerdown", handleOutside);
  }, [open]);

  useEffect(() => {
    if (!open) {
      setAnchorRect(null);
      return;
    }

    const update = () => {
      const rect = badgeRef.current?.getBoundingClientRect();
      setAnchorRect(rect ?? null);
    };

    update();
    window.addEventListener("scroll", update, true);
    window.addEventListener("resize", update);
    return () => {
      window.removeEventListener("scroll", update, true);
      window.removeEventListener("resize", update);
    };
  }, [open]);

  const toggle = (event?: SyntheticEvent) => {
    event?.stopPropagation();
    setOpen((prev) => !prev);
  };

  const handleKeyDown = (event: KeyboardEvent<HTMLDivElement>) => {
    if (event.key === "Enter" || event.key === " ") {
      event.preventDefault();
      toggle(event);
    }
  };

  return (
    <div ref={wrapperRef} data-stop-card-click className={clsx("relative", className)}>
      <span ref={badgeRef} className="inline-flex">
        <Badge
          role="button"
          tabIndex={0}
          variant="outline"
          className={clsx(
            "cursor-pointer select-none border-white/15 bg-white/5 text-slate-200",
            "hover:bg-white/7 hover:text-white",
            active && "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100",
            className
          )}
          onClick={toggle}
          onPointerDown={(event) => event.stopPropagation()}
          onKeyDown={handleKeyDown}
        >
          {label}
        </Badge>
      </span>

      {open && anchorRect
        ? createPortal(
            <div
              className="fixed z-[9999]"
              style={{
                left: anchorRect.left + anchorRect.width / 2,
                top: Math.max(8, anchorRect.top - 8),
              }}
              onPointerDown={(event) => event.stopPropagation()}
              onClick={(event) => {
                event.stopPropagation();
                setOpen(false);
              }}
              data-stop-card-click
            >
              <div className="flex -translate-x-1/2 -translate-y-full flex-col items-center">
                <div className="relative max-w-[240px] rounded-lg border border-white/10 bg-slate-900/95 px-3 py-2 pr-9 text-xs font-semibold text-slate-50 backdrop-blur">
                  <Button
                    type="button"
                    variant="ghost"
                    size="icon"
                    className="absolute right-1 top-1 h-7 w-7 text-slate-300 hover:bg-white/10 hover:text-white"
                    aria-label=""
                    onClick={(event) => {
                      event.stopPropagation();
                      setOpen(false);
                    }}
                    onPointerDown={(event) => event.stopPropagation()}
                  >
                    <X className="h-4 w-4" />
                  </Button>

                  <span>{hintPrimary}</span>
                  {hintSecondary ? (
                    <span className="ml-1 text-[11px] font-normal text-slate-400">({hintSecondary})</span>
                  ) : null}
                </div>
                <div className="h-2 w-2 rotate-45 border-b border-r border-white/10 bg-slate-900/95" />
              </div>
            </div>,
            document.body
          )
        : null}
    </div>
  );
};

export default SourceBadge;
</file>

<file path="src/lib/components/characterCreator/SubclassForm.tsx">
"use client";

import { useStepForm } from "@/hooks/useStepForm";
import { subclassSchema } from "@/lib/zod/schemas/persCreateSchema";
import { ClassI } from "@/lib/types/model-types";
import { Card, CardContent } from "@/components/ui/card";
import clsx from "clsx";
import { useEffect } from "react";
import { Badge } from "@/components/ui/badge";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import { InfoDialog, InfoGrid, InfoPill, InfoSectionTitle } from "@/lib/components/characterCreator/EntityInfoDialog";
// import { SourceBadge } from "@/lib/components/characterCreator/SourceBadge";
import { sourceTranslations, subclassTranslations, subclassTranslationsEng } from "@/lib/refs/translation";
import {
  formatLanguages,
  formatToolProficiencies,
  prettifyEnum,
  translateValue,
} from "@/lib/components/characterCreator/infoUtils";
import { FormattedDescription } from "@/components/ui/FormattedDescription";

interface Props {
  cls: ClassI;
  formId: string;
  onNextDisabledChange?: (disabled: boolean) => void;
}

export const SubclassForm = ({ cls, formId, onNextDisabledChange }: Props) => {
  const { updateFormData, nextStep } = usePersFormStore();
  
  const { form, onSubmit } = useStepForm(subclassSchema, (data) => {
    updateFormData({ 
      subclassId: data.subclassId,
      subclassChoiceSelections: data.subclassChoiceSelections 
    });
    nextStep();
  });
  
  const chosenSubclassId = form.watch("subclassId");

  useEffect(() => {
    if (!chosenSubclassId) {
      onNextDisabledChange?.(true);
      return;
    }
    onNextDisabledChange?.(false);
  }, [onNextDisabledChange, chosenSubclassId]);

  const subclasses = cls.subclasses || [];

  const SubclassInfoModal = ({ subclass }: { subclass: any }) => {
    const name = subclassTranslations[subclass.name] ?? subclass.name;
    const rawFeatures = subclass.features || [];
    const featureList = [...rawFeatures].sort(
      (a: any, b: any) => (a.levelUnlock || 0) - (b.levelUnlock || 0)
    );

    return (
      <InfoDialog
        title={name}
        triggerLabel={`  ${name}`}
      >
        <InfoGrid>
          <InfoPill label="" value={sourceTranslations[subclass.source] ?? subclass.source} />
          <InfoPill label=" " value={prettifyEnum(subclass.primaryCastingStat)} />
          <InfoPill label=" " value={prettifyEnum(subclass.spellcastingType)} />
          <InfoPill
            label=""
            value={formatLanguages(subclass.languages, subclass.languagesToChooseCount)}
          />
          <InfoPill
            label=""
            value={formatToolProficiencies(subclass.toolProficiencies, subclass.toolToChooseCount)}
          />
          <div className="col-span-full">
             {subclass.description ? (
               <FormattedDescription content={subclass.description} className="text-sm text-slate-300" />
             ) : null}
          </div>
        </InfoGrid>

        <div className="space-y-2">
          <InfoSectionTitle> </InfoSectionTitle>
          {featureList.length ? (
            featureList.map((f: any) => (
              <div
                key={f.feature.featureId}
                className="glass-panel border-gradient-rpg rounded-lg px-3 py-2.5"
              >
                <div className="flex items-center justify-between mb-1">
                  <p className="text-sm font-semibold text-white">{f.feature.name}</p>
                  <Badge variant="outline" className="border-white/15 bg-white/5 text-[10px] text-slate-300">
                    {(() => {
                      const lvl = f.levelUnlock ?? f.levelGranted;
                      return `. ${lvl ?? ""}`;
                    })()}
                  </Badge>
                </div>
                <FormattedDescription
                  content={f.feature.description}
                  className="text-sm leading-relaxed text-slate-200/90"
                />
              </div>
            ))
          ) : (
            <p className="text-sm text-slate-400">      .</p>
          )}
        </div>
      </InfoDialog>
    );
  };

  return (
    <form id={formId} onSubmit={onSubmit} className="w-full space-y-4">
      <div className="space-y-2 text-center">
        <h2 className="font-rpg-display text-3xl font-semibold uppercase tracking-widest text-slate-200 sm:text-4xl">
           
        </h2>
        <p className="text-sm text-slate-400">  {translateValue(cls.name)}</p>
      </div>
      <div className="grid gap-3 sm:grid-cols-2">
        {subclasses.map((sc) => {
          const name = subclassTranslations[sc.name] ?? sc.name;
          const engName = subclassTranslationsEng[sc.name] ?? sc.name;
          
          return (
          <Card
            key={sc.subclassId}
            className={clsx(
              "glass-card cursor-pointer transition-all duration-200",
              sc.subclassId === chosenSubclassId && "glass-active"
            )}
            onClick={(e) => {
              if ((e.target as HTMLElement | null)?.closest?.('[data-stop-card-click]')) return;
              if (sc.subclassId === chosenSubclassId) return;
              form.setValue("subclassId", sc.subclassId, { shouldDirty: true, shouldTouch: true, shouldValidate: true });
              form.setValue("subclassChoiceSelections", {}, { shouldDirty: true, shouldTouch: true, shouldValidate: true });
              updateFormData({ subclassId: sc.subclassId, subclassChoiceSelections: {} });
            }}
          >
            <CardContent className="relative flex items-center justify-between p-4">
              <SubclassInfoModal subclass={sc} />
              <div>
                <div className="text-lg font-semibold text-white">{name}</div>
                <div className="text-xs text-slate-400">{engName}</div>
              </div>
              {/* <SourceBadge code={sc.source} active={sc.subclassId === chosenSubclassId} /> */}
            </CardContent>
          </Card>
        )})}
      </div>
      <input
        type="hidden"
        {...form.register("subclassId", {
          setValueAs: (value) => {
            if (value === "" || value === undefined || value === null) return undefined;
            const num = typeof value === "number" ? value : Number(value);
            return Number.isFinite(num) ? num : undefined;
          },
        })}
      />
    </form>
  );
};

export default SubclassForm;
</file>

<file path="src/lib/components/characterCreator/SubracesForm.tsx">
"use client";

import { useStepForm } from "@/hooks/useStepForm";
import { subraceSchema } from "@/lib/zod/schemas/persCreateSchema";
import { RaceI } from "@/lib/types/model-types";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import clsx from "clsx";
import { useEffect } from "react";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import { InfoDialog, InfoGrid, InfoPill, InfoSectionTitle } from "@/lib/components/characterCreator/EntityInfoDialog";
import { SourceBadge } from "@/lib/components/characterCreator/SourceBadge";
import { sourceTranslations, subraceTranslations, subraceTranslationsEng } from "@/lib/refs/translation";
import {
  // formatArmorProficiencies,
  formatASI,
  formatLanguages,
  // formatList,
  // formatSkillProficiencies,
  formatSpeeds,
  formatToolProficiencies,
  // formatWeaponProficiencies,
  translateValue,
} from "@/lib/components/characterCreator/infoUtils";
import { FormattedDescription } from "@/components/ui/FormattedDescription";

interface Props {
  race: RaceI;
  formId: string;
  onNextDisabledChange?: (disabled: boolean) => void;
}

export const SubracesForm = ({ race, formId, onNextDisabledChange }: Props) => {
  const { updateFormData, nextStep } = usePersFormStore();
  
  const { form, onSubmit } = useStepForm(subraceSchema, (data) => {
    updateFormData({ subraceId: data.subraceId });
    nextStep();
  });
  
  const chosenSubraceId = form.watch("subraceId");

  useEffect(() => {
    // Subrace selection is optional  user can continue without choosing.
    onNextDisabledChange?.(false);
  }, [onNextDisabledChange]);

  const subraces = race.subraces || [];

  const SubraceInfoModal = ({ subrace }: { subrace: any }) => {
    const name = subraceTranslations[subrace.name] ?? subrace.name;
    const rawTraits = subrace.traits || [];
    const traitList = [...rawTraits].sort(
      (a: any, b: any) => (a.subraceTraitId || 0) - (b.subraceTraitId || 0)
    );

    return (
      <InfoDialog
        title={name}
        triggerLabel={`  ${name}`}
      >
        <InfoGrid>
          <InfoPill label="" value={sourceTranslations[subrace.source] ?? subrace.source} />
          <InfoPill label="" value={formatSpeeds(subrace)} />
          <InfoPill label=" " value={formatASI(subrace.additionalASI)} />
          <InfoPill
            label=""
            value={formatLanguages(subrace.additionalLanguages, subrace.languagesToChooseCount)}
          />
          <InfoPill
            label=""
            value={formatToolProficiencies(subrace.toolProficiencies)}
          />
          <div className="col-span-full">
             {subrace.description ? (
               <FormattedDescription content={subrace.description} className="text-sm text-slate-300" />
             ) : null}
          </div>
        </InfoGrid>

        <div className="space-y-2">
          <InfoSectionTitle></InfoSectionTitle>
          {traitList.length ? (
            traitList.map((trait: any) => (
              <div
                key={trait.subraceTraitId}
                className="glass-panel border-gradient-rpg rounded-lg px-3 py-2.5"
              >
                <p className="text-sm font-semibold text-white">{trait.feature.name}</p>
                <FormattedDescription
                  content={trait.feature.description}
                  className="text-sm leading-relaxed text-slate-200/90"
                />
              </div>
            ))
          ) : (
            <p className="text-sm text-slate-400">      .</p>
          )}
        </div>
      </InfoDialog>
    );
  };

  return (
    <form id={formId} onSubmit={onSubmit} className="w-full space-y-4">
      <div className="space-y-2 text-center">
        <h2 className="font-rpg-display text-3xl font-semibold uppercase tracking-widest text-slate-200 sm:text-4xl">
            ()
        </h2>
        <p className="text-sm text-slate-400">  {translateValue(race.name)}</p>
      </div>
      <div className="grid gap-3 sm:grid-cols-2">
        {subraces.map((sr) => {
          const name = subraceTranslations[sr.name] ?? sr.name;
          const engName = subraceTranslationsEng[sr.name] ?? sr.name;
          
          return (
          <Card
            key={sr.subraceId}
            className={clsx(
              "glass-card cursor-pointer transition-all duration-200",
              sr.subraceId === chosenSubraceId && "glass-active"
            )}
            onClick={(e) => {
              if ((e.target as HTMLElement | null)?.closest?.('[data-stop-card-click]')) return;
              form.setValue("subraceId", sr.subraceId);
            }}
          >
            <CardContent className="relative flex items-center justify-between p-4">
              <SubraceInfoModal subrace={sr} />
              <div>
                <div className="text-lg font-semibold text-white">{name}</div>
                <div className="text-xs text-slate-400">{engName}</div>
              </div>
              <SourceBadge code={sr.source} active={sr.subraceId === chosenSubraceId} />
            </CardContent>
          </Card>
        )})}
      </div>

      <div className="flex justify-center">
        <Button
          type="button"
          variant="outline"
            className="border-white/15 bg-white/5 text-slate-200 hover:bg-white/7"
          onClick={() => {
            form.setValue("subraceId", undefined);
            updateFormData({ subraceId: undefined });
            nextStep();
          }}
        >
          
        </Button>
      </div>

      <input
        type="hidden"
        {...form.register("subraceId", {
          setValueAs: (value) => {
            if (value === "" || value === undefined || value === null) return undefined;
            const num = typeof value === "number" ? value : Number(value);
            return Number.isFinite(num) ? num : undefined;
          },
        })}
      />
    </form>
  );
};

export default SubracesForm;
</file>

<file path="src/lib/components/characterSheet/slides/FeaturesSlide.tsx">
"use client";

import { useMemo, useState, useTransition } from "react";
import { CharacterFeatureItem, CharacterFeaturesGroupedResult, PersWithRelations } from "@/lib/actions/pers";
import { FeatureDisplayType, SpellcastingType } from "@prisma/client";
import { ChevronRight } from "lucide-react";
import { useRouter } from "next/navigation";
import { spendFeatureUse, restoreFeatureUse } from "@/lib/actions/feature-uses";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from "@/components/ui/collapsible";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { useModalBackButton } from "@/hooks/useModalBackButton";
import { FormattedDescription } from "@/components/ui/FormattedDescription";
import { FeatureCard, ResourceCard } from "@/lib/components/characterSheet/shared/FeatureCards";
import { toast } from "sonner";

import { Badge } from "@/components/ui/badge";
import {
  ControlledInfoDialog,
  InfoGrid,
  InfoPill,
  InfoSectionTitle,
} from "@/lib/components/characterCreator/EntityInfoDialog";
import {
  formatASI,
  formatAbilityList,
  formatArmorProficiencies,
  formatLanguages,
  formatList,
  formatMulticlassReqs,
  formatRaceAC,
  formatSkillProficiencies,
  formatSpeeds,
  formatToolProficiencies,
  formatWeaponProficiencies,
  prettifyEnum,
  translateValue,
} from "@/lib/components/characterCreator/infoUtils";
import {
  backgroundTranslations,
  classTranslations,
  raceTranslations,
  sourceTranslations,
  subraceTranslations,
  subclassTranslations,
  variantTranslations,
} from "@/lib/refs/translation";

interface FeaturesSlideProps {
  pers: PersWithRelations;
  groupedFeatures: CharacterFeaturesGroupedResult | null;
  isReadOnly?: boolean;
}

type CategoryKind = "passive" | "action" | "bonus" | "reaction";
type Category = { title: string; items: CharacterFeatureItem[]; kind: CategoryKind };

type EntityDialogKind = "race" | "raceVariant" | "subrace" | "class" | "subclass" | "background";

const SPELLCASTING_LABELS: Record<SpellcastingType, string> = {
  NONE: " ",
  FULL: " ",
  HALF: " ",
  THIRD: " ",
  PACT: " ",
};

// safeText removed - no longer used

function categoryVariant(kind: "passive" | "action" | "bonus" | "reaction") {
  switch (kind) {
    case "action":
      return {
        container: "border-l-red-500/50 from-red-950/20",
        chevron: "text-red-300",
        title: "text-red-50",
        count: "text-red-200/70",
        cardBorder: "border-red-600/30 hover:border-red-500/60",
        cardBg: "bg-red-900/25 hover:bg-red-900/45",
      };
    case "bonus":
      return {
        container: "border-l-blue-500/50 from-blue-950/20",
        chevron: "text-blue-300",
        title: "text-blue-50",
        count: "text-blue-200/70",
        cardBorder: "border-blue-600/30 hover:border-blue-500/60",
        cardBg: "bg-blue-900/25 hover:bg-blue-900/45",
      };
    case "reaction":
      return {
        container: "border-l-purple-500/50 from-purple-950/20",
        chevron: "text-purple-300",
        title: "text-purple-50",
        count: "text-purple-200/70",
        cardBorder: "border-purple-600/30 hover:border-purple-500/60",
        cardBg: "bg-purple-900/25 hover:bg-purple-900/45",
      };
    case "passive":
    default:
      return {
        container: "border-l-amber-600/50 from-amber-950/20",
        chevron: "text-amber-300",
        title: "text-amber-50",
        count: "text-amber-200/70",
        cardBorder: "border-amber-700/30 hover:border-amber-600/60",
        cardBg: "bg-amber-900/20 hover:bg-amber-900/40",
      };
  }
}

// getKindFromPrimaryType removed - no longer used

// Redundant local FeatureCard removed - using shared/FeatureCards.tsx

export default function FeaturesSlide({ pers, groupedFeatures, isReadOnly }: FeaturesSlideProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();

  const [selected, setSelected] = useState<CharacterFeatureItem | null>(null);

  useModalBackButton(!!selected, () => setSelected(null));
  const [entityOpen, setEntityOpen] = useState(false);
  const [entityKind, setEntityKind] = useState<EntityDialogKind>("race");
  const [entityVariantIndex, setEntityVariantIndex] = useState(0);

  const [usesOverrideByKey, setUsesOverrideByKey] = useState<Record<string, number | null>>({});

  const classEntries = useMemo(() => {
    const multiclasses = ((pers as any).multiclasses || []) as any[];
    const multiclassLevels = multiclasses.reduce((acc, m) => acc + (Number(m.classLevel) || 0), 0);
    const mainLevel = Math.max(1, (Number(pers.level) || 1) - multiclassLevels);

    const entries: Array<{
      key: string;
      kind: "main" | "multiclass";
      classLevel: number;
      cls: any;
    }> = [];

    entries.push({
      key: `main:${pers.classId}`,
      kind: "main",
      classLevel: mainLevel,
      cls: pers.class,
    });

    multiclasses.forEach((m) => {
      if (!m?.class) return;
      entries.push({
        key: `multi:${m.classId}`,
        kind: "multiclass",
        classLevel: Number(m.classLevel) || 1,
        cls: m.class,
      });
    });

    return entries;
  }, [pers]);

  const subclassEntries = useMemo(() => {
    const multiclasses = ((pers as any).multiclasses || []) as any[];
    const multiclassLevels = multiclasses.reduce((acc, m) => acc + (Number(m.classLevel) || 0), 0);
    const mainLevel = Math.max(1, (Number(pers.level) || 1) - multiclassLevels);

    const entries: Array<{
      key: string;
      kind: "main" | "multiclass";
      classLevel: number;
      cls: any;
      subclass: any;
    }> = [];

    if (pers.subclass) {
      entries.push({
        key: `main:${pers.classId}:${pers.subclassId ?? "none"}`,
        kind: "main",
        classLevel: mainLevel,
        cls: pers.class,
        subclass: pers.subclass,
      });
    }

    multiclasses.forEach((m) => {
      if (!m?.class || !m?.subclass) return;
      entries.push({
        key: `multi:${m.classId}:${m.subclassId ?? "none"}`,
        kind: "multiclass",
        classLevel: Number(m.classLevel) || 1,
        cls: m.class,
        subclass: m.subclass,
      });
    });

    return entries;
  }, [pers]);

  const categories = useMemo<Category[]>(() => {
    if (!groupedFeatures) return [];
    return [
      { title: " ", items: groupedFeatures.actions, kind: "action" },
      { title: " ", items: groupedFeatures.bonusActions, kind: "bonus" },
      { title: "", items: groupedFeatures.reactions, kind: "reaction" },
      { title: " ", items: groupedFeatures.passive, kind: "passive" },
    ];
  }, [groupedFeatures]);

  const allItems = useMemo(() => {
    if (!groupedFeatures) return [] as CharacterFeatureItem[];
    return [
      ...(groupedFeatures.actions ?? []),
      ...(groupedFeatures.bonusActions ?? []),
      ...(groupedFeatures.reactions ?? []),
      ...(groupedFeatures.passive ?? []),
    ];
  }, [groupedFeatures]);

// Redundant slot and label helpers removed

  const resourceItems = useMemo(() => {
    return allItems
      .filter((it) => Array.isArray(it.displayTypes) && (it.displayTypes.includes(FeatureDisplayType.RESOURCE) || it.displayTypes.includes(FeatureDisplayType.CLASS_RESOURCE)))
      .filter((it) => typeof it.usesPer === "number");
  }, [allItems]);

// limitedUseGroups removed

  const getUsesRemaining = (item: CharacterFeatureItem) => {
    const overridden = usesOverrideByKey[item.key];
    return typeof overridden === "number" || overridden === null ? overridden : item.usesRemaining ?? null;
  };

  const spendOneUse = (item: CharacterFeatureItem) => {
    if (isReadOnly || !item.featureId) return;
    const cur = getUsesRemaining(item);
    if (typeof cur !== "number" || cur <= 0) return;

    setUsesOverrideByKey((prev) => ({ ...prev, [item.key]: Math.max(0, cur - 1) }));
    startTransition(async () => {
      const res = await spendFeatureUse({ persId: pers.persId, featureId: item.featureId! });
      if (!res.success) {
        toast.error(res.error);
        router.refresh();
        return;
      }
      setUsesOverrideByKey((prev) => ({ ...prev, [item.key]: res.usesRemaining }));
      router.refresh();
    });
  };

  const restoreOneUse = (item: CharacterFeatureItem) => {
    if (isReadOnly || !item.featureId) return;
    const cur = getUsesRemaining(item);
    if (typeof cur !== "number" || cur >= (item.usesPer ?? 0)) return;

    setUsesOverrideByKey((prev) => ({ ...prev, [item.key]: cur + 1 }));
    startTransition(async () => {
      const res = await restoreFeatureUse({ persId: pers.persId, featureId: item.featureId! });
      if (!res.success) {
          toast.error(res.error);
          router.refresh();
          return;
      }
      setUsesOverrideByKey((prev) => ({ ...prev, [item.key]: res.usesRemaining }));
      router.refresh();
    });
  };

  const raceName = useMemo(
    () => raceTranslations[pers.race.name as keyof typeof raceTranslations] || pers.race.name,
    [pers.race.name]
  );
  const subraceName = useMemo(() => {
    if (!pers.subrace) return null;
    return subraceTranslations[pers.subrace.name as keyof typeof subraceTranslations] || pers.subrace.name;
  }, [pers.subrace]);
  const backgroundName = useMemo(
    () => backgroundTranslations[pers.background.name as keyof typeof backgroundTranslations] || pers.background.name,
    [pers.background.name]
  );

  const openEntity = (kind: EntityDialogKind, variantIndex?: number) => {
    if (isReadOnly) return;
    setEntityKind(kind);
    if (typeof variantIndex === "number") setEntityVariantIndex(variantIndex);
    setEntityOpen(true);
  };

  const parseItems = (items: unknown): string[] => {
    if (!Array.isArray(items)) return [];

    return (items as unknown[])
      .map((item) => {
        if (!item) return null;
        if (typeof item === "string") return item;
        if (typeof item === "object") {
          const name = (item as any).name;
          const quantity = (item as any).quantity;
          if (!name) return null;
          return quantity ? `${name} x${quantity}` : name;
        }
        return null;
      })
      .filter(Boolean) as string[];
  };

  const entityDialog = useMemo(() => {
    if (entityKind === "race") {
      const race = pers.race as any;
      const rawTraits = (race.traits || []) as any[];
      const traitList = [...rawTraits].sort((a, b) => (a.raceTraitId || 0) - (b.raceTraitId || 0));

      return {
        title: raceName,
        subtitle: undefined,
        content: (
          <>
            <InfoGrid>
              <InfoPill label="" value={sourceTranslations[race.source] ?? race.source} />
              <InfoPill label="" value={formatList(race.size)} />
              <InfoPill label="" value={formatSpeeds(race)} />
              <InfoPill label=" " value={formatRaceAC(race.ac)} />
              <InfoPill label=" " value={formatASI(race.ASI)} />
              <InfoPill label="" value={formatLanguages(race.languages, race.languagesToChooseCount)} />
              <InfoPill label="" value={formatSkillProficiencies(race.skillProficiencies)} />
              <InfoPill label="" value={formatToolProficiencies(race.toolProficiencies, race.toolToChooseCount)} />
              <InfoPill label="" value={formatWeaponProficiencies(race.weaponProficiencies)} />
              <InfoPill label="" value={formatArmorProficiencies(race.armorProficiencies)} />
            </InfoGrid>

            <div className="space-y-2">
              <InfoSectionTitle></InfoSectionTitle>
              {traitList.length ? (
                traitList.map((trait, idx) => (
                  <div
                    key={trait.raceTraitId ?? `feature:${trait.feature?.featureId ?? "unknown"}:${idx}`}
                    className="rounded-lg border border-slate-800/80 bg-slate-900/60 px-3 py-2.5 shadow-inner"
                  >
                    <p className="text-sm font-semibold text-white">{trait.feature?.name}</p>
                    {trait.feature?.description ? (
                      <div className="mt-1">
                        <FormattedDescription content={trait.feature.description} className="text-slate-200/90" />
                      </div>
                    ) : null}
                  </div>
                ))
              ) : (
                <p className="text-sm text-slate-400">      .</p>
              )}
            </div>
          </>
        ),
      };
    }

    if (entityKind === "raceVariant") {
      const variants = (pers as any).raceVariants as any[] | undefined;
      const variant = variants?.[entityVariantIndex];
      if (!variant) {
        return {
          title: " ",
          subtitle: undefined,
          content: <div className="text-sm text-slate-400">   .</div>,
        };
      }

      const name = variantTranslations[variant.name as keyof typeof variantTranslations] ?? String(variant.name);
      const rawTraits = (variant.traits || []) as any[];
      const traitList = [...rawTraits].sort((a, b) => (a.raceVariantTraitId || 0) - (b.raceVariantTraitId || 0));

      return {
        title: name,
        subtitle: undefined,
        content: (
          <>
            <InfoGrid>
              <InfoPill label="" value={sourceTranslations[variant.source] ?? variant.source} />
              <InfoPill
                label=""
                value={
                  formatSpeeds({
                    speed: variant.overridesRaceSpeed,
                    flightSpeed: variant.overridesFlightSpeed,
                  })
                }
              />
              <InfoPill label=" " value={formatASI(variant.overridesRaceASI)} />
              <div className="col-span-full">
                {variant.description ? <FormattedDescription content={variant.description} className="text-slate-200/90" /> : null}
              </div>
            </InfoGrid>

            <div className="space-y-2">
              <InfoSectionTitle></InfoSectionTitle>
              {traitList.length ? (
                traitList.map((trait, idx) => (
                  <div
                    key={trait.raceVariantTraitId ?? `feature:${trait.feature?.featureId ?? "unknown"}:${idx}`}
                    className="rounded-lg border border-slate-800/80 bg-slate-900/60 px-3 py-2.5 shadow-inner"
                  >
                    <p className="text-sm font-semibold text-white">{trait.feature?.name}</p>
                    {trait.feature?.description ? (
                      <div className="mt-1">
                        <FormattedDescription content={trait.feature.description} className="text-slate-200/90" />
                      </div>
                    ) : null}
                  </div>
                ))
              ) : (
                <p className="text-sm text-slate-400">      .</p>
              )}
            </div>
          </>
        ),
      };
    }

    if (entityKind === "subrace") {
      if (!pers.subrace) {
        return {
          title: "",
          subtitle: undefined,
          content: <div className="text-sm text-slate-400">  .</div>,
        };
      }

      const subrace = pers.subrace as any;
      const rawTraits = (subrace.traits || []) as any[];
      const traitList = [...rawTraits].sort((a, b) => (a.subraceTraitId || 0) - (b.subraceTraitId || 0));

      return {
        title: subraceName || subrace.name,
        subtitle: undefined,
        content: (
          <>
            <InfoGrid>
              <InfoPill label="" value={sourceTranslations[subrace.source] ?? subrace.source} />
              <InfoPill label="" value={formatSpeeds(subrace)} />
              <InfoPill label=" " value={formatASI(subrace.additionalASI)} />
              <InfoPill label="" value={formatLanguages(subrace.additionalLanguages, subrace.languagesToChooseCount)} />
              <InfoPill label="" value={formatToolProficiencies(subrace.toolProficiencies)} />
            </InfoGrid>

            <div className="space-y-2">
              <InfoSectionTitle></InfoSectionTitle>
              {traitList.length ? (
                traitList.map((trait, idx) => (
                  <div
                    key={trait.subraceTraitId ?? `feature:${trait.feature?.featureId ?? "unknown"}:${idx}`}
                    className="rounded-lg border border-slate-800/80 bg-slate-900/60 px-3 py-2.5 shadow-inner"
                  >
                    <p className="text-sm font-semibold text-white">{trait.feature?.name}</p>
                    {trait.feature?.description ? (
                      <div className="mt-1">
                        <FormattedDescription content={trait.feature.description} className="text-slate-200/90" />
                      </div>
                    ) : null}
                  </div>
                ))
              ) : (
                <p className="text-sm text-slate-400">      .</p>
              )}
            </div>
          </>
        ),
      };
    }

    if (entityKind === "class") {
      const entry = classEntries[entityVariantIndex] ?? classEntries[0];
      const cls = (entry?.cls ?? pers.class) as any;
      const rawFeatures = (cls.features || []) as any[];
      const features = [...rawFeatures].sort((a, b) => (a.levelGranted || 0) - (b.levelGranted || 0));

      const title = classTranslations[cls.name as keyof typeof classTranslations] || cls.name;

      return {
        title,
        subtitle: undefined,
        content: (
          <>
            <InfoGrid>
              <InfoPill label=" " value={`d${cls.hitDie}`} />
              <InfoPill label="" value={SPELLCASTING_LABELS[cls.spellcastingType as SpellcastingType] ?? ""} />
              <InfoPill label="  " value={` ${cls.subclassLevel}`} />
              <InfoPill label="" value={formatAbilityList(cls.savingThrows)} />
              <InfoPill label="" value={formatSkillProficiencies(cls.skillProficiencies)} />
              <InfoPill label="" value={formatToolProficiencies(cls.toolProficiencies, cls.toolToChooseCount)} />
              <InfoPill label="" value={formatWeaponProficiencies(cls.weaponProficiencies)} />
              <InfoPill label="" value={formatArmorProficiencies(cls.armorProficiencies)} />
              <InfoPill label="" value={formatLanguages(cls.languages, cls.languagesToChooseCount)} />
              <InfoPill label="" value={formatMulticlassReqs(cls.multiclassReqs)} />
              {cls.primaryCastingStat ? (
                <InfoPill label=" " value={prettifyEnum(cls.primaryCastingStat)} />
              ) : null}
            </InfoGrid>

            <div className="space-y-2">
              <InfoSectionTitle></InfoSectionTitle>
              {features.length ? (
                features.map((feature) => (
                  <div
                    key={feature.classFeatureId || feature.feature?.featureId}
                    className="rounded-lg border border-slate-800/80 bg-slate-900/60 px-3 py-2.5 shadow-inner"
                  >
                    <div className="mb-1 flex items-center justify-between gap-2">
                      <p className="text-sm font-semibold text-white">{feature.feature?.name}</p>
                      <Badge
                        variant="outline"
                        className="border-slate-700 bg-slate-800/70 text-[11px] text-slate-200"
                      >
                        . {feature.levelGranted}
                      </Badge>
                    </div>
                    {feature.feature?.description ? (
                      <div className="mt-1">
                        <FormattedDescription content={feature.feature.description} className="text-slate-200/90" />
                      </div>
                    ) : null}
                  </div>
                ))
              ) : (
                <p className="text-sm text-slate-400">   .</p>
              )}
            </div>
          </>
        ),
      };
    }

    if (entityKind === "subclass") {
      const entry = subclassEntries[entityVariantIndex] ?? subclassEntries[0];

      if (!entry?.subclass) {
        return {
          title: "",
          subtitle: undefined,
          content: <div className="text-sm text-slate-400">  .</div>,
        };
      }

      const subcls = entry.subclass as any;
      const rawFeatures = (subcls.features || []) as any[];
      const featureList = [...rawFeatures].sort((a, b) => (a.levelUnlock || 0) - (b.levelUnlock || 0));

      const title =
        subclassTranslations[subcls.name as keyof typeof subclassTranslations] ||
        subcls.name ||
        "";

      return {
        title,
        subtitle: undefined,
        content: (
          <>
            <InfoGrid>
              <InfoPill label="" value={sourceTranslations[subcls.source] ?? subcls.source} />
              <InfoPill label=" " value={prettifyEnum(subcls.primaryCastingStat)} />
              <InfoPill label=" " value={prettifyEnum(subcls.spellcastingType)} />
              <InfoPill label="" value={formatLanguages(subcls.languages, subcls.languagesToChooseCount)} />
              <InfoPill label="" value={formatToolProficiencies(subcls.toolProficiencies, subcls.toolToChooseCount)} />
              <div className="col-span-full">
                {subcls.description ? (
                  <FormattedDescription content={subcls.description} className="text-slate-200/90" />
                ) : null}
              </div>
            </InfoGrid>

            <div className="space-y-2">
              <InfoSectionTitle> </InfoSectionTitle>
              {featureList.length ? (
                featureList.map((f) => (
                  <div
                    key={f.feature?.featureId}
                    className="rounded-lg border border-slate-800/80 bg-slate-900/60 px-3 py-2.5 shadow-inner"
                  >
                    <div className="flex items-center justify-between mb-1">
                      <p className="text-sm font-semibold text-white">{f.feature?.name}</p>
                      <Badge variant="outline" className="text-[10px] border-slate-700 text-slate-400">
                        {(() => {
                          const lvl = (f as any).levelUnlock ?? (f as any).levelGranted;
                          return `. ${lvl ?? ""}`;
                        })()}
                      </Badge>
                    </div>
                    {f.feature?.description ? (
                      <div className="mt-1">
                        <FormattedDescription content={f.feature.description} className="text-slate-200/90" />
                      </div>
                    ) : null}
                  </div>
                ))
              ) : (
                <p className="text-sm text-slate-400">      .</p>
              )}
            </div>
          </>
        ),
      };
    }

    const background = pers.background as any;
    const items = parseItems(background.items);
    const resolvedSource = background.source ? prettifyEnum(background.source) : "";

    return {
      title: backgroundName,
      subtitle: undefined,
      content: (
        <>
          <InfoGrid>
            <InfoPill label="" value={resolvedSource} />
            <InfoPill label="" value={formatSkillProficiencies(background.skillProficiencies)} />
            <InfoPill label="" value={formatToolProficiencies(background.toolProficiencies)} />
            <InfoPill label="" value={formatLanguages([], background.languagesToChooseCount)} />
            <InfoPill label="" value={background.specialAbilityName || "-"} />
          </InfoGrid>

          {items.length ? (
            <div className="space-y-1.5">
              <InfoSectionTitle> </InfoSectionTitle>
              <ul className="space-y-1 text-sm text-slate-200/90">
                {items.map((item, index) => (
                  <li key={`${item}-${index}`} className="flex items-start gap-2">
                    <span className="mt-1 h-1.5 w-1.5 rounded-full bg-indigo-400" aria-hidden />
                    <span className="flex-1">{item}</span>
                  </li>
                ))}
              </ul>
            </div>
          ) : null}

          {(background.specialAbilityName || background.description) ? (
            <div className="space-y-1">
              <InfoSectionTitle> </InfoSectionTitle>
              {background.specialAbilityName ? (
                <p className="text-sm font-semibold text-white">{background.specialAbilityName}</p>
              ) : null}
              {background.description ? (
                <FormattedDescription content={background.description} className="text-slate-200/90" />
              ) : null}
            </div>
          ) : null}
        </>
      ),
    };
  }, [backgroundName, classEntries, entityKind, entityVariantIndex, pers, raceName, subclassEntries, subraceName]);

  return (
    <div className="h-full p-3 sm:p-4 space-y-3">
      <h2 className="text-xl sm:text-2xl font-bold text-slate-50"></h2>

      <div className="grid grid-cols-2 sm:grid-cols-3 gap-1">
        <button
          type="button"
          onClick={() => openEntity("race")}
          disabled={isReadOnly}
          className="rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition px-1.5 py-0.5 text-center flex flex-col items-center justify-center h-12"
        >
          <div className="text-[8px] uppercase tracking-[0.1em] text-slate-400 leading-none"></div>
          <div className="text-[12px] font-semibold text-slate-50 truncate leading-tight">{raceName}</div>
        </button>

        {(pers as any).raceVariants?.map((rv: any, idx: number) => {
          const name = variantTranslations[rv.name as keyof typeof variantTranslations] ?? String(rv.name);
          return (
            <button
              key={rv.raceVariantId ?? idx}
              type="button"
              onClick={() => openEntity("raceVariant", idx)}
              disabled={isReadOnly}
              className="rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition px-1.5 py-0.5 text-center flex flex-col items-center justify-center h-12"
            >
              <div className="text-[8px] uppercase tracking-[0.1em] text-slate-400 leading-none"> </div>
              <div className="text-[12px] font-semibold text-slate-50 truncate leading-tight">{name}</div>
            </button>
          );
        })}

        {pers.subrace ? (
          <button
            type="button"
            onClick={() => openEntity("subrace")}
            disabled={isReadOnly}
            className="rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition px-1.5 py-0.5 text-center flex flex-col items-center justify-center h-12"
          >
            <div className="text-[8px] uppercase tracking-[0.1em] text-slate-400 leading-none"></div>
            <div className="text-[12px] font-semibold text-slate-50 truncate leading-tight">{subraceName}</div>
          </button>
        ) : null}

        <button
          type="button"
          onClick={() => openEntity("class")}
          disabled={isReadOnly}
          className="hidden"
        >
          <div />
        </button>

        {classEntries.map((entry, idx) => {
          const name =
            classTranslations[entry.cls?.name as keyof typeof classTranslations] ||
            entry.cls?.name ||
            "";

          return (
            <button
              key={entry.key}
              type="button"
              onClick={() => openEntity("class", idx)}
                className="rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition px-1.5 py-0.5 text-center flex flex-col items-center justify-center h-12"
            >
                  <div className="text-[8px] uppercase tracking-[0.1em] text-slate-400 leading-none">
                {entry.kind === "main" ? "" : ""}
              </div>
                  <div className="text-[12px] font-semibold text-slate-50 truncate leading-tight">{name}</div>
                  <div className="text-[9px] text-slate-300/70 truncate leading-none"> {entry.classLevel}</div>
            </button>
          );
        })}

        {subclassEntries.map((entry, idx) => {
          const clsName =
            classTranslations[entry.cls?.name as keyof typeof classTranslations] ||
            entry.cls?.name ||
            "";
          const scName =
            subclassTranslations[entry.subclass?.name as keyof typeof subclassTranslations] ||
            entry.subclass?.name ||
            "";

          return (
            <button
              key={entry.key}
              type="button"
              onClick={() => openEntity("subclass", idx)}
              className="rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition px-1.5 py-0.5 text-center flex flex-col items-center justify-center h-12"
            >
                <div className="text-[8px] uppercase tracking-[0.1em] text-slate-400 leading-none">
                {entry.kind === "main" ? "" : " ()"}
              </div>
                <div className="text-[12px] font-semibold text-slate-50 truncate leading-tight">{scName}</div>
                <div className="text-[9px] text-slate-300/70 truncate leading-none">{clsName}</div>
            </button>
          );
        })}

        <button
          type="button"
          onClick={() => openEntity("background")}
          className="rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition px-1.5 py-0.5 text-center flex flex-col items-center justify-center h-12"
        >
          <div className="text-[8px] uppercase tracking-[0.1em] text-slate-400 leading-none"></div>
          <div className="text-[12px] font-semibold text-slate-50 truncate leading-tight">{backgroundName}</div>
        </button>
      </div>

      {resourceItems.length > 0 ? (
        <div className="space-y-3">
          <div className="text-[10px] uppercase font-bold tracking-[0.2em] text-cyan-400 px-1">  </div>
          <div className="grid grid-cols-1 gap-2">
            {resourceItems.map((item) => {
                const remaining = getUsesRemaining(item);
                const featureRef = {
                    ...item,
                    displayType: item.displayTypes,
                    usesRemaining: remaining,
                    usesCount: item.usesPer
                };

                return (
                    <ResourceCard
                        key={item.key}
                        feature={featureRef}
                        isPending={isPending}
                        isReadOnly={isReadOnly}
                        onSpend={() => spendOneUse(item)}
                        onRestore={() => restoreOneUse(item)}
                        onInfo={() => setSelected(item)}
                    />
                );
            })}
          </div>
        </div>
      ) : null}

      {!groupedFeatures ? (
        <div className="text-sm text-slate-400">   </div>
      ) : (
        <div className="space-y-2">
          {categories.map((category) => {
            const variant = categoryVariant(category.kind);
            const total = category.items.length;

            return (
              <Collapsible
                key={category.title}
                defaultOpen={total > 0}
                className={
                  "group border-l-2 bg-gradient-to-r to-transparent rounded-r-lg p-3 sm:p-4 transition-all duration-300 " +
                  variant.container
                }
              >
                <CollapsibleTrigger className="flex items-center gap-3 w-full">
                  <ChevronRight className={"w-5 h-5 transition-transform group-data-[state=open]:rotate-90 " + variant.chevron} />
                  <span className={"font-bold uppercase tracking-wider text-xs sm:text-sm " + variant.title}>{category.title}</span>
                  <span className={"ml-auto text-[10px] sm:text-xs " + variant.count}>[{total}]</span>
                </CollapsibleTrigger>

                <CollapsibleContent className="mt-3 sm:mt-4 pl-6 sm:pl-8">
                  {total === 0 ? (
                    <div className="text-xs text-slate-400">   </div>
                  ) : (
                    <ScrollArea className="max-h-[44vh] overflow-y-auto pr-3">
                      <div className="space-y-2">
                        {category.items.map((item) => {
                          const remaining = getUsesRemaining(item);
                          const featureRef = {
                              ...item,
                              displayType: item.displayTypes,
                              usesRemaining: remaining,
                              usesCount: item.usesPer
                          };

                          return (
                            <FeatureCard 
                                key={item.key} 
                                feature={featureRef} 
                                onClick={() => setSelected(item)} 
                                isPending={isPending}
                                isReadOnly={isReadOnly}
                                onSpend={() => spendOneUse(item)}
                                onRestore={() => restoreOneUse(item)}
                            />
                          );
                        })}
                      </div>
                    </ScrollArea>
                  )}
                </CollapsibleContent>
              </Collapsible>
            );
          })}
        </div>
      )}

      <Dialog open={!!selected} onOpenChange={(open) => !open && setSelected(null)}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle className="text-xl font-bold">{selected?.name}</DialogTitle>
            {selected ? (
              <DialogDescription className="text-xs text-slate-300">
                {selected.sourceName}  {translateValue(selected.source)}
              </DialogDescription>
            ) : null}
          </DialogHeader>
          {selected?.description ? (
            <div className="glass-panel rounded-xl border border-slate-800/70 p-4">
              <FormattedDescription content={selected.description} className="text-slate-200/90" />
            </div>
          ) : null}
        </DialogContent>
      </Dialog>

      <ControlledInfoDialog
        open={entityOpen}
        onOpenChange={(open) => setEntityOpen(open)}
        title={entityDialog.title}
        subtitle={entityDialog.subtitle}
      >
        {entityDialog.content}
      </ControlledInfoDialog>
    </div>
  );
}
</file>

<file path="src/lib/components/characterSheet/CharacterCarousel.tsx">
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { PersWithRelations } from "@/lib/actions/pers";
import MainStatsSlide from "./slides/MainStatsSlide";
import SkillsSlide from "./slides/SkillsSlide";
import CombatPage from "./CombatPage";
import MagicSlide from "./slides/MagicSlide";
import FeaturesSlide from "./slides/FeaturesSlide";
import { ChevronLeft, ChevronRight } from "lucide-react";
import { Button } from "@/components/ui/button";
import { CharacterFeaturesGroupedResult } from "@/lib/actions/pers";
import { useMediaQuery } from "@/lib/hooks/useMediaQuery";

interface CharacterCarouselProps {
  pers: PersWithRelations;
  onPersUpdate: (next: PersWithRelations) => void;
  groupedFeatures: CharacterFeaturesGroupedResult | null;
  isReadOnly?: boolean;
}

export default function CharacterCarousel({ pers, onPersUpdate, groupedFeatures, isReadOnly }: CharacterCarouselProps) {
  const isLg = useMediaQuery("(min-width: 1024px)");
  const isMd = useMediaQuery("(min-width: 768px)");

  type SlideId = "stats" | "skills" | "equipment" | "magic" | "features";
  type SlideDef = { id: SlideId; label: string };

  const allSlides: SlideDef[] = useMemo(
    () => [
      { id: "stats", label: "" },
      { id: "skills", label: "" },
      { id: "equipment", label: "" },
      { id: "magic", label: "" },
      { id: "features", label: "" },
    ],
    []
  );

  const totalSlides = allSlides.length;
  const visibleCount = isLg ? 3 : isMd ? 2 : 1;

  const getStartIndex = () => (isLg ? 4 : 0);

  const [currentIndex, setCurrentIndex] = useState(getStartIndex);

  // On breakpoint change, set initial index per spec.
  useEffect(() => {
    setCurrentIndex(getStartIndex());
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isLg, isMd]);

  const swipeStart = useRef<{ x: number; y: number } | null>(null);

  const handlePrevious = () => {
    setCurrentIndex((prev) => (prev - 1 + totalSlides) % totalSlides);
  };

  const handleNext = () => {
    setCurrentIndex((prev) => (prev + 1) % totalSlides);
  };

  const getVisibleSlides = () => {
    const visible: Array<SlideDef & { index: number }> = [];
    for (let i = 0; i < visibleCount; i++) {
      const index = (currentIndex + i) % totalSlides;
      visible.push({ ...allSlides[index], index });
    }
    return visible;
  };

  const visibleSlides = getVisibleSlides();

  const renderSlide = (id: SlideId) => {
    if (id === "stats") return <MainStatsSlide pers={pers} onPersUpdate={onPersUpdate} isReadOnly={isReadOnly} />;
    if (id === "skills") return <SkillsSlide pers={pers} onPersUpdate={onPersUpdate} isReadOnly={isReadOnly} />;
    if (id === "equipment") return <CombatPage pers={pers} onPersUpdate={onPersUpdate} isReadOnly={isReadOnly} />;
    if (id === "magic") return <MagicSlide pers={pers} onPersUpdate={onPersUpdate} isReadOnly={isReadOnly} />;
    if (id === "features") return <FeaturesSlide pers={pers} onPersUpdate={onPersUpdate} groupedFeatures={groupedFeatures} isReadOnly={isReadOnly} />;
    return null;
  };

  const onTouchStart = (e: React.TouchEvent) => {
    const t = e.touches[0];
    if (!t) return;
    swipeStart.current = { x: t.clientX, y: t.clientY };
  };

  const onTouchEnd = (e: React.TouchEvent) => {
    const start = swipeStart.current;
    swipeStart.current = null;
    if (!start) return;

    const t = e.changedTouches[0];
    if (!t) return;

    const dx = t.clientX - start.x;
    const dy = t.clientY - start.y;

    // Horizontal swipe only; keep vertical scroll intact.
    if (Math.abs(dx) < 60) return;
    if (Math.abs(dy) > 40) return;

    if (dx < 0) handleNext();
    else handlePrevious();
  };

  return (
    <div className="h-full flex flex-col overflow-hidden">
      {/* Content */}
      <div className="flex-1 relative overflow-hidden">
        <div
          className="absolute inset-0 px-3 pt-3 pb-2 md:px-4 md:pt-4"
          onTouchStart={onTouchStart}
          onTouchEnd={onTouchEnd}
        >
          <div className="h-full grid gap-3 md:gap-4" style={{ gridTemplateColumns: `repeat(${visibleCount}, 1fr)` }}>
            {visibleSlides.map((slide) => (
              <div
                key={`${slide.id}-${slide.index}`}
                className="h-full bg-slate-900/90 backdrop-blur-sm border border-white/10 rounded-xl shadow-2xl shadow-black/30 overflow-hidden"
              >
                <div className="h-full overflow-y-auto" style={{ scrollBehavior: "smooth" }}>
                  {renderSlide(slide.id)}
                </div>
              </div>
            ))}
          </div>

          {/* Side navigation arrows (all breakpoints) */}
          <Button
            onClick={handlePrevious}
            className="absolute left-2 md:left-6 top-1/2 -translate-y-1/2 bg-slate-900/90 hover:bg-slate-800/95 backdrop-blur-sm border border-white/20 text-white rounded-full w-10 h-10 md:w-12 md:h-12 p-0 shadow-xl z-10"
            size="icon"
            aria-label="Previous slide"
          >
            <ChevronLeft className="w-5 h-5 md:w-6 md:h-6" />
          </Button>
          <Button
            onClick={handleNext}
            className="absolute right-2 md:right-6 top-1/2 -translate-y-1/2 bg-slate-900/90 hover:bg-slate-800/95 backdrop-blur-sm border border-white/20 text-white rounded-full w-10 h-10 md:w-12 md:h-12 p-0 shadow-xl z-10"
            size="icon"
            aria-label="Next slide"
          >
            <ChevronRight className="w-5 h-5 md:w-6 md:h-6" />
          </Button>
        </div>
      </div>

      {/* Bottom navigation (always visible) */}
      <div className="sticky bottom-0 z-20 border-t border-white/10 bg-slate-900/95 backdrop-blur-xl px-2 py-2 shadow-xl shadow-black/30">
        <div className="mx-auto max-w-5xl flex items-center justify-center gap-1">
          {allSlides.map((s, idx) => {
            const active = idx === currentIndex;
            return (
              <button
                key={s.id}
                type="button"
                onClick={() => {
                  setCurrentIndex(idx);
                }}
                className={
                  "px-2 py-1 rounded-md text-[10px] sm:text-xs transition border " +
                  (active
                    ? "bg-indigo-500/20 border-indigo-400/40 text-indigo-100"
                    : "bg-white/5 border-white/10 text-slate-200/80 hover:bg-white/10")
                }
              >
                {s.label}
              </button>
            );
          })}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/lib/components/characterSheet/EntityInfoDialog.tsx">
"use client";

import { ReactNode } from "react";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { FormattedDescription } from "@/components/ui/FormattedDescription";
import { useModalBackButton } from "@/hooks/useModalBackButton";

export type EntityInfoKind = "race" | "class" | "background";

export interface EntityInfoDialogEntity {
  name?: string | null;
  description?: string | null;
  [key: string]: unknown;
}

interface EntityInfoDialogProps {
  isOpen: boolean;
  onClose: () => void;
  kind: EntityInfoKind;
  title: string;
  subtitle?: string;
  entity?: EntityInfoDialogEntity | null;
  children?: ReactNode;
}

export function EntityInfoDialog({
  isOpen,
  onClose,
  kind,
  title,
  subtitle,
  entity,
  children,
}: EntityInfoDialogProps) {
  const description = (entity?.description ?? "").toString().trim();

  useModalBackButton(isOpen, onClose);

  return (
    <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>
      <DialogContent className="max-h-[85vh] w-[95vw] max-w-2xl overflow-y-auto shadow-2xl ring-1 ring-white/20">
        <DialogHeader>
          <DialogTitle className="text-xl font-bold">{title}</DialogTitle>
          <DialogDescription className="text-xs text-slate-300">
            {subtitle ? `${subtitle}  ` : ""}
            {kind.toUpperCase()}
          </DialogDescription>
        </DialogHeader>

        {children ? <div className="space-y-3">{children}</div> : null}

        {description ? (
          <FormattedDescription
            content={description}
            className="text-sm text-slate-200/90 leading-relaxed"
          />
        ) : (
          <div className="text-sm text-slate-400"> </div>
        )}
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="prisma/seed/classEquipmentSeed.ts">
import {
    PrismaClient,
    Prisma,
    WeaponCategory, ArmorCategory, Classes, WeaponType, EquipmentPackCategory
} from "@prisma/client";

export const seedClassEquipment = async (prisma: PrismaClient) => {
    console.log('   ...')
    const equipment: Prisma.ClassStartingEquipmentOptionCreateInput[] = [
        // GROUP 1: Armor choice
        // Option A: Chain mail
        {
            choiceGroup: 1,
            option: 'a',
            armor: { connect: { name: ArmorCategory.CHAIN_MAIL } },
            class: { connect: { name: Classes.FIGHTER_2014 } },
            quantity: 1,
            description: ' (16 )'
        },
        {
            choiceGroup: 1,
            option: 'b',
            armor: { connect: { name: ArmorCategory.LEATHER } },
            class: { connect: { name: Classes.FIGHTER_2014 } },
            quantity: 1,
            description: ' (11 +  )'
        },
        {
            choiceGroup: 1,
            option: 'b',
            weapon: { connect: { name: WeaponCategory.LONGBOW } },
            class: { connect: { name: Classes.FIGHTER_2014 } },
            quantity: 1,
            description: '  (18)'
        },
        {
            choiceGroup: 1,
            option: 'b',
            class: { connect: { name: Classes.FIGHTER_2014 } },
            quantity: 20,
            item: '',
            description: '20 '
        },

        //  2:  
        //  :  
        {
            choiceGroup: 2,
            option: 'a',
            chooseAnyWeapon: true,
            weaponType: WeaponType.MARTIAL_WEAPON,
            weaponCount: 1,
            class: { connect: { name: Classes.FIGHTER_2014 } },
            quantity: 1,
            description: '    '
        },
        //  : 
        {
            choiceGroup: 2,
            option: 'a',
            armor: { connect: { name: ArmorCategory.SHIELD } },
            class: { connect: { name: Classes.FIGHTER_2014 } },
            quantity: 1,
            description: ' (+2  )'
        },
        //  :   
        {
            choiceGroup: 2,
            option: 'b',
            chooseAnyWeapon: true,
            weaponType: WeaponType.MARTIAL_WEAPON,
            weaponCount: 2,
            class: { connect: { name: Classes.FIGHTER_2014 } },
            quantity: 1,
            description: '    '
        },

        //  3:  
        //  :  
        {
            choiceGroup: 3,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.LIGHT_CROSSBOW } },
            class: { connect: { name: Classes.FIGHTER_2014 } },
            quantity: 1,
            description: '  (18)'
        },
        //  : 
        {
            choiceGroup: 3,
            option: 'a',
            class: { connect: { name: Classes.FIGHTER_2014 } },
            quantity: 20,
            item: ' ',
            description: '20 ',
        },
        //  :  
        {
            choiceGroup: 3,
            option: 'b',
            weapon: { connect: { name: WeaponCategory.HANDAXE } },
            class: { connect: { name: Classes.FIGHTER_2014 } },
            quantity: 2,
            description: '   (16), '
        },

        //  4:  
        //  :   
        {
            choiceGroup: 4,
            option: 'a',
            equipmentPack: { connect: { name: EquipmentPackCategory.DUNGEONEERS_PACK } },
            class: { connect: { name: Classes.FIGHTER_2014 } },
            quantity: 1,
            description: '  '
        },
        //  :  
        {
            choiceGroup: 4,
            option: 'b',
            equipmentPack: { connect: { name: EquipmentPackCategory.EXPLORERS_PACK } },
            class: { connect: { name: Classes.FIGHTER_2014 } },
            quantity: 1,
            description: ' '
        },





        // BARBARIAN STARTING EQUIPMENT
//  1:  
//  :  
        {
            choiceGroup: 1,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.GREATAXE } },
            class: { connect: { name: Classes.BARBARIAN_2014 } },
            quantity: 1,
            description: '  (112)'
        },
//  : -   
        {
            choiceGroup: 1,
            option: 'b',
            chooseAnyWeapon: true,
            weaponType: WeaponType.MARTIAL_WEAPON,
            weaponCount: 1,
            class: { connect: { name: Classes.BARBARIAN_2014 } },
            quantity: 1,
            description: '    '
        },

//  2:  
//  :   
        {
            choiceGroup: 2,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.HANDAXE } },
            class: { connect: { name: Classes.BARBARIAN_2014 } },
            quantity: 2,
            description: '   (16), '
        },
//  : -  
        {
            choiceGroup: 2,
            option: 'b',
            chooseAnyWeapon: true,
            weaponType: WeaponType.SIMPLE_WEAPON,
            weaponCount: 1,
            class: { connect: { name: Classes.BARBARIAN_2014 } },
            quantity: 1,
            description: '   '
        },

//  3:   ()
//  
        {
            choiceGroup: 3,
            option: 'a',
            equipmentPack: { connect: { name: EquipmentPackCategory.EXPLORERS_PACK } },
            class: { connect: { name: Classes.BARBARIAN_2014 } },
            quantity: 1,
            description: ' '
        },
        {
            choiceGroup: 3,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.JAVELIN } },
            class: { connect: { name: Classes.BARBARIAN_2014 } },
            quantity: 4,
            description: '4  (16), '
        },


        //   
        //  1:  
        //  :  
        {
            choiceGroup: 1,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.SHORTSWORD } },
            class: { connect: { name: Classes.MONK_2014 } },
            quantity: 1,
            description: '  (16)'
        },
        //  : -  
        {
            choiceGroup: 1,
            option: 'b',
            chooseAnyWeapon: true,
            weaponType: WeaponType.SIMPLE_WEAPON,
            weaponCount: 1,
            class: { connect: { name: Classes.MONK_2014 } },
            quantity: 1,
            description: '   '
        },

        //  2:  
        //  :   
        {
            choiceGroup: 2,
            option: 'a',
            equipmentPack: { connect: { name: EquipmentPackCategory.DUNGEONEERS_PACK } },
            class: { connect: { name: Classes.MONK_2014 } },
            quantity: 1,
            description: '  '
        },
        //  :  
        {
            choiceGroup: 2,
            option: 'b',
            equipmentPack: { connect: { name: EquipmentPackCategory.EXPLORERS_PACK } },
            class: { connect: { name: Classes.MONK_2014 } },
            quantity: 1,
            description: ' '
        },

        //  3:  
        // 10  ()
        {
            choiceGroup: 3,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.DART } },
            class: { connect: { name: Classes.MONK_2014 } },
            quantity: 10,
            description: '10  (14), '
        },




        // ===== RANGER STARTING EQUIPMENT =====

//  1: 
//  :  
        {
            choiceGroup: 1,
            option: 'a',
            armor: { connect: { name: ArmorCategory.SCALE_MAIL } },
            class: { connect: { name: Classes.RANGER_2014 } },
            quantity: 1,
            description: '  (14 +  [ 2] )'
        },
//  :  
        {
            choiceGroup: 1,
            option: 'b',
            armor: { connect: { name: ArmorCategory.LEATHER } },
            class: { connect: { name: Classes.RANGER_2014 } },
            quantity: 1,
            description: '  (11 +  )'
        },

//  2:  
//  :   
        {
            choiceGroup: 2,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.SHORTSWORD } },
            class: { connect: { name: Classes.RANGER_2014 } },
            quantity: 2,
            description: '   (16)'
        },
//  :    
        {
            choiceGroup: 2,
            option: 'b',
            chooseAnyWeapon: true,
            weaponType: WeaponType.SIMPLE_WEAPON,
            weaponCount: 2,
            class: { connect: { name: Classes.RANGER_2014 } },
            quantity: 1,
            description: '     '
        },

//  3:  
//  :   
        {
            choiceGroup: 3,
            option: 'a',
            equipmentPack: { connect: { name: EquipmentPackCategory.DUNGEONEERS_PACK } },
            class: { connect: { name: Classes.RANGER_2014 } },
            quantity: 1,
            description: '  '
        },
//  :  
        {
            choiceGroup: 3,
            option: 'b',
            equipmentPack: { connect: { name: EquipmentPackCategory.EXPLORERS_PACK } },
            class: { connect: { name: Classes.RANGER_2014 } },
            quantity: 1,
            description: ' '
        },

//  4:   ()
//  
        {
            choiceGroup: 4,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.LONGBOW } },
            class: { connect: { name: Classes.RANGER_2014 } },
            quantity: 1,
            description: '  (18)'
        },
//   20 
        {
            choiceGroup: 4,
            option: 'a',
            class: { connect: { name: Classes.RANGER_2014 } },
            quantity: 20,
            item: '',
            description: '  20 '
        },



        //  seedClassStartingEquipment :

// ===== PALADIN STARTING EQUIPMENT =====

//  1:  
//  :   + 
        {
            choiceGroup: 1,
            option: 'a',
            chooseAnyWeapon: true,
            weaponType: WeaponType.MARTIAL_WEAPON,
            weaponCount: 1,
            class: { connect: { name: Classes.PALADIN_2014 } },
            quantity: 1,
            description: '   '
        },
        {
            choiceGroup: 1,
            option: 'a',
            armor: { connect: { name: ArmorCategory.SHIELD } },
            class: { connect: { name: Classes.PALADIN_2014 } },
            quantity: 1,
            description: ' (+2 )'
        },
//  :   
        {
            choiceGroup: 1,
            option: 'b',
            chooseAnyWeapon: true,
            weaponType: WeaponType.MARTIAL_WEAPON,
            weaponCount: 2,
            class: { connect: { name: Classes.PALADIN_2014 } },
            quantity: 1,
            description: '    '
        },

//  2: / 
//  : 5 
        {
            choiceGroup: 2,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.JAVELIN } },
            class: { connect: { name: Classes.PALADIN_2014 } },
            quantity: 5,
            description: '5  (16)'
        },
//  : -   
        {
            choiceGroup: 2,
            option: 'b',
            chooseAnyWeapon: true,
            weaponType: WeaponType.SIMPLE_WEAPON,
            weaponCount: 1,
            class: { connect: { name: Classes.PALADIN_2014 } },
            quantity: 1,
            description: '    '
        },

//  3:  
//  :  
        {
            choiceGroup: 3,
            option: 'a',
            equipmentPack: { connect: { name: EquipmentPackCategory.PRIESTS_PACK } },
            class: { connect: { name: Classes.PALADIN_2014 } },
            quantity: 1,
            description: ' '
        },
//  :  
        {
            choiceGroup: 3,
            option: 'b',
            equipmentPack: { connect: { name: EquipmentPackCategory.EXPLORERS_PACK } },
            class: { connect: { name: Classes.PALADIN_2014 } },
            quantity: 1,
            description: ' '
        },

//  4:   ()
//  
        {
            choiceGroup: 4,
            option: 'a',
            armor: { connect: { name: ArmorCategory.CHAIN_MAIL } },
            class: { connect: { name: Classes.PALADIN_2014 } },
            quantity: 1,
            description: ' (16 )'
        },
//  
        {
            choiceGroup: 4,
            option: 'a',
            class: { connect: { name: Classes.PALADIN_2014 } },
            quantity: 1,
            item: ' ',
            description: '  ( )'
        },




// ===== ROGUE STARTING EQUIPMENT =====

//  1:  
//  : 
        {
            choiceGroup: 1,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.RAPIER } },
            class: { connect: { name: Classes.ROGUE_2014 } },
            quantity: 1,
            description: ' (18, )'
        },
//  :  
        {
            choiceGroup: 1,
            option: 'b',
            weapon: { connect: { name: WeaponCategory.SHORTSWORD } },
            class: { connect: { name: Classes.ROGUE_2014 } },
            quantity: 1,
            description: '  (16, , )'
        },

//  2: / 
//  :   + 20 
        {
            choiceGroup: 2,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.SHORTBOW } },
            class: { connect: { name: Classes.ROGUE_2014 } },
            quantity: 1,
            description: '  (16)'
        },
        {
            choiceGroup: 2,
            option: 'a',
            class: { connect: { name: Classes.ROGUE_2014 } },
            quantity: 20,
            item: '',
            description: '  20 '
        },
//  :  
        {
            choiceGroup: 2,
            option: 'b',
            weapon: { connect: { name: WeaponCategory.SHORTSWORD } },
            class: { connect: { name: Classes.ROGUE_2014 } },
            quantity: 1,
            description: '  (16, , )'
        },

//  3:   (3 !)
//  :  
        {
            choiceGroup: 3,
            option: 'a',
            equipmentPack: { connect: { name: EquipmentPackCategory.BURGLARS_PACK } },
            class: { connect: { name: Classes.ROGUE_2014 } },
            quantity: 1,
            description: ' '
        },
//  :   
        {
            choiceGroup: 3,
            option: 'b',
            equipmentPack: { connect: { name: EquipmentPackCategory.DUNGEONEERS_PACK } },
            class: { connect: { name: Classes.ROGUE_2014 } },
            quantity: 1,
            description: '  '
        },
//  :  
        {
            choiceGroup: 3,
            option: 'c',
            equipmentPack: { connect: { name: EquipmentPackCategory.EXPLORERS_PACK } },
            class: { connect: { name: Classes.ROGUE_2014 } },
            quantity: 1,
            description: ' '
        },

//  4:   ()
//  
        {
            choiceGroup: 4,
            option: 'a',
            armor: { connect: { name: ArmorCategory.LEATHER } },
            class: { connect: { name: Classes.ROGUE_2014 } },
            quantity: 1,
            description: '  (11 +  )'
        },
//  
        {
            choiceGroup: 4,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.DAGGER } },
            class: { connect: { name: Classes.ROGUE_2014 } },
            quantity: 2,
            description: '  (14, , , )'
        },
//  
        {
            choiceGroup: 4,
            option: 'a',
            class: { connect: { name: Classes.ROGUE_2014 } },
            quantity: 1,
            item: ' ',
            description: ' '
        },




        // ===== WARLOCK STARTING EQUIPMENT =====

//  1:  
//  :   + 20 
        {
            choiceGroup: 1,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.LIGHT_CROSSBOW } },
            class: { connect: { name: Classes.WARLOCK_2014 } },
            quantity: 1,
            description: '  (18)'
        },
        {
            choiceGroup: 1,
            option: 'a',
            class: { connect: { name: Classes.WARLOCK_2014 } },
            quantity: 20,
            item: '',
            description: '20   '
        },
//  : -  
        {
            choiceGroup: 1,
            option: 'b',
            chooseAnyWeapon: true,
            weaponType: WeaponType.SIMPLE_WEAPON,
            weaponCount: 1,
            class: { connect: { name: Classes.WARLOCK_2014 } },
            quantity: 1,
            description: '-    '
        },

//  2:  
//  :  
        {
            choiceGroup: 2,
            option: 'a',
            class: { connect: { name: Classes.WARLOCK_2014 } },
            quantity: 1,
            item: ' ',
            description: '  (component pouch)'
        },
//  :  
        {
            choiceGroup: 2,
            option: 'b',
            class: { connect: { name: Classes.WARLOCK_2014 } },
            quantity: 1,
            item: '  (arcane focus)',
            description: '  (arcane focus)'
        },

//  3:  
//  :  
        {
            choiceGroup: 3,
            option: 'a',
            equipmentPack: { connect: { name: EquipmentPackCategory.SCHOLARS_PACK } },
            class: { connect: { name: Classes.WARLOCK_2014 } },
            quantity: 1,
            description: ' '
        },
//  :   
        {
            choiceGroup: 3,
            option: 'b',
            equipmentPack: { connect: { name: EquipmentPackCategory.DUNGEONEERS_PACK } },
            class: { connect: { name: Classes.WARLOCK_2014 } },
            quantity: 1,
            description: '  '
        },

//  4:   ()
//  
        {
            choiceGroup: 4,
            option: 'a',
            armor: { connect: { name: ArmorCategory.LEATHER } },
            class: { connect: { name: Classes.WARLOCK_2014 } },
            quantity: 1,
            description: '  (11 +  )'
        },
// -   ()
        {
            choiceGroup: 4,
            option: 'a',
            chooseAnyWeapon: true,
            weaponType: WeaponType.SIMPLE_WEAPON,
            weaponCount: 1,
            class: { connect: { name: Classes.WARLOCK_2014 } },
            quantity: 1,
            description: '-  '
        },
//  
        {
            choiceGroup: 4,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.DAGGER } },
            class: { connect: { name: Classes.WARLOCK_2014 } },
            quantity: 2,
            description: '  (14)'
        },


// ===== ARTIFICER () STARTING EQUIPMENT =====

        //  1:   
        {
            choiceGroup: 1,
            option: 'a',
            chooseAnyWeapon: true,
            weaponType: WeaponType.SIMPLE_WEAPON,
            weaponCount: 2,
            class: { connect: { name: Classes.ARTIFICER_2014 } },
            quantity: 1,
            description: '-     '
        },

        //  2:    20   -  
        {
            choiceGroup: 2,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.LIGHT_CROSSBOW } },
            class: { connect: { name: Classes.ARTIFICER_2014 } },
            quantity: 1,
            description: '  (18)'
        },
        {
            choiceGroup: 2,
            option: 'a',
            class: { connect: { name: Classes.ARTIFICER_2014 } },
            quantity: 20,
            item: '',
            description: '20 '
        },
        {
            choiceGroup: 2,
            option: 'b',
            chooseAnyWeapon: true,
            weaponType: WeaponType.SIMPLE_WEAPON,
            weaponCount: 1,
            class: { connect: { name: Classes.ARTIFICER_2014 } },
            quantity: 1,
            description: '-    '
        },

        //  3:      
        {
            choiceGroup: 3,
            option: 'a',
            armor: { connect: { name: ArmorCategory.STUDDED_LEATHER } },
            class: { connect: { name: Classes.ARTIFICER_2014 } },
            quantity: 1,
            description: '   (12 +  )'
        },
        {
            choiceGroup: 3,
            option: 'b',
            armor: { connect: { name: ArmorCategory.SCALE_MAIL } },
            class: { connect: { name: Classes.ARTIFICER_2014 } },
            quantity: 1,
            description: '  (14 +  [ 2] )'
        },

        //  4:         
        {
            choiceGroup: 4,
            option: 'a',
            equipmentPack: { connect: { name: EquipmentPackCategory.DUNGEONEERS_PACK } },
            class: { connect: { name: Classes.ARTIFICER_2014 } },
            quantity: 1,
            description: '  '
        },
        {
            choiceGroup: 4,
            option: 'a',
            class: { connect: { name: Classes.ARTIFICER_2014 } },
            quantity: 1,
            item: ' ',
            description: ' '
        },


        // ===== SORCERER STARTING EQUIPMENT =====
        //  1:  
        {
            choiceGroup: 1,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.LIGHT_CROSSBOW } },
            class: { connect: { name: Classes.SORCERER_2014 } },
            quantity: 1,
            description: '  (18)'
        },
        {
            choiceGroup: 1,
            option: 'a',
            class: { connect: { name: Classes.SORCERER_2014 } },
            quantity: 20,
            item: ' ',
            description: '20  '
        },
        {
            choiceGroup: 1,
            option: 'b',
            chooseAnyWeapon: true,
            weaponType: WeaponType.SIMPLE_WEAPON,
            weaponCount: 1,
            class: { connect: { name: Classes.SORCERER_2014 } },
            quantity: 1,
            description: '    '
        },

        //  2:   
        {
            choiceGroup: 2,
            option: 'a',
            equipmentPack: { connect: { name: EquipmentPackCategory.COMPONENT_POUCH } },
            class: { connect: { name: Classes.SORCERER_2014 } },
            quantity: 1,
            description: '  '
        },
        {
            choiceGroup: 2,
            option: 'b',
            class: { connect: { name: Classes.SORCERER_2014 } },
            quantity: 1,
            item: ' ',
            description: '   '
        },

        //  3:  
        {
            choiceGroup: 3,
            option: 'a',
            equipmentPack: { connect: { name: EquipmentPackCategory.DUNGEONEERS_PACK } },
            class: { connect: { name: Classes.SORCERER_2014 } },
            quantity: 1,
            description: '  '
        },
        {
            choiceGroup: 3,
            option: 'b',
            equipmentPack: { connect: { name: EquipmentPackCategory.EXPLORERS_PACK } },
            class: { connect: { name: Classes.SORCERER_2014 } },
            quantity: 1,
            description: ' '
        },

        //  4:  
        {
            choiceGroup: 4,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.DAGGER } },
            class: { connect: { name: Classes.SORCERER_2014 } },
            quantity: 2,
            description: ' '
        },

        // ===== WIZARD STARTING EQUIPMENT =====
        //  1: 
        {
            choiceGroup: 1,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.QUARTERSTAFF } },
            class: { connect: { name: Classes.WIZARD_2014 } },
            quantity: 1,
            description: '  (16/18)'
        },
        {
            choiceGroup: 1,
            option: 'b',
            weapon: { connect: { name: WeaponCategory.DAGGER } },
            class: { connect: { name: Classes.WIZARD_2014 } },
            quantity: 1,
            description: ' (14)'
        },

        //  2:   
        {
            choiceGroup: 2,
            option: 'a',
            equipmentPack: { connect: { name: EquipmentPackCategory.COMPONENT_POUCH } },
            class: { connect: { name: Classes.WIZARD_2014 } },
            quantity: 1,
            description: '  '
        },
        {
            choiceGroup: 2,
            option: 'b',
            class: { connect: { name: Classes.WIZARD_2014 } },
            quantity: 1,
            item: ' ',
            description: '   '
        },

        //  3:  
        {
            choiceGroup: 3,
            option: 'a',
            equipmentPack: { connect: { name: EquipmentPackCategory.SCHOLARS_PACK } },
            class: { connect: { name: Classes.WIZARD_2014 } },
            quantity: 1,
            description: ' '
        },
        {
            choiceGroup: 3,
            option: 'b',
            equipmentPack: { connect: { name: EquipmentPackCategory.EXPLORERS_PACK } },
            class: { connect: { name: Classes.WIZARD_2014 } },
            quantity: 1,
            description: ' '
        },

        //  4:  
        {
            choiceGroup: 4,
            option: 'a',
            equipmentPack: { connect: { name: EquipmentPackCategory.SPELLBOOK } },
            class: { connect: { name: Classes.WIZARD_2014 } },
            quantity: 1,
            description: '  '
        },
        {
            choiceGroup: 4,
            option: 'a',
            weapon: { connect: { name: WeaponCategory.DAGGER } },
            class: { connect: { name: Classes.WIZARD_2014 } },
            quantity: 1,
            description: ' (14)'
        }
    ];

    let seedIndex = 1;

    for (const piece of equipment) {
        await prisma.classStartingEquipmentOption.upsert({
            where: { seedIndex },
            update: piece,
            create: {
                seedIndex,
                ...piece
            }
        })

        seedIndex++;
    }

    console.log(`  ${equipment.length}  !`)
}
</file>

<file path="prisma/seed/classFeatureSeed.ts">
import { Ability, FeatureDisplayType, Prisma, PrismaClient, RestType, Skills } from "@prisma/client";
import { normalizeFeatureCreateInput, type SeedFeatureCreateInput } from "./helpers/featureDisplayType";

export const seedClassFeatures = async ( prisma: PrismaClient ) => {
    console.log( '   ...' )
    const features: SeedFeatureCreateInput[] = [
        {
            name: '  ',
            engName: 'Archery',
            description: '   +2   ,      .',
            shortDescription: '+2     ',
            displayType: [FeatureDisplayType.PASSIVE],

            bonusToRangedAttackRoll: 2,
        },
        {
            name: ' ',
            engName: 'Blind Fighting',
            description: '     10 .        ,      ,        .  ,        ,        .',
            shortDescription: ' 10 ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '',
            engName: 'Defense',
            description: '   ,    +1  .',
            shortDescription: '+1     ',
            displayType: [FeatureDisplayType.PASSIVE],

            givesAC: 1,
            requiresArmorForACBonus: true,
        },
        {
            name: '',
            engName: 'Dueling',
            description: '            ,    +2     .',
            shortDescription: '+2    ',
            displayType: [FeatureDisplayType.PASSIVE],

            bonusToMeleeOneHandedWeaponDamage: 2,

        },
        {
            name: '  ',
            engName: 'Great Weapon Fighting',
            description: '   1  2       ,     ,          ,     1  2.       ,      .',
            shortDescription: ' 1-2     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '',
            engName: 'Interception',
            description: ' ,   ,    ( )   5    ,     ,   ,   ,  110 +    (  0 ).         ,    .',
            shortDescription: '    110 + ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '',
            engName: 'Protection',
            description: ' ,   ,    ,     5   ,     ,      .    .',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Superior Technique',
            description: '        ,     .  ,   ,      ,    ,   8 +    +      (  ).     ,   6 (    -  ,      ).       .   ,    .      ,      .',
            shortDescription: ' 1    6 ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1,

            givesManeuvres: true,
            superiorityDiceCount: 1,
        },
        {
            name: '  ',
            engName: 'Thrown Weapon Fighting',
            description: '         ,     .  ,        ,    +2   .',
            shortDescription: '+2    ',
            displayType: [FeatureDisplayType.PASSIVE],

            bonusToThrownDamage: 2,
        },
        {
            name: '  ',
            engName: 'Two-Weapon Fighting',
            description: '       ,          .',
            shortDescription: '      ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Unarmed Fighting',
            description: '      ,   16 +     .        ,    , 6  8.         14    ,  .',
            shortDescription: '16 (18)   ',
            displayType: [FeatureDisplayType.PASSIVE],

            modifiesUnarmed: true,
            unarmedDamage: '16 / 18',
        },
        {
            name: ' ',
            engName: 'Druidic Warrior',
            description: '          .      ,         . ,       ,             .',
            shortDescription: '2  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Blessed Warrior',
            description: '          .      ,        . ,       ,             .',
            shortDescription: '2  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // fighter
        {
            name: ' ',
            engName: 'Second Wind',
            description: '    ,   ,     .        ,   -,   110 +   .  ,     ,       ,      .',
            shortDescription: ' 110 +   ',
            displayType: [FeatureDisplayType.BONUSACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1,
        },
        {
            name: ' ',
            engName: 'Action Surge',
            description: '  2 ,          .         .  ,     ,       ,      .   17 ,       ,        .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.FREE],
            limitedUsesPer: RestType.SHORT_REST,
            usesCountSpecial: [
                {
                    lvl: 2,
                    uses: 1,
                },
                {
                    lvl: 17,
                    uses: 2,
                },
            ],
        },
        {
            name: '',
            engName: 'Indomitable',
            description: '  9 ,    ,   .    ,     ,        ,     .         ,   13 ,     ,   17 .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.FREE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountSpecial: [
                {
                    lvl: 9,
                    uses: 1,
                },
                {
                    lvl: 13,
                    uses: 2,
                },
                {
                    lvl: 17,
                    uses: 3,
                }
            ],
        },

        // BARBARIAN
        {
            name: '',
            engName: 'Rage',
            description: '   \'   .          .   ,    ,      :         ;      ,  ,      ,      ;     ,    .    1 .   ,    ,     ,                 .           .       ,    ,   . \n\n    Rage:\n' +
                '1-8 : +2 \n' +
                '\n' +
                '9-15 : +3 \n' +
                '\n' +
                '16-20 : +4  \n\n     :\n' +
                '1-2 : 2 \n' +
                '\n' +
                '3-5 : 3 \n' +
                '\n' +
                '6-11 : 4 \n' +
                '\n' +
                '12-16 : 5 \n' +
                '\n' +
                '17-19 : 6 \n' +
                '\n' +
                '20 : !',
            shortDescription: '   ,   , ',
            displayType: [FeatureDisplayType.BONUSACTION, FeatureDisplayType.CLASS_RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountSpecial: [
                {
                    lvl: 1,
                    uses: 2,
                },
                {
                    lvl: 3,
                    uses: 3,
                },
                {
                    lvl: 6,
                    uses: 4,
                },
                {
                    lvl: 12,
                    uses: 5,
                },
                {
                    lvl: 17,
                    uses: 6,
                },
                {
                    lvl: 20,
                    uses: 'UNLIMITED', // Unlimited  20  
                }
            ],
        },
        {
            name: '  ',
            engName: 'Unarmored Defense',
            description: '     ,     10 +    +   .          .',
            shortDescription: ' = 10 +  +   ',
            displayType: [FeatureDisplayType.PASSIVE],
            modifiesAC: {
                base: 10,
                bonus: {
                    stats: ['DEX', 'CON']
                },
                prerequisites: ['UNARMORED']
            }
        },
        {
            name: ' ',
            engName: 'Reckless Attack',
            description: '  2 ,       ,     .         ,     .         ,   ,   ,           .',
            shortDescription: '  ,     ',
            displayType: [FeatureDisplayType.FREE],
        },
        {
            name: ' ',
            engName: 'Danger Sense',
            description: ' 2      ,     ,   ,   ,     .        ,    ,     .    ,     ,   .',
            shortDescription: '      ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Primal Knowledge',
            description: '   3     10 ,           ,    1 .',
            shortDescription: ' 1   ',
            displayType: [FeatureDisplayType.PASSIVE],
            skillProficiencies: {
                options: [Skills.ANIMAL_HANDLING, Skills.ATHLETICS, Skills.INTIMIDATION, Skills.NATURE, Skills.PERCEPTION, Skills.SURVIVAL],
                choiceCount: 1
            },
        },
        {
            name: ' ',
            engName: 'Barbarian Extra Attack',
            description: '  5 ,       ,        .',
            shortDescription: '2   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Fast Movement',
            description: '  5 ,     10 ,      .',
            shortDescription: '+10     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Instinctive Pounce',
            description: ' 7 ,    ,   ,    ,         .',
            shortDescription: '       ',
            displayType: [FeatureDisplayType.BONUSACTION],
        },
        {
            name: ' ',
            engName: 'Feral Instinct',
            description: ' 7     ,       . \n\n  ,           ,        ,         ,       .',
            shortDescription: '  ,    ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Brutal Critical',
            description: '  9 ,                 .        13       17 .',
            shortDescription: '+1      (+2  13 , +3  17)',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Relentless Rage',
            description: '  11 ,       ,    .     0 -       ,        10.    ,    1 -  .  ,        ,    5.       ,    10.',
            shortDescription: ' ,    1   0',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Persistent Rage',
            description: '  15 ,    ,    ,           .',
            shortDescription: '  ,   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Indomitable Might',
            description: '  18 ,            ,        .',
            shortDescription: '    =  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Primal Champion',
            description: ' 20      .        4.        24.',
            shortDescription: '+4    ,  24',
            displayType: [FeatureDisplayType.PASSIVE],
            givesSTR: 4,
            givesCON: 4,
        },


        // MONKKKKKKKKKKKKKKKKKKKKKK


        // 1 
        {
            name: '  ',
            engName: 'Unarmored Defense (Monk)',
            description: '         ,     10 +    +   .',
            shortDescription: ' = 10 +  +     ',
            displayType: [FeatureDisplayType.PASSIVE],
            modifiesAC: {
                base: 10,
                bonus: {
                    stats: ['DEX', 'WIS']
                },
                prerequisites: ['UNARMORED', 'NO_SHIELD']
            }
        },
        {
            name: ' ',
            engName: 'Martial Arts',
            description: ' 1           ,        -     -   ,       .\n\n   ,              :\n\n                 .\n\n    ,    ,         .      :\n1-4 : 14\n5-10 : 16\n11-16 : 18\n17-20 : 110\n\n             ,        . ,         ,        ,          .',
            shortDescription: ' ,   ,  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 2 
        {
            name: '',
            engName: 'Ki',
            description: '  2 ,        .         .      ,    (   ).\n\n         .  ,    :  ,     .         .\n\n    ,  ,        ,        .     30    ,    .\n\n   ,    .    :\n\n**   = 8 +   () +  **\n\n** .**   ,        ,    1  ,       .\n\n** .**    1  ,         .\n\n** .**    1  ,           ,        .',
            shortDescription: '  =  .  ,  ,  ',
            displayType: [FeatureDisplayType.CLASS_RESOURCE, FeatureDisplayType.BONUSACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCountDependsOnProficiencyBonus: false,
            usesCountSpecial: [
                { lvl: 2, uses: 2 },
                { lvl: 3, uses: 3 },
                { lvl: 4, uses: 4 },
                { lvl: 5, uses: 5 },
                { lvl: 6, uses: 6 },
                { lvl: 7, uses: 7 },
                { lvl: 8, uses: 8 },
                { lvl: 9, uses: 9 },
                { lvl: 10, uses: 10 },
                { lvl: 11, uses: 11 },
                { lvl: 12, uses: 12 },
                { lvl: 13, uses: 13 },
                { lvl: 14, uses: 14 },
                { lvl: 15, uses: 15 },
                { lvl: 16, uses: 16 },
                { lvl: 17, uses: 17 },
                { lvl: 18, uses: 18 },
                { lvl: 19, uses: 19 },
                { lvl: 20, uses: 20 },
            ]
        },
        {
            name: '  ',
            engName: 'Unarmored Movement',
            description: '  2 ,     10 ,       .   ,      :\n\n2-5 : +10 \n6-9 : +15 \n10-13 : +20 \n14-17 : +25 \n18-20 : +30 ',
            shortDescription: '+10     (  )',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Dedicated Weapon',
            description: '  2        ,         . ,       ,     ,     ,         ,       .\n\n     :\n      .\n    .\n        .',
            shortDescription: '   1  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 3 
        {
            name: ' ',
            engName: 'Deflect Missiles',
            description: '  3 ,     ,     ,      .    , ,     ,   110 +    +   .\n\n     0,    ,    ,       ,       .      ,    1  ,     ( 20/60 )   ,    ,     .      ,      ,        .',
            shortDescription: '      110++',
            displayType: [FeatureDisplayType.REACTION],
        },
        {
            name: ',  ',
            engName: 'Ki-Fueled Attack',
            description: '  3 ,    1           ,                (  \'   ,    )',
            shortDescription: '       ',
            displayType: [FeatureDisplayType.BONUSACTION],
        },

        // 4 
        {
            name: ' ',
            engName: 'Slow Fall',
            description: '  4 ,     ,  ,   -   ,   ,  ,   \'     .',
            shortDescription: '     5   ',
            displayType: [FeatureDisplayType.REACTION],
        },
        {
            name: ' ',
            engName: 'Quickened Healing',
            description: ' 4      2       .    -,         ().',
            shortDescription: '2     =    + ',
            displayType: [FeatureDisplayType.ACTION],
        },

        // 5 
        {
            name: ' ',
            engName: 'Extra Attack (Monk)',
            description: '  5 ,       ,        .',
            shortDescription: '2   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Stunning Strike',
            description: '  5 ,         .        ,    1  ,    .             .',
            shortDescription: '1  :      ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Focused Aim',
            description: '  5 ,     ,     1  3  ,       2      ,   ,     .',
            shortDescription: '1-3   +2      ( )',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 6 
        {
            name: ',  ',
            engName: 'Ki-Empowered Strikes',
            description: '  6 ,               .',
            shortDescription: '   .',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 7 
        {
            name: '',
            engName: 'Evasion (Monk)',
            description: ' 7            ,         .     ,     ,     ,       ,   ,    ,  .',
            shortDescription: ' :  = 0 ,  =   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Stillness of Mind',
            description: '  7 ,     ,      ,     .',
            shortDescription: '       ',
            displayType: [FeatureDisplayType.ACTION],
        },

        // 9 
        {
            name: '  ()',
            engName: 'Unarmored Movement (Vertical)',
            description: ' 9              ,     .',
            shortDescription: '      ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 10 
        {
            name: ' ',
            engName: 'Purity of Body',
            description: ' 10    ,    ,       .',
            shortDescription: '    ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 13 
        {
            name: '   ',
            engName: 'Tongue of the Sun and Moon',
            description: '  13 ,      ,     .  , - ,    ,  ,   .',
            shortDescription: '  ,   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 14 
        {
            name: ' ',
            engName: 'Diamond Soul',
            description: '  14 ,        .\n\n , ,       ,    1  ,       .',
            shortDescription: '   , 1  =   ',
            displayType: [FeatureDisplayType.PASSIVE],
            savingThrows: [Ability.STR, Ability.DEX, Ability.CON, Ability.INT, Ability.WIS, Ability.CHA]
        },

        // 15 
        {
            name: ' ',
            engName: 'Timeless Body',
            description: ' 15      ,        ,     .        .  ,       .',
            shortDescription: ' ,   /',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 18 
        {
            name: ' ',
            engName: 'Empty Body',
            description: '  18 ,     ,   4       1 .          ,    .\n\n ,    8  ,      [Astral Projection]      .    ,         .',
            shortDescription: '4  =  +   ; 8  =  ',
            displayType: [FeatureDisplayType.ACTION],
            givesSpells: {
                connect: { engName: 'Astral Projection' },
            }
        },

        // 20 
        {
            name: ' ',
            engName: 'Perfect Self',
            description: ' 20 ,            ,   4  .',
            shortDescription: ' 0       4 ',
            displayType: [FeatureDisplayType.PASSIVE],
        },


        // ===== RANGER FEATURES =====

        // 1 
        {
            name: ' ',
            engName: 'Favored Enemy',
            description: '  1 ,      , ,        .\n\n   : , , , , , , , , , , ,   . ,       (,   )   .\n\n      (),     ,     ,     .\n\n    ,        ,     ,    .\n\n     ,    ,  6  14 .',
            shortDescription: '         ',
            displayType: [FeatureDisplayType.PASSIVE],
            languagesToChooseCount: 1,
        },
        {
            name: ' ',
            engName: 'Natural Explorer',
            description: ' 1                 .     : , , , , , ,   .\n\n      , \'    ,    ,    ,  \n\n          ,    :\n\n       .\n     ,    .\n          (,  ,   ),     .\n    ,       .\n    ,     ,  .\n           ,         .\n\n       6  10 .',
            shortDescription: '        +     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ()',
            engName: 'Spellcasting (Ranger)',
            description: ' 2          ,      .\n\n** :**   ,           1   .      ,       .      ,    .\n\n** :**     1        .      ,         .\n\n** :**        .\n\n**   = 8 +   () +  **\n\n**   =  +  **',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 3 
        {
            name: ' ',
            engName: 'Primeval Awareness',
            description: '  3 ,           ,        .  1 ,      ,   ,        1    (    6 ,       ): , , , , ,   .         .',
            shortDescription: '          1 ',
            displayType: [FeatureDisplayType.ACTION],
        },

        // 5 
        {
            name: ' ',
            engName: 'Extra Attack (Ranger)',
            description: '  5 ,       ,        .',
            shortDescription: '2   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 8 
        {
            name: ' ',
            engName: 'Land\'s Stride',
            description: '  8 ,          .       ,         ,    ,    .\n\n ,       ,     ,   ,  ,    <a href="/spell/1325"> [Entangle]</a>.',
            shortDescription: '       ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 10 
        {
            name: '  ',
            engName: 'Hide in Plain Sight',
            description: '  10 ,    1      .       , , ,     ,    .\n\n    ,    ,    ,     ,       ,  .    +10    (),       .         ,    ,    .',
            shortDescription: '+10      ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 14 
        {
            name: '',
            engName: 'Vanish',
            description: '  14 ,          .  ,      ,       .',
            shortDescription: '  ,    ',
            displayType: [FeatureDisplayType.BONUSACTION, FeatureDisplayType.PASSIVE],
        },

        // 18 
        {
            name: ' ',
            engName: 'Feral Senses',
            description: ' 18     ,      ,    .    ,   ,             .\n\n    -     30   ,  ,      ,       ( ).',
            shortDescription: '   ,    30 ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 20 
        {
            name: ' ',
            engName: 'Foe Slayer',
            description: ' 20        .                   ,         .          ,   ,    -  .',
            shortDescription: '   +       ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // Favored Foe (Optional)
        {
            name: ' ',
            engName: 'Favored Foe',
            description: '  1           .              ,   .\n\n     ,      \'  ,         1     ,      (     ).\n\n     ,          ,   ,    ,      14.\n\n    ,      ,     ,      ,    .\n\n    ,        :  16  6    18  14 .',
            shortDescription: ' , +14     (  16/18)',
            displayType: [FeatureDisplayType.PASSIVE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,
        },

        // Deft Explorer - Canny
        {
            name: '  - ',
            engName: 'Deft Explorer - Canny',
            description: '  1     .       .\n\n -        ,         .\n\n    .      -  ,   ,   .\n\n   ,    2     .',
            shortDescription: '     + 2 ',
            displayType: [FeatureDisplayType.PASSIVE],
            languagesToChooseCount: 2,
            skillExpertises: {
                chooseFromCurrentProficiencies: true,

            }
        },

        // Deft Explorer - Roving
        {
            name: '  - ',
            engName: 'Deft Explorer - Roving',
            description: ' 6       5,        ,     .',
            shortDescription: '+5  ,    ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // Deft Explorer - Tireless
        {
            name: '  - ',
            engName: 'Deft Explorer - Tireless',
            description: ' 10         -,   18 +    ( 1  -).       ,     ,      ,    .\n\n , ,     ,   ,   ,   1.',
            shortDescription: '18 +    ,  ',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,
        },

        // Primal Awareness (Optional)
        {
            name: ' ',
            engName: 'Primal Awareness',
            description: '  3     .       .\n\n      \' :    ,       ,      ,       .        ,   .\n\n**  :**\n3 : Speak with Animals\n5 : Beast Sense\n9 : Speak with Plants\n13 : Locate Creature\n17 : Commune with Nature\n\n        ,    .       ,      ,     .',
            shortDescription: ' 5  ,  1    ',
            displayType: [FeatureDisplayType.PASSIVE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Speak with Animals' },
                    { engName: 'Beast Sense' },
                    { engName: 'Speak with Plants' },
                    { engName: 'Locate Creature' },
                    { engName: 'Commune with Nature' },
                ]
            }
        },

        // Spellcasting Focus (Optional)
        {
            name: '  ()',
            engName: 'Spellcasting Focus (Ranger)',
            description: ' 2              .        ,         , ,     ,  ,   \', ,      .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // Nature's Veil (Optional)
        {
            name: ' ',
            engName: 'Nature\'s Veil',
            description: '  10      .       .\n\n   ,        .          - ,     ,     .\n\n      ,     ,      ,    .',
            shortDescription: '      ',
            displayType: [FeatureDisplayType.BONUSACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,
        },


        // ===== PALADIN FEATURES =====

        // 1 
        {
            name: ' ',
            engName: 'Divine Sense',
            description: '         ,          .          .         - ,      60   ,      .    (,   ) - ,    ,     (,     ).\n\n         -   ,     ,     <a href="/spell/1155"> [Hallow]</a>.\n\n      ,   1 +   .     ,     .',
            shortDescription: '  //  60 ',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCountSpecial: {
                type: 'FORMULA',
                group: 'STAT_BASED',
                base: 1,
                stat: 'CHA',
                operation: 'ADD',
            }
        },
        {
            name: ' ',
            engName: 'Lay on Hands',
            description: '     .      ,  ,     .          -,       5.\n\n         ,      -,    ,     .\n\n,    5 -     ,          ,    .             ,  -   .\n\n       .',
            shortDescription: '  =    5,     /',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCountSpecial: {
                type: 'FORMULA',
                group: 'LEVEL_BASED',
                multiplier: 5,
                operation: 'MULTIPLY',
            }
        },

        // 2 
        {
            name: ' ()',
            engName: 'Spellcasting (Paladin)',
            description: ' 2             ,   .\n\n**   :**   ,          .       1   ,      .      ,    .\n\n    ,   ,     .      ,      +    ,   (  ).    ,      .\n\n** :**        .\n\n**   = 8 +   () +  **\n\n**   =  +  **\n\n** :**           .',
            shortDescription: '  ;   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Divine Smite',
            description: '  2 ,        ,      ,         .    28    1 ,  18      1,   58.    18,      ,   68.',
            shortDescription: '      +28  68  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 3 
        {
            name: ' \'',
            engName: 'Divine Health',
            description: ' 3   ,    ,     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Sacred Oath',
            description: '   3 ,   ,   \'   .        ,  ,     .\n\n       3 ,    7, 15  20 .      ,      ,      .',
            shortDescription: '  () -   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Channel Divinity',
            description: '          .    ,   , ,   .\n\n     ,  ,   .       ,      .\n\n     .     ,       .',
            shortDescription: '      (1    )',
            displayType: [FeatureDisplayType.ACTION, FeatureDisplayType.BONUSACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1,
        },
        {
            name: ' ',
            engName: 'Oath Spells',
            description: '    \' .          ,      ( 3, 5, 9, 13  17 ).\n\n       ,     .       ,     .\n\n    ,   \'    ,         .',
            shortDescription: '      ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        // 5 
        {
            name: ' ',
            engName: 'Extra Attack (Paladin)',
            description: '  5 ,       ,        .',
            shortDescription: '2   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 6 
        {
            name: ' ',
            engName: 'Aura of Protection',
            description: '  6 ,        10      ,      ,      (   +1).     ,    .\n\n 18       30 .',
            shortDescription: '+      10  (30  18 )',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 10 
        {
            name: ' ',
            engName: 'Aura of Courage',
            description: '  10 ,       10       ,    .\n\n 18       30 .',
            shortDescription: '  frightened      10  (30  18 )',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 11 
        {
            name: '  ',
            engName: 'Improved Divine Smite',
            description: ' 11      ,         .       ,    18  .',
            shortDescription: ' +18      ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 14 
        {
            name: ' ',
            engName: 'Cleansing Touch',
            description: '  14 ,             ,   .\n\n      ,      (  ).    ,    .',
            shortDescription: '      ',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCountSpecial: {
                type: 'STATIC_FROM_STAT',
                stat: 'CHA'
            }
        },

        //   (Tasha's)
        {
            name: '  ',
            engName: 'Harness Divine Power',
            description: '  3        ,    .       ,        ,            ( ).  ,      ,   ,      : 3  -  ; 7  - ; 15  - .     ,    .',
            shortDescription: ' Channel Divinity      ',
            displayType: [FeatureDisplayType.BONUSACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCountSpecial: [
                { lvl: 3, uses: 1, },
                { lvl: 7, uses: 2, },
                { lvl: 15, uses: 3, }
            ],
        },


        // ===== ROGUE FEATURES =====

        // 1 
        {
            name: '',
            engName: 'Expertise',
            description: ' 1     :   ,       .    ()   -  ,   ,  -   .\n\n 6         (   ),    .',
            shortDescription: '   2  ( 2  6 )',
            displayType: [FeatureDisplayType.PASSIVE],
            skillExpertises: {
                chooseFromCurrentProficiencies: true,
                count: 2
            }
        },
        {
            name: ' ',
            engName: 'Sneak Attack',
            description: ' ,       .        16   ,     ,        .       .\n\n      ,        5   ,    ,        .\n\n      ,       .',
            shortDescription: '   +X6         ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Thieves\' Cant',
            description: '         -   ,   ,      ,  ,  .   ,    ,   .         ,      .\n\n ,       ,     ,  ,  :    ,     ,    ,       ,          .',
            shortDescription: '   +  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 2 
        {
            name: ' ',
            engName: 'Cunning Action',
            description: '  2 ,           .        : ,   .',
            shortDescription: ' : ,   ',
            displayType: [FeatureDisplayType.BONUSACTION],
        },

        // 3 
        {
            name: ' ',
            engName: 'Roguish Archetype',
            description: ' 3    ,        .        3 ,     9, 13  17 .',
            shortDescription: '  -   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 5 
        {
            name: ' ',
            engName: 'Uncanny Dodge',
            description: '  5 ,  ,   ,    ,     ,       .',
            shortDescription: '    ',
            displayType: [FeatureDisplayType.REACTION],
        },

        // 6 

        {
            name: ' 2',
            engName: 'Expertise 2',
            description: '  6 ,        (   ).    ()   -  ,   ,  -   .',
            shortDescription: '    2  (6 )',
            displayType: [FeatureDisplayType.PASSIVE],
            skillExpertises: {
                chooseFromCurrentProficiencies: true,
                count: 2
            }
        },

        // 7 
        {
            name: '',
            engName: 'Evasion',
            description: '  7 ,         ,         <a href="/spell/1190">  [Ice Storm]</a>.    ,      ,     ,      ,     ,     ,    .',
            shortDescription: ' :   0 ,   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 11 
        {
            name: ' ',
            engName: 'Reliable Talent',
            description: ' 11         ,     . ,     ,        (),     20 9    10.',
            shortDescription: '    20 < 10 = 10 ( 10  )',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 14 
        {
            name: '',
            engName: 'Blindsense',
            description: '  14 ,    ,    -       10   .',
            shortDescription: ' /   10  ( )',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 15 
        {
            name: ' ',
            engName: 'Slippery Mind',
            description: ' 15      .     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE],
            savingThrows: [Ability.WIS],
        },

        // 18 
        {
            name: '',
            engName: 'Elusive',
            description: '  18 ,   ,       .        ,    .',
            shortDescription: '        ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 20 
        {
            name: ' ',
            engName: 'Stroke of Luck',
            description: ' 20       ,    .         ,      . ,     ,     20  20.\n\n     ,      ,       .',
            shortDescription: '       20   (1   short rest)',
            displayType: [FeatureDisplayType.PASSIVE],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1,
        },

        //   (Tasha's)
        {
            name: ' ',
            engName: 'Steady Aim',
            description: ' 3 ,  ,             .               ,         0    .',
            shortDescription: '      (     0 )',
            displayType: [FeatureDisplayType.BONUSACTION],
        },



        // ===== WARLOCK FEATURES =====

        // 1 
        {
            name: ' ',
            engName: 'Pact Magic',
            description: '    ,     ,     .\n\n**:**           .        ,        .\n\n** :**   ,      .   ,    .      .        1   ,     .      ,      .\n\n,   5 ,       3 .    1  <a href="/spell/1505">  [Witch Bolt]</a>,       ,       3 .\n\n** :**  1      1        .\n\n     ,          1   . ,   ,      ,         .    6 , ,     ,    1, 2  3 .\n\n** :**        .\n\n**   = 8 +   () +  **\n\n**   =   () +  **\n\n** :**           .',
            shortDescription: '  :  ,         ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 2 
        {
            name: ' ',
            engName: 'Eldritch Invocations',
            description: '         -   ,      .\n\n 2         .         .      ,       ,        .\n\n** :** 2   2 ,  +1   : 5, 7, 9, 12, 15, 18 (  8   18 ).\n\n ,       ,      ,   ,     ,        .',
            shortDescription: ' 2  ,      ( 8 )',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 3 
        {
            name: ' ',
            engName: 'Pact Boon',
            description: ' 3           .         :\n\n** :**          .    ,      ,    .   ,   .   ,       5     1   .   ,      ,     ( )    .\n\n** :**    <a href="/spell/1319">  [Find Familiar]</a>      .        .     ,                : , ,   .\n\n** :**     ,    .     ,       -  (   \'     ).    ,      .        .    \'    ,        .\n\n** ** *()*:      - ,    ,   .       ,    4  ,     .       ,      (),     ,     .',
            shortDescription: '  : ,  (),   ',
            displayType: [FeatureDisplayType.HIDDEN],
        },

        // 11, 13, 15, 17 
        {
            name: '  (6 )',
            engName: 'Mystic Arcanum (6th level)',
            description: ' 11       ,   .     6    .\n\n    -  ,    .     ,      .\n\n          ,      :   7   13 ,   8   15     9   17 .       ,    .',
            shortDescription: ' 1  6 ,   1    ',
            displayType: [FeatureDisplayType.PASSIVE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
        },

        {
            name: '  (7 )',
            engName: 'Mystic Arcanum (7th level)',
            description: ' 13      7     .      ,    .     ,      .',
            shortDescription: ' 1  7 ,   1    ',
            displayType: [FeatureDisplayType.PASSIVE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
        },

        {
            name: '  (8 )',
            engName: 'Mystic Arcanum (8th level)',
            description: ' 15      8     .      ,    .     ,      .',
            shortDescription: ' 1  8 ,   1    ',
            displayType: [FeatureDisplayType.PASSIVE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
        },

        {
            name: '  (9 )',
            engName: 'Mystic Arcanum (9th level)',
            description: ' 17      9     .      ,    .     ,      .',
            shortDescription: ' 1  9 ,   1    ',
            displayType: [FeatureDisplayType.PASSIVE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
        },

        // 20 
        {
            name: ' ',
            engName: 'Eldritch Master',
            description: ' 20         ,       .    1 ,     ,           .        ,     ,      .',
            shortDescription: '1        (1   )',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
        },

        // ===== PACT BOONS ( ) =====

        {
            name: ' ',
            engName: 'Pact of the Blade',
            description: '         .    ,      ,    .   ,   .              .\n\n   ,       5     1   .   ,      ,     (  )    .\n\n**  :**          ,     1 ,    .        .\n\n            ,     .          .      ,   ,        ,      ,     \'.  \'   ,      ,  \' .',
            shortDescription: '   ,  \'     ',
            displayType: [FeatureDisplayType.ACTION],
        },

        {
            name: ' ',
            engName: 'Pact of the Chain',
            description: '   <a href="/spell/1319">  [Find Familiar]</a>      .        .\n\n    ,                : , ,   .\n\n ,     ,         ,         .',
            shortDescription: ' <a href="/spell/1319">  [Find Familiar]</a>      ',
            displayType: [FeatureDisplayType.PASSIVE],
            givesSpells: {
                connect: [{ engName: 'Find Familiar' }]
            },
        },

        {
            name: ' ',
            engName: 'Pact of the Tome',
            description: '    ,    .     ,       -  (   \'     ).    ,      .        .    \'    ,        .\n\n** :**      ,     ,      .           ,     .    ,   .',
            shortDescription: '   3   - ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        {
            name: ' ',
            engName: 'Pact of the Talisman',
            description: '     - ,    ,   .       ,    4  ,     .       ,     ,     ,     .\n\n** :**    ,     ,      .           ,     .    ,   .',
            shortDescription: '  +4     ( =  )',
            displayType: [FeatureDisplayType.FREE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,
        },


        // ===== ELDRITCH INVOCATIONS -   =====

        // 1. Agonizing Blast
        {
            name: ' ',
            engName: 'Agonizing Blast',
            description: '   <a href="/spell/1343">  [Eldritch Blast]</a>,      ,     .',
            shortDescription: '+     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 2. Armor of Shadows
        {
            name: ' ',
            engName: 'Armor of Shadows',
            description: '   <a href="/spell/1326">  [Mage Armor]</a>   ,        .',
            shortDescription: '<a href="/spell/1326">  [Mage Armor]</a>   ',
            displayType: [FeatureDisplayType.PASSIVE],
            givesSpells: {
                connect: [{ engName: 'Mage Armor' }]
            },
        },

        // 3. Ascendant Step
        {
            name: ' ',
            engName: 'Ascendant Step',
            description: '   <a href="/spell/1507"> [Levitate]</a>   ,        .',
            shortDescription: ' [Levitate]   ',
            displayType: [FeatureDisplayType.PASSIVE],
            givesSpells: {
                connect: [{ engName: 'Levitate' }]
            },
        },

        // 4. Beguiling Influence
        {
            name: ' ',
            engName: 'Beguiling Influence',
            description: '     ',
            shortDescription: '    ',
            displayType: [FeatureDisplayType.PASSIVE],
            skillProficiencies: {
                granted: ['DECEPTION', 'PERSUASION']
            },
        },

        // 5. Beast Speech
        {
            name: ' ',
            engName: 'Beast Speech',
            description: '   <a href="/spell/1317">   [Speak with Animals]</a> ,    .',
            shortDescription: '   [Speak with Animals] ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            givesSpells: {
                connect: [{ engName: 'Speak with Animals' }]
            },
        },

        // 6. Devil's Sight
        {
            name: ' ',
            engName: 'Devil\'s Sight',
            description: '     ,  ,   ,    120 .',
            shortDescription: '  -   120 ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 7. Eldritch Sight
        {
            name: ' ',
            engName: 'Eldritch Sight',
            description: '   <a href="/spell/1045">  [Detect Magic]</a> ,    .',
            shortDescription: '<a href="/spell/1045">  [Detect Magic]</a> ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            givesSpells: {
                connect: [{ engName: 'Detect Magic' }]
            },
        },

        // 8. Eldritch Mind
        {
            name: ' ',
            engName: 'Eldritch Mind',
            description: '          .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 9. Eldritch Spear
        {
            name: ' ',
            engName: 'Eldritch Spear',
            description: '   <a href="/spell/1343">  [Eldritch Blast]</a>,     300 .',
            shortDescription: ' <a href="/spell/1343">  [Eldritch Blast]</a> = 300 ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 10. Eyes of the Rune Keeper
        {
            name: '  ',
            engName: 'Eyes of the Rune Keeper',
            description: '     .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 11. Gaze of Two Minds
        {
            name: '  ',
            engName: 'Gaze of Two Minds',
            description: '    ,  ,          .        ,   ,          \',        .       ,    -  ,    ,         .',
            shortDescription: '      (   )',
            displayType: [FeatureDisplayType.ACTION, FeatureDisplayType.BONUSACTION],
        },

        // 12. Mask of Many Faces
        {
            name: '  ',
            engName: 'Mask of Many Faces',
            description: '   <a href="/spell/1332"> [Disguise Self]</a> ,    .',
            shortDescription: '<a href="/spell/1332"> [Disguise Self]</a> ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            givesSpells: {
                connect: [{ engName: 'Disguise Self' }]
            },
        },

        // 13. Misty Visions
        {
            name: ' ',
            engName: 'Misty Visions',
            description: '   <a href="/spell/1330">  [Silent Image]</a> ,        .',
            shortDescription: '<a href="/spell/1330">  [Silent Image]</a> ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            givesSpells: {
                connect: [{ engName: 'Silent Image' }]
            },
        },

        // 14. Repelling Blast
        {
            name: ' ',
            engName: 'Repelling Blast',
            description: '     <a href="/spell/1343">  [Eldritch Blast]</a>,       10      .',
            shortDescription: '<a href="/spell/1343">  [Eldritch Blast]</a>   10 ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 15. Sculptor of Flesh
        {
            name: ' ',
            engName: 'Sculptor of Flesh',
            description: '   <a href="/spell/1189"> [Polymorph]</a>  ,    .      ,     .',
            shortDescription: '<a href="/spell/1189"> [Polymorph]</a> 1   ',
            displayType: [FeatureDisplayType.RESOURCE, FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
            givesSpells: {
                connect: [{ engName: 'Polymorph' }]
            },
        },

        // 16. Sign of Ill Omen
        {
            name: '  ',
            engName: 'Sign of Ill Omen',
            description: '   <a href="/spell/1226">  [Bestow Curse]</a>  ,    .      ,     .',
            shortDescription: '<a href="/spell/1226">  [Bestow Curse]</a> 1   ',
            displayType: [FeatureDisplayType.RESOURCE, FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
            givesSpells: {
                connect: [{ engName: 'Bestow Curse' }]
            },
        },

        // 17. Thirsting Blade
        {
            name: ' ',
            engName: 'Thirsting Blade',
            description: '        ,        .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 18. Visions of Distant Realms
        {
            name: '  ',
            engName: 'Visions of Distant Realms',
            description: '   <a href="/spell/1205">  [Arcane Eye]</a> ,    .',
            shortDescription: '<a href="/spell/1205">  [Arcane Eye]</a> ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            givesSpells: {
                connect: [{ engName: 'Arcane Eye' }]
            },
        },

        // 19. Voice of the Chain Master
        {
            name: '  ',
            engName: 'Voice of the Chain Master',
            description: '            ,       .  ,       ,          ,        .',
            shortDescription: ' \'    ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 20. Whispers of the Grave
        {
            name: ' ',
            engName: 'Whispers of the Grave',
            description: '   <a href="/spell/1215">   [Speak with Dead]</a> ,    .',
            shortDescription: '<a href="/spell/1215">   [Speak with Dead]</a> ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            givesSpells: {
                connect: [{ engName: 'Speak with Dead' }]
            },
        },

        // 21. Book of Ancient Secrets
        {
            name: '  ',
            engName: 'Book of Ancient Secrets',
            description: '         .    1     (ritual),    - .  \'        ,   .            .     ,     ,      .\n\n            .     ,      ,            ( ),         .        2    50 .',
            shortDescription: ' 2 -   ,   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 22. Otherworldly Leap
        {
            name: ' ',
            engName: 'Otherworldly Leap',
            description: '   <a href="/spell/1307"> [Jump]</a>   ,        .',
            shortDescription: '<a href="/spell/1307"> [Jump]</a>   ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            givesSpells: {
                connect: [{ engName: 'Jump' }]
            },
        },

        // 23. Gift of the Depths
        {
            name: ' ',
            engName: 'Gift of the Depths',
            description: '    ,     ,     .\n\n    <a href="/spell/1241">  [Water Breathing]</a>  ,    .      ,    .',
            shortDescription: '   +  , <a href="/spell/1241">  [Water Breathing]</a> 1/',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
            givesSpells: {
                connect: [{ engName: 'Water Breathing' }]
            },
        },

        // 24. Gift of the Ever-Living Ones
        {
            name: ' ',
            engName: 'Gift of the Ever-Living Ones',
            description: '   -,       100   ,  - ,     -,  ,       .',
            shortDescription: ' ,    (100 )',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 25. Grasp of Hadar
        {
            name: ' ',
            engName: 'Grasp of Hadar',
            description: '     ,      <a href="/spell/1343">  [Eldritch Blast]</a>,          10    .',
            shortDescription: '<a href="/spell/1343">  [Eldritch Blast]</a>   10  (1   )',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 26. Lance of Lethargy
        {
            name: ' ',
            engName: 'Lance of Lethargy',
            description: '     ,      <a href="/spell/1343">  [Eldritch Blast]</a>,        10      .',
            shortDescription: '<a href="/spell/1343">  [Eldritch Blast]</a>   10  (1   )',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 27. Fiendish Vigor
        {
            name: ' ',
            engName: 'Fiendish Vigor',
            description: '   <a href="/spell/1304">  [False Life]</a>      1 ,        .',
            shortDescription: '<a href="/spell/1304">  [False Life]</a>   ',
            displayType: [FeatureDisplayType.PASSIVE],
            givesSpells: {
                connect: [{ engName: 'False Life' }]
            },
        },

        // 28. Improved Pact Weapon
        {
            name: '  ',
            engName: 'Improved Pact Weapon',
            description: '   - ,     Pact of the Blade,      .\n\n ,   +1      ,     ,       .\n\n,      ,  ,     .',
            shortDescription: '  =  , +1  /,   /',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 29. Eldritch Smite
        {
            name: ' ',
            engName: 'Eldritch Smite',
            description: '    ,       ,      ,    18   ,   18    ,      ,      . (  1515 ,   ,    )',
            shortDescription: '     +18    +  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 30. Shrouded in Shadow
        {
            name: ' ',
            engName: 'Shrouded in Shadow',
            description: '   <a href="/spell/1276"> [Invisibility]</a>   ,        .',
            shortDescription: '<a href="/spell/1276"> [Invisibility]</a>   ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            givesSpells: {
                connect: [{ engName: 'Invisibility' }]
            },
        },

        // 31. Master of Myriad Forms
        {
            name: '  ',
            engName: 'Master of Myriad Forms',
            description: '   <a href="/spell/1288">  [Alter Self]</a> ,    .',
            shortDescription: '<a href="/spell/1288">  [Alter Self]</a> ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            givesSpells: {
                connect: [{ engName: 'Alter Self' }]
            },
        },

        // 32. Witch Sight
        {
            name: ' ',
            engName: 'Witch Sight',
            description: '     -   ,     ,      30         .',
            shortDescription: '     30 ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 33. Lifedrinker
        {
            name: '',
            engName: 'Lifedrinker',
            description: '      ,     ,      ( 1).',
            shortDescription: '+     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 35. Minions of Chaos
        {
            name: ' ',
            engName: 'Minions of Chaos',
            description: '   <a href="/spell/1170">\'  [Conjure Elemental]</a>  ,    .      ,     .',
            shortDescription: '<a href="/spell/1170">\'  [Conjure Elemental]</a> 1   ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
            givesSpells: {
                connect: [{ engName: 'Conjure Elemental' }]
            },
        },

        // 36. One with Shadows
        {
            name: '  ',
            engName: 'One with Shadows',
            description: '        ,     .   ,         .',
            shortDescription: '    (  /)',
            displayType: [FeatureDisplayType.ACTION],
        },

        // 37. Chains of Carceri
        {
            name: ' ',
            engName: 'Chains of Carceri',
            description: '   <a href="/spell/1143">  [Hold Monster]</a>  -   ,    -        .     ,           .',
            shortDescription: '<a href="/spell/1143">  [Hold Monster]</a>   //',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            givesSpells: {
                connect: [{ engName: 'Hold Monster' }]
            },
        },

        // 38. Tomb of Levistus
        {
            name: ' ',
            engName: 'Tomb of Levistus',
            description: ',    ,       10  -    ,       .          ,     0,   .\n\n ,     ,      ,       .',
            shortDescription: '  10   ,   0     ',
            displayType: [FeatureDisplayType.REACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1,
        },

        // 39. Trickster's Escape
        {
            name: ' ',
            engName: 'Trickster\'s Escape',
            description: '   <a href="/spell/1184">  [Freedom of Movement]</a>    ,    .      ,    .',
            shortDescription: '<a href="/spell/1184">  [Freedom of Movement]</a>   1   ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
            givesSpells: {
                connect: [{ engName: 'Freedom of Movement' }]
            },
        },

        // 40. Bewitching Whispers
        {
            name: ' ',
            engName: 'Bewitching Whispers',
            description: '   <a href="/spell/1186"> [Compulsion]</a>  ,    .      ,     .',
            shortDescription: '<a href="/spell/1186"> [Compulsion]</a> 1   ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
            givesSpells: {
                connect: [{ engName: 'Compulsion' }]
            },
        },

        // 41. Dreadful Word
        {
            name: ' ',
            engName: 'Dreadful Word',
            description: '   <a href="/spell/1183">\' [Confusion]</a>  ,    .      ,     .',
            shortDescription: '<a href="/spell/1183">\' [Confusion]</a> 1   ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
            givesSpells: {
                connect: [{ engName: 'Confusion' }]
            },
        },

        // 42. Mire the Mind
        {
            name: '  ',
            engName: 'Mire the Mind',
            description: '   <a href="/spell/1208"> [Slow]</a>  ,    .      ,     .',
            shortDescription: '<a href="/spell/1208"> [Slow]</a> 1   ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
            givesSpells: {
                connect: [{ engName: 'Slow' }]
            },
        },

        // 43. Thief of Five Fates
        {
            name: ' \' ',
            engName: 'Thief of Five Fates',
            description: '   <a href="/spell/1336"> [Bane]</a>  ,    .      ,     .',
            shortDescription: '<a href="/spell/1336"> [Bane]</a> 1   ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
            givesSpells: {
                connect: [{ engName: 'Bane' }]
            },
        },

        // 44. Aspect of the Moon
        {
            name: ' ',
            engName: 'Aspect of the Moon',
            description: '          .     ,     8    ,         .',
            shortDescription: '  ,    (  )',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
        },

        // 45. Cloak of Flies
        {
            name: ' ',
            engName: 'Cloak of Flies',
            description: '       ,     .    5      ,     .  ,           .\n\n      ,        . -  ,      ,   ,      ( 0 ).',
            shortDescription: '    :   , +   ',
            displayType: [FeatureDisplayType.BONUSACTION],
        },

        // 46. Ghostly Gaze
        {
            name: ' ',
            engName: 'Ghostly Gaze',
            description: '       \'    30     .       \'  ,  .\n\n    ,      ,       .',
            shortDescription: '    30     (1 / )',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1,
        },

        // 47. Maddening Hex
        {
            name: ' ',
            engName: 'Maddening Hex',
            description: '      ,    <a href="/spell/1362"> [Hex]</a>    ,    Hexblade    .    ,    ,       30   .        ,       5   ,   ,      ( 1 ).',
            shortDescription: '         ',
            displayType: [FeatureDisplayType.BONUSACTION],
        },

        // 48. Relentless Hex
        {
            name: ' ',
            engName: 'Relentless Hex',
            description: '    \'     .          30    ,    ,   5   ,    <a href="/spell/1362"> [Hex]</a>    ,    Hexblade    .    ,     .',
            shortDescription: '      ( 30 )',
            displayType: [FeatureDisplayType.BONUSACTION],
        },

        // 49. Far Scribe ( )
        {
            name: ' ',
            engName: 'Far Scribe',
            description: '    \'  .         \'   ,     ,      ().\n\n    <a href="/spell/1220"> [Sending]</a>  ,  \'   ,        .   ,      .      ,    ,   \'  ,     .    1 .\n\n     \'  ,  .',
            shortDescription: '     <a href="/spell/1220"> [Sending]</a>  ',
            displayType: [FeatureDisplayType.PASSIVE],
            givesSpells: {
                connect: [{ engName: 'Sending' }]
            },
        },


        // 50. Gift of the Protectors ( )
        {
            name: ' ',
            engName: 'Gift of the Protectors',
            description: '    \'  .         \'   ,     ,      ().\n\n - ,  \'   ,   0 -,    ,     1 -  .  ,      ,        ,      .\n\n     \'  ,  .',
            shortDescription: '  :   0   1  (1   /)',
            displayType: [FeatureDisplayType.PASSIVE],
        },


        // 51. Investment of the Chain Master
        {
            name: '  ',
            engName: 'Investment of the Chain Master',
            description: '   <a href="/spell/1319">  [Find Familiar]</a>,      :\n\n     ,    (  ),     .\n         .\n              .\n      ,      .\n    ,         .',
            shortDescription: '  : /,   ,  , ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // 52. Undying Servitude
        {
            name: ' ',
            engName: 'Undying Servitude',
            description: '   <a href="/spell/1217">  [Animate Dead]</a>  ,    .      ,    .',
            shortDescription: '<a href="/spell/1217">  [Animate Dead]</a> 1   ',
            displayType: [FeatureDisplayType.PASSIVE, FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
            givesSpells: {
                connect: [{ engName: 'Animate Dead' }]
            },
        },

        // 53. Rebuke of the Talisman
        {
            name: ' ',
            engName: 'Rebuke of the Talisman',
            description: '       ,       30   ,       ,      (),       10    .',
            shortDescription: ':         ',
            displayType: [FeatureDisplayType.REACTION],
        },

        // 54. Protection of the Talisman
        {
            name: ' ',
            engName: 'Protection of the Talisman',
            description: '       ,    4  ,     .       ,      (),     ,     .',
            shortDescription: '+4    ( =  )',
            displayType: [FeatureDisplayType.PASSIVE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,
        },

        // 55. Bond of the Talisman
        {
            name: ' ',
            engName: 'Bond of the Talisman',
            description: '     ,       ,    ,   30   ,  ,       .       ,       .      ,      (),     ,     .',
            shortDescription: '      ( =  )',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,
        },


        // ===== SORCERER FEATURES =====

        {
            name: ' ()',
            engName: 'Spellcasting (Sorcerer)',
            description: ' 1         ,   .\n\n** **:      ,    .     ,            ,     ,      .\n\n****:        .\n\n** **:   ,          1   .      .\n\n** **:     .\n\n   = 8 +   () +  .\n   =  +  .',
            shortDescription: '       ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Sorcerous Origin',
            description: ' 1       ,       1, 6, 14  18 .       :  ,     .',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Font of Magic',
            description: '  2 ,     ,       .\n\n** **:     ,      .     ,    .\n\n** **:     ,     (1  = 2 , 2  = 3, 3  = 5, 4  = 6, 5  = 7).      ,     (1  = 2 , 2  = 3, 3  = 5, 4  = 6, 5  = 7).',
            shortDescription: '  = ;      ',
            displayType: [FeatureDisplayType.CLASS_RESOURCE],
        },
        {
            name: '',
            engName: 'Metamagic',
            description: ' 3         ,    .    10  17 ,     .\n\n          ,     .',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Sorcerous Restoration',
            description: ' 20    4    ,    .',
            shortDescription: '+4     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // Sorcerer optional features
        {
            name: ' ',
            engName: 'Magical Guidance',
            description: '  5 ,     ,    1  ,   .     .',
            shortDescription: ' 1  ,   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Sorcerous Versatility',
            description: '     (4, 8, 12, 16  19 ),        ,  ,     ,       ,  ,  .        .',
            shortDescription: '        ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // Sorcerer Metamagic options
        {
            name: ' ',
            engName: 'Careful Spell',
            description: '   ,          ,    1  ,    ,       ( ).       .',
            shortDescription: '      1  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Distant Spell',
            description: '      5   ,    1  ,    .       30 .',
            shortDescription: '       30 ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Empowered Spell',
            description: '      ,    1  ,     ,       ( ).     .           .',
            shortDescription: '   (  )',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Extended Spell',
            description: '      1   ,    1  ,    ,   24 .',
            shortDescription: '   ( 24 )',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Heightened Spell',
            description: '   ,     ,    3  ,       .',
            shortDescription: ' 3       ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Quickened Spell',
            description: '   ,    ,    2  ,       .',
            shortDescription: '      ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Subtle Spell',
            description: '   ,    1  ,        .',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Twinned Spell',
            description: '   ,           ,     ,     (1  ),       .       .',
            shortDescription: '        ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Seeking Spell',
            description: '     ,    2  ,   .     .        ,       .',
            shortDescription: ' 2      ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Transmuted Spell',
            description: '   ,   , , , ,    ,    1  ,        : , , , ,   .',
            shortDescription: ' 1     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // ===== WIZARD FEATURES =====
        {
            name: ' ()',
            engName: 'Spellcasting (Wizard)',
            description: ' 1              .\n\n** **:       1 .     ,         .\n\n**   **:     ,       +    ( ).    ,      .     ,     ,       .\n\n** **:     .\n\n   = 8 +   () +  .\n   =  +  .\n\n** **:     ,      (  )  .',
            shortDescription: '        ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Arcane Recovery',
            description: '  1 ,      .       ,           ( ),   .  6       .',
            shortDescription: '        =   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Arcane Tradition',
            description: ' 2     ,     .        2, 6, 10  14 .',
            shortDescription: '  /   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Cantrip Formulas',
            description: '  3 ,      .               .      .',
            shortDescription: '      ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Spell Mastery',
            description: ' 18      1  2 ,        ,   .        ,  8   .',
            shortDescription: '  1 .   2 .   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Signature Spells',
            description: ' 20       3    .           .           ,        .    ,    ,  .',
            shortDescription: '  3 .    /  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },


        // ===== ARTIFICER () =====
        {
            name: ' ',
            engName: 'Magical Tinkering',
            description: '        .              (,  ,   ).       ,     ();   ,   .',
            shortDescription: '      ( = )',
            displayType: [FeatureDisplayType.ACTION],
        },
        {
            name: ' ()',
            engName: 'Spellcasting (Artificer)',
            description: '     ,     .    :  .        .\n\n   = 8 +   () +  .\n   =  +  .',
            shortDescription: ', ,    ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Infuse Item',
            description: '       ,   .         ;   ,   .     .      ,     24 .',
            shortDescription: '    (  )',
            displayType: [FeatureDisplayType.CLASS_RESOURCE],
        },
        {
            name: '   ',
            engName: 'The Right Tool for the Job',
            description: '       1        .   ,     .',
            shortDescription: ' 1     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Tool Expertise',
            description: '  6 ,       ,   ,      ().',
            shortDescription: '   ()  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Flash of Genius',
            description: '  7 ,        30      ,         .      ,     ( 1),        .',
            shortDescription: '  .   / ( = )',
            displayType: [FeatureDisplayType.REACTION],
            limitedUsesPer: RestType.LONG_REST,
        },
        {
            name: '  ',
            engName: 'Magic Item Adept',
            description: '  10 ,       :     ,         .',
            shortDescription: '      ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '- ',
            engName: 'Spell-Storing Item',
            description: ' 11       12   .     ,        ;    $2\u00d7$    ( 2).',
            shortDescription: ' 12 .   ( = 2, . 2)',
            displayType: [FeatureDisplayType.CLASS_RESOURCE],
        },
        {
            name: '  ',
            engName: 'Magic Item Savant',
            description: ' 14     ,       ,         .',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '  ',
            engName: 'Magic Item Master',
            description: ' 18          ,  .',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Soul of Artifice',
            description: ' 20 ,        ,   +1         .     0 ,        ,    1 .',
            shortDescription: '+1        ;   1 ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // ===== BARD FEATURES =====
        {
            name: ' ()',
            engName: 'Spellcasting (Bard)',
            description: '       ,   .\n\n** **:      ,    .   ,           (   ,      ).\n\n****:       (   ).\n\n** **:      .\n\n** **:     .\n\n   = 8 +   () +  .\n   =  +  .',
            shortDescription: '       ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Bardic Inspiration',
            description: '      (   60 ),    .             ,    ,    .\n\n      ( 1),       .       .',
            shortDescription: '      ( = )',
            displayType: [FeatureDisplayType.BONUSACTION, FeatureDisplayType.CLASS_RESOURCE],
        },
        {
            name: '   ',
            engName: 'Jack of All Trades',
            description: '  2 ,       (),  ,  -  ,      .',
            shortDescription: '    1/2  ()',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Song of Rest',
            description: '  2 ,            .   (  ,   )         ,           (     ).',
            shortDescription: '       ( )',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ()',
            engName: 'Expertise (Bard)',
            description: '  3 ,  2   .    ()   -  ,   ,     .        2    .',
            shortDescription: '   2  (  2)',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Font of Inspiration',
            description: '  5 ,            .',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '',
            engName: 'Countercharm',
            description: '  6 ,     ,         .    ,       30 ,    ,        .',
            shortDescription: '      /',
            displayType: [FeatureDisplayType.ACTION],
        },
        {
            name: ' ',
            engName: 'Magical Secrets',
            description: ' 10         :  2   -  .       .          .',
            shortDescription: '   -    ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Superior Inspiration',
            description: ' 20 ,           ,    .',
            shortDescription: '    1  ,  0',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // BARD
        // NOTE: Bard features are seeded earlier with full canonical descriptions and shortDescription.

        // CLERIC
        // ===== CLERIC FEATURES =====
        {
            name: ' ()',
            engName: 'Spellcasting (Cleric)',
            description: '        .\n\n** **:      .        +    ( 1).\n\n** **:   ,          1   .      .\n\n** **:     .\n\n   = 8 +   () +  .\n   =  +  .',
            shortDescription: '       ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Divine Domain',
            description: ' 1     ,    .            .',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '  ()',
            engName: 'Channel Divinity (Cleric)',
            description: '  2 ,     ,     .      .\n\n    ,         .',
            shortDescription: '   ;    ',
            displayType: [FeatureDisplayType.CLASS_RESOURCE],
            limitedUsesPer: RestType.SHORT_REST,
            usesCountSpecial: [
                { lvl: 2, uses: 1 },
                { lvl: 6, uses: 2 },
                { lvl: 18, uses: 3 },
            ],
        },
        {
            name: ' ',
            engName: 'Turn Undead',
            description: '  2 ,      ,   .        ;       1      .',
            shortDescription: '   ,   ',
            displayType: [FeatureDisplayType.ACTION],
        },
        {
            name: ' ',
            engName: 'Destroy Undead',
            description: '  5 ,        ,     ,    (CR)  .     .',
            shortDescription: '       ( )',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Divine Intervention',
            description: '  10 ,        .   .   ,       ,     .',
            shortDescription: '     (   1/ )',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
        },

        // NOTE: Cleric features are seeded earlier with full canonical descriptions and shortDescription.

        // DRUID

        // ===== DRUID FEATURES =====
        {
            name: ' ',
            engName: 'Druidic',
            description: '       .          .         .',
            shortDescription: '       ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ()',
            engName: 'Spellcasting (Druid)',
            description: '   ,    .\n\n** **:      .        +    ( 1).\n\n** **:   ,          1   .      .\n\n****:       (   ).\n\n** **:     .\n\n   = 8 +   () +  .\n   =  +  .',
            shortDescription: '       ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Wild Shape',
            description: '   ,     ,   .    ,            .        ,   ,       ,   .\n\n       ,         .',
            shortDescription: '   ;     ',
            displayType: [FeatureDisplayType.CLASS_RESOURCE, FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
        },
        {
            name: ' ',
            engName: 'Druid Circle',
            description: ' 2       ,      .        .',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '  ',
            engName: 'Timeless Body (Druid)',
            description: '  18 ,    :   ,        ,  .',
            shortDescription: '     /',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Beast Spells',
            description: '  18 ,         ,          ,  .          ,    ,      .',
            shortDescription: '     (  )',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '-',
            engName: 'Archdruid',
            description: ' 20       :       ,          ,     .',
            shortDescription: '        ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // NOTE: Druid features are seeded earlier with full canonical descriptions and shortDescription.

        // MONK
        // NOTE: Monk features are seeded earlier with full canonical descriptions and shortDescription.

        // PALADIN
        // NOTE: Paladin features are seeded earlier with full canonical descriptions and shortDescription.

        // RANGER
        // NOTE: Ranger features are seeded earlier with full canonical descriptions and shortDescription.

        // ROGUE
        // NOTE: Rogue features are seeded earlier with full canonical descriptions and shortDescription.

        // SORCERER
        // NOTE: Sorcerer features are seeded earlier with full canonical descriptions and shortDescription.

        // WARLOCK
        // NOTE: Warlock features are seeded earlier with full canonical descriptions and shortDescription.

        // WIZARD
        // NOTE: Wizard features are seeded earlier with full canonical descriptions and shortDescription.
    ]

    for (const feature of features) {
        try {
            const normalized = normalizeFeatureCreateInput(feature);
            await prisma.feature.upsert({
                where: { engName: normalized.engName },
                update: normalized,
                create: normalized,
            });
        } catch (error) {
            console.error('   :', feature.name);
            console.error(' Feature :', JSON.stringify(feature, null, 2));
            //    Prisma 
            if (error instanceof Prisma.PrismaClientKnownRequestError) {
                console.error(' Prisma Error Code:', error.code);
                console.error(' Meta:', error.meta);

                //     error.code  error.meta 
                if (error.code === 'P2025') {
                    console.error('   record(s)  connect:', error.meta?.cause);
                }
            }
        }
    }


    console.log(`  ${features.length}  !`)
}
</file>

<file path="prisma/seed/subclassChoiceOptionSeed.ts">
import { PrismaClient, Subclasses } from "@prisma/client"

type NewChoiceOption = {
  groupName: string
  optionName: string
  optionNameEng: string
  featureEngName: string
}

type SubclassChoiceLink = {
  subclass: Subclasses
  optionNameEng: string
  levelsGranted: number[]
}

export const seedSubclassChoiceOptions = async (prisma: PrismaClient) => {
  console.log("  ...")

  const newChoiceOptions: NewChoiceOption[] = [
    // Arcane Shot options
    { groupName: " ", optionName: " ", optionNameEng: "Banishing Arrow (Arcane Shot)", featureEngName: "Banishing Arrow" },
    { groupName: " ", optionName: " ", optionNameEng: "Beguiling Arrow (Arcane Shot)", featureEngName: "Beguiling Arrow" },
    { groupName: " ", optionName: " ", optionNameEng: "Bursting Arrow (Arcane Shot)", featureEngName: "Bursting Arrow" },
    { groupName: " ", optionName: " ", optionNameEng: "Enfeebling Arrow (Arcane Shot)", featureEngName: "Enfeebling Arrow" },
    { groupName: " ", optionName: " ", optionNameEng: "Grasping Arrow (Arcane Shot)", featureEngName: "Grasping Arrow" },
    { groupName: " ", optionName: " ", optionNameEng: "Piercing Arrow (Arcane Shot)", featureEngName: "Piercing Arrow" },
    { groupName: " ", optionName: "-", optionNameEng: "Seeking Arrow (Arcane Shot)", featureEngName: "Seeking Arrow" },
    { groupName: " ", optionName: " ", optionNameEng: "Shadow Arrow (Arcane Shot)", featureEngName: "Shadow Arrow" },

    // Battle Master maneuvers
    { groupName: "  ", optionName: "", optionNameEng: "Ambush (Maneuver)", featureEngName: "Ambush" },
    { groupName: "  ", optionName: "  ", optionNameEng: "Bait and Switch (Maneuver)", featureEngName: "Bait and Switch" },
    { groupName: "  ", optionName: "", optionNameEng: "Brace (Maneuver)", featureEngName: "Brace" },
    { groupName: "  ", optionName: " ", optionNameEng: "Commander's Strike (Maneuver)", featureEngName: "Commander's Strike" },
    { groupName: "  ", optionName: " ", optionNameEng: "Commanding Presence (Maneuver)", featureEngName: "Commanding Presence" },
    { groupName: "  ", optionName: " ", optionNameEng: "Disarming Attack (Maneuver)", featureEngName: "Disarming Attack" },
    { groupName: "  ", optionName: " ", optionNameEng: "Distracting Strike (Maneuver)", featureEngName: "Distracting Strike" },
    { groupName: "  ", optionName: " ", optionNameEng: "Evasive Footwork (Maneuver)", featureEngName: "Evasive Footwork" },
    { groupName: "  ", optionName: " ", optionNameEng: "Feinting Attack (Maneuver)", featureEngName: "Feinting Attack" },
    { groupName: "  ", optionName: " ", optionNameEng: "Goading Attack (Maneuver)", featureEngName: "Goading Attack" },
    { groupName: "  ", optionName: " ", optionNameEng: "Grappling Strike (Maneuver)", featureEngName: "Grappling Strike" },
    { groupName: "  ", optionName: "  ", optionNameEng: "Lunging Attack (Maneuver)", featureEngName: "Lunging Attack" },
    { groupName: "  ", optionName: " ", optionNameEng: "Maneuvering Attack (Maneuver)", featureEngName: "Maneuvering Attack" },
    { groupName: "  ", optionName: " ", optionNameEng: "Menacing Attack (Maneuver)", featureEngName: "Menacing Attack" },
    { groupName: "  ", optionName: "", optionNameEng: "Parry (Maneuver)", featureEngName: "Parry" },
    { groupName: "  ", optionName: " ", optionNameEng: "Precision Attack (Maneuver)", featureEngName: "Precision Attack" },
    { groupName: "  ", optionName: " ", optionNameEng: "Pushing Attack (Maneuver)", featureEngName: "Pushing Attack" },
    { groupName: "  ", optionName: " ", optionNameEng: "Quick Toss (Maneuver)", featureEngName: "Quick Toss" },
    { groupName: "  ", optionName: "", optionNameEng: "Rally (Maneuver)", featureEngName: "Rally" },
    { groupName: "  ", optionName: "", optionNameEng: "Riposte (Maneuver)", featureEngName: "Riposte" },
    { groupName: "  ", optionName: " ", optionNameEng: "Sweeping Attack (Maneuver)", featureEngName: "Sweeping Attack" },
    { groupName: "  ", optionName: " ", optionNameEng: "Tactical Assessment (Maneuver)", featureEngName: "Tactical Assessment" },
    { groupName: "  ", optionName: "", optionNameEng: "Trip Attack (Maneuver)", featureEngName: "Trip Attack" },

    // Rune options
    { groupName: " ", optionName: " ", optionNameEng: "Cloud Rune (Rune)", featureEngName: "Cloud Rune" },
    { groupName: " ", optionName: " ", optionNameEng: "Fire Rune (Rune)", featureEngName: "Fire Rune" },
    { groupName: " ", optionName: " ", optionNameEng: "Frost Rune (Rune)", featureEngName: "Frost Rune" },
    { groupName: " ", optionName: " ", optionNameEng: "Stone Rune (Rune)", featureEngName: "Stone Rune" },
    { groupName: " ", optionName: " ", optionNameEng: "Hill Rune (Rune)", featureEngName: "Hill Rune" },
    { groupName: " ", optionName: " ", optionNameEng: "Storm Rune (Rune)", featureEngName: "Storm Rune" },

    // Circle of the Land biomes
    { groupName: "  ()", optionName: "", optionNameEng: "Circle Spells  Arctic", featureEngName: "Circle Spells  Arctic" },
    { groupName: "  ()", optionName: "", optionNameEng: "Circle Spells  Coast", featureEngName: "Circle Spells  Coast" },
    { groupName: "  ()", optionName: "", optionNameEng: "Circle Spells  Desert", featureEngName: "Circle Spells  Desert" },
    { groupName: "  ()", optionName: "", optionNameEng: "Circle Spells  Forest", featureEngName: "Circle Spells  Forest" },
    { groupName: "  ()", optionName: "", optionNameEng: "Circle Spells  Grassland", featureEngName: "Circle Spells  Grassland" },
    { groupName: "  ()", optionName: "", optionNameEng: "Circle Spells  Mountain", featureEngName: "Circle Spells  Mountain" },
    { groupName: "  ()", optionName: "", optionNameEng: "Circle Spells  Swamp", featureEngName: "Circle Spells  Swamp" },
    { groupName: "  ()", optionName: "", optionNameEng: "Circle Spells  Underdark", featureEngName: "Circle Spells  Underdark" },

    // Totem Spirit (Barbarian)
    { groupName: " ", optionName: " ()", optionNameEng: "Totem Spirit: Bear", featureEngName: "Totem Spirit: Bear" },
    { groupName: " ", optionName: " ()", optionNameEng: "Totem Spirit: Eagle", featureEngName: "Totem Spirit: Eagle" },
    { groupName: " ", optionName: " ()", optionNameEng: "Totem Spirit: Elk", featureEngName: "Totem Spirit: Elk" },
    { groupName: " ", optionName: " ()", optionNameEng: "Totem Spirit: Tiger", featureEngName: "Totem Spirit: Tiger" },
    { groupName: " ", optionName: " ()", optionNameEng: "Totem Spirit: Wolf", featureEngName: "Totem Spirit: Wolf" },

    // Aspect of the Beast (Barbarian)
    { groupName: " ", optionName: " ()", optionNameEng: "Aspect of the Beast: Bear", featureEngName: "Aspect of the Beast: Bear" },
    { groupName: " ", optionName: " ()", optionNameEng: "Aspect of the Beast: Eagle", featureEngName: "Aspect of the Beast: Eagle" },
    { groupName: " ", optionName: " ()", optionNameEng: "Aspect of the Beast: Elk", featureEngName: "Aspect of the Beast: Elk" },
    { groupName: " ", optionName: " ()", optionNameEng: "Aspect of the Beast: Tiger", featureEngName: "Aspect of the Beast: Tiger" },
    { groupName: " ", optionName: " ()", optionNameEng: "Aspect of the Beast: Wolf", featureEngName: "Aspect of the Beast: Wolf" },

    // Totemic Attunement (Barbarian)
    { groupName: " ", optionName: " ()", optionNameEng: "Totemic Attunement: Bear", featureEngName: "Totemic Attunement: Bear" },
    { groupName: " ", optionName: " ()", optionNameEng: "Totemic Attunement: Eagle", featureEngName: "Totemic Attunement: Eagle" },
    { groupName: " ", optionName: " ()", optionNameEng: "Totemic Attunement: Elk", featureEngName: "Totemic Attunement: Elk" },
    { groupName: " ", optionName: " ()", optionNameEng: "Totemic Attunement: Tiger", featureEngName: "Totemic Attunement: Tiger" },
    { groupName: " ", optionName: " ()", optionNameEng: "Totemic Attunement: Wolf", featureEngName: "Totemic Attunement: Wolf" },

    // Draconic Ancestry (Sorcerer)
    { groupName: "-", optionName: "  ()", optionNameEng: "Black Dragon (Acid)", featureEngName: "Draconic Ancestry" },
    { groupName: "-", optionName: "  ()", optionNameEng: "Blue Dragon (Lightning)", featureEngName: "Draconic Ancestry" },
    { groupName: "-", optionName: "  ()", optionNameEng: "Brass Dragon (Fire)", featureEngName: "Draconic Ancestry" },
    { groupName: "-", optionName: "  ()", optionNameEng: "Bronze Dragon (Lightning)", featureEngName: "Draconic Ancestry" },
    { groupName: "-", optionName: "  ()", optionNameEng: "Copper Dragon (Acid)", featureEngName: "Draconic Ancestry" },
    { groupName: "-", optionName: "  ()", optionNameEng: "Gold Dragon (Fire)", featureEngName: "Draconic Ancestry" },
    { groupName: "-", optionName: "  ()", optionNameEng: "Green Dragon (Poison)", featureEngName: "Draconic Ancestry" },
    { groupName: "-", optionName: "  ()", optionNameEng: "Red Dragon (Fire)", featureEngName: "Draconic Ancestry" },
    { groupName: "-", optionName: "  ()", optionNameEng: "Silver Dragon (Cold)", featureEngName: "Draconic Ancestry" },
    { groupName: "-", optionName: "  ()", optionNameEng: "White Dragon (Cold)", featureEngName: "Draconic Ancestry" },

    // Hunter's Prey (Hunter)
    { groupName: " ", optionName: " ", optionNameEng: "Colossus Slayer (Hunter)", featureEngName: "Hunter's Prey" },
    { groupName: " ", optionName: " ", optionNameEng: "Giant Killer (Hunter)", featureEngName: "Hunter's Prey" },
    { groupName: " ", optionName: " ", optionNameEng: "Horde Breaker (Hunter)", featureEngName: "Hunter's Prey" },

    // Defensive Tactics (Hunter)
    { groupName: " ", optionName: "  ", optionNameEng: "Escape the Horde (Hunter)", featureEngName: "Defensive Tactics" },
    { groupName: " ", optionName: "  ", optionNameEng: "Multiattack Defense (Hunter)", featureEngName: "Defensive Tactics" },
    { groupName: " ", optionName: " ", optionNameEng: "Steel Will (Hunter)", featureEngName: "Defensive Tactics" },

    // Multiattack (Hunter)
    { groupName: "", optionName: "", optionNameEng: "Volley (Hunter)", featureEngName: "Multiattack (Hunter)" },
    { groupName: "", optionName: " ", optionNameEng: "Whirlwind Attack (Hunter)", featureEngName: "Multiattack (Hunter)" },

    // Superior Hunter's Defense
    { groupName: "  ", optionName: "", optionNameEng: "Evasion (Hunter)", featureEngName: "Superior Hunter's Defense" },
    { groupName: "  ", optionName: "  ", optionNameEng: "Stand Against the Tide (Hunter)", featureEngName: "Superior Hunter's Defense" },
    { groupName: "  ", optionName: " ", optionNameEng: "Uncanny Dodge (Hunter)", featureEngName: "Superior Hunter's Defense" },

    // Fighting Style (Swords)
    { groupName: "  (Swords)", optionName: "", optionNameEng: "Dueling (Swords)", featureEngName: "Fighting Style (Swords)" },
    { groupName: "  (Swords)", optionName: "  ", optionNameEng: "Two-Weapon Fighting (Swords)", featureEngName: "Fighting Style (Swords)" },
    
    // Armor Model (Armorer)
    { groupName: " ", optionName: "", optionNameEng: "Guardian (Armor Model)", featureEngName: "Armor Model" },
    { groupName: " ", optionName: "", optionNameEng: "Infiltrator (Armor Model)", featureEngName: "Armor Model" },

    // Elemental Disciplines (Way of the Four Elements)
    { groupName: " ", optionName: " ", optionNameEng: "Breath of Winter (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
    { groupName: " ", optionName: "  ", optionNameEng: "Clench of the North Wind (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
    { groupName: " ", optionName: "  ", optionNameEng: "Eternal Mountain Defense (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
    { groupName: " ", optionName: "  ", optionNameEng: "Fangs of the Fire Snake (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
    { groupName: " ", optionName: "  ", optionNameEng: "Fist of Four Thunders (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
    { groupName: " ", optionName: "  ", optionNameEng: "Fist of Unbroken Air (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
    { groupName: " ", optionName: "' ", optionNameEng: "Flames of the Phoenix (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
    { groupName: " ", optionName: " ", optionNameEng: "Gong of the Summit (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
    { groupName: " ", optionName: " ", optionNameEng: "Mist Stance (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
    { groupName: " ", optionName: " ", optionNameEng: "Ride the Wind (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
    { groupName: " ", optionName: "  '", optionNameEng: "River of Hungry Flame (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
    { groupName: " ", optionName: "  ", optionNameEng: "Rush of the Gale Spirits (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
    { groupName: " ", optionName: " ", optionNameEng: "Shape the Flowing River (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
    { groupName: " ", optionName: "  ", optionNameEng: "Sweeping Cinder Strike (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
    { groupName: " ", optionName: " ", optionNameEng: "Water Whip (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
    { groupName: " ", optionName: "  ", optionNameEng: "Wave of Rolling Earth (Elemental Discipline)", featureEngName: "Disciple of the Elements" },
  ]

  const subclassLinks: SubclassChoiceLink[] = [
    // Arcane Archer
    { subclass: Subclasses.ARCANE_ARCHER, optionNameEng: "Banishing Arrow (Arcane Shot)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.ARCANE_ARCHER, optionNameEng: "Beguiling Arrow (Arcane Shot)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.ARCANE_ARCHER, optionNameEng: "Bursting Arrow (Arcane Shot)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.ARCANE_ARCHER, optionNameEng: "Enfeebling Arrow (Arcane Shot)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.ARCANE_ARCHER, optionNameEng: "Grasping Arrow (Arcane Shot)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.ARCANE_ARCHER, optionNameEng: "Piercing Arrow (Arcane Shot)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.ARCANE_ARCHER, optionNameEng: "Seeking Arrow (Arcane Shot)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.ARCANE_ARCHER, optionNameEng: "Shadow Arrow (Arcane Shot)", levelsGranted: [3, 7, 10, 15] },

    // Battle Master maneuvers
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Ambush (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Bait and Switch (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Brace (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Commander's Strike (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Commanding Presence (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Disarming Attack (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Distracting Strike (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Evasive Footwork (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Feinting Attack (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Goading Attack (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Grappling Strike (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Lunging Attack (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Maneuvering Attack (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Menacing Attack (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Parry (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Precision Attack (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Pushing Attack (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Quick Toss (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Rally (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Riposte (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Sweeping Attack (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Tactical Assessment (Maneuver)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.BATTLE_MASTER, optionNameEng: "Trip Attack (Maneuver)", levelsGranted: [3, 7, 10, 15] },

    // Rune Knight runes
    { subclass: Subclasses.RUNE_KNIGHT, optionNameEng: "Cloud Rune (Rune)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.RUNE_KNIGHT, optionNameEng: "Fire Rune (Rune)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.RUNE_KNIGHT, optionNameEng: "Frost Rune (Rune)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.RUNE_KNIGHT, optionNameEng: "Stone Rune (Rune)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.RUNE_KNIGHT, optionNameEng: "Hill Rune (Rune)", levelsGranted: [3, 7, 10, 15] },
    { subclass: Subclasses.RUNE_KNIGHT, optionNameEng: "Storm Rune (Rune)", levelsGranted: [3, 7, 10, 15] },

    // Circle of the Land biomes
    { subclass: Subclasses.CIRCLE_OF_THE_LAND, optionNameEng: "Circle Spells  Arctic", levelsGranted: [3] },
    { subclass: Subclasses.CIRCLE_OF_THE_LAND, optionNameEng: "Circle Spells  Coast", levelsGranted: [3] },
    { subclass: Subclasses.CIRCLE_OF_THE_LAND, optionNameEng: "Circle Spells  Desert", levelsGranted: [3] },
    { subclass: Subclasses.CIRCLE_OF_THE_LAND, optionNameEng: "Circle Spells  Forest", levelsGranted: [3] },
    { subclass: Subclasses.CIRCLE_OF_THE_LAND, optionNameEng: "Circle Spells  Grassland", levelsGranted: [3] },
    { subclass: Subclasses.CIRCLE_OF_THE_LAND, optionNameEng: "Circle Spells  Mountain", levelsGranted: [3] },
    { subclass: Subclasses.CIRCLE_OF_THE_LAND, optionNameEng: "Circle Spells  Swamp", levelsGranted: [3] },
    { subclass: Subclasses.CIRCLE_OF_THE_LAND, optionNameEng: "Circle Spells  Underdark", levelsGranted: [3] },

    // Champion additional fighting style at 10 level
    { subclass: Subclasses.CHAMPION, optionNameEng: "Archery", levelsGranted: [10] },
    { subclass: Subclasses.CHAMPION, optionNameEng: "Blind Fighting", levelsGranted: [10] },
    { subclass: Subclasses.CHAMPION, optionNameEng: "Defense", levelsGranted: [10] },
    { subclass: Subclasses.CHAMPION, optionNameEng: "Dueling", levelsGranted: [10] },
    { subclass: Subclasses.CHAMPION, optionNameEng: "Great Weapon Fighting", levelsGranted: [10] },
    { subclass: Subclasses.CHAMPION, optionNameEng: "Interception", levelsGranted: [10] },
    { subclass: Subclasses.CHAMPION, optionNameEng: "Protection", levelsGranted: [10] },
    { subclass: Subclasses.CHAMPION, optionNameEng: "Superior Technique", levelsGranted: [10] },
    { subclass: Subclasses.CHAMPION, optionNameEng: "Thrown Weapon Fighting", levelsGranted: [10] },
    { subclass: Subclasses.CHAMPION, optionNameEng: "Two-Weapon Fighting", levelsGranted: [10] },
    { subclass: Subclasses.CHAMPION, optionNameEng: "Unarmed Fighting", levelsGranted: [10] },
    { subclass: Subclasses.CHAMPION, optionNameEng: "Druidic Warrior", levelsGranted: [10] },
    { subclass: Subclasses.CHAMPION, optionNameEng: "Blessed Warrior", levelsGranted: [10] },

    // Totem Spirit (Barbarian)
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, optionNameEng: "Totem Spirit: Bear", levelsGranted: [3] },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, optionNameEng: "Totem Spirit: Eagle", levelsGranted: [3] },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, optionNameEng: "Totem Spirit: Elk", levelsGranted: [3] },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, optionNameEng: "Totem Spirit: Tiger", levelsGranted: [3] },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, optionNameEng: "Totem Spirit: Wolf", levelsGranted: [3] },

    // Aspect of the Beast (Barbarian)
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, optionNameEng: "Aspect of the Beast: Bear", levelsGranted: [6] },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, optionNameEng: "Aspect of the Beast: Eagle", levelsGranted: [6] },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, optionNameEng: "Aspect of the Beast: Elk", levelsGranted: [6] },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, optionNameEng: "Aspect of the Beast: Tiger", levelsGranted: [6] },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, optionNameEng: "Aspect of the Beast: Wolf", levelsGranted: [6] },

    // Totemic Attunement (Barbarian)
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, optionNameEng: "Totemic Attunement: Bear", levelsGranted: [14] },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, optionNameEng: "Totemic Attunement: Eagle", levelsGranted: [14] },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, optionNameEng: "Totemic Attunement: Elk", levelsGranted: [14] },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, optionNameEng: "Totemic Attunement: Tiger", levelsGranted: [14] },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, optionNameEng: "Totemic Attunement: Wolf", levelsGranted: [14] },

    // Draconic Ancestry (Sorcerer)
    { subclass: Subclasses.DRACONIC_BLOODLINE, optionNameEng: "Black Dragon (Acid)", levelsGranted: [1] },
    { subclass: Subclasses.DRACONIC_BLOODLINE, optionNameEng: "Blue Dragon (Lightning)", levelsGranted: [1] },
    { subclass: Subclasses.DRACONIC_BLOODLINE, optionNameEng: "Brass Dragon (Fire)", levelsGranted: [1] },
    { subclass: Subclasses.DRACONIC_BLOODLINE, optionNameEng: "Bronze Dragon (Lightning)", levelsGranted: [1] },
    { subclass: Subclasses.DRACONIC_BLOODLINE, optionNameEng: "Copper Dragon (Acid)", levelsGranted: [1] },
    { subclass: Subclasses.DRACONIC_BLOODLINE, optionNameEng: "Gold Dragon (Fire)", levelsGranted: [1] },
    { subclass: Subclasses.DRACONIC_BLOODLINE, optionNameEng: "Green Dragon (Poison)", levelsGranted: [1] },
    { subclass: Subclasses.DRACONIC_BLOODLINE, optionNameEng: "Red Dragon (Fire)", levelsGranted: [1] },
    { subclass: Subclasses.DRACONIC_BLOODLINE, optionNameEng: "Silver Dragon (Cold)", levelsGranted: [1] },
    { subclass: Subclasses.DRACONIC_BLOODLINE, optionNameEng: "White Dragon (Cold)", levelsGranted: [1] },

    // Hunter's Prey (Hunter)
    { subclass: Subclasses.HUNTER_CONCLAVE, optionNameEng: "Colossus Slayer (Hunter)", levelsGranted: [3] },
    { subclass: Subclasses.HUNTER_CONCLAVE, optionNameEng: "Giant Killer (Hunter)", levelsGranted: [3] },
    { subclass: Subclasses.HUNTER_CONCLAVE, optionNameEng: "Horde Breaker (Hunter)", levelsGranted: [3] },

    // Defensive Tactics (Hunter)
    { subclass: Subclasses.HUNTER_CONCLAVE, optionNameEng: "Escape the Horde (Hunter)", levelsGranted: [7] },
    { subclass: Subclasses.HUNTER_CONCLAVE, optionNameEng: "Multiattack Defense (Hunter)", levelsGranted: [7] },
    { subclass: Subclasses.HUNTER_CONCLAVE, optionNameEng: "Steel Will (Hunter)", levelsGranted: [7] },

    // Multiattack (Hunter)
    { subclass: Subclasses.HUNTER_CONCLAVE, optionNameEng: "Volley (Hunter)", levelsGranted: [11] },
    { subclass: Subclasses.HUNTER_CONCLAVE, optionNameEng: "Whirlwind Attack (Hunter)", levelsGranted: [11] },

    // Superior Hunter's Defense (Hunter)
    { subclass: Subclasses.HUNTER_CONCLAVE, optionNameEng: "Evasion (Hunter)", levelsGranted: [15] },
    { subclass: Subclasses.HUNTER_CONCLAVE, optionNameEng: "Stand Against the Tide (Hunter)", levelsGranted: [15] },
    { subclass: Subclasses.HUNTER_CONCLAVE, optionNameEng: "Uncanny Dodge (Hunter)", levelsGranted: [15] },

    // Fighting Style (Swords)
    { subclass: Subclasses.COLLEGE_OF_SWORDS, optionNameEng: "Dueling (Swords)", levelsGranted: [3] },
    { subclass: Subclasses.COLLEGE_OF_SWORDS, optionNameEng: "Two-Weapon Fighting (Swords)", levelsGranted: [3] },

    // Armor Model (Armorer)
    { subclass: Subclasses.ARMORER, optionNameEng: "Guardian (Armor Model)", levelsGranted: [3] },
    { subclass: Subclasses.ARMORER, optionNameEng: "Infiltrator (Armor Model)", levelsGranted: [3] },

    // Elemental Disciplines (Way of the Four Elements)
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "Breath of Winter (Elemental Discipline)", levelsGranted: [17] },
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "Clench of the North Wind (Elemental Discipline)", levelsGranted: [6, 11, 17] },
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "Eternal Mountain Defense (Elemental Discipline)", levelsGranted: [11, 17] },
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "Fangs of the Fire Snake (Elemental Discipline)", levelsGranted: [3, 6, 11, 17] },
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "Fist of Four Thunders (Elemental Discipline)", levelsGranted: [3, 6, 11, 17] },
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "Fist of Unbroken Air (Elemental Discipline)", levelsGranted: [3, 6, 11, 17] },
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "Flames of the Phoenix (Elemental Discipline)", levelsGranted: [11, 17] },
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "Gong of the Summit (Elemental Discipline)", levelsGranted: [6, 11, 17] },
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "Mist Stance (Elemental Discipline)", levelsGranted: [11, 17] },
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "Ride the Wind (Elemental Discipline)", levelsGranted: [11, 17] },
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "River of Hungry Flame (Elemental Discipline)", levelsGranted: [17] },
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "Rush of the Gale Spirits (Elemental Discipline)", levelsGranted: [3, 6, 11, 17] },
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "Shape the Flowing River (Elemental Discipline)", levelsGranted: [3, 6, 11, 17] },
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "Sweeping Cinder Strike (Elemental Discipline)", levelsGranted: [3, 6, 11, 17] },
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "Water Whip (Elemental Discipline)", levelsGranted: [3, 6, 11, 17] },
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, optionNameEng: "Wave of Rolling Earth (Elemental Discipline)", levelsGranted: [17] },
  ]

  for (const option of newChoiceOptions) {
    const feature = await prisma.feature.findUnique({ where: { engName: option.featureEngName } })
    if (!feature) {
      console.warn(`Feature ${option.featureEngName}     ${option.optionNameEng}`)
      continue
    }

    const choice = await prisma.choiceOption.upsert({
      where: { optionNameEng: option.optionNameEng },
      update: {
        groupName: option.groupName,
        optionName: option.optionName,
      },
      create: {
        groupName: option.groupName,
        optionName: option.optionName,
        optionNameEng: option.optionNameEng,
      },
    })

    //   feature <-> choiceOption,   
    await prisma.choiceOptionFeature.deleteMany({ where: { choiceOptionId: choice.choiceOptionId } })
    await prisma.choiceOptionFeature.create({
      data: {
        choiceOptionId: choice.choiceOptionId,
        featureId: feature.featureId,
      },
    })
  }

  //     
  for (const link of subclassLinks) {
    const subclass = await prisma.subclass.findFirst({ where: { name: link.subclass } })
    const choiceOption = await prisma.choiceOption.findUnique({ where: { optionNameEng: link.optionNameEng } })
    if (!subclass || !choiceOption) {
      console.warn(` SubclassChoiceOption  ${link.subclass} -> ${link.optionNameEng}`)
      continue
    }

    const existing = await prisma.subclassChoiceOption.findFirst({
      where: { subclassId: subclass.subclassId, choiceOptionId: choiceOption.choiceOptionId },
    })

    const data = {
      subclassId: subclass.subclassId,
      choiceOptionId: choiceOption.choiceOptionId,
      levelsGranted: link.levelsGranted,
    }

    if (existing) {
      await prisma.subclassChoiceOption.update({
        where: { optionId: existing.optionId },
        data,
      })
    } else {
      await prisma.subclassChoiceOption.create({ data })
    }
  }

  console.log(".    .")
}
</file>

<file path="prisma/schema.prisma">
generator client {
  provider = "prisma-client-js"
  engine   = "js"
}

datasource db {
  provider = "postgresql"
}
</file>

<file path="src/app/page.tsx">
"use client";

import Link from "next/link";
import Image from "next/image";
import { motion } from "framer-motion";

const containerVariants = {
  hidden: {
    opacity: 0,
  },
  show: {
    opacity: 1,
    transition: {
      staggerChildren: 0.18,
      delayChildren: 0.1,
    },
  },
} as const;

const cardVariants = {
  hidden: {
    opacity: 0,
    y: 28,
  },
  show: {
    opacity: 1,
    y: 0,
    transition: {
      duration: 0.7,
      ease: [0.22, 1, 0.36, 1],
    },
  },
} as const;

const textVariants = {
  hidden: {
    opacity: 0,
    y: 10,
  },
  show: {
    opacity: 1,
    y: 0,
    transition: {
      duration: 0.6,
      delay: 0.15,
      ease: [0.22, 1, 0.36, 1],
    },
  },
} as const;

type HomeCard = {
  href: string;
  title: string;
  imageSrc: string;
  priority?: boolean;
  objectClassName?: string;
};

const cards: HomeCard[] = [
  {
    href: "/pers/home",
    title: "",
    imageSrc: "/images/home-characters.webp",
    priority: true,
    objectClassName: "object-center",
  },
  {
    href: "/spells",
    title: "",
    imageSrc: "/images/home-spells.webp",
    priority: true,
    objectClassName: "object-[center_85%]",
  },
];

export default function Page() {

  return (
    <motion.main
      className="h-[100dvh] w-full overflow-hidden"
      variants={containerVariants}
      initial="hidden"
      animate="show"
    >
      <div className="flex h-full flex-col md:flex-row">
        {cards.map((card, index) => (
          <Link key={card.href} href={card.href} className="group relative flex-1 overflow-hidden">
            <motion.div className="h-full" variants={cardVariants}>
              <div className="glass-card relative h-full w-full overflow-hidden transition-transform duration-300 ease-out md:group-hover:-translate-y-4">
                <Image
                  src={card.imageSrc}
                  alt={card.title}
                  fill
                  priority={card.priority}
                  sizes="(max-width: 768px) 100vw, 50vw"
                  className={`object-cover ${card.objectClassName ?? "object-center"} grayscale saturate-[0.4] opacity-80 transition-all duration-300 ease-out group-hover:grayscale-0 group-hover:saturate-100 group-hover:opacity-100 group-hover:brightness-110`}
                />
                <div className="absolute inset-0 bg-background/30" />

                <div className="relative z-10 flex h-full items-center justify-center p-10">
                  <motion.h1
                    className="font-rpg-display text-center text-4xl uppercase tracking-[0.15em] text-foreground md:text-6xl md:tracking-[0.22em] lg:text-7xl"
                    variants={textVariants}
                    transition={{ ...textVariants.show.transition, delay: 0.25 + index * 0.08 }}
                  >
                    {card.title}
                  </motion.h1>
                </div>
              </div>
            </motion.div>
          </Link>
        ))}
      </div>
    </motion.main>
  );
}
</file>

<file path="src/components/ui/App.tsx">
import React from "react";

export const App = ({ children }: { children: React.ReactNode }) => {
  return (
    <main className="col-start-1 row-start-1 flex min-h-full w-full flex-col items-center md:col-start-2">
      { children }
    </main>
  )
}
</file>

<file path="src/components/ui/Navigation.tsx">
'use client';

import { Logo } from "@/lib/components/icons/Logo";
import Link from "next/link";
import { Suspense } from "react";
import { usePathname } from "next/navigation";
import { Home, Sparkles, LogIn, LogOut } from "lucide-react";
import { signOut, useSession } from "next-auth/react";
import { cn } from "@/lib/utils";
import GoogleAuthDialog from "@/lib/components/auth/GoogleAuthDialog";
import { useState } from "react";
import Image from "next/image";

export const Navigation = () => {
  const pathname = usePathname();
  const { data: session } = useSession();
  const [authOpen, setAuthOpen] = useState(false);

  const navLinks = [
    { href: "/", icon: Home, label: "" },
    { href: "/spells", icon: Sparkles, label: "" },
    { href: "/pers/home", icon: "dragon", label: "" },
  ];

  return (
    <nav className="fixed bottom-0 left-0 z-50 flex w-full flex-row items-center justify-around gap-2 border-t border-white/5 bg-slate-950/40 px-4 py-3 backdrop-blur-xl md:sticky md:top-0 md:h-screen md:w-20 md:flex-col md:justify-between md:border-t-0 md:border-r md:py-8">
      
      {/* Top Section: Logo & Main Links */}
      <div className="flex flex-row items-center gap-4 md:flex-col md:gap-8">
        <Link
          href="/"
          aria-label=""
          className="flex h-10 w-10 items-center justify-center rounded-2xl bg-gradient-to-br from-teal-500/20 to-violet-500/20 shadow-lg ring-1 ring-white/10 transition-transform hover:scale-105 active:scale-95 md:h-12 md:w-12"
        >
          <Logo className="h-7 w-7 md:h-8 md:w-8" />
        </Link>

        <div className="flex flex-row gap-2 md:flex-col md:gap-4">
          {navLinks.map((link) => {
            const isActive =
              link.href === "/" ? pathname === "/" : pathname.startsWith(link.href);

            return (
              <Link
                key={link.href}
                href={link.href}
                aria-label={link.label}
                className={cn(
                  "relative flex w-16 flex-col items-center justify-center gap-1 rounded-xl py-2 transition-all duration-300",
                  isActive
                    ? "bg-teal-500/10 text-teal-400 ring-1 ring-teal-500/30 shadow-[inset_0_0_10px_rgba(45,212,191,0.2)]"
                    : "text-slate-400 hover:bg-white/5 hover:text-slate-200"
                )}
              >
                {link.icon === "dragon" ? (
                  <Image
                    src="/images/dragon.png"
                    alt=""
                    width={24}
                    height={24}
                    className={cn(
                      "h-6 w-6",
                      isActive && "drop-shadow-[0_0_5px_rgba(45,212,191,0.5)]"
                    )}
                    priority={false}
                  />
                ) : (
                  (() => {
                    const Icon = link.icon;
                    return (
                      <Icon
                        className={cn(
                          "h-6 w-6",
                          isActive && "drop-shadow-[0_0_5px_rgba(45,212,191,0.5)]"
                        )}
                      />
                    );
                  })()
                )}
                <span className="text-[11px] leading-none">{link.label}</span>
              </Link>
            );
          })}
        </div>
      </div>

      {/* Bottom Section: Auth */}
      <div className="flex flex-row gap-4 md:flex-col md:gap-4">
        {session?.user ? (
          <button
            onClick={() => signOut({ callbackUrl: "/" })}
            aria-label=""
            className="flex w-16 flex-col items-center justify-center gap-1 rounded-xl py-2 text-rose-400/70 transition-all hover:bg-rose-500/10 hover:text-rose-400"
          >
            <LogOut className="h-6 w-6" />
            <span className="text-[11px] leading-none"></span>
          </button>
        ) : (
          <>
            <Suspense fallback={null}>
              <GoogleAuthDialog open={authOpen} onOpenChange={setAuthOpen} />
            </Suspense>
            <button
              onClick={() => setAuthOpen(true)}
              aria-label=""
              className="flex w-16 flex-col items-center justify-center gap-1 rounded-xl py-2 text-slate-400 transition-all hover:bg-white/5 hover:text-slate-200"
            >
              <LogIn className="h-6 w-6" />
              <span className="text-[11px] leading-none"></span>
            </button>
          </>
        )}
      </div>
    </nav>
  );
};
</file>

<file path="src/lib/components/characterCreator/ASIForm.tsx">
"use client";

import { useStepForm } from "@/hooks/useStepForm";
import { Ability, Classes } from "@prisma/client";
import { asiSchema } from "@/lib/zod/schemas/persCreateSchema";
import { useFieldArray, useWatch } from "react-hook-form";
import React, { useEffect, useMemo } from "react";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import { classAbilityScores } from "@/lib/refs/classesBaseASI";
import { ClassI, RaceI, RaceASI } from "@/lib/types/model-types";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Badge } from "@/components/ui/badge";
import { Minus, Plus, ArrowUp, ArrowDown, Check, AlertCircle } from "lucide-react";
import { Input } from "@/components/ui/input";
import { Switch } from "@/components/ui/switch";
import { Label } from "@/components/ui/label";
import { RaceVariant } from "@prisma/client";


interface Props {
  race: RaceI
  raceVariant?: RaceVariant | null
  selectedClass: ClassI
  prevRaceId: number | null
  setPrevRaceId: (id: number) => void;
  formId: string
  onNextDisabledChange?: (disabled: boolean) => void
}

const attributes = [
  { eng: Ability.STR, ukr: '' },
  { eng: Ability.DEX, ukr: '' },
  { eng: Ability.CON, ukr: '' },
  { eng: Ability.INT, ukr: '' },
  { eng: Ability.WIS, ukr: '' },
  { eng: Ability.CHA, ukr: '' }
];

const attributesUrkShort = [
  { eng: Ability.STR, ukr: '' }, // Strength  
  { eng: Ability.DEX, ukr: '' }, // Dexterity  
  { eng: Ability.CON, ukr: '' }, // Constitution  
  { eng: Ability.INT, ukr: '' }, // Intelligence  
  { eng: Ability.WIS, ukr: '' }, // Wisdom  
  { eng: Ability.CHA, ukr: '' }, // Charisma  
];

const asiSystems = {
  POINT_BUY: 'POINT_BUY',
  SIMPLE: 'SIMPLE',
  CUSTOM: 'CUSTOM'
}


export const ASIForm = (
  { race, raceVariant, selectedClass, prevRaceId, setPrevRaceId, formId, onNextDisabledChange }: Props
) => {
  const { updateFormData, nextStep } = usePersFormStore();
  
  const raceAsi = useMemo(() => {
    if (raceVariant?.overridesRaceASI) {
      return raceVariant.overridesRaceASI as unknown as RaceASI;
    }
    return race.ASI;
  }, [race, raceVariant]);

  const { form, onSubmit } = useStepForm(asiSchema, (data) => {
    // Save the entire ASI data object
    updateFormData({
      isDefaultASI: data.isDefaultASI,
      asiSystem: data.asiSystem,
      points: data.points,
      simpleAsi: data.simpleAsi,
      asi: data.asi,
      racialBonusChoiceSchema: data.racialBonusChoiceSchema
    });
    nextStep();
  });

  const { fields: asiFields, replace: replaceAsi } = useFieldArray({
    control: form.control,
    name: "asi",
  });
  const { fields: simpleAsiFields, replace: replaceSimpleAsi } = useFieldArray({
    control: form.control,
    name: "simpleAsi",
  });
  const { fields: customAsiFields, replace: replaceCustomAsi } = useFieldArray({
    control: form.control,
    name: "customAsi",
  });
  const watchedSimpleAsi = useWatch({
    control: form.control,
    name: 'simpleAsi'
  })

  const isDefaultASI = form.watch('isDefaultASI') || false
  const asiSystem = form.watch('asiSystem') || asiSystems.POINT_BUY
  const points = form.watch('points') || 0

  useEffect(() => {
    onNextDisabledChange?.(asiSystem === asiSystems.POINT_BUY && points < 0);
  }, [asiSystem, points, onNextDisabledChange])

  const racialBonusSchemaPath = `racialBonusChoiceSchema.${ isDefaultASI ? 'basicChoices' : 'tashaChoices' }` as const;

  const sortedSimpleAsi = useMemo(() => {
    if (!watchedSimpleAsi || watchedSimpleAsi.length === 0) {
      return [...simpleAsiFields].sort((a, b) => b.value - a.value);
    }

    const enrichedFields = simpleAsiFields.map((field, index) => ({
      ...field,
      ability: field.ability,
      value: watchedSimpleAsi[index]?.value ?? field.value
    }));

    return enrichedFields.sort((a, b) => b.value - a.value);
  }, [watchedSimpleAsi, simpleAsiFields])

  const incrementValue = (index: number) => {
    const currentValue = form.getValues(`asi.${ index }.value`) || 0;
    form.setValue('points', currentValue >= 13 ? points - 2 : points - 1, { shouldDirty: true, shouldTouch: true, shouldValidate: true })
    form.setValue(`asi.${ index }.value`, currentValue + 1, { shouldDirty: true, shouldTouch: true, shouldValidate: true })
  }
  const decrementValue = (index: number) => {
    const currentValue = form.getValues(`asi.${ index }.value`) || 0;
    if (currentValue > 8) {
      form.setValue('points', currentValue >= 14 ? points + 2 : points + 1, { shouldDirty: true, shouldTouch: true, shouldValidate: true })
      form.setValue(`asi.${ index }.value`, currentValue - 1, { shouldDirty: true, shouldTouch: true, shouldValidate: true })
    }
  }

  const swapValues = ({ sortedIndexA, isDirectionUp }: { sortedIndexA: number, isDirectionUp: boolean }) => { // index == 0-5
    if (isDirectionUp ? sortedIndexA > 0 : sortedIndexA < 5) {
      const sortedIndexB = isDirectionUp ? sortedIndexA - 1 : sortedIndexA + 1

      const itemA = sortedSimpleAsi[sortedIndexA]
      const itemB = sortedSimpleAsi[sortedIndexB]

      const originalIndexA = simpleAsiFields.findIndex(field => field.id === itemA.id);
      const originalIndexB = simpleAsiFields.findIndex(field => field.id === itemB.id);

      if (originalIndexA === -1 || originalIndexB === -1) return;

      form.setValue(`simpleAsi.${ originalIndexA }.value`, itemB.value, {
        shouldTouch: true,
        shouldDirty: true,
        shouldValidate: true
      });

      form.setValue(`simpleAsi.${ originalIndexB }.value`, itemA.value, {
        shouldTouch: true,
        shouldDirty: true,
        shouldValidate: true
      });
    }
  }

  const handleToggleRacialBonus = ({ groupIndex, choiceCount, ability }: {
    groupIndex: number,
    choiceCount: number,
    ability: Ability
  }) => {
    const schemaPath = racialBonusSchemaPath;

    const groups: {
      groupIndex: number;
      choiceCount: number;
      selectedAbilities: Ability[];
    }[] = form.getValues(schemaPath) || []

    const arrayIndex = groups.findIndex((g) => g.groupIndex === groupIndex)

    if (arrayIndex !== -1) {
      const currentAbilities = groups[arrayIndex]?.selectedAbilities ?? []
      const hasAbility = currentAbilities.includes(ability)

      if (!hasAbility && currentAbilities.length >= choiceCount) return null

      const newAbilities = hasAbility
        ? currentAbilities.filter((a) => a !== ability)
        : [...currentAbilities, ability]

      const nextGroups = groups.map((g, idx) =>
        idx === arrayIndex
          ? {
              ...g,
              choiceCount,
              selectedAbilities: newAbilities,
            }
          : g
      )

      form.setValue(schemaPath, nextGroups, {
        shouldDirty: true,
        shouldTouch: true,
        shouldValidate: true,
      })
      return
    }

    const newGroup = {
      groupIndex,
      choiceCount,
      selectedAbilities: [ability],
    }
    form.setValue(schemaPath, [...groups, newGroup], {
      shouldDirty: true,
      shouldTouch: true,
      shouldValidate: true,
    })
  }

  const getRacialBonusGroup = (groupIndex: number) => {
    const groups: {
      groupIndex: number;
      choiceCount: number;
      selectedAbilities: Ability[];
    }[] = form.getValues(racialBonusSchemaPath) || []
    return groups.find((g) => g.groupIndex === groupIndex)
  }

  const isRacialBonusSelected = (groupIndex: number, ability: Ability) => {
    const group = getRacialBonusGroup(groupIndex)
    return (group?.selectedAbilities ?? []).includes(ability)
  }

  const getCurrentSelectedCount = (groupIndex: number) => {
    const group = getRacialBonusGroup(groupIndex)
    return (group?.selectedAbilities ?? []).length
  }

  useEffect(() => {
    if (selectedClass) {
      const defaultClassASI = classAbilityScores[selectedClass.name as Classes]
      if (defaultClassASI) {
        const currentAsi = form.getValues('asi')
        const currentSimpleAsi = form.getValues('simpleAsi')
        const currentCustomAsi = form.getValues('customAsi')

        if (!currentAsi || currentAsi.length === 0) {
          replaceAsi(defaultClassASI.map(asi => ({
            ability: asi.ability,
            value: asi.value,
          })));
        }
        if (!currentSimpleAsi || currentSimpleAsi.length === 0) {
          replaceSimpleAsi(defaultClassASI.map(asi => ({
            ability: asi.ability,
            value: asi.value,
          })));
        }
        if (!currentCustomAsi || currentCustomAsi.length === 0) {
          replaceCustomAsi(defaultClassASI.map(asi => ({
            ability: asi.ability,
            value: String(asi.value),
          })));
        }
      }
    }
  }, [selectedClass, replaceAsi, replaceSimpleAsi, replaceCustomAsi, form])

  useEffect(() => {
    form.register('points')

    const p = form.getValues('points');
    if (typeof p !== 'number') {
      form.setValue('points', 0, { shouldDirty: false, shouldTouch: false })
    }
  }, [form])

  useEffect(() => {form.register('racialBonusChoiceSchema')},
    [form])

  useEffect(() => {
    if (prevRaceId !== null && prevRaceId !== race.raceId) {
      form.setValue(`racialBonusChoiceSchema.tashaChoices`, [])
      form.setValue(`racialBonusChoiceSchema.basicChoices`, [])
    }

    setPrevRaceId(race.raceId)
  }, [form, prevRaceId, race.raceId, setPrevRaceId])

  const racialBonusGroups = useMemo(() => {
    return isDefaultASI
      ? raceAsi.basic?.flexible?.groups
      : raceAsi.tasha?.flexible.groups
  }, [isDefaultASI, raceAsi])

  const systemCopy: Record<string, string> = {
    [asiSystems.POINT_BUY]: '        .',
    [asiSystems.SIMPLE]: '         .',
    [asiSystems.CUSTOM]: ' :  -  ,     .',
  }

  return (
    <form id={formId} onSubmit={onSubmit} className="w-full space-y-6">
      <Card className="shadow-xl">
        <CardHeader className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div className="space-y-1">
            <CardTitle className="text-xl text-white md:text-2xl"> </CardTitle>
          </div>
        </CardHeader>

        <CardContent className="space-y-4">
          <input type="hidden" {...form.register('asiSystem')} value={asiSystem} />

          {asiFields.map((field, index) => (
            <React.Fragment key={field.id}>
              <input type="hidden" {...form.register(`asi.${index}.ability`)} />
              <input type="hidden" {...form.register(`asi.${index}.value`, { valueAsNumber: true })} />
            </React.Fragment>
          ))}

          {simpleAsiFields.map((field, index) => (
            <React.Fragment key={field.id}>
              <input type="hidden" {...form.register(`simpleAsi.${index}.ability`)} />
              <input type="hidden" {...form.register(`simpleAsi.${index}.value`, { valueAsNumber: true })} />
            </React.Fragment>
          ))}

          {customAsiFields.map((field, index) => (
            <React.Fragment key={field.id}>
              <input type="hidden" {...form.register(`customAsi.${index}.ability`)} />
              <input type="hidden" {...form.register(`customAsi.${index}.value`)} />
            </React.Fragment>
          ))}

          <Tabs
            value={asiSystem}
            onValueChange={(value) => form.setValue('asiSystem', value)}
            className="w-full"
          >
            <TabsList className="grid w-full grid-cols-3 bg-white/5 text-slate-300">
              <TabsTrigger
                value={asiSystems.POINT_BUY}
                className="data-[state=active]:bg-white/7 data-[state=active]:text-white"
              >
                 
              </TabsTrigger>
              <TabsTrigger
                value={asiSystems.SIMPLE}
                className="data-[state=active]:bg-white/7 data-[state=active]:text-white"
              >
                
              </TabsTrigger>
              <TabsTrigger
                value={asiSystems.CUSTOM}
                className="data-[state=active]:bg-white/7 data-[state=active]:text-white"
              >
                
              </TabsTrigger>
            </TabsList>

            <p className="mt-3 text-sm text-slate-400">{systemCopy[asiSystem]}</p>

            <TabsContent value={asiSystems.POINT_BUY} className="space-y-4">
              <div className="grid gap-3 md:grid-cols-2">
                {asiFields.map((field, index) => {
                  const attr = attributes.find((a) => a.eng === field.ability);
                  const currentValue = form.watch(`asi.${index}.value`) || field.value;
                  const bonus = Math.floor((currentValue - 10) / 2)

                  return (
                    <Card
                      key={field.id}
                      className="shadow-sm transition hover:-translate-y-0.5 hover:ring-1 hover:ring-white/10"
                    >
                      <CardHeader className="flex flex-row items-center justify-between pb-2">
                        <div>
                          <p className="text-xs uppercase tracking-wide text-slate-400">{attr?.ukr || field.ability}</p>
                        </div>
                        <Badge variant="outline" className="border-white/15 bg-white/5 text-slate-200">
                          {bonus > 0 ? `+${bonus}` : bonus}
                        </Badge>
                      </CardHeader>
                      <CardContent className="flex items-center justify-between pt-0">
                        <Button
                          type="button"
                          variant="outline"
                          size="icon"
                          onClick={() => decrementValue(index)}
                          disabled={(currentValue as number) <= 8}
                          className="border-indigo-500/60 bg-indigo-500/10 text-indigo-50 hover:bg-indigo-500/20"
                        >
                          <Minus className="h-4 w-4" />
                        </Button>
                        <div className="rounded-lg border border-white/10 bg-white/5 px-4 py-2 text-lg font-semibold text-white">
                          {currentValue as number}
                        </div>
                        <Button
                          type="button"
                          variant="outline"
                          size="icon"
                          onClick={() => incrementValue(index)}
                          disabled={(currentValue as number) > 14}
                          className="border-emerald-400/60 bg-emerald-500/10 text-emerald-50 hover:bg-emerald-500/20"
                        >
                          <Plus className="h-4 w-4" />
                        </Button>
                      </CardContent>
                    </Card>
                  );
                })}
              </div>
              <div className="flex items-center justify-between rounded-lg border border-white/10 bg-white/5 px-4 py-3 text-sm">
                <span className="text-slate-300"> </span>
                <Badge
                  variant="outline"
                  className={`px-3 text-base ${points < 0 ? 'border-red-500/60 text-red-200' : 'border-emerald-500/50 text-emerald-200'}`}
                >
                  {points}
                </Badge>
              </div>
            </TabsContent>

            <TabsContent value={asiSystems.SIMPLE} className="space-y-3">
              <div className="flex flex-col gap-2">
                {sortedSimpleAsi.map((field, sortedIndex) => {
                  const attr = attributes.find((a) => a.eng === field.ability);
                  const currentValue = field.value;
                  return (
                    <Card
                    key={field.id}
                    className="shadow-sm transition hover:-translate-y-0.5 hover:ring-1 hover:ring-white/10 p-2"
                  >
                    <CardContent className="flex items-center justify-between gap-1 pt-0 pb-1">
                      <Button
                        type="button"
                        variant="outline"
                        size="icon"
                        className="h-6 w-6 border-indigo-500/60 bg-indigo-500/10 text-indigo-50 hover:bg-indigo-500/20"
                        onClick={() => swapValues({ sortedIndexA: sortedIndex, isDirectionUp: true })}
                        disabled={sortedIndex === 0 || currentValue >= 15}
                      >
                        <ArrowUp className="h-3 w-3" />
                      </Button>
                  
                      <div className="flex flex-col items-center justify-center">
                        <p className="text-[10px] uppercase tracking-wide text-slate-400">{attr?.ukr || field.ability}</p>
                        <p className="text-lg font-semibold text-white leading-none">{currentValue}</p>
                      </div>
                  
                      <Button
                        type="button"
                        variant="outline"
                        size="icon"
                        className="h-6 w-6 border-emerald-500/60 bg-emerald-500/10 text-emerald-50 hover:bg-emerald-500/20"
                        onClick={() => swapValues({ sortedIndexA: sortedIndex, isDirectionUp: false })}
                        disabled={sortedIndex === sortedSimpleAsi.length - 1 || currentValue <= 8}
                      >
                        <ArrowDown className="h-3 w-3" />
                      </Button>
                    </CardContent>
                  </Card>
                  );
                })}
              </div>
            </TabsContent>

            <TabsContent value={asiSystems.CUSTOM} className="space-y-3">
              <div className="grid gap-3 md:grid-cols-2">
                {customAsiFields.map((field, index) => {
                  const attr = attributes.find((a) => a.eng === field.ability);
                  const currentValue = form.watch(`customAsi.${index}.value`);
                  // const shortName = attributesUrkShort.find((a) => a.eng === field.ability)?.ukr || attr?.ukr;

                  return (
                    <Card
                      key={field.id}
                      className="shadow-sm transition hover:-translate-y-0.5 hover:ring-1 hover:ring-white/10"
                    >
                      <CardHeader className="flex items-center justify-between pb-2">
                        <div>
                          <p className="text-xs uppercase tracking-wide text-slate-400">{attr?.ukr || field.ability}</p>
                        </div>
                      </CardHeader>
                      <CardContent className="pt-0">
                        <Input
                          type="number"
                          inputMode="numeric"
                          placeholder="14"
                          value={currentValue ?? ''}
                          onChange={(e) => form.setValue(`customAsi.${index}.value`, e.target.value)}
                          className="border-white/10 bg-white/5 text-white focus-visible:ring-cyan-400/30"
                        />
                      </CardContent>
                    </Card>
                  );
                })}
              </div>
            </TabsContent>
          </Tabs>
        </CardContent>
      </Card>

      <Card className="shadow-xl">
        <CardHeader>
          <CardTitle className="text-white"> </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {form.formState.errors.racialBonusChoiceSchema && (
            <div className="flex items-center gap-2 rounded-lg border border-red-500/30 bg-red-500/10 px-3 py-2 text-sm text-red-100">
              <AlertCircle className="h-4 w-4" />
              <span>{form.formState.errors.racialBonusChoiceSchema.message}</span>
            </div>
          )}

          {racialBonusGroups?.length ? (
            racialBonusGroups.map((group, index) => (
              <div
                key={index}
                className="glass-panel border-gradient-rpg rounded-xl p-4"
              >
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-semibold text-white">{group.groupName}</p>
                    <p className="text-xs text-slate-400"> {group.choiceCount}</p>
                  </div>
                  <Badge variant="secondary" className="bg-white/5 text-white">
                    +{group.value}
                  </Badge>
                </div>

                <div className="mt-3 grid grid-cols-2 gap-2 sm:grid-cols-3">
                  {attributesUrkShort.map((attr, i) => {
                    const isSelected = isRacialBonusSelected(index, attr.eng);
                    const currentCount = getCurrentSelectedCount(index);
                    const isMaxReached = currentCount >= group.choiceCount;
                    const formGroups: {
                      groupIndex: number;
                      choiceCount: number;
                      selectedAbilities: Ability[];
                    }[] = form.getValues(racialBonusSchemaPath) || [];

                    const currentGroup = formGroups.find((g) => g.groupIndex === index);

                    const uniqueDisabled = isDefaultASI
                      ? (
                        raceAsi.basic?.simple
                        && (raceAsi.basic?.flexible?.groups?.length ?? 0) > 0
                        && (raceAsi.basic?.flexible?.groups?.every((flexGroup) => flexGroup.unique))
                        && (Object.keys(raceAsi.basic?.simple ?? {}).includes(attr.eng))
                      )
                      : (
                        (raceAsi.tasha?.flexible.groups.length ?? 0) > 1
                        && (raceAsi.tasha?.flexible?.groups?.every((flexGroup) => flexGroup.unique))
                        && (formGroups?.some((flexGroup) =>
                          (flexGroup.groupIndex !== (currentGroup?.groupIndex ?? index))
                          && (flexGroup.selectedAbilities.includes(attr.eng))
                        ))
                      );

                    const isDisabled = (!isSelected && isMaxReached) || uniqueDisabled;

                    return (
                      <Button
                        key={i}
                        type="button"
                        variant={isSelected ? 'secondary' : 'outline'}
                        className={`justify-between border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white ${isSelected ? 'border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100' : ''} ${isDisabled ? 'opacity-60' : ''}`}
                        disabled={isDisabled}
                        onClick={() =>
                          handleToggleRacialBonus({
                            groupIndex: index,
                            choiceCount: group.choiceCount,
                            ability: attr.eng,
                          })
                        }
                      >
                        <span className="text-sm">{attr.ukr}</span>
                        {isSelected && <Check className="h-4 w-4" />}
                      </Button>
                    );
                  })}
                </div>
              </div>
            ))
          ) : (
            <p className="text-sm text-slate-400">     .</p>
          )}

          {isDefaultASI && Object.entries(raceAsi.basic?.simple || {}).length > 0 && (
            <div className="grid gap-3 sm:grid-cols-2">
              {Object.entries(raceAsi.basic?.simple || {}).map(([attrEng, value], index) => {
                const attr = attributes.find((a) => a.eng === attrEng);

                return (
                  <div
                    key={index}
                    className="flex items-center justify-between rounded-lg border border-white/10 bg-white/5 px-4 py-3"
                  >
                    <span className="font-semibold text-white">{attr?.ukr}</span>
                    <Badge variant="outline" className="border-white/15 bg-white/5 text-slate-100">
                      +{value}
                    </Badge>
                  </div>
                );
              })}
            </div>
          )}
        </CardContent>
      </Card>

      <div className="glass-panel border-gradient-rpg space-y-3 rounded-2xl p-4">
        <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <p className="text-sm font-semibold text-white">  </p>
            <p className="text-xs text-slate-400">,        .</p>
          </div>
          <div className="flex items-center gap-3">
            <input
              type="checkbox"
              className="sr-only"
              {...form.register('isDefaultASI')}
              checked={isDefaultASI}
              onChange={(event) => form.setValue('isDefaultASI', event.target.checked)}
            />
            <Switch
              id="isDefaultASI"
              checked={isDefaultASI}
              onCheckedChange={(checked) => form.setValue('isDefaultASI', checked)}
            />
            <Label htmlFor="isDefaultASI" className="text-slate-200">
              
            </Label>
          </div>
        </div>
        <p className="text-xs text-right text-slate-500">
              .
        </p>
      </div>
    </form>
  )
};

export default ASIForm;
</file>

<file path="src/lib/components/characterCreator/CharacterCreateHeader.tsx">
"use client";

import { ArrowLeftRight, LogIn } from "lucide-react";
import { Button } from "@/components/ui/button";

interface Props {
  onReset: () => void;
  onOpenAuth: () => void;
  isAuthenticated?: boolean;
}

export const CharacterCreateHeader = ({ onReset, onOpenAuth, isAuthenticated = false }: Props) => {
  return (
    <div className="glass-panel border-gradient-rpg w-full rounded-2xl px-3 py-4 sm:px-4 sm:py-4 md:px-6 md:py-5">
      <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between md:gap-4">
        <div className="space-y-1">
          <h1 className="font-rpg-display text-xl font-semibold uppercase tracking-widest text-slate-200 sm:text-2xl md:text-3xl">
             
          </h1>
        </div>

        <div className="flex items-center gap-3">
          <Button
            variant="ghost"
            size="sm"
            className="border border-white/10 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white"
            onClick={onReset}
          >
            <ArrowLeftRight className="mr-2 h-4 w-4" />
            
          </Button>
          {!isAuthenticated && (
            <Button
              variant="secondary"
              className="border border-white/15 bg-white/5 text-white hover:bg-white/10"
              onClick={onOpenAuth}
            >
              <LogIn className="mr-2 h-4 w-4" />
              
            </Button>
          )}
        </div>
      </div>
    </div>
  );
};
</file>

<file path="src/lib/components/characterCreator/ClassChoiceOptionsForm.tsx">
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { ClassI } from "@/lib/types/model-types";
import { useStepForm } from "@/hooks/useStepForm";
import { classChoiceOptionsSchema } from "@/lib/zod/schemas/persCreateSchema";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { classTranslations, classTranslationsEng } from "@/lib/refs/translation";
import { translateValue } from "@/lib/components/characterCreator/infoUtils";
import clsx from "clsx";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import { Button } from "@/components/ui/button";
import { HelpCircle } from "lucide-react";
import { ControlledInfoDialog, InfoSectionTitle } from "@/lib/components/characterCreator/EntityInfoDialog";
import { FormattedDescription } from "@/components/ui/FormattedDescription";

const stripMarkdownPreview = (value: string) => {
  return value
    .replace(/\r\n/g, "\n")
    .replace(/<a\s+[^>]*>(.*?)<\/a>/gi, "$1")
    .replace(/<[^>]+>/g, " ")
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, "$1")
    .replace(/`{1,3}([^`]+)`{1,3}/g, "$1")
    .replace(/\*\*([^*]+)\*\*/g, "$1")
    .replace(/__([^_]+)__/g, "$1")
    .replace(/\*([^*]+)\*/g, "$1")
    .replace(/_([^_]+)_/g, "$1")
    .replace(/^#{1,6}\s+/gm, "")
    .replace(/^>\s?/gm, "")
    .replace(/^\s*[-*+]\s+/gm, "")
    .replace(/^\s*\d+\.\s+/gm, "")
    .replace(/\s+/g, " ")
    .trim();
};

interface Props {
  selectedClass?: ClassI | null;
  availableOptions?: ClassI["classChoiceOptions"];
  formId: string;
  onNextDisabledChange?: (disabled: boolean) => void;
}

const displayName = (cls?: ClassI | null) =>
  cls ? classTranslations[cls.name] || classTranslationsEng[cls.name] || cls.name : "";

const isEnumLike = (value?: string | null) => !!value && /^[A-Z0-9_]+$/.test(value);

const ClassChoiceOptionsForm = ({ selectedClass, availableOptions, formId, onNextDisabledChange }: Props) => {
  const { updateFormData, nextStep } = usePersFormStore();

  const [infoOpen, setInfoOpen] = useState(false);
  const [infoTitle, setInfoTitle] = useState<string>("");
  const [infoFeatures, setInfoFeatures] = useState<Array<{ name: string; description: string; shortDescription?: string | null }>>([]);
  
  const { form, onSubmit } = useStepForm(classChoiceOptionsSchema, (data) => {
    updateFormData({ classChoiceSelections: data.classChoiceSelections });
    nextStep();
  });
  
  const selections = form.watch("classChoiceSelections") || {};
  const prevDisabledRef = useRef<boolean | undefined>(undefined);

  const optionsToUse = useMemo(() => {
      if (availableOptions) return availableOptions;
      return (selectedClass?.classChoiceOptions || []).filter((opt) => (opt.levelsGranted || []).includes(1));
  }, [selectedClass, availableOptions]);

  const groupedOptions = useMemo(() => {
    const groups: Record<string, typeof optionsToUse> = {};
    optionsToUse.forEach((opt) => {
      const key = opt.choiceOption.groupName || "";
      if (!groups[key]) groups[key] = [];
      groups[key].push(opt);
    });
    return Object.entries(groups).map(([groupName, options]) => ({ groupName, options }));
  }, [optionsToUse]);

  useEffect(() => {
    let disabled: boolean;

    if (!selectedClass) {
      disabled = true;
    } else if (!groupedOptions.length) {
      disabled = false;
    } else {
      disabled = groupedOptions.some(({ groupName }) => !selections[groupName]);
    }

    if (prevDisabledRef.current !== disabled) {
      prevDisabledRef.current = disabled;
      onNextDisabledChange?.(disabled);
    }
  }, [selectedClass, groupedOptions, selections, onNextDisabledChange]);

  useEffect(() => {
    updateFormData({ classChoiceSelections: selections });
  }, [selections, updateFormData]);

  const selectOption = (groupName: string, optionId: number) => {
    const next = { ...(selections || {}), [groupName]: optionId };
    form.setValue("classChoiceSelections", next, { shouldDirty: true });
  };

  const openFeaturesInfo = (
    title: string,
    features?: ClassI["classChoiceOptions"][number]["choiceOption"]["features"]
  ) => {
    const normalized = (features || [])
      .map((item) => item.feature)
      .filter(Boolean)
      .map((feat) => ({
        name: String((feat as any).name ?? ""),
        description: String((feat as any).description ?? ""),
        shortDescription: (feat as any).shortDescription ?? null,
      }))
      .filter((feat) => feat.name);

    setInfoTitle(title);
    setInfoFeatures(normalized);
    setInfoOpen(true);
  };

  if (!selectedClass && !availableOptions) {
    return (
      <Card className="p-4 text-center text-slate-200">
          .
      </Card>
    );
  }

  if (!groupedOptions.length) {
    return (
      <Card className="p-4 text-center text-slate-200">
         1  {displayName(selectedClass)}    .   .
      </Card>
    );
  }

  return (
    <form id={formId} onSubmit={onSubmit} className="space-y-4">
      <div className="space-y-1 text-center">
        <p className="text-sm font-semibold text-slate-300"> 1</p>
        <h2 className="font-rpg-display text-3xl font-semibold uppercase tracking-widest text-slate-200 sm:text-4xl"> </h2>
        <p className="text-sm text-slate-400">
          {displayName(selectedClass)}  .  ,    .
        </p>
      </div>

      <div className="space-y-4">
        {groupedOptions.map(({ groupName, options }) => (
          <Card
            key={groupName}
            className=""
          >
            <CardContent className="space-y-3 p-4">
              <div className="flex items-center justify-between gap-3">
                <div>
                  <p className="text-xs uppercase tracking-[0.14em] text-slate-400"></p>
                  <p className="text-base font-semibold text-white">{groupName}</p>
                </div>
                <Badge variant="outline" className="border-white/15 bg-white/5 text-slate-200">
                   1
                </Badge>
              </div>

              <div className="grid gap-3 sm:grid-cols-2">
                {options.map((opt) => {
                  const optionId = opt.optionId ?? opt.choiceOptionId;
                  const selected = selections[groupName] === optionId;
                  const ukrLabel = opt.choiceOption.optionName;
                  const engLabel = opt.choiceOption.optionNameEng;
                  const label = ukrLabel || (isEnumLike(engLabel) ? translateValue(engLabel) : engLabel);

                  const featureObjects = (opt.choiceOption.features || [])
                    .map((item) => item.feature)
                    .filter(Boolean) as Array<{ shortDescription?: string | null; description?: string | null }>;

                  const previewText =
                    featureObjects.find((f) => (f.shortDescription ?? "").trim())?.shortDescription ||
                    featureObjects.find((f) => (f.description ?? "").trim())?.description ||
                    "";

                  return (
                    <Card
                      key={optionId}
                      className={clsx(
                        "glass-card cursor-pointer transition-all duration-200",
                        selected ? "glass-active" : ""
                      )}
                      onClick={() => selectOption(groupName, optionId)}
                    >
                      <CardContent className="flex h-full flex-col gap-2 p-3 sm:p-4">
                        <div className="flex items-center justify-between gap-2">
                          <p className="truncate text-sm font-semibold text-white">{label}</p>

                          <div className="flex items-center gap-2">
                            <div
                              onPointerDown={(e) => {
                                e.stopPropagation();
                              }}
                              onClick={(e) => {
                                e.stopPropagation();
                              }}
                            >
                              <Button
                                type="button"
                                size="icon"
                                variant="secondary"
                                className="glass-panel border-gradient-rpg h-8 w-8 rounded-full text-slate-100 transition-all duration-200 hover:text-white focus-visible:ring-cyan-400/30"
                                aria-label={`  ${label}`}
                                //  ControlledInfoDialog  EntityInfoDialog.tsx     .
                                onClick={() => openFeaturesInfo(label || "", opt.choiceOption.features)}
                              >
                                <HelpCircle className="h-4 w-4" />
                              </Button>
                            </div>

                            <Badge
                              variant={selected ? "secondary" : "outline"}
                              className={clsx(
                                "border-white/15 bg-white/5 text-slate-200",
                                selected && "text-slate-100"
                              )}
                            >
                              {selected ? "" : ""}
                            </Badge>
                          </div>
                        </div>

                        {previewText ? (
                          <p className="text-sm text-slate-400 line-clamp-2">
                            {stripMarkdownPreview(String(previewText))}
                          </p>
                        ) : null}
                      </CardContent>
                    </Card>
                  );
                })}
              </div>
            </CardContent>
          </Card>
        ))}
      </div>

      <ControlledInfoDialog
        open={infoOpen}
        onOpenChange={setInfoOpen}
        title={infoTitle || ""}
        subtitle={infoFeatures.length ? `: ${infoFeatures.length}` : undefined}
        contentClassName="max-w-2xl border border-white/10 bg-slate-900/95 backdrop-blur text-slate-50"
      >
        {infoFeatures.length ? (
          <div className="space-y-3">
            <InfoSectionTitle></InfoSectionTitle>
            <div className="space-y-3">
              {infoFeatures.map((feat) => (
                <div key={feat.name} className="rounded-lg border border-white/10 bg-white/5 p-3">
                  <div className="text-sm font-semibold text-white">{feat.name}</div>
                  {feat.description ? (
                    <FormattedDescription
                      content={feat.description}
                      className="mt-2 text-slate-200/90"
                    />
                  ) : null}
                </div>
              ))}
            </div>
          </div>
        ) : (
          <div className="text-sm text-slate-400"> </div>
        )}
      </ControlledInfoDialog>
    </form>
  );
};

export default ClassChoiceOptionsForm;
</file>

<file path="src/lib/components/characterCreator/infoUtils.ts">
import { Ability, ArmorType, Language, Size, WeaponCategory, WeaponType, Skills } from "@prisma/client";

import {
  LanguageTranslations,
  SizeTranslations,
  armorTranslations,
  attributesUkrFull,
  engEnumSkills,
  featTranslations,
  weaponTranslations,
  subraceTranslations,
  variantTranslations,
  subclassTranslations,
  sourceTranslations,
  toolTranslations,
  armorTypeTranslations,
  weaponTypeTranslations,
  backgroundTranslations,
  spellSchoolTranslations,
  damageTypeTranslations,
  raceTranslations,
  classTranslations,
} from "@/lib/refs/translation";
import { MulticlassReqs, SkillProficiencies, ToolProficiencies, WeaponProficiencies } from "@/lib/types/model-types";

const capitalize = (value: string) => value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();

const abilityTranslations = attributesUkrFull;

const skillTranslations: Record<Skills, string> = Object.fromEntries(
  engEnumSkills.map(({ eng, ukr }) => [eng, ukr])
) as Record<Skills, string>;

export const prettifyEnum = (value?: string | number | null) => {
  if (value === undefined || value === null) return "";
  return String(value)
    .split("_")
    .filter(Boolean)
    .map(capitalize)
    .join(" ");
};

export const translateValue = (value?: string | number | null): string => {
  if (value === undefined || value === null) return "";
  const key = String(value);

  if ((abilityTranslations as Record<string, string>)[key]) return abilityTranslations[key as Ability];
  if (SizeTranslations[key]) return SizeTranslations[key];
  if (LanguageTranslations[key]) return LanguageTranslations[key];
  if (armorTranslations[key as keyof typeof armorTranslations]) return armorTranslations[key as keyof typeof armorTranslations];
  if (weaponTranslations[key as keyof typeof weaponTranslations])
    return weaponTranslations[key as keyof typeof weaponTranslations];
  if ((skillTranslations as Record<string, string>)[key]) return skillTranslations[key as Skills];
  if (raceTranslations[key as keyof typeof raceTranslations]) return raceTranslations[key as keyof typeof raceTranslations];
  if (classTranslations[key as keyof typeof classTranslations]) return classTranslations[key as keyof typeof classTranslations];
  if (subraceTranslations[key as keyof typeof subraceTranslations]) return subraceTranslations[key as keyof typeof subraceTranslations];
  if (variantTranslations[key as keyof typeof variantTranslations]) return variantTranslations[key as keyof typeof variantTranslations];
  if (subclassTranslations[key as keyof typeof subclassTranslations]) return subclassTranslations[key as keyof typeof subclassTranslations];
  if (sourceTranslations[key as keyof typeof sourceTranslations]) return sourceTranslations[key as keyof typeof sourceTranslations];
  if (featTranslations[key]) return featTranslations[key];
  if (toolTranslations[key as keyof typeof toolTranslations]) return toolTranslations[key as keyof typeof toolTranslations];
  if (armorTypeTranslations[key as keyof typeof armorTypeTranslations]) return armorTypeTranslations[key as keyof typeof armorTypeTranslations];
  if (weaponTypeTranslations[key as keyof typeof weaponTypeTranslations]) return weaponTypeTranslations[key as keyof typeof weaponTypeTranslations];
  if (backgroundTranslations[key as keyof typeof backgroundTranslations]) return backgroundTranslations[key as keyof typeof backgroundTranslations];
  if (spellSchoolTranslations[key as keyof typeof spellSchoolTranslations]) return spellSchoolTranslations[key as keyof typeof spellSchoolTranslations];
  if (damageTypeTranslations[key as keyof typeof damageTypeTranslations]) return damageTypeTranslations[key as keyof typeof damageTypeTranslations];

  return prettifyEnum(value);
};

export const formatList = (values?: Array<string | number> | null, fallback = "") => {
  if (!values || values.length === 0) return fallback;
  return values.map((item) => translateValue(item)).join(", ");
};

export const formatSize = (values?: Size[] | null, fallback = "") => {
  if (!values || values.length === 0) return fallback;
  return values.map((item) => translateValue(item)).join(", ");
};

export const formatSkillProficiencies = (skills?: SkillProficiencies | null) => {
  if (!skills) return "";
  if (Array.isArray(skills)) {
    return formatList(skills);
  }

  const { options, choiceCount, chooseAny } = skills;
  const count = choiceCount ?? options.length;

  if (chooseAny) {
    return ` - ${count}`;
  }

  if (!options.length) return ` ${count}`;
  return ` ${count}: ${formatList(options)}`;
};

export const formatToolProficiencies = (tools?: ToolProficiencies | null, chooseCount?: number | null) => {
  const parts: string[] = [];

  if (tools && tools.length) {
    parts.push(formatList(tools));
  }

  if (chooseCount) {
    parts.push(` ${chooseCount}`);
  }

  return parts.length ? parts.join("  ") : "";
};

export const formatLanguages = (languages?: Language[] | null, toChoose?: number | null) => {
  const hasLanguages = languages && languages.length;
  if (hasLanguages && toChoose) {
    return `${formatList(languages)}    ${toChoose}`;
  }
  if (hasLanguages) return formatList(languages);
  if (toChoose) return ` ${toChoose}`;
  return "";
};

export const formatWeaponProficiencies = (
  profs?: WeaponProficiencies | WeaponType[] | WeaponCategory[] | null
) => {
  if (!profs) return "";

  if (Array.isArray(profs)) {
    return formatList(profs);
  }

  const parts: string[] = [];

  if (profs.category?.length) {
    parts.push(formatList(profs.category));
  }
  if (profs.type?.length) {
    parts.push(formatList(profs.type));
  }

  return parts.length ? parts.join("  ") : "";
};

export const formatArmorProficiencies = (armor?: ArmorType[] | null) => formatList(armor);

export const formatAbilityList = (abilities?: Ability[] | null) => formatList(abilities);

export const formatMulticlassReqs = (reqs?: MulticlassReqs | (MulticlassReqs & { choice?: Ability[] }) | null) => {
  if (!reqs) return "";

  const choice = (reqs as any).choice as Ability[] | undefined;
  const required = (reqs as any).required as Ability[] | undefined;

  if (choice?.length) {
    return ` ${reqs.score}+   : ${formatList(choice)}`;
  }

  if (required?.length) {
    return ` ${reqs.score}+ : ${formatList(required)}`;
  }

  return ` ${reqs.score}+  `;
};

export const formatRaceAC = (ac?: any | null) => {
  if (!ac) return "10";
  if ("consistentBonus" in ac) {
    return `+${ac.consistentBonus}  `;
  }
  const bonus = ac.bonus ? ` + ${ac.bonus}` : "";
  return ` ${ac.base}${bonus}`;
};

export const formatASI = (asi?: any | null) => {
  if (!asi) return "";

  const fixedEntries = Object.entries(asi.basic?.simple || {});
  const basicFlexible = asi.basic?.flexible?.groups || [];
  const tashaFlexible = asi.tasha?.flexible?.groups || [];

  const parts: string[] = [];

  if (fixedEntries.length) {
    parts.push(
      `: ${fixedEntries
        .map(([stat, value]) => `${translateValue(String(stat).toUpperCase())} +${value}`)
        .join(", ")}`
    );
  }

  if (basicFlexible.length) {
    parts.push(
      `: ${basicFlexible
        .map(
          (group: any) =>
            `${group.groupName} (+${group.value},  ${group.choiceCount})`
        )
        .join("; ")}`
    );
  }

  if (tashaFlexible.length) {
    parts.push(
      ` : ${tashaFlexible
        .map(
          (group: any) =>
            `${group.groupName} (+${group.value},  ${group.choiceCount})`
        )
        .join("; ")}`
    );
  }

  return parts.join("  ") || "";
};

export const formatSpeeds = (entity: any) => {
  const speeds = [
    { label: "", value: entity.speed },
    { label: "", value: entity.climbSpeed },
    { label: "", value: entity.swimSpeed },
    { label: "", value: entity.flightSpeed },
    { label: "", value: entity.burrowSpeed },
  ].filter((item) => (item.value ?? 0) > 0 || (item.label === "" && item.value != null));

  return speeds
    .map((item) => `${item.label}: ${item.value} `)
    .join("  ");
};
</file>

<file path="src/lib/components/characterCreator/SkillsForm.tsx">
import {skillsSchema} from "@/lib/zod/schemas/persCreateSchema";
import {useStepForm} from "@/hooks/useStepForm";
import {BackgroundI, ClassI, RaceI, SkillProficiencies, SkillProficienciesChoice} from "@/lib/types/model-types";
import {useEffect, useMemo} from "react";
import {engEnumSkills} from "@/lib/refs/translation";
import {RaceVariant, Skills} from "@prisma/client";
import {Skill, SkillsEnum} from "@/lib/types/enums";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Switch } from "@/components/ui/switch";
import { Label } from "@/components/ui/label";
import { Check, Lock } from "lucide-react";
import { usePersFormStore } from "@/lib/stores/persFormStore";

interface Props {
  race: RaceI
  raceVariant?: RaceVariant | null
  selectedClass: ClassI
  background: BackgroundI
  formId: string
  onNextDisabledChange?: (disabled: boolean) => void
}

type GroupName = 'race' | 'selectedClass';

function isSkill(value: unknown): value is Skill {
  return typeof value === "string" && (SkillsEnum as readonly string[]).includes(value)
}

function normalizeSkillProficiencies(value: unknown): SkillProficiencies | null {
  if (!value) return null

  if (Array.isArray(value)) {
    return value.filter(isSkill) as unknown as SkillProficiencies
  }

  if (typeof value === "object") {
    const maybe = value as { options?: unknown; choiceCount?: unknown; chooseAny?: unknown }
    if (typeof maybe.choiceCount === "number" && Array.isArray(maybe.options)) {
      const options = maybe.options.filter(isSkill)
      const chooseAny = typeof maybe.chooseAny === "boolean" ? maybe.chooseAny : undefined
      return { options, choiceCount: maybe.choiceCount, chooseAny }
    }
  }

  return null
}

function getSkillProficienciesCount(skillProfs: SkillProficiencies | null): number {
  if (!skillProfs) return 0;

  if (Array.isArray(skillProfs)) return skillProfs.length

  return skillProfs.choiceCount
}

function getTotalSkillProficienciesCount(
  {raceCount, classCount, backgroundCount, subraceCount, variantCount}: { 
    raceCount: number, 
    classCount: number, 
    backgroundCount: number,
    subraceCount: number,
    variantCount: number
  }
): number {
  return raceCount + classCount + backgroundCount + subraceCount + variantCount
}

interface hasSkills {
  skillProficiencies: SkillProficiencies | null
}

function populateSkills<T extends hasSkills>(model: T) {
  if (model.skillProficiencies && !Array.isArray(model.skillProficiencies)) {
    model.skillProficiencies.options = [...SkillsEnum]
  }
}

export const SkillsForm = ({race, raceVariant, selectedClass, background, formId, onNextDisabledChange}: Props) => {
  const { formData, updateFormData, nextStep } = usePersFormStore();
  
  // Get selected subrace from formData
  const selectedSubrace = useMemo(() => {
    if (!formData.subraceId) return null;
    return race.subraces?.find(sr => sr.subraceId === formData.subraceId);
  }, [formData.subraceId, race.subraces]);
  
  // Calculate fixed skills from race/background/subrace
  const fixedSkillsFromRaceAndBackground = useMemo(() => {
    const skills = new Set<Skill>();
    
    // Background fixed skills
    if (Array.isArray(background.skillProficiencies)) {
      background.skillProficiencies.forEach(s => skills.add(s));
    }
    
    // Race fixed skills
    if (Array.isArray(race.skillProficiencies)) {
      race.skillProficiencies.forEach(s => skills.add(s));
    }
    
    // Subrace fixed skills
    if (selectedSubrace && Array.isArray(selectedSubrace.skillProficiencies)) {
      selectedSubrace.skillProficiencies.forEach((s) => {
        if (isSkill(s)) skills.add(s)
      });
    }
    
    return Array.from(skills);
  }, [background, race, selectedSubrace]);
  
  // Custom submit handler to build skills array
  const {form, onSubmit: baseOnSubmit} = useStepForm(skillsSchema, (data) => {
    // Build flat skills array from schema data
    const allSkills = new Set<string>();
    
    if (data.isTasha) {
      // In Tasha mode, tashaChoices already contains ALL selected skills (no fixed skills - they become choices)
      data.tashaChoices.forEach(s => allSkills.add(s));
    } else {
      // In basic mode, combine fixed race/background skills + class choices
      
      // Add fixed background skills
      if (Array.isArray(background.skillProficiencies)) {
        background.skillProficiencies.forEach(s => allSkills.add(s));
      }
      
      // Add fixed race skills
      if (Array.isArray(race.skillProficiencies)) {
        race.skillProficiencies.forEach(s => allSkills.add(s));
      }
      
      // Add subrace fixed skills
      const selectedSubrace = race.subraces?.find(sr => sr.subraceId === formData.subraceId);
      if (selectedSubrace && Array.isArray(selectedSubrace.skillProficiencies)) {
        selectedSubrace.skillProficiencies.forEach((s) => {
          if (isSkill(s)) allSkills.add(s)
        });
      }
      
      // Add class choices (user-selected)
      data.basicChoices.selectedClass.forEach(s => allSkills.add(s));
    }
    
    // Save both skillsSchema AND flat skills array
    const skillsArray = Array.from(allSkills);
    
    updateFormData({
      skillsSchema: data,
      skills: skillsArray
    });
    
    nextStep();
  });

  populateSkills<typeof race>(race)

  useEffect(() => {
    form.register('basicChoices')
    form.register('basicChoices.race')
    form.register('basicChoices.selectedClass')
    form.register('tashaChoices')
    form.register('isTasha')
    form.register('_requiredCount')
    form.register('_raceCount')
    form.register('_classCount')
  }, [form])

  const isTasha = form.watch('isTasha') ?? true
  const tashaChoices = form.watch('tashaChoices') || []
  const basicChoices = form.watch('basicChoices') ?? {
    race: [],
    selectedClass: [],
  }

  // Skills shown as "locked" in UI - only in non-Tasha mode
  const lockedSkillsInUI = useMemo(() => {
    if (isTasha) return []; // In Tasha mode, NO skills are locked in UI (they become free choices)
    return fixedSkillsFromRaceAndBackground; // In non-Tasha mode, these are locked
  }, [isTasha, fixedSkillsFromRaceAndBackground]);

  const raceSkillProficiencies = useMemo(() => {
    if (raceVariant?.name === 'HUMAN_VARIANT') {
      // Variant Human gets 1 skill of choice
      return {
        choiceCount: 1,
        options: [...SkillsEnum]
      } as SkillProficienciesChoice;
    }
    return race.skillProficiencies;
  }, [race, raceVariant]);

  const raceCount = getSkillProficienciesCount(raceSkillProficiencies)
  const classCount = getSkillProficienciesCount(selectedClass.skillProficiencies)
  const backgroundCount = getSkillProficienciesCount(background.skillProficiencies)
  const subraceCount = getSkillProficienciesCount(normalizeSkillProficiencies(selectedSubrace?.skillProficiencies))
  const variantCount = 0

  // In Tasha mode, ALL skills (including fixed ones) become free choices in ONE pool
  const tashaChoiceCountTotal = isTasha 
    ? getTotalSkillProficienciesCount({
        raceCount,
        classCount,
        backgroundCount,
        subraceCount,
        variantCount
      })
    : 0;
    
  const tashaChoiceCountCurrent = tashaChoiceCountTotal - (tashaChoices?.length ?? 0)

  const basicCounts = {
    race: raceCount - (basicChoices?.race?.length ?? 0),
    selectedClass: classCount - (basicChoices?.selectedClass?.length ?? 0)
  }

  const entries = Object.entries(basicChoices) as [GroupName, Skill[]][];

  const skillsByGroup = {
    race: raceSkillProficiencies as SkillProficienciesChoice,
    selectedClass: selectedClass.skillProficiencies as SkillProficienciesChoice,
  }

  const checkIfSelectedByOthers = (groupName: GroupName, skill: Skill) => {
    // Check if skill is in fixed granted skills
    if (fixedSkillsFromRaceAndBackground.includes(skill)) return true;
    
    const allSkillGroups = {
      background: background.skillProficiencies,
      race: Array.isArray(race.skillProficiencies)
        ? race.skillProficiencies
        : basicChoices.race,
      selectedClass: basicChoices.selectedClass
    }
    delete allSkillGroups[groupName]

    return Object.values(allSkillGroups).some(value =>
      Array.isArray(value)
        ? value.includes(skill)
        : value?.options?.includes(skill)
    )
  }

  // Set validation metadata fields
  useEffect(() => {
    if (isTasha) {
      form.setValue('_requiredCount', tashaChoiceCountTotal);
      form.setValue('_raceCount', undefined);
      form.setValue('_classCount', undefined);
    } else {
      form.setValue('_requiredCount', undefined);
      form.setValue('_raceCount', raceCount);
      form.setValue('_classCount', classCount);
    }
  }, [isTasha, tashaChoiceCountTotal, raceCount, classCount, form]);

  // Update button state based on form validity
  useEffect(() => {
    // Skills selection is optional: allow continuing even if not all picks are filled.
    // We only guard against impossible states (over the computed limit), but UI already prevents that.
    const isOverLimit = isTasha
      ? tashaChoices.length > tashaChoiceCountTotal
      : (basicChoices.selectedClass ?? []).length > classCount;

    onNextDisabledChange?.(isOverLimit);
  }, [isTasha, tashaChoices.length, tashaChoiceCountTotal, basicChoices, classCount, onNextDisabledChange]);

  const handleToggleTashaSkill = (skill: Skill) => {
    const has = tashaChoices.includes(skill)

    // Can't select if already at limit and not currently selected
    if (!has && tashaChoiceCountCurrent < 1) return;

    const updated = has
      ? tashaChoices.filter(c => c !== skill)
      : [...tashaChoices, skill]

    form.setValue('tashaChoices', updated)
  }

  const handleToggleBasicSkill = ({skill, groupName}: { skill: Skill, groupName: GroupName }) => {
    const current = basicChoices[groupName] ?? []
    const has = current.includes(skill)

    if (!has && basicCounts[groupName] < 1) return;

    const updated = has
      ? current.filter(c => c !== skill)
      : [...current, skill]

    form.setValue(`basicChoices.${groupName}`, updated)
  }

  return (
    <form id={formId} onSubmit={baseOnSubmit} className="w-full space-y-4">
      <Card className="shadow-xl">
        <CardHeader className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <CardTitle className="text-white"></CardTitle>
          </div>
          <div className="flex items-center gap-3">
            <Switch
              id="isTasha"
              checked={isTasha}
              onCheckedChange={(checked) => form.setValue('isTasha', checked)}
            />
            <Label htmlFor="isTasha" className="text-slate-200"> </Label>
            <Badge className="border border-white/15 bg-white/5 text-slate-200"> </Badge>
          </div>
        </CardHeader>

        <CardContent className="space-y-4">
          {isTasha ? (
            <div className="space-y-3">
              <div className="flex items-center justify-between rounded-lg border border-white/10 bg-white/5 px-3 py-2 text-sm text-slate-300">
                <span>  </span>
                <Badge variant="outline" className="border-white/15 bg-white/5 text-white">
                  {tashaChoiceCountCurrent}
                </Badge>
              </div>
              
              {/* In Tasha mode, NO fixed skills section - all become choices */}
              <p className="text-xs text-slate-400 px-2">
                  :    ,        
              </p>
              
              <div className="grid gap-2 sm:grid-cols-2 md:grid-cols-3">
                {engEnumSkills.map((skill, index) => {
                  const isSelected = tashaChoices.includes(skill.eng);
                  const isReachedLimit = tashaChoiceCountCurrent < 1;
                  const isDisabled = !isSelected && isReachedLimit;
                  const active = isSelected;
                  
                  return (
                    <Button
                      key={index}
                      type="button"
                      variant="outline"
                      disabled={isDisabled}
                      className={`justify-between border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white ${
                        active ? "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100" : ""
                      } ${isDisabled ? "opacity-60" : ""}`}
                      onClick={() => handleToggleTashaSkill(skill.eng)}
                    >
                      <span>{skill.ukr}</span>
                      {active && <Check className="h-4 w-4" />}
                    </Button>
                  );
                })}
              </div>
            </div>
          ) : (
            <div className="space-y-5">
              {/* Show fixed skills from background/race/subrace in NON-Tasha mode */}
              {lockedSkillsInUI.length > 0 && (
                <div className="rounded-lg border border-amber-500/30 bg-amber-500/5 p-3">
                  <div className="flex items-center gap-2 mb-2">
                    <Lock className="h-4 w-4 text-amber-400" />
                    <h3 className="text-sm font-semibold text-amber-200"> </h3>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {lockedSkillsInUI.map((skill) => {
                      const skillGroup = engEnumSkills.find((s) => s.eng === skill);
                      return (
                        <Badge key={skill} className="bg-amber-900/30 text-amber-100 border border-amber-700/50">
                          {skillGroup?.ukr}
                        </Badge>
                      );
                    })}
                  </div>
                  <p className="text-xs text-amber-300/70 mt-2">
                           
                  </p>
                </div>
              )}

              {entries.map(([groupName, choices], index) => (
                <div key={index} className="space-y-2 rounded-lg border border-white/10 bg-white/5 p-3">
                  {skillsByGroup[groupName]?.options && (
                    <div className="flex items-center justify-between text-sm text-slate-300">
                      <div className="font-semibold text-white">
                        {groupName === 'race' ? '  ' : '  '}
                      </div>
                      <span className="text-xs uppercase tracking-wide">: <span className="text-indigo-300">{basicCounts[groupName]}</span></span>
                    </div>
                  )}
                  <div className="grid gap-2 sm:grid-cols-2">
                    {(skillsByGroup[groupName]?.options ?? []).map((skill, skillIndex) => {
                      const skillGroup = engEnumSkills.find((s) => s.eng === skill)
                      if (!skillGroup) return null;
                      const isSelected = (choices ?? []).includes(skill)
                      const isSelectedByOthers = checkIfSelectedByOthers(groupName, skill)
                      const isMaxReached = basicCounts[groupName] < 1;
                      const isDisabled = (!isSelected && isMaxReached) || isSelectedByOthers
                      const active = isSelected || isSelectedByOthers;
                      
                      return (
                        <Button
                          key={skillIndex}
                          type="button"
                          variant="outline"
                          disabled={isDisabled}
                          className={`justify-between ${
                            isSelectedByOthers 
                              ? "bg-white/3 text-slate-400 border-white/10 cursor-not-allowed" 
                              : active 
                                ? "border-gradient-rpg border-gradient-rpg-active glass-active bg-white/5 text-slate-100" 
                                : "border-white/15 bg-white/5 text-slate-200"
                          } ${isDisabled && !isSelectedByOthers ? "opacity-60" : ""}`}
                          onClick={() => !isSelectedByOthers && handleToggleBasicSkill({
                            skill: Skills[skillGroup.eng],
                            groupName: groupName
                          })}
                        >
                          <span className="flex items-center gap-2">
                            {isSelectedByOthers && <Lock className="h-3 w-3" />}
                            {skillGroup.ukr}
                          </span>
                          {active && !isSelectedByOthers && <Check className="h-4 w-4" />}
                          {isSelectedByOthers && <span className="text-xs opacity-70">( )</span>}
                        </Button>
                      )
                    })}
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>
    </form>
  )
};

export default SkillsForm
</file>

<file path="src/lib/components/ui/dialog.tsx">
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-[9998] bg-slate-950/45 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    onPointerDown={() => {
      const handler = (event: MouseEvent) => {
        event.preventDefault();
        event.stopPropagation();
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        ;(event as any).stopImmediatePropagation?.();
        document.removeEventListener("click", handler, true);
      };

      document.addEventListener("click", handler, true);
      window.setTimeout(() => {
        document.removeEventListener("click", handler, true);
      }, 800);
    }}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-[9999] grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 rounded-2xl border border-white/10 bg-gradient-to-b from-slate-950/28 to-slate-950/18 p-6 text-slate-50 backdrop-blur-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
        className
      )}
      onPointerDown={(e) => e.stopPropagation()}
      onClick={(e) => e.stopPropagation()}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "font-rpg-display text-lg font-semibold uppercase leading-none tracking-wider text-amber-50/90 drop-shadow-[0_2px_10px_rgba(99,102,241,0.25)]",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogTrigger,
  DialogClose,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}
</file>

<file path="prisma/seed/choiceOptionSeed.ts">
import { Prisma, PrismaClient } from "@prisma/client";

export const seedChoiceOptions = async (prisma: PrismaClient) => {
    console.log('    ( )...')

    const options: Prisma.ChoiceOptionCreateInput[] = [
        // ===    ===
        {
            groupName: ' ',
            optionName: '  ',
            optionNameEng: 'Archery',

            features: {
                create: [
                    { feature: { connect: { engName: 'Archery' } } }
                ]
            },
        },

        // ===   ===
        {
            groupName: ' ',
            optionName: ' ',
            optionNameEng: 'Blind Fighting',

            features: {
                create: [
                    { feature: { connect: { engName: 'Blind Fighting' } } }
                ]
            },
        },

        // ===  ===
        {
            groupName: ' ',
            optionName: '',
            optionNameEng: 'Defense',

            features: {
                create: [
                    { feature: { connect: { engName: 'Defense' } } }
                ]
            },
        },

        // ===  ===
        {
            groupName: ' ',
            optionName: '',
            optionNameEng: 'Dueling',

            features: {
                create: [
                    { feature: { connect: { engName: 'Dueling' } } }
                ]
            },
        },

        // ===    ===
        {
            groupName: ' ',
            optionName: '  ',
            optionNameEng: 'Great Weapon Fighting',

            features: {
                create: [
                    { feature: { connect: { engName: 'Great Weapon Fighting' } } }
                ]
            },
        },

        // ===  ===
        {
            groupName: ' ',
            optionName: '',
            optionNameEng: 'Interception',

            features: {
                create: [
                    { feature: { connect: { engName: 'Interception' } } }
                ]
            },
        },

        // ===  ===
        {
            groupName: ' ',
            optionName: '',
            optionNameEng: 'Protection',

            features: {
                create: [
                    { feature: { connect: { engName: 'Protection' } } }
                ]
            },
        },

        // ===   ===
        {
            groupName: ' ',
            optionName: ' ',
            optionNameEng: 'Superior Technique',

            features: {
                create: [
                    { feature: { connect: { engName: 'Superior Technique' } } }
                ]
            },
        },

        // ===    ===
        {
            groupName: ' ',
            optionName: '  ',
            optionNameEng: 'Thrown Weapon Fighting',

            features: {
                create: [
                    { feature: { connect: { engName: 'Thrown Weapon Fighting' } } }
                ]
            },
        },

        // ===    ===
        {
            groupName: ' ',
            optionName: '  ',
            optionNameEng: 'Two-Weapon Fighting',

            features: {
                create: [
                    { feature: { connect: { engName: 'Two-Weapon Fighting' } } }
                ]
            },
        },

        // ===   ===
        {
            groupName: ' ',
            optionName: ' ',
            optionNameEng: 'Unarmed Fighting',

            features: {
                create: [
                    { feature: { connect: { engName: 'Unarmed Fighting' } } }
                ]
            },
        },

        // ===   ===
        {
            groupName: ' ',
            optionName: ' ',
            optionNameEng: 'Druidic Warrior',

            features: {
                create: [
                    { feature: { connect: { engName: 'Druidic Warrior' } } }
                ]
            },
        },

        // ===   ===
        {
            groupName: ' ',
            optionName: ' ',
            optionNameEng: 'Blessed Warrior',

            features: {
                create: [
                    { feature: { connect: { engName: 'Blessed Warrior' } } }
                ]
            },
        },

        // ===   ===
        {
            groupName: ' : ',
            optionName: '  ',
            optionNameEng: 'Favored Foe',

            features: {
                create: [
                    { feature: { connect: { engName: 'Favored Foe' } } }
                ]
            },
        },

        // ===   ===
        {
            groupName: ' : ',
            optionName: '  ',
            optionNameEng: 'Favored Enemy',

            features: {
                create: [
                    { feature: { connect: { engName: 'Favored Enemy' } } }
                ]
            },
        },

        // ===== METAMAGIC OPTIONS (SORCERER) =====
        {
            groupName: '',
            optionName: ' ',
            optionNameEng: 'Careful Spell',
            features: {
                create: [
                    { feature: { connect: { engName: 'Careful Spell' } } }
                ]
            },
        },
        {
            groupName: '',
            optionName: ' ',
            optionNameEng: 'Distant Spell',
            features: {
                create: [
                    { feature: { connect: { engName: 'Distant Spell' } } }
                ]
            },
        },
        {
            groupName: '',
            optionName: ' ',
            optionNameEng: 'Empowered Spell',
            features: {
                create: [
                    { feature: { connect: { engName: 'Empowered Spell' } } }
                ]
            },
        },
        {
            groupName: '',
            optionName: ' ',
            optionNameEng: 'Extended Spell',
            features: {
                create: [
                    { feature: { connect: { engName: 'Extended Spell' } } }
                ]
            },
        },
        {
            groupName: '',
            optionName: ' ',
            optionNameEng: 'Heightened Spell',
            features: {
                create: [
                    { feature: { connect: { engName: 'Heightened Spell' } } }
                ]
            },
        },
        {
            groupName: '',
            optionName: ' ',
            optionNameEng: 'Quickened Spell',
            features: {
                create: [
                    { feature: { connect: { engName: 'Quickened Spell' } } }
                ]
            },
        },
        {
            groupName: '',
            optionName: ' ',
            optionNameEng: 'Subtle Spell',
            features: {
                create: [
                    { feature: { connect: { engName: 'Subtle Spell' } } }
                ]
            },
        },
        {
            groupName: '',
            optionName: ' ',
            optionNameEng: 'Twinned Spell',
            features: {
                create: [
                    { feature: { connect: { engName: 'Twinned Spell' } } }
                ]
            },
        },
        {
            groupName: '',
            optionName: ' ',
            optionNameEng: 'Seeking Spell',
            features: {
                create: [
                    { feature: { connect: { engName: 'Seeking Spell' } } }
                ]
            },
        },
        {
            groupName: '',
            optionName: ' ',
            optionNameEng: 'Transmuted Spell',
            features: {
                create: [
                    { feature: { connect: { engName: 'Transmuted Spell' } } }
                ]
            },
        },

        {
            groupName: ' : ',
            optionName: '2  + ',
            optionNameEng: 'Deft Explorer - Canny',

            features: {
                create: [
                    { feature: { connect: { engName: 'Deft Explorer - Canny' } } }
                ]
            },
        },
        {
            groupName: ' : ',
            optionName: '  ( )',
            optionNameEng: 'Natural Explorer',

            features: {
                create: [
                    { feature: { connect: { engName: 'Natural Explorer' } } }
                ]
            },
        },


        {
            groupName: ' : ',
            optionName: '    ',
            optionNameEng: 'Primal Awareness',

            features: {
                create: [
                    { feature: { connect: { engName: 'Primal Awareness' } } }
                ]
            },
        },
        {
            groupName: ' : ',
            optionName: '  ',
            optionNameEng: 'Primeval Awareness',

            features: {
                create: [
                    { feature: { connect: { engName: 'Primeval Awareness' } } }
                ]
            },
        },


        {
            groupName: ' : ',
            optionName: '  ',
            optionNameEng: 'Nature\'s Veil',

            features: {
                create: [
                    { feature: { connect: { engName: 'Nature\'s Veil' } } }
                ]
            },
        },
        {
            groupName: ' : ',
            optionName: '+10       ',
            optionNameEng: 'Hide in Plain Sight',

            features: {
                create: [
                    { feature: { connect: { engName: 'Hide in Plain Sight' } } }
                ]
            },
        },


        // =====   (PACT BOONS) =====

        {
            groupName: ' ',
            optionName: ' -   ',
            optionNameEng: 'Pact of the Blade',

            features: {
                create: [
                    { feature: { connect: { engName: 'Pact of the Blade' } } }
                ]
            },
        },

        {
            groupName: ' ',
            optionName: ' -  ',
            optionNameEng: 'Pact of the Chain',

            features: {
                create: [
                    { feature: { connect: { engName: 'Pact of the Chain' } } }
                ]
            },
        },

        {
            groupName: ' ',
            optionName: ' - 3  ',
            optionNameEng: 'Pact of the Tome',

            features: {
                create: [
                    { feature: { connect: { engName: 'Pact of the Tome' } } }
                ]
            },
        },

        {
            groupName: ' ',
            optionName: ' - +4  ',
            optionNameEng: 'Pact of the Talisman',

            features: {
                create: [
                    { feature: { connect: { engName: 'Pact of the Talisman' } } }
                ]
            },
        },


        // ===== ELDRITCH INVOCATIONS =====

//  
        {
            groupName: ' ',
            optionName: '+    ',
            optionNameEng: 'Agonizing Blast',
            features: {
                create: [{ feature: { connect: { engName: 'Agonizing Blast' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '  ',
            optionNameEng: 'Armor of Shadows',
            features: {
                create: [{ feature: { connect: { engName: 'Armor of Shadows' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: ' + ',
            optionNameEng: 'Beguiling Influence',
            features: {
                create: [{ feature: { connect: { engName: 'Beguiling Influence' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '   ',
            optionNameEng: 'Beast Speech',
            features: {
                create: [{ feature: { connect: { engName: 'Beast Speech' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '   120 ',
            optionNameEng: 'Devil\'s Sight',
            features: {
                create: [{ feature: { connect: { engName: 'Devil\'s Sight' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '  ',
            optionNameEng: 'Eldritch Sight',
            features: {
                create: [{ feature: { connect: { engName: 'Eldritch Sight' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '  ',
            optionNameEng: 'Eldritch Mind',
            features: {
                create: [{ feature: { connect: { engName: 'Eldritch Mind' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '  300 ',
            optionNameEng: 'Eldritch Spear',
            features: {
                create: [{ feature: { connect: { engName: 'Eldritch Spear' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '  ',
            optionNameEng: 'Eyes of the Rune Keeper',
            features: {
                create: [{ feature: { connect: { engName: 'Eyes of the Rune Keeper' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '  ',
            optionNameEng: 'Fiendish Vigor',
            features: {
                create: [{ feature: { connect: { engName: 'Fiendish Vigor' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '  ',
            optionNameEng: 'Gaze of Two Minds',
            features: {
                create: [{ feature: { connect: { engName: 'Gaze of Two Minds' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: ' ',
            optionNameEng: 'Mask of Many Faces',
            features: {
                create: [{ feature: { connect: { engName: 'Mask of Many Faces' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '  ',
            optionNameEng: 'Misty Visions',
            features: {
                create: [{ feature: { connect: { engName: 'Misty Visions' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '    10 ',
            optionNameEng: 'Repelling Blast',
            features: {
                create: [{ feature: { connect: { engName: 'Repelling Blast' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '    10 ',
            optionNameEng: 'Grasp of Hadar',
            features: {
                create: [{ feature: { connect: { engName: 'Grasp of Hadar' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '    10 ',
            optionNameEng: 'Lance of Lethargy',
            features: {
                create: [{ feature: { connect: { engName: 'Lance of Lethargy' } } }]
            },
        },

// : 5+ 
        {
            groupName: ' ',
            optionName: '   ',
            optionNameEng: 'Thirsting Blade',
            prerequisites: { level: 5, pact: 'Pact of the Blade' },
            features: {
                create: [{ feature: { connect: { engName: 'Thirsting Blade' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '  1/',
            optionNameEng: 'Sign of Ill Omen',
            prerequisites: { level: 5 },
            features: {
                create: [{ feature: { connect: { engName: 'Sign of Ill Omen' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '+1   ,  ',
            optionNameEng: 'Improved Pact Weapon',
            prerequisites: { level: 5, pact: 'Pact of the Blade' },
            features: {
                create: [{ feature: { connect: { engName: 'Improved Pact Weapon' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '   + ',
            optionNameEng: 'Gift of the Depths',
            prerequisites: { level: 5 },
            features: {
                create: [{ feature: { connect: { engName: 'Gift of the Depths' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '   ',
            optionNameEng: 'Gift of the Ever-Living Ones',
            prerequisites: { level: 5, pact: 'Pact of the Chain' },
            features: {
                create: [{ feature: { connect: { engName: 'Gift of the Ever-Living Ones' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '  ',
            optionNameEng: 'Voice of the Chain Master',
            prerequisites: { pact: 'Pact of the Chain' },
            features: {
                create: [{ feature: { connect: { engName: 'Voice of the Chain Master' } } }]
            },
        },

// 7+ 
        {
            groupName: ' ',
            optionName: ' 1/',
            optionNameEng: 'Sculptor of Flesh',
            prerequisites: { level: 7 },
            features: {
                create: [{ feature: { connect: { engName: 'Sculptor of Flesh' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '    ',
            optionNameEng: 'One with Shadows',
            prerequisites: { level: 7 },
            features: {
                create: [{ feature: { connect: { engName: 'One with Shadows' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '  1/',
            optionNameEng: 'Trickster\'s Escape',
            prerequisites: { level: 7 },
            features: {
                create: [{ feature: { connect: { engName: 'Trickster\'s Escape' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '    ',
            optionNameEng: 'Eldritch Smite',
            prerequisites: { level: 5, pact: 'Pact of the Blade' },
            features: {
                create: [{ feature: { connect: { engName: 'Eldritch Smite' } } }]
            },
        },

// 9+ 
        {
            groupName: ' ',
            optionName: '   ',
            optionNameEng: 'Ascendant Step',
            prerequisites: { level: 9 },
            features: {
                create: [{ feature: { connect: { engName: 'Ascendant Step' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '   ',
            optionNameEng: 'Whispers of the Grave',
            prerequisites: { level: 9 },
            features: {
                create: [{ feature: { connect: { engName: 'Whispers of the Grave' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: ' [Jump]   ',
            optionNameEng: 'Otherworldly Leap',
            prerequisites: { level: 9 },
            features: {
                create: [{ feature: { connect: { engName: 'Otherworldly Leap' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '\'  [Conjure Elemental] 1/',
            optionNameEng: 'Minions of Chaos',
            prerequisites: { level: 9 },
            features: {
                create: [{ feature: { connect: { engName: 'Minions of Chaos' } } }]
            },
        },

// 12+ 
        {
            groupName: ' ',
            optionName: '+   ',
            optionNameEng: 'Lifedrinker',
            prerequisites: { level: 12, pact: 'Pact of the Blade' },
            features: {
                create: [{ feature: { connect: { engName: 'Lifedrinker' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '    ',
            optionNameEng: 'Book of Ancient Secrets',
            prerequisites: { pact: 'Pact of the Tome' },
            features: {
                create: [{ feature: { connect: { engName: 'Book of Ancient Secrets' } } }]
            },
        },

// 15+ 
        {
            groupName: ' ',
            optionName: '  ',
            optionNameEng: 'Visions of Distant Realms',
            prerequisites: { level: 15 },
            features: {
                create: [{ feature: { connect: { engName: 'Visions of Distant Realms' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '  ',
            optionNameEng: 'Master of Myriad Forms',
            prerequisites: { level: 15 },
            features: {
                create: [{ feature: { connect: { engName: 'Master of Myriad Forms' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '  (  )',
            optionNameEng: 'Shrouded in Shadow',
            prerequisites: { level: 15 },
            features: {
                create: [{ feature: { connect: { engName: 'Shrouded in Shadow' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '   30 ',
            optionNameEng: 'Witch Sight',
            prerequisites: { level: 15 },
            features: {
                create: [{ feature: { connect: { engName: 'Witch Sight' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '    ',
            optionNameEng: 'Chains of Carceri',
            prerequisites: { level: 15, pact: 'Pact of the Chain' },
            features: {
                create: [{ feature: { connect: { engName: 'Chains of Carceri' } } }]
            },
        },
        {
            groupName: ' ',
            optionName: '  10 ',
            optionNameEng: 'Tomb of Levistus',
            prerequisites: { level: 5 },
            features: {
                create: [{ feature: { connect: { engName: 'Tomb of Levistus' } } }]
            },
        },

        // ===== XGE INVOCATIONS =====

// 44. Aspect of the Moon
        {
            groupName: ' ',
            optionName: '   ( )',
            optionNameEng: 'Aspect of the Moon',
            prerequisites: { pact: 'Pact of the Tome' },
            features: {
                create: [{ feature: { connect: { engName: 'Aspect of the Moon' } } }]
            },
        },

// 45. Cloak of Flies
        {
            groupName: ' ',
            optionName: ' : +  ',
            optionNameEng: 'Cloak of Flies',
            prerequisites: { level: 5 },
            features: {
                create: [{ feature: { connect: { engName: 'Cloak of Flies' } } }]
            },
        },

// 46. Ghostly Gaze
        {
            groupName: ' ',
            optionName: '   30 ',
            optionNameEng: 'Ghostly Gaze',
            prerequisites: { level: 7 },
            features: {
                create: [{ feature: { connect: { engName: 'Ghostly Gaze' } } }]
            },
        },

// 47. Maddening Hex
        {
            groupName: ' ',
            optionName: '   ',
            optionNameEng: 'Maddening Hex',
            prerequisites: { level: 5 },
            features: {
                create: [{ feature: { connect: { engName: 'Maddening Hex' } } }]
            },
        },

// 48. Relentless Hex
        {
            groupName: ' ',
            optionName: '   ',
            optionNameEng: 'Relentless Hex',
            prerequisites: { level: 7 },
            features: {
                create: [{ feature: { connect: { engName: 'Relentless Hex' } } }]
            },
        },

// ===== TCE INVOCATIONS =====

// 49. Far Scribe
        {
            groupName: ' ',
            optionName: '    ( )',
            optionNameEng: 'Far Scribe',
            prerequisites: { level: 5, pact: 'Pact of the Tome' },
            features: {
                create: [{ feature: { connect: { engName: 'Far Scribe' } } }]
            },
        },

// 50. Gift of the Protectors
        {
            groupName: ' ',
            optionName: '6 : 0   1  ( )',
            optionNameEng: 'Gift of the Protectors',
            prerequisites: { level: 9, pact: 'Pact of the Tome' },
            features: {
                create: [{ feature: { connect: { engName: 'Gift of the Protectors' } } }]
            },
        },

// 51. Investment of the Chain Master
        {
            groupName: ' ',
            optionName: '  ( )',
            optionNameEng: 'Investment of the Chain Master',
            prerequisites: { pact: 'Pact of the Chain' },
            features: {
                create: [{ feature: { connect: { engName: 'Investment of the Chain Master' } } }]
            },
        },

// 52. Undying Servitude
        {
            groupName: ' ',
            optionName: '  1/',
            optionNameEng: 'Undying Servitude',
            prerequisites: { level: 5 },
            features: {
                create: [{ feature: { connect: { engName: 'Undying Servitude' } } }]
            },
        },

// 53. Rebuke of the Talisman
        {
            groupName: ' ',
            optionName: ':   ( )',
            optionNameEng: 'Rebuke of the Talisman',
            prerequisites: { pact: 'Pact of the Talisman' },
            features: {
                create: [{ feature: { connect: { engName: 'Rebuke of the Talisman' } } }]
            },
        },

// 54. Protection of the Talisman
        {
            groupName: ' ',
            optionName: '+4   ( )',
            optionNameEng: 'Protection of the Talisman',
            prerequisites: { level: 7, pact: 'Pact of the Talisman' },
            features: {
                create: [{ feature: { connect: { engName: 'Protection of the Talisman' } } }]
            },
        },

// 55. Bond of the Talisman
        {
            groupName: ' ',
            optionName: '   ',
            optionNameEng: 'Bond of the Talisman',
            prerequisites: { level: 12, pact: 'Pact of the Talisman' },
            features: {
                create: [{ feature: { connect: { engName: 'Bond of the Talisman' } } }]
            },
        },
    ];

    // /  ,          
    for (const option of options) {
        const createEntries = option.features?.create;
        const featureCreates = Array.isArray(createEntries)
            ? createEntries
            : createEntries
                ? [createEntries]
                : [];

        const featureNames = featureCreates
            .map((entry) => (entry as any)?.feature?.connect?.engName as string | undefined)
            .filter(Boolean) as string[];

        const { features, ...optionData } = option;

        const savedOption = await prisma.choiceOption.upsert({
            where: { optionNameEng: option.optionNameEng },
            update: optionData,
            create: optionData,
        });

        //    ',    
        for (const engName of featureNames) {
            const feature = await prisma.feature.findUnique({ where: { engName } });
            if (!feature) {
                console.warn(` Feature with engName=${engName} not found, skip linking to ${option.optionNameEng}`);
                continue;
            }

            const existingLink = await prisma.choiceOptionFeature.findFirst({
                where: {
                    choiceOptionId: savedOption.choiceOptionId,
                    featureId: feature.featureId,
                },
            });

            if (!existingLink) {
                await prisma.choiceOptionFeature.create({
                    data: {
                        choiceOptionId: savedOption.choiceOptionId,
                        featureId: feature.featureId,
                    },
                });
            }
        }
    }


    console.log('   :', options.length);
}
</file>

<file path="prisma/seed/raceFeatureSeed.ts">
import { PrismaClient, FeatureDisplayType, RestType, Prisma } from "@prisma/client";
import { normalizeFeatureCreateInput, type SeedFeatureCreateInput } from "./helpers/featureDisplayType";

export const seedRaceFeatures = async (prisma: PrismaClient) => {
    console.log('    ...')

    const features: SeedFeatureCreateInput[] = [
        // ============    ============
        {
            name: '',
            engName: 'Darkvision',
            description: '        60  ,    ,    ,    .       ,   .',
            shortDescription: '    60 ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Superior Darkvision',
            description: '        120  ,    ,    ,    .       ,   .',
            shortDescription: '    120 ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Keen Senses',
            description: '    .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // ============ /  ============
        {
            name: ' ',
            engName: 'Fey Ancestry',
            description: '      ,     .',
            shortDescription: '        ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Gnome Cunning',
            description: '     ,     .',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // ============   ============
        {
            name: ' ',
            engName: 'Dwarven Resilience',
            description: '           .',
            shortDescription: '   + ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Relentless Endurance',
            description: '  -   0,     ,     1 -  .       ,     .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: ' ',
            engName: 'Halfling Resilience',
            description: '        .',
            shortDescription: '    ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        {
            name: '  ',
            engName: 'Dwarven Combat Training',
            description: '   ,  ,     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '  ',
            engName: 'Dwarven Tool Proficiency',
            description: '       :  ,     .',
            shortDescription: '    ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // ============    ============
        {
            name: '',
            engName: 'Lucky',
            description: '   1   20   ,    ,         .',
            shortDescription: '   20',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '',
            engName: 'Brave',
            description: '      .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // ============ /  ============
        {
            name: ' ',
            engName: 'Hellish Resistance',
            description: '     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Celestial Resistance',
            description: '       .',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // ============    ============
        {
            name: '',
            engName: 'Trance',
            description: '   .     ,    ,  4   .        -;      ,      .        ,     8  .',
            shortDescription: '4    8  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // ============   ============
        {
            name: '  ()',
            engName: 'Breath Weapon (Acid)',
            description: '    ,    .      ,      (530  ())    .  = 8 +    +   .   26          .    36  6 , 46  11   56  16 .          ,       .',
            shortDescription: '  530  ()',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1,
        },
        {
            name: '  ()',
            engName: 'Breath Weapon (Lightning)',
            description: '    ,    .      ,      (530  ())    .  = 8 +    +   .   26          .    36  6 , 46  11   56  16 .          ,       .',
            shortDescription: '  530  ()',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1,
        },
        {
            name: '  (, )',
            engName: 'Breath Weapon (Fire, Cone)',
            description: '    ,    .      ,      (15  ())    .  = 8 +    +   .   26          .    36  6 , 46  11   56  16 .          ,       .',
            shortDescription: '  15  ()',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1,
        },
        {
            name: '  (, )',
            engName: 'Breath Weapon (Fire, Line)',
            description: '    ,    .      ,      (30  ())    .  = 8 +    +   .   26          .    36  6 , 46  11   56  16 .          ,       .',
            shortDescription: '  30  ()',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1,
        },
        {
            name: '  ()',
            engName: 'Breath Weapon (Poison)',
            description: '    ,    .      ,      (15  ())    .  = 8 +    +   .   26          .    36  6 , 46  11   56  16 .          ,       .',
            shortDescription: '  15  ()',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1,
        },
        {
            name: '  ()',
            engName: 'Breath Weapon (Cold)',
            description: '    ,    .      ,      (15  ())    .  = 8 +    +   .   26          .    36  6 , 46  11   56  16 .          ,       .',
            shortDescription: '  15  ()',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1,
        },

        {
            name: ' ',
            engName: 'Draconic Resistance',
            description: '     , \'    .',
            shortDescription: '    ',
            displayType: [FeatureDisplayType.PASSIVE]
            //       (////)
        },


        // ============   ============
        {
            name: ' ',
            engName: 'Natural Armor',
            description: '   ,  .     ,     13 +   .          ,  ,   ,     .     .',
            shortDescription: ' = 13 + ',
            displayType: [FeatureDisplayType.PASSIVE],
            modifiesAC: {
                naturalArmor: {
                    baseAC: 13,
                    addsDex: true
                }
            }
        },
        {
            name: ' ',
            engName: 'Scaled Body',
            description: '    .     ,    13 +   .          .',
            shortDescription: ' = 13 + ',
            displayType: [FeatureDisplayType.PASSIVE],
            modifiesAC: {
                naturalArmor: {
                    baseAC: 13,
                    addsDex: true
                }
            }
        },

        // ============    ============
        {
            name: '',
            engName: 'Nimble',
            description: '  .        .',
            shortDescription: ' ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Halfling Nimbleness',
            description: '       .',
            shortDescription: '    ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '',
            engName: 'Nimbleness',
            description: '     - ,     .',
            shortDescription: '    ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // ============   () ============
        {
            name: ' ',
            engName: 'Infernal Legacy',
            description: '    [Thaumaturgy].    3- ,         [Hellish Rebuke]   2- .    5- ,         [Darkness].     [Hellish Rebuke]   [Darkness]       ,     .      ,  -    ,    .       ,      .',
            shortDescription: ' [Thaumaturgy],   [Hellish Rebuke],  [Darkness]',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Thaumaturgy' },
                    { engName: 'Hellish Rebuke' },
                    { engName: 'Darkness' }
                ]
            }
        },

        // ============   ============
        {
            name: '\' ',
            engName: 'Dwarven Toughness',
            description: '  -   1,     1  ,    .',
            shortDescription: '+1 HP  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '',
            engName: 'Stonecunning',
            description: '     ,    \' ',
            shortDescription: '        ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Dwarven Armor Training',
            description: '      .',
            shortDescription: '    ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Elf Weapon Training',
            description: '   ,  ,     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Menacing',
            description: '   .',
            shortDescription: ' ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Natural Instinct',
            description: '       .',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // ============   2024 ============
        {
            name: '',
            engName: 'Ingenious',
            description: '      ,     +4.       ,     ,         .',
            shortDescription: '+4     ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,  //  
        },
        {
            name: ' ',
            engName: 'Astral Knowledge',
            description: '       .     ,                 ,    .     ,      ,    ,       .',
            shortDescription: ' /  ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: ' ',
            engName: 'Savage Attacks',
            description: '      ,                   .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // ############################################## MPMM

        {
            name: '',
            engName: 'Flight',
            description: '  ,    ,     .       ,      .',
            shortDescription: '  =  ,       ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '',
            engName: 'Talons',
            description: '  ,       .    ,   16 +        ,     .',
            shortDescription: '  16 + ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Wind Caller',
            description: '  3- ,       [Gust of Wind]  ,    .            ,     .      ,  -   2-   ,    . ,         ,       (     ).',
            shortDescription: '  [Gust of Wind] 1    ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
            givesSpells: {
                connect: [{ engName: 'Gust of Wind' }]
            }
        },

        // ============ AASIMAR ============
        {
            name: ' ',
            engName: 'Healing Hands',
            description: '         \',     .          ,     .',
            shortDescription: ' =  ',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: '',
            engName: 'Light Bearer',
            description: '    [Light].',
            shortDescription: '  [Light]',
            displayType: [FeatureDisplayType.PASSIVE],
            givesSpells: {
                connect: [{ engName: 'Light' }]
            }
        },

// ============ AASIMAR PROTECTOR ============
        {
            name: ' ',
            engName: 'Celestial Revelation',
            description: '   3- ,      .       ,      ,    .    1         .          ,     :\n\n .       ,         . ,   ,   10   ,    ,     ( = 8 +    +   )         .   ,     ,        ,       .      .\n\n .         .         10       10 ,          10      ,     .   ,     ,        ,       .      .\n\n .         .       ,     ,              ,       .      .',
            shortDescription: ': // +  ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },


// ============ BUGBEAR ============
        {
            name: ' ',
            engName: 'Surprise Attack',
            description: '        ,     26  .          .',
            shortDescription: '+26    ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Long-Limbed',
            description: '        ,       5 .',
            shortDescription: '+5    ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '',
            engName: 'Sneaky',
            description: '   .  ,  ,       ,    .',
            shortDescription: '  +       ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

// ============ CENTAUR ============
        {
            name: '',
            engName: 'Charge',
            description: '     30    ,           ,          .',
            shortDescription: '     30 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '',
            engName: 'Hooves',
            description: '  ,       .    ,     16 +   .',
            shortDescription: '   16 + ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Equine Build',
            description: '     ,      ,      .\n' +
                '\n' +
                ' , ,     ,         .          4     1.',
            shortDescription: ' 1  = 4;    ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

// ============ CHANGELING ============
        {
            name: '',
            engName: 'Shapechanger',
            description: '         .  ,  ,   , , ,  ,   ,  ,      .     ,        .      ,    ,           ,   .      .     ,            .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.ACTION]
        },

// ============ DEEP GNOME ============
        {
            name: '\' ',
            engName: 'Stone Camouflage',
            description: '      (),    \' .',
            shortDescription: '    ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        {
            name: ' ',
            engName: 'Gift of the Svirfneblin',
            description: '  3- ,      [Disguise Self]  .   5- ,        [Nondetection],    .             ,     .      ,  -    ,    . ,         ,       (     ).',
            shortDescription: ' [Disguise Self],   [Nondetection]',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Disguise Self' },
                    { engName: 'Nondetection' }
                ]
            }
        },
        {
            name: '  ',
            engName: 'Gnomish Magic Resistance',
            description: '     ,     .',
            shortDescription: '   ,     ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Svirfneblin Camouflage',
            description: '    ,      .       ,     ,         .',
            shortDescription: '   .  =     ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,  //  
        },

// ============ DUERGAR ============
        {
            name: ' ',
            engName: 'Duergar Resilience',
            description: '           .',
            shortDescription: '  , , ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Duergar Magic',
            description: '   3- ,       / [Enlarge/Reduce]  .    5- ,         [Invisibility]  .             ,     .      ,  -    ,    . ,         ,       (     ).',
            shortDescription: '/ [Enlarge/Reduce],  [Invisibility]',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Enlarge/Reduce' },
                    { engName: 'Invisibility' }
                ]
            }
        },
        {
            name: ' ',
            engName: 'Psionic Fortitude',
            description: '    ,   ,          .',
            shortDescription: '    ',
            displayType: [FeatureDisplayType.PASSIVE],
        },


// ============ ELADRIN ============
        {
            name: ' ',
            engName: 'Fey Step',
            description: '         30    ,   .       ,     ,         .\n\n   3- ,          ;    ,   8 +    +   ,    (     ):\n\n.   ,      ,      ,      10   ,          1 ,         -   .\n\n.      ,     ,      5     ,             .\n\n.      ,         5   .     , \'      ,      30   .\n\n.   ,      ,     ,      5   ,   ,     .',
            shortDescription: ' 30  +  ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,  //  
        },

// ============ FAIRY ============
        {
            name: ' ',
            engName: 'Fairy Magic',
            description: '     [Druidcraft].    3- ,         [Faerie Fire].    5- ,        / [Enlarge/Reduce].     [Faerie Fire]  / [Enlarge/Reduce]       ,     .      ,  -    ,    . ,         ,       (     ).',
            shortDescription: '  [Druidcraft],   [Faerie Fire], / [Enlarge/Reduce]',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Druidcraft' },
                    { engName: 'Faerie Fire' },
                    { engName: 'Enlarge/Reduce' }
                ]
            }
        },

// ============ FIRBOLG ============
        {
            name: ' ',
            engName: 'Hidden Step',
            description: '              ,   ,       .          ,       .',
            shortDescription: ' ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },
        {
            name: ' ',
            engName: 'Powerful Build',
            description: '           ,    ,   .',
            shortDescription: ' ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Firbolg Magic',
            description: '        [Detect Magic]   [Disguise Self].       [Disguise Self],     3    .             ,     .      ,  -  ,    . ,         ,       (     ).',
            shortDescription: '  [Detect Magic],  [Disguise Self]',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Detect Magic' },
                    { engName: 'Disguise Self' }
                ]
            }
        },
        {
            name: '   ',
            engName: 'Speech of Beast and Leaf',
            description: '        ,   .      ,          .       ,   ,    .',
            shortDescription: '     +     ',
            displayType: [FeatureDisplayType.PASSIVE]
        },


// ============ GENASI AIR ============
        {
            name: '  ',
            engName: 'Mingle with the Wind',
            description: '     [Shocking Grasp].    3- ,        \' [Feather Fall].    5- ,         [Levitate]  .    \' [Feather Fall]   [Levitate]       ,     .      ,  -    ,    . ,         ,       (     ).',
            shortDescription: '  [Shocking Grasp],  \' [Feather Fall],  [Levitate]',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Shocking Grasp' },
                    { engName: 'Feather Fall' },
                    { engName: 'Levitate' }
                ]
            }
        },
        {
            name: '  ',
            engName: 'Lightning Resistance',
            description: '     .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Unending Breath',
            description: '     ,    .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

// ============ GENASI EARTH ============
        {
            name: '  ',
            engName: 'Merge with Stone',
            description: '      [Blade Ward].      ,   -   ,     ,         .    5- ,          [Pass without Trace].      [Pass without Trace]       ,     .      ,  -    ,    . ,         ,       (     ).',
            shortDescription: '   [Blade Ward],    [Pass without Trace]',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,  //  
            givesSpells: {
                connect: [
                    { engName: 'Blade Ward' },
                    { engName: 'Pass without Trace' }
                ]
            }
        },
        {
            name: ' ',
            engName: 'Earth Walk',
            description: '     ,    ,          .',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE]
        },


// ============ GENASI FIRE ============
        {
            name: ' \'',
            engName: 'Reach to the Blaze',
            description: '     [Produce Flame].    3- ,         [Burning Hands]   1- .    5- ,          [Flaming Sphere]   2- .     [Burning Hands]    [Flaming Sphere]       ,     .      ,  -    ,    . ,         ,       (     ).',
            shortDescription: '  [Produce Flame],   [Burning Hands],   [Flaming Sphere]',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Produce Flame' },
                    { engName: 'Burning Hands' },
                    { engName: 'Flaming Sphere' }
                ]
            }
        },

// ============ GENASI WATER ============
        {
            name: ' ',
            engName: 'Call to the Wave',
            description: '     [Shape Water].    3- ,           [Create or Destroy Water]   1- .    5- ,          [Water Breathing].       [Create or Destroy Water]    [Water Breathing]       ,     .      ,  -    ,    . ,         ,       (     ).',
            shortDescription: '  [Shape Water],     [Create or Destroy Water],   [Water Breathing]',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Shape Water' },
                    { engName: 'Create or Destroy Water' },
                    { engName: 'Water Breathing' }
                ]
            }
        },
        {
            name: '  ',
            engName: 'Acid Resistance',
            description: '     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '',
            engName: 'Amphibious',
            description: '     .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },


// ============ GITHYANKI ============
        {
            name: ' ',
            engName: 'Githyanki Psionics',
            description: '     [Mage Hand],   ,       .    3- ,      [Jump]  .    5- ,        [Misty Step]  .  ,     [Jump]    [Misty Step]  ,         ,     .     -   ,  -    ,    . ,         ,       (     ).        ,      .',
            shortDescription: '  [Mage Hand],  [Jump],   [Misty Step]',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Mage Hand' },
                    { engName: 'Jump' },
                    { engName: 'Misty Step' }
                ]
            }
        },
        {
            name: ' ',
            engName: 'Psychic Resilience',
            description: '     .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },


// ============ GITHZERAI ============
        {
            name: ' ',
            engName: 'Mental Discipline',
            description: '                       ,     .',
            shortDescription: '  ,  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Githzerai Psionics',
            description: '     [Mage Hand],   ,       .    3- ,        [Shield].    5- ,          [Detect Thoughts].    [Shield]    [Detect Thoughts]       ,     .      ,  -    ,    . ,         ,       (     ).        ,      .',
            shortDescription: '  [Mage Hand],  [Shield],   [Detect Thoughts]',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Mage Hand' },
                    { engName: 'Shield' },
                    { engName: 'Detect Thoughts' }
                ]
            }
        },

// ============ GOBLIN ============
        {
            name: ' ',
            engName: 'Fury of the Small',
            description: '       ,       ,      ,     .          ,       ,          ',
            shortDescription: '        =  ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },
        {
            name: ' ',
            engName: 'Nimble Escape',
            description: '             .',
            shortDescription: '/  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

// ============ GOLIATH ============
        {
            name: ' ',
            engName: 'Stone\'s Endurance',
            description: ',    ,       112 +   .      =  .',
            shortDescription: '   112 + ',
            displayType: [FeatureDisplayType.REACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCountDependsOnProficiencyBonus: true,  //  
        },
        {
            name: ' ',
            engName: 'Little Giant',
            description: '   ,             ,    ,   .',
            shortDescription: '  +      ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Mountain Born',
            description: '     .       ,        .     20,000 .',
            shortDescription: '   +   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

// ============ HARENGON ============
        {
            name: ' ',
            engName: 'Hare-Trigger',
            description: '         .',
            shortDescription: '+   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Leporine Senses',
            description: '    .',
            shortDescription: ' ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Lucky Footwork',
            description: '    ,     ,   14  ,     .      ,        0.',
            shortDescription: '+14    ',
            displayType: [FeatureDisplayType.REACTION],
        },
        {
            name: ' ',
            engName: 'Rabbit Hop',
            description: '       ,   \'   ,   .     ,       0.      ,     ,         .',
            shortDescription: '  5    ',
            displayType: [FeatureDisplayType.RESOURCE, FeatureDisplayType.BONUSACTION],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,  //  
        },

// ============ HOBGOBLIN ============
        {
            name: '  ',
            engName: 'Fortune from the Many',
            description: '         ,      ,    ,       30    (  +3).      ,     ,         .',
            shortDescription: '+1-3   -   ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,  //  
        },
        {
            name: ' ',
            engName: 'Fey Gift',
            description: '    ,       ,       ,     .         .\n\n  3- ,       ,         :\n\n.   ,   ,    -,   16 +   .\n\n.   ,   ,      10      .\n\n.     ,  ,   ,      ,        ,      .',
            shortDescription: '   +   (HP//)',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,  //  
        },


// ============ KENKU ============
        {
            name: '\' ',
            engName: 'Kenku Recall',
            description: '   \',        .  ,     ,  - ,   ,          20.      ,     ,         .',
            shortDescription: '2  +   ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,  //  
        },
        {
            name: '',
            engName: 'Mimicry',
            description: '    ,   ,  . ,   ,   ,  ,   ,      ( )   8 +    +   .',
            shortDescription: '      8 +  + ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Expert Duplication',
            description: '       ,     ,     -  ,       .',
            shortDescription: '      ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

// ============ KOBOLD ============
        {
            name: ' ',
            engName: 'Draconic Cry',
            description: '           10   .                -   ,    .       ,     ,         .',
            shortDescription: '        ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,  //  
        },

// ============ LIZARDFOLK ============
        {
            name: ' ',
            engName: 'Hold Breath',
            description: '     15 .',
            shortDescription: '  15 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Hungry Jaws',
            description: '     .         .   ,    ,     -,     .       ,     ,         .',
            shortDescription: '     +  ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,  //  
        },
        {
            name: '',
            engName: 'Bite',
            description: '   ,      .    ,   16 +        ,    .',
            shortDescription: '  16 +   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

// ============ MINOTAUR ============
        {
            name: '',
            engName: 'Horns',
            description: '  ,       .    ,     16 +   .',
            shortDescription: '  16 + ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Goring Rush',
            description: '         20    ,      ()  .',
            shortDescription: '      20   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Hammering Horns',
            description: '        ,    ,       .            .    ,        = 8 +    +   .       10   .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' \'',
            engName: 'Labyrinthine Recall',
            description: '  ,   ,      -   (),       .',
            shortDescription: '   +   /',
            displayType: [FeatureDisplayType.PASSIVE]
        },

// ============ ORC ============
        {
            name: ' ',
            engName: 'Adrenaline Rush',
            description: '      .    ,     -,     .       ,     ,         .',
            shortDescription: ' +  HP',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,  //  
        },

// ============ SATYR ============
        {
            name: ' ',
            engName: 'Magic Resistance',
            description: '      .',
            shortDescription: '    ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Mirthful Leaps',
            description: '       ,    8      ,   ,      .       .',
            shortDescription: '+8   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '',
            engName: 'Reveler',
            description: '      ,        .',
            shortDescription: '    +  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '',
            engName: 'Ram',
            description: '         .    ,   16 +     ',
            shortDescription: '  16 +   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

// ============ SEA ELF ============
        {
            name: '  ',
            engName: 'Sea Elf Training',
            description: '  , ,    .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Child of the Sea',
            description: '    30 ,    ,      ',
            shortDescription: ' 30 ,    +  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Friend of the Sea',
            description: '       .      - ,    .     ,          .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

// ============ SHADAR-KAI ============
        {
            name: '  ',
            engName: 'Blessing of the Raven Queen',
            description: '         30    ,   .   3 ,              ,        .       ,     ,         .',
            shortDescription: ' 30  +  ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST
        },
        {
            name: ' ',
            engName: 'Necrotic Resistance',
            description: '     .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

// ============ SHIFTER ============
        {
            name: '',
            engName: 'Shifting',
            description: '       .    1 ,      ,      .   ,    -,     +    ( 1).     ,      .          ,       .',
            shortDescription: '   1 ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },
        {
            name: ' ',
            engName: 'Bestial Instincts',
            description: '   ,          : , ,   .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

// ============ TABAXI ============
        {
            name: ' ',
            engName: 'Cat\'s Claws',
            description: '  ,       .    ,     16 +      ,     .',
            shortDescription: ' 16 + ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Cat\'s Talent',
            description: '      .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Feline Agility',
            description: '       ,        .          ,     0      .',
            shortDescription: ' ',
            displayType: [FeatureDisplayType.RESOURCE]
        },

// ============ TORTLE ============
        {
            name: ' ',
            engName: 'Shell Defense',
            description: '      .  ,   ,   +4   ,         .    ,   ,   0    ,      ,     ,   ,    ,   ,    .',
            shortDescription: '+4   ',
            displayType: [FeatureDisplayType.ACTION]
        },
        {
            name: ' ',
            engName: 'Nature\'s Intuition',
            description: '   \'  ,          :   , , , ,   .',
            shortDescription: '    (6 )',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Shell Armor',
            description: '      17 (       ).     ,    ,     ,       .',
            shortDescription: ' = 17 ( ),    ',
            displayType: [FeatureDisplayType.PASSIVE],
            modifiesAC: {
                naturalArmor: {
                    baseAC: 17,
                    addsDex: false
                }
            }
        },
        {
            name: '',
            engName: 'Claws',
            description: '  ,      .    ,   16 +        ,    .',
            shortDescription: '  16 +   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },


// ============ TRITON ============
        {
            name: '   ',
            engName: 'Control Air and Water',
            description: '        [Fog Cloud].    3- ,         [Gust of Wind].    5- ,           [Water Walk].          ,     .      ,  -    ,    . ,         ,       (     ).',
            shortDescription: '  [Fog Cloud],   [Gust of Wind],    [Water Walk]',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Fog Cloud' },
                    { engName: 'Gust of Wind' },
                    { engName: 'Water Walk' }
                ]
            }
        },
        {
            name: ' ',
            engName: 'Emissary of the Sea',
            description: '     - ,   ,    .     ,          .',
            shortDescription: '    (//)',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Guardian of the Depths',
            description: '    ,       .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

// ============ YUAN-TI ============
        {
            name: '  ',
            engName: 'Poison Resilience',
            description: '    ,   ,        .       .',
            shortDescription: '   +    ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Serpentine Spellcasting',
            description: '     [Poison Spray].        [Animal Friendship]       ,       .   3- ,       [Suggestion]    .        ,     .     ,  -   2-   ,    . ,         ,       (     ).',
            shortDescription: '  [Poison Spray],    [Animal Friendship] (),  [Suggestion]',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
            givesSpells: {
                connect: [
                    { engName: 'Poison Spray' },
                    { engName: 'Animal Friendship' },
                    { engName: 'Suggestion' }
                ]
            }
        },
        // ASTRAL ELF
        {
            name: ' ',
            engName: 'Astral Fire',
            description: '       :   [Dancing Lights],  [Light]   \' [Sacred Flame].   - ,    (     ).',
            shortDescription: '1 :   [Dancing Lights]/ [Light]/ \' [Sacred Flame]',
            displayType: [FeatureDisplayType.PASSIVE],
            // TODO: Races Choice Option   
        },
        {
            name: '  ',
            engName: 'Starlight Step',
            description: '         30    ,  .      ,    ,        .',
            shortDescription: ' 30  ( )',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            // usesCount   
        },
        {
            name: ' ',
            engName: 'Astral Trance',
            description: '   ,      .       4   .                    .        .',
            shortDescription: ' 4  +  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

// AUTOGNOME
        {
            name: ' ',
            engName: 'Armored Casing',
            description: '        .     ,      13 +   .',
            shortDescription: ' 13 +  (  )',
            displayType: [FeatureDisplayType.PASSIVE],
            modifiesAC: {
                naturalArmor: { baseAC: 13, addsDex: true }
            }
        },
        {
            name: '  ',
            engName: 'Built for Success',
            description: '   4    ,    ,       20,   ,     .      ,   ,       .',
            shortDescription: '+4   ( )',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST
        },
        {
            name: ' ',
            engName: 'Healing Machine',
            description: '      [Mending],     ,      ,    +    ( 1).  ,     ,     ,   ,      :   [Cure Wounds],   [healing word],    [Mass Cure Wounds],    [Mass Healing Word]     [Spare the Dying].',
            shortDescription: 'Mending  +  healing ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Mechanical Nature',
            description: '         ,        .    ,   .',
            shortDescription: '  ,   ,       ,   ,   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Sentry\'s Rest',
            description: '    ,    6   ,    .      ,    .',
            shortDescription: '6    ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Specialized Design',
            description: '          .',
            shortDescription: ' 2 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

// GIFF
        {
            name: ' ',
            engName: 'Astral Spark',
            description: '            ,       .         ,         ,     .       ,     ,       .         .',
            shortDescription: '    =  ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
        },
        {
            name: '  ',
            engName: 'Firearms Mastery',
            description: '    .      ,    20  1  2  .',
            shortDescription: ' firearms +  1-2  20',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Hippo Build',
            description: '     ,    ,   .  ,            ,    ,   .',
            shortDescription: '      +  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

// HADOZEE
        {
            name: ' ',
            engName: 'Dexterous Feet',
            description: '        \',      ,     \'.',
            shortDescription: ' :  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '',
            engName: 'Glide',
            description: '      10   ,     ,           ,     ,    0   .    .',
            shortDescription: '     + 0   ',
            displayType: [FeatureDisplayType.RESOURCE],
        },
        {
            name: ' ',
            engName: 'Hadozee Resilience',
            description: ',     ,   .   ,    6,           ( 0).       ,     .         .',
            shortDescription: ':    6 + ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST
        },

// PLASMOID -      !

        {
            name: ' ',
            engName: 'Shape Self',
            description: '      ,   ,    ,         ,       .     ,      ,     .         15     10        .           ,   \',      ,      \'.         ,       5 .',
            shortDescription: '   +   ',
            displayType: [FeatureDisplayType.ACTION],
        },
        {
            name: '',
            engName: 'Amorphous',
            description: '       2.5 ,  ,        .       ,   ,      .',
            shortDescription: '  2.5  +    ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Natural Resilience',
            description: '       ,        .',
            shortDescription: '     +     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },


// THRI-KREEN
        {
            name: '-',
            engName: 'Chameleon Carapace',
            description: '   ,       13 +  .     ,      ()     .',
            shortDescription: ' 13 +  + ',
            displayType: [FeatureDisplayType.ACTION],
            modifiesAC: {
                naturalArmor: { baseAC: 13, addsDex: true }
            }
        },
        {
            name: ' ',
            engName: 'Secondary Arms',
            description: '        .     \', / ,   \'      .',
            shortDescription: '2    ( )',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '',
            engName: 'Sleepless',
            description: '   ,          ,        ,     ',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' -',
            engName: 'Thri-kreen Telepathy',
            description: '        - .           120 .       ,     .   \'   ,          120  ( 36 ),              (   ).',
            shortDescription: ' 120 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        // ============ KENDER (DRAGONLANCE) ============
        {
            name: '',
            engName: 'Fearless',
            description: '    ,   ,        .    ,        ,      .  ,        ,      ,     .',
            shortDescription: '   + 1    ',
            displayType: [FeatureDisplayType.PASSIVE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
        },
        {
            name: ' ',
            engName: 'Kender Aptitude',
            description: '    ,          :  , ,  ,   .',
            shortDescription: ' 1   5 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '',
            engName: 'Taunt',
            description: '       .             60   ,      .     ,         ,  ,     .   8 +    +   ,    (     ).        ,     ,         .',
            shortDescription: ' :       ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST
        },

// ============ GRUNG (ONE GRUNG ABOVE) ============
        {
            name: ' ',
            engName: 'Arboreal Alertness',
            description: '    .',
            shortDescription: ' ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '  ',
            engName: 'Poison Immunity',
            description: '        .',
            shortDescription: '      ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Poisonous Skin',
            description: '- ,             ,       12     1 .  ,       ,        ,      . \n \n        -       ,    ,   .         12,   24  .\n',
            shortDescription: '   =  12     1 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Standing Leap',
            description: '      25 ,       15 ,    .',
            shortDescription: ': 25   , 15   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Water Dependency',
            description: '        1   ,        .     ,   ,       1 .',
            shortDescription: ' 1      ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

// ============ LOCATHAH (LOCATHAH RISING) ============
// :     Locathah   ac: {base: 17, bonus: Ability.DEX}
//  : ac: {base: 12, bonus: Ability.DEX}
        {
            name: '  ',
            engName: 'Locathah Natural Armor',
            description: '  ,  .     ,     12 +   .          ,  ,   ,     .     .',
            shortDescription: ' = 12 + ',
            displayType: [FeatureDisplayType.PASSIVE],
            modifiesAC: {
                naturalArmor: {
                    baseAC: 12,
                    addsDex: true
                }
            }
        },
        {
            name: '  ',
            engName: 'Observant and Athletic',
            description: '      .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Leviathan Will',
            description: '      ,   , , , ,   .',
            shortDescription: '    6 ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Limited Amphibiousness',
            description: '     ,         4 ,   .',
            shortDescription: '   ,     4 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

// ============ CENTAUR (GGTR) ============
//       !

// ============ LOXODON (GGTR) ============
// :     Loxodon   ac: {base: 17, bonus: Ability.CON}
//  : ac: {base: 12, bonus: Ability.CON}
        {
            name: '  ',
            engName: 'Loxodon Natural Armor',
            description: '  ,  .     ,     12 +   .          ,  ,   ,     .     .',
            shortDescription: ' = 12 + ',
            displayType: [FeatureDisplayType.PASSIVE],
            modifiesAC: {
                naturalArmor: {
                    baseAC: 12,
                    addsCon: true
                }
            }
        },
        {
            name: ' ',
            engName: 'Loxodon Serenity',
            description: '      ,     .',
            shortDescription: '    ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Keen Smell',
            description: '   ,       (),  ()   (),   .',
            shortDescription: '  //  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '',
            engName: 'Trunk',
            description: '     ,        .    5      ,   \'   .         : , , ,    \'  ;      ;  ;    .            .          ,    , ,          .',
            shortDescription: ':  5 ,  5 ,  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

// ============ MINOTAUR (GGTR) ============
// Horns, Goring Rush, Hammering Horns -      

// ============ SIMIC HYBRID (GGTR) ============
        {
            name: ' ',
            engName: 'Animal Enhancements',
            description: '     .          5 .\n\n 1 :\n\n  (Manta Glide):    ,       .       ,     100               2    1  .\n\n  (Nimble Climber):    ,     .\n\n  (Underwater Adaptation):      ,     ,     .\n\n 5 :\n\n   (Grappling Appendages):     ,      . ,    ,  .       ,   .       ,      .   ,   16 +     .          .       ,      .\n\n (Carapace):      .   +1   ,     .\n\n  (Acid Spit):         ,      \',      30   .        = 8 +    +   .   210    .    310  11   410  17 .      ,     ,   .',
            shortDescription: '    1  5 ',
            displayType: [FeatureDisplayType.PASSIVE],
        },


// ============ VEDALKEN (GGTR) ============
        {
            name: ' ',
            engName: 'Vedalken Dispassion',
            description: '      ,   .',
            shortDescription: '   INT/WIS/CHA ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Tireless Precision',
            description: '        : , , , ,    .        .  ,          ,  4   ,  ,    .',
            shortDescription: '1  + 1  + 4    ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Partially Amphibious',
            description: '  ,         1 .          ,     .',
            shortDescription: '   1    ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },

// ============ VERDAN (ACQUISITIONS INCORPORATED) ============
        {
            name: '  ',
            engName: 'Black Blood Healing',
            description: ' ,    \'    --,    .    1  2  -  ,      ,         .',
            shortDescription: ' 1-2  Hit Dice   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Limited Telepathy',
            description: '     - ,      30 .        ,     ,       .       ,           .',
            shortDescription: '    30 ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '',
            engName: 'Persuasive',
            description: '         .     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Telepathic Insight',
            description: '\'         .         .',
            shortDescription: '     ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

// ============ KALASHTAR (EBERRON) ============
        {
            name: ' ',
            engName: 'Dual Mind',
            description: '      .',
            shortDescription: '   WIS ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '  ',
            engName: 'Kalashtar Mental Discipline',
            description: '     .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' \'',
            engName: 'Mind Link',
            description: '     - ,   ,  ,       ,   10    .      ,      ,       .\n\n         ,     ,           1         .    ,           .          ;         ,   .',
            shortDescription: '   10    +  \'',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '  ',
            engName: 'Severed from Dreams',
            description: ' ,    \'   ,     .             .  ,       ,      , -   [Dream],      ,   , -   [Sleep].',
            shortDescription: '   ,   ',
            displayType: [FeatureDisplayType.PASSIVE],
        },


// ============ WARFORGED (EBERRON) ============
        {
            name: ' ',
            engName: 'Constructed Resilience',
            description: '  ,    .       ,   ,       .     .    ,   .    ,      .',
            shortDescription: '   +   poison +    +  ///',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Integrated Protection',
            description: '     ,     .    +1   .     ,    .   ,         1 ,        .   ,    1 ,  .   ,       .   ,           .',
            shortDescription: '+1  + 1   / ',
            displayType: [FeatureDisplayType.PASSIVE],
            givesAC: 1,
        },
        {
            name: ' ',
            engName: 'Warforged Specialized Design',
            description: '              .',
            shortDescription: ' 1  + 1 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

// ============ LEONIN (MYTHIC ODYSSEYS OF THEROS) ============
        {
            name: ' ',
            engName: 'Leonin Claws',
            description: '    ,       .    ,     14 +      ,    .',
            shortDescription: '  14 +  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Hunter\'s Instincts',
            description: '        : , ,   .',
            shortDescription: ' 1  4 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Daunting Roar',
            description: '       .       10   ,    ,             .   8 +    +   .          ,       .',
            shortDescription: ' :     10 ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },

// ============ DHAMPIR (VAN RICHTEN'S GUIDE TO RAVENLOFT) ============
        {
            name: ' ',
            engName: 'Dhampir Deathless Nature',
            description: '   .',
            shortDescription: '   .',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: ' ',
            engName: 'Spider Climb',
            description: '   ,     .  ,  3-     ,          ,   .',
            shortDescription: '  =   +   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Vampiric Bite',
            description: '     ,      ,   .             ,    .   14    .        -,      ,     .\n\n        ,      ,           :\n\n   -,    ,  .\n\n          ,   ;    ,  .\n\n       ,     ,          .',
            shortDescription: '    (14) +   ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
        },


// ============ HEXBLOOD (VAN RICHTEN'S) ============
        {
            name: ' ',
            engName: 'Eerie Token',
            description: '        ,         .    ,      .     ,     :\n\n :       ,     ,  ,      10   .      \' .\n\n :      10   ,      .   1 ,   ,     (  )   .            ,    ,   .         ,        .   ,   .\n\n ,        ,      ,     ,      .',
            shortDescription: '      ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1,
        },
        {
            name: ' ',
            engName: 'Hex Magic',
            description: '     [Disguise Self]   [Hex]  .  ,         ,        ,     .      ,  -  ,    .\n\n,           ( ,   ).',
            shortDescription: ' [Disguise Self]   [Hex]   ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Disguise Self' },
                    { engName: 'Hex' }
                ]
            }
        },

// ============ REBORN (VAN RICHTEN'S) ============
        {
            name: ' ',
            engName: 'Deathless Nature',
            description: '  , ,   :\n\n         ,       .\n\n       .\n\n    ,   .\n\n    ,      .       4 ,       ,  ,      .',
            shortDescription: '     +   //',
            displayType: [FeatureDisplayType.PASSIVE],
        },
        {
            name: '   ',
            engName: 'Knowledge from a Past Life',
            description: '  \'  , ,        .     ,   ,    6   ,     20,     6  .       ,     ,          .',
            shortDescription: '+16     ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCountDependsOnProficiencyBonus: true,  //  
        },


// ============ OWLIN (STRIXHAVEN) ============
        {
            name: ' \'',
            engName: 'Silent Feathers',
            description: '    .',
            shortDescription: ' ',
            displayType: [FeatureDisplayType.PASSIVE],
        },

        // ============ TIEFLING VARIANT FEATURES ============

        // --- SCAG BLOODLINES ---
        
        // Asmodeus (PHB default, explicit variant)
        {
            name: '  ()',
            engName: 'Infernal Legacy (Asmodeus)',
            description: '   <a href="/spell/1357"> [Thaumaturgy]</a>.    3- ,       <a href="/spell/1320">  [Hellish Rebuke]</a>.    5- ,        <a href="/spell/1249"> [Darkness]</a>.             ,     .        .',
            shortDescription: ',   (3),  (5)',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Thaumaturgy' },
                    { engName: 'Hellish Rebuke' },
                    { engName: 'Darkness' }
                ]
            }
        },
        
        // Baalzebul
        {
            name: '  ()',
            engName: 'Infernal Legacy (Baalzebul)',
            description: '   <a href="/spell/1357"> [Thaumaturgy]</a>.    3- ,       <a href="/spell/1499">  [Ray of Sickness]</a>.    5- ,        <a href="/spell/1501">  [Crown of Madness]</a>.             ,     .        .',
            shortDescription: ',   (3),   (5)',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Thaumaturgy' },
                    { engName: 'Ray of Sickness' },
                    { engName: 'Crown of Madness' }
                ]
            }
        },
        
        // Dispater
        {
            name: '  ()',
            engName: 'Infernal Legacy (Dispater)',
            description: '   <a href="/spell/1357"> [Thaumaturgy]</a>.    3- ,       <a href="/spell/1332"> [Disguise Self]</a>.    5- ,        <a href="/spell/1297">  [Detect Thoughts]</a>.             ,     .        .',
            shortDescription: ',  (3),   (5)',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Thaumaturgy' },
                    { engName: 'Disguise Self' },
                    { engName: 'Detect Thoughts' }
                ]
            }
        },
        
        // Fierna
        {
            name: '  ()',
            engName: 'Infernal Legacy (Fierna)',
            description: '   <a href="/spell/1494"> [Friends]</a>.    3- ,       <a href="/spell/1318">  [Charm Person]</a>.    5- ,        <a href="/spell/1277"> [Suggestion]</a>.             ,     .        .',
            shortDescription: ',   (3),  (5)',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Friends' },
                    { engName: 'Charm Person' },
                    { engName: 'Suggestion' }
                ]
            }
        },
        
        // Glasya
        {
            name: '  ()',
            engName: 'Infernal Legacy (Glasya)',
            description: '   <a href="/spell/1351">  [Minor Illusion]</a>.    3- ,       <a href="/spell/1332"> [Disguise Self]</a>.    5- ,        <a href="/spell/1276"> [Invisibility]</a>.             ,     .        .',
            shortDescription: ' ,  (3),  (5)',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Minor Illusion' },
                    { engName: 'Disguise Self' },
                    { engName: 'Invisibility' }
                ]
            }
        },
        
        // Levistus
        {
            name: '  ()',
            engName: 'Infernal Legacy (Levistus)',
            description: '   <a href="/spell/1342">  [Ray of Frost]</a>.    3- ,       <a href="/spell/1497">  [Armor of Agathys]</a>.    5- ,        <a href="/spell/1249"> [Darkness]</a>.             ,     .        .',
            shortDescription: ' ,   (3),  (5)',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Ray of Frost' },
                    { engName: 'Armor of Agathys' },
                    { engName: 'Darkness' }
                ]
            }
        },
        
        // Mammon
        {
            name: '  ()',
            engName: 'Infernal Legacy (Mammon)',
            description: '   <a href="/spell/1352">  [Mage Hand]</a>.    3- ,       <a href="/spell/1504">   [Tenser\'s Floating Disk]</a>.    5- ,        <a href="/spell/1300">  [Arcane Lock]</a>.             ,     .        .',
            shortDescription: ' ,    (3),   (5)',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Mage Hand' },
                    { engName: 'Tenser\'s Floating Disk' },
                    { engName: 'Arcane Lock' }
                ]
            }
        },
        
        // Mephistopheles
        {
            name: '  ()',
            engName: 'Infernal Legacy (Mephistopheles)',
            description: '   <a href="/spell/1352">  [Mage Hand]</a>.    3- ,       <a href="/spell/1321">  [Burning Hands]</a>.    5- ,        <a href="/spell/1363">  [Flame Blade]</a>.             ,     .        .',
            shortDescription: ' ,   (3),   (5)',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Mage Hand' },
                    { engName: 'Burning Hands' },
                    { engName: 'Flame Blade' }
                ]
            }
        },
        
        // Zariel
        {
            name: '  ()',
            engName: 'Infernal Legacy (Zariel)',
            description: '   <a href="/spell/1357"> [Thaumaturgy]</a>.    3- ,       <a href="/spell/1455">  [Searing Smite]</a>.    5- ,        <a href="/spell/1252">  [Branding Smite]</a>.             ,     .        .',
            shortDescription: ',   (3),   (5)',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Thaumaturgy' },
                    { engName: 'Searing Smite' },
                    { engName: 'Branding Smite' }
                ]
            }
        },
        
        // --- MTOF VARIANTS ---
        
        // Devil's Tongue
        {
            name: '  ( )',
            engName: 'Infernal Legacy (Devil\'s Tongue)',
            description: '   <a href="/spell/1356">  [Vicious Mockery]</a>.    3- ,       <a href="/spell/1318">  [Charm Person]</a>.    5- ,        <a href="/spell/1290">  [Enthrall]</a>.             ,     .        .',
            shortDescription: ' ,   (3),   (5)',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Vicious Mockery' },
                    { engName: 'Charm Person' },
                    { engName: 'Enthrall' }
                ]
            }
        },
        
        // Hellfire
        {
            name: '  ( )',
            engName: 'Infernal Legacy (Hellfire)',
            description: '   <a href="/spell/1357"> [Thaumaturgy]</a>.    3- ,       <a href="/spell/1321">  [Burning Hands]</a>.    5- ,        <a href="/spell/1249"> [Darkness]</a>.             ,     .        .',
            shortDescription: ',   (3),  (5)',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            givesSpells: {
                connect: [
                    { engName: 'Thaumaturgy' },
                    { engName: 'Burning Hands' },
                    { engName: 'Darkness' }
                ]
            }
        },
        
        // Winged
        {
            name: ' ',
            engName: 'Winged Tiefling',
            description: '    30 .    ,        .',
            shortDescription: '  30 ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // ============ DRAGONBORN ANCESTRY FEATURES ============

        // Draconic Ancestry - Damage Resistance
        {
            name: '  () - ',
            engName: 'Draconic Ancestry (Black)',
            description: '     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  () - ',
            engName: 'Draconic Ancestry (Blue)',
            description: '     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  () - ',
            engName: 'Draconic Ancestry (Brass)',
            description: '     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  () - ',
            engName: 'Draconic Ancestry (Bronze)',
            description: '     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  () - ',
            engName: 'Draconic Ancestry (Copper)',
            description: '     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  () - ',
            engName: 'Draconic Ancestry (Gold)',
            description: '     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  () - ',
            engName: 'Draconic Ancestry (Green)',
            description: '     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  () - ',
            engName: 'Draconic Ancestry (Red)',
            description: '     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  () - ',
            engName: 'Draconic Ancestry (Silver)',
            description: '     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  () - ',
            engName: 'Draconic Ancestry (White)',
            description: '     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // Gem Dragonborn - Damage Resistance
        {
            name: '  () - ',
            engName: 'Draconic Ancestry (Amethyst)',
            description: '     .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  () - ',
            engName: 'Draconic Ancestry (Crystal)',
            description: '     .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  () - ',
            engName: 'Draconic Ancestry (Emerald)',
            description: '     .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  () - ',
            engName: 'Draconic Ancestry (Sapphire)',
            description: '     .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  () - ',
            engName: 'Draconic Ancestry (Topaz)',
            description: '     .',
            shortDescription: '   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // Breath Weapon variants
        {
            name: '  ( - )',
            engName: 'Breath Weapon (Acid - Line)',
            description: '    ,    .      ,        .     8 +    +   .\n\n  26          .    36  6- , 46  11-  56  16- .\n\n**:**  5x30 \n**:** \n** :** \n\n          ,       .',
            shortDescription: ' 5x30 , 26   ( )',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },
        {
            name: '  ( - )',
            engName: 'Breath Weapon (Lightning - Line)',
            description: '    ,    .      ,        .     8 +    +   .\n\n  26          .    36  6- , 46  11-  56  16- .\n\n**:**  5x30 \n**:** \n** :** \n\n          ,       .',
            shortDescription: ' 5x30 , 26   ( )',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },
        {
            name: '  ( - )',
            engName: 'Breath Weapon (Fire - Line)',
            description: '    ,    .      ,        .     8 +    +   .\n\n  26          .    36  6- , 46  11-  56  16- .\n\n**:**  5x30 \n**:** \n** :** \n\n          ,       .',
            shortDescription: ' 5x30 , 26   ( )',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },
        {
            name: '  ( - )',
            engName: 'Breath Weapon (Fire - Cone)',
            description: '    ,    .      ,        .     8 +    +   .\n\n  26          .    36  6- , 46  11-  56  16- .\n\n**:**  15 \n**:** \n** :** \n\n          ,       .',
            shortDescription: ' 15 , 26   ( )',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },
        {
            name: '  ( - )',
            engName: 'Breath Weapon (Poison - Cone)',
            description: '    ,    .      ,        .     8 +    +   .\n\n  26          .    36  6- , 46  11-  56  16- .\n\n**:**  15 \n**:** \n** :** \n\n          ,       .',
            shortDescription: ' 15 , 26   ( )',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },
        {
            name: '  ( - )',
            engName: 'Breath Weapon (Cold - Cone)',
            description: '    ,    .      ,        .     8 +    +   .\n\n  26          .    36  6- , 46  11-  56  16- .\n\n**:**  15 \n**:** \n** :** \n\n          ,       .',
            shortDescription: ' 15 , 26   ( )',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },

        {
            name: '  ( - )',
            engName: 'Breath Weapon (Force - Cone)',
            description: '    ,    .      ,        .     8 +    +   .\n\n  26          .    36  6- , 46  11-  56  16- .\n\n**:**  15 \n**:** \n** :** \n\n          ,       .',
            shortDescription: ' 15 , 26   ( )',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },
        {
            name: '  ( - )',
            engName: 'Breath Weapon (Radiant - Cone)',
            description: '    ,    .      ,        .     8 +    +   .\n\n  26          .    36  6- , 46  11-  56  16- .\n\n**:**  15 \n**:** \n** :** \n\n          ,       .',
            shortDescription: ' 15 , 26   ( )',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },
        {
            name: '  ( - )',
            engName: 'Breath Weapon (Psychic - Cone)',
            description: '    ,    .      ,        .     8 +    +   .\n\n  26          .    36  6- , 46  11-  56  16- .\n\n**:**  15 \n**:** \n** :** \n\n          ,       .',
            shortDescription: ' 15 , 26   ( )',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },
        {
            name: '  ( - )',
            engName: 'Breath Weapon (Thunder - Cone)',
            description: '    ,    .      ,        .     8 +    +   .\n\n  26          .    36  6- , 46  11-  56  16- .\n\n**:**  15 \n**:** \n** :** \n\n          ,       .',
            shortDescription: ' 15 , 26   ( )',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },
        {
            name: '  ( - )',
            engName: 'Breath Weapon (Necrotic - Cone)',
            description: '    ,    .      ,        .     8 +    +   .\n\n  26          .    36  6- , 46  11-  56  16- .\n\n**:**  15 \n**:** \n** :** \n\n          ,       .',
            shortDescription: ' 15 , 26   ( )',
            displayType: [FeatureDisplayType.ACTION],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },

        // ============ HALF-ELF DRAGONMARKS (EBERRON) ============

        // Mark of Detection
        {
            name: ' ',
            engName: 'Deductive Intuition',
            description: '     ( [Investigation])   ( [Insight]),    4     .',
            shortDescription: '4  Investigation  Insight',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Magical Detection',
            description: '    <a href="/spell/1045">  [Detect Magic]</a>  <a href="/spell/1297">  [Detect Thoughts]</a>,       .        ,     .        .',
            shortDescription: 'Detect Magic  Detect Thoughts 1/',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: '  ',
            engName: 'Spells of the Mark (Detection)',
            description: '    Spellcasting  Pact Magic,          : <a href="/spell/1297">  [Detect Thoughts]</a>, <a href="/spell/1045">  [Detect Magic]</a>, <a href="/spell/1218"> [Clairvoyance]</a>, <a href="/spell/1205">  [Arcane Eye]</a>, <a href="/spell/1164">   [Legend Lore]</a>.',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // Mark of Storm
        {
            name: '  ',
            engName: 'Windwright\'s Intuition',
            description: '     ( [Acrobatics])  - , \'     ,    4     .',
            shortDescription: '4  Acrobatics  navigation',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Storm\'s Boon',
            description: '     .',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  ',
            engName: 'Headwinds',
            description: '   <a href="/spell/1416"> [Gust]</a>.   3- ,     <a href="/spell/1267">  [Gust of Wind]</a>,   .        ,     .        .',
            shortDescription: 'Gust cantrip + Gust of Wind 1/',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: '  ',
            engName: 'Spells of the Mark (Storm)',
            description: '    Spellcasting  Pact Magic,          : <a href="/spell/1267">  [Gust of Wind]</a>, <a href="/spell/1237"> [Lightning Bolt]</a>, <a href="/spell/1238"> [Sleet Storm]</a>, <a href="/spell/1191">  [Control Water]</a>, <a href="/spell/1170">  [Conjure Elemental]</a>.',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // ============ AASIMAR CELESTIAL REVELATION (CHOICE) ============

        {
            name: ' ',
            engName: 'Necrotic Shroud',
            description: '      ,     \'   .       10   ,    ,     ( 8 +   +  ).           .     ,      ,       110      (   ).   1      ,    .',
            shortDescription: ' + 110  ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: ' ',
            engName: 'Radiant Consumption',
            description: '       10 .           10       10 .              ,       10      ,     ( ).  ,      ,       110     .   1      ,    .',
            shortDescription: '   + 110  ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: ' ',
            engName: 'Radiant Soul',
            description: '       ,     30 .  ,      ,       110     .   1      ,    .',
            shortDescription: ' 30  + 110  ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },

        // ============ SHIFTER SHIFTING FORMS (CHOICE) ============

        {
            name: ':  ',
            engName: 'Shifting: Beasthide',
            description: '        .    1 ,      ,      .   ,    -,  16 +    ( 1).       +1   .',
            shortDescription: '16+  HP + AC +1',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },
        {
            name: ':  ',
            engName: 'Shifting: Longtooth',
            description: '        .    1 ,      ,      .   ,    -,  16 +    ( 1).      ;    16 +    .         .',
            shortDescription: '16+  HP +  16+',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },
        {
            name: ':  ',
            engName: 'Shifting: Swiftstride',
            description: '        .    1 ,      ,      .   ,    -,  16 +    ( 1).         10 . ,     10   ,        5   .       .',
            shortDescription: '16+  HP +  +10 ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },
        {
            name: ':  ',
            engName: 'Shifting: Wildhunt',
            description: '        .    1 ,      ,      .   ,    -,  16 +    ( 1).         ,      30            ,     .',
            shortDescription: '16+  HP +   ',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.SHORT_REST,
            usesCount: 1
        },

        // ============ DWARF DRAGONMARK (EBERRON) ============

        // Mark of Warding
        {
            name: '  ',
            engName: 'Warder\'s Intuition',
            description: '     ( [Investigation])     ,    ,    4     .',
            shortDescription: '4  Investigation ()   ',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Wards and Seals',
            description: '    <a href="/spell/1306">  [Alarm]</a>  <a href="/spell/1326">  [Mage Armor]</a>.   3- ,     <a href="/spell/1300">   [Arcane Lock]</a>.   -         ,     .        .',
            shortDescription: 'Alarm, Mage Armor, Arcane Lock 1/',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: '  ',
            engName: 'Spells of the Mark (Warding)',
            description: '    Spellcasting  Pact Magic,          : <a href="/spell/1306">  [Alarm]</a>, <a href="/spell/1300">  [Arcane Lock]</a>, <a href="/spell/1222">  [Glyph of Warding]</a>, <a href="/spell/1326">  [Mage Armor]</a>, <a href="/spell/1334">   [Leomund\'s Secret Chest]</a>.',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // ============ HALFLING DRAGONMARK (EBERRON) ============

        // Mark of Healing
        {
            name: ' ',
            engName: 'Medical Intuition',
            description: '     ( [Medicine])        [herbalism kit],    4     .',
            shortDescription: '4  Medicine  herbalism kit',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Healing Touch',
            description: '    <a href="/spell/1334">  [Cure Wounds]</a>.   3- ,      <a href="/spell/1281">  [Lesser Restoration]</a>.   -             ,     .        .',
            shortDescription: 'Cure Wounds  Lesser Restoration 1/',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: '  ',
            engName: 'Spells of the Mark (Healing)',
            description: '    Spellcasting  Pact Magic,          : <a href="/spell/1334">  [Cure Wounds]</a>, <a href="/spell/1303">  [Healing Word]</a>, <a href="/spell/1281">  [Lesser Restoration]</a>, <a href="/spell/1280">   [Prayer of Healing]</a>, <a href="/spell/1510">  [Aura of Vitality]</a>, <a href="/spell/1230">   [Mass Healing Word]</a>.',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // Mark of Hospitality
        {
            name: ' ',
            engName: 'Ever-Hospitable',
            description: '     ( [Persuasion])        [brewer\'s supplies]    [cook\'s utensils],    4     .',
            shortDescription: '4  Persuasion, brewer\'s supplies  cook\'s utensils',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Innkeeper\'s Magic',
            description: '   <a href="/spell/1050"> [Prestidigitation]</a>.      <a href="/spell/1323">    [Purify Food and Drink]</a>  <a href="/spell/1340"> [Goodberry]</a>       .   -        ,     .        .',
            shortDescription: 'Prestidigitation, Purify Food and Drink  Goodberry 1/',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: '  ',
            engName: 'Spells of the Mark (Hospitality)',
            description: '    Spellcasting  Pact Magic,          : <a href="/spell/1340"> [Goodberry]</a>, <a href="/spell/1323">    [Purify Food and Drink]</a>, <a href="/spell/1259"> [Aid]</a>, <a href="/spell/1298">  [Calm Emotions]</a>, <a href="/spell/1211">    [Create Food and Water]</a>, <a href="/spell/1513">   [Leomund\'s Tiny Hut]</a>.',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // ============ GNOME DRAGONMARK (EBERRON) ============

        // Mark of Scribing
        {
            name: ' ',
            engName: 'Gifted Scribe',
            description: '     ( [History])        [calligrapher\'s supplies],    4     .',
            shortDescription: '4  History  calligrapher\'s supplies',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Scribe\'s Insight',
            description: '   <a href="/spell/1344"> [Message]</a>.      <a href="/spell/1315">  [Comprehend Languages]</a>       .   3- ,      <a href="/spell/1282">  [Magic Mouth]</a>       .  ,    Comprehend Languages  Magic Mouth    ,       ,     .        .',
            shortDescription: 'Message, Comprehend Languages  Magic Mouth 1/',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: '  ',
            engName: 'Spells of the Mark (Scribing)',
            description: '    Spellcasting  Pact Magic,          : <a href="/spell/1315">  [Comprehend Languages]</a>, <a href="/spell/1049">  [Illusory Script]</a>, <a href="/spell/1251">  [Animal Messenger]</a>, <a href="/spell/1282">  [Magic Mouth]</a>, <a href="/spell/1220"> [Sending]</a>, <a href="/spell/1146">   [Arcane Page]</a>.',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // ============ HUMAN DRAGONMARK (EBERRON) ============

        // Mark of Finding
        {
            name: ' ',
            engName: 'Hunter\'s Intuition',
            description: '     ( [Perception])   ( [Survival]),    4     .',
            shortDescription: '4  Perception  Survival',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Finder\'s Magic',
            description: '    <a href="/spell/1331">  [Hunter\'s Mark]</a>.   3- ,      <a href="/spell/1265">  [Locate Object]</a>.  ,    -       ,      ,     .        .',
            shortDescription: 'Hunter\'s Mark  Locate Object 1/',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: '   ()',
            engName: 'Spells of the Mark (Finding)',
            description: '    Spellcasting  Pact Magic,          : <a href="/spell/1331">  [Hunter\'s Mark]</a>, <a href="/spell/1316"> [Identify]</a>, <a href="/spell/1265">  [Locate Object]</a>, <a href="/spell/1263">    [Locate Animals or Plants]</a>, <a href="/spell/1218"> [Clairvoyance]</a>, <a href="/spell/1214">   [Speak with Plants]</a>.',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // Mark of Handling
        {
            name: ' ',
            engName: 'Wild Intuition',
            description: '     (   [Animal Handling])   ( [Nature]),    4     .',
            shortDescription: '4  Animal Handling  Nature',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Primal Connection',
            description: '    <a href="/spell/1339">   [Animal Friendship]</a>  <a href="/spell/1317">   [Speak with Animals]</a>.   3- ,      <a href="/spell/1459">  [Beast Bond]</a>.  ,    -       ,      ,     .        .',
            shortDescription: 'Animal Friendship, Speak with Animals  Beast Bond 1/',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: '  ',
            engName: 'The Bigger They Are',
            description: '       [Animal Friendship]     [Speak with Animals],      (Monstrosity),     3  .',
            shortDescription: '    Monstrosity',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: '  ',
            engName: 'Spells of the Mark (Handling)',
            description: '    Spellcasting  Pact Magic,          : <a href="/spell/1339">   [Animal Friendship]</a>, <a href="/spell/1317">   [Speak with Animals]</a>, <a href="/spell/1459">  [Beast Bond]</a>, <a href="/spell/1548">  [Beast Sense]</a>, <a href="/spell/1298">  [Calm Emotions]</a>, <a href="/spell/1239">  [Conjure Animals]</a>, <a href="/spell/1185">  [Dominate Beast]</a>.',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // Mark of Making
        {
            name: ' ',
            engName: 'Artisan\'s Intuition',
            description: '     ( [Arcana])        [artisan\'s tools],    4     .',
            shortDescription: '4  Arcana  artisan\'s tools',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Maker\'s Gift',
            description: '   <a href="/spell/1353"> [Mending]</a>.',
            shortDescription: '  Mending',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Spellsmith',
            description: '    <a href="/spell/1283">  [Magic Weapon]</a>  .    ,   1     .   3- ,      <a href="/spell/1316"> [Identify]</a>  .  ,    -       ,          ,     .        .',
            shortDescription: 'Magic Weapon ( .)  Identify 1/',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: '  ',
            engName: 'Spells of the Mark (Making)',
            description: '    Spellcasting  Pact Magic,          : <a href="/spell/1316"> [Identify]</a>, <a href="/spell/1504">   [Tenser\'s Floating Disk]</a>, <a href="/spell/1295">  [Continual Flame]</a>, <a href="/spell/1283">  [Magic Weapon]</a>, <a href="/spell/1491">  [Elemental Weapon]</a>, <a href="/spell/1201"> [Fabricate]</a>, <a href="/spell/1140"> [Creation]</a>.',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // Mark of Passage
        {
            name: ' ',
            engName: 'Intuition of the Voyager',
            description: '     ( [Acrobatics])         [land vehicles],    4     .',
            shortDescription: '4  Acrobatics  land vehicles',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Magical Passage',
            description: '    <a href="/spell/1247">  [Misty Step]</a>   .   3- ,      <a href="/spell/1327">  [Expeditious Retreat]</a>.  ,    -       ,      ,     .        .',
            shortDescription: 'Misty Step  Expeditious Retreat 1/',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: '  ',
            engName: 'Spells of the Mark (Passage)',
            description: '    Spellcasting  Pact Magic,          : <a href="/spell/1327">  [Expeditious Retreat]</a>, <a href="/spell/1307"> [Jump]</a>, <a href="/spell/1247">  [Misty Step]</a>, <a href="/spell/1270">   [Pass without Trace]</a>, <a href="/spell/1221"> [Fly]</a>, <a href="/spell/1196">   [Dimension Door]</a>, <a href="/spell/1163">  [Teleportation Circle]</a>.',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // Mark of Sentinel
        {
            name: ' ',
            engName: 'Sentinel\'s Intuition',
            description: '     (  [Insight])   ( [Perception]),    4     .',
            shortDescription: '4  Insight  Perception',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Guardian\'s Shield',
            description: '    <a href="/spell/1302"> [Shield]</a>.   3- ,      <a href="/spell/1274">  [Warding Bond]</a>.  ,    -       ,      ,     .        .',
            shortDescription: 'Shield  Warding Bond 1/',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: ' ',
            engName: 'Vigilant Guardian',
            description: ' ,      5   ,   ,     ,       .       .       ,     .',
            shortDescription: '     ()',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: '  ',
            engName: 'Spells of the Mark (Sentinel)',
            description: '    Spellcasting  Pact Magic,          : <a href="/spell/1495">   [Compelled Duel]</a>, <a href="/spell/1301">  [Shield of Faith]</a>, <a href="/spell/1259"> [Aid]</a>, <a href="/spell/1274">  [Warding Bond]</a>, <a href="/spell/1236">   [Protection from Energy]</a>, <a href="/spell/1193">   [Death Ward]</a>, <a href="/spell/1203">  [Guardian of Faith]</a>.',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        },

        // ============ ELF DRAGONMARK (EBERRON) ============

        // Mark of Shadow
        {
            name: ' ',
            engName: 'Cunning Intuition',
            description: '     ( [Performance])   ( [Stealth]),    4     .',
            shortDescription: '4  Performance  Stealth',
            displayType: [FeatureDisplayType.PASSIVE]
        },
        {
            name: ' ',
            engName: 'Shape Shadows',
            description: '   <a href="/spell/1351">  [Minor Illusion]</a>.   3- ,     <a href="/spell/1276"> [Invisibility]</a>            ,     .        .',
            shortDescription: 'Minor Illusion, Invisibility 1/',
            displayType: [FeatureDisplayType.RESOURCE],
            limitedUsesPer: RestType.LONG_REST,
            usesCount: 1
        },
        {
            name: '  ',
            engName: 'Spells of the Mark (Shadow)',
            description: '    Spellcasting  Pact Magic,          : <a href="/spell/1332"> [Disguise Self]</a>, <a href="/spell/1330">  [Silent Image]</a>, <a href="/spell/1276"> [Invisibility]</a>, <a href="/spell/1270">   [Pass without Trace]</a>, <a href="/spell/1218"> [Clairvoyance]</a>, <a href="/spell/1223">  [Major Image]</a>, <a href="/spell/1204">  [Greater Invisibility]</a>, <a href="/spell/1178">  [Hallucinatory Terrain]</a>, <a href="/spell/1154"> [Mislead]</a>.',
            shortDescription: '  ',
            displayType: [FeatureDisplayType.PASSIVE]
        }
    ]

    for (const feature of features) {
        try {
            const normalized = normalizeFeatureCreateInput(feature);
            await prisma.feature.upsert({
                where: { engName: normalized.engName },
                update: normalized,
                create: normalized,
            });
        } catch (error) {
            console.error('   :', feature.name);
            console.error(' Feature :', JSON.stringify(feature, null, 2));
            console.error(' Error:', error);

            //    Prisma 
            if (error instanceof Prisma.PrismaClientKnownRequestError) {
                console.error(' Prisma Error Code:', error.code);
                console.error(' Meta:', error.meta);

                //     error.code  error.meta 
                if (error.code === 'P2025') {
                    console.error('   record(s)  connect:', error.meta?.cause);
                }
            }
        }
    }


    console.log(`  ${ features.length }  !`)
}
</file>

<file path="prisma/seed/raceSeed.ts">
import {
    Ability,
    Language,
    Prisma,
    PrismaClient,
    Races,
    Size,
    Skills,
    Source,
    WeaponCategory, WeaponType
} from "@prisma/client";

export const seedRaces = async (prisma: PrismaClient) => {
    console.log('  ...')

    const MPMMBaseASI = {
        tasha: {
            flexible: {
                groups: [
                    {
                        groupName: '+1  ',
                        value: 1,
                        choiceCount: 2,
                        unique: false
                    },
                    {
                        groupName: '+1  ',
                        value: 1,
                        choiceCount: 1,
                        unique: false
                    },
                ]
            },
        },
    }

    const races: Prisma.RaceCreateInput[] = [
        // ============  ============
        {
            name: Races.DWARF_2014,
            sortOrder: 2,
            size: [Size.MEDIUM],
            speed: 25,
            source: Source.PHB,
            languages: [Language.COMMON, Language.DWARVISH],
            weaponProficiencies: {
                category: [
                    WeaponCategory.BATTLEAXE,
                    WeaponCategory.HANDAXE,
                    WeaponCategory.LIGHT_HAMMER,
                    WeaponCategory.WARHAMMER
                ],
            },
            languagesToChooseCount: 0,
            toolProficiencies: [
                ' ',
                ' ',
                ' '
            ],
            ASI: {
                basic: {
                    simple: {
                        CON: 2
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Dwarven Combat Training' } } },
                    { feature: { connect: { engName: 'Stonecunning' } } },
                    { feature: { connect: { engName: 'Dwarven Tool Proficiency' } } },
                    { feature: { connect: { engName: 'Dwarven Resilience' } } }
                ]
            }
        },

        // ============  ============
        {
            name: Races.ELF_2014,
            sortOrder: 3,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.PHB,
            languages: [Language.COMMON, Language.ELVISH],
            languagesToChooseCount: 0,
            ASI: {
                basic: {
                    simple: {
                        DEX: 2
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            skillProficiencies: [Skills.PERCEPTION],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Keen Senses' } } },
                    { feature: { connect: { engName: 'Fey Ancestry' } } },
                    { feature: { connect: { engName: 'Trance' } } }
                ]
            }
        },

        // ============  ============
        {
            name: Races.HALFLING_2014,
            sortOrder: 4,
            size: [Size.SMALL],
            speed: 25,
            source: Source.PHB,
            languages: [Language.COMMON, Language.HALFLING],
            languagesToChooseCount: 0,
            ASI: {
                basic: {
                    simple: {
                        DEX: 2
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Lucky' } } },
                    { feature: { connect: { engName: 'Brave' } } },
                    { feature: { connect: { engName: 'Nimbleness' } } }
                ]
            }
        },

        // ============  ============
        {
            name: Races.HUMAN_2014,
            sortOrder: 1,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.PHB,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: {
                basic: {
                    simple: {
                        STR: 1,
                        DEX: 1,
                        CON: 1,
                        INT: 1,
                        WIS: 1,
                        CHA: 1
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 6,
                                unique: true
                            }
                        ]
                    }
                }
            },
            traits: {
                create: []
            }
        },

        // ============  ============
        {
            name: Races.DRAGONBORN_2014,
            sortOrder: 5,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.PHB,
            languages: [Language.COMMON, Language.DRACONIC],
            languagesToChooseCount: 0,
            ASI: {
                basic: {
                    simple: {
                        STR: 2,
                        CHA: 1
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            },
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Draconic Resistance' } } },
                ]
            }
        },

        // ============  (FIZBAN'S) ============
        {
            name: Races.DRAGONBORN_CHROMATIC,
            sortOrder: 5,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.FTOD,
            languages: [Language.COMMON, Language.DRACONIC],
            languagesToChooseCount: 0,
            ASI: MPMMBaseASI,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Chromatic Warding' } } },
                ]
            }
        },
        {
            name: Races.DRAGONBORN_METALLIC,
            sortOrder: 5,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.FTOD,
            languages: [Language.COMMON, Language.DRACONIC],
            languagesToChooseCount: 0,
            ASI: MPMMBaseASI,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Metallic Breath Weapon' } } },
                ]
            }
        },
        {
            name: Races.DRAGONBORN_GEM,
            sortOrder: 5,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.FTOD,
            languages: [Language.COMMON, Language.DRACONIC],
            languagesToChooseCount: 0,
            ASI: MPMMBaseASI,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Psionic Mind' } } },
                    { feature: { connect: { engName: 'Gem Flight' } } },
                ]
            }
        },

        // ============  ============
        {
            name: Races.GNOME_2014,
            sortOrder: 6,
            size: [Size.SMALL],
            speed: 25,
            source: Source.PHB,
            languages: [Language.COMMON, Language.GNOMISH],
            languagesToChooseCount: 0,
            ASI: {
                basic: {
                    simple: {
                        INT: 2
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Gnome Cunning' } } }
                ]
            }
        },

        // ============  ============
        {
            name: Races.HALF_ELF_2014,
            sortOrder: 7,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.PHB,
            languages: [Language.COMMON, Language.ELVISH],
            languagesToChooseCount: 1,
            ASI: {
                basic: {
                    simple: {
                        CHA: 2,
                    },
                    flexible: {
                        groups: [
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 2,
                                unique: true
                            },
                        ]
                    },
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 2,
                                unique: true
                            },
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            },
                        ]
                    },
                },
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Fey Ancestry' } } }
                ]
            }
        },

        // ============  ============
        {
            name: Races.HALF_ORC_2014,
            sortOrder: 8,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.PHB,
            languages: [Language.COMMON, Language.ORC],
            languagesToChooseCount: 0,
            ASI: {
                basic: {
                    simple: {
                        STR: 2,
                        CON: 1
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            },
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            skillProficiencies: [Skills.INTIMIDATION],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Relentless Endurance' } } },
                    { feature: { connect: { engName: 'Menacing' } } },
                    { feature: { connect: { engName: 'Savage Attacks' } } }
                ]
            }
        },

        // ============  ============
        {
            name: Races.TIEFLING_2014,
            sortOrder: 9,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.PHB,
            languages: [Language.COMMON, Language.INFERNAL],
            languagesToChooseCount: 0,
            ASI: {
                basic: {
                    simple: {
                        CHA: 2,
                        INT: 1
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            },
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Hellish Resistance' } } },
                    { feature: { connect: { engName: 'Infernal Legacy' } } }
                ]
            }
        },

        // ============ AARAKOCRA ============
        {
            name: Races.AARAKOCRA_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            flightSpeed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Flight' } } },
                    { feature: { connect: { engName: 'Talons' } } },
                    { feature: { connect: { engName: 'Wind Caller' } } },
                ]
            }
        },

        // ============ AASIMAR ============
        {
            name: Races.AASIMAR_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Celestial Resistance' } } },
                    { feature: { connect: { engName: 'Healing Hands' } } },
                    { feature: { connect: { engName: 'Celestial Revelation' } } }
                ]
            }
        },

        // ============ BUGBEAR ============
        {
            name: Races.BUGBEAR_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            skillProficiencies: [Skills.STEALTH],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Long-Limbed' } } },
                    { feature: { connect: { engName: 'Powerful Build' } } },
                    { feature: { connect: { engName: 'Sneaky' } } },
                    { feature: { connect: { engName: 'Surprise Attack' } } }
                ]
            }
        },

        // ============ CENTAUR ============
        {
            name: Races.CENTAUR_MPMM,
            size: [Size.MEDIUM],
            speed: 40,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            skillProficiencies: {
                options: [Skills.ANIMAL_HANDLING, Skills.MEDICINE, Skills.NATURE, Skills.SURVIVAL],
                choiceCount: 1
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Charge' } } },
                    { feature: { connect: { engName: 'Hooves' } } },
                    { feature: { connect: { engName: 'Equine Build' } } }
                ]
            }
        },

        // ============ CHANGELING ============
        {
            name: Races.CHANGELING_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            skillProficiencies: {
                options: [Skills.DECEPTION, Skills.INTIMIDATION, Skills.PERSUASION, Skills.PERFORMANCE, Skills.INSIGHT],
                choiceCount: 2
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Shapechanger' } } }
                ]
            }
        },

        // ============ DEEP GNOME ============
        {
            name: Races.DEEP_GNOME_MPMM,
            size: [Size.SMALL],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Superior Darkvision' } } },
                    { feature: { connect: { engName: 'Gift of the Svirfneblin' } } },
                    { feature: { connect: { engName: 'Gnomish Magic Resistance' } } },
                    { feature: { connect: { engName: 'Svirfneblin Camouflage' } } },
                ]
            }
        },

        // ============ DUERGAR ============
        {
            name: Races.DUERGAR_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Superior Darkvision' } } },
                    { feature: { connect: { engName: 'Dwarven Resilience' } } },
                    { feature: { connect: { engName: 'Duergar Resilience' } } },
                    { feature: { connect: { engName: 'Psionic Fortitude' } } },
                    { feature: { connect: { engName: 'Duergar Magic' } } }
                ]
            }
        },

        // ============ ELADRIN ============
        {
            name: Races.ELADRIN_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            skillProficiencies: [Skills.PERCEPTION],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Fey Ancestry' } } },
                    { feature: { connect: { engName: 'Fey Step' } } },
                    { feature: { connect: { engName: 'Keen Senses' } } },
                    { feature: { connect: { engName: 'Trance' } } }
                ]
            }
        },

        // ============ FAIRY ============
        {
            name: Races.FAIRY_MPMM,
            size: [Size.SMALL],
            speed: 30,
            flightSpeed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Fairy Magic' } } },
                    { feature: { connect: { engName: 'Flight' } } }
                ]
            }
        },

        // ============ FIRBOLG ============
        {
            name: Races.FIRBOLG_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Powerful Build' } } },
                    { feature: { connect: { engName: 'Hidden Step' } } },
                    { feature: { connect: { engName: 'Speech of Beast and Leaf' } } },
                    { feature: { connect: { engName: 'Firbolg Magic' } } }
                ]
            }
        },

        // ============ GENASI AIR ============
        {
            name: Races.GENASI_AIR_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Unending Breath' } } },
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Mingle with the Wind' } } },
                    { feature: { connect: { engName: 'Lightning Resistance' } } }
                ]
            }
        },

        // ============ GENASI EARTH ============
        {
            name: Races.GENASI_EARTH_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Earth Walk' } } },
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Merge with Stone' } } }
                ]
            }
        },

        // ============ GENASI FIRE ============
        {
            name: Races.GENASI_FIRE_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Hellish Resistance' } } },
                    { feature: { connect: { engName: 'Reach to the Blaze' } } }
                ]
            }
        },

        // ============ GENASI WATER ============
        {
            name: Races.GENASI_WATER_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            swimSpeed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Acid Resistance' } } },
                    { feature: { connect: { engName: 'Amphibious' } } },
                    { feature: { connect: { engName: 'Call to the Wave' } } }
                ]
            }
        },

        // ============ GITHYANKI ============
        {
            name: Races.GITHYANKI_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Astral Knowledge' } } },
                    { feature: { connect: { engName: 'Psychic Resilience' } } },
                    { feature: { connect: { engName: 'Githyanki Psionics' } } }
                ]
            }
        },

        // ============ GITHZERAI ============
        {
            name: Races.GITHZERAI_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Mental Discipline' } } },
                    { feature: { connect: { engName: 'Psychic Resilience' } } },
                    { feature: { connect: { engName: 'Githzerai Psionics' } } }
                ]
            }
        },

        // ============ GOBLIN ============
        {
            name: Races.GOBLIN_MPMM,
            size: [Size.SMALL],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Fury of the Small' } } },
                    { feature: { connect: { engName: 'Fey Ancestry' } } },
                    { feature: { connect: { engName: 'Nimble Escape' } } }
                ]
            }
        },

        // ============ GOLIATH ============
        {
            name: Races.GOLIATH_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI:
            MPMMBaseASI
            ,
            skillProficiencies: [Skills.ATHLETICS],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Stone\'s Endurance' } } },
                    { feature: { connect: { engName: 'Little Giant' } } },
                    { feature: { connect: { engName: 'Mountain Born' } } },
                ]
            }
        },

        // ============ HARENGON ============
        {
            name: Races.HARENGON_MPMM,
            size: [Size.MEDIUM, Size.SMALL],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            skillProficiencies: [Skills.PERCEPTION],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Hare-Trigger' } } },
                    { feature: { connect: { engName: 'Leporine Senses' } } },
                    { feature: { connect: { engName: 'Lucky Footwork' } } },
                    { feature: { connect: { engName: 'Rabbit Hop' } } },
                ]
            }
        },

        // ============ HOBGOBLIN ============
        {
            name: Races.HOBGOBLIN_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Fey Ancestry' } } },
                    { feature: { connect: { engName: 'Fey Gift' } } },
                    { feature: { connect: { engName: 'Fortune from the Many' } } }
                ]
            }
        },

        // ============ KENKU ============
        {
            name: Races.KENKU_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            skillProficiencies: {
                options: [], // ALL!!!
                choiceCount: 2,
                chooseAny: true
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Kenku Recall' } } },
                    { feature: { connect: { engName: 'Mimicry' } } },
                    { feature: { connect: { engName: 'Expert Duplication' } } },
                ]
            }
        },

        // ============ KOBOLD ============
        {
            name: Races.KOBOLD_MPMM,
            size: [Size.SMALL],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Draconic Cry' } } } // TODO: race options for ancestry
                ]
            }
        },

        // ============ LIZARDFOLK ============
        {
            name: Races.LIZARDFOLK_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            swimSpeed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            skillProficiencies: {
                options: [Skills.ANIMAL_HANDLING, Skills.MEDICINE, Skills.NATURE, Skills.PERCEPTION, Skills.STEALTH, Skills.SURVIVAL],
                choiceCount: 2,
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Natural Armor' } } },
                    { feature: { connect: { engName: 'Hold Breath' } } },
                    { feature: { connect: { engName: 'Hungry Jaws' } } },
                    { feature: { connect: { engName: 'Bite' } } },
                ]
            }
        },

        // ============ MINOTAUR ============
        {
            name: Races.MINOTAUR_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            skillProficiencies: [Skills.SURVIVAL],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Horns' } } },
                    { feature: { connect: { engName: 'Goring Rush' } } },
                    { feature: { connect: { engName: 'Labyrinthine Recall' } } },
                    { feature: { connect: { engName: 'Hammering Horns' } } }
                ]
            }
        },

        // ============ ORC ============
        {
            name: Races.ORC_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Adrenaline Rush' } } },
                    { feature: { connect: { engName: 'Powerful Build' } } },
                    { feature: { connect: { engName: 'Relentless Endurance' } } }
                ]
            }
        },

        // ============ SATYR ============
        {
            name: Races.SATYR_MPMM,
            size: [Size.MEDIUM],
            speed: 35,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            skillProficiencies: [Skills.PERFORMANCE, Skills.PERSUASION],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Magic Resistance' } } },
                    { feature: { connect: { engName: 'Mirthful Leaps' } } },
                    { feature: { connect: { engName: 'Ram' } } },
                    { feature: { connect: { engName: 'Reveler' } } }
                ]
            }
        },

        // ============ SEA ELF ============
        {
            name: Races.SEA_ELF_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            swimSpeed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON, Language.ELVISH],
            languagesToChooseCount: 0,
            ASI: MPMMBaseASI,
            skillProficiencies: [Skills.PERCEPTION],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Fey Ancestry' } } },
                    { feature: { connect: { engName: 'Trance' } } },
                    { feature: { connect: { engName: 'Child of the Sea' } } },
                    { feature: { connect: { engName: 'Keen Senses' } } },
                    { feature: { connect: { engName: 'Friend of the Sea' } } },
                ]
            }
        },

        // ============ SHADAR-KAI ============
        {
            name: Races.SHADAR_KAI_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON, Language.ELVISH],
            languagesToChooseCount: 0,
            ASI: MPMMBaseASI,
            skillProficiencies: [Skills.PERCEPTION],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Fey Ancestry' } } },
                    { feature: { connect: { engName: 'Trance' } } },
                    { feature: { connect: { engName: 'Keen Senses' } } },
                    { feature: { connect: { engName: 'Blessing of the Raven Queen' } } },
                    { feature: { connect: { engName: 'Necrotic Resistance' } } }
                ]
            }
        },

        // ============ SHIFTER ============
        {
            name: Races.SHIFTER_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            skillProficiencies: {
                options: [Skills.ACROBATICS, Skills.ATHLETICS, Skills.INTIMIDATION, Skills.SURVIVAL],
                choiceCount: 1,
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Bestial Instincts' } } },
                    // { feature: { connect: { engName: 'Shifting' } } }  TODO: Races Options - shift
                ]
            }
        },

        // ============ TABAXI ============
        {
            name: Races.TABAXI_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            climbSpeed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            skillProficiencies: [Skills.PERCEPTION, Skills.STEALTH],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Cat\'s Claws' } } },
                    { feature: { connect: { engName: 'Cat\'s Talent' } } },
                    { feature: { connect: { engName: 'Feline Agility' } } }
                ]
            }
        },

        // ============ TORTLE ============
        {
            name: Races.TORTLE_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ac: {base: 17, bonus: null},
            ASI: MPMMBaseASI,
            skillProficiencies: {
                options: [Skills.ANIMAL_HANDLING, Skills.MEDICINE, Skills.NATURE, Skills.SURVIVAL, Skills.STEALTH, Skills.PERCEPTION],
                choiceCount: 1,
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Shell Armor' } } },
                    { feature: { connect: { engName: 'Hold Breath' } } },
                    { feature: { connect: { engName: 'Claws' } } },
                    { feature: { connect: { engName: 'Shell Defense' } } }
                ]
            }
        },

        // ============ TRITON ============
        {
            name: Races.TRITON_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            swimSpeed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Amphibious' } } },
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Control Air and Water' } } },
                    { feature: { connect: { engName: 'Emissary of the Sea' } } },
                    { feature: { connect: { engName: 'Guardian of the Depths' } } }
                ]
            }
        },

        // ============ YUAN-TI ============
        {
            name: Races.YUAN_TI_MPMM,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.MPMM,
            languages: [Language.COMMON],
            languagesToChooseCount: 2,
            ASI: MPMMBaseASI,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Magic Resistance' } } },
                    { feature: { connect: { engName: 'Serpentine Spellcasting' } } },
                    { feature: { connect: { engName: 'Poison Resilience' } } }
                ]
            }
        },
        // ============ SPELLJAMMER RACES ============

// ============ ASTRAL ELF ============
        {
            name: Races.ASTRAL_ELF_SPELLJAMMER,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.SPELLJAMMER,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            skillProficiencies: [Skills.PERCEPTION],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Astral Fire' } } }, // cantrip: Dancing Lights/Light/Sacred Flame
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Fey Ancestry' } } },
                    { feature: { connect: { engName: 'Keen Senses' } } },
                    { feature: { connect: { engName: 'Starlight Step' } } }, // teleport 30ft, prof bonus times
                    { feature: { connect: { engName: 'Astral Trance' } } } // 4hr rest + temp proficiency
                ]
            }
        },

// ============ AUTOGNOME ============
        {
            name: Races.AUTOGNOME_SPELLJAMMER,
            size: [Size.SMALL],
            speed: 30,
            ac: {base: 13, bonus: Ability.DEX},
            source: Source.SPELLJAMMER,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            toolToChooseCount: 2,
            ASI: MPMMBaseASI,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Armored Casing' } } }, // AC 13 + DEX
                    { feature: { connect: { engName: 'Built for Success' } } }, // +d4  rolls
                    { feature: { connect: { engName: 'Healing Machine' } } }, // Mending + healing spells work
                    { feature: { connect: { engName: 'Mechanical Nature' } } }, // poison resistance, no eat/drink/breathe
                    { feature: { connect: { engName: 'Sentry\'s Rest' } } }, // 6hr inactive rest
                    { feature: { connect: { engName: 'Specialized Design' } } } // 2 tool proficiencies
                ]
            }
        },

// ============ GIFF ============
        {
            name: Races.GIFF_SPELLJAMMER,
            size: [Size.MEDIUM],
            speed: 30,
            swimSpeed: 30,
            source: Source.SPELLJAMMER,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            weaponProficiencies: {
                type: [WeaponType.FIREARMS]
            },
            skillProficiencies: [Skills.ATHLETICS],
            ASI: MPMMBaseASI,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Astral Spark' } } }, // adv on INT/WIS/CHA saves vs magic
                    { feature: { connect: { engName: 'Firearms Mastery' } } }, // firearms proficiency + damage bonus
                    { feature: { connect: { engName: 'Hippo Build' } } } // carrying capacity x2
                ]
            }
        },

// ============ HADOZEE ============
        {
            name: Races.HADOZEE_SPELLJAMMER,
            size: [Size.MEDIUM, Size.SMALL],
            speed: 30,
            climbSpeed: 25,
            source: Source.SPELLJAMMER,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            skillProficiencies: [Skills.ACROBATICS],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Dexterous Feet' } } }, // bonus action manipulate object
                    { feature: { connect: { engName: 'Glide' } } }, // fall speed 60ft, move 5ft per 1ft descended
                    { feature: { connect: { engName: 'Hadozee Resilience' } } } // reaction: reduce damage by d6+prof
                ]
            }
        },

// ============ PLASMOID ============
        {
            name: Races.PLASMOID_SPELLJAMMER,
            size: [Size.MEDIUM, Size.SMALL],
            speed: 30,
            source: Source.SPELLJAMMER,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Amorphous' } } }, // squeeze through 1 inch + grapple advantage
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Hold Breath' } } }, // 1 hour
                    { feature: { connect: { engName: 'Natural Resilience' } } }, // acid + poison resistance
                    { feature: { connect: { engName: 'Shape Self' } } } // reshape body + pseudopod
                ]
            }
        },

// ============ THRI-KREEN ============
        {
            name: Races.THRI_KREEN_SPELLJAMMER,
            size: [Size.MEDIUM, Size.SMALL],
            speed: 30,
            source: Source.SPELLJAMMER,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ac: {base: 17, bonus: Ability.DEX}, // base AC 13 + DEX from Chameleon Carapace
            ASI: MPMMBaseASI,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Chameleon Carapace' } } }, // AC 13+DEX + stealth advantage
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Secondary Arms' } } }, // 2 extra arms for light weapons
                    { feature: { connect: { engName: 'Sleepless' } } }, // no sleep needed
                    { feature: { connect: { engName: 'Thri-kreen Telepathy' } } } // 120ft telepathy
                ]
            }
        },

// ============ DRAGONLANCE ============

// ============ KENDER ============
        {
            name: Races.KENDER_DRAGONLANCE,
            size: [Size.SMALL],
            speed: 30,
            source: Source.DRAGONLANCE,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            skillProficiencies: {
                options: [Skills.INSIGHT, Skills.INVESTIGATION, Skills.SLEIGHT_OF_HAND, Skills.STEALTH, Skills.SURVIVAL],
                choiceCount: 1
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Fearless' } } }, // adv vs frightened + 1/LR auto-succeed
                    { feature: { connect: { engName: 'Kender Aptitude' } } }, // 1 skill proficiency
                    { feature: { connect: { engName: 'Taunt' } } } // bonus action taunt, WIS save
                ]
            }
        },

// ============ ONE GRUNG ABOVE ============

// ============ GRUNG ============
        {
            name: Races.GRUNG_OGA,
            size: [Size.SMALL],
            speed: 25,
            climbSpeed: 25,
            source: Source.OGA,
            languages: [Language.GRUNG],
            languagesToChooseCount: 0,
            ASI: {
                basic: {
                    simple: {
                        DEX: 2,
                        CON: 1
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            },
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            skillProficiencies: [Skills.PERCEPTION],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Arboreal Alertness' } } }, // adv on Perception/Stealth checks
                    { feature: { connect: { engName: 'Amphibious' } } },
                    { feature: { connect: { engName: 'Poisonous Skin' } } }, // poison damage on touch/grapple
                    { feature: { connect: { engName: 'Poison Immunity' } } },
                    { feature: { connect: { engName: 'Standing Leap' } } }, // long jump 25ft, high 15ft
                    { feature: { connect: { engName: 'Water Dependency' } } } // need water immersion 1/day
                ]
            }
        },

// ============ LOCATHAH RISING ============

// ============ LOCATHAH ============
        {
            name: Races.LOCATHAH_LR,
            size: [Size.MEDIUM],
            speed: 30,
            swimSpeed: 30,
            source: Source.LR,
            languages: [Language.COMMON, Language.AQUAN],
            languagesToChooseCount: 0,
            ac: {base: 12, bonus: Ability.DEX}, // Natural Armor: 12 + DEX
            ASI: {
                basic: {
                    simple: {
                        STR: 2,
                        DEX: 1
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            },
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            skillProficiencies: [Skills.ATHLETICS, Skills.PERCEPTION],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Locathah Natural Armor' } } }, // 12 + DEX
                    { feature: { connect: { engName: 'Observant and Athletic' } } }, // Athletics + Perception prof
                    { feature: { connect: { engName: 'Leviathan Will' } } }, // adv vs charmed/frightened/paralyzed/poisoned/stunned/sleep
                    { feature: { connect: { engName: 'Limited Amphibiousness' } } } // need water every 4 hours
                ]
            }
        },

// ============ GUILDMASTERS' GUIDE TO RAVNICA ============

// ============ LOXODON ============
        {
            name: Races.LOXODON_GGTR,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.GGTR,
            languages: [Language.COMMON, Language.LOXODON],
            languagesToChooseCount: 0,
            ac: {base: 12, bonus: Ability.CON}, // Natural Armor: 12 + CON
            ASI: {
                basic: {
                    simple: {
                        CON: 2,
                        WIS: 1
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            },
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Loxodon Natural Armor' } } }, // 12 + CON modifier
                    { feature: { connect: { engName: 'Loxodon Serenity' } } }, // adv vs charmed/frightened
                    { feature: { connect: { engName: 'Powerful Build' } } },
                    { feature: { connect: { engName: 'Keen Smell' } } }, // adv on Perception/Survival using smell
                    { feature: { connect: { engName: 'Trunk' } } } // can use as extra hand
                ]
            }
        },

// ============ SIMIC HYBRID ============
        {
            name: Races.SIMIC_HYBRID_GGTR,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.GGTR,
            languages: [Language.COMMON, Language.ELVISH, Language.VEDALKEN],
            languagesToChooseCount: 1,
            ASI: {
                basic: {
                    simple: {
                        CON: 2
                    },
                    flexible: {
                        groups: [
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            },
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Animal Enhancements' } } } // TODO: Races Choice Options -  1  1lvl, +1  5lvl
                ]
            }
        },

// ============ VEDALKEN ============
        {
            name: Races.VEDALKEN_GGTR,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.GGTR,
            languages: [Language.COMMON, Language.VEDALKEN],
            languagesToChooseCount: 1,
            ASI: {
                basic: {
                    simple: {
                        INT: 2,
                        WIS: 1
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            },
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            skillProficiencies: {
                options: [Skills.ARCANA, Skills.HISTORY, Skills.INVESTIGATION, Skills.MEDICINE, Skills.PERFORMANCE, Skills.SLEIGHT_OF_HAND],
                choiceCount: 1
            },
            toolToChooseCount: 1,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Vedalken Dispassion' } } }, // adv on INT/WIS/CHA saves
                    { feature: { connect: { engName: 'Tireless Precision' } } }, // 1 skill prof + 1 tool prof
                    { feature: { connect: { engName: 'Partially Amphibious' } } } // breathe underwater 1 hour
                ]
            }
        },

// ============ ACQUISITIONS INCORPORATED ============

// ============ VERDAN ============
        {
            name: Races.VERDAN_AI,
            size: [Size.MEDIUM, Size.SMALL],
            speed: 30,
            source: Source.AI,
            languages: [Language.COMMON, Language.GOBLIN],
            languagesToChooseCount: 1,
            ASI: {
                basic: {
                    simple: {
                        CHA: 2,
                        CON: 1
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            },
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            skillProficiencies: [Skills.PERSUASION],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Black Blood Healing' } } }, // 12+1d4 HP from magical healing
                    { feature: { connect: { engName: 'Limited Telepathy' } } }, // 30ft telepathy
                    { feature: { connect: { engName: 'Persuasive' } } }, // Persuasion proficiency
                    { feature: { connect: { engName: 'Telepathic Insight' } } } // adv on WIS/CHA saves
                ]
            }
        },

// ============ EBERRON: RISING FROM THE LAST WAR ============

// ============ KALASHTAR ============
        {
            name: Races.KALASHTAR_EBERRON,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.EBERRON,
            languages: [Language.COMMON, Language.QUORI],
            languagesToChooseCount: 1,
            ASI: {
                basic: {
                    simple: {
                        WIS: 2,
                        CHA: 1
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            },
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Dual Mind' } } }, // adv on WIS saves
                    { feature: { connect: { engName: 'Kalashtar Mental Discipline' } } }, // psychic resistance
                    { feature: { connect: { engName: 'Mind Link' } } }, // telepathy prof bonus creatures
                    { feature: { connect: { engName: 'Severed from Dreams' } } } // no sleep, can't be affected by dream spells
                ]
            }
        },

// ============ WARFORGED ============
        {
            name: Races.WARFORGED_EBERRON,
            size: [Size.MEDIUM],
            speed: 30,
            source: Source.EBERRON,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ac: {
                consistentBonus: 1
            },
            ASI: {
                basic: {
                    simple: {
                        CON: 2
                    },
                    flexible: {
                        groups: [
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            },
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            skillProficiencies: {
                options: [], // ALL!!!
                choiceCount: 1,
                chooseAny: true
            },
            toolToChooseCount: 1,
            traits: {
                create: [
                    { feature: { connect: { engName: 'Constructed Resilience' } } }, // poison adv, no eat/drink/breathe/sleep
                    { feature: { connect: { engName: 'Sentry\'s Rest' } } },
                    { feature: { connect: { engName: 'Integrated Protection' } } }, // AC bonus + can integrate armor
                    { feature: { connect: { engName: 'Warforged Specialized Design' } } } // 1 skill + 1 tool proficiency
                ]
            }
        },

// ============ MYTHIC ODYSSEYS OF THEROS ============

// ============ LEONIN ============
        {
            name: Races.LEONIN_MOOT,
            size: [Size.MEDIUM],
            speed: 35,
            source: Source.MOOT,
            languages: [Language.COMMON, Language.LEONIN],
            languagesToChooseCount: 0,
            ASI: {
                basic: {
                    simple: {
                        CON: 2,
                        STR: 1
                    }
                },
                tasha: {
                    flexible: {
                        groups: [
                            {
                                groupName: '+2  ',
                                value: 2,
                                choiceCount: 1,
                                unique: true
                            },
                            {
                                groupName: '+1  ',
                                value: 1,
                                choiceCount: 1,
                                unique: true
                            }
                        ]
                    }
                }
            },
            skillProficiencies: {
                options: [Skills.ATHLETICS, Skills.INTIMIDATION, Skills.PERCEPTION, Skills.SURVIVAL],
                choiceCount: 1
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Leonin Claws' } } }, // 1d4 slashing
                    { feature: { connect: { engName: 'Hunter\'s Instincts' } } }, // 1 skill from 4 options
                    { feature: { connect: { engName: 'Daunting Roar' } } } // frightened on failed WIS save
                ]
            }
        },
// TODO: custom race
// ============ VAN RICHTEN'S GUIDE TO RAVENLOFT ============

// ============ DHAMPIR ============
        {
            name: Races.DHAMPIR_VRGTR,
            size: [Size.MEDIUM, Size.SMALL],
            speed: 35,
            climbSpeed: 35, // can climb difficult surfaces
            source: Source.VRGTR,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            skillProficiencies: {
                options: [], // ALL!!!
                choiceCount: 2,
                chooseAny: true
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Dhampir Deathless Nature' } } }, // no breathe, adv vs disease/poison
                    { feature: { connect: { engName: 'Spider Climb' } } }, // climb speed equal to walking
                    { feature: { connect: { engName: 'Vampiric Bite' } } } // piercing damage + heal, prof bonus times
                ]
            }
        },

// ============ HEXBLOOD ============
        {
            name: Races.HEXBLOOD_VRGTR,
            size: [Size.MEDIUM, Size.SMALL],
            speed: 30,
            source: Source.VRGTR,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            skillProficiencies: {
                options: [], // ALL!!!
                choiceCount: 2,
                chooseAny: true
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Eerie Token' } } }, // create token to spy/communicate
                    { feature: { connect: { engName: 'Hex Magic' } } } // Disguise Self + Hex spells
                ]
            }
        },

// ============ REBORN ============
        {
            name: Races.REBORN_VRGTR,
            size: [Size.MEDIUM, Size.SMALL],
            speed: 30,
            source: Source.VRGTR,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            skillProficiencies: {
                options: [], // ALL!!!
                choiceCount: 2,
                chooseAny: true
            },
            traits: {
                create: [
                    { feature: { connect: { engName: 'Darkvision' } } },
                    { feature: { connect: { engName: 'Deathless Nature' } } },
                    { feature: { connect: { engName: 'Knowledge from a Past Life' } } } // add d6 to skill check, prof bonus times
                ]
            }
        },

// ============ STRIXHAVEN: A CURRICULUM OF CHAOS ============

// ============ OWLIN ============
        {
            name: Races.OWLIN_SACOC,
            size: [Size.MEDIUM, Size.SMALL],
            speed: 30,
            flightSpeed: 30,
            source: Source.SACOC,
            languages: [Language.COMMON],
            languagesToChooseCount: 1,
            ASI: MPMMBaseASI,
            skillProficiencies: [Skills.STEALTH],
            traits: {
                create: [
                    { feature: { connect: { engName: 'Superior Darkvision' } } },
                    { feature: { connect: { engName: 'Flight' } } },
                    { feature: { connect: { engName: 'Silent Feathers' } } } // Stealth proficiency
                ]
            }
        }
    ]

    
    for (const race of races) {
        const traitCreates = Array.isArray(race.traits?.create)
            ? race.traits?.create ?? []
            : race.traits?.create
                ? [race.traits.create]
                : [];

        const { traits, ...raceData } = race;

        try {
            const savedRace = await prisma.race.upsert({
                where: { name: race.name },
                update: raceData,
                create: raceData
            })

            for (const entry of traitCreates) {
                const engName = (entry as any)?.feature?.connect?.engName as string | undefined;
                if (!engName) continue;

                const feature = await prisma.feature.findUnique({ where: { engName } });
                if (!feature) {
                    console.warn(`Feature with engName=${engName} not found, skip linking to race ${race.name}`);
                    continue;
                }

                const existing = await prisma.raceTrait.findFirst({
                    where: { raceId: savedRace.raceId, featureId: feature.featureId },
                });

                if (!existing) {
                    await prisma.raceTrait.create({
                        data: {
                            raceId: savedRace.raceId,
                            featureId: feature.featureId,
                        },
                    });
                }
            }
        } catch (error) {
            console.error('Failed to upsert race:', race.name);
            console.error('Race payload:', JSON.stringify(race, null, 2));
            console.error('Error:', error);

            if (error instanceof Prisma.PrismaClientKnownRequestError) {
                console.error('Prisma Error Code:', error.code);
                console.error('Meta:', error.meta);

                if (error.code === 'P2025') {
                    console.error('Record to connect not found:', error.meta?.cause);
                }
                if (error.code === 'P2002') {
                    console.error('Unique constraint violation:', error.meta?.target);
                }
            }
        }
    }


    console.log(`  ${races.length} !`)
}
</file>

<file path="prisma/seed/subclassSeed.ts">
import { Ability, Classes, Prisma, PrismaClient, SpellcastingType, Subclasses } from "@prisma/client"

type SubclassSeed = Omit<Prisma.SubclassCreateInput, "class" | "name"> & {
  name: Subclasses
  classConnect: Classes
}

export const seedSubclasses = async (prisma: PrismaClient) => {
  console.log(" ...")

  const subclasses: SubclassSeed[] = [
    // ==== Artificer ====
    {
      name: Subclasses.ALCHEMIST,
      description: "         .    ,      .",
      spellcastingType: SpellcastingType.HALF,
      classConnect: Classes.ARTIFICER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.ARMORER,
      description: "  ,       .      .",
      spellcastingType: SpellcastingType.HALF,
      classConnect: Classes.ARTIFICER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.ARTILLERIST,
      description: "    ,         .",
      spellcastingType: SpellcastingType.HALF,
      classConnect: Classes.ARTIFICER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.BATTLE_SMITH,
      description: "           .    .",
      spellcastingType: SpellcastingType.HALF,
      classConnect: Classes.ARTIFICER_2014,
      expandedSpells: { connect: [] },
    },

    {
      name: Subclasses.ARCANE_ARCHER,
      description:
        "     ,           .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.FIGHTER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.BANNERET,
      description:
        "           ,      .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.FIGHTER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.BATTLE_MASTER,
      description:
        "     ,          .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.FIGHTER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.CAVALIER,
      description:
        "  ,         ,    .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.FIGHTER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.CHAMPION,
      description: "      ,     .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.FIGHTER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.ECHO_KNIGHT,
      description: "     ,         .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.FIGHTER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.ELDRITCH_KNIGHT,
      description: "       ,     .",
      primaryCastingStat: Ability.INT,
      spellcastingType: SpellcastingType.THIRD,
      grantsSpells: true,
      classConnect: Classes.FIGHTER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.PSI_WARRIOR,
      description: "-     ,       .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.FIGHTER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.RUNE_KNIGHT,
      description: "      ,        .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.FIGHTER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SAMURAI,
      description: "      ,       .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.FIGHTER_2014,
      expandedSpells: { connect: [] },
    },

    // ==== Barbarian ====
    {
      name: Subclasses.PATH_OF_THE_ANCESTRAL_GUARDIAN,
      description:
        "    ,          .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.BARBARIAN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.PATH_OF_THE_BATTLERAGER,
      description:
        "      ,         .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.BARBARIAN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.PATH_OF_THE_BEAST,
      description:
        "    :     ,  ,   .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.BARBARIAN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.PATH_OF_THE_BERSERKER,
      description:
        "      ,   ,   .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.BARBARIAN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.PATH_OF_THE_GIANT,
      description:
        "       :  ,     .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.BARBARIAN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.PATH_OF_THE_STORM_HERALD,
      description:
        "      ,   ,      .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.BARBARIAN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.PATH_OF_THE_TOTEM_WARRIOR,
      description:
        "   -  :  ,        .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.BARBARIAN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.PATH_OF_WILD_MAGIC,
      description:
        "    :     ,     .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.BARBARIAN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.PATH_OF_THE_ZEALOT,
      description:
        "    :     ,      .",
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.BARBARIAN_2014,
      expandedSpells: { connect: [] },
    },

    // ==== Cleric ====
    {
      name: Subclasses.ARCANA_DOMAIN,
      description:
        "       :  ,       .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.CLERIC_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.DEATH_DOMAIN,
      description:
        "    ,    ,      .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.CLERIC_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.FORGE_DOMAIN,
      description:
        "     :    ,      .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.CLERIC_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.GRAVE_DOMAIN,
      description:
        "       :   ,       .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.CLERIC_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.KNOWLEDGE_DOMAIN,
      description:
        "    :   ,  ,      .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.CLERIC_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.LIFE_DOMAIN,
      description:
        "     :  ,         .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.CLERIC_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.LIGHT_DOMAIN,
      description:
        "    :  ,       .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.CLERIC_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.NATURE_DOMAIN,
      description:
        "      :    ,      .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.CLERIC_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.ORDER_DOMAIN,
      description:
        "     :  ,       .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.CLERIC_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.PEACE_DOMAIN,
      description:
        "        ,     .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.CLERIC_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.TEMPEST_DOMAIN,
      description:
        "     :    ,      .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.CLERIC_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.TRICKERY_DOMAIN,
      description:
        "     : , ,      .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.CLERIC_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.TWILIGHT_DOMAIN,
      description:
        "    :   ,       .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.CLERIC_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.WAR_DOMAIN,
      description:
        "   :  ,        .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.CLERIC_2014,
      expandedSpells: { connect: [] },
    },

    // ==== Warlock ====
    {
      name: Subclasses.ARCHFEY,
      description:
        "-   ,   :  ,       .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.PACT,
      grantsSpells: true,
      classConnect: Classes.WARLOCK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.FIEND,
      description:
        "       :   ,       .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.PACT,
      grantsSpells: true,
      classConnect: Classes.WARLOCK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.GREAT_OLD_ONE,
      description:
        "      :  ,     -.",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.PACT,
      grantsSpells: true,
      classConnect: Classes.WARLOCK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.HEXBLADE,
      description:
        "     :  ,      -.",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.PACT,
      grantsSpells: true,
      classConnect: Classes.WARLOCK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.CELESTIAL,
      description:
        "     :  ,        .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.PACT,
      grantsSpells: true,
      classConnect: Classes.WARLOCK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.FATHOMLESS,
      description:
        "   :  ,  ,      .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.PACT,
      grantsSpells: true,
      classConnect: Classes.WARLOCK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.THE_GENIE,
      description:
        "   ,    :   ,         .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.PACT,
      grantsSpells: true,
      classConnect: Classes.WARLOCK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.UNDEAD,
      description:
        "-    ,       .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.PACT,
      grantsSpells: true,
      classConnect: Classes.WARLOCK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.UNDYING,
      description:
        "    :  ,       .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.PACT,
      grantsSpells: true,
      classConnect: Classes.WARLOCK_2014,
      expandedSpells: { connect: [] },
    },

    // ==== Sorcerer ====
    {
      name: Subclasses.ABERRANT_MIND,
      description:
        " ,      : ,     .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.SORCERER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.CLOCKWORK_SOUL,
      description:
        "     ,       .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.SORCERER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.DRACONIC_BLOODLINE,
      description:
        "   ,           .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.SORCERER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.DIVINE_SOUL,
      description:
        "      :  ,    .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.SORCERER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.LUNAR_SORCERY,
      description:
        "   :   ,         .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.SORCERER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SHADOW_MAGIC,
      description:
        "   ,  ,       .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.SORCERER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.STORM_SORCERY,
      description:
        "  :   ,    ,       .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.SORCERER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.WILD_MAGIC,
      description:
        "   :   ,        .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.SORCERER_2014,
      expandedSpells: { connect: [] },
    },

    // ==== Wizard ====
    {
      name: Subclasses.SCHOOL_OF_ABJURATION,
      description:
        "    :  ,      .",
      primaryCastingStat: Ability.INT,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.WIZARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SCHOOL_OF_BLADESINGING,
      description:
        "    :  ,  ,        .",
      primaryCastingStat: Ability.INT,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.WIZARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SCHOOL_OF_CHRONURGY,
      description:
        "  :  ,    ,     .",
      primaryCastingStat: Ability.INT,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.WIZARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SCHOOL_OF_CONJURATION,
      description:
        "       :  , ,  .",
      primaryCastingStat: Ability.INT,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.WIZARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SCHOOL_OF_DIVINATION,
      description:
        "  :  ,      .",
      primaryCastingStat: Ability.INT,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.WIZARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SCHOOL_OF_ENCHANTMENT,
      description:
        "  : ,   ,     .",
      primaryCastingStat: Ability.INT,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.WIZARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SCHOOL_OF_EVOCATION,
      description:
        "  :  ,  ,       .",
      primaryCastingStat: Ability.INT,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.WIZARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SCHOOL_OF_GRAVITURGY,
      description:
        "  :  , ,      .",
      primaryCastingStat: Ability.INT,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.WIZARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SCHOOL_OF_ILLUSION,
      description:
        "   :   ,  ,     .",
      primaryCastingStat: Ability.INT,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.WIZARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SCHOOL_OF_NECROMANCY,
      description:
        "    :    ,  /,      .",
      primaryCastingStat: Ability.INT,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.WIZARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.ORDER_OF_SCRIBES,
      description:
        "     :  ,  ,       .",
      primaryCastingStat: Ability.INT,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.WIZARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SCHOOL_OF_TRANSMUTATION,
      description:
        "  :  ,     ,  .",
      primaryCastingStat: Ability.INT,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.WIZARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SCHOOL_OF_WAR_MAGIC,
      description:
        "     :  ,  ,       .",
      primaryCastingStat: Ability.INT,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.WIZARD_2014,
      expandedSpells: { connect: [] },
    },

    // ==== Druid ====
    {
      name: Subclasses.CIRCLE_OF_DREAMS,
      description:
        "     :    ,     ,      .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.DRUID_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.CIRCLE_OF_THE_LAND,
      description:
        "     :   ,   ,       .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.DRUID_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.CIRCLE_OF_THE_MOON,
      description:
        "     :  ,  ,    .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.DRUID_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.CIRCLE_OF_THE_SHEPHERD,
      description:
        "-     ,  -,      .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.DRUID_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.CIRCLE_OF_SPORES,
      description:
        "    :  ,  ,        .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.DRUID_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.CIRCLE_OF_STARS,
      description:
        "    :  , ,   ,   ,    ,  .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.DRUID_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.CIRCLE_OF_WILDFIRE,
      description:
        "     :  ,     ,      .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.DRUID_2014,
      expandedSpells: { connect: [] },
    },

    // ==== Paladin ====
    {
      name: Subclasses.OATH_OF_THE_ANCIENTS,
      description:
        "       ,      .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.PALADIN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.OATH_OF_CONQUEST,
      description:
        "    :  ,      .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.PALADIN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.OATH_OF_THE_CROWN,
      description:
        "     ,   ,     .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.PALADIN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.OATH_OF_DEVOTION,
      description:
        "      : , ,      .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.PALADIN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.OATH_OF_GLORY,
      description:
        "  ,    :   ,     .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.PALADIN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.OATH_OF_REDEMPTION,
      description:
        "     ,          .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.PALADIN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.OATH_OF_VENGEANCE,
      description:
        "       - ,       .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.PALADIN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.OATH_OF_THE_WATCHERS,
      description:
        "       ,        .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.PALADIN_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.OATHBREAKER,
      description:
        "        ,     .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.PALADIN_2014,
      expandedSpells: { connect: [] },
    },

    // ==== Ranger ====
    {
      name: Subclasses.BEAST_MASTER_CONCLAVE,
      description:
        "       -,   --  .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.RANGER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.DRAKEWARDEN,
      description:
        "       ,  -    .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.RANGER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.FEY_WANDERER,
      description:
        "     :  ,        .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.RANGER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.GLOOM_STALKER_CONCLAVE,
      description:
        "       :   ,     .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.RANGER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.HORIZON_WALKER_CONCLAVE,
      description:
        "    : ,          .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.RANGER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.HUNTER_CONCLAVE,
      description:
        "     :  ,      .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.RANGER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.MONSTER_SLAYER_CONCLAVE,
      description:
        "    ,    ,      .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.RANGER_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SWARMKEEPER,
      description:
        "         :   ,     .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.HALF,
      grantsSpells: true,
      classConnect: Classes.RANGER_2014,
      expandedSpells: { connect: [] },
    },

    // ==== Bard ====
    {
      name: Subclasses.COLLEGE_OF_CREATION,
      description:
        "   ,   .        .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.BARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.COLLEGE_OF_ELOQUENCE,
      description:
        "    :  ,        .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.BARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.COLLEGE_OF_GLAMOUR,
      description:
        "     .    ,     .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.BARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.COLLEGE_OF_LORE,
      description:
        "      .   ,       - .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.BARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.COLLEGE_OF_SPIRITS,
      description:
        "     .      ,      .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.BARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.COLLEGE_OF_SWORDS,
      description:
        "     .      ,   .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.BARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.COLLEGE_OF_VALOR,
      description:
        "    .              .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.BARD_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.COLLEGE_OF_WHISPERS,
      description:
        "     .   ,     ,  .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.FULL,
      grantsSpells: true,
      classConnect: Classes.BARD_2014,
      expandedSpells: { connect: [] },
    },

    // ==== Rogue ====
    {
      name: Subclasses.ARCANE_TRICKSTER,
      description:
        "         ,     .",
      primaryCastingStat: Ability.INT,
      spellcastingType: SpellcastingType.THIRD,
      grantsSpells: true,
      classConnect: Classes.ROGUE_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.ASSASSIN,
      description:
        "     ,        .",
      primaryCastingStat: Ability.DEX,
      spellcastingType: SpellcastingType.NONE,
      grantsSpells: false,
      classConnect: Classes.ROGUE_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.INQUISITIVE,
      description:
        "     ,            .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.NONE,
      grantsSpells: false,
      classConnect: Classes.ROGUE_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.MASTERMIND,
      description:
        "       ,           .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.NONE,
      grantsSpells: false,
      classConnect: Classes.ROGUE_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.PHANTOM,
      description:
        "  '   ,          .",
      primaryCastingStat: Ability.DEX,
      spellcastingType: SpellcastingType.NONE,
      grantsSpells: false,
      classConnect: Classes.ROGUE_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SCOUT,
      description:
        "     ,       .",
      primaryCastingStat: Ability.DEX,
      spellcastingType: SpellcastingType.NONE,
      grantsSpells: false,
      classConnect: Classes.ROGUE_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SOULKNIFE,
      description:
        "                 '  .",
      primaryCastingStat: Ability.DEX,
      spellcastingType: SpellcastingType.NONE,
      grantsSpells: false,
      classConnect: Classes.ROGUE_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.SWASHBUCKLER,
      description:
        "     ,    ,       .",
      primaryCastingStat: Ability.CHA,
      spellcastingType: SpellcastingType.NONE,
      grantsSpells: false,
      classConnect: Classes.ROGUE_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.THIEF,
      description:
        "     :  ,       .",
      primaryCastingStat: Ability.DEX,
      spellcastingType: SpellcastingType.NONE,
      grantsSpells: false,
      classConnect: Classes.ROGUE_2014,
      expandedSpells: { connect: [] },
    },

    {
      name: Subclasses.WAY_OF_MERCY,
      description:
        "     ,      .   ,        .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.MONK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.WAY_OF_THE_ASCENDANT_DRAGON,
      description:
        "       .    ,          .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.MONK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.WAY_OF_THE_ASTRAL_SELF,
      description:
        "  \"\" ,     .    ,   ,        .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.MONK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.WAY_OF_THE_DRUNKEN_MASTER,
      description:
        " '       '.    ,        .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.MONK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.WAY_OF_THE_FOUR_ELEMENTS,
      description:
        "      , ,   .    ,    ',     .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.MONK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.WAY_OF_THE_KENSEI,
      description:
        "      .         ,       .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.MONK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.WAY_OF_THE_LONG_DEATH,
      description:
        "     .       ,   ,    .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.MONK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.WAY_OF_THE_OPEN_HAND,
      description:
        "       .     ,    ,      .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.MONK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.WAY_OF_SHADOW,
      description:
        "      .    ,     ,   .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.MONK_2014,
      expandedSpells: { connect: [] },
    },
    {
      name: Subclasses.WAY_OF_THE_SUN_SOUL,
      description:
        "      .         ,  .",
      primaryCastingStat: Ability.WIS,
      spellcastingType: SpellcastingType.NONE,
      classConnect: Classes.MONK_2014,
      expandedSpells: { connect: [] },
    },
  ]

  for (const subclass of subclasses) {
    const { classConnect, ...data } = subclass
    const cls = await prisma.class.findUnique({ where: { name: classConnect } })

    if (!cls) {
        console.error('   :', classConnect, ' :', subclass.name);
        throw new Error(`Class ${classConnect} not found for subclass ${subclass.name}`);
    }

    await prisma.subclass.upsert({
      where: {
        classId_name: {
          classId: cls.classId,
          name: subclass.name,
        },
      },
      update: {
        ...data,
        class: {
          connect: { name: classConnect },
        },
      },
      create: {
        ...data,
        class: {
          connect: { name: classConnect },
        },
      },
    })
  }

  console.log(`.  ${subclasses.length} .`)
}
</file>

<file path="src/lib/components/characterCreator/ClassOptionalFeaturesForm.tsx">
"use client";

import { useEffect, useMemo } from "react";
import { ClassI } from "@/lib/types/model-types";
import { useStepForm } from "@/hooks/useStepForm";
import { classOptionalFeaturesSchema } from "@/lib/zod/schemas/persCreateSchema";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { classTranslations, classTranslationsEng } from "@/lib/refs/translation";
import { InfoSectionTitle } from "@/lib/components/characterCreator/EntityInfoDialog";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import clsx from "clsx";
import { FormattedDescription } from "@/components/ui/FormattedDescription";

interface Props {
  selectedClass?: ClassI | null;
  formId: string;
  onNextDisabledChange?: (disabled: boolean) => void;
}

const displayName = (cls?: ClassI | null) =>
  cls ? classTranslations[cls.name] || classTranslationsEng[cls.name] || cls.name : "";

const ClassOptionalFeaturesForm = ({ selectedClass, formId, onNextDisabledChange }: Props) => {
  const { formData, updateFormData, nextStep } = usePersFormStore();
  
  const { form, onSubmit } = useStepForm(classOptionalFeaturesSchema, (data) => {
    updateFormData({ classOptionalFeatureSelections: data.classOptionalFeatureSelections });
    nextStep();
  });

  const decisions = form.watch("classOptionalFeatureSelections") || {};
  const selectedChoiceIds = useMemo(() => {
    const selections = (formData.classChoiceSelections as Record<string, number>) || {};
    return Object.values(selections)
      .map((value) => Number(value))
      .filter((value) => !Number.isNaN(value));
  }, [formData.classChoiceSelections]);

  const levelOneOptional = useMemo(
    () => (selectedClass?.classOptionalFeatures || []).filter((item) => (item.grantedOnLevels || []).includes(1)),
    [selectedClass]
  );

  const visibleOptional = useMemo(
    () =>
      levelOneOptional
        .filter((item) => {
          const deps = (item as any).appearsOnlyIfChoicesTaken || [];
          if (!deps.length) return true;
          return deps.some((choice: any) => selectedChoiceIds.includes(choice.choiceOptionId));
        })
        .filter((item) => Boolean(item.optionalFeatureId)),
    [levelOneOptional, selectedChoiceIds]
  );

  useEffect(() => {
    if (!selectedClass) {
      onNextDisabledChange?.(true);
      return;
    }
    if (!visibleOptional.length) {
      onNextDisabledChange?.(false);
      return;
    }
    const incomplete = visibleOptional.some(
      (item) => decisions[item.optionalFeatureId?.toString() || ""] === undefined
    );
    onNextDisabledChange?.(incomplete);
  }, [selectedClass, visibleOptional, decisions, onNextDisabledChange]);

  const setDecision = (id: number, take: boolean) => {
    const next = { ...(decisions || {}), [id]: take };
    form.setValue("classOptionalFeatureSelections", next, { shouldDirty: true });
  };

  if (!selectedClass) {
    return (
      <Card className="p-4 text-center text-slate-200">
          .
      </Card>
    );
  }

  if (!visibleOptional.length) {
    return (
      <Card className="p-4 text-center text-slate-200">
         1  {displayName(selectedClass)}    .  .
      </Card>
    );
  }

  return (
    <form id={formId} onSubmit={onSubmit} className="space-y-4">
      <div className="space-y-1 text-center">
        <p className="text-sm font-semibold text-slate-300"> 1</p>
        <h2 className="font-rpg-display text-3xl font-semibold uppercase tracking-widest text-slate-200 sm:text-4xl">  </h2>
        <p className="text-sm text-slate-400">
          ,    Optional Class Features.  ,    .
        </p>
      </div>

      <div className="space-y-3">
        {visibleOptional.map((item) => {
          if (!item.optionalFeatureId) return null;

          const key = item.optionalFeatureId?.toString() || "";
          const accepted = decisions[key];
          const title = item.title || item.feature?.name || " ";
          const description = item.feature?.description || " .";
          const replaces =
            item.replacesFeatures?.map((rep) => rep.replacedFeature?.name).filter(Boolean).join(", ") || "";

          return (
            <Card
              key={key}
              className={clsx(
                accepted === true && "border-gradient-rpg border-gradient-rpg-active glass-active",
                accepted === false && "opacity-90"
              )}
            >
              <CardContent className="space-y-3 p-4">
                <div className="flex flex-wrap items-center justify-between gap-2">
                  <div>
                    <p className="text-sm font-semibold text-white">{title}</p>
                    {replaces ? (
                      <p className="text-xs text-slate-400">: {replaces}</p>
                    ) : null}
                  </div>
                  <Badge variant="outline" className="border-white/15 bg-white/5 text-slate-200">
                     1
                  </Badge>
                </div>

                <div className="glass-panel border-gradient-rpg space-y-1.5 rounded-lg p-3">
                  <InfoSectionTitle></InfoSectionTitle>
                  <FormattedDescription
                    content={description}
                    className="text-sm leading-relaxed text-slate-200/90"
                  />
                </div>

                <div className="flex flex-wrap gap-2">
                  <Button
                    type="button"
                    size="sm"
                    variant="outline"
                    className={clsx(
                      "border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white",
                      accepted === true && "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100"
                    )}
                    onClick={() => setDecision(item.optionalFeatureId!, true)}
                  >
                    
                  </Button>
                  <Button
                    type="button"
                    size="sm"
                    variant="outline"
                    className={clsx(
                      "border-white/15 bg-white/5 text-slate-200 hover:bg-white/7 hover:text-white",
                      accepted === false && "border-rose-400/40 bg-rose-500/10 text-rose-50"
                    )}
                    onClick={() => setDecision(item.optionalFeatureId!, false)}
                  >
                    
                  </Button>
                </div>
              </CardContent>
            </Card>
          );
        })}
      </div>
    </form>
  );
};

export default ClassOptionalFeaturesForm;
</file>

<file path="src/lib/refs/translation.ts">
import { Skills } from "@prisma/client";

export const raceTranslations = {
  AASIMAR_2024: "",
  DRAGONBORN_2024: "",
  DWARF_2024: "",
  ELF_2024: "",
  GNOME_2024: "",
  GOLIATH_2024: "",
  HALFLING_2024: "",
  HUMAN_2024: "",
  ORC_2024: "",
  TIEFLING_2024: "",
  DRAGONBORN_2014: "",
  DRAGONBORN_CHROMATIC: " ()",
  DRAGONBORN_METALLIC: " ()",
  DRAGONBORN_GEM: " ()",
  DWARF_2014: "",
  ELF_2014: "",
  GNOME_2014: "",
  HALF_ELF_2014: "",
  HALF_ORC_2014: "",
  HALFLING_2014: "",
  HUMAN_2014: "",
  TIEFLING_2014: "",
  CENTAUR_GGTR: "",
  LOXODON_GGTR: "",
  MINOTAUR_GGTR: "",
  SIMIC_HYBRID_GGTR: " ",
  VEDALKEN_GGTR: "",
  VERDAN_AI: "",
  KALASHTAR_EBERRON: "",
  WARFORGED_EBERRON: "",
  LEONIN_MOOT: "",
  SATYR_MOOT: "",
  DHAMPIR_VRGTR: "",
  HEXBLOOD_VRGTR: "",
  REBORN_VRGTR: "",
  OWLIN_SACOC: "",
  AARAKOCRA_MPMM: "",
  AASIMAR_MPMM: "",
  BUGBEAR_MPMM: "",
  CENTAUR_MPMM: "",
  CHANGELING_MPMM: "",
  DEEP_GNOME_MPMM: " ",
  DUERGAR_MPMM: "",
  ELADRIN_MPMM: "",
  FAIRY_MPMM: "",
  FIRBOLG_MPMM: "",
  GENASI_AIR_MPMM: " ",
  GENASI_EARTH_MPMM: " ",
  GENASI_FIRE_MPMM: " ",
  GENASI_WATER_MPMM: " ",
  GITHYANKI_MPMM: "",
  GITHZERAI_MPMM: "",
  GOBLIN_MPMM: "",
  GOLIATH_MPMM: "",
  HARENGON_MPMM: "",
  HOBGOBLIN_MPMM: "",
  KENKU_MPMM: "",
  KOBOLD_MPMM: "",
  LIZARDFOLK_MPMM: "",
  MINOTAUR_MPMM: "",
  ORC_MPMM: "",
  SATYR_MPMM: "",
  SEA_ELF_MPMM: " ",
  SHADAR_KAI_MPMM: "-",
  SHIFTER_MPMM: "",
  TABAXI_MPMM: "",
  TORTLE_MPMM: "",
  TRITON_MPMM: "",
  YUAN_TI_MPMM: "-",
  ASTRAL_ELF_SPELLJAMMER: " ",
  AUTOGNOME_SPELLJAMMER: "",
  GIFF_SPELLJAMMER: "",
  HADOZEE_SPELLJAMMER: "",
  PLASMOID_SPELLJAMMER: "",
  THRI_KREEN_SPELLJAMMER: "-",
  KENDER_DRAGONLANCE: "",
  GRUNG_OGA: "",
  LOCATHAH_LR: ""
} as const;

export const raceTranslationsEng = {
  AASIMAR_2024: "Aasimar",
  DRAGONBORN_2024: "Dragonborn",
  DWARF_2024: "Dwarf",
  ELF_2024: "Elf",
  GNOME_2024: "Gnome",
  GOLIATH_2024: "Goliath",
  HALFLING_2024: "Halfling",
  HUMAN_2024: "Human",
  ORC_2024: "Orc",
  TIEFLING_2024: "Tiefling",
  DRAGONBORN_2014: "Dragonborn",
  DRAGONBORN_CHROMATIC: "Dragonborn (Chromatic)",
  DRAGONBORN_METALLIC: "Dragonborn (Metallic)",
  DRAGONBORN_GEM: "Dragonborn (Gem)",
  DWARF_2014: "Dwarf",
  ELF_2014: "Elf",
  GNOME_2014: "Gnome",
  HALF_ELF_2014: "Half-Elf",
  HALF_ORC_2014: "Half-Orc",
  HALFLING_2014: "Halfling",
  HUMAN_2014: "Human",
  TIEFLING_2014: "Tiefling",
  CENTAUR_GGTR: "Centaur",
  LOXODON_GGTR: "Loxodon",
  MINOTAUR_GGTR: "Minotaur",
  SIMIC_HYBRID_GGTR: "Simic Hybrid",
  VEDALKEN_GGTR: "Vedalken",
  VERDAN_AI: "Verdan",
  KALASHTAR_EBERRON: "Kalashtar",
  WARFORGED_EBERRON: "Warforged",
  LEONIN_MOOT: "Leonin",
  SATYR_MOOT: "Satyr",
  DHAMPIR_VRGTR: "Dhampir",
  HEXBLOOD_VRGTR: "Hexblood",
  REBORN_VRGTR: "Reborn",
  OWLIN_SACOC: "Owlin",
  AARAKOCRA_MPMM: "Aarakocra",
  AASIMAR_MPMM: "Aasimar",
  BUGBEAR_MPMM: "Bugbear",
  CENTAUR_MPMM: "Centaur",
  CHANGELING_MPMM: "Changeling",
  DEEP_GNOME_MPMM: "Deep Gnome",
  DUERGAR_MPMM: "Duergar",
  ELADRIN_MPMM: "Eladrin",
  FAIRY_MPMM: "Fairy",
  FIRBOLG_MPMM: "Firbolg",
  GENASI_AIR_MPMM: "Genasi (Air)",
  GENASI_EARTH_MPMM: "Genasi (Earth)",
  GENASI_FIRE_MPMM: "Genasi (Fire)",
  GENASI_WATER_MPMM: "Genasi (Water)",
  GITHYANKI_MPMM: "Githyanki",
  GITHZERAI_MPMM: "Githzerai",
  GOBLIN_MPMM: "Goblin",
  GOLIATH_MPMM: "Goliath",
  HARENGON_MPMM: "Harengon",
  HOBGOBLIN_MPMM: "Hobgoblin",
  KENKU_MPMM: "Kenku",
  KOBOLD_MPMM: "Kobold",
  LIZARDFOLK_MPMM: "Lizardfolk",
  MINOTAUR_MPMM: "Minotaur",
  ORC_MPMM: "Orc",
  SATYR_MPMM: "Satyr",
  SEA_ELF_MPMM: "Sea Elf",
  SHADAR_KAI_MPMM: "Shadar-Kai",
  SHIFTER_MPMM: "Shifter",
  TABAXI_MPMM: "Tabaxi",
  TORTLE_MPMM: "Tortle",
  TRITON_MPMM: "Triton",
  YUAN_TI_MPMM: "Yuan-ti",
  ASTRAL_ELF_SPELLJAMMER: "Astral Elf",
  AUTOGNOME_SPELLJAMMER: "Autognome",
  GIFF_SPELLJAMMER: "Giff",
  HADOZEE_SPELLJAMMER: "Hadozee",
  PLASMOID_SPELLJAMMER: "Plasmoid",
  THRI_KREEN_SPELLJAMMER: "Thri-Kreen",
  KENDER_DRAGONLANCE: "Kender",
  GRUNG_OGA: "Grung",
  LOCATHAH_LR: "Locathah"
} as const;

export const variantTranslations = {
  HALF_ELF_VARIANT_HIGH_DESCENT_SCAG: " ",
  HALF_ELF_VARIANT_WOOD_DESCENT_SCAG: " ",
  HALF_ELF_VARIANT_DROW_DESCENT_SCAG: "-",
  HALF_ELF_VARIANT_AQUATIC_DESCENT_SCAG: " )",
  HALF_ELF_VARIANT: " ",
  TIEFLING_BAALZEBUL: " ()",
  TIEFLING_DISPATER: " ()",
  TIEFLING_ASMODEUS: " ()",
  TIEFLING_FIERNA: " ()",
  TIEFLING_GLASYA: " ()",
  TIEFLING_LEVISTUS: " ()",
  TIEFLING_MAMMON: " ()",
  TIEFLING_MEPHISTOPHELES: " ()",
  TIEFLING_ZARIEL: " ()",
  TIEFLING_VARIANT_FERAL_SCAG: " ( )",
  TIEFLING_VARIANT_DEVILS_TONGUE_SCAG: " ( )",
  TIEFLING_VARIANT_HELLFIRE_SCAG: " ( )",
  TIEFLING_VARIANT_WINGED_SCAG: " ()",
  HUMAN_VARIANT: " ",
  HALF_ELF_MARK_OF_DETECTION_EBERRON: " ( )",
  HALF_ELF_MARK_OF_STORM_EBERRON: " ( )",
  DWARF_MARK_OF_WARDING_EBERRON: " ( )",
  HALFLING_MARK_OF_HEALING_EBERRON: " ( )",
  HALFLING_MARK_OF_HOSPITALITY_EBERRON: " ( )",
  GNOME_MARK_OF_SCRIBING_EBERRON: " ( )",
  HUMAN_MARK_OF_FINDING_EBERRON: " ( )",
  HALF_ORC_MARK_OF_FINDING_EBERRON: " ( )",
  HUMAN_MARK_OF_HANDLING_EBERRON: " ( )",
  HUMAN_MARK_OF_MAKING_EBERRON: " ( )",
  HUMAN_MARK_OF_PASSAGE_EBERRON: " ( )",
  HUMAN_MARK_OF_SENTINEL_EBERRON: " ( )",
  ELF_MARK_OF_SHADOW_EBERRON: " ( )",
} as const;

export const variantTranslationsEng = {
  HALF_ELF_VARIANT_HIGH_DESCENT_SCAG: "Half-Elf (High Descent)",
  HALF_ELF_VARIANT_WOOD_DESCENT_SCAG: "Half-Elf (Wood Descent)",
  HALF_ELF_VARIANT_DROW_DESCENT_SCAG: "Half-Elf (Drow Descent)",
  HALF_ELF_VARIANT_AQUATIC_DESCENT_SCAG: "Half-Elf (Aquatic Descent)",
  HALF_ELF_VARIANT: "Half-Elf Variant",
  TIEFLING_ASMODEUS: "Tiefling (Asmodeus)",
  TIEFLING_BAALZEBUL: "Tiefling (Baalzebul)",
  TIEFLING_DISPATER: "Tiefling (Dispater)",
  TIEFLING_FIERNA: "Tiefling (Fierna)",
  TIEFLING_GLASYA: "Tiefling (Glasya)",
  TIEFLING_LEVISTUS: "Tiefling (Levistus)",
  TIEFLING_MAMMON: "Tiefling (Mammon)",
  TIEFLING_MEPHISTOPHELES: "Tiefling (Mephistopheles)",
  TIEFLING_ZARIEL: "Tiefling (Zariel)",
  TIEFLING_VARIANT_FERAL_SCAG: "Tiefling (Feral Variant)",
  TIEFLING_VARIANT_DEVILS_TONGUE_SCAG: "Tiefling (Devil's Tongue)",
  TIEFLING_VARIANT_HELLFIRE_SCAG: "Tiefling (Hellfire)",
  TIEFLING_VARIANT_WINGED_SCAG: "Tiefling (Winged)",
  HUMAN_VARIANT: "Human Variant",
  HALF_ELF_MARK_OF_DETECTION_EBERRON: "Half-Elf (Mark of Detection)",
  HALF_ELF_MARK_OF_STORM_EBERRON: "Half-Elf (Mark of Storm)",
  DWARF_MARK_OF_WARDING_EBERRON: "Dwarf (Mark of Warding)",
  HALFLING_MARK_OF_HEALING_EBERRON: "Halfling (Mark of Healing)",
  HALFLING_MARK_OF_HOSPITALITY_EBERRON: "Halfling (Mark of Hospitality)",
  GNOME_MARK_OF_SCRIBING_EBERRON: "Gnome (Mark of Scribing)",
  HUMAN_MARK_OF_FINDING_EBERRON: "Human (Mark of Finding)",
  HALF_ORC_MARK_OF_FINDING_EBERRON: "Half-Orc (Mark of Finding)",
  HUMAN_MARK_OF_HANDLING_EBERRON: "Human (Mark of Handling)",
  HUMAN_MARK_OF_MAKING_EBERRON: "Human (Mark of Making)",
  HUMAN_MARK_OF_PASSAGE_EBERRON: "Human (Mark of Passage)",
  HUMAN_MARK_OF_SENTINEL_EBERRON: "Human (Mark of Sentinel)",
  ELF_MARK_OF_SHADOW_EBERRON: "Elf (Mark of Shadow)",
} as const;


export const classTranslations = {
  ARTIFICER_2014: "",
  BARBARIAN_2014: "",
  BARD_2014: "",
  CLERIC_2014: "",
  DRUID_2014: "",
  FIGHTER_2014: "",
  MONK_2014: "",
  PALADIN_2014: "",
  RANGER_2014: "",
  ROGUE_2014: "",
  SORCERER_2014: "",
  WARLOCK_2014: "",
  WIZARD_2014: ""
} as const;

export const classTranslationsEng = {
  ARTIFICER_2014: "Artificer",
  BARBARIAN_2014: "Barbarian",
  BARD_2014: "Bard",
  CLERIC_2014: "Cleric",
  DRUID_2014: "Druid",
  FIGHTER_2014: "Fighter",
  MONK_2014: "Monk",
  PALADIN_2014: "Paladin",
  RANGER_2014: "Ranger",
  ROGUE_2014: "Rogue",
  SORCERER_2014: "Sorcerer",
  WARLOCK_2014: "Warlock",
  WIZARD_2014: "Wizard"
} as const;

export const subclassTranslations = {
  // Artificer
  ALCHEMIST: "",
  ARMORER: "",
  ARTILLERIST: "",
  BATTLE_SMITH: " ",

  // Barbarian
  PATH_OF_THE_ANCESTRAL_GUARDIAN: " -",
  PATH_OF_THE_BATTLERAGER: "  ",
  PATH_OF_THE_BEAST: " ",
  PATH_OF_THE_BERSERKER: " ",
  PATH_OF_THE_GIANT: " ",
  PATH_OF_THE_STORM_HERALD: "  ",
  PATH_OF_THE_TOTEM_WARRIOR: "  ",
  PATH_OF_WILD_MAGIC: "  ",
  PATH_OF_THE_ZEALOT: " ",

  // Bard
  COLLEGE_OF_CREATION: " ",
  COLLEGE_OF_ELOQUENCE: " ",
  COLLEGE_OF_GLAMOUR: " ",
  COLLEGE_OF_LORE: " ",
  COLLEGE_OF_SPIRITS: " ",
  COLLEGE_OF_SWORDS: " ",
  COLLEGE_OF_VALOR: " ",
  COLLEGE_OF_WHISPERS: " ",

  // Cleric
  ARCANA_DOMAIN: " ",
  DEATH_DOMAIN: " ",
  FORGE_DOMAIN: " ",
  GRAVE_DOMAIN: " ",
  KNOWLEDGE_DOMAIN: " ",
  LIFE_DOMAIN: " ",
  LIGHT_DOMAIN: " ",
  NATURE_DOMAIN: " ",
  ORDER_DOMAIN: " ",
  PEACE_DOMAIN: " ",
  TEMPEST_DOMAIN: " ",
  TRICKERY_DOMAIN: " ",
  TWILIGHT_DOMAIN: " ",
  WAR_DOMAIN: " ",

  // Druid
  CIRCLE_OF_DREAMS: " ",
  CIRCLE_OF_THE_LAND: " ",
  CIRCLE_OF_THE_MOON: " ",
  CIRCLE_OF_THE_SHEPHERD: " ",
  CIRCLE_OF_SPORES: " ",
  CIRCLE_OF_STARS: " ",
  CIRCLE_OF_WILDFIRE: "  ",

  // Fighter
  ARCANE_ARCHER: " ",
  BANNERET: "",
  BATTLE_MASTER: "  ",
  CAVALIER: "",
  CHAMPION: "",
  ECHO_KNIGHT: " ",
  ELDRITCH_KNIGHT: " ",
  PSI_WARRIOR: "-",
  RUNE_KNIGHT: " ",
  SAMURAI: "",

  // Monk
  WAY_OF_MERCY: " ",
  WAY_OF_THE_ASCENDANT_DRAGON: "  ",
  WAY_OF_THE_ASTRAL_SELF: "  ",
  WAY_OF_THE_DRUNKEN_MASTER: " ' ",
  WAY_OF_THE_FOUR_ELEMENTS: "  ",
  WAY_OF_THE_KENSEI: " ",
  WAY_OF_THE_LONG_DEATH: "  ",
  WAY_OF_THE_OPEN_HAND: "  ",
  WAY_OF_SHADOW: " ",
  WAY_OF_THE_SUN_SOUL: "  ",

  // Paladin
  OATH_OF_THE_ANCIENTS: " ",
  OATH_OF_CONQUEST: " ",
  OATH_OF_THE_CROWN: " ",
  OATH_OF_DEVOTION: " ",
  OATH_OF_GLORY: " ",
  OATH_OF_REDEMPTION: " ",
  OATH_OF_VENGEANCE: " ",
  OATH_OF_THE_WATCHERS: " ",
  OATHBREAKER: "",

  // Ranger
  BEAST_MASTER_CONCLAVE: " ",
  DRAKEWARDEN: " ",
  FEY_WANDERER: " ",
  GLOOM_STALKER_CONCLAVE: "  ",
  HORIZON_WALKER_CONCLAVE: "  ",
  HUNTER_CONCLAVE: " ",
  MONSTER_SLAYER_CONCLAVE: "  ",
  SWARMKEEPER: " ",

  // Rogue
  ARCANE_TRICKSTER: " ",
  ASSASSIN: "",
  INQUISITIVE: "",
  MASTERMIND: " ",
  PHANTOM: "",
  SCOUT: "",
  SOULKNIFE: " ",
  SWASHBUCKLER: "",
  THIEF: "",

  // Sorcerer
  ABERRANT_MIND: " ",
  CLOCKWORK_SOUL: " ",
  DRACONIC_BLOODLINE: " ",
  DIVINE_SOUL: " ",
  LUNAR_SORCERY: " ",
  SHADOW_MAGIC: " ",
  STORM_SORCERY: " ",
  WILD_MAGIC: " ",

  // Warlock
  ARCHFEY: "",
  CELESTIAL: "",
  FATHOMLESS: "",
  FIEND: "",
  THE_GENIE: "",
  GREAT_OLD_ONE: "",
  HEXBLADE: " ",
  UNDEAD: "",
  UNDYING: "",

  // Wizard
  SCHOOL_OF_ABJURATION: " ",
  SCHOOL_OF_BLADESINGING: "  ",
  SCHOOL_OF_CHRONURGY: " ",
  SCHOOL_OF_CONJURATION: " ",
  SCHOOL_OF_DIVINATION: " ",
  SCHOOL_OF_ENCHANTMENT: " ",
  SCHOOL_OF_EVOCATION: " ",
  SCHOOL_OF_GRAVITURGY: " ",
  SCHOOL_OF_ILLUSION: " ",
  SCHOOL_OF_NECROMANCY: " ",
  ORDER_OF_SCRIBES: " ",
  SCHOOL_OF_TRANSMUTATION: " ",
  SCHOOL_OF_WAR_MAGIC: "  ",
} as const;

export const subclassTranslationsEng = {
  // Artificer
  ALCHEMIST: "Alchemist",
  ARMORER: "Armorer",
  ARTILLERIST: "Artillerist",
  BATTLE_SMITH: "Battle Smith",

  // Barbarian
  PATH_OF_THE_ANCESTRAL_GUARDIAN: "Path of the Ancestral Guardian",
  PATH_OF_THE_BATTLERAGER: "Path of the Battlerager",
  PATH_OF_THE_BEAST: "Path of the Beast",
  PATH_OF_THE_BERSERKER: "Path of the Berserker",
  PATH_OF_THE_GIANT: "Path of the Giant",
  PATH_OF_THE_STORM_HERALD: "Path of the Storm Herald",
  PATH_OF_THE_TOTEM_WARRIOR: "Path of the Totem Warrior",
  PATH_OF_WILD_MAGIC: "Path of Wild Magic",
  PATH_OF_THE_ZEALOT: "Path of the Zealot",

  // Bard
  COLLEGE_OF_CREATION: "College of Creation",
  COLLEGE_OF_ELOQUENCE: "College of Eloquence",
  COLLEGE_OF_GLAMOUR: "College of Glamour",
  COLLEGE_OF_LORE: "College of Lore",
  COLLEGE_OF_SPIRITS: "College of Spirits",
  COLLEGE_OF_SWORDS: "College of Swords",
  COLLEGE_OF_VALOR: "College of Valor",
  COLLEGE_OF_WHISPERS: "College of Whispers",

  // Cleric
  ARCANA_DOMAIN: "Arcana Domain",
  DEATH_DOMAIN: "Death Domain",
  FORGE_DOMAIN: "Forge Domain",
  GRAVE_DOMAIN: "Grave Domain",
  KNOWLEDGE_DOMAIN: "Knowledge Domain",
  LIFE_DOMAIN: "Life Domain",
  LIGHT_DOMAIN: "Light Domain",
  NATURE_DOMAIN: "Nature Domain",
  ORDER_DOMAIN: "Order Domain",
  PEACE_DOMAIN: "Peace Domain",
  TEMPEST_DOMAIN: "Tempest Domain",
  TRICKERY_DOMAIN: "Trickery Domain",
  TWILIGHT_DOMAIN: "Twilight Domain",
  WAR_DOMAIN: "War Domain",

  // Druid
  CIRCLE_OF_DREAMS: "Circle of Dreams",
  CIRCLE_OF_THE_LAND: "Circle of the Land",
  CIRCLE_OF_THE_MOON: "Circle of the Moon",
  CIRCLE_OF_THE_SHEPHERD: "Circle of the Shepherd",
  CIRCLE_OF_SPORES: "Circle of Spores",
  CIRCLE_OF_STARS: "Circle of Stars",
  CIRCLE_OF_WILDFIRE: "Circle of Wildfire",

  // Fighter
  ARCANE_ARCHER: "Arcane Archer",
  BANNERET: "Banneret",
  BATTLE_MASTER: "Battle Master",
  CAVALIER: "Cavalier",
  CHAMPION: "Champion",
  ECHO_KNIGHT: "Echo Knight",
  ELDRITCH_KNIGHT: "Eldritch Knight",
  PSI_WARRIOR: "Psi Warrior",
  RUNE_KNIGHT: "Rune Knight",
  SAMURAI: "Samurai",

  // Monk
  WAY_OF_MERCY: "Way of Mercy",
  WAY_OF_THE_ASCENDANT_DRAGON: "Way of the Ascendant Dragon",
  WAY_OF_THE_ASTRAL_SELF: "Way of the Astral Self",
  WAY_OF_THE_DRUNKEN_MASTER: "Way of the Drunken Master",
  WAY_OF_THE_FOUR_ELEMENTS: "Way of the Four Elements",
  WAY_OF_THE_KENSEI: "Way of the Kensei",
  WAY_OF_THE_LONG_DEATH: "Way of the Long Death",
  WAY_OF_THE_OPEN_HAND: "Way of the Open Hand",
  WAY_OF_SHADOW: "Way of Shadow",
  WAY_OF_THE_SUN_SOUL: "Way of the Sun Soul",

  // Paladin
  OATH_OF_THE_ANCIENTS: "Oath of the Ancients",
  OATH_OF_CONQUEST: "Oath of Conquest",
  OATH_OF_THE_CROWN: "Oath of the Crown",
  OATH_OF_DEVOTION: "Oath of Devotion",
  OATH_OF_GLORY: "Oath of Glory",
  OATH_OF_REDEMPTION: "Oath of Redemption",
  OATH_OF_VENGEANCE: "Oath of Vengeance",
  OATH_OF_THE_WATCHERS: "Oath of the Watchers",
  OATHBREAKER: "Oathbreaker",

  // Ranger
  BEAST_MASTER_CONCLAVE: "Beast Master Conclave",
  DRAKEWARDEN: "Drakewarden",
  FEY_WANDERER: "Fey Wanderer",
  GLOOM_STALKER_CONCLAVE: "Gloom Stalker Conclave",
  HORIZON_WALKER_CONCLAVE: "Horizon Walker Conclave",
  HUNTER_CONCLAVE: "Hunter Conclave",
  MONSTER_SLAYER_CONCLAVE: "Monster Slayer Conclave",
  SWARMKEEPER: "Swarmkeeper",

  // Rogue
  ARCANE_TRICKSTER: "Arcane Trickster",
  ASSASSIN: "Assassin",
  INQUISITIVE: "Inquisitive",
  MASTERMIND: "Mastermind",
  PHANTOM: "Phantom",
  SCOUT: "Scout",
  SOULKNIFE: "Soulknife",
  SWASHBUCKLER: "Swashbuckler",
  THIEF: "Thief",

  // Sorcerer
  ABERRANT_MIND: "Aberrant Mind",
  CLOCKWORK_SOUL: "Clockwork Soul",
  DRACONIC_BLOODLINE: "Draconic Bloodline",
  DIVINE_SOUL: "Divine Soul",
  LUNAR_SORCERY: "Lunar Sorcery",
  SHADOW_MAGIC: "Shadow Magic",
  STORM_SORCERY: "Storm Sorcery",
  WILD_MAGIC: "Wild Magic",

  // Warlock
  ARCHFEY: "Archfey",
  CELESTIAL: "Celestial",
  FATHOMLESS: "Fathomless",
  FIEND: "Fiend",
  THE_GENIE: "The Genie",
  GREAT_OLD_ONE: "Great Old One",
  HEXBLADE: "Hexblade",
  UNDEAD: "Undead",
  UNDYING: "Undying",

  // Wizard
  SCHOOL_OF_ABJURATION: "School of Abjuration",
  SCHOOL_OF_BLADESINGING: "School of Bladesinging",
  SCHOOL_OF_CHRONURGY: "School of Chronurgy",
  SCHOOL_OF_CONJURATION: "School of Conjuration",
  SCHOOL_OF_DIVINATION: "School of Divination",
  SCHOOL_OF_ENCHANTMENT: "School of Enchantment",
  SCHOOL_OF_EVOCATION: "School of Evocation",
  SCHOOL_OF_GRAVITURGY: "School of Graviturgy",
  SCHOOL_OF_ILLUSION: "School of Illusion",
  SCHOOL_OF_NECROMANCY: "School of Necromancy",
  ORDER_OF_SCRIBES: "Order of Scribes",
  SCHOOL_OF_TRANSMUTATION: "School of Transmutation",
  SCHOOL_OF_WAR_MAGIC: "School of War Magic",
} as const;


export const backgroundTranslations = {
  ACOLYTE: "",
  CHARLATAN: "",
  CRIMINAL: "",
  ENTERTAINER: "",
  FOLK_HERO: " ",
  GUILD_ARTISAN: " ",
  GUILD_MERCHANT: " ",
  HERMIT: "",
  NOBLE: "",
  OUTLANDER: "",
  SAGE: "",
  SAILOR: "",
  SOLDIER: "",
  URCHIN: "",
  GLADIATOR: "",
  KNIGHT: "",
  PIRATE: "",
  SPY: "",
  ANTHROPOLOGIST: "",
  ARCHAEOLOGIST: "",
  CITY_WATCH: " ",
  CLAN_CRAFTER: " ",
  CLOISTERED_SCHOLAR: " ",
  COURTIER: "",
  FACTION_AGENT: " ",
  FAR_TRAVELER: " ",
  INHERITOR: "",
  INVESTIGATOR: "",
  KNIGHT_OF_THE_ORDER: " ",
  MERCENARY_VETERAN: "-",
  URBAN_BOUNTY_HUNTER: "   ",
  UTHGARDT_TRIBE_MEMBER: "  ",
  WATERDHAVIAN_NOBLE: " ",
  FISHER: "",
  SHIPWRIGHT: " ",
  SMUGGLER: "",
  MARINE: " ",
  AZORIUS_FUNCTIONARY: " ",
  BOROS_LEGIONNAIRE: " ",
  DIMIR_OPERATIVE: " ",
  GOLGARI_AGENT: " ",
  GRUUL_ANARCH: " ",
  IZZET_ENGINEER: " ",
  ORZHOV_REPRESENTATIVE: " ",
  RAKDOS_CULTIST: " ",
  SELESNYA_INITIATE: " ",
  SIMIC_SCIENTIST: " ",
  GRINNER: "",
  VOLSTRUCKER_AGENT: " ",
  ATHLETE: "",
  LOREHOLD_STUDENT: " ",
  PRISMARI_STUDENT: " ",
  QUANDRIX_STUDENT: " ",
  SILVERQUILL_STUDENT: " ",
  WITHERBLOOM_STUDENT: " ",
  ASTRAL_DRIFTER: " ",
  FACELESS: "",
  FAILED_MERCHANT: "-",
  FEYLOST: "   ",
  GAMBLER: " ",
  HAUNTED_ONE: "",
  PLAINTIFF: "",
  RIVAL_INTERN: " ",
  WILDSPACER: " ",
  WITCHLIGHT_HAND: "  (  )",
  KNIGHT_OF_SOLAMNIA: " ",
  MAGE_OF_HIGH_SORCERY: "  ",
  HOUSE_AGENT: " ",
  ARTISAN_2024: " 2024",
  CHARLATAN_2024: " 2024",
  CRIMINAL_2024: " 2024",
  ENTERTAINER_2024: " 2024",
  FARMER_2024: " 2024",
  GUARD_2024: " 2024",
  GUIDE_2024: " 2024",
  HERMIT_2024: " 2024",
  MERCHANT_2024: " 2024",
  NOBLE_2024: " 2024",
  SAGE_2024: " 2024",
  SAILOR_2024: " 2024",
  SCRIBE_2024: " 2024",
  SOLDIER_2024: " 2024",
  WAYFARER_2024: " 2024",
  CUSTOM: ""
} as const;

export const backgroundTranslationsEng = {
  ACOLYTE: "Acolyte",
  CHARLATAN: "Charlatan",
  CRIMINAL: "Criminal",
  ENTERTAINER: "Entertainer",
  FOLK_HERO: "Folk Hero",
  GUILD_ARTISAN: "Guild Artisan",
  GUILD_MERCHANT: "Guild Merchant",
  HERMIT: "Hermit",
  NOBLE: "Noble",
  OUTLANDER: "Outlander",
  SAGE: "Sage",
  SAILOR: "Sailor",
  SOLDIER: "Soldier",
  URCHIN: "Urchin",
  GLADIATOR: "Gladiator",
  KNIGHT: "Knight",
  PIRATE: "Pirate",
  SPY: "Spy",
  ANTHROPOLOGIST: "Anthropologist",
  ARCHAEOLOGIST: "Archaeologist",
  CITY_WATCH: "City Watch",
  CLAN_CRAFTER: "Clan Crafter",
  CLOISTERED_SCHOLAR: "Cloistered Scholar",
  COURTIER: "Courtier",
  FACTION_AGENT: "Faction Agent",
  FAR_TRAVELER: "Far Traveler",
  INHERITOR: "Inheritor",
  INVESTIGATOR: "Investigator",
  KNIGHT_OF_THE_ORDER: "Knight of the Order",
  MERCENARY_VETERAN: "Mercenary Veteran",
  URBAN_BOUNTY_HUNTER: "Urban Bounty Hunter",
  UTHGARDT_TRIBE_MEMBER: "Uthgardt Tribe Member",
  WATERDHAVIAN_NOBLE: "Waterdhavian Noble",
  FISHER: "Fisher",
  SHIPWRIGHT: "Shipwright",
  SMUGGLER: "Smuggler",
  MARINE: "Marine",
  AZORIUS_FUNCTIONARY: "Azorius Functionary",
  BOROS_LEGIONNAIRE: "Boros Legionnaire",
  DIMIR_OPERATIVE: "Dimir Operative",
  GOLGARI_AGENT: "Golgari Agent",
  GRUUL_ANARCH: "Gruul Anarch",
  IZZET_ENGINEER: "Izzet Engineer",
  ORZHOV_REPRESENTATIVE: "Orzhov Representative",
  RAKDOS_CULTIST: "Rakdos Cultist",
  SELESNYA_INITIATE: "Selesnya Initiate",
  SIMIC_SCIENTIST: "Simic Scientist",
  GRINNER: "Grinner",
  VOLSTRUCKER_AGENT: "Volstrucker Agent",
  ATHLETE: "Athlete",
  LOREHOLD_STUDENT: "Lorehold Student",
  PRISMARI_STUDENT: "Prismari Student",
  QUANDRIX_STUDENT: "Quandrix Student",
  SILVERQUILL_STUDENT: "Silverquill Student",
  WITHERBLOOM_STUDENT: "Witherbloom Student",
  ASTRAL_DRIFTER: "Astral Drifter",
  FACELESS: "Faceless",
  FAILED_MERCHANT: "Failed Merchant",
  FEYLOST: "Feylost",
  GAMBLER: "Gambler",
  HAUNTED_ONE: "Haunted One",
  PLAINTIFF: "Plaintiff",
  RIVAL_INTERN: "Rival Intern",
  WILDSPACER: "Wildspacer",
  WITCHLIGHT_HAND: "Witchlight Hand",
  KNIGHT_OF_SOLAMNIA: "Knight of Solamnia",
  MAGE_OF_HIGH_SORCERY: "Mage of High Sorcery",
  HOUSE_AGENT: "House Agent",
  ARTISAN_2024: "Artisan 2024",
  CHARLATAN_2024: "Charlatan 2024",
  CRIMINAL_2024: "Criminal 2024",
  ENTERTAINER_2024: "Entertainer 2024",
  FARMER_2024: "Farmer 2024",
  GUARD_2024: "Guard 2024",
  GUIDE_2024: "Guide 2024",
  HERMIT_2024: "Hermit 2024",
  MERCHANT_2024: "Merchant 2024",
  NOBLE_2024: "Noble 2024",
  SAGE_2024: "Sage 2024",
  SAILOR_2024: "Sailor 2024",
  SCRIBE_2024: "Scribe 2024",
  SOLDIER_2024: "Soldier 2024",
  WAYFARER_2024: "Wayfarer 2024",
  CUSTOM: "Custom"
} as const;


export const attributesUkrFull = {
  STR: "",
  DEX: "",
  CON: "",
  INT: "",
  WIS: "",
  CHA: ""
};

export const attributesUkrShort = {
  STR: "",
  DEX: "",
  CON: "",
  INT: "",
  WIS: "",
  CHA: ""
};

export const skills = [
  { eng: 'Acrobatics', ukr: '' },
  { eng: 'Animal Handling', ukr: '  ' },
  { eng: 'Arcana', ukr: '' },
  { eng: 'Athletics', ukr: '' },
  { eng: 'Deception', ukr: '' },
  { eng: 'History', ukr: '' },
  { eng: 'Insight', ukr: ' ' },
  { eng: 'Intimidation', ukr: '' },
  { eng: 'Investigation', ukr: '' },
  { eng: 'Medicine', ukr: '' },
  { eng: 'Nature', ukr: '' },
  { eng: 'Perception', ukr: '' },
  { eng: 'Performance', ukr: '' },
  { eng: 'Persuasion', ukr: '' },
  { eng: 'Religion', ukr: '' },
  { eng: 'Sleight of Hand', ukr: ' ' },
  { eng: 'Stealth', ukr: '' },
  { eng: 'Survival', ukr: '' }
];

export const engEnumSkills = [
  { eng: Skills.ACROBATICS, ukr: '' },
  { eng: Skills.ANIMAL_HANDLING, ukr: '  ' },
  { eng: Skills.ARCANA, ukr: '' },
  { eng: Skills.ATHLETICS, ukr: '' },
  { eng: Skills.DECEPTION, ukr: '' },
  { eng: Skills.HISTORY, ukr: '' },
  { eng: Skills.INSIGHT, ukr: ' ' },
  { eng: Skills.INTIMIDATION, ukr: '' },
  { eng: Skills.INVESTIGATION, ukr: '' },
  { eng: Skills.MEDICINE, ukr: '' },
  { eng: Skills.NATURE, ukr: '' },
  { eng: Skills.PERCEPTION, ukr: '' },
  { eng: Skills.PERFORMANCE, ukr: '' },
  { eng: Skills.PERSUASION, ukr: '' },
  { eng: Skills.RELIGION, ukr: '' },
  { eng: Skills.SLEIGHT_OF_HAND, ukr: ' ' },
  { eng: Skills.STEALTH, ukr: '' },
  { eng: Skills.SURVIVAL, ukr: '' }
];

export const sourceTranslations = {
  PHB: "  (2014)",
  DMG: "  (2014)",
  MM: " (2014)",
  XGTE: "   ",
  TCOE: "   ",
  FTOD: "  ",
  EGTW: "   ",
  SCAG: "   ",
  GGTR: "  ",
  AI: " ",
  IDROTF: "  :   ",
  SPELLJAMMER: ":   ",
  COS: " ",
  BGDIA: " :   ",
  VGTM: "   ",
  MTOF: "  ",
  MPMM: " ",
  BPGOTG: " :  ",
  VRGTR: "    ",
  MOOT: "  ",
  SACOC: ":   ",
  WBTW: "   ",
  EBERRON: ":    ",
  DRAGONLANCE: " :   ",
  PHB_2024: "  (2024)",
  DMG_2024: "  (2024)",
  MM_2024: " (2024)",
  OGA: "  ",
  LR: " "
} as const;

export const sourceTranslationsEng = {
  PHB: "Player's Handbook (2014)",
  DMG: "Dungeon Master's Guide (2014)",
  MM: "Monster Manual (2014)",
  XGTE: "Xanathar's Guide to Everything",
  TCOE: "Tasha's Cauldron of Everything",
  FTOD: "Fizban's Treasury of Dragons",
  EGTW: "Explorer's Guide to Wildemount",
  SCAG: "Sword Coast Adventurer's Guide",
  GGTR: "Guildmasters' Guide to Ravnica",
  AI: "Acquisitions Incorporated",
  IDROTF: "Icewind Dale: Rime of the Frostmaiden",
  SPELLJAMMER: "Spelljammer: Adventures in Space",
  COS: "Curse of Strahd",
  BGDIA: "Baldur's Gate: Descent into Avernus",
  VGTM: "Volo's Guide to Monsters",
  MTOF: "Mordenkainen's Tome of Foes",
  MPMM: "Mordenkainen Presents: Monsters of the Multiverse",
  BPGOTG: "Bigby Presents: Glory of the Giants",
  VRGTR: "Van Richten's Guide to Ravenloft",
  MOOT: "Mythic Odysseys of Theros",
  SACOC: "Strixhaven: A Curriculum of Chaos",
  WBTW: "The Wild Beyond the Witchlight",
  EBERRON: "Eberron: Rising from the Last War",
  DRAGONLANCE: "Dragonlance: Shadow of the Dragon Queen",
  PHB_2024: "Player's Handbook (2024)",
  DMG_2024: "Dungeon Master's Guide (2024)",
  MM_2024: "Monster Manual (2024)",
  OGA: "One Grung Above",
  LR: "Locathah Rising"
} as const;

export const armorTranslations = {
  PADDED: "",
  LEATHER: "",
  STUDDED_LEATHER: " ",
  HIDE: "",
  CHAIN_SHIRT: " ",
  SCALE_MAIL: "",
  BREASTPLATE: "",
  HALF_PLATE: "",
  RING_MAIL: "",
  CHAIN_MAIL: "",
  SPLINT: "",
  PLATE: "",
  SHIELD: "",
  HOMEBREW: ""
} as const;

export const armorTranslationsEng = {
  PADDED: "Padded",
  LEATHER: "Leather",
  STUDDED_LEATHER: "Studded Leather",
  HIDE: "Hide",
  CHAIN_SHIRT: "Chain Shirt",
  SCALE_MAIL: "Scale Mail",
  BREASTPLATE: "Breastplate",
  HALF_PLATE: "Half Plate",
  RING_MAIL: "Ring Mail",
  CHAIN_MAIL: "Chain Mail",
  SPLINT: "Splint",
  PLATE: "Plate",
  SHIELD: "Shield",
  HOMEBREW: "Homebrew"
} as const;

export const weaponTranslations = {
  CLUB: "",
  DAGGER: "",
  GREATCLUB: " ",
  HANDAXE: " ",
  JAVELIN: " ",
  LIGHT_HAMMER: " ",
  MACE: "",
  QUARTERSTAFF: " ",
  SICKLE: "",
  SPEAR: "",
  UNARMED_STRIKE: " ",
  LIGHT_CROSSBOW: " ",
  DART: "",
  SHORTBOW: " ",
  SLING: "",
  BATTLEAXE: " ",
  FLAIL: " ",
  GLAIVE: "",
  GREATAXE: " ",
  GREATSWORD: " ",
  HALBERD: "",
  LANCE: "",
  LONGSWORD: " ",
  MAUL: " ",
  MORNINGSTAR: "",
  PIKE: "",
  RAPIER: "",
  SCIMITAR: "",
  SHORTSWORD: " ",
  TRIDENT: "",
  WAR_PICK: "",
  WARHAMMER: " ",
  WHIP: "",
  BLOWGUN: " ",
  HAND_CROSSBOW: " ",
  HEAVY_CROSSBOW: " ",
  LONGBOW: " ",
  NET: "",
  HOMEBREW: "",

  // Renaissance Firearms
  PISTOL_RENAISSANCE: " ()",
  MUSKET: "",

  // Modern Firearms
  PISTOL_AUTOMATIC: " ",
  REVOLVER: "",
  RIFLE_HUNTING: " ",
  RIFLE_AUTOMATIC: " ",
  SHOTGUN: "",

  // Futuristic Firearms
  LASER_PISTOL: " ",
  ANTIMATTER_RIFLE: " ",
  LASER_RIFLE: " "
} as const;

export const weaponTranslationsEng = {
  CLUB: "Club",
  DAGGER: "Dagger",
  GREATCLUB: "Greatclub",
  HANDAXE: "Handaxe",
  JAVELIN: "Javelin",
  LIGHT_HAMMER: "Light Hammer",
  MACE: "Mace",
  QUARTERSTAFF: "Quarterstaff",
  SICKLE: "Sickle",
  SPEAR: "Spear",
  UNARMED_STRIKE: "Unarmed Strike",
  LIGHT_CROSSBOW: "Light Crossbow",
  DART: "Dart",
  SHORTBOW: "Shortbow",
  SLING: "Sling",
  BATTLEAXE: "Battleaxe",
  FLAIL: "Flail",
  GLAIVE: "Glaive",
  GREATAXE: "Greataxe",
  GREATSWORD: "Greatsword",
  HALBERD: "Halberd",
  LANCE: "Lance",
  LONGSWORD: "Longsword",
  MAUL: "Maul",
  MORNINGSTAR: "Morningstar",
  PIKE: "Pike",
  RAPIER: "Rapier",
  SCIMITAR: "Scimitar",
  SHORTSWORD: "Shortsword",
  TRIDENT: "Trident",
  WAR_PICK: "War Pick",
  WARHAMMER: "Warhammer",
  WHIP: "Whip",
  BLOWGUN: "Blowgun",
  HAND_CROSSBOW: "Hand Crossbow",
  HEAVY_CROSSBOW: "Heavy Crossbow",
  LONGBOW: "Longbow",
  NET: "Net",
  HOMEBREW: "Homebrew",

  // Renaissance Firearms
  PISTOL_RENAISSANCE: "Pistol (Renaissance)",
  MUSKET: "Musket",

  // Modern Firearms
  PISTOL_AUTOMATIC: "Automatic Pistol",
  REVOLVER: "Revolver",
  RIFLE_HUNTING: "Hunting Rifle",
  RIFLE_AUTOMATIC: "Automatic Rifle",
  SHOTGUN: "Shotgun",

  // Futuristic Firearms
  LASER_PISTOL: "Laser Pistol",
  ANTIMATTER_RIFLE: "Antimatter Rifle",
  LASER_RIFLE: "Laser Rifle"
} as const;

export const SizeTranslations: Record<string, string> = {
  TINY: "",
  SMALL: "",
  MEDIUM: "",
  LARGE: "",
  HUGE: "",
  GARGANTUAN: "",
} as const;

export const LanguageTranslations: Record<string, string> = {
  COMMON: "",
  DWARVISH: "",
  ELVISH: "",
  GIANT: " ",
  GNOMISH: "'",
  GOBLIN: "",
  HALFLING: " ",
  ORC: "",
  ABYSSAL: " ",
  CELESTIAL: "",
  DRACONIC: "",
  DEEP_SPEECH: " ",
  INFERNAL: "",
  PRIMORDIAL: "",
  SYLVAN: "",
  UNDERCOMMON: "",
  DRUIDIC: "",
  THIEVES_CANT: " ",
  COMMON_SIGN_LANGUAGE: "  ",
  GRUNG: "",
  AQUAN: "",
  LOXODON: "",
  VEDALKEN: "",
  QUORI: "",
  LEONIN: "",
};

export const subraceTranslations = {
  DWARF_HILL_2014: " ",
  DWARF_MOUNTAIN_2014: " ",
  DWARF_DUERGAR_GRAY_SCAG: "  ()",
  ELF_HIGH_2014: " ",
  ELF_WOOD_2014: " ",
  ELF_DARK_DROW_2014: "  ()",
  ELF_ELADRIN_DMG: " (DMG)",
  ELF_ELADRIN_MPMM: " (MPMM)",
  ELF_SHADAR_KAI_MPMM: "-",
  ELF_SEA_MTOF: " ",
  ELF_PALLID_EGTW: " ",
  GNOME_FOREST_2014: " ",
  GNOME_ROCK_2014: " ",
  GNOME_DEEP_SCAG: "  ()",
  HALFLING_LIGHTFOOT_2014: " ",
  HALFLING_STOUT_2014: " ",
  HALFLING_GHOSTWISE_SCAG: " ",
  DRAGONBORN_BLACK: " ",
  DRAGONBORN_BLUE: " ",
  DRAGONBORN_BRASS: " ",
  DRAGONBORN_BRONZE: " ",
  DRAGONBORN_COPPER: " ",
  DRAGONBORN_GOLD: " ",
  DRAGONBORN_GREEN: " ",
  DRAGONBORN_RED: " ",
  DRAGONBORN_SILVER: " ",
  DRAGONBORN_WHITE: " ",
  DRAGONBORN_CHROMATIC: " ",
  DRAGONBORN_METALLIC: " ",
  DRAGONBORN_GEM: " ",
  DRAGONBORN_DRACONBLOOD: "",
  DRAGONBORN_RAVENITE: "",
  AASIMAR_PROTECTOR: "-",
  AASIMAR_SCOURGE: "-",
  AASIMAR_FALLEN: " ",
  SHIFTER_BEASTHIDE: " ",
  SHIFTER_LONGTOOTH: " ",
  SHIFTER_SWIFTSTRIDE: " ",
  SHIFTER_WILDHUNT: "  "
} as const;

export const subraceTranslationsEng = {
  DWARF_HILL_2014: "Hill Dwarf",
  DWARF_MOUNTAIN_2014: "Mountain Dwarf",
  DWARF_DUERGAR_GRAY_SCAG: "Gray Dwarf (Duergar)",
  ELF_HIGH_2014: "High Elf",
  ELF_WOOD_2014: "Wood Elf",
  ELF_DARK_DROW_2014: "Dark Elf (Drow)",
  ELF_ELADRIN_DMG: "Eladrin (DMG)",
  ELF_ELADRIN_MPMM: "Eladrin (MPMM)",
  ELF_SHADAR_KAI_MPMM: "Shadar-Kai",
  ELF_SEA_MTOF: "Sea Elf",
  ELF_PALLID_EGTW: "Pallid Elf",
  GNOME_FOREST_2014: "Forest Gnome",
  GNOME_ROCK_2014: "Rock Gnome",
  GNOME_DEEP_SCAG: "Deep Gnome (Svirfneblin)",
  HALFLING_LIGHTFOOT_2014: "Lightfoot Halfling",
  HALFLING_STOUT_2014: "Stout Halfling",
  HALFLING_GHOSTWISE_SCAG: "Ghostwise Halfling",
  DRAGONBORN_BLACK: "Black Dragonborn",
  DRAGONBORN_BLUE: "Blue Dragonborn",
  DRAGONBORN_BRASS: "Brass Dragonborn",
  DRAGONBORN_BRONZE: "Bronze Dragonborn",
  DRAGONBORN_COPPER: "Copper Dragonborn",
  DRAGONBORN_GOLD: "Gold Dragonborn",
  DRAGONBORN_GREEN: "Green Dragonborn",
  DRAGONBORN_RED: "Red Dragonborn",
  DRAGONBORN_SILVER: "Silver Dragonborn",
  DRAGONBORN_WHITE: "White Dragonborn",
  DRAGONBORN_CHROMATIC: "Chromatic Dragonborn",
  DRAGONBORN_METALLIC: "Metallic Dragonborn",
  DRAGONBORN_GEM: "Gem Dragonborn",
  DRAGONBORN_DRACONBLOOD: "Draconblood",
  DRAGONBORN_RAVENITE: "Ravenite",
  AASIMAR_PROTECTOR: "Protector Aasimar",
  AASIMAR_SCOURGE: "Scourge Aasimar",
  AASIMAR_FALLEN: "Fallen Aasimar",
  SHIFTER_BEASTHIDE: "Beasthide Shifter",
  SHIFTER_LONGTOOTH: "Longtooth Shifter",
  SHIFTER_SWIFTSTRIDE: "Swiftstride Shifter",
  SHIFTER_WILDHUNT: "Wildhunt Shifter"
} as const;
export const featTranslations: Record<string, string> = {
  ALERT: "",
  ATHLETE: "",
  ACTOR: "",
  CHARGER: "",
  CROSSBOW_EXPERT: "  ",
  DEFENSIVE_DUELIST: " ",
  DUAL_WIELDER: "   ",
  DUNGEON_DELVER: " ",
  DURABLE: "",
  ELEMENTAL_ADEPT: " ",
  GRAPPLER: "",
  GREAT_WEAPON_MASTER: "  ",
  HEALER: "",
  HEAVILY_ARMORED: "",
  HEAVY_ARMOR_MASTER: "  ",
  INSPIRING_LEADER: " ",
  KEEN_MIND: " ",
  LIGHTLY_ARMORED: "",
  LINGUIST: "",
  LUCKY: "",
  MAGE_SLAYER: " ",
  MAGIC_INITIATE: "  ",
  MARTIAL_ADEPT: " ",
  MEDIUM_ARMOR_MASTER: "  ",
  MOBILE: "",
  MODERATELY_ARMORED: "",
  MOUNTED_COMBATANT: " ",
  OBSERVANT: "",
  POLEARM_MASTER: "  ",
  RESILIENT: "",
  RITUAL_CASTER: " ",
  SAVAGE_ATTACKER: " ",
  SENTINEL: "",
  SHARPSHOOTER: " ",
  SHIELD_MASTER: " ",
  SKILLED: "",
  SKULKER: "",
  SPELL_SNIPER: " ",
  TAVERN_BRAWLER: "  ",
  TOUGH: "",
  WAR_CASTER: " ",
  WEAPON_MASTER: " ",
  BOUNTIFUL_LUCK: " ",
  DRAGON_FEAR: " ",
  DRAGON_HIDE: " ",
  DROW_HIGH_MAGIC: "  ",
  DWARVEN_FORTITUDE: " ",
  ELVEN_ACCURACY: " ",
  FADE_AWAY: "",
  FEY_TELEPORTATION: " ",
  FLAMES_OF_PHLEGETHOS: "' ",
  INFERNAL_CONSTITUTION: " ",
  ORCISH_FURY: " ",
  PRODIGY: "",
  SECOND_CHANCE: " ",
  SQUAT_NIMBLENESS: " ",
  WOOD_ELF_MAGIC: "  ",
  ARTIFICER_INITIATE: "  ",
  CHEF: "",
  CRUSHER: "",
  ELDRITCH_ADEPT: " ",
  FEY_TOUCHED: " ",
  FIGHTING_INITIATE: "  ",
  GUNNER: "",
  METAMAGIC_ADEPT: " ",
  PIERCER: "",
  POISONER: "",
  SHADOW_TOUCHED: " ",
  SKILL_EXPERT: "  ",
  SLASHER: "",
  TELEKINETIC: "",
  TELEPATHIC: "",
  ABERRANT_DRAGONMARK: "  ",
  GIFT_OF_THE_CHROMATIC_DRAGON: "  ",
  GIFT_OF_THE_GEM_DRAGON: "  ",
  GIFT_OF_THE_METALLIC_DRAGON: "  ",
  STRIKE_OF_THE_GIANTS: " ",
  EMBER_OF_GIANTS: " ",
  FURY_OF_GIANTS: " ",
  GUILE_OF_GIANTS: " ",
  KEENNESS_OF_GIANTS: " ",
  SOUL_OF_GIANTS: " ",
  VIGOR_OF_GIANTS: " ",
};

export const toolTranslations: Record<string, string> = {
  ARTISAN_TOOLS: " ",
  DICE_SET: " ",
  DRAGONCHESS_SET: "   ",
  PLAYING_CARD_SET: "  ",
  THREE_DRAGON_ANTE_SET: "   ",
  GAMING_SET: " ",
  MUSICAL_INSTRUMENT: " ",
  DISGUISE_KIT: "  ",
  FORGERY_KIT: " ",
  HERBALISM_KIT: " ",
  NAVIGATORS_TOOLS: " ",
  POISONERS_KIT: " ",
  THIEVES_TOOLS: " ",
  JEWELERS_TOOLS: " ",
  FISHING_TACKLE: " ",
  CARTOGRAPHERS_TOOLS: " ",
  VEHICLES_LAND: " ",
  VEHICLES_WATER: " ",
};

export const armorTypeTranslations: Record<string, string> = {
  LIGHT: " ",
  MEDIUM: " ",
  HEAVY: " ",
  SHIELD: "",
};

export const weaponTypeTranslations: Record<string, string> = {
  SIMPLE_WEAPON: " ",
  MARTIAL_WEAPON: " ",
  FIREARMS: " ",
};

export const equipmentCategoryTranslations: Record<string, string> = {
  BURGLARS_PACK: " ",
  DIPLOMATS_PACK: " ",
  DUNGEONEERS_PACK: " ",
  ENTERTAINERS_PACK: " ",
  EXPLORERS_PACK: " ",
  PRIESTS_PACK: " ",
  SCHOLARS_PACK: " ",
  COMPONENT_POUCH: " ",
  SPELLBOOK: " ",
  HOMEBREW: "",
};

export const weaponPropertyTranslations: Record<string, string> = {
  AMMUNITION: "",
  FINESSE: "",
  HEAVY: "",
  LIGHT: "",
  LOADING: "",
  RANGE: "",
  REACH: "",
  SPECIAL: "",
  THROWN: "",
  TWO_HANDED: "",
  VERSATILE: "",
  MAGIC_WEAPON: "",
  RELOAD: "",
  BURST_FIRE: "",
};

export const spellSchoolTranslations: Record<string, string> = {
  ABJURATION: "",
  CONJURATION: "",
  DIVINATION: "",
  ENCHANTMENT: "",
  EVOCATION: "",
  ILLUSION: "",
  NECROMANCY: "",
  TRANSMUTATION: "",
};

export const abilityTranslations: Record<string, string> = {
  STR: "",
  DEX: "",
  CON: "",
  INT: "",
  WIS: "",
  CHA: "",
};

export const skillTranslations: Record<string, string> = {
  ACROBATICS: "",
  ANIMAL_HANDLING: "  ",
  ARCANA: "",
  ATHLETICS: "",
  DECEPTION: "",
  HISTORY: "",
  INSIGHT: " ",
  INTIMIDATION: "",
  INVESTIGATION: "",
  MEDICINE: "",
  NATURE: "",
  PERCEPTION: "",
  PERFORMANCE: "",
  PERSUASION: "",
  RELIGION: "",
  SLEIGHT_OF_HAND: " ",
  STEALTH: "",
  SURVIVAL: "",
};

export const expertiseTranslations: Record<Skills, string> = {
  ACROBATICS: "",
  ANIMAL_HANDLING: " ",
  ARCANA: "",
  ATHLETICS: "",
  DECEPTION: "",
  HISTORY: "",
  INSIGHT: "",
  INTIMIDATION: "",
  INVESTIGATION: "",
  MEDICINE: "",
  NATURE: "",
  PERCEPTION: "",
  PERFORMANCE: "",
  PERSUASION: "",
  RELIGION: "",
  SLEIGHT_OF_HAND: " ",
  STEALTH: "",
  SURVIVAL: "",
};

export const damageTypeTranslations: Record<string, string> = {
  ACID: "",
  BLUDGEONING: "",
  COLD: "",
  FIRE: "",
  FORCE: "",
  LIGHTNING: "",
  NECROTIC: "",
  PIERCING: "",
  POISON: "",
  PSYCHIC: "",
  RADIANT: "",
  SLASHING: "",
  THUNDER: "",
};

// Rest system translations
export const restTranslations = {
  rest: "",
  shortRest: " ",
  longRest: " ",
  hitDice: "-",
  restoreHp: " HP",
  confirm: "",
  cancel: "",
  currentHp: " HP",
  maxHp: ". HP",
  hpRestored: " HP",
  featuresRestored: " ",
  spellSlotsRestored: "  ",
  selectHitDice: " -  ",
  available: "",
  perDie: " ",
  takingShortRest: " ...",
  takingLongRest: " ...",
  shortRestComplete: "  ",
  longRestComplete: "  ",
  confirmLongRest: "  ?",
  longRestDescription: "  HP,  -,    ",
  noHitDiceAvailable: "  -",
} as const;

// Bonus modification translations
export const bonusTranslations = {
  modifyTitle: "",
  statBonus: "  ",
  modifierBonus: "  ",
  saveBonus: "  ",
  skillBonus: "  ",
  hpBonus: "  . HP",
  acBonus: "  AC",
  speedBonus: "  ",
  proficiencyBonus: "  ",
  initiativeBonus: "  ",
  spellAttackBonus: "   ",
  spellDCBonus: "  DC ",
  baseValue: "",
  finalValue: "",
  currentBonus: " ",
  save: "OK",
  cancel: "",
  saving: "...",
  noBonus: " ",
  // Stat names
  statNames: {
    STR: "",
    DEX: "",
    CON: "",
    INT: "",
    WIS: "",
    CHA: "",
  },
  // Simple field names
  fieldNames: {
    hp: "- (HP)",
    ac: "  (AC)",
    speed: "",
    proficiency: " ",
    initiative: "",
    spellAttack: " ",
    spellDC: "  ",
  },
  proficiencyLevel: " ",
  proficiencies: {
    NONE: "",
    PROFICIENT: "",
    EXPERTISE: "",
  },
  saveProficiency: "  ",
} as const;
</file>

<file path="prisma.config.ts">
import { defineConfig } from "prisma/config";
import * as dotenv from 'dotenv';

dotenv.config();

if (!process.env.DATABASE_URL) {
  throw new Error("DATABASE_URL is not defined in .env file!");
}

export default defineConfig({
  schema: "./prisma", //  "prisma/schema"  multi-file
  datasource: {
    url: process.env.DATABASE_URL!,
    shadowDatabaseUrl: process.env.SHADOW_DATABASE_URL,
  },
  migrations: {
    seed: 'tsx prisma/seed.ts',
  },
});
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "noImplicitAny": false,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    "src/lib/types/prisma-json.d.ts"
  ],
  "exclude": [
    "node_modules", 
    "prisma/seed/toFuture",
    "node_modules/.prisma/**"
  ]
}
</file>

<file path="prisma/seed/classSeed.ts">
import {
    Ability,
    ArmorType,
    Classes,
    Prisma,
    PrismaClient,
    Skills,
    SpellcastingType,
    ToolCategory,
    WeaponCategory,
    WeaponType
} from "@prisma/client";
import ClassCreateInput = Prisma.ClassCreateInput;

export const seedClasses = async (prisma: PrismaClient) => {
    console.log(' ...')

    const classes: ClassCreateInput[] = [
        {
            name: Classes.FIGHTER_2014,
            sortOrder: 5,
            hitDie: 10,
            spellcastingType: SpellcastingType.NONE,
            abilityScoreUpLevels: [4, 6, 8, 12, 14, 16, 19],
            subclassLevel: 3,
            multiclassReqs: {
                choice: ['STR', 'DEX'],
                score: 13,
            },

            armorProficiencies: [ArmorType.HEAVY, ArmorType.MEDIUM, ArmorType.LIGHT, ArmorType.SHIELD],
            weaponProficiencies: [WeaponType.SIMPLE_WEAPON, WeaponType.MARTIAL_WEAPON],
            savingThrows: [Ability.STR, Ability.CON],
            skillProficiencies: {
                options: [
                    Skills.ANIMAL_HANDLING,
                    Skills.ACROBATICS,
                    Skills.ATHLETICS,
                    Skills.HISTORY,
                    Skills.INSIGHT,
                    Skills.INTIMIDATION,
                    Skills.PERCEPTION,
                    Skills.SURVIVAL
                ],
                choiceCount: 2
            },

            features: {
                create: [
                    {
                        feature: { connect: { engName: "Second Wind" } },
                        levelGranted: 1,
                    },
                    {
                        feature: { connect: { engName: "Action Surge" } },
                        levelGranted: 2,
                    },
                    {
                        feature: { connect: { engName: "Extra Attack" } },
                        levelGranted: 5,
                    },
                    {
                        feature: { connect: { engName: "Indomitable" } },
                        levelGranted: 9,
                    },
                ],
            }
        },
        {
            name: Classes.BARBARIAN_2014,
            sortOrder: 1,
            hitDie: 12,
            abilityScoreUpLevels: [4, 8, 12, 16, 19],
            subclassLevel: 3,
            multiclassReqs: {
                required: ['STR'],
                score: 13,
            },

            armorProficiencies: [ArmorType.LIGHT, ArmorType.MEDIUM, ArmorType.SHIELD],
            weaponProficiencies: [WeaponType.SIMPLE_WEAPON, WeaponType.MARTIAL_WEAPON],
            savingThrows: [Ability.STR, Ability.CON],
            skillProficiencies: {
                options: [
                    Skills.ANIMAL_HANDLING,
                    Skills.ATHLETICS,
                    Skills.INTIMIDATION,
                    Skills.NATURE,
                    Skills.PERCEPTION,
                    Skills.SURVIVAL
                ],
                choiceCount: 2
            },

            features: {
                create: [
                    {
                        feature: { connect: { engName: "Rage" } },
                        levelGranted: 1,
                    },
                    {
                        feature: { connect: { engName: "Unarmored Defense" } },
                        levelGranted: 1,
                    },
                    {
                        feature: { connect: { engName: "Reckless Attack" } },
                        levelGranted: 2,
                    },
                    {
                        feature: { connect: { engName: "Danger Sense" } },
                        levelGranted: 2,
                    },
                    {
                        feature: { connect: { engName: "Barbarian Extra Attack" } },
                        levelGranted: 5,
                    },
                    {
                        feature: { connect: { engName: "Fast Movement" } },
                        levelGranted: 5,
                    },
                    {
                        feature: { connect: { engName: "Feral Instinct" } },
                        levelGranted: 7,
                    },
                    {
                        feature: { connect: { engName: "Brutal Critical" } },
                        levelGranted: 9,
                    },
                    {
                        feature: { connect: { engName: "Relentless Rage" } },
                        levelGranted: 11,
                    },
                    {
                        feature: { connect: { engName: "Persistent Rage" } },
                        levelGranted: 15,
                    },
                    {
                        feature: { connect: { engName: "Indomitable Might" } },
                        levelGranted: 18,
                    },
                    {
                        feature: { connect: { engName: "Primal Champion" } },
                        levelGranted: 20,
                    },
                ],
            }
        },
        // BARD CLASS
        {
            name: Classes.BARD_2014,
            sortOrder: 2,
            hitDie: 8,
            primaryCastingStat: Ability.CHA,
            spellcastingType: SpellcastingType.FULL,
            abilityScoreUpLevels: [4, 8, 12, 16, 19],
            subclassLevel: 3,
            multiclassReqs: {
                required: ['CHA'],
                score: 13,
            },
            armorProficiencies: [ArmorType.LIGHT],
            weaponProficiencies: [WeaponType.SIMPLE_WEAPON],
            weaponProficienciesSpecial: {
                specific: [
                    WeaponCategory.HAND_CROSSBOW,
                    WeaponCategory.LONGSWORD,
                    WeaponCategory.RAPIER,
                    WeaponCategory.SHORTSWORD
                ]
            },
            savingThrows: [Ability.DEX, Ability.CHA],
            skillProficiencies: {
                options: Object.values(Skills), // Any 3 skills
                choiceCount: 3
            },
            toolProficiencies: [],
            toolToChooseCount: 3, // Three musical instruments
            features: {
                create: [
                    { feature: { connect: { engName: "Spellcasting (Bard)" } }, levelGranted: 1 },
                    { feature: { connect: { engName: "Bardic Inspiration" } }, levelGranted: 1 },
                    { feature: { connect: { engName: "Jack of All Trades" } }, levelGranted: 2 },
                    { feature: { connect: { engName: "Song of Rest" } }, levelGranted: 2 },
                    { feature: { connect: { engName: "Expertise (Bard)" } }, levelGranted: 3 },
                    { feature: { connect: { engName: "Font of Inspiration" } }, levelGranted: 5 },
                    { feature: { connect: { engName: "Countercharm" } }, levelGranted: 6 },
                    { feature: { connect: { engName: "Magical Secrets" } }, levelGranted: 10 },
                    { feature: { connect: { engName: "Superior Inspiration" } }, levelGranted: 20 },
                ]
            }
        },
        // CLERIC CLASS
        {
            name: Classes.CLERIC_2014,
            sortOrder: 3,
            hitDie: 8,
            primaryCastingStat: Ability.WIS,
            spellcastingType: SpellcastingType.FULL,
            abilityScoreUpLevels: [4, 8, 12, 16, 19],
            subclassLevel: 1, // Devine Domain at 1st level
            multiclassReqs: {
                required: ['WIS'],
                score: 13,
            },
            armorProficiencies: [ArmorType.LIGHT, ArmorType.MEDIUM, ArmorType.SHIELD],
            weaponProficiencies: [WeaponType.SIMPLE_WEAPON],
            savingThrows: [Ability.WIS, Ability.CHA],
            skillProficiencies: {
                options: [
                    Skills.HISTORY,
                    Skills.INSIGHT,
                    Skills.MEDICINE,
                    Skills.PERSUASION,
                    Skills.RELIGION
                ],
                choiceCount: 2
            },
            features: {
                create: [
                    { feature: { connect: { engName: "Spellcasting (Cleric)" } }, levelGranted: 1 },
                    { feature: { connect: { engName: "Divine Domain" } }, levelGranted: 1 },
                    { feature: { connect: { engName: "Channel Divinity (Cleric)" } }, levelGranted: 2 },
                    { feature: { connect: { engName: "Destroy Undead" } }, levelGranted: 5 },
                    { feature: { connect: { engName: "Divine Intervention" } }, levelGranted: 10 },
                ]
            }
        },
        // DRUID CLASS
        {
            name: Classes.DRUID_2014,
            sortOrder: 4,
            hitDie: 8,
            primaryCastingStat: Ability.WIS,
            spellcastingType: SpellcastingType.FULL,
            abilityScoreUpLevels: [4, 8, 12, 16, 19],
            subclassLevel: 2,
            multiclassReqs: {
                required: ['WIS'],
                score: 13,
            },
            armorProficiencies: [ArmorType.LIGHT, ArmorType.MEDIUM, ArmorType.SHIELD],
            weaponProficiencies: [],
            weaponProficienciesSpecial: {
                specific: [
                    WeaponCategory.CLUB,
                    WeaponCategory.DAGGER,
                    WeaponCategory.DART,
                    WeaponCategory.JAVELIN,
                    WeaponCategory.MACE,
                    WeaponCategory.QUARTERSTAFF,
                    WeaponCategory.SCIMITAR,
                    WeaponCategory.SICKLE,
                    WeaponCategory.SLING,
                    WeaponCategory.SPEAR
                ]
            },
            savingThrows: [Ability.INT, Ability.WIS],
            skillProficiencies: {
                options: [
                    Skills.ARCANA,
                    Skills.ANIMAL_HANDLING,
                    Skills.INSIGHT,
                    Skills.MEDICINE,
                    Skills.NATURE,
                    Skills.PERCEPTION,
                    Skills.RELIGION,
                    Skills.SURVIVAL
                ],
                choiceCount: 2
            },
            toolProficiencies: [ToolCategory.HERBALISM_KIT],
            features: {
                create: [
                    { feature: { connect: { engName: "Druidic" } }, levelGranted: 1 },
                    { feature: { connect: { engName: "Spellcasting (Druid)" } }, levelGranted: 1 },
                    { feature: { connect: { engName: "Wild Shape" } }, levelGranted: 2 },
                    { feature: { connect: { engName: "Druid Circle" } }, levelGranted: 2 },
                    { feature: { connect: { engName: "Timeless Body (Druid)" } }, levelGranted: 18 },
                    { feature: { connect: { engName: "Beast Spells" } }, levelGranted: 18 },
                    { feature: { connect: { engName: "Archdruid" } }, levelGranted: 20 },
                ]
            }
        },
        //  
        {
            name: Classes.MONK_2014,
            sortOrder: 6,
            hitDie: 8,
            abilityScoreUpLevels: [4, 8, 12, 16, 19],
            subclassLevel: 3,
            multiclassReqs: {
                required: ['DEX', 'WIS'], //  required!
                score: 13,
            },

            armorProficiencies: [], //  ! 
            weaponProficiencies: [WeaponType.SIMPLE_WEAPON], // + shortswords 
            weaponProficienciesSpecial: {
                specific: [WeaponCategory.SHORTSWORD]
            }, //   
            savingThrows: [Ability.STR, Ability.DEX],
            skillProficiencies: {
                options: [
                    Skills.ACROBATICS,
                    Skills.ATHLETICS,
                    Skills.HISTORY,
                    Skills.INSIGHT,
                    Skills.RELIGION,
                    Skills.STEALTH
                ],
                choiceCount: 2
            },
            toolProficiencies: [],
            toolToChooseCount: 1, //  musical instrument  artisan's tools

            features: {
                create: [
                    {
                        feature: { connect: { engName: "Unarmored Defense (Monk)" } },
                        levelGranted: 1,
                    },
                    {
                        feature: { connect: { engName: "Martial Arts" } },
                        levelGranted: 1,
                    },
                    {
                        feature: { connect: { engName: "Ki" } },
                        levelGranted: 2,
                    },
                    {
                        feature: { connect: { engName: "Unarmored Movement" } },
                        levelGranted: 2,
                    },
                    {
                        feature: { connect: { engName: "Deflect Missiles" } },
                        levelGranted: 3,
                    },
                    {
                        feature: { connect: { engName: "Slow Fall" } },
                        levelGranted: 4,
                    },
                    {
                        feature: { connect: { engName: "Extra Attack (Monk)" } },
                        levelGranted: 5,
                    },
                    {
                        feature: { connect: { engName: "Stunning Strike" } },
                        levelGranted: 5,
                    },
                    {
                        feature: { connect: { engName: "Ki-Empowered Strikes" } },
                        levelGranted: 6,
                    },
                    {
                        feature: { connect: { engName: "Evasion" } },
                        levelGranted: 7,
                    },
                    {
                        feature: { connect: { engName: "Stillness of Mind" } },
                        levelGranted: 7,
                    },
                    {
                        feature: { connect: { engName: "Unarmored Movement (Vertical)" } },
                        levelGranted: 9,
                    },
                    {
                        feature: { connect: { engName: "Purity of Body" } },
                        levelGranted: 10,
                    },
                    {
                        feature: { connect: { engName: "Tongue of the Sun and Moon" } },
                        levelGranted: 13,
                    },
                    {
                        feature: { connect: { engName: "Diamond Soul" } },
                        levelGranted: 14,
                    },
                    {
                        feature: { connect: { engName: "Timeless Body" } },
                        levelGranted: 15,
                    },
                    {
                        feature: { connect: { engName: "Empty Body" } },
                        levelGranted: 18,
                    },
                    {
                        feature: { connect: { engName: "Perfect Self" } },
                        levelGranted: 20,
                    },
                ],
            }
        },

        // RANGER CLASS
        {
            name: Classes.RANGER_2014,
            sortOrder: 8,
            hitDie: 10,
            primaryCastingStat: 'WIS',
            spellcastingType: SpellcastingType.HALF, //  
            abilityScoreUpLevels: [4, 8, 12, 16, 19],
            subclassLevel: 3,
            multiclassReqs: {
                required: ['DEX', 'WIS'], //  DEX  WIS   13+
                score: 13,
            },

            armorProficiencies: [ArmorType.LIGHT, ArmorType.MEDIUM, ArmorType.SHIELD],
            weaponProficiencies: [WeaponType.SIMPLE_WEAPON, WeaponType.MARTIAL_WEAPON],
            savingThrows: [Ability.STR, Ability.DEX],
            skillProficiencies: {
                options: [
                    Skills.ANIMAL_HANDLING,
                    Skills.ATHLETICS,
                    Skills.INSIGHT,
                    Skills.INVESTIGATION,
                    Skills.NATURE,
                    Skills.PERCEPTION,
                    Skills.STEALTH,
                    Skills.SURVIVAL
                ],
                choiceCount: 3 //  3 
            },

            features: {
                create: [
                    {
                        feature: { connect: { engName: "Spellcasting (Ranger)" } },
                        levelGranted: 2,
                    },
                    {
                        feature: { connect: { engName: "Extra Attack (Ranger)" } },
                        levelGranted: 5,
                    },
                    {
                        feature: { connect: { engName: "Land\'s Stride" } },
                        levelGranted: 8,
                    },
                    {
                        feature: { connect: { engName: "Vanish" } },
                        levelGranted: 14,
                    },
                    {
                        feature: { connect: { engName: "Feral Senses" } },
                        levelGranted: 18,
                    },
                    {
                        feature: { connect: { engName: "Foe Slayer" } },
                        levelGranted: 20,
                    },
                ],
            }
        },

        //  seedClasses :

        {
            name: Classes.PALADIN_2014,
            sortOrder: 7,
            hitDie: 10,
            primaryCastingStat: 'CHA',
            spellcastingType: SpellcastingType.HALF, //   
            abilityScoreUpLevels: [4, 8, 12, 16, 19],
            subclassLevel: 3,
            multiclassReqs: {
                required: ['STR', 'CHA'], //  STR  CHA   13+
                score: 13,
            },

            armorProficiencies: [
                ArmorType.LIGHT,
                ArmorType.MEDIUM,
                ArmorType.HEAVY,
                ArmorType.SHIELD
            ],
            weaponProficiencies: [
                WeaponType.SIMPLE_WEAPON,
                WeaponType.MARTIAL_WEAPON
            ],
            savingThrows: [Ability.WIS, Ability.CHA],
            skillProficiencies: {
                options: [
                    Skills.ATHLETICS,
                    Skills.INSIGHT,
                    Skills.INTIMIDATION,
                    Skills.MEDICINE,
                    Skills.PERSUASION,
                    Skills.RELIGION
                ],
                choiceCount: 2 //  2 
            },

            features: {
                create: [
                    { feature: { connect: { engName: "Divine Sense" } }, levelGranted: 1 },
                    { feature: { connect: { engName: "Lay on Hands" } }, levelGranted: 1 },
                    { feature: { connect: { engName: "Fighting Style" } }, levelGranted: 2 },
                    { feature: { connect: { engName: "Spellcasting (Paladin)" } }, levelGranted: 2 },
                    { feature: { connect: { engName: "Divine Smite" } }, levelGranted: 2 },
                    { feature: { connect: { engName: "Divine Health" } }, levelGranted: 3 },
                    { feature: { connect: { engName: "Sacred Oath" } }, levelGranted: 3 },
                    { feature: { connect: { engName: "Channel Divinity" } }, levelGranted: 3 },
                    { feature: { connect: { engName: "Oath Spells" } }, levelGranted: 3 },
                    { feature: { connect: { engName: "Ability Score Improvement" } }, levelGranted: 4 },
                    { feature: { connect: { engName: "Extra Attack (Paladin)" } }, levelGranted: 5 },
                    { feature: { connect: { engName: "Aura of Protection" } }, levelGranted: 6 },
                    { feature: { connect: { engName: "Ability Score Improvement" } }, levelGranted: 8 },
                    { feature: { connect: { engName: "Aura of Courage" } }, levelGranted: 10 },
                    { feature: { connect: { engName: "Improved Divine Smite" } }, levelGranted: 11 },
                    { feature: { connect: { engName: "Ability Score Improvement" } }, levelGranted: 12 },
                    { feature: { connect: { engName: "Cleansing Touch" } }, levelGranted: 14 },
                    { feature: { connect: { engName: "Ability Score Improvement" } }, levelGranted: 16 },
                    { feature: { connect: { engName: "Aura Improvements" } }, levelGranted: 18 },
                    { feature: { connect: { engName: "Ability Score Improvement" } }, levelGranted: 19 },
                ],
            }
        },

        //  seedClasses :

        {
            name: Classes.ROGUE_2014,
            sortOrder: 9,
            hitDie: 8,
            spellcastingType: SpellcastingType.NONE,
            abilityScoreUpLevels: [4, 8, 10, 12, 16, 19], //  : Rogue  ASI  10 !
            subclassLevel: 3,
            multiclassReqs: {
                required: ['DEX'],
                score: 13,
            },

            armorProficiencies: [ArmorType.LIGHT],
            weaponProficiencies: [WeaponType.SIMPLE_WEAPON],
            weaponProficienciesSpecial: {
                specific: [
                    WeaponCategory.LIGHT_CROSSBOW,
                    WeaponCategory.LONGSWORD,
                    WeaponCategory.RAPIER,
                    WeaponCategory.SHORTSWORD
                ]
            },
            savingThrows: [Ability.DEX, Ability.INT],
            skillProficiencies: {
                options: [
                    Skills.ACROBATICS,
                    Skills.ATHLETICS,
                    Skills.DECEPTION,
                    Skills.INSIGHT,
                    Skills.INTIMIDATION,
                    Skills.INVESTIGATION,
                    Skills.PERCEPTION,
                    Skills.PERFORMANCE,
                    Skills.PERSUASION,
                    Skills.SLEIGHT_OF_HAND,
                    Skills.STEALTH
                ],
                choiceCount: 4 //   4  -    !
            },
            toolProficiencies: [ToolCategory.THIEVES_TOOLS],

            features: {
                create: [
                    {
                        feature: { connect: { engName: "Expertise" } },
                        levelGranted: 1,
                    },
                    {
                        feature: { connect: { engName: "Sneak Attack" } },
                        levelGranted: 1,
                    },
                    {
                        feature: { connect: { engName: "Thieves' Cant" } },
                        levelGranted: 1,
                    },
                    {
                        feature: { connect: { engName: "Cunning Action" } },
                        levelGranted: 2,
                    },
                    {
                        feature: { connect: { engName: "Roguish Archetype" } },
                        levelGranted: 3,
                    },
                    {
                        feature: { connect: { engName: "Uncanny Dodge" } },
                        levelGranted: 5,
                    },
                    {
                        feature: { connect: { engName: "Expertise 2" } },
                        levelGranted: 6,
                    },
                    {
                        feature: { connect: { engName: "Evasion" } },
                        levelGranted: 7,
                    },
                    {
                        feature: { connect: { engName: "Reliable Talent" } },
                        levelGranted: 11,
                    },
                    {
                        feature: { connect: { engName: "Blindsense" } },
                        levelGranted: 14,
                    },
                    {
                        feature: { connect: { engName: "Slippery Mind" } },
                        levelGranted: 15,
                    },
                    {
                        feature: { connect: { engName: "Elusive" } },
                        levelGranted: 18,
                    },
                    {
                        feature: { connect: { engName: "Stroke of Luck" } },
                        levelGranted: 20,
                    },
                ],
            }
        },


        {
            name: Classes.SORCERER_2014,
            sortOrder: 10,
            hitDie: 6,
            primaryCastingStat: Ability.CHA,
            spellcastingType: SpellcastingType.FULL,
            abilityScoreUpLevels: [4, 8, 12, 16, 19],
            subclassLevel: 1,
            multiclassReqs: {
                required: ['CHA'],
                score: 13,
            },

            armorProficiencies: [],
            weaponProficiencies: [],
            weaponProficienciesSpecial: {
                specific: [
                    WeaponCategory.DAGGER,
                    WeaponCategory.DART,
                    WeaponCategory.SLING,
                    WeaponCategory.QUARTERSTAFF,
                    WeaponCategory.LIGHT_CROSSBOW,
                ]
            },
            savingThrows: [Ability.CON, Ability.CHA],
            skillProficiencies: {
                options: [
                    Skills.ARCANA,
                    Skills.DECEPTION,
                    Skills.INSIGHT,
                    Skills.INTIMIDATION,
                    Skills.PERSUASION,
                    Skills.RELIGION,
                ],
                choiceCount: 2
            },

            features: {
                create: [
                    {
                        feature: { connect: { engName: "Spellcasting (Sorcerer)" } },
                        levelGranted: 1,
                    },
                    {
                        feature: { connect: { engName: "Sorcerous Origin" } },
                        levelGranted: 1,
                    },
                    {
                        feature: { connect: { engName: "Font of Magic" } },
                        levelGranted: 2,
                    },
                    {
                        feature: { connect: { engName: "Metamagic" } },
                        levelGranted: 3,
                    },
                    {
                        feature: { connect: { engName: "Sorcerous Restoration" } },
                        levelGranted: 20,
                    },
                ],
            }
        },

        {
            name: Classes.WIZARD_2014,
            sortOrder: 12,
            hitDie: 6,
            primaryCastingStat: Ability.INT,
            spellcastingType: SpellcastingType.FULL,
            abilityScoreUpLevels: [4, 8, 12, 16, 19],
            subclassLevel: 2,
            multiclassReqs: {
                required: ['INT'],
                score: 13,
            },

            armorProficiencies: [],
            weaponProficiencies: [],
            weaponProficienciesSpecial: {
                specific: [
                    WeaponCategory.DAGGER,
                    WeaponCategory.DART,
                    WeaponCategory.SLING,
                    WeaponCategory.QUARTERSTAFF,
                    WeaponCategory.LIGHT_CROSSBOW,
                ]
            },
            savingThrows: [Ability.INT, Ability.WIS],
            skillProficiencies: {
                options: [
                    Skills.ARCANA,
                    Skills.HISTORY,
                    Skills.INSIGHT,
                    Skills.INVESTIGATION,
                    Skills.MEDICINE,
                    Skills.RELIGION,
                ],
                choiceCount: 2
            },

            features: {
                create: [
                    {
                        feature: { connect: { engName: "Spellcasting (Wizard)" } },
                        levelGranted: 1,
                    },
                    {
                        feature: { connect: { engName: "Arcane Recovery" } },
                        levelGranted: 1,
                    },
                    {
                        feature: { connect: { engName: "Arcane Tradition" } },
                        levelGranted: 2,
                    },
                    {
                        feature: { connect: { engName: "Spell Mastery" } },
                        levelGranted: 18,
                    },
                    {
                        feature: { connect: { engName: "Signature Spells" } },
                        levelGranted: 20,
                    },
                ],
            }
        },


        {
            name: Classes.WARLOCK_2014,
            sortOrder: 11,
            hitDie: 8,
            primaryCastingStat: Ability.CHA,
            spellcastingType: SpellcastingType.PACT, //   Pact Magic !
            abilityScoreUpLevels: [4, 8, 12, 16, 19],
            subclassLevel: 1, //  : Patron   1 !
            multiclassReqs: {
                required: ['CHA'],
                score: 13,
            },

            armorProficiencies: [ArmorType.LIGHT],
            weaponProficiencies: [WeaponType.SIMPLE_WEAPON],
            savingThrows: [Ability.WIS, Ability.CHA],
            skillProficiencies: {
                options: [
                    Skills.ARCANA,
                    Skills.DECEPTION,
                    Skills.HISTORY,
                    Skills.INTIMIDATION,
                    Skills.INVESTIGATION,
                    Skills.NATURE,
                    Skills.RELIGION
                ],
                choiceCount: 2 //  2 
            },

            features: {
                create: [
                    {
                        feature: { connect: { engName: "Pact Magic" } },
                        levelGranted: 1,
                        grantsSpellSlots: true,
                    },
                    {
                        feature: { connect: { engName: "Eldritch Invocations" } },
                        levelGranted: 2,
                    },
                    {
                        feature: { connect: { engName: "Pact Boon" } },
                        levelGranted: 3,
                    },
                    {
                        feature: { connect: { engName: "Mystic Arcanum (6th level)" } },
                        levelGranted: 11,
                    },
                    {
                        feature: { connect: { engName: "Mystic Arcanum (7th level)" } },
                        levelGranted: 13,
                    },
                    {
                        feature: { connect: { engName: "Mystic Arcanum (8th level)" } },
                        levelGranted: 15,
                    },
                    {
                        feature: { connect: { engName: "Mystic Arcanum (9th level)" } },
                        levelGranted: 17,
                    },
                    {
                        feature: { connect: { engName: "Eldritch Master" } },
                        levelGranted: 20,
                    },
                ],
            }
        },

        {
            name: Classes.ARTIFICER_2014,
            hitDie: 8,
            primaryCastingStat: Ability.INT,
            spellcastingType: SpellcastingType.HALF,
            abilityScoreUpLevels: [4, 8, 12, 16, 19],
            subclassLevel: 3,
            multiclassReqs: {
                required: ['INT'],
                score: 13,
            },

            armorProficiencies: [ArmorType.LIGHT, ArmorType.MEDIUM, ArmorType.SHIELD],
            weaponProficiencies: [WeaponType.SIMPLE_WEAPON],
            savingThrows: [Ability.CON, Ability.INT],
            skillProficiencies: {
                options: [
                    Skills.ARCANA,
                    Skills.HISTORY,
                    Skills.INVESTIGATION,
                    Skills.MEDICINE,
                    Skills.NATURE,
                    Skills.PERCEPTION,
                    Skills.SLEIGHT_OF_HAND
                ],
                choiceCount: 2
            },
            toolProficiencies: [ToolCategory.THIEVES_TOOLS],
            toolToChooseCount: 2, // Tinker's tools + 1 artisan's tool

            features: {
                create: [
                    {
                        feature: { connect: { engName: "Magical Tinkering" } },
                        levelGranted: 1,
                    },
                    {
                        feature: { connect: { engName: "Spellcasting (Artificer)" } },
                        levelGranted: 1,
                    },
                    {
                        feature: { connect: { engName: "Infuse Item" } },
                        levelGranted: 2,
                    },
                    {
                        feature: { connect: { engName: "The Right Tool for the Job" } },
                        levelGranted: 3,
                    },
                    {
                        feature: { connect: { engName: "Tool Expertise" } },
                        levelGranted: 6,
                    },
                    {
                        feature: { connect: { engName: "Flash of Genius" } },
                        levelGranted: 7,
                    },
                    {
                        feature: { connect: { engName: "Magic Item Adept" } },
                        levelGranted: 10,
                    },
                    {
                        feature: { connect: { engName: "Spell-Storing Item" } },
                        levelGranted: 11,
                    },
                    {
                        feature: { connect: { engName: "Magic Item Savant" } },
                        levelGranted: 14,
                    },
                    {
                        feature: { connect: { engName: "Magic Item Master" } },
                        levelGranted: 18,
                    },
                    {
                        feature: { connect: { engName: "Soul of Artifice" } },
                        levelGranted: 20,
                    },
                ],
            }
        }



    ]

    
    for (const class_ of classes) {
        const featureCreates = Array.isArray(class_.features?.create)
            ? class_.features?.create ?? []
            : class_.features?.create
                ? [class_.features.create]
                : [];

        const { features, ...classData } = class_;

        try {
            const savedClass = await prisma.class.upsert({
                where: { name: class_.name },
                update: classData,
                create: classData
            });

            for (const entry of featureCreates) {
                const engName = (entry as any)?.feature?.connect?.engName as string | undefined;
                if (!engName) continue;

                const feature = await prisma.feature.findUnique({ where: { engName } });
                if (!feature) {
                    console.warn(`Feature with engName=${engName} not found, skip linking to class ${class_.name}`);
                    continue;
                }

                const existing = await prisma.classFeature.findFirst({
                    where: { classId: savedClass.classId, featureId: feature.featureId },
                });

                const data = {
                    classId: savedClass.classId,
                    featureId: feature.featureId,
                    levelGranted: (entry as any)?.levelGranted ?? 1,
                    grantsSpellSlots: (entry as any)?.grantsSpellSlots ?? false,
                };

                if (existing) {
                    if (
                        existing.levelGranted !== data.levelGranted ||
                        existing.grantsSpellSlots !== data.grantsSpellSlots
                    ) {
                        await prisma.classFeature.update({
                            where: { classFeatureId: existing.classFeatureId },
                            data,
                        });
                    }
                } else {
                    await prisma.classFeature.create({ data });
                }
            }
        } catch (error) {
            console.error('Failed to upsert class:', class_.name);
            console.error('Class payload:', JSON.stringify(class_, null, 2));
            console.error('Error:', error);

            if (error instanceof Prisma.PrismaClientKnownRequestError) {
                console.error('Prisma Error Code:', error.code);
                console.error('Meta:', error.meta);

                if (error.code === 'P2025') {
                    console.error('Record to connect not found:', error.meta?.cause);
                }
            }
        }
    }



    console.log(`  ${classes.length} !`)
}
</file>

<file path="prisma/seed/subclassFeatureSeed.ts">
import { FeatureDisplayType, PrismaClient, RestType, Subclasses } from "@prisma/client"
import { normalizeFeatureCreateInput, type SeedFeatureCreateInput } from "./helpers/featureDisplayType"

type SubclassFeatureLink = {
  subclass: Subclasses
  feature: string
  level: number
}

export const seedSubclassFeatures = async (prisma: PrismaClient) => {
  console.log("    ...")

  const subclassSpellSlotFeatures = new Set<string>(["Spellcasting (Eldritch Knight)"])

  const features: SeedFeatureCreateInput[] = [
    // ===== Arcane Archer =====
    {
      name: " : ",
      engName: "Arcane Archer Lore",
      shortDescription:
        "        <a href=\"/spell/1050\"> [Prestidigitation]</a>  <a href=\"/spell/1341\">  [Druidcraft]</a>.",
      description:
        " 3     :           .  ,   <a href=\"/spell/1050\"> [Prestidigitation]</a>  <a href=\"/spell/1341\">  [Druidcraft]</a>   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Arcane Shot",
      shortDescription:
        "2     / ;  18    .",
      description:
        " 3          .   ,           ,        .  ,    (     ).\n\n  2            .  7, 10  15     .           .\n\n      = 8 +    +   .\n\n 18       ,     .",
      displayType: [FeatureDisplayType.CLASS_RESOURCE],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 2,
    },
    {
      name: " ",
      engName: "Magic Arrow",
      shortDescription: "         /.",
      description:
        " 7 ,         ,                .       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Curving Shot",
      shortDescription: "         60 .",
      description:
        " 7 ,          ,              60   .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Ever-Ready Shot",
      shortDescription: "     ,     .",
      description:
        " 15 ,           ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // Arcane Shot options
    {
      name: " ",
      engName: "Banishing Arrow",
      shortDescription:
        "     ;  18   26  .",
      description:
        "  ,         .        :    0,  .             .\n\n 18     26    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Beguiling Arrow",
      shortDescription:
        "+26              ;  18  +46.",
      description:
        "     26  ,       30   .    ;           .   ,          .\n\n 18     46.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Bursting Arrow",
      shortDescription: "      10   26  ;  18  46.",
      description:
        "      .        10    26  .\n\n 18    46.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Enfeebling Arrow",
      shortDescription:
        "+26               ;  18  46.",
      description:
        "   26  .    ;               ( ).\n\n 18     46.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Grasping Arrow",
      shortDescription:
        "+26  , -10  , 26     ;  18    46.",
      description:
        "   26  ,     10 ,     ,     1     ,  26  .           ()     ,    .    1         .\n\n 18     46.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Piercing Arrow",
      shortDescription:
        " 30 ,  ;      +16 ,   ;  18  +26.",
      description:
        "    .    1    30  ,    .       .     ,    ,  16  ;    .\n\n 18      26.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "-",
      engName: "Seeking Arrow",
      shortDescription:
        "  :         ,  ;     +16     ;   ,   .  18  +26.",
      description:
        "  ,     .    ,        .          ,    .     ,    ,  16  ,      .      ,   .\n\n 18     26.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Shadow Arrow",
      shortDescription:
        "+26            5     ;  18  46.",
      description:
        "   26      .               5   .\n\n 18     46.",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Battle Master =====
    {
      name: " ",
      engName: "Combat Superiority",
      shortDescription:
        "4   (d8), ,  8 +  + /;    / .",
      description:
        " 3           .       .  7, 10  15      ;         .\n\n  4   d8.  ,    ,       .      7  (5 )   15  (6 ).\n\n     :  = 8 +    +      ( ).\n\n 10     d10,  18  d12.",
      displayType: [FeatureDisplayType.CLASS_RESOURCE],
      limitedUsesPer: RestType.SHORT_REST,
    },
    {
      name: " ",
      engName: "Student of War",
      shortDescription: "      .",
      description:
        " 3           ,     ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Know Your Enemy",
      shortDescription:
        "         (,  ).",
      description:
        " 7 ,            1 ,  ,    ,          :  , , ;  ;  ;     ( );   ( ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Improved Combat Superiority",
      shortDescription: "   d10,   18   d12.",
      description: " 10      d10.  18    d12.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "",
      engName: "Relentless (Battle Master)",
      shortDescription: "   ,     .",
      description:
        " 15 ,          ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // Battle Master maneuvers
    {
      name: "",
      engName: "Ambush",
      shortDescription: "      ()  .",
      description:
        "     ()   ,           (  ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Bait and Switch",
      shortDescription:
        "     5 ,            .",
      description:
        "     5      ,         ,   5   (      ).      .   :          ( )    ,  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "",
      engName: "Brace",
      shortDescription: "  ,     ,    .",
      description:
        " ,   ,       ,           .       .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Commander's Strike",
      shortDescription: "    ,    .",
      description:
        "    ,           ,     , .    ,       ,    .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Commanding Presence",
      shortDescription: "     (//).",
      description:
        "    (), ()  (),          .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Disarming Attack",
      shortDescription: "         ( ).",
      description:
        "    ,    ,    .    ,     .      ,  ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Distracting Strike",
      shortDescription:
        "   ,     ( )      .",
      description:
        "    ,    ,   .    ,                 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Evasive Footwork",
      shortDescription: "         .",
      description:
        "  ,    ,       ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Feinting Attack",
      shortDescription:
        "     5 ,            .",
      description:
        "     ,      5 .           ;      .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Goading Attack",
      shortDescription:
        "   ;             .",
      description:
        "    ,    ,   .    ,     .         -,  ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Grappling Strike",
      shortDescription:
        "       ,      ().",
      description:
        "                  (  PHB).       ().",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: "  ",
      engName: "Lunging Attack",
      shortDescription: "    5 ,    .",
      description:
        "        ,    ,       5 .      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Maneuvering Attack",
      shortDescription:
        "   ,            .",
      description:
        "    ,    ,   .       ,     .               .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Menacing Attack",
      shortDescription:
        "   ;          .",
      description:
        "    ,    ,    .    ,     .          .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "",
      engName: "Parry",
      shortDescription:
        "        +  .",
      description:
        "       ,      ,      +   .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Precision Attack",
      shortDescription: "     (   ,   ).",
      description:
        "      ,         .      ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Pushing Attack",
      shortDescription:
        "   ;         ,     15 .",
      description:
        "    ,    ,    .    ,      ,    .       15   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Quick Toss",
      shortDescription: "      ,    .",
      description:
        "     ,        .        .      .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: "",
      engName: "Rally",
      shortDescription: "      =   +  .",
      description:
        "       ,  ,     .    ,    +   .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: "",
      engName: "Riposte",
      shortDescription: "           .",
      description:
        "      ,      ,             .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Sweeping Attack",
      shortDescription:
        "   ,      ,     .",
      description:
        "     ,    ,       5        .     ,    ,   ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Tactical Assessment",
      shortDescription: "     (/)   ( ).",
      description:
        "    (  )   ( ),          .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "",
      engName: "Trip Attack",
      shortDescription:
        "   ;         ,  .",
      description:
        "    ,    ,   .    ,      ,    .    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Cavalier =====
    {
      name: "  ()",
      engName: "Bonus Proficiency (Cavalier)",
      shortDescription:
        "         (  ).",
      description:
        " 3      :   . ,   ,  ,      (,   ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Born to the Saddle",
      shortDescription:
        "/  5  ;    10    ;       .",
      description:
        " 3          5  ,      10      ,   .  ,     ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Unwavering Mark",
      shortDescription:
        "   ;      ,            .",
      description:
        "         ,        .         -,  .       ,    5   ,         .      ,      ( ).      ,     ( 1);      .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: false,
    },
    {
      name: " ",
      engName: "Warding Maneuver",
      shortDescription:
        "  18      ;      18. : 2 +    .",
      description:
        " 7 ,       5    ,     18      .     ,       (18).     2        .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
    },
    {
      name: " ",
      engName: "Hold the Line",
      shortDescription:
        "   ,    ;     0  .",
      description:
        " 10  ,      ,   .     ,    0    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Ferocious Charger",
      shortDescription:
        "  10           ( ).",
      description:
        " 15 ,       10     ,         ( 8 +  +  ).    .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Vigilant Defender",
      shortDescription:
        "            ,     .",
      description:
        " 18      :                (     ).   1     ,         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Champion =====
    {
      name: "  ",
      engName: "Improved Critical (Champion)",
      shortDescription: "     1920.",
      description: " 3          19  20  d20.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Remarkable Athlete",
      shortDescription:
        "     //  ;   .",
      description:
        " 7       (. )  -  ,   ,       .  ,        ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Additional Fighting Style (Champion)",
      shortDescription: " 10        ( ,   ).",
      description:
        " 10          .     ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Superior Critical",
      shortDescription: "     1820.",
      description: " 15          1820  d20.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "",
      engName: "Survivor",
      shortDescription:
        "  ,      >0,   = 5 +  .",
      description:
        " 18      ,            0 ,   5  +   .  ,    0 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Banneret =====
    {
      name: " ",
      engName: "Rallying Cry",
      shortDescription:
        "     3   60 ,    =   .",
      description:
        " 3 ,     ,        60 ,   /.   ,    ,  ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Royal Envoy",
      shortDescription:
        "  (  ),    /  ;    .",
      description:
        " 7      .   ,           .  ,     (. )     ,      .\n\n           .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Inspiring Surge",
      shortDescription:
        "   ,  (   18 )   60     .",
      description:
        " 10 ,     ,      60 ,   /.        .  18       (       ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "",
      engName: "Bulwark (Banneret)",
      shortDescription:
        "     //,   60       .",
      description:
        " 15 ,       ,       ,       60 ,   /.           ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Echo Knight =====
    {
      name: " ",
      engName: "Manifest Echo",
      shortDescription:
        "      15 ;       .",
      description:
        " 3            15 ,    ,   30    .        30 .    ,     ;         .         .    5   ,   ,  ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Unleash Incarnation",
      shortDescription:
        "   ,       .  =    .",
      description:
        "  3 ,     ,         .      ;     .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: " ",
      engName: "Echo Avatar",
      shortDescription:
        "        1000 ,      .",
      description:
        " 7          10 ,        ,          .          1000        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Shadow Martyr",
      shortDescription:
        "            ; 1/.",
      description:
        " 10 ,  ,   ,     30 ,          5         .    ,  .        .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Reclaim Potential",
      shortDescription:
        "   ,     26 +   (1/).",
      description:
        " 15 ,      30   ,      ,  26 +   .        .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Legion of One",
      shortDescription:
        "  2 ; Unleash Incarnation  2 ;      .",
      description:
        " 18 ,    ,    ,    ,  . Unleash Incarnation       .        Unleash Incarnation,  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Eldritch Knight =====
    {
      name: "  ",
      engName: "Spellcasting (Eldritch Knight)",
      shortDescription: "    (),      /.",
      description:
        " 3      ,          ( = 8 +  + . ,    =  + . ).   2   2 ;          .     ,     3-,     -  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Weapon Bond",
      shortDescription: "    :          .",
      description:
        " 3     1- ,       .   ,    ,    ,              .      ;    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "War Magic",
      shortDescription: "       .",
      description: " 7 ,      ,       .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Eldritch Strike",
      shortDescription:
        "                 .",
      description:
        " 10 ,       ,        ,          .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Arcane Charge",
      shortDescription: "   ,    30      .",
      description:
        " 15 ,     ,     30    ,  ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Improved War Magic",
      shortDescription: "  -         .",
      description:
        " 18 ,     ,       .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },

    // ===== Psi Warrior =====
    {
      name: "-",
      engName: "Psionic Power",
      shortDescription: "- (d6  d8/d10/d12)   2; :  , -,  .",
      description:
        " 3     -:       ,  d6.     d8  5 , d10  11, d12  17.           (. )  .   1   -,   .\n\n:\n  :   ,  ,    30 ,  ,  ,      +    (. 1).\n -:      ,     ,   +  .\n  :   ,      ( )   30     (  30   ).",
      displayType: [FeatureDisplayType.CLASS_RESOURCE],
      limitedUsesPer: RestType.LONG_REST,
    },
    {
      name: " ",
      engName: "Telekinetic Adept",
      shortDescription:
        " - (   )     - ( , /).",
      description:
        " 7    :\n -.     -,        ,     .\n  .     -,      .        10 ,   ( ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Guarded Mind",
      shortDescription: "  ;   ,   /.",
      description:
        " 10      .  ,      ,     -,      (  ,     1).",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Bulwark of Force",
      shortDescription:
        "   ,     .   30    1 ; 1/   .",
      description:
        " 15        -,        (. 1)   30   .      ( +2      )  1      .       ,    -;       ,       .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Telekinetic Master",
      shortDescription:
        "      ;  ,     .",
      description:
        " 18         <a href=\"/spell/1139\"> [Telekinesis]</a>      .     ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Rune Knight =====
    {
      name: "  ( )",
      engName: "Bonus Proficiencies (Rune Knight)",
      shortDescription: "      .",
      description: " 3          .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Rune Carver",
      shortDescription:
        " 2  (3/7, 4/10, 5/15),        ,  /.",
      description:
        " 3           .  7    3 ,  10  4,  15  5. ,      ,       .          ,     (   ).    , , ,   ,      .      ;        .            .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Giant's Might",
      shortDescription:
        "   ( )  1 ,  16      ; 2/.",
      description:
        " 3          1 .   ,     ,    ( ,   /),      16       .    2;    .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 2,
    },
    {
      name: " ",
      engName: "Runic Shield",
      shortDescription:
        "        60 ;  2 +   .",
      description:
        " 7 ,  ,     60 ,     ,       ,   .      2        .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
    },
    {
      name: " ",
      engName: "Great Stature",
      shortDescription: " 10      14 ;      18.",
      description:
        " 10    :  14,      .        18  16.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Master of Runes",
      shortDescription: "       ( )  .",
      description:
        " 15      ,  ,    ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Runic Juggernaut",
      shortDescription:
        "      ,   110,   +5 .",
      description:
        " 18 ,     ,      (Huge),   .     110.           ,   5    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // Rune options
    {
      name: " ",
      engName: "Cloud Rune",
      shortDescription:
        "     ;        30 . 1/.",
      description:
        ":     ( )   (). ,      30     ,         30  ( )   .         .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Fire Rune",
      shortDescription:
        "     ;   +26 .     ( ), 1/.",
      description:
        " :        ,    .     ,    :    26      .      1    26      ;      ,  .         .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Frost Rune",
      shortDescription:
        "      ;   +2  /     10 ., 1/.",
      description:
        "      (  )   ().       10 ,  +2        .         .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Stone Rune",
      shortDescription:
        "   ,  120 ;     30  ( )   1 ., 1/.",
      description:
        " :     ( )   120 . ,      30 ,      .       1 ,   0,    ;     ,    .        .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Hill Rune",
      shortDescription:
        " 7 . :      ;     ././.  1 ., 1/.",
      description:
        " 7 .   ,           .       1 ,   ,    .       .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Storm Rune",
      shortDescription:
        " 7 .   ,     ;   1 .     /    60  (), 1/.",
      description:
        " 7 .       ()      ,   .         1      .   ,      60    ,   ,         .      .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Samurai =====
    {
      name: "  ()",
      engName: "Bonus Proficiency (Samurai)",
      shortDescription:
        "     / (  ).",
      description:
        " 3      .   ,       ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Fighting Spirit",
      shortDescription:
        "     (5 +  )       .  =   .",
      description:
        " 3        :   ,  5 +   ,         .      ;     .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: " ",
      engName: "Elegant Courtier",
      shortDescription: "    ;      .",
      description:
        " 7          ().     ,  ;             (  ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Tireless Spirit",
      shortDescription: "      ,  .",
      description:
        " 10 ,           ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Rapid Strike",
      shortDescription:
        "         ,       .",
      description:
        " 15 ,       ,       ,       ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Strength Before Death",
      shortDescription:
        "     0 ,       ;    . 1/.",
      description:
        " 18 ,     0     ,         ,  .            /.      .       .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Path of the Ancestral Guardian =====
    {
      name: "-",
      engName: "Ancestral Protectors",
      shortDescription:
        "              ,      .",
      description:
        "  3 ,     ,     ,    , -  .              -,  ,      -,  ,     ( ).  ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Spirit Shield",
      shortDescription:
        ",  ,      30   26 (36  10 , 46  14).",
      description:
        "  6 ,          30 ,     ,   ,  26.      .  10     36,  14   46.     .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Consult the Spirits",
      shortDescription:
        "    <a href=\"/spell/1261\"> [Augury]</a>  <a href=\"/spell/1218\"> [Clairvoyance]</a>   ().",
      description:
        " 10     ,   .        <a href=\"/spell/1261\"> [Augury]</a>  <a href=\"/spell/1218\"> [Clairvoyance]</a>      ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: "-",
      engName: "Vengeful Ancestors",
      shortDescription:
        "    ,         .",
      description:
        " 14   -  .        ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Path of the Battlerager =====
    {
      name: " ",
      engName: "Battlerager Armor",
      shortDescription:
        "  ;     (14 ),      3      .",
      description:
        " 3     ,     (  ).        ,           5 ;     14   +   .  , ,    ,  3      .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Reckless Abandon",
      shortDescription:
        "     ,    = .  (. 1).",
      description:
        " 6 ,        ,    ,     ( 1).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Battlerager Charge",
      shortDescription: "   ,     .",
      description: " 10 ,    ,     .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Spiked Retribution",
      shortDescription:
        "   , ,      5 ,  3  .",
      description:
        " 14 ,     , - ,         5 ,  3     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Path of the Beast =====
    {
      name: " ",
      engName: "Form of the Beast",
      shortDescription:
        "    ,      ;   //.",
      description:
        " 3 ,     ,    .   ;     ,  :\n .    ,   18  .       ,     (. 1).\n .    ,       (16  ).         ,        .\n .      ;      10 ,  18  .         18          (  ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Bestial Soul",
      shortDescription:
        "   ;     (//).",
      description:
        " 6           .  ,         :\n  :     ,    .\n  :     ,    /  .\n  :      ,  18        (    ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Infectious Fury",
      shortDescription:
        "     ,     :  +212  ,    .  =   .",
      description:
        " 10 ,        ,       .    : (1)   212  ;  (2)    ,          ( ),   .      ;    .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: " ",
      engName: "Call the Hunt",
      shortDescription:
        "             5   ;   +16     .  =   .",
      description:
        " 14 ,     ,     -  ,    30 ,    .        ,  5    .    ,   ,     ,  16     ,    .   =   ;    .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },

    // ===== Path of the Berserker =====
    {
      name: "",
      engName: "Frenzy",
      shortDescription:
        "      :       ;    1  .",
      description:
        " 3 ,     ,     .  ,               .   ,     .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Mindless Rage",
      shortDescription: " ,       ;      .",
      description:
        " 6 ,    ,       .         ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Intimidating Presence",
      shortDescription:
        "    60 :           ( ).",
      description:
        " 10       ,    60 .    ;          .    :       ,     .          ,    .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Retaliation",
      shortDescription: "  ,     5 ,       .",
      description:
        " 14 ,    5        ,           .",
      displayType: [FeatureDisplayType.REACTION],
    },

    // ===== Path of the Giant =====
    {
      name: " ",
      engName: "Giants Power",
      shortDescription:
        "   ( ,  )    : <a href=\"/spell/1341\">  [Druidcraft]</a>  <a href=\"/spell/1357\"> [Thaumaturgy]</a> ().",
      description:
        " 3      (   ,    ),    : <a href=\"/spell/1341\">  [Druidcraft]</a>  <a href=\"/spell/1357\"> [Thaumaturgy]</a>.         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Giants Havoc",
      shortDescription:
        "     ( )   +5  ;         ,  .",
      description:
        "  3 ,    ,      (  ),      5 .  ,      ,   ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Elemental Cleaver",
      shortDescription:
        " ,  :     ////,  +16    ;     .  14  +26.",
      description:
        " 6 ,     ,   ,  ,      : , , , , .        ,     ,      16  ,        20/60        .         .  14      26.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Mighty Impel",
      shortDescription:
        "               30  (    ).",
      description:
        " 10   ,    ,             ,  ,   30 .      ( = 8 +  +  );    .           ,    ,      .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: "-",
      engName: "Demiurgic Colossus",
      shortDescription:
        "       ,  +10 , Mighty Impel    , Elemental Cleaver  +26.",
      description:
        " 14      :  ,     10 ,         (  ,   ). Mighty Impel       .       26,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Path of the Storm Herald =====
    {
      name: " ",
      engName: "Storm Aura",
      shortDescription:
        "      (//)  10 ;    ,     .",
      description:
        " 3 ,     ,      10 .  ,       :\n .   ,       2  .    3  5 , 4  10  5  15.\n .   ,      .     ( = 8 +  +  );    16  ,   .    26  10   36  15.\n .   ,     ( )     ,  2 +   .    3  5 , 4  10  5  15.\n         ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Storm Soul",
      shortDescription:
        "    :     (   ;        ;       ).",
      description:
        " 6          ;     .\n :   ,       .\n :   ,     ,    .\n :   ,     ,         5 ,    1 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Shielding Storm",
      shortDescription:
        "       /   .",
      description:
        " 10 ,     ,    -     10  ( )  /,     (  ).  ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Raging Storm",
      shortDescription:
        "       (    ,   ;   /;    ).",
      description:
        " 14       ,  ,    ,   :\n :         ,    ,    .\n :  ,     ,      (  ),         ( = 8 +  +  );      15   ,   .\n :        ,        ( = 8 +  +  );      0     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Path of the Totem Warrior =====
    {
      name: " ",
      engName: "Spirit Seeker",
      shortDescription:
        "  <a href=\"/spell/1548\">  [Beast Sense]</a>  <a href=\"/spell/1317\">   [Speak with Animals]</a>   .",
      description:
        " 3       :   <a href=\"/spell/1548\">  [Beast Sense]</a>  <a href=\"/spell/1317\">   [Speak with Animals]</a>   ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Totem Spirit",
      shortDescription:
        " 3    (////),     .    . . .",
      description:
        " 3 ,     ,   - (, , ,   )    .        .        (   ).      (. ).     ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Aspect of the Beast",
      shortDescription:
        " 6     ( ):     / . . .",
      description:
        " 6         (      3 ),      . .   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Spirit Walker",
      shortDescription:
        "   <a href=\"/spell/1166\">   [Commune with Nature]</a>;     .",
      description:
        " 10     <a href=\"/spell/1166\">   [Commune with Nature]</a>  .         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Totemic Attunement",
      shortDescription:
        " 14     ( ):     . . .",
      description:
        " 14        (  -   ),     . .   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // Totem Spirit options
    {
      name: " : ",
      engName: "Totem Spirit: Bear",
      shortDescription: " ,    ,  .",
      description:
        "    .    ,      ,  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " : ",
      engName: "Totem Spirit: Eagle",
      shortDescription:
        "    ,        ,      .",
      description:
        "     .         ,         ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " : ",
      engName: "Totem Spirit: Elk",
      shortDescription:
        "    ,      15 .",
      description:
        "    .         ,     15 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " : ",
      engName: "Totem Spirit: Tiger",
      shortDescription: " ,  10       3   .",
      description:
        "     .    ,   10       3     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " : ",
      engName: "Totem Spirit: Wolf",
      shortDescription:
        " ,          5   .",
      description:
        "     .    ,         -   5   ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // Aspect of the Beast options
    {
      name: " : ",
      engName: "Aspect of the Beast: Bear",
      shortDescription:
        "   ;       /// .",
      description:
        "     (.   ),       ,   , ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " : ",
      engName: "Aspect of the Beast: Eagle",
      shortDescription:
        "  1 ,     100 ;       .",
      description:
        "    :      1   ,    ,    100 .         ().",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " : ",
      engName: "Aspect of the Beast: Elk",
      shortDescription:
        "   ,    10   60 ,    .",
      description:
        "    :     ,        60 ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " : ",
      engName: "Aspect of the Beast: Tiger",
      shortDescription:
        "     : , , , .",
      description:
        "   :           , , , .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " : ",
      engName: "Aspect of the Beast: Wolf",
      shortDescription:
        "            .",
      description:
        "   :    ,   ,   ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // Totemic Attunement options
    {
      name: " : ",
      engName: "Totemic Attunement: Bear",
      shortDescription:
        " ,   5         (  /      ).",
      description:
        "   , -   5   ,   ,      ,        . ,             .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " : ",
      engName: "Totemic Attunement: Eagle",
      shortDescription:
        " ,    =  ; ,     .",
      description:
        "      ,    .        ,  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " : ",
      engName: "Totemic Attunement: Elk",
      shortDescription:
        " ,             ;         112+.   .",
      description:
        "   ,             .     ( 8 +  +  );         112 +   .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " : ",
      engName: "Totemic Attunement: Tiger",
      shortDescription:
        " ,      20      ,         .",
      description:
        "   ,      20           ,           .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " : ",
      engName: "Totemic Attunement: Wolf",
      shortDescription:
        " ,    ,        .",
      description:
        "   ,       ,      .      ;   .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },

    // ===== Path of Wild Magic =====
    {
      name: " ",
      engName: "Magic Awareness",
      shortDescription:
        "    60     ;  /.  =   .",
      description:
        " 3             .           60 ,      .     .     ;    .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: " ",
      engName: "Wild Surge",
      shortDescription:
        "   ,  8    ;  ,       .",
      description:
        "  3 ,     ,  8    (,         ):\n1.        30 .    ;    112  ,     ,   +   .\n2.     30    ,  ;    10      16  .\n3.   (  )   :    ,  ,   ;     16  (  )    10 .\n4.       30- ,      .      .\n5. :       30   16  .         30   16  .\n6.  :   ,   +1  ,  -,      ,  16  .\n7.   :   ,     30          .\n8.    : - ,     5   ,      16  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Bolstering Magic",
      shortDescription:
        "  /:  +13    10 .,    (3 ).  =   .",
      description:
        " 6      ,     ():\n :  10    13       .\n :         ,   13 (      ).       ,  .\n    ;     .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: " ",
      engName: "Unstable Backlash",
      shortDescription:
        ",         ,    ,   .",
      description:
        " 10 ,          ,        :      ,   ,   .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Controlled Surge",
      shortDescription:
        "      ,      ;     .",
      description:
        " 14 ,    8    ,     .      ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Path of the Zealot =====
    {
      name: " ",
      engName: "Divine Fury",
      shortDescription:
        "         16 +       .",
      description:
        " 3 ,    ,  ,       ,   16 +     ( )     (     ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Warrior of the Gods",
      shortDescription:
        ",     ,      .",
      description:
        "  3      :       (- ,  ),         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Fanatical Focus",
      shortDescription:
        "  ,   ,    (  ).",
      description:
        " 6 ,    ,    ,       .      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Zealous Presence",
      shortDescription:
        "    10   60 :          . 1/.",
      description:
        " 10        .        60  (  ),   /,            .      .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Arcana Domain =====
    {
      name: "  ()",
      engName: "Arcana Domain Spells",
      shortDescription: "    .",
      description:
        " : 1. <a href=\"/spell/1045\">  [Detect Magic]</a>, <a href=\"/spell/1333\">  [Magic missile]</a>; 3. <a href=\"/spell/1283\">  [Magic Weapon]</a>, <a href=\"/spell/1509\">   [Nystul's Magic Aura]</a>; 5. <a href=\"/spell/1216\">  [Dispel Magic]</a>, <a href=\"/spell/1231\">  [Magic Circle]</a>; 7. <a href=\"/spell/1205\">  [Arcane eye]</a>, <a href=\"/spell/1516\">   [Leomund's Secret Chest]</a>; 9. <a href=\"/spell/1153\">  [Planar Binding]</a>, <a href=\"/spell/1163\">  [Teleportation Circle]</a>.\n\n    ,     .          .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Arcane Initiate (Arcana Domain)",
      shortDescription: "      ;   .",
      description:
        " 1      .  ,       .       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Arcane Abjuration",
      shortDescription:
        "     ///  30       / ( Turn Undead).",
      description:
        " 2      ,    .    , ,     30 ,   /.    ;      1       ( ,   ).      5  ,     1/2   ,        (banishment)  1   .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Spell Breaker",
      shortDescription:
        "   1+ ,       (   ).",
      description:
        " 6 ,        1   ,      .           .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Potent Spellcasting (Arcana Domain)",
      shortDescription: "      .",
      description:
        " 8       ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Arcane Mastery",
      shortDescription:
        " 17   4   (6/7/8 ,   );   ,  ,  .",
      description:
        " 17        6, 7, 8       -  68  .        ,    ,  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Death Domain =====
    {
      name: "  ()",
      engName: "Death Domain Spells",
      shortDescription: "    .",
      description:
        "1. <a href=\"/spell/1304\">  [False life]</a>, <a href=\"/spell/1499\">  [Ray of Sickness]</a>; 3. <a href=\"/spell/1255\">/ [Blindness/Deafness]</a>, <a href=\"/spell/1262\">  [Ray of Enfeeblement]</a>; 5. <a href=\"/spell/1217\">  [Animate dead]</a>, <a href=\"/spell/1057\">  [Vampiric Touch]</a>; 7. <a href=\"/spell/1179\"> [Blight]</a>, <a href=\"/spell/1193\">   [Death Ward]</a>; 9. <a href=\"/spell/1159\">   [Antilife shell]</a>, <a href=\"/spell/1172\">  [Cloudkill]</a>.\n\n           .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Bonus Proficiency (Death Domain)",
      shortDescription: "  .",
      description: " 1      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "",
      engName: "Reaper",
      shortDescription:
        "  ;      5 ,     5   .",
      description:
        " 1        -  (    ).    ,       ,    5    ,         (    ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Touch of Death",
      shortDescription:
        "   ,    = 5 + 2  .",
      description:
        " 2 ,       ,    ,    ,  5 +    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Inescapable Destruction",
      shortDescription: "    ;     .",
      description: " 6           .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Divine Strike (Death)",
      shortDescription: "    18      (28  14 ).",
      description:
        " 8    ,     ,  18  .  14   28.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Improved Reaper",
      shortDescription:
        "    15 ,    ,     5   .",
      description:
        " 17 ,     15 ,     ( ),      5       (      ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Forge Domain =====
    {
      name: "  ()",
      engName: "Forge Domain Spells",
      shortDescription: "    .",
      description:
        "1. <a href=\"/spell/1316\"> [Identify]</a>, <a href=\"/spell/1455\">  [Searing Smite]</a>; 3. <a href=\"/spell/1258\">  [Heat Metal]</a>, <a href=\"/spell/1283\">  [Magic Weapon]</a>; 5. <a href=\"/spell/1491\">  [Elemental Weapon]</a>, <a href=\"/spell/1236\">   [Protection from Energy]</a>; 7. <a href=\"/spell/1201\"> [Fabricate]</a>, <a href=\"/spell/1181\">  [Wall of Fire]</a>; 9. <a href=\"/spell/1156\">  [Animate objects]</a>, <a href=\"/spell/1140\"> [Creation]</a>.\n\n         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Bonus Proficiencies (Forge Domain)",
      shortDescription: "     .",
      description: " 1         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Blessing of the Forge",
      shortDescription:
        "    /: +1   /  +1     .",
      description:
        " 1           :   .         +1     ,    +1  .        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Artisans Blessing",
      shortDescription:
        " 1       100  ,   .",
      description:
        " 2      ,   1- ,       100  (  PHB: / , , 10 , ).      ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Soul of the Forge",
      shortDescription:
        "+1    ;  ;    ,   14  (   ).",
      description:
        " 6 ,     ,     1,     ,   ,      ,  14  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Divine Strike (Forge)",
      shortDescription: "    18      (28  14 ).",
      description:
        " 8    ,     ,  18  .  14   28.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Saint of Forge and Fire",
      shortDescription:
        "  ;     //  .",
      description:
        " 17       .    ,   ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Grave Domain =====
    {
      name: "  ()",
      engName: "Grave Domain Spells",
      shortDescription: "    .",
      description:
        "1. <a href=\"/spell/1336\"> [Bane]</a>, <a href=\"/spell/1304\">  [False life]</a>; 3. <a href=\"/spell/1275\">  [Gentle Repose]</a>, <a href=\"/spell/1262\">  [Ray of Enfeeblement]</a>; 5. <a href=\"/spell/1245\"> [Revivify]</a>, <a href=\"/spell/1057\">  [Vampiric Touch]</a>; 7. <a href=\"/spell/1179\"> [Blight]</a>, <a href=\"/spell/1193\">   [Death Ward]</a>; 9. <a href=\"/spell/1159\">   [Antilife shell]</a>, <a href=\"/spell/1157\">  [Raise Dead]</a>.\n\n        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Circle of Mortality",
      shortDescription:
        "   0   ; <a href=\"/spell/1349\">   [Spare the Dying]</a>     30 .",
      description:
        " 1 ,      0 ,      .    <a href=\"/spell/1349\">   [Spare the Dying]</a>;          30 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Eyes of the Grave",
      shortDescription:
        "     60  (    ).  = .    (.1).",
      description:
        " 1          60 ,           .      ( 1);    .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
    },
    {
      name: ":   ",
      engName: "Channel Divinity: Path to the Grave",
      shortDescription:
        "  :             ,      .",
      description:
        " 2     ,    30 .                    ,      .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: "  ",
      engName: "Sentinel at Death's Door",
      shortDescription:
        "       30 ;  = .    (.1).",
      description:
        " 6 ,  ,     30 ,   ,       .    ,     ( 1);      .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
    },
    {
      name: "  ()",
      engName: "Potent Spellcasting (Grave Domain)",
      shortDescription: "      .",
      description:
        " 8           .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Keeper of Souls",
      shortDescription:
        "  ,     60 ,     ,  - .",
      description:
        " 17    ,  ,     60 , ,        60 ;    ,   -   ( 1).  ,      0 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Knowledge Domain =====
    {
      name: "  ()",
      engName: "Knowledge Domain Spells",
      shortDescription: "    .",
      description:
        "1. <a href=\"/spell/1329\"> [Command]</a>, <a href=\"/spell/1316\"> [Identify]</a>; 3. <a href=\"/spell/1261\"> [Augury]</a>, <a href=\"/spell/1277\"> [Suggestion]</a>; 5. <a href=\"/spell/1224\"> [Nondetection]</a>, <a href=\"/spell/1215\">   [Speak with Dead]</a>; 7. <a href=\"/spell/1205\">  [Arcane eye]</a>, <a href=\"/spell/1183\"> [Confusion]</a>; 9. <a href=\"/spell/1164\">  [Legend Lore]</a>, <a href=\"/spell/1144\"> [Scrying]</a>.\n\n        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Blessings of Knowledge",
      shortDescription:
        "       (///)    .",
      description:
        " 1            : , ,   .       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Knowledge of the Ages",
      shortDescription:
        "   -     10 .",
      description:
        " 2       ,            10 .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Read Thoughts",
      shortDescription:
        "      60  1 .;     <a href=\"/spell/1277\"> [Suggestion]</a>   .",
      description:
        " 6       ,     ,    60 ,  1  ().   ,        <a href=\"/spell/1277\"> [Suggestion]</a>   ;    .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: "  ()",
      engName: "Potent Spellcasting (Knowledge Domain)",
      shortDescription: "      .",
      description: " 8         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Visions of the Past",
      shortDescription:
        "    :    (/ )      = . .",
      description:
        " 17    ,    .    (  10 .        100 )   (     24 /100 ,   ).      (.1);    .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
    },
    {
      name: "    ",
      engName: "Rage Beyond Death",
      shortDescription:
        " ,      0         ,    .",
      description:
        " 14 ,    ,   0     .       ;   ,        0    .  ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Life Domain =====
    {
      name: "  ()",
      engName: "Life Domain Spells",
      shortDescription: "    .",
      description:
        "1. <a href=\"/spell/1044\"> [Bless]</a>, <a href=\"/spell/1334\">  [Cure Wounds]</a>; 3. <a href=\"/spell/1281\">  [Lesser Restoration]</a>, <a href=\"/spell/1292\">  [Spiritual Weapon]</a>; 5. <a href=\"/spell/1229\">  [Beacon of Hope]</a>, <a href=\"/spell/1245\"> [Revivify]</a>; 7. <a href=\"/spell/1193\">   [Death Ward]</a>, <a href=\"/spell/1203\">  [Guardian of Faith]</a>; 9. <a href=\"/spell/1161\">   [Mass Cure Wounds]</a>, <a href=\"/spell/1157\">  [Raise Dead]</a>.\n\n        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Bonus Proficiency (Life Domain)",
      shortDescription: "  .",
      description: " 1     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Disciple of Life",
      shortDescription: "   1+ ,  2 +     .",
      description:
        " 1     : ,   1     ,    2 +  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Preserve Life",
      shortDescription:
        "   = 5      30 ,     .",
      description:
        " 2      ,  5   ,  -     30 .         .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Blessed Healer",
      shortDescription: "    1+ ,   2 +  .",
      description:
        " 6 ,        1   ,    2 +  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Divine Strike (Life)",
      shortDescription: "    18      (28  14 ).",
      description: " 8         18  ;  14   28.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Supreme Healing",
      shortDescription: "      ,    .",
      description:
        " 17 ,     ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Light Domain =====
    {
      name: "  ()",
      engName: "Light Domain Spells",
      shortDescription: "    .",
      description:
        "1. <a href=\"/spell/1321\">  [Burning Hands]</a>, <a href=\"/spell/1041\">  [Faerie fire]</a>; 3. <a href=\"/spell/1271\">  [Flaming Sphere]</a>, <a href=\"/spell/1256\">  [Scorching Ray]</a>; 5. <a href=\"/spell/1242\">  [Daylight]</a>, <a href=\"/spell/1246\"> [Fireball]</a>; 7. <a href=\"/spell/1203\">  [Guardian of Faith]</a>, <a href=\"/spell/1181\">  [Wall of Fire]</a>; 9. <a href=\"/spell/1151\">'  [Flame Strike]</a>, <a href=\"/spell/1144\"> [Scrying]</a>.\n\n        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Bonus Cantrip (Light Domain)",
      shortDescription: "  <a href=\"/spell/1055\"> [Light]</a>.",
      description: " 1     <a href=\"/spell/1055\"> [Light]</a>,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Warding Flare",
      shortDescription:
        ",       30 ,      (   /).  = .   .",
      description:
        "  1 ,  ,     30 ,     ,        .       .     (.1);    .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Radiance of the Dawn",
      shortDescription:
        "      210 +        30  (  ).",
      description:
        " 2         30         : 210 +   ,    .      .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Improved Flare",
      shortDescription: "   ,       30 .",
      description:
        " 6      ,    30        (   ).   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Potent Spellcasting (Light Domain)",
      shortDescription: "      .",
      description: " 8          .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Corona of Light",
      shortDescription:
        "  60  / 30  ;          /.",
      description:
        " 17         60  (  30  ).           ,      .  ,        .",
      displayType: [FeatureDisplayType.ACTION],
    },

    // ===== Nature Domain =====
    {
      name: "  ()",
      engName: "Nature Domain Spells",
      shortDescription: "    .",
      description:
        "1. <a href=\"/spell/1339\">   [Animal friendship]</a>, <a href=\"/spell/1317\">   [Speak with Animals]</a>; 3. <a href=\"/spell/1293\">  [Barkskin]</a>, <a href=\"/spell/1260\">  [Spike Growth]</a>; 5. <a href=\"/spell/1213\">  [Plant Growth]</a>, <a href=\"/spell/1209\">  [Wind Wall]</a>; 7. <a href=\"/spell/1185\">  [Dominate Beast]</a>, <a href=\"/spell/1556\">  [Grasping Vine]</a>; 9. <a href=\"/spell/1160\">  [Insect Plague]</a>, <a href=\"/spell/1171\">  [Tree Stride]</a>.\n\n         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Acolyte of Nature",
      shortDescription:
        "   ;    : /  /.",
      description:
        " 1         ( ).  ,      : ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Bonus Proficiency (Nature Domain)",
      shortDescription: "  .",
      description: " 1      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":    ",
      engName: "Channel Divinity: Charm Animals and Plants",
      shortDescription:
        "  /  30         1 .",
      description:
        " 2       ;    ,    /  30 ,   .       1      .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Dampen Elements",
      shortDescription:
        "   ////        .",
      description:
        " 6  ,      30    , , ,   ,         .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: "  ()",
      engName: "Divine Strike (Nature)",
      shortDescription:
        "    18 //     (28  14 ).",
      description:
        " 8          18  ,    (   ).  14   28.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Master of Nature",
      shortDescription: "     :       1 .",
      description:
        " 17 ,          ,     ,     ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Order Domain =====
    {
      name: "  ()",
      engName: "Order Domain Spells",
      shortDescription: "    .",
      description:
        "1. <a href=\"/spell/1329\"> [Command]</a>, <a href=\"/spell/1047\"> [Heroism]</a>; 3. <a href=\"/spell/1254\">  [Hold Person]</a>, <a href=\"/spell/1287\">  [Zone of Truth]</a>; 5. <a href=\"/spell/1230\">   [Mass Healing Word]</a>, <a href=\"/spell/1208\"> [Slow]</a>; 7. <a href=\"/spell/1186\"> [Compulsion]</a>, <a href=\"/spell/1185\">  [Dominate Beast]</a>; 9. <a href=\"/spell/1149\">  [Dominate Person]</a>, <a href=\"/spell/1143\">  [Hold Monster]</a>.\n\n        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Bonus Proficiencies (Order Domain)",
      shortDescription: "    .",
      description: " 1         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Voice of Authority",
      shortDescription: "   1+   ,      .",
      description:
        " 1 ,     1   ,    ( ),       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Orders Demand",
      shortDescription:
        "    30               .",
      description:
        " 2     ;      30    .             .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Embodiment of Law",
      shortDescription: ".          1    .",
      description:
        " 6   ,     (.1),         ,     1 ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
    },
    {
      name: "  ()",
      engName: "Divine Strike (Order)",
      shortDescription: "    18      (28  14 ).",
      description: " 8         18  ;  14   28.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Orders Wrath",
      shortDescription:
        "    ,   :        +28  .  = .   .",
      description:
        " 17 ,     ,          .    ,      ,    28  .      (.1);    .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
    },

    // ===== Peace Domain =====
    {
      name: "  ()",
      engName: "Peace Domain Spells",
      shortDescription: "    .",
      description:
        "1. <a href=\"/spell/1047\"> [Heroism]</a>, <a href=\"/spell/1313\"> [Sanctuary]</a>; 3. <a href=\"/spell/1259\"> [Aid]</a>, <a href=\"/spell/1274\"> ' [Warding Bond]</a>; 5. <a href=\"/spell/1229\">  [Beacon of Hope]</a>, <a href=\"/spell/1220\"> [Sending]</a>; 7. <a href=\"/spell/1555\">  [Aura of Purity]</a>, <a href=\"/spell/1518\">   [Otiluke's Resilient Sphere]</a>; 9. <a href=\"/spell/1173\">  [Greater Restoration]</a>, <a href=\"/spell/1522\"> '  [Rary's Telepathic Bond]</a>.\n\n        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " '",
      engName: "Emboldening Bond",
      shortDescription:
        "  '      30  (10 ):   30    ,  14  //.  =   .",
      description:
        " 1       ,    ,  30 , '   10 .   ,     30    ,    14   ,   .    ;     .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Balm of Peace",
      shortDescription:
        "     ;  ,     ,  26 +   .",
      description:
        " 2        ,    .  ,       ,  ,  26 +   .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " '",
      engName: "Protective Bond",
      shortDescription:
        "    ,       5       .",
      description:
        " 6 ,      '  ,   ,   ,        5       .     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Potent Spellcasting (Peace Domain)",
      shortDescription: "      .",
      description: " 8         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " '",
      engName: "Expansive Bond",
      shortDescription: " ' 60 ;    '     .",
      description:
        " 17   ' ,     60    .   '  ,       (   ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Tempest Domain =====
    {
      name: "  ()",
      engName: "Tempest Domain Spells",
      shortDescription: "    .",
      description:
        "1. <a href=\"/spell/1305\">  [Fog Cloud]</a>, <a href=\"/spell/1043\">  [Thunderwave]</a>; 3. <a href=\"/spell/1267\">  [Gust of Wind]</a>, <a href=\"/spell/1294\"> [Shatter]</a>; 5. <a href=\"/spell/1225\">  [Call Lightning]</a>, <a href=\"/spell/1238\"> [Sleet Storm]</a>; 7. <a href=\"/spell/1191\">  [Control Water]</a>, <a href=\"/spell/1190\">  [Ice Storm]</a>; 9. <a href=\"/spell/1521\">  [Destructive Wave]</a>, <a href=\"/spell/1160\">  [Insect Plague]</a>.\n\n        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Bonus Proficiencies (Tempest Domain)",
      shortDescription: "     .",
      description: " 1         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Wrath of the Storm",
      shortDescription:
        ",     5 ,  28 /  (   ).  = .   .",
      description:
        " 1 ,    5    ,        .     28     ( );    .      (.1);    .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Destructive Wrath",
      shortDescription: "  / ,       .",
      description:
        " 2 ,       ,    ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Thunderbolt Strike",
      shortDescription: "    ,     10   .",
      description:
        " 6 ,      ,      10   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Divine Strike (Tempest)",
      shortDescription: "    18      (28  14 ).",
      description: " 8         18  ;  14   28.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Stormborn",
      shortDescription: " 17     =  ,         .",
      description:
        " 17     ,    ,          .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Trickery Domain =====
    {
      name: "  ()",
      engName: "Trickery Domain Spells",
      shortDescription: "    .",
      description:
        "1. <a href=\"/spell/1318\">  [Charm Person]</a>, <a href=\"/spell/1332\"> [Disguise Self]</a>; 3. <a href=\"/spell/1296\"> [Mirror Image]</a>, <a href=\"/spell/1270\">   [Pass without Trace]</a>; 5. <a href=\"/spell/1228\"> [Blink]</a>, <a href=\"/spell/1216\">  [Dispel Magic]</a>; 7. <a href=\"/spell/1196\">   [Dimension Door]</a>, <a href=\"/spell/1189\"> [Polymorph]</a>; 9. <a href=\"/spell/1149\">  [Dominate Person]</a>, <a href=\"/spell/1165\">  [Modify Memory]</a>.\n\n        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Blessing of the Trickster",
      shortDescription:
        "  :       1     .",
      description:
        " 1     ,  ,      1 .     ;    .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Invoke Duplicity",
      shortDescription:
        "     30  (, 1 );      ,    5 .",
      description:
        " 2        30 ;    1  ().        30 .       5   ,        .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Cloak of Shadows",
      shortDescription: "      ,      .",
      description:
        " 6               //.",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: "  ()",
      engName: "Divine Strike (Trickery)",
      shortDescription: "    18      (28  14 ).",
      description: " 8         18  ;  14   28.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Improved Duplicity",
      shortDescription:
        "     4  ;    30    .",
      description:
        " 17 ,     ,     .     -     30 .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },

    // ===== Twilight Domain =====
    {
      name: "  ()",
      engName: "Twilight Domain Spells",
      shortDescription: "    .",
      description:
        "1. <a href=\"/spell/1041\">  [Faerie fire]</a>, <a href=\"/spell/1310\"> [Sleep]</a>; 3. <a href=\"/spell/1278\">  [Moonbeam]</a>, <a href=\"/spell/1299\">  [See Invisibility]</a>; 5. <a href=\"/spell/1514\">  [Aura of Vitality]</a>, <a href=\"/spell/1513\">   [Leomund's Tiny Hut]</a>; 7. <a href=\"/spell/1514\">  [Aura of Life]</a>, <a href=\"/spell/1204\">  [Greater Invisibility]</a>; 9. <a href=\"/spell/1557\">  [Circle of Power]</a>, <a href=\"/spell/1154\"> [Mislead]</a>.\n\n        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Bonus Proficiencies (Twilight Domain)",
      shortDescription: "     .",
      description: " 1         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Eyes of Night",
      shortDescription:
        " 300 ;        1 , .      .",
      description:
        " 1     300  (      ).        ,    ,  1 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Vigilant Blessing",
      shortDescription:
        "      ( );     .",
      description:
        " 1     ,  ,     .    ;     .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Twilight Sanctuary",
      shortDescription:
        "  30- ;         (16+ )   /.",
      description:
        " 2         30 ,    .   1 .             ,  16 +   ,       .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Steps of Night",
      shortDescription:
        " ,     /,    =    1 .  =   .",
      description:
        " 6 ,        ,      ,   ,  1 .    ;    .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: "  ()",
      engName: "Divine Strike (Twilight)",
      shortDescription: "    18      (28  14 ).",
      description: " 8         18  ;  14   28.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Midnight Shroud",
      shortDescription:
        "   ,     :         .",
      description:
        " 17 ,     ,     :     ,   ,             ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== War Domain =====
    {
      name: "  ()",
      engName: "War Domain Spells",
      shortDescription: "    .",
      description:
        "1. <a href=\"/spell/1042\">  [Divine Favor]</a>, <a href=\"/spell/1301\">  [Shield of Faith]</a>; 3. <a href=\"/spell/1283\">  [Magic Weapon]</a>, <a href=\"/spell/1292\">  [Spiritual Weapon]</a>; 5. <a href=\"/spell/1231\">  [Magic Circle]</a>, <a href=\"/spell/1553\">  [Crusader's Mantle]</a>; 7. <a href=\"/spell/1184\">  [Freedom of Movement]</a>, <a href=\"/spell/1192\">'  [Stoneskin]</a>; 9. <a href=\"/spell/1151\">'  [Flame Strike]</a>, <a href=\"/spell/1143\">  [Hold Monster]</a>.\n\n        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Bonus Proficiencies (War Domain)",
      shortDescription: "     .",
      description: " 1         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "War Priest",
      shortDescription:
        "        .  = .    (.1).",
      description:
        " 1 ,     ,       .      (.1);     .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Guided Strike",
      shortDescription: "   ,   +10  .",
      description:
        " 2 ,     ,    ,   +10  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":   ",
      engName: "Channel Divinity: War Gods Blessing",
      shortDescription: "  +10      30 .   .",
      description:
        " 6 ,    30    ,      ,   +10   .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: "  ()",
      engName: "Divine Strike (War)",
      shortDescription: "    18   (  )  ; 28  14 .",
      description:
        " 8         18    ,   .  14   28.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Avatar of Battle",
      shortDescription: " 17    //  .",
      description:
        " 17     ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Warlock: Archfey =====
    {
      name: "  ()",
      engName: "Expanded Spell List (Archfey)",
      shortDescription:
        "1. <a href=\"/spell/1041\">  [Faerie fire]</a>, <a href=\"/spell/1310\"> [Sleep]</a>; 2. <a href=\"/spell/1298\">  [Calm Emotions]</a>, <a href=\"/spell/1502\">  [Phantasmal Force]</a>; 3. <a href=\"/spell/1228\"> [Blink]</a>, <a href=\"/spell/1213\">  [Plant Growth]</a>; 4. <a href=\"/spell/1185\">  [Dominate Beast]</a>, <a href=\"/spell/1204\">  [Greater Invisibility]</a>; 5. <a href=\"/spell/1149\">  [Dominate Person]</a>, <a href=\"/spell/1152\"> [Seeming]</a>.",
      description: "        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Fey Presence",
      shortDescription:
        "    10- :             . 1/.",
      description:
        " 1        10-      .        (  )     .           .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Misty Escape",
      shortDescription:
        "      60           /. 1/.",
      description:
        "  6 ,    ,         60    ,  .             .             .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Beguiling Defenses",
      shortDescription: "  ;     ,        1 .",
      description:
        " 10       .     ,           ;       1      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Dark Delirium",
      shortDescription:
        "    60  ( )           1  (.). 1/.",
      description:
        " 14        60 ,  .    ;        ( )   1 .  ,     ,    ,      .  ,        ,      (  ).         .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },

    // ===== Warlock: Fiend =====
    {
      name: "  ()",
      engName: "Expanded Spell List (Fiend)",
      shortDescription:
        "1. <a href=\"/spell/1321\">  [Burning Hands]</a>, <a href=\"/spell/1329\"> [Command]</a>; 2. <a href=\"/spell/1255\">/ [Blindness/Deafness]</a>, <a href=\"/spell/1256\">  [Scorching Ray]</a>; 3. <a href=\"/spell/1246\"> [Fireball]</a>, <a href=\"/spell/1212\">  [Stinking Cloud]</a>; 4. <a href=\"/spell/1200\">  [Fire Shield]</a>, <a href=\"/spell/1181\">  [Wall of Fire]</a>; 5. <a href=\"/spell/1151\">'  [Flame Strike]</a>, <a href=\"/spell/1155\"> [Hallow]</a>.",
      description: "        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Dark Ones Blessing",
      shortDescription: "     ,    = .  +  .",
      description:
        " 1 ,   ,      1 ,   0    ,    ,     +  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Dark Ones Own Luck",
      shortDescription: "     110      .",
      description:
        " 6      (   )  110     .         .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Fiendish Resilience",
      shortDescription: " /          (    ).",
      description:
        " 10          .      ,        .         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Hurl Through Hell",
      shortDescription: "   ,     ;        1010  . 1/.",
      description:
        " 14 ,     ,       .       ,     . ,   1010  . ,   ,   .           .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Warlock: Great Old One =====
    {
      name: "  ( )",
      engName: "Expanded Spell List (Great Old One)",
      shortDescription:
        "1. <a href=\"/spell/1496\">  [Dissonant Whispers]</a>, <a href=\"/spell/1324\">   [Tasha's Hideous Laughter]</a>; 2. <a href=\"/spell/1297\">  [Detect Thoughts]</a>, <a href=\"/spell/1502\">  [Phantasmal Force]</a>; 3. <a href=\"/spell/1218\"> [Clairvoyance]</a>, <a href=\"/spell/1220\"> [Sending]</a>; 4. <a href=\"/spell/1185\">  [Dominate Beast]</a>, <a href=\"/spell/1515\">   [Evard's Black Tentacles]</a>; 5. <a href=\"/spell/1149\">  [Dominate Person]</a>, <a href=\"/spell/1139\"> [Telekinesis]</a>.",
      description: "        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Awakened Mind",
      shortDescription: "    30 ,      .",
      description:
        " 1       -   30 ,  ,      .     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Entropic Ward",
      shortDescription:
        "      ;                . 1/.",
      description:
        " 6 ,       ,       .   ,               .         .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Thought Shield",
      shortDescription: "  ; -,     ,     .",
      description:
        " 10      .  ,      ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Create Thrall",
      shortDescription:
        "        ,        ;      -    .",
      description:
        " 14     .      ,      (     ,          ).  ,         -    .",
      displayType: [FeatureDisplayType.ACTION],
    },

    // ===== Warlock: Hexblade =====
    {
      name: "  ()",
      engName: "Expanded Spell List (Hexblade)",
      shortDescription:
        "1. <a href=\"/spell/1302\"> [Shield]</a>, <a href=\"/spell/1453\">  [Wrathful Smite]</a>; 2. <a href=\"/spell/1252\">  [Branding Smite]</a>, <a href=\"/spell/1257\"> [Blur]</a>; 3. <a href=\"/spell/1228\"> [Blink]</a>, <a href=\"/spell/1491\">  [Elemental Weapon]</a>; 4. <a href=\"/spell/1177\">  [Phantasmal Killer]</a>, <a href=\"/spell/1457\">  [Staggering Smite]</a>; 5. <a href=\"/spell/1162\">  [Cone of Cold]</a>, <a href=\"/spell/1521\">  [Destructive Wave]</a>.",
      description: "        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Hexblades Curse",
      shortDescription:
        "     30 : +  ,   1920,    . 1/.",
      description:
        " 1     ,    30 .   1        0 .   +     ,    1920,    ,  ,    +  .         .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Hex Warrior",
      shortDescription:
        "  ,    ;      /   (   ).",
      description:
        " 1     ,    .    ,      ,         ,     /     .      ,       ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Accursed Specter",
      shortDescription:
        "  ,        ;     = 1/2         . 1/.",
      description:
        " 6 ,    ,    ,        .    ,     ,           .       .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Armor of Hexes",
      shortDescription: "     ,  6;  4+  .",
      description:
        " 10 ,         ,    6.   4       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Master of Hexes",
      shortDescription:
        "   ,          30    .",
      description:
        " 14 ,      ,       ,    30 .         .",
      displayType: [FeatureDisplayType.REACTION],
    },

    // ===== Warlock: Celestial =====
    {
      name: "  ()",
      engName: "Expanded Spell List (Celestial)",
      shortDescription:
        "1. <a href=\"/spell/1334\">  [Cure Wounds]</a>, <a href=\"/spell/1309\">  [Guiding Bolt]</a>; 2. <a href=\"/spell/1271\">  [Flaming Sphere]</a>, <a href=\"/spell/1281\">  [Lesser Restoration]</a>; 3. <a href=\"/spell/1242\">  [Daylight]</a>, <a href=\"/spell/1245\"> [Revivify]</a>; 4. <a href=\"/spell/1203\">  [Guardian of Faith]</a>, <a href=\"/spell/1181\">  [Wall of Fire]</a>; 5. <a href=\"/spell/1151\">'  [Flame Strike]</a>, <a href=\"/spell/1173\">  [Greater Restoration]</a>.",
      description: "        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Bonus Cantrips (Celestial)",
      shortDescription: " <a href=\"/spell/1055\"> [Light]</a>  <a href=\"/spell/1347\"> [Guidance]</a>.",
      description:
        " 1     <a href=\"/spell/1055\"> [Light]</a>  <a href=\"/spell/1347\"> [Guidance]</a>;       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Healing Light",
      shortDescription:
        " 6 = 1 +  ;     .  ,    60 .",
      description:
        " 1      (6),  1 +   .         (.1)   ,    60 ,   .       .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Radiant Soul",
      shortDescription: "  ;     .       .",
      description:
        " 6     .   ,     ,      ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Celestial Resilience",
      shortDescription:
        "     =  + . ;  .      = 1/2  + . .",
      description:
        " 10          ,     +  .  ,   ,     (.1),  :    ,      +   ( ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Searing Vengeance",
      shortDescription:
        "    0 ,  :  1/2  + .  , ,   30   28+.        . 1/.",
      description:
        " 14 ,       0 ,     .   ,      +  ,   .     30   28 +            .           .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Warlock: Fathomless =====
    {
      name: "  ()",
      engName: "Expanded Spell List (Fathomless)",
      shortDescription:
        "1. <a href=\"/spell/1308\">    [Create or Destroy Water]</a>, <a href=\"/spell/1043\">  [Thunderwave]</a>; 2. <a href=\"/spell/1267\">  [Gust of Wind]</a>, <a href=\"/spell/1248\"> [Silence]</a>; 3. <a href=\"/spell/1237\">  [Lightning Bolt]</a>, <a href=\"/spell/1238\"> [Sleet Storm]</a>; 4. <a href=\"/spell/1191\">  [Control Water]</a>, <a href=\"/spell/1449\">  [Summon Elemental]</a>; 5. <a href=\"/spell/1493\">  [Bigby's Hand]</a>, <a href=\"/spell/1162\">  [Cone of Cold]</a>.",
      description: "        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Tentacle of the Deeps",
      shortDescription:
        "     60  (1 ):  18 (28  10 .)   -10 .     .  =   .",
      description:
        " 1         60 .      10     :     18  ,      10      .   1 ;       30    .        .    28  10 .",
      displayType: [FeatureDisplayType.CLASS_RESOURCE],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: " ",
      engName: "Gift of the Sea",
      shortDescription: "    =       .",
      description: " 1     ,   ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Oceanic Soul",
      shortDescription: "  ;      ,   .",
      description:
        " 6      .  ,      - ,   ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Guardian Coil",
      shortDescription:
        "   10      ,     18 (28  10 .).",
      description:
        " 6 ,  ,   ,  10       ,        18 (28  10 ),    .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Grasping Tentacles",
      shortDescription:
        "     <a href=\"/spell/1515\">   [Evard's Black Tentacles]</a>  ,    =       .",
      description:
        " 10         <a href=\"/spell/1515\">   [Evard's Black Tentacles]</a>    .   ,   ,    ,        .       .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: "  ",
      engName: "Fathomless Plunge",
      shortDescription:
        "     5   30   ,     1 ;     .",
      description:
        " 14          30          (   10 ),     1 .      .           .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Warlock: Genie =====
    {
      name: "  ()",
      engName: "Genie Expanded Spells",
      shortDescription:
        ": 1 <a href=\"/spell/1048\">    [Detect evil and good]</a>, 2 <a href=\"/spell/1502\">  [Phantasmal Force]</a>, 3 <a href=\"/spell/1211\">    [Create Food and Water]</a>, 4 <a href=\"/spell/1177\">  [Phantasmal Killer]</a>, 5 <a href=\"/spell/1140\"> [Creation]</a>, 9 <a href=\"/spell/1068\"> [Wish]</a>;      .",
      description:
        " 1     .      .\n\n : 1 <a href=\"/spell/1048\">    [Detect evil and good]</a>; 2 <a href=\"/spell/1502\">  [Phantasmal Force]</a>; 3 <a href=\"/spell/1211\">    [Create Food and Water]</a>; 4 <a href=\"/spell/1177\">  [Phantasmal Killer]</a>; 5 <a href=\"/spell/1140\"> [Creation]</a>; 9 <a href=\"/spell/1068\"> [Wish]</a>.\n\n     :\n-  (): 1 <a href=\"/spell/1313\"> [Sanctuary]</a>, 2 <a href=\"/spell/1260\">  [Spike Growth]</a>, 3 <a href=\"/spell/1235\">   [Meld into Stone]</a>, 4 <a href=\"/spell/1176\">  [Stone Shape]</a>, 5 <a href=\"/spell/1141\">   [Wall of Stone]</a>.\n-  (): 1 <a href=\"/spell/1043\">  [Thunderwave]</a>, 2 <a href=\"/spell/1267\">  [Gust of Wind]</a>, 3 <a href=\"/spell/1209\">  [Wind Wall]</a>, 4 <a href=\"/spell/1204\">  [Greater Invisibility]</a>, 5 <a href=\"/spell/1152\"> [Seeming]</a>.\n-  (): 1 <a href=\"/spell/1321\">  [Burning Hands]</a>, 2 <a href=\"/spell/1256\">  [Scorching Ray]</a>, 3 <a href=\"/spell/1246\"> [Fireball]</a>, 4 <a href=\"/spell/1200\">  [Fire Shield]</a>, 5 <a href=\"/spell/1151\">'  [Flame Strike]</a>.\n-  (): 1 <a href=\"/spell/1305\">  [Fog Cloud]</a>, 2 <a href=\"/spell/1257\"> [Blur]</a>, 3 <a href=\"/spell/1238\"> [Sleet Storm]</a>, 4 <a href=\"/spell/1191\">  [Control Water]</a>, 5 <a href=\"/spell/1162\">  [Cone of Cold]</a>.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Genies Vessel",
      shortDescription:
        " -:   (  1 /),     +      .",
      description:
        " 1     (,  ),    .      ( )  2 ;    ,         .  20- ,  ,  .\n\n  ,   ,   ,   ,   :  (),  (),  ()   ().\n\n   =   ,  =    + ,      .    ,     1  (  / ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Elemental Gift",
      shortDescription:
        "   ;      30  ()  10 ,  =   .",
      description:
        " 6     :     (///).       30      10 .    ;    .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: "  ",
      engName: "Sanctuary Vessel",
      shortDescription:
        "   ,    5    30 ; 10   =  ,        .",
      description:
        " 10 ,     ,        30 ;     .     -  ;   ,         .      10     ,     -        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Limited Wish",
      shortDescription:
        "    6      1   -   .   14 .",
      description:
        " 14       ,     6       1   - .   .    4;     ,     .",
      displayType: [FeatureDisplayType.ACTION],
    },

    // ===== Warlock: Undead =====
    {
      name: "  ()",
      engName: "Expanded Spell List (Undead)",
      shortDescription:
        "1. <a href=\"/spell/1336\"> [Bane]</a>, <a href=\"/spell/1304\">  [False life]</a>; 2. <a href=\"/spell/1255\">/ [Blindness/Deafness]</a>, <a href=\"/spell/1502\">  [Phantasmal Force]</a>; 3. <a href=\"/spell/1215\">   [Speak with Dead]</a>, <a href=\"/spell/1207\">  [phantom steed]</a>; 4. <a href=\"/spell/1193\">   [Death Ward]</a>, <a href=\"/spell/1204\">  [Greater Invisibility]</a>; 5. <a href=\"/spell/1159\">   [Antilife shell]</a>, <a href=\"/spell/1172\">  [Cloudkill]</a>.",
      description: "        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Form of Dread",
      shortDescription:
        "   1    :   =  + . ,   ,          .  =   .",
      description:
        " 1        1 .   ,     +  ,      .    ,     ,     ;          .       .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: " ",
      engName: "Grave Touched",
      shortDescription:
        "   ,            110  .",
      description:
        " 6 ,    ,               110       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Mortal Husk",
      shortDescription:
        "  ;      0 ,      1      ( =  + . )  30 . 1/.",
      description:
        " 10      .     0 ,      1         30    ,     +   (   ).         .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Spirit Projection",
      shortDescription:
        "  1   :  ././.,   ,     +18,  ;   . 1/.",
      description:
        " 14           1  (  ).    ,     ,        ,        18.    ,   .      ;   ,      .       .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Warlock: Undying =====
    {
      name: "  ()",
      engName: "Expanded Spell List (Undying)",
      shortDescription:
        "1. <a href=\"/spell/1304\">  [False life]</a>, <a href=\"/spell/1499\">  [Ray of Sickness]</a>; 2. <a href=\"/spell/1255\">/ [Blindness/Deafness]</a>, <a href=\"/spell/1248\"> [Silence]</a>; 3. <a href=\"/spell/1511\">  [Feign Death]</a>, <a href=\"/spell/1215\">   [Speak with Dead]</a>; 4. <a href=\"/spell/1514\">  [Aura of Life]</a>, <a href=\"/spell/1193\">   [Death Ward]</a>; 5. <a href=\"/spell/1169\"> [Contagion]</a>, <a href=\"/spell/1164\">  [Legend Lore]</a>.",
      description: "        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Among the Dead",
      shortDescription:
        "  <a href=\"/spell/1349\">   [Spare the Dying]</a>;      ;    ,    (1   24 ).",
      description:
        " 1      <a href=\"/spell/1349\">   [Spare the Dying]</a>      30 .       .     ,         ;          /.       24 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Defy Death",
      shortDescription:
        "        <a href=\"/spell/1349\">  </a>,   18 + .  . 1/.",
      description:
        " 6 ,          <a href=\"/spell/1349\">   [Spare the Dying]</a>  ,    18 +   .         .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Undying Nature",
      shortDescription: "  ,   ,  ,    .",
      description:
        " 10     ,   .   ,         ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Indestructible Life",
      shortDescription:
        "   18 +         . 1/.",
      description:
        " 14      18 +   .     ,      .         .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },

    // ===== Sorcerer: Aberrant Mind =====
    {
      name: "  ( )",
      engName: "Psionic Spells (Aberrant Mind)",
      shortDescription:
        "  : <a href=\"/spell/1500\">  [Arms of Hadar]</a>, <a href=\"/spell/1496\">  [Dissonant Whispers]</a>, <a href=\"/spell/1297\">  [Detect Thoughts]</a>, <a href=\"/spell/1298\">  [Calm Emotions]</a>, <a href=\"/spell/1512\">  [Hunger of Hadar]</a>, <a href=\"/spell/1220\"> [Sending]</a>, <a href=\"/spell/1515\">   [Evard's Black Tentacles]</a>, <a href=\"/spell/1450\">  [Summon Aberration]</a>, <a href=\"/spell/1139\"> [Telekinesis]</a>, <a href=\"/spell/1165\">  [Modify Memory]</a>, <a href=\"/spell/1522\"> '  [Rary's Telepathic Bond]</a>.",
      description:
        "        .            .     ,          //        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Telepathic Speech",
      shortDescription:
        "     30           .  .",
      description:
        " 1       30 ,  .  ,    ,       ,     ,     (.1). ,        .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Psionic Sorcery",
      shortDescription:
        "   ,        ( =  ).",
      description:
        " 6 ,       ,    ,   ,   .   ,    ,     (  ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Psychic Defenses",
      shortDescription: "  ;       .",
      description:
        " 6               .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Revelation in Flesh",
      shortDescription:
        "   14  ,   : / , spectral wings ( 30),   ,   (.  ).  10 .",
      description:
        " 14     14  ,    ,   10 : \n-       ,   .\n-      30 .\n-     :    120     .\n-        1   .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Warping Implosion",
      shortDescription:
        "   120 ,    30      ( )   310    . 1/  5 .",
      description:
        " 18          120 .  ,   ,  30   ,  ,   .     310            ;        .     ;    5  ,   .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Sorcerer: Clockwork Soul =====
    {
      name: "  ( )",
      engName: "Clockwork Spells",
      shortDescription:
        " : <a href=\"/spell/1306\"> [Alarm]</a>, <a href=\"/spell/1337\">     [Protection from Evil and Good]</a>, <a href=\"/spell/1259\"> [Aid]</a>, <a href=\"/spell/1281\">  [Lesser Restoration]</a>, <a href=\"/spell/1216\">  [Dispel Magic]</a>, <a href=\"/spell/1236\">   [Protection from Energy]</a>, <a href=\"/spell/1184\">  [Freedom of Movement]</a>, <a href=\"/spell/1448\">  [Summon Construct]</a>, <a href=\"/spell/1173\">  [Greater Restoration]</a>, <a href=\"/spell/1142\">  [Wall of Force]</a>.",
      description:
        "       ;          .                      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Restore Balance",
      shortDescription:
        "  60   /   ,   .  =   .",
      description:
        " 1 ,    60    ,       ,     ,   .     ;    .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: " ",
      engName: "Bastion of Law",
      shortDescription:
        "   15 ,   8.   ,  ,  8.  1 .",
      description:
        " 6     15      8 .  1 ,   ,    -   8     .  8      .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Trance of Order",
      shortDescription:
        "   1 :  9-  d20  // = 10;     . 1/  5 .",
      description:
        " 14        1 .  ,        ,      ,   ,   d20  1  9   10.     ;    5  ,   .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Clockwork Cavalcade",
      shortDescription:
        "  30-   1 :   100 ,   ,   6    (  ). 1/.",
      description:
        " 18       30-   1 . : \n-    100         .\n-      (   ).\n-    6      (  ,    ).\n         .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Sorcerer: Draconic Bloodline =====
    {
      name: "-",
      engName: "Draconic Ancestry",
      shortDescription: "  -;      ;   .",
      description:
        " 1   - (////).      .     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Draconic Resilience",
      shortDescription: "   = 13 + . ; +1    .",
      description:
        "  1     :      13 +  .  ,       1  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Elemental Affinity",
      shortDescription:
        "     ,  .     ;  1       1 .",
      description:
        " 6 ,       ,       .   1             1 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Dragon Wings",
      shortDescription: "    ( =  ); ,     .",
      description:
        " 14      ,   ,   .     .       ,     .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Draconic Presence",
      shortDescription:
        "  5 ,  60-   1  (.):      /.",
      description:
        " 18    5  ,      1  ().      60       ;        ( ),   .       .",
      displayType: [FeatureDisplayType.ACTION],
    },

    // ===== Sorcerer: Divine Soul =====
    {
      name: " ",
      engName: "Divine Magic",
      shortDescription:
        "    ;  1-   : // / /    .",
      description:
        " 1          .  ,   1-    :   <a href=\"/spell/1044\"> [Bless]</a>;   <a href=\"/spell/1336\"> [Bane]</a>;   <a href=\"/spell/1334\">  [Cure Wounds]</a>;   <a href=\"/spell/1338\">  [Inflict Wounds]</a>;   <a href=\"/spell/1337\">     [Protection from Evil and Good]</a>.         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Favored by the Gods",
      shortDescription: "     ,     24,   .",
      description:
        "  1 ,      ,   24  ,   .         .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Empowered Healing",
      shortDescription: "   5      ,     (.    ).",
      description:
        " 6 ,      5       ,    ,       (  ).     ,       (.1).",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: false,
    },
    {
      name: " ",
      engName: "Otherworldly Wings",
      shortDescription: "       ( =  ).",
      description:
        " 14         ,   ,   .     .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Unearthly Recovery",
      shortDescription:
        " ,     ,     . 1/.",
      description:
        " 18 ,       ,     ,      ( ).       .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Sorcerer: Lunar Sorcery =====
    {
      name: " ",
      engName: "Lunar Embodiment",
      shortDescription:
        "   :  <a href=\"/spell/1302\"> [Shield]</a>, <a href=\"/spell/1281\">  [Lesser Restoration]</a>, <a href=\"/spell/1216\">  [Dispel Magic]</a>, <a href=\"/spell/1193\">   [Death Ward]</a>, <a href=\"/spell/1522\"> '  [Rary's Telepathic Bond]</a>;  <a href=\"/spell/1499\">  [Ray of Sickness]</a>, <a href=\"/spell/1255\">/ [Blindness/Deafness]</a>, <a href=\"/spell/1057\">  [Vampiric Touch]</a>, <a href=\"/spell/1183\"> [Confusion]</a>, <a href=\"/spell/1143\">  [Hold Monster]</a>;  <a href=\"/spell/1335\">  [Color Spray]</a>, <a href=\"/spell/1288\">  [Alter self]</a>, <a href=\"/spell/1207\">  [phantom steed]</a>, <a href=\"/spell/1178\">  [Hallucinatory Terrain]</a>, <a href=\"/spell/1154\"> [Mislead]</a>.",
      description:
        " 1        ;         .      (//).   ,       1-     .  6          ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Moon Fire",
      shortDescription:
        " <a href=\"/spell/1056\"> ' [Sacred Flame]</a>;      5    .",
      description:
        "  1    <a href=\"/spell/1056\"> ' [Sacred Flame]</a> (    ).          5      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Lunar Boons",
      shortDescription:
        "   ,    (: /; : /; : /)   1  ,    .",
      description:
        " 6        :     ;     ;     .          ,       1 (.0).    ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: "  ",
      engName: "Waxing and Waning",
      shortDescription: "   1 ,    .",
      description:
        " 6      1  ,       .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Lunar Empowerment",
      shortDescription:
        ": ,    /  ; :   ,       ; :     .",
      description:
        " 14      :\n- :   /   10  ( 10  );               .\n- :     ;     ,     .\n- :     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Lunar Phenomenon",
      shortDescription:
        "     (:    38; : 310 ,  0,  ; :   60   ,        ). 1/  5 .",
      description:
        " 18        (     ):\n- :     30    ,        ;      38 .\n- :     30    ;    310     0     .           /.\n- :      60 ;      5 ,   ;            .\n      ,    5     .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Sorcerer: Shadow Magic =====
    {
      name: " ",
      engName: "Eyes of the Dark",
      shortDescription:
        " 120 ;  <a href=\"/spell/1249\"> [Darkness]</a>         (1   ).",
      description:
        " 1     120 .    <a href=\"/spell/1249\"> [Darkness]</a>,    ;         .      2  .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Strength of the Grave",
      shortDescription:
        "     0 ,    ( 5 +  );     1 . 1/.",
      description:
        "  1 ,        0 ,        5 +  .     1 .        .       .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: "  ",
      engName: "Hound of Ill Omen",
      shortDescription:
        "   3       :   ,          ( + .  + ). ,        .",
      description:
        " 6     3  ,  ,  ,    .    =  ,  = ,  40,   .           / ( 18 +  ).        ,   .  ,     0 ,     5 .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Shadow Walk",
      shortDescription: "     /   120 .",
      description:
        " 14 ,       ,          /,     120 .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Umbral Form",
      shortDescription:
        "   6     1 :  ,  / ;       .",
      description:
        " 18     6  ,    1 .     ,    ,          ( 5  ,     ).",
      displayType: [FeatureDisplayType.BONUSACTION],
    },

    // ===== Sorcerer: Storm Sorcery =====
    {
      name: " ",
      engName: "Wind Speaker",
      shortDescription: "   (, , , ).",
      description: " 1     ,    , ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Tempestuous Magic",
      shortDescription:
        "   1+      10   .",
      description:
        " 1 ,    1   ,       10      .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Heart of the Storm",
      shortDescription:
        "    ;    / 1+ ,   10       =  .",
      description:
        " 6        .    1   ,      ,      10      ,      ( ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Storm Guide",
      shortDescription:
        "    20  ;       100  .",
      description:
        "  6 ,   ,      20-   .   ,         100   ;       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Storm's Fury",
      shortDescription:
        ",    ,    =  ;       20   .",
      description:
        " 14 ,       ,      ,    .    ;      20     .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Wind Soul",
      shortDescription:
        "     ;   60;   1       /   30 .",
      description:
        " 18              60 .      ,    ,  30          30   1 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Sorcerer: Wild Magic =====
    {
      name: "  ",
      engName: "Wild Magic Surge",
      shortDescription:
        "             .",
      description:
        " 1           20:  1      .   (  )    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Tides of Chaos",
      shortDescription:
        "       //; ,       .",
      description:
        "  1       ,   .       .         ;     .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Bend Luck",
      shortDescription:
        "  2     14  ,    60 .",
      description:
        " 6 ,    60    ,   ,     2       14   ( )  ,   .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Controlled Chaos",
      shortDescription:
        "     ,     .",
      description:
        " 14 ,     ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Spell Bombardment",
      shortDescription:
        "       ,       ;   .",
      description:
        " 18 ,            ,         .   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Wizard: Abjuration =====
    {
      name: " ",
      engName: "Arcane Ward",
      shortDescription:
        "    1+ ,    = 2 + . ;     .",
      description:
        " 2 ,      1   ,      2     +  .     .     ,       ( ).    0 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Projected Ward",
      shortDescription:
        "       30 ,   .",
      description:
        " 6 ,     ,    30   ,      ,    .    ,   .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: "  ",
      engName: "Improved Abjuration",
      shortDescription: "     /   .",
      description:
        " 10 ,           (, <a href=\"/spell/1216\">  [Dispel Magic]</a>  <a href=\"/spell/1233\"> [Counterspell]</a>),    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Spell Resistance",
      shortDescription: "         .",
      description: " 14            -   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Wizard: Bladesinging =====
    {
      name: "   ",
      engName: "Training in War and Song",
      shortDescription: "  ,        .",
      description:
        " 2      ,         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Bladesong",
      shortDescription:
        "    1 : +  , +10  ,   , +   ;   /./. .  =   .",
      description:
        " 2         1 .  :     ;  +10 ;    ;    / .      /    .    ;    .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: "  ()",
      engName: "Extra Attack (Bladesinger)",
      shortDescription: "   ,  2 ;        1 .",
      description:
        " 6 ,   ,   .          1 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Song of Defense",
      shortDescription:
        "      ,    5   .",
      description:
        " 10 ,        ,    ;    5   .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Song of Victory",
      shortDescription: "   ,  .     .",
      description: " 14 ,    ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Wizard: Chronurgy =====
    {
      name: " ",
      engName: "Chronal Shift",
      shortDescription:
        "       30   //    .",
      description:
        " 2 ,   ,      30 ,      ;   .  ;    .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 2,
    },
    {
      name: " ",
      engName: "Temporal Awareness",
      shortDescription: "    .",
      description: " 2       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Momentary Stasis",
      shortDescription:
        "   60          0     .",
      description:
        " 6      ,    60 ,   .        0     .        .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Arcane Abeyance",
      shortDescription:
        "   3 .   (1 ),      (.  1 ),      ,   .",
      description:
        " 10 ,   3      1 ,      ,    (  1 ).      ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Convergent Future",
      shortDescription:
        "   //   60   10;   .",
      description:
        " 14      d20 ,      60   10 ( /).     1  .",
      displayType: [FeatureDisplayType.REACTION],
    },

    // ===== Wizard: Conjuration =====
    {
      name: " ",
      engName: "Minor Conjuration",
      shortDescription: "     3 , 10   1 .",
      description:
        " 2       3     10 .       ,   1      .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Benign Transposition",
      shortDescription:
        "   30       . 1/,       1+ .",
      description:
        " 6      30             30 .       ,       1    (  ).",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Focused Conjuration",
      shortDescription: "       .",
      description: " 10           .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Durable Summons",
      shortDescription: "    30  .",
      description: " 14  ,    ,  30  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Wizard: Divination =====
    {
      name: "",
      engName: "Portent",
      shortDescription:
        "   220     //         .",
      description:
        " 2       20  .   -  ,      ,  ,    .     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Expert Divination",
      shortDescription:
        "   2+ .     (. 1).",
      description:
        " 6 ,      2   ,     ,     ( 1 ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "The Third Eye",
      shortDescription:
        "       :  60;    10 ;   60;  - .",
      description:
        " 10        :  60 ;   /  10 ;    60 ;  -  .       .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Greater Portent",
      shortDescription: " 3 ( 2) 20    .",
      description: " 14    20     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Wizard: Enchantment =====
    {
      name: " ",
      engName: "Hypnotic Gaze",
      shortDescription:
        "   5  ( )   ,    0;     .",
      description:
        " 2      5 .    ;    ,     0     .  ,      .        ,   .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Instinctive Charm",
      shortDescription:
        "  ,   ,        ( ).",
      description:
        " 6 ,  ,    30 ,    ,       .       ,    ;        ,  .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Split Enchantment",
      shortDescription: "    ,   ,     .",
      description:
        " 10 ,    ,         ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Alter Memories",
      shortDescription:
        "           ( ).",
      description:
        " 14 ,    ,    .    ;    ,    ,      8  ,     (  ).",
      displayType: [FeatureDisplayType.BONUSACTION],
    },

    // ===== Wizard: Evocation =====
    {
      name: " ",
      engName: "Sculpt Spells",
      shortDescription:
        "    ,   =   +1:           .",
      description:
        " 2 ,    ,     ,    + 1.           (  ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Potent Cantrip (Evocation)",
      shortDescription: "         .",
      description: " 6         ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Empowered Evocation",
      shortDescription: " .       .",
      description:
        " 10 ,     ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "",
      engName: "Overchannel",
      shortDescription:
        "      5   ;       212     .",
      description:
        " 14 ,    5   ,   ,    .       ;         212     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Wizard: Graviturgy =====
    {
      name: " ",
      engName: "Adjust Density",
      shortDescription:
        " (., 1 ) /  /  30 : +10/-10 ,  2, /  .  10 .   .",
      description:
        " 2        (  )  30 .   +10  ,  2,    / .   -10      / .   1  ().  10      .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Gravity Well",
      shortDescription:
        "     //   ,     5 .",
      description:
        " 6 ,     ,       ,     5    ,  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Violent Attraction",
      shortDescription:
        "  110      60   +210    .  = .   .",
      description:
        " 10  ,    60    ,  110    .     60     ,  210.      (.1)   .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Event Horizon",
      shortDescription:
        " (., 1 )  30- :       210     0;    ,   +2 /.",
      description:
        " 14      30   1  ().  ,     ,   :   210     0     ;    ,       2   .         3   .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Wizard: Illusion =====
    {
      name: "  ",
      engName: "Improved Minor Illusion",
      shortDescription: " <a href=\"/spell/1351\">  [Minor Illusion]</a>;      .",
      description:
        " 2    <a href=\"/spell/1351\">  [Minor Illusion]</a> (   )         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Malleable Illusions",
      shortDescription: "    ,      .",
      description:
        " 6 ,        ,     /    ,      .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Illusory Self",
      shortDescription: "   ,   . 1/.",
      description:
        " 10 ,     ,     ;  .       .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Illusory Reality",
      shortDescription:
        "   ,       1  (   /).",
      description:
        " 14 ,      1   ,         1 .          (  ).",
      displayType: [FeatureDisplayType.BONUSACTION],
    },

    // ===== Wizard: Necromancy =====
    {
      name: " ",
      engName: "Grim Harvest",
      shortDescription:
        "   ,   = 2   (3  ). 1/,   /.",
      description:
        " 2 ,     ,   ,      ( ,    ).      .   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Undead Thralls",
      shortDescription:
        "  <a href=\"/spell/1217\">  [Animate dead]</a>,  +1 ;     =  + .    .   .",
      description:
        " 6 ,  <a href=\"/spell/1217\">  [Animate dead]</a>,    . ,  ,   ,    ,         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Inured to Undeath",
      shortDescription: "  ;     .",
      description: " 10      ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Command Undead",
      shortDescription:
        "    60  ( ,    );     .",
      description:
        " 14      60    .      ,        .            .",
      displayType: [FeatureDisplayType.ACTION],
    },

    // ===== Wizard: Order of Scribes =====
    {
      name: " ",
      engName: "Wizardly Quill",
      shortDescription: "  / ;        .",
      description:
        " 2         .    .            .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Awakened Spellbook",
      shortDescription:
        "         ,        ;       .",
      description:
        " 2 ,       ,           (  ).    ,      -,    .        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Manifest Mind",
      shortDescription:
        "      ( 10 , /  ),     ;  =      3+  .",
      description:
        " 6      ,  ,   10/  10 ,     ,  / 60    30 .      300 , .       30   /  .        .        ;    3   ,   .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: "-",
      engName: "Master Scrivener",
      shortDescription:
        "     12 .   (  1  );      .",
      description:
        " 10         1  2     ( 1 ).        .   2 ,   .       ()   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "One with the Word",
      shortDescription:
        ",   ,     :        ;     .",
      description:
        " 14 ,   ,       (. 1 ).          .  ,      .   ,   26            1    .",
      displayType: [FeatureDisplayType.REACTION],
    },

    // ===== Wizard: Transmutation =====
    {
      name: " ",
      engName: "Minor Alchemy",
      shortDescription: " 10    (///)   1        1 .",
      description:
        " 2   10 ,      , ,           1  .  1   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Transmuters Stone",
      shortDescription:
        " ,    +10  ,  60,  (////)     .",
      description:
        " 6            1+ .  : +10  ;  60 ;  , , ,   ;     .   ,        1+ .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "",
      engName: "Shapechanger",
      shortDescription:
        "  <a href=\"/spell/1189\"> [Polymorph]</a>       (   1). 1/.",
      description:
        " 10      <a href=\"/spell/1189\"> [Polymorph]</a>     .          1.       .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Master Transmuter",
      shortDescription:
        "      :   ,   (  ),  ,   24 .",
      description:
        " 14 , ,     ,   : \n-  :    ( 5 )   . \n- :  /,    <a href=\"/spell/1173\">  [Greater Restoration]</a>. \n- :     ,  . \n- :    ,     24   ( <a href=\"/spell/1157\">  [Raise Dead]</a>  ).",
      displayType: [FeatureDisplayType.ACTION],
    },

    // ===== Wizard: War Magic =====
    {
      name: " ",
      engName: "Arcane Deflection",
      shortDescription:
        "  /   +2   +4  ;        .",
      description:
        " 2 ,         ,    +2      +4  .           .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Tactical Wit",
      shortDescription: "    .",
      description: "  2       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Power Surge",
      shortDescription:
        "  ( = . )  /       ;     = 1/2  .",
      description:
        " 6     ,            .   =    (.1).    ,       ,      ( ).     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Durable Magic",
      shortDescription: "  ,  +2    .",
      description: " 10 ,  ,   +2      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Deflecting Shroud",
      shortDescription:
        "   ,        60  =   .",
      description:
        " 14 ,   ,       60 ;    ,      ( ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Druid: Circle of Dreams =====
    {
      name: "  ",
      engName: "Balm of the Summer Court",
      shortDescription:
        "        d6 (  = )    120 :    +   =  .",
      description:
        " 2        ,    d6,      .           ( )  ,      120 .            d6   1  -.        .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: "   ",
      engName: "Hearth of Moonlight and Shadow",
      shortDescription:
        "  /   30-   : +5     ,     .",
      description:
        " 6 ,     ,    30-   ,   .             +5     ()   (). -            .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Hidden Paths",
      shortDescription:
        "    60 ;      30   30 .  =     .",
      description:
        " 10     :       60    ,  .     ,    30 ,    30     .     ;    .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: " ",
      engName: "Walker in Dreams",
      shortDescription:
        "          : <a href=\"/spell/1146\"> [Dream]</a> (  ), <a href=\"/spell/1163\">  [Teleportation Circle]</a> (  )  <a href=\"/spell/1171\">  [Tree Stride]</a>.",
      description:
        " 14 ,   ,           : <a href=\"/spell/1146\"> [Dream]</a> (  ), <a href=\"/spell/1163\">  [Teleportation Circle]</a> (    ,    )  <a href=\"/spell/1171\">  [Tree Stride]</a>.          ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Druid: Circle of the Land =====
    {
      name: "  ( )",
      engName: "Bonus Cantrip (Circle of the Land)",
      shortDescription: "    .",
      description: " 2           .       ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Natural Recovery",
      shortDescription:
        "        :       ( ),    5 .",
      description:
        "  2 ,   ,      .    ,          ( ),         6   .            .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "   ",
      engName: "Circle Spells  Arctic",
      shortDescription:
        " : 3. <a href=\"/spell/1254\">  [Hold Person]</a>, <a href=\"/spell/1260\">  [Spike Growth]</a>; 5. <a href=\"/spell/1238\"> [Sleet Storm]</a>, <a href=\"/spell/1208\"> [Slow]</a>; 7. <a href=\"/spell/1184\">  [Freedom of Movement]</a>, <a href=\"/spell/1190\">  [Ice Storm]</a>; 9. <a href=\"/spell/1166\">   [Commune with Nature]</a>, <a href=\"/spell/1162\">  [Cone of Cold]</a>.",
      description:
        " 3, 5, 7  9     ,           . : \n 3 : <a href=\"/spell/1254\">  [Hold Person]</a>, <a href=\"/spell/1260\">  [Spike Growth]</a>.\n 5 : <a href=\"/spell/1238\"> [Sleet Storm]</a>, <a href=\"/spell/1208\"> [Slow]</a>.\n 7 : <a href=\"/spell/1184\">  [Freedom of Movement]</a>, <a href=\"/spell/1190\">  [Ice Storm]</a>.\n 9 : <a href=\"/spell/1166\">   [Commune with Nature]</a>, <a href=\"/spell/1162\">  [Cone of Cold]</a>.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "   ",
      engName: "Circle Spells  Coast",
      shortDescription:
        "3. <a href=\"/spell/1296\"> [Mirror Image]</a>, <a href=\"/spell/1247\">  [Misty Step]</a>; 5. <a href=\"/spell/1241\">  [Water Breathing]</a>, <a href=\"/spell/1206\">   [Water Walk]</a>; 7. <a href=\"/spell/1191\">  [Control Water]</a>, <a href=\"/spell/1184\">  [Freedom of Movement]</a>; 9. <a href=\"/spell/1170\">'  [Conjure Elemental]</a>, <a href=\"/spell/1144\"> [Scrying]</a>.",
      description:
        "  ( ): \n 3 : <a href=\"/spell/1296\"> [Mirror Image]</a>, <a href=\"/spell/1247\">  [Misty Step]</a>.\n 5 : <a href=\"/spell/1241\">  [Water Breathing]</a>, <a href=\"/spell/1206\">   [Water Walk]</a>.\n 7 : <a href=\"/spell/1191\">  [Control Water]</a>, <a href=\"/spell/1184\">  [Freedom of Movement]</a>.\n 9 : <a href=\"/spell/1170\">'  [Conjure Elemental]</a>, <a href=\"/spell/1144\"> [Scrying]</a>.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "   ",
      engName: "Circle Spells  Desert",
      shortDescription:
        "3. <a href=\"/spell/1257\"> [Blur]</a>, <a href=\"/spell/1248\"> [Silence]</a>; 5. <a href=\"/spell/1211\">    [Create Food and Water]</a>, <a href=\"/spell/1236\">   [Protection from Energy]</a>; 7. <a href=\"/spell/1179\"> [Blight]</a>, <a href=\"/spell/1178\">  [Hallucinatory Terrain]</a>; 9. <a href=\"/spell/1160\">  [Insect Plague]</a>, <a href=\"/spell/1141\">   [Wall of Stone]</a>.",
      description:
        "  ( ): \n 3 : <a href=\"/spell/1257\"> [Blur]</a>, <a href=\"/spell/1248\"> [Silence]</a>.\n 5 : <a href=\"/spell/1211\">    [Create Food and Water]</a>, <a href=\"/spell/1236\">   [Protection from Energy]</a>.\n 7 : <a href=\"/spell/1179\"> [Blight]</a>, <a href=\"/spell/1178\">  [Hallucinatory Terrain]</a>.\n 9 : <a href=\"/spell/1160\">  [Insect Plague]</a>, <a href=\"/spell/1141\">   [Wall of Stone]</a>.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "   ",
      engName: "Circle Spells  Forest",
      shortDescription:
        "3. <a href=\"/spell/1293\">  [Barkskin]</a>, <a href=\"/spell/1272\">  [Spider Climb]</a>; 5. <a href=\"/spell/1225\">  [Call Lightning]</a>, <a href=\"/spell/1213\">  [Plant Growth]</a>; 7. <a href=\"/spell/1198\"> [Divination]</a>, <a href=\"/spell/1184\">  [Freedom of Movement]</a>; 9. <a href=\"/spell/1166\">   [Commune with Nature]</a>, <a href=\"/spell/1171\">  [Tree Stride]</a>.",
      description:
        "  ( ): \n 3 : <a href=\"/spell/1293\">  [Barkskin]</a>, <a href=\"/spell/1272\">  [Spider Climb]</a>.\n 5 : <a href=\"/spell/1225\">  [Call Lightning]</a>, <a href=\"/spell/1213\">  [Plant Growth]</a>.\n 7 : <a href=\"/spell/1198\"> [Divination]</a>, <a href=\"/spell/1184\">  [Freedom of Movement]</a>.\n 9 : <a href=\"/spell/1166\">   [Commune with Nature]</a>, <a href=\"/spell/1171\">  [Tree Stride]</a>.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "   ",
      engName: "Circle Spells  Grassland",
      shortDescription:
        "3. <a href=\"/spell/1276\"> [Invisibility]</a>, <a href=\"/spell/1270\">   [Pass without Trace]</a>; 5. <a href=\"/spell/1242\">  [Daylight]</a>, <a href=\"/spell/1219\"> [Haste]</a>; 7. <a href=\"/spell/1198\"> [Divination]</a>, <a href=\"/spell/1184\">  [Freedom of Movement]</a>; 9. <a href=\"/spell/1146\"> [Dream]</a>, <a href=\"/spell/1160\">  [Insect Plague]</a>.",
      description:
        "  ( ): \n 3 : <a href=\"/spell/1276\"> [Invisibility]</a>, <a href=\"/spell/1270\">   [Pass without Trace]</a>.\n 5 : <a href=\"/spell/1242\">  [Daylight]</a>, <a href=\"/spell/1219\"> [Haste]</a>.\n 7 : <a href=\"/spell/1198\"> [Divination]</a>, <a href=\"/spell/1184\">  [Freedom of Movement]</a>.\n 9 : <a href=\"/spell/1146\"> [Dream]</a>, <a href=\"/spell/1160\">  [Insect Plague]</a>.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "   ",
      engName: "Circle Spells  Mountain",
      shortDescription:
        "3. <a href=\"/spell/1272\">  [Spider Climb]</a>, <a href=\"/spell/1043\">  [Thunderwave]</a>; 5. <a href=\"/spell/1237\">  [Lightning Bolt]</a>, <a href=\"/spell/1235\">   [Meld into Stone]</a>; 7. <a href=\"/spell/1176\">  [Stone Shape]</a>, <a href=\"/spell/1192\">'  [Stoneskin]</a>; 9. <a href=\"/spell/1145\">  [Passwall]</a>, <a href=\"/spell/1141\">   [Wall of Stone]</a>.",
      description:
        "  ( ): \n 3 : <a href=\"/spell/1272\">  [Spider Climb]</a>, <a href=\"/spell/1043\">  [Thunderwave]</a>.\n 5 : <a href=\"/spell/1237\">  [Lightning Bolt]</a>, <a href=\"/spell/1235\">   [Meld into Stone]</a>.\n 7 : <a href=\"/spell/1176\">  [Stone Shape]</a>, <a href=\"/spell/1192\">'  [Stoneskin]</a>.\n 9 : <a href=\"/spell/1145\">  [Passwall]</a>, <a href=\"/spell/1141\">   [Wall of Stone]</a>.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "   ",
      engName: "Circle Spells  Swamp",
      shortDescription:
        "3. <a href=\"/spell/1249\"> [Darkness]</a>, <a href=\"/spell/1286\">   [Melf's Acid arrow]</a>; 5. <a href=\"/spell/1206\">   [Water Walk]</a>, <a href=\"/spell/1212\">  [Stinking Cloud]</a>; 7. <a href=\"/spell/1184\">  [Freedom of Movement]</a>, <a href=\"/spell/1188\">  [Locate Creature]</a>; 9. <a href=\"/spell/1160\">  [Insect Plague]</a>, <a href=\"/spell/1144\"> [Scrying]</a>.",
      description:
        "  ( ): \n 3 : <a href=\"/spell/1249\"> [Darkness]</a>, <a href=\"/spell/1286\">   [Melf's Acid arrow]</a>.\n 5 : <a href=\"/spell/1206\">   [Water Walk]</a>, <a href=\"/spell/1212\">  [Stinking Cloud]</a>.\n 7 : <a href=\"/spell/1184\">  [Freedom of Movement]</a>, <a href=\"/spell/1188\">  [Locate Creature]</a>.\n 9 : <a href=\"/spell/1160\">  [Insect Plague]</a>, <a href=\"/spell/1144\"> [Scrying]</a>.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "   ",
      engName: "Circle Spells  Underdark",
      shortDescription:
        "3. <a href=\"/spell/1272\">  [Spider Climb]</a>, <a href=\"/spell/1273\"> [Web]</a>; 5. <a href=\"/spell/1244\">  [Gaseous Form]</a>, <a href=\"/spell/1212\">  [Stinking Cloud]</a>; 7. <a href=\"/spell/1204\">  [Greater Invisibility]</a>, <a href=\"/spell/1176\">  [Stone Shape]</a>; 9. <a href=\"/spell/1172\">  [Cloudkill]</a>, <a href=\"/spell/1160\">  [Insect Plague]</a>.",
      description:
        "  ( ): \n 3 : <a href=\"/spell/1272\">  [Spider Climb]</a>, <a href=\"/spell/1273\"> [Web]</a>.\n 5 : <a href=\"/spell/1244\">  [Gaseous Form]</a>, <a href=\"/spell/1212\">  [Stinking Cloud]</a>.\n 7 : <a href=\"/spell/1204\">  [Greater Invisibility]</a>, <a href=\"/spell/1176\">  [Stone Shape]</a>.\n 9 : <a href=\"/spell/1172\">  [Cloudkill]</a>, <a href=\"/spell/1160\">  [Insect Plague]</a>.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Lands Stride",
      shortDescription:
        "   ;     /,       .",
      description:
        " 6           .       (,   )    .      ,      ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Natures Ward",
      shortDescription: "    ;         .",
      description:
        " 10        .            .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Natures Sanctuary",
      shortDescription:
        "          ,   ;        .",
      description:
        " 14      ,     (  /  ),          .          /. ,      ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Druid: Circle of the Moon =====
    {
      name: "  ",
      engName: "Combat Wild Shape",
      shortDescription:
        "     ;           18   .",
      description:
        " 2        ,   .     ,         18     .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Circle Forms",
      shortDescription:
        "        1;  6     /3 ( ),    .",
      description:
        "  2 ,   ,         1.   6 ,         ,   3 ( ).          ,       4/8   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Primal Strike",
      shortDescription: "       .",
      description: " 6                      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Elemental Wild Shape",
      shortDescription: " 2   ,    , ,    .",
      description:
        " 10 ,   ,      ,     , ,   .        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Thousand Forms",
      shortDescription: "  <a href=\"/spell/1288\">  [Alter self]</a>      .",
      description:
        " 14     <a href=\"/spell/1288\">  [Alter self]</a>    ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Druid: Circle of the Shepherd =====
    {
      name: " ",
      engName: "Speech of the Woods",
      shortDescription: "     ;        .",
      description:
        " 2          .      ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "-",
      engName: "Spirit Totem",
      shortDescription:
        "   //  1  (30  ).  =    .",
      description:
        "  2      -  ,    60 .   1  (  ),  ,      30- .        .\n\n,   :\n :        ,  5 +   .  ,           .\n :    ,   ,   ,         .        .\n :            ,    .     ,        ,    .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: " ",
      engName: "Mighty Summoner",
      shortDescription: "      +2    ,     .",
      description:
        " 6    ,    ,  2       .               .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "-",
      engName: "Guardian Spirit",
      shortDescription:
        "  /,       -,  ,     .",
      description:
        " 10 ,    ,  ,   ,       -,   ,      ( ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Faithful Summons",
      shortDescription:
        "    0       ,   <a href=\"/spell/1239\">'  [Conjure Animals]</a> (4   2)  , 1/.",
      description:
        " 14 ,     0         ,    <a href=\"/spell/1239\">'  [Conjure Animals]</a>   9       .          2  ,     20 .  ,    (  ,     )    1 .         .",
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Druid: Circle of Spores =====
    {
      name: " ",
      engName: "Halo of Spores",
      shortDescription:
        ",        10 ,    14 (6-:16;10-:18;14-:110),        .",
      description:
        " 2          10 ,            .         ;    14  ,    .    16  6 , 18  10   110  14 .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Symbiotic Entity",
      shortDescription:
        "   ,    = 4 ;     ,      +16 . 10 .",
      description:
        "  2       ,  ,   .    ,  4    ,  10 .  ,        ,        16  .  ,    .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Fungal Infestation",
      shortDescription:
        ",  /      10 ,    1 ;  = .    .",
      description:
        " 6 ,          10   ,      .     1 -,          1 ,   .      (.1)   .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: ",  ",
      engName: "Spreading Spores",
      shortDescription:
        "   ,    10-    30   1 ;           ;     .",
      description:
        " 10 ,    ,         30    10-   1 .     -         (       ).   ,        .        30 ;     .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Fungal Body",
      shortDescription:
        "   ,    , , , ;      .",
      description:
        " 14 ,     ,     , , , .  ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Druid: Circle of Stars =====
    {
      name: " ",
      engName: "Star Map",
      shortDescription:
        " -,  <a href=\"/spell/1347\"> [Guidance]</a>,   <a href=\"/spell/1309\">  [Guiding Bolt]</a>     =    .",
      description:
        " 2      (  ,  ,  ),        .    <a href=\"/spell/1347\"> [Guidance]</a>.  ,    ,    <a href=\"/spell/1309\">  [Guiding Bolt]</a>   ,     ;    .   ,      1  ,    50 .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: " ",
      engName: "Starry Form",
      shortDescription:
        "      10   ;  :  (18+.   ),  (  18+.),  ( 9-  10  /    ).",
      description:
        "  2        ,     10  ( ).  ;     :\\n :              60 ,  18 +    .\\n :      ,      30      18 +   .\\n :             ,    d20  10   10.",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Cosmic Omen",
      shortDescription:
        "    6: 13  (-16 ), 46  (+16 )  //  30 ;  =    .",
      description:
        " 6        6,   : 13  , 46  . ,    30    ,    ,    :    16  ;    16.     ;    .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: true,
    },
    {
      name: " ",
      engName: "Twinkling Constellations",
      shortDescription:
        "          ; / / 28,     20  ( ).",
      description:
        " 10    .          .  :     28  18  /,       20    ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Full of Stars",
      shortDescription: "   ,   ,    .",
      description: " 14 ,    ,    ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Druid: Circle of Wildfire =====
    {
      name: "    ",
      engName: "Circle Spells  Wildfire",
      shortDescription:
        " : 1. <a href=\"/spell/1321\">  [Burning Hands]</a>, <a href=\"/spell/1334\">  [Cure Wounds]</a>; 3. <a href=\"/spell/1271\">  [Flaming Sphere]</a>, <a href=\"/spell/1256\">  [Scorching Ray]</a>; 5. <a href=\"/spell/1213\">  [Plant Growth]</a>, <a href=\"/spell/1245\"> [Revivify]</a>; 7. <a href=\"/spell/1514\">  [Aura of Life]</a>, <a href=\"/spell/1200\">  [Fire Shield]</a>; 9. <a href=\"/spell/1151\">'  [Flame Strike]</a>, <a href=\"/spell/1161\">   [Mass Cure Wounds]</a>.",
      description:
        "        ,      : \n 1 : <a href=\"/spell/1321\">  [Burning Hands]</a>, <a href=\"/spell/1334\">  [Cure Wounds]</a>.\n 3 : <a href=\"/spell/1271\">  [Flaming Sphere]</a>, <a href=\"/spell/1256\">  [Scorching Ray]</a>.\n 5 : <a href=\"/spell/1213\">  [Plant Growth]</a>, <a href=\"/spell/1245\"> [Revivify]</a>.\n 7 : <a href=\"/spell/1514\">  [Aura of Life]</a>, <a href=\"/spell/1200\">  [Fire Shield]</a>.\n 9 : <a href=\"/spell/1151\">'  [Flame Strike]</a>, <a href=\"/spell/1161\">   [Mass Cure Wounds]</a>.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Summon Wildfire Spirit",
      shortDescription:
        "   ,      30  ().       10       26+. .      ( ,  ).",
      description:
        " 2 ,    ,       ,          30 .      ,    ,   ,        .   ,      10           ;    26 +    ,    .            (     15 ,       ).  ,      0      .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Enhanced Bond",
      shortDescription:
        "   ,         18   ;      /    .",
      description:
        " 6 ,      ,    ,       ,   18        .        ,   ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Cauterizing Flames",
      shortDescription:
        ",   /    30     ,    (  )  1 .  ,  /  ,     210+.,     .",
      description:
        " 10 ,     /     30      ,           5    .   1     .  ,           ,    ,   :   210 +   ,       .      ,      ;      .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Blazing Revival",
      shortDescription:
        "    120       0 ,  ,     .     5   . 1/.",
      description:
        " 14 ,          ,     0 ,   ,   :   ,    ,       5   ,    .       ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    // ===== Oath of Devotion =====
    {
      name: "  ",
      engName: "Oath of Devotion Spells",
      shortDescription: "      3, 5, 9, 13, 17.",
      description:
        "       .\n\n3 : <a href=\"/spell/1437\">     [Protection from Evil and Good]</a>, <a href=\"/spell/1393\"> [Sanctuary]</a>\n5 : <a href=\"/spell/1281\">  [Lesser Restoration]</a>, <a href=\"/spell/1516\">  [Zone of Truth]</a>\n9 : <a href=\"/spell/1229\">  [Beacon of Hope]</a>, <a href=\"/spell/1169\">  [Dispel Magic]</a>\n13 : <a href=\"/spell/1184\">  [Freedom of Movement]</a>, <a href=\"/spell/1537\">  [Guardian of Faith]</a>\n17 : <a href=\"/spell/1148\">   [Commune]</a>, <a href=\"/spell/1273\">  [Flame Strike]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Sacred Weapon",
      shortDescription:
        "       1 ,     .",
      description:
        "    ,     .      ( +1)       1 .       20      20,   .  ,          ( ).",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Turn the Unholy",
      shortDescription:
        "      30       () 1 .",
      description:
        "       ,    .     30 ,     ,   .      1     .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Aura of Devotion",
      shortDescription: "    10  (30   18 )    .",
      description:
        "  7 ,       10        (Charmed),    .\n\n 18     30 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Purity of Spirit",
      shortDescription: "        ( ).",
      description:
        "  15 ,       <a href=\"/spell/1437\">     [Protection from Evil and Good]</a>.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Holy Nimbus",
      shortDescription:
        "  1 :  30 , 10      ,    /.",
      description:
        " 20       .  1       30      30.       ,   10  .  ,         ,    .\n\n      .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Oath of Glory =====
    {
      name: "  ",
      engName: "Oath of Glory Spells",
      shortDescription: "      3, 5, 9, 13, 17.",
      description:
        "       .\n\n3 : <a href=\"/spell/1439\"> [Guiding Bolt]</a>, <a href=\"/spell/1440\"> [Heroism]</a>\n5 : <a href=\"/spell/1267\">  [Enhance Ability]</a>, <a href=\"/spell/1279\">  [Magic Weapon]</a>\n9 : <a href=\"/spell/1233\"> [Haste]</a>, <a href=\"/spell/1238\">   [Protection from Energy]</a>\n13 : <a href=\"/spell/1195\">  [Compulsion]</a>, <a href=\"/spell/1184\">  [Freedom of Movement]</a>\n17 : <a href=\"/spell/1148\">   [Commune]</a>, <a href=\"/spell/1273\">  [Flame Strike]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Peerless Athlete",
      shortDescription:
        "   10 :   /,  ,  +10 .",
      description:
        "       .      10 :\n     ()   ().\n   .\n         10  (    ).",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Inspiring Smite",
      shortDescription:
        "   (Smite)    (28 + )    .",
      description:
        "      .   ,       (Divine Smite),              30  (  ).   = 28 +   .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Aura of Alacrity",
      shortDescription: "    5  (10   18 )  +10   .",
      description:
        "  7 ,      10 .  , - ,      5   ,  +10       .\n\n 18      10 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Glorious Defense",
      shortDescription:
        "  +     ;     . ( = . ).",
      description:
        " 15       .       10  ,             .   ,         (    )     .\n\n   ,     (   ).",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCountDependsOnProficiencyBonus: false,
    },
    {
      name: " ",
      engName: "Living Legend",
      shortDescription:
        "   10 :    ,   ,  .",
      description:
        " 20    .     10 :\n    .\n   ,    ,     .\n   ,    .\n\n      (    5 ).",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Oath of Redemption =====
    {
      name: "  ",
      engName: "Oath of Redemption Spells",
      shortDescription: "      3, 5, 9, 13, 17.",
      description:
        "       .\n\n3 : <a href=\"/spell/1393\"> [Sanctuary]</a>, <a href=\"/spell/1400\"> [Sleep]</a>\n5 : <a href=\"/spell/1502\">  [Calm Emotions]</a>, <a href=\"/spell/1266\">  [Hold Person]</a>\n9 : <a href=\"/spell/1202\"> [Counterspell]</a>, <a href=\"/spell/1364\">  [Hypnotic Pattern]</a>\n13 : <a href=\"/spell/1518\">   [Otiluke's Resilient Sphere]</a>, <a href=\"/spell/1291\">'  [Stoneskin]</a>\n17 : <a href=\"/spell/1255\">  [Hold Monster]</a>, <a href=\"/spell/1141\">   [Wall of Force]</a> (Wall of Force   \" \" ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Emissary of Peace",
      shortDescription: "   +5    10 .",
      description:
        "    ,   .      +5    ()  10 .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Rebuke the Violent",
      shortDescription:
        "     :     =   (  ).",
      description:
        "    ,   .   ,    30         ( ),       .      ,    ;    .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Aura of the Guardian",
      shortDescription: "     10  (30   18 )  .",
      description:
        "  7 ,       '.    10     ,         . (  ).  18     30 .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Protective Spirit",
      shortDescription: " 16 + 1/2     ,   <     .",
      description:
        "  15 ,    .   ,          ,   16 +     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Emissary of Redemption",
      shortDescription:
        "    ;     ,    .  (Rebuke)  .",
      description:
        " 20     .      ,    ( ,  ). ,    ,          -  ,           .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Oath of the Ancients =====
    {
      name: "  ",
      engName: "Oath of the Ancients Spells",
      shortDescription: "      3, 5, 9, 13, 17.",
      description:
        "       .            .\n\n3 : <a href=\"/spell/1402\"> [Ensnaring Strike]</a>, <a href=\"/spell/1435\">   [Speak with Animals]</a>\n5 : <a href=\"/spell/1278\">  [Moonbeam]</a>, <a href=\"/spell/1270\">  [Misty Step]</a>\n9 : <a href=\"/spell/1360\">   [Protection from Energy]</a>, <a href=\"/spell/1301\">  [Plant Growth]</a>\n13 : <a href=\"/spell/1190\">  [Ice Storm]</a>, <a href=\"/spell/1291\">'  [Stoneskin]</a>\n17 : <a href=\"/spell/1148\">   [Commune with Nature]</a>, <a href=\"/spell/1142\">'  [Tree Stride]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Nature's Wrath",
      shortDescription: "  ,     10  (   ).",
      description:
        "    ,    .        ,    10 .       (  ).    ;       ,   .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Turn the Faithless",
      shortDescription:
        "      30       () 1 .",
      description:
        "    ,    ,       .      :      30 ,   ,   .     (turn)  1      .\n\n       ,     ,         30 .     ,           ,   .   ,   .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Aura of Warding",
      shortDescription: "    10  (30   18 )     .",
      description:
        "  7 ,    .       10        .\n\n 18       30 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Undying Sentinel",
      shortDescription:
        "   0 ,   1  (1/);      .",
      description:
        "  15 ,      0,     ,       1 .        .\n\n ,      ,       ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Elder Champion",
      shortDescription:
        "   1 :  10 ,     ,       .",
      description:
        " 20         (    , ,   ).     1 ,  :\n       10 .\n     ,     1 ,      .\n    10                .\n\n       .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Oath of Conquest =====
    {
      name: "  ",
      engName: "Oath of Conquest Spells",
      shortDescription: "      3, 5, 9, 13, 17.",
      description:
        "       .\n\n3 : <a href=\"/spell/1497\">  [Armor of Agathys]</a>, <a href=\"/spell/1498\"> [Command]</a>\n5 : <a href=\"/spell/1266\">  [Hold Person]</a>, <a href=\"/spell/1499\">  [Spiritual Weapon]</a>\n9 : <a href=\"/spell/1140\">  [Bestow Curse]</a>, <a href=\"/spell/1460\"> [Fear]</a>\n13 : <a href=\"/spell/1149\">  [Dominate Beast]</a>, <a href=\"/spell/1291\">'  [Stoneskin]</a>\n17 : <a href=\"/spell/1077\">  [Cloudkill]</a>, <a href=\"/spell/1149\">  [Dominate Person]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Conquering Presence",
      shortDescription:
        "       30         1 .",
      description:
        "    ,   .          30 ,   ,   .       1 .        ,    .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Guided Strike",
      shortDescription: "   ,  +10   (  ,    ).",
      description:
        "    ,     .     ,   +10   .       ,     d20,   ,   ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Aura of Conquest",
      shortDescription:
        ",   ,   0    (10/30 )    .",
      description:
        "  7 ,     ,   .    10      ,     .\n\n       ,    0,     ,     ,    .\n\n 18      30 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Scornful Rebuke",
      shortDescription: "     ,     =  .",
      description:
        "  15 , ,    ,   .  ,      ,    ,     ( 1),    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Invincible Conqueror",
      shortDescription:
        "  1 :   ,     ,    1920.",
      description:
        " 20     .       1 :\n     .\n        ,           .\n         19  20  d20.\n\n       .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Oath of the Crown =====
    {
      name: "  ",
      engName: "Oath of the Crown Spells",
      shortDescription: "      3, 5, 9, 13, 17.",
      description:
        "       .\n\n3 : <a href=\"/spell/1498\"> [Command]</a>, <a href=\"/spell/1495\">   [Compelled Duel]</a>\n5 : <a href=\"/spell/1502\">  [Calm Emotions]</a>, <a href=\"/spell/1516\">  [Zone of Truth]</a>\n9 : <a href=\"/spell/1510\">  [Aura of Vitality]</a>, <a href=\"/spell/1532\">  [Spirit Guardians]</a>\n13 : <a href=\"/spell/1199\"> [Banishment]</a>, <a href=\"/spell/1537\">  [Guardian of Faith]</a>\n17 : <a href=\"/spell/1539\">  [Circle of Power]</a>, <a href=\"/spell/1541\"> [Geas]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Champion Challenge",
      shortDescription:
        "     30  ( )    30   .",
      description:
        "    ,     .            30 ,   /.    .           30   .  ,     ,       30    (,   ).",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Turn the Tide",
      shortDescription:
        "   16 + .     30  ( <  ).",
      description:
        "    ,   .     16 +        (  ,  ,   )   30 ,     .    ,        .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Divine Allegiance",
      shortDescription:
        "    ,      5   .",
      description:
        "  7 ,     5     ,       .      .          .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Unyielding Spirit",
      shortDescription: "      .",
      description:
        " 15      ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Exalted Champion",
      shortDescription:
        "  1 :  // (.),      .",
      description:
        " 20       .       1 :\n    ,       .\n     30        (death saving throws)    .\n\n      .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Oath of Vengeance =====
    {
      name: "  ",
      engName: "Oath of Vengeance Spells",
      shortDescription: "      3, 5, 9, 13, 17.",
      description:
        "       .\n\n3 : <a href=\"/spell/1042\"> [Bane]</a>, <a href=\"/spell/1283\">  [Hunter's Mark]</a>\n5 : <a href=\"/spell/1266\">  [Hold Person]</a>, <a href=\"/spell/1270\">  [Misty Step]</a>\n9 : <a href=\"/spell/1233\"> [Haste]</a>, <a href=\"/spell/1238\">   [Protection from Energy]</a>\n13 : <a href=\"/spell/1199\"> [Banishment]</a>, <a href=\"/spell/1183\">  [Dimension Door]</a>\n17 : <a href=\"/spell/1265\">  [Hold Monster]</a>, <a href=\"/spell/1144\"> [Scrying]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":   ",
      engName: "Channel Divinity: Abjure Enemy",
      shortDescription:
        "     60  ( );   0 (   ). /  .",
      description:
        ":    .      60 ,  .     (    ).      1      0 (   ).        1       .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Vow of Enmity",
      shortDescription:
        "          10   1 .",
      description:
        "   .      10   .          1 ,       0   .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Relentless Avenger",
      shortDescription:
        "   ,      (  ).",
      description:
        "  7 ,         .      (opportunity attack),            ,     .      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Soul of Vengeance",
      shortDescription:
        "      ,   .",
      description:
        "  15 , '    .  ,       ,  ,    ,        ,     .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Avenging Angel",
      shortDescription:
        "  1 :  60 ,   30  (   ;     ).",
      description:
        " 20       (,  ).     1 :\n     60 .\n      30 . ,      (  ),   .      1  (     ).   ,   24 .\n        ,  .\n\n      .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Oath of the Watchers =====
    {
      name: "  ",
      engName: "Oath of the Watchers Spells",
      shortDescription: "      3, 5, 9, 13, 17.",
      description:
        "       .\n\n3 : <a href=\"/spell/1306\"> [Alarm]</a>, <a href=\"/spell/1314\">  [Detect Magic]</a>\n5 : <a href=\"/spell/1278\">  [Moonbeam]</a>, <a href=\"/spell/1438\">  [See Invisibility]</a>\n9 : <a href=\"/spell/1202\"> [Counterspell]</a>, <a href=\"/spell/1406\"> [Nondetection]</a>\n13 : <a href=\"/spell/1510\">  [Aura of Purity]</a>, <a href=\"/spell/1199\"> [Banishment] (Aura of Purity - 4th level Paladin? No, Watchers gets Aura of Purity and Banishment)</a>\n17 : <a href=\"/spell/1266\">  [Hold Monster]</a>, <a href=\"/spell/1144\"> [Scrying]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Watcher's Will",
      shortDescription:
        "     //    (- = . )  1 .",
      description:
        "    ,   .      (  )       30 .  1          ,   .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Abjure the Extraplanar",
      shortDescription:
        "  (Turn) , , ,     30  ( ).",
      description:
        "    ,   .   , , ,     30   ,   ,    .     (turn)  1      (,   ,  ).",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Aura of the Sentinel",
      shortDescription: "    10  (30   18 )     .",
      description:
        "  7 ,   .   -    10          .\n\n 18      30 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Vigilant Rebuke",
      shortDescription:
        ",  /    //,   28 +   .",
      description:
        " 15    ,     .    ,     30 ,     ,   ,    ,     (,    ) 28 +     .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Mortal Bulwark",
      shortDescription:
        "  1 :   120 ,   ,     .",
      description:
        " 20      .     1 :\n    120 .\n      , , ,   .\n       ,       .     (  Banishment)     (   )      1  (               ,      ;   banished  ,   ).\n\n      .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Oathbreaker =====
    {
      name: " ",
      engName: "Oathbreaker Spells",
      shortDescription: "      3, 5, 9, 13, 17.",
      description:
        "       .\n\n3 : <a href=\"/spell/1496\">  [Hellish Rebuke]</a>, <a href=\"/spell/1338\">  [Inflict Wounds]</a>\n5 : <a href=\"/spell/1501\">  [Crown of Madness]</a>, <a href=\"/spell/1249\"> [Darkness]</a>\n9 : <a href=\"/spell/1149\">  [Animate Dead]</a>, <a href=\"/spell/1140\">  [Bestow Curse]</a>\n13 : <a href=\"/spell/1368\">  [Confusion]</a>, <a href=\"/spell/1223\">  [Blight] (Blight 4th lvl, Confusion 4th)</a>\n17 : <a href=\"/spell/1471\"> [Contagion]</a>, <a href=\"/spell/1149\">  [Dominate Person]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Control Undead",
      shortDescription: "    ( <  )  24  ( ).",
      description:
        "    ,   .      30 .    .       24  (       ).     (CR),       ,  .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: ":  ",
      engName: "Channel Divinity: Dreadful Aspect",
      shortDescription: "     30  ( )  1 .",
      description:
        "    ,   .        30    .      1 .         30 ,    .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Aura of Hate",
      shortDescription: "  /  10  (30  18-)  +   .",
      description:
        "  7 , ,   -      10   ,        ,     ( +1).       .\n\n 18     30 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Supernatural Resistance",
      shortDescription: " ,       .",
      description:
        " 15      ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Dread Lord",
      shortDescription:
        "  1 :   30 , 410 .   ,    ,     .",
      description:
        " 20      .     1 :\n      30   .\n  ,       ,   410  ,    .\n   ,   ,   :      .\n          :    , 310 +   .\n\n      .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ===== Hunter =====
    {
      name: " ",
      engName: "Hunter's Prey",
      shortDescription: "    :  ,  ,  .",
      description:
        " 3          :\n\n**  (Colossus Slayer)**:      .    ,       ,     ( ),     18 .\n\n**  (Giant Killer)**:         5         ,    ,         ( ,    ).\n\n**  (Horde Breaker)**:    ,     ,            ,     5          .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Defensive Tactics",
      shortDescription: " :   ,   ,  .",
      description:
        " 7       :\n\n**   (Escape the Horde)**:       .\n\n**   (Multiattack Defense)**:      ,   +4           .\n\n**  (Steel Will)**:       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "",
      engName: "Multiattack (Hunter)",
      shortDescription: " :    .",
      description:
        " 11       :\n\n** (Volley)**:        -     10   ,       .       ,      .\n\n**  (Whirlwind Attack)**:         -     5   ,     .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: "  ",
      engName: "Superior Hunter's Defense",
      shortDescription: " : ,   ,  .",
      description:
        " 15       :\n\n** (Evasion)**:     ,          (,  ),           .\n\n**   (Stand Against the Tide)**:         ,    ,            ( )   .\n\n**  (Uncanny Dodge)**:  ,   ,    ,    ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Beast Master =====
    {
      name: " ",
      engName: "Ranger's Companion",
      shortDescription:
        "  - (CR <= 1/4),     '   .",
      description:
        " 3    - (, , , ),     1/4  .        ,   .     ,   ,      (,      5+ ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Exceptional Training",
      shortDescription:
        "     ,   .    .",
      description:
        "  7 ,  - ,     ,     ,      ,   .  ,       .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Bestial Fury",
      shortDescription: "    ,     .",
      description:
        "  11 ,        ,     ,     ( ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Share Spells",
      shortDescription:
        "     ,      ,    30 .",
      description:
        "  15 ,    ,    ,        ,      30   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ===== Gloom Stalker =====
    {
      name: "   ",
      engName: "Gloom Stalker Magic",
      shortDescription: "      3, 5, 9, 13, 17.",
      description:
        "   .\n\n3 : <a href=\"/spell/1208\"> [Disguise Self]</a>\n5 : <a href=\"/spell/1429\">  [Rope Trick]</a>\n9 : <a href=\"/spell/1231\"> [Fear]</a>\n13 : <a href=\"/spell/1218\">  [Greater Invisibility]</a>\n17 : <a href=\"/spell/1440\"> [Seeming]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Dread Ambusher",
      shortDescription:
        "+  .    : +10  ,   ( +18 ).",
      description:
        " 3      ,   . ,          10 ,     ,            .     ,    18    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Umbral Sight",
      shortDescription: " 60 ( +30).    ,      .",
      description:
        " 3     60  (       30 ).  ,      :     ,    - ,    ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Iron Mind",
      shortDescription: "    ( /,   ).",
      description:
        " 7     .     .     ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Stalker's Flurry",
      shortDescription: "   ,    ,     .",
      description:
        " 11       ,    .     ,     ,            .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Shadowy Dodge",
      shortDescription:
        "         (   ).",
      description:
        " 15      .    ,      ,    ,       .       ,     .",
      displayType: [FeatureDisplayType.REACTION],
    },

    // ===== Horizon Walker =====
    {
      name: "  ",
      engName: "Horizon Walker Magic",
      shortDescription: "      3, 5, 9, 13, 17.",
      description:
        "   .\n\n3 : <a href=\"/spell/1238\">     [Protection from Evil and Good]</a>\n5 : <a href=\"/spell/1270\">  [Misty Step]</a>\n9 : <a href=\"/spell/1233\"> [Haste]</a>\n13 : <a href=\"/spell/1199\"> [Banishment]</a>\n17 : <a href=\"/spell/1279\">  [Teleportation Circle]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Detect Portal",
      shortDescription: "     1  (, ).",
      description:
        " 3               1 .     .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Planar Warrior",
      shortDescription:
        "     30 :      +18 (28  11-).",
      description:
        " 3      .      ,    30 .     ,       ,       (force),     18  .  11      28.",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Ethereal Step",
      shortDescription:
        "       (   ).   .",
      description:
        " 7       .       <a href=\"/spell/1221\"> [Etherealness]</a>,        .       .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Distant Strike",
      shortDescription:
        "    10   .    ,    .",
      description:
        " 11       .     ,     10    ,  ,    .          ,         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Spectral Defense",
      shortDescription: ",   ,       .",
      description:
        " 15       ,   .      ,    ,          (     ).",
      displayType: [FeatureDisplayType.REACTION],
    },

    // ===== Monster Slayer =====
    {
      name: "  ",
      engName: "Monster Slayer Magic",
      shortDescription: "      3, 5, 9, 13, 17.",
      description:
        "   .\n\n3 : <a href=\"/spell/1241\">     [Protection from Evil and Good]</a>\n5 : <a href=\"/spell/1286\">  [Zone of Truth]</a>\n9 : <a href=\"/spell/1267\">  [Magic Circle]</a>\n13 : <a href=\"/spell/1199\"> [Banishment]</a>\n17 : <a href=\"/spell/1265\">  [Hold Monster]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Hunter's Sense",
      shortDescription:
        "  ,      60 .",
      description:
        " 3         60       ,  (resistances)  .     ,  ,     .        .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
    },
    {
      name: " ",
      engName: "Slayer's Prey",
      shortDescription:
        "   :      +16 .",
      description:
        " 3         60 .     ,       ,    16 .  ,          .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Supernatural Defense",
      shortDescription: " 16         .",
      description:
        " 7 ,             (,   ),    16  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "-",
      engName: "Magic-User's Nemesis",
      shortDescription:
        ",   /  60 ,    ,   .",
      description:
        " 11      .   ,    60     ,         (   ).   /    .    .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Slayer's Counter",
      shortDescription:
        ",      ,   .      .",
      description:
        " 15 ,         ,         .      .   ,    ,      .",
      displayType: [FeatureDisplayType.REACTION],
    },

    // ===== Fey Wanderer =====
    {
      name: "  ",
      engName: "Fey Wanderer Magic",
      shortDescription: "      3, 5, 9, 13, 17.",
      description:
        "   .\n\n3 : <a href=\"/spell/1468\">  [Charm Person]</a>\n5 : <a href=\"/spell/1270\">  [Misty Step]</a>\n9 : <a href=\"/spell/1206\">  [Dispel Magic]</a>\n13 : <a href=\"/spell/1183\">  [Dimension Door]</a>\n17 : <a href=\"/spell/1515\">   [Mislead]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Dreadful Strikes",
      shortDescription: "+14        .",
      description:
        "  3 ,       .      ,     14  .              (    ,    ).    16  11 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Otherworldly Glamour",
      shortDescription: "     .   (, , ).",
      description:
        " 3     .  ,     ,       .        : ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Beguiling Twist",
      shortDescription:
        "    /.   (/)    ,   /  .",
      description:
        " 7      .       ,     .  ,      120 ,   ,      ,        120    .         1  (   ).",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Fey Reinforcements",
      shortDescription:
        "     (Summon Fey).          ( ,  1 ).",
      description:
        " 11      .      (Summon Fey).             .       ,    1  ( ).",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Misty Wanderer",
      shortDescription:
        "    (Misty Step)     = .      .",
      description:
        " 15      ,   .     <a href=\"/spell/1270\">  [Misty Step]</a>   .      ,     (   ).  ,     ,          5        5    .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
    },

    // ===== Swarmkeeper =====
    {
      name: "  ",
      engName: "Swarmkeeper Magic",
      shortDescription: "      3, 5, 9, 13, 17.     .",
      description:
        "   <a href=\"/spell/1262\">  [Mage Hand]</a> (  )    .\n\n3 : <a href=\"/spell/1484\">  [Faerie Fire]</a>\n5 : <a href=\"/spell/1460\"> [Web]</a>\n9 : <a href=\"/spell/1220\">  [Gaseous Form]</a>\n13 : <a href=\"/spell/1188\">  [Arcane Eye] (Swarm sees)</a> => *Correct: Arcane Eye allows seeing, logic fits.*\n17 : <a href=\"/spell/1489\">  [Insect Plague]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Gathered Swarm",
      shortDescription: "  : +16 ,    15 ( ),   5 .",
      description:
        " 3       .     ,      ,        :\n   16  .\n          15    - .\n    5     (   ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Writhing Tide",
      shortDescription:
        "    10    (hover)  1 .   ,   .",
      description:
        " 7     ,     .       10    (hover)  1 .  PB    ,    1+ .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Mighty Swarm",
      shortDescription: "  :  18,     (prone),    .",
      description:
        " 11    :\n      18.\n     ,       (prone)  .\n      ,     (half cover)    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Swarming Dispersal",
      shortDescription:
        "   :        30    .",
      description:
        " 15      ,   .    ,        (resistance)    30    . PB    .",
      displayType: [FeatureDisplayType.REACTION],
    },

    // ===== Drakewarden =====
    {
      name: " ",
      engName: "Draconic Gift",
      shortDescription:
        "   .   .",
      description:
        " 3  '   .    <a href=\"/spell/1453\"> [Thaumaturgy]</a> ( ,   [Mending],  ).   ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "-",
      engName: "Drake Companion",
      shortDescription:
        "  .     .     (     ).",
      description:
        " 3      .           .         (   ).     ,    ,        (+16).",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: "'   ",
      engName: "Bond of Fang and Scale",
      shortDescription:
        "   ()   .       .",
      description:
        " 7   .    (Medium),        (     ,    ).    .      ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Drake's Breath",
      shortDescription:
        " (  )   30: 86  ( 106  15).   ,    3+.",
      description:
        " 11     (    )   30 .    ,  86  ( )  ,    .    106  15 .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " '",
      engName: "Perfected Bond",
      shortDescription:
        "   (Large).      16.    (resistance)   ,   .",
      description:
        " 15          .      16.  ,      30   ,         (resistance)   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ==== College of Creation ====
    {
      name: " ",
      engName: "Note of Potential",
      shortDescription:
        "        (, , ).",
      description:
        " 3      .      ,    .      :\n\n** **:    ,   .\n** **:   ,      5           .\n****:         +   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Performance of Creation",
      shortDescription: "      (    )   .",
      description:
        " 3              10 .        ,    .    (20 *   ).    ,   PB.  :  (Medium).  6   ,  14  .       ,    2+ .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Animating Performance",
      shortDescription:
        "       1  (     ).",
      description:
        " 6            ,      30 .      (Dancing Item),         .      .   1 ,   0 .     ,    3+ .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Creative Crescendo",
      shortDescription:
        "      .   .",
      description:
        " 14 ,     ,     5   (   ).  ,       (GP cost).       ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ==== College of Eloquence ====
    {
      name: " ",
      engName: "Silver Tongue",
      shortDescription:
        "  10       .",
      description:
        " 3     .      ()   (), -  9    20   10.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Unsettling Words",
      shortDescription:
        "   ,         .",
      description:
        " 3        .             60 .    :             .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Unfailing Inspiration",
      shortDescription: "    ,   .",
      description:
        " 6     ,    .         ,         ,     (   ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Universal Speech",
      shortDescription: "  -      1 .",
      description:
        " 6     ,     .      ,    ,   60 .  1       ,   ,   .     ,   .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Infectious Inspiration",
      shortDescription:
        "     ,        .",
      description:
        " 14 ,    60       ,    ,       ( )     .       ,    (   ).",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
    },

    // ==== College of Glamour ====
    {
      name: " ",
      engName: "Mantle of Inspiration",
      shortDescription:
        "   :         .",
      description:
        " 3      .        ,        (  )   60    (5,   8  5-, 11  10-, 14  15- ).  ,        ,     ,   .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Enthralling Performance",
      shortDescription:
        "  1    (Wisdom save, Charmed 1 ).",
      description:
        " 3 ,     1 ,        60  (   ).         (Charmed)   1 .   ,         .   ,    ,     .    .",
      displayType: [FeatureDisplayType.ACTION], // Takes 1 minute conceptually
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Mantle of Majesty",
      shortDescription:
        "   1      (Command)    .",
      description:
        " 6       .        <a href=\"/spell/1457\"> [Command]</a>   .  1                . - ,  ,      .     .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Unbreakable Majesty",
      shortDescription:
        "   1   :     ,   .",
      description:
        " 14       .        1 .    - ,   ,     .               .         ,         .     .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },

    // ==== College of Lore ====
    {
      name: " ",
      engName: "Bonus Proficiencies (Lore)",
      shortDescription: "    -    .",
      description:
        " 3      -    .",
      displayType: [FeatureDisplayType.PASSIVE],
      skillProficiencies: { any: 3 },
    },
    {
      name: " ",
      engName: "Cutting Words",
      shortDescription:
        "  ,    ,    .",
      description:
        " 3     ,     .  ,     60 ,   ,     ,                .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: "  ",
      engName: "Additional Magical Secrets",
      shortDescription: "      - .",
      description:
        " 6          - .              .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Peerless Skill",
      shortDescription:
        "   ,   ,     .",
      description:
        " 14 ,     ,       .          .       20,      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ==== College of Spirits ====
    {
      name: " ",
      engName: "Guiding Whispers",
      shortDescription: "    (Guidance)   60 .",
      description:
        " 3        .    <a href=\"/spell/1229\"> [Guidance]</a>,         .      60 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Spiritual Focus",
      shortDescription:
        "     (+16      ).",
      description:
        " 3    ,     (, ,    )   .   6 ,     ,      ,   ,   16        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Tales from Beyond",
      shortDescription:
        "     (   ).  .   .",
      description:
        " 3      ,    .              ,    ,   .      '        .\n\n     30  (   )   .    ,         (  .     ).",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Spirit Session",
      shortDescription:
        " (1 ):       ( 5 ).",
      description:
        " 6       .     1       PB (  ).            - .       PB.        .",
      displayType: [FeatureDisplayType.ACTION], // Ritual
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " '",
      engName: "Mystical Connection",
      shortDescription:
        "  6       .",
      description:
        " 14       .      ,    6     .             .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ==== College of Swords ====
    {
      name: "  (Swords)",
      engName: "Bonus Proficiencies (Swords)",
      shortDescription: "   .   .",
      description:
        " 3        .         ,           .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  (Swords)",
      engName: "Fighting Style (Swords)",
      shortDescription: "   :     .",
      description:
        " 3       ,    :\n\n** (Dueling)**\n**   (Two-Weapon Fighting)**",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Blade Flourish",
      shortDescription:
        " : +10  .      (, , ).",
      description:
        " 3     .  ,        ,     10    .    ,       (Blade Flourish),   :\n\n** **:            .\n** **:             5 .\n** **:         5 +   ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Extra Attack (Bard)",
      shortDescription: "      ,    .",
      description:
        "  6 ,    ,    ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Master's Flourish",
      shortDescription: "       ( 6).",
      description:
        " 14 ,     ,    6     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ==== College of Valor ====
    {
      name: "  (Valor)",
      engName: "Bonus Proficiencies (Valor)",
      shortDescription: " ,    .",
      description:
        " 3      ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Combat Inspiration",
      shortDescription:
        "        ().",
      description:
        " 3       . ,     ,       . ,   ,    ,          ( ,    ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    // Note: Extra Attack is shared with Swords, usually implemented separately to avoid duplicates if ID matters, but description is same. I'll use separate entry if needed or reuse. 
    // Prisma seed logic finds by engName. If I name it 'Extra Attack (Bard)', both can link to it. I named it (Bard) above.
    {
      name: " ",
      engName: "Battle Magic",
      shortDescription: "    ,    .",
      description:
        " 14         .        ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ==== College of Whispers ====
    {
      name: " ",
      engName: "Psychic Blades",
      shortDescription:
        "  :       (26, ).",
      description:
        " 3      ,      .       ,       ,    26  .    36  5-, 56  10-  86  15- .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Words of Terror",
      shortDescription:
        "    1  ,     (1 ).",
      description:
        " 3     .        1 ,      (    ).      (Frightened)         1 .     .",
      displayType: [FeatureDisplayType.ACTION], // Speaking for 1 min
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Mantle of Whispers",
      shortDescription:
        "      .     (+)  1 .",
      description:
        " 6 ,     30   ,      .        .     ,     .        (  ).   1 .          (+5).",
      displayType: [FeatureDisplayType.REACTION], // Capture is reaction, Use is Action
      limitedUsesPer: RestType.SHORT_REST, // Once per rest effectively due to capture mechanic limits usually, but rule says 'capture' then 'use'. Capture has no limit stated other than having one shadow. Wait. "You can use this feature reaction... Once you use this feature, you can't use it again until short rest."
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Shadow Lore",
      shortDescription:
        "  :   (Charmed)  8    , ,     .",
      description:
        " 14         .         30 .      (,    ).     (Charmed)   8 .  ,      ,     (     ).  ,   .     .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ================= ARTIFICER =================

    // ==== Alchemist ====
    {
      name: " ",
      engName: "Alchemist Spells",
      shortDescription: "      (,  ).",
      description:
        "     ,    .      ,       .\n\n3 : <a href=\"/spell/1303\">  [Healing Word]</a>, <a href=\"/spell/1499\">  [Ray of Sickness]</a>\n5 : <a href=\"/spell/1271\">  [Flaming Sphere]</a>, <a href=\"/spell/1286\">   [Melf's Acid Arrow]</a>\n9 : <a href=\"/spell/1244\">  [Gaseous Form]</a>, <a href=\"/spell/1230\">   [Mass Healing Word]</a>\n13 : <a href=\"/spell/1179\"> [Blight]</a>, <a href=\"/spell/1193\">   [Death Ward]</a>\n17 : <a href=\"/spell/1172\">  [Cloudkill]</a>, <a href=\"/spell/1157\">  [Raise Dead]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Tools of the Trade (Alchemist)",
      shortDescription: "    .",
      description:
        "    .      ,          .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Experimental Elixir",
      shortDescription:
        "        (, ,  ).",
      description:
        "  3- , ,     ,          ,  .      ,    ,    .\n\n          1-   ,   .       .\n\n    ( 1 ,         ).        .",
      displayType: [FeatureDisplayType.ACTION], // Creating via slot is Action. Drinking is Action.
    },
    {
      name: " ",
      engName: "Alchemical Savant",
      shortDescription:
        " INT     (, , , )   .",
      description:
        "  5- ,       .    ,     ,         .       ( +1).    , ,     ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Restorative Reagents",
      shortDescription:
        "   .       (INT ).",
      description:
        "  9- ,         :\n\n* ,       ,       26 +    ( 1).\n*     <a href=\"/spell/1281\">  [Lesser Restoration]</a>    ,      .      ,      ( 1),        .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      // usesCount varies by INT. User handles logic? Usually usesCount is meant for static, but description implies INT.
    },
    {
      name: " ",
      engName: "Chemical Mastery",
      shortDescription:
        "  /.    . Greater Restoration/Heal  .",
      description:
        "  15- ,      ,        :\n\n*    (Resistance)      ,       (Poisoned).\n*     <a href=\"/spell/1173\">  [Greater Restoration]</a>  <a href=\"/spell/1131\"> [Heal]</a>    ,          .         ,         .",
      displayType: [FeatureDisplayType.PASSIVE], // Grants casts
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1, // Per spell.
    },

    // ==== Armorer ====
    {
      name: " ",
      engName: "Armorer Spells",
      shortDescription: "      (Magic Missile, Thunderwave ).",
      description:
        "3 : <a href=\"/spell/1333\">  [Magic Missile]</a>, <a href=\"/spell/1043\">  [Thunderwave]</a>\n5 : <a href=\"/spell/1296\"> [Mirror Image]</a>, <a href=\"/spell/1294\"> [Shatter]</a>\n9 : <a href=\"/spell/1243\">  [Hypnotic Pattern]</a>, <a href=\"/spell/1237\">  [Lightning Bolt]</a>\n13 : <a href=\"/spell/1200\">  [Fire Shield]</a>, <a href=\"/spell/1204\">  [Greater Invisibility]</a>\n17 : <a href=\"/spell/1145\">  [Passwall]</a>, <a href=\"/spell/1142\">  [Wall of Force]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Tools of the Trade (Armorer)",
      shortDescription: "     .",
      description:
        "    .      .      ,          .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Arcane Armor",
      shortDescription:
        "   :   ,  ,     ,  .",
      description:
        "  3- ,          .     ,  ,    (Arcane Armor).\n\n    ,    :\n*      ,    .\n*          .\n*            .   ,    ,    .\n\n      .  ,    .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Armor Model",
      shortDescription:
        " :  (Guardian)   (Infiltrator).   .",
      description:
        "  3- ,      .     :\n\n** (Guardian)**:    .    (Thunder Gauntlets)    (Defensive Field).\n** (Infiltrator)**:   .     (Lightning Launcher),      .\n\n     ,      ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
      // Has choices implemented via SubclassChoiceOption
    },
    {
      name: "  ()",
      engName: "Extra Attack (Armorer)",
      shortDescription: "      ,    .",
      description:
        "  5- ,    ,    , ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Armor Modifications",
      shortDescription:
        "      (,  )  . +2  (  ).",
      description:
        "  9- ,      .           : , ,     .          .\n\n ,   ,     (Infuse) ,   2,          .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Perfected Armor",
      shortDescription:
        ":   . :    (  . ).",
      description:
        "  15- ,         :\n\n** (Guardian)**:  /       30   ,        .      30      .      5   ,             .\n** (Infiltrator)**: - ,        ,  .       5        ,       .       16  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ==== Artillerist ====
    {
      name: " ",
      engName: "Artillerist Spells",
      shortDescription: "   (Shield, Thunderwave, Fireball ).",
      description:
        "3 : <a href=\"/spell/1302\"> [Shield]</a>, <a href=\"/spell/1043\">  [Thunderwave]</a>\n5 : <a href=\"/spell/1256\">  [Scorching Ray]</a>, <a href=\"/spell/1294\"> [Shatter]</a>\n9 : <a href=\"/spell/1246\"> [Fireball]</a>, <a href=\"/spell/1209\">  [Wind Wall]</a>\n13 : <a href=\"/spell/1190\">  [Ice Storm]</a>, <a href=\"/spell/1181\">  [Wall of Fire]</a>\n17 : <a href=\"/spell/1162\">  [Cone of Cold]</a>, <a href=\"/spell/1142\">  [Wall of Force]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ()",
      engName: "Tools of the Trade (Artillerist)",
      shortDescription: "  .",
      description:
        "      .    ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Eldritch Cannon",
      shortDescription:
        "   (,   ).    .",
      description:
        "  3- ,     . ,   ,    (Small)   (Tiny)    5 .\n\n   18,  (5 *  ),   /.   1     = 0.\n\n      (  15   /).\n\n :\n* ** (Flamethrower)**:  15 , 28  ( DEX ).\n* **  (Force Ballista)**:  , 120 , 28   +   5 .\n* ** (Protector)**:   10   18 + INT  .\n\n: 1  ,    1+ .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: "  ",
      engName: "Arcane Firearm",
      shortDescription:
        " /  : +18    .",
      description:
        " 5-     ,       ,    .        ,  18        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Explosive Cannon",
      shortDescription:
        "   (38).    (38 + ).",
      description:
        " 9-      :\n*      18 ( 38).\n*      .    20    ,  38   ( )  .",
      displayType: [FeatureDisplayType.PASSIVE], // Adds capability
    },
    {
      name: " ",
      engName: "Fortified Position",
      shortDescription:
        "     .      .",
      description:
        " 15-     :\n*   ( )    (+2   DEX )    10   .\n*      .       ( 2 /    +  ,    ,   ).     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ==== Battle Smith ====
    {
      name: "  ",
      engName: "Battle Smith Spells",
      shortDescription: "   (Shield, Heroism, Branding Smite ).",
      description:
        "3 : <a href=\"/spell/1047\"> [Heroism]</a>, <a href=\"/spell/1302\"> [Shield]</a>\n5 : <a href=\"/spell/1252\">  [Branding Smite]</a>, <a href=\"/spell/1274\"> ' [Warding Bond]</a>\n9 : <a href=\"/spell/1510\">  [Aura of Vitality]</a>, <a href=\"/spell/1552\">  [Conjure Barrage]</a>\n13 : <a href=\"/spell/1555\">  [Aura of Purity]</a>, <a href=\"/spell/1200\">  [Fire Shield]</a>\n17 : <a href=\"/spell/1458\">  [Banishing Smite]</a>, <a href=\"/spell/1161\">   [Mass Cure Wounds]</a>",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ( )",
      engName: "Tools of the Trade (Battle Smith)",
      shortDescription: "  .",
      description:
        "    .    ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Battle Ready",
      shortDescription:
        "  .  INT  /  .",
      description:
        "    .     ,              .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Steel Defender",
      shortDescription: " ,      ( ).",
      description:
        "   ,   .    (Medium Construct).\n*      .\n*       .\n*         (Dodge),               (Force-Empowered Rend, Repair)   .   ,   .\n*   ,      1    ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ( )",
      engName: "Extra Attack (Battle Smith)",
      shortDescription: "      .",
      description:
        "  5- ,    ,    , ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Arcane Jolt",
      shortDescription:
        "  (  )  26     26 .",
      description:
        " 9-        .             ,     ,     :\n*    26    (Force).\n*      '   30    (    ),    26 .\n\n     ,     ( 1),      .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      // usesCount: INT based
    },
    {
      name: " ",
      engName: "Improved Defender",
      shortDescription:
        "   46.   +2 .      ,   ? ,   deflect.",
      description:
        " 15-         :\n*         46.\n*     +2   .\n*         (Deflect Attack), ,  ,     14 +   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ================ ROGUE ================

    // ==== Thief ====
    {
      name: " ",
      engName: "Fast Hands",
      shortDescription: "     ,     .",
      description:
        "  3- ,     ,     (Cunning Action),     ( ),         ,     .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: "   ",
      engName: "Second-Story Work",
      shortDescription: "  ,   .",
      description:
        " 3-      ,  .       .  ,      , ,   ,    ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Supreme Sneak",
      shortDescription: "  ,        .",
      description:
        "  9- ,       (),            .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Use Magic Device",
      shortDescription: "   ,      .",
      description:
        " 13-       .      ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Thief's Reflexes",
      shortDescription: "     .",
      description:
        " 17-     ,          .        ,          10.      ,    (surprised).",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ==== Assassin ====
    {
      name: "  ()",
      engName: "Bonus Proficiencies (Assassin)",
      shortDescription: "      .",
      description:
        "      3- ,       (disguise kit)      (poisoner's kit).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "",
      engName: "Assassinate",
      shortDescription: "  ,    .    .",
      description:
        "  3- ,      .        - ,        .  , -   ,   (surprised),   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Infiltration Expertise",
      shortDescription: "    7   25 .",
      description:
        "  9- ,      .     25 ,        ,   '.       ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "",
      engName: "Impostor",
      shortDescription: "  ,     3  .",
      description:
        " 13-       ,     .         ,      .    ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Death Strike",
      shortDescription: "       ( CON).",
      description:
        " 17-      .       ,   (surprised),      (CD 8 +   +  ).       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ==== Arcane Trickster ====
    {
      name: " ( )",
      engName: "Spellcasting (Arcane Trickster)",
      shortDescription: "     (INT).",
      description:
        " 3-      .    : <a href=\"/spell/1352\">  [Mage Hand]</a>          .     1- ,          .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Mage Hand Legerdemain",
      shortDescription: "  ,       .",
      description:
        " 3-      .   ,       :\n*   ,   ,  ,      .\n*      .\n*           .\n     ,    ( )   ().  ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Magical Ambush",
      shortDescription: "     ,   .",
      description:
        "  9- ,     ,     ,     -       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Versatile Trickster",
      shortDescription: "        .",
      description:
        " 13-         .            5   .              .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Spell Thief",
      shortDescription: "  ,    .",
      description:
        " 17-        .    ,      ,            CD   .       ,      8 .     ,    ,   .",
      displayType: [FeatureDisplayType.REACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ==== Inquisitive ====
    {
      name: "  ",
      engName: "Ear for Deceit",
      shortDescription: " 10        .",
      description:
        "      3- ,      .      (),  ,   ,  7      8.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Eye for Detail",
      shortDescription: "      .",
      description:
        " 3-      ,     (),      ',    (),     .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Insightful Fighting",
      shortDescription: "       .",
      description:
        " 3-       .        ()   () ,        .         (Sneak Attack)   ,         ,   .    1           .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Steady Eye",
      shortDescription: "  ,         .",
      description:
        "  9- ,       ()   (),            .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Unerring Eye",
      shortDescription: "     .",
      description:
        " 13-     ,     .     ,       30   .  ,    ,       .       ,      ( 1),      .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      // usesCount based on WIS
    },
    {
      name: "  ",
      engName: "Eye for Weakness",
      shortDescription: "       .",
      description:
        " 17-         .       ,       (Insightful Fighting),      36.",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ==== Mastermind ====
    {
      name: "  ()",
      engName: "Master of Intrigue",
      shortDescription: "  ,      .  .",
      description:
        "      3- ,       (disguise kit),    (forgery kit)       .        .  ,         ,      1 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Master of Tactics",
      shortDescription: "      30 .",
      description:
        "  3- ,          (Help).      ,   ,       30   ,   5 .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Insightful Manipulator",
      shortDescription: "    1  .",
      description:
        "  9- ,           1 ,   ,             (  ):\n*  \n*  \n*  \n*   ( ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Misdirection",
      shortDescription: "    ,    .",
      description:
        "  13- ,          .     ,      5       (cover)   ,    ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Soul of Deceit",
      shortDescription: "      .",
      description:
        " 17-            ,     .     ,  ,    .   ,     ,    ,   ,    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ==== Scout ====
    {
      name: "",
      engName: "Skirmisher",
      shortDescription: "     ,     .",
      description:
        "  3- ,     .        5   ,     ,        .       .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: "",
      engName: "Survivalist",
      shortDescription: "       .",
      description:
        " 3-     .      (Nature)   (Survival).      -  ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Superior Mobility",
      shortDescription: "+10     ( /).",
      description:
        " 9-       10 .        ,     10 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Ambush Master",
      shortDescription: "  .       .",
      description:
        "  13- ,      .  ,  ,         ,      :           .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Sudden Strike",
      shortDescription: "       .",
      description:
        " 17-       .        ,        .        (Sneak Attack),         ,                 .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },

    // ==== Phantom ====
    {
      name: " ",
      engName: "Whispers from the Dead",
      shortDescription: "       .",
      description:
        " 3-       .       ,           ,        .   ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Wails from the Grave",
      shortDescription: "        .",
      description:
        " 3- ,       (Sneak Attack),           30   .     ,         ( ).       ,     ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      // usesCount based on Proficiency Bonus
    },
    {
      name: " ",
      engName: "Tokens of the Departed",
      shortDescription: "       .",
      description:
        " 9- ,    30     ,           (,   ).     ,      .    :\n*         .\n*    ,     ,     .\n*     ,      (     ).",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " ",
      engName: "Ghost Walk",
      shortDescription: "  :     .",
      description:
        " 13-     .       10 .     10 ,      ' ( ,    ),       .         ,     .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Death's Friend",
      shortDescription: "       .   .",
      description:
        " 17-   '    . ,      ,       ,   .  ,         ,   '  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // ==== Soulknife ====
    {
      name: " ",
      engName: "Psychic Whispers",
      shortDescription: "  '  .",
      description:
        " 3-      '.     ,    (   )   30 .        ,     . '  1 .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Psychic Blades",
      shortDescription: "     .",
      description:
        " 3-        .     ,           ( 16 ).    .        ,          ( 14).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Soul Blades",
      shortDescription: "       .",
      description:
        " 9-         .      , :\n*      ,   .\n*   ,     ,   5.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Psychic Veil",
      shortDescription: "   1 .",
      description:
        " 13-     .          1             .        ,      .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Rend Mind",
      shortDescription: "     ( WIS).",
      description:
        " 17-       .       (Sneak Attack)    ,        (CD 8 +   +  ).      (Stunned)  1 .        ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // ==== Swashbuckler ====
    {
      name: "  ",
      engName: "Fancy Footwork",
      shortDescription: ",      ,       .",
      description:
        " 3-        .           ,         (attacks of opportunity)      ,   ,   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Rakish Audacity",
      shortDescription: "   .     1  1.",
      description:
        " 3-       .        .  ,      (Sneak Attack),      5   ,        5   ,        .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "",
      engName: "Panache",
      shortDescription: "      .",
      description:
        " 9-     .      ()   () ,   :\n*   ,                   1 .\n*    ,   (Charmed)   1 .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Elegant Maneuver",
      shortDescription: "         .",
      description:
        " 13-      ,        ()   (),        .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Master Duelist",
      shortDescription: "    .",
      description:
        " 17-          .     ,      .       .",
      displayType: [FeatureDisplayType.PASSIVE],
      limitedUsesPer: RestType.SHORT_REST,
      usesCount: 1,
    },

    // ==== Monk Features ====

    // Way of Mercy
    {
      name: " ",
      engName: "Implements of Mercy",
      shortDescription: "    ,    .",
      description:
        "      ,     .     ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Hand of Harm",
      shortDescription: " 1 ,         .",
      description:
        "   ,   .        ,    1  ,     ,         +   .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Hand of Healing",
      shortDescription: " 1 ,     .",
      description:
        "     .     1  ,        ,        +   .     ,               .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Physician's Touch",
      shortDescription: "   ,   .",
      description:
        "      .     ,           ,    : , , ,   .\n\n    ,           .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "   ",
      engName: "Flurry of Healing and Harm",
      shortDescription: "          .",
      description:
        "        .     ,                   .  ,          ,             (      ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Hand of Ultimate Mercy",
      shortDescription: "    5  .",
      description:
        "       .      ,      24  ,   5  .    ,   ,   410 +   .   ,    -   ,    : , , , , .    ,          .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },

    // Way of the Ascendant Dragon
    {
      name: " ",
      engName: "Draconic Disciple",
      shortDescription: " /,    ,  .",
      description:
        "   .    :\n\n** .**      ()   (),    ,   ,     .    ,          ,    1  .\n\n** .**       ,       , , ,   .\n\n** .**         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Breath of the Dragon",
      shortDescription: "     (  ).",
      description:
        "     .        ,           20-   30-   5 .   : , , ,   .             ,  ,          ,    .\n\n      ,     ,      .       2  .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 2, // Initial proficiency bonus, scales automatically if handled elsewhere, otherwise static for now
    },
    {
      name: " ",
      engName: "Wings Unfurled",
      shortDescription: "      .",
      description:
        "    ,         ,      .   ,    ,     .       ,     ,      .       1  .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Aspect of the Wyrm",
      shortDescription: "     .",
      description:
        "     .        ,   1       :\n\n** .**       10   ,                .\n\n** .**  , , ,   .       10      .\n\n   ,          ,    3  .",
      displayType: [FeatureDisplayType.BONUSACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: " ",
      engName: "Ascendant Aspect",
      shortDescription: ",     .",
      description:
        " '     :\n\n**.**      10 .         ,      .\n\n** .**     ,     .         .\n\n** .**     ,     30 .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // Way of the Astral Self
    {
      name: "  \"\"",
      engName: "Arms of the Astral Self",
      shortDescription: "      .",
      description:
        "     1  ,      \"\".    ,        10          24  .   10 .   :\n\n-             .\n-        .\n-       ,     5 .\n-       ,               .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: "  \"\"",
      engName: "Visage of the Astral Self",
      shortDescription: "     .",
      description:
        "  (     )    1  ,      \"\".    :\n\n** .**           120 .\n\n** .**       ()   ().\n\n** .**    ,      ,      60 .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: "  \"\"",
      engName: "Body of the Astral Self",
      shortDescription: "      .",
      description:
        "     ,  ,       \"\" (  ).   :\n\n** .**     , , , ,   ,       110 +    +   .\n\n** .**    ,       \"\",     ,       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  \"\"",
      engName: "Awakened Astral Self",
      shortDescription: "+2       .",
      description:
        "       \"\" (,   ),  :\n\n** .**   +2   .\n\n** .**        ,         \"\" (  ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // Way of the Drunken Master
    {
      name: "  (' )",
      engName: "Bonus Proficiencies (Drunken Master)",
      shortDescription: "     .",
      description:
        "       .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "' ",
      engName: "Drunken Technique",
      shortDescription: "     +10  .",
      description:
        "    ,     ,       10     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Tipsy Sway",
      shortDescription: "    .",
      description:
        "   ,  .    :\n\n**  .**     ,   ,   5  .\n\n** .**          ,    1   ,            ( ),      5   .",
      displayType: [FeatureDisplayType.REACTION],
    },
    {
      name: " '",
      engName: "Drunkard's Luck",
      shortDescription: "     2 .",
      description:
        "    ,      ,    2  ,      .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "' ",
      engName: "Intoxicated Frenzy",
      shortDescription: " 5       .",
      description:
        "    ,        ( 5),  ,         .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // Way of the Four Elements
    {
      name: " ",
      engName: "Disciple of the Elements",
      shortDescription: "   ,   .",
      description:
        "   ,     .           .      6, 11  17 .\n\n   ,      ,   8 +    +   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    // Elemental Disciplines will be handled via Choices

    // Way of the Kensei
    {
      name: " ",
      engName: "Path of the Kensei",
      shortDescription: " ,  ,  .",
      description:
        "     :\n\n** .**     (     ),      .    ,    .      .      6, 11  17 .\n\n** .**          ,     ,   +2       .\n\n** .**             .       14    .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "One with the Blade",
      shortDescription: "     .",
      description:
        "     .  ,       ,    1  ,    ,     .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Sharpen the Blade",
      shortDescription: " ,        .",
      description:
        "      3  ,    ,   ,      ,     .   1 .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Unerring Accuracy",
      shortDescription: "      .",
      description:
        "    ,   ,    .          .",
      displayType: [FeatureDisplayType.PASSIVE],
    },

    // Way of the Long Death
    {
      name: " ",
      engName: "Touch of Death",
      shortDescription: "     .",
      description:
        "       5     0,    ,      +   .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Hour of Reaping",
      shortDescription: "     30 .",
      description:
        "     ,   .     30   ,    ,             .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Mastery of Death",
      shortDescription: " 1 ,    1   0.",
      description:
        "     0,    1   (  ),        1.",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: "  ",
      engName: "Touch of the Long Death",
      shortDescription: " 1-10 ,     .",
      description:
        "       5     1  10  .     ,  210         ,    .",
      displayType: [FeatureDisplayType.ACTION],
    },

    // Way of the Open Hand
    {
      name: "  ",
      engName: "Open Hand Technique",
      shortDescription: "     (  , ,  ).",
      description:
        "        ,        :\n\n-          .\n-          15   .\n-          .",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Wholeness of Body",
      shortDescription: "  (3 *  ) .",
      description:
        "       ,     ,   3.     ,       .",
      displayType: [FeatureDisplayType.ACTION],
      limitedUsesPer: RestType.LONG_REST,
      usesCount: 1,
    },
    {
      name: "",
      engName: "Tranquility",
      shortDescription: "     .",
      description:
        "      .          (      ).         (      ).",
      displayType: [FeatureDisplayType.PASSIVE],
    },
    {
      name: " ",
      engName: "Quivering Palm",
      shortDescription: "    .",
      description:
        "        .        ,    3  ,    .    ,     .   ,     .     .      0 .     1010  .",
      displayType: [FeatureDisplayType.ACTION],
    },

    // Way of Shadow
    {
      name: " ",
      engName: "Shadow Arts",
      shortDescription: ",      2 .",
      description:
        "        .     2  ,   , ,    ,    .  ,     .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Shadow Step",
      shortDescription: "    60 .",
      description:
        "        .        ,         60    ,            .             .",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: " ",
      engName: "Cloak of Shadows",
      shortDescription: "   .",
      description:
        "       ,     .   ,   ,          .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: "",
      engName: "Opportunist",
      shortDescription: "     .",
      description:
        "   ,   .     5         ,  ,    ,        .",
      displayType: [FeatureDisplayType.REACTION],
    },

    // Way of the Sun Soul
    {
      name: "  ",
      engName: "Radiant Sun Bolt",
      shortDescription: "  ,    .",
      description:
        "      .    ,     .       30 .            .   ,        .            ,    1  ,         .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: "  ",
      engName: "Searing Arc Strike",
      shortDescription: "      .",
      description:
        "  ,        ,    2  ,       .      ,     (    ,  ).",
      displayType: [FeatureDisplayType.BONUSACTION],
    },
    {
      name: "  ",
      engName: "Searing Sunburst",
      shortDescription: "    20 .",
      description:
        "    .      20        150     .   26    .      .    ,   .   ( 3)  26 .",
      displayType: [FeatureDisplayType.ACTION],
    },
    {
      name: " ",
      engName: "Sun Shield",
      shortDescription: " ,    .",
      description:
        "  .      30      30.        .        ,   ,       ,   5 +   .",
      displayType: [FeatureDisplayType.REACTION],
    },
  ]
  const links: SubclassFeatureLink[] = [
    // College of Creation
    { subclass: Subclasses.COLLEGE_OF_CREATION, feature: "Note of Potential", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_CREATION, feature: "Performance of Creation", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_CREATION, feature: "Animating Performance", level: 6 },
    { subclass: Subclasses.COLLEGE_OF_CREATION, feature: "Creative Crescendo", level: 14 },

    // College of Eloquence
    { subclass: Subclasses.COLLEGE_OF_ELOQUENCE, feature: "Silver Tongue", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_ELOQUENCE, feature: "Unsettling Words", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_ELOQUENCE, feature: "Unfailing Inspiration", level: 6 },
    { subclass: Subclasses.COLLEGE_OF_ELOQUENCE, feature: "Universal Speech", level: 6 },
    { subclass: Subclasses.COLLEGE_OF_ELOQUENCE, feature: "Infectious Inspiration", level: 14 },

    // College of Glamour
    { subclass: Subclasses.COLLEGE_OF_GLAMOUR, feature: "Mantle of Inspiration", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_GLAMOUR, feature: "Enthralling Performance", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_GLAMOUR, feature: "Mantle of Majesty", level: 6 },
    { subclass: Subclasses.COLLEGE_OF_GLAMOUR, feature: "Unbreakable Majesty", level: 14 },

    // College of Lore
    { subclass: Subclasses.COLLEGE_OF_LORE, feature: "Bonus Proficiencies (Lore)", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_LORE, feature: "Cutting Words", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_LORE, feature: "Additional Magical Secrets", level: 6 },
    { subclass: Subclasses.COLLEGE_OF_LORE, feature: "Peerless Skill", level: 14 },

    // College of Spirits
    { subclass: Subclasses.COLLEGE_OF_SPIRITS, feature: "Guiding Whispers", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_SPIRITS, feature: "Spiritual Focus", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_SPIRITS, feature: "Tales from Beyond", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_SPIRITS, feature: "Spirit Session", level: 6 },
    { subclass: Subclasses.COLLEGE_OF_SPIRITS, feature: "Mystical Connection", level: 14 },

    // College of Swords
    { subclass: Subclasses.COLLEGE_OF_SWORDS, feature: "Bonus Proficiencies (Swords)", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_SWORDS, feature: "Fighting Style (Swords)", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_SWORDS, feature: "Blade Flourish", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_SWORDS, feature: "Extra Attack (Bard)", level: 6 },
    { subclass: Subclasses.COLLEGE_OF_SWORDS, feature: "Master's Flourish", level: 14 },

    // College of Valor
    { subclass: Subclasses.COLLEGE_OF_VALOR, feature: "Bonus Proficiencies (Valor)", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_VALOR, feature: "Combat Inspiration", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_VALOR, feature: "Extra Attack (Bard)", level: 6 },
    { subclass: Subclasses.COLLEGE_OF_VALOR, feature: "Battle Magic", level: 14 },

    // College of Whispers
    { subclass: Subclasses.COLLEGE_OF_WHISPERS, feature: "Psychic Blades", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_WHISPERS, feature: "Words of Terror", level: 3 },
    { subclass: Subclasses.COLLEGE_OF_WHISPERS, feature: "Mantle of Whispers", level: 6 },
    { subclass: Subclasses.COLLEGE_OF_WHISPERS, feature: "Shadow Lore", level: 14 },
    // Beast Master
    { subclass: Subclasses.BEAST_MASTER_CONCLAVE, feature: "Ranger's Companion", level: 3 },
    { subclass: Subclasses.BEAST_MASTER_CONCLAVE, feature: "Exceptional Training", level: 7 },
    { subclass: Subclasses.BEAST_MASTER_CONCLAVE, feature: "Bestial Fury", level: 11 },
    { subclass: Subclasses.BEAST_MASTER_CONCLAVE, feature: "Share Spells", level: 15 },

    // Drakewarden
    { subclass: Subclasses.DRAKEWARDEN, feature: "Draconic Gift", level: 3 },
    { subclass: Subclasses.DRAKEWARDEN, feature: "Drake Companion", level: 3 },
    { subclass: Subclasses.DRAKEWARDEN, feature: "Bond of Fang and Scale", level: 7 },
    { subclass: Subclasses.DRAKEWARDEN, feature: "Drake's Breath", level: 11 },
    { subclass: Subclasses.DRAKEWARDEN, feature: "Perfected Bond", level: 15 },

    // Fey Wanderer
    { subclass: Subclasses.FEY_WANDERER, feature: "Fey Wanderer Magic", level: 3 },
    { subclass: Subclasses.FEY_WANDERER, feature: "Dreadful Strikes", level: 3 },
    { subclass: Subclasses.FEY_WANDERER, feature: "Otherworldly Glamour", level: 3 },
    { subclass: Subclasses.FEY_WANDERER, feature: "Beguiling Twist", level: 7 },
    { subclass: Subclasses.FEY_WANDERER, feature: "Fey Reinforcements", level: 11 },
    { subclass: Subclasses.FEY_WANDERER, feature: "Misty Wanderer", level: 15 },

    // Gloom Stalker
    { subclass: Subclasses.GLOOM_STALKER_CONCLAVE, feature: "Gloom Stalker Magic", level: 3 },
    { subclass: Subclasses.GLOOM_STALKER_CONCLAVE, feature: "Dread Ambusher", level: 3 },
    { subclass: Subclasses.GLOOM_STALKER_CONCLAVE, feature: "Umbral Sight", level: 3 },
    { subclass: Subclasses.GLOOM_STALKER_CONCLAVE, feature: "Iron Mind", level: 7 },
    { subclass: Subclasses.GLOOM_STALKER_CONCLAVE, feature: "Stalker's Flurry", level: 11 },
    { subclass: Subclasses.GLOOM_STALKER_CONCLAVE, feature: "Shadowy Dodge", level: 15 },

    // Horizon Walker
    { subclass: Subclasses.HORIZON_WALKER_CONCLAVE, feature: "Horizon Walker Magic", level: 3 },
    { subclass: Subclasses.HORIZON_WALKER_CONCLAVE, feature: "Detect Portal", level: 3 },
    { subclass: Subclasses.HORIZON_WALKER_CONCLAVE, feature: "Planar Warrior", level: 3 },
    { subclass: Subclasses.HORIZON_WALKER_CONCLAVE, feature: "Ethereal Step", level: 7 },
    { subclass: Subclasses.HORIZON_WALKER_CONCLAVE, feature: "Distant Strike", level: 11 },
    { subclass: Subclasses.HORIZON_WALKER_CONCLAVE, feature: "Spectral Defense", level: 15 },

    // Hunter
    { subclass: Subclasses.HUNTER_CONCLAVE, feature: "Hunter's Prey", level: 3 },
    { subclass: Subclasses.HUNTER_CONCLAVE, feature: "Defensive Tactics", level: 7 },
    { subclass: Subclasses.HUNTER_CONCLAVE, feature: "Multiattack (Hunter)", level: 11 },
    { subclass: Subclasses.HUNTER_CONCLAVE, feature: "Superior Hunter's Defense", level: 15 },

    // Monster Slayer
    { subclass: Subclasses.MONSTER_SLAYER_CONCLAVE, feature: "Monster Slayer Magic", level: 3 },
    { subclass: Subclasses.MONSTER_SLAYER_CONCLAVE, feature: "Hunter's Sense", level: 3 },
    { subclass: Subclasses.MONSTER_SLAYER_CONCLAVE, feature: "Slayer's Prey", level: 3 },
    { subclass: Subclasses.MONSTER_SLAYER_CONCLAVE, feature: "Supernatural Defense", level: 7 },
    { subclass: Subclasses.MONSTER_SLAYER_CONCLAVE, feature: "Magic-User's Nemesis", level: 11 },
    { subclass: Subclasses.MONSTER_SLAYER_CONCLAVE, feature: "Slayer's Counter", level: 15 },

    // Swarmkeeper
    { subclass: Subclasses.SWARMKEEPER, feature: "Swarmkeeper Magic", level: 3 },
    { subclass: Subclasses.SWARMKEEPER, feature: "Gathered Swarm", level: 3 },
    { subclass: Subclasses.SWARMKEEPER, feature: "Writhing Tide", level: 7 },
    { subclass: Subclasses.SWARMKEEPER, feature: "Mighty Swarm", level: 11 },
    { subclass: Subclasses.SWARMKEEPER, feature: "Swarming Dispersal", level: 15 },

    // Oath of the Ancients
    { subclass: Subclasses.OATH_OF_THE_ANCIENTS, feature: "Oath of the Ancients Spells", level: 3 },
    { subclass: Subclasses.OATH_OF_THE_ANCIENTS, feature: "Channel Divinity: Nature's Wrath", level: 3 },
    { subclass: Subclasses.OATH_OF_THE_ANCIENTS, feature: "Channel Divinity: Turn the Faithless", level: 3 },
    { subclass: Subclasses.OATH_OF_THE_ANCIENTS, feature: "Aura of Warding", level: 7 },
    { subclass: Subclasses.OATH_OF_THE_ANCIENTS, feature: "Undying Sentinel", level: 15 },
    { subclass: Subclasses.OATH_OF_THE_ANCIENTS, feature: "Elder Champion", level: 20 },

    // Oath of Conquest
    { subclass: Subclasses.OATH_OF_CONQUEST, feature: "Oath of Conquest Spells", level: 3 },
    { subclass: Subclasses.OATH_OF_CONQUEST, feature: "Channel Divinity: Conquering Presence", level: 3 },
    { subclass: Subclasses.OATH_OF_CONQUEST, feature: "Channel Divinity: Guided Strike", level: 3 },
    { subclass: Subclasses.OATH_OF_CONQUEST, feature: "Aura of Conquest", level: 7 },
    { subclass: Subclasses.OATH_OF_CONQUEST, feature: "Scornful Rebuke", level: 15 },
    { subclass: Subclasses.OATH_OF_CONQUEST, feature: "Invincible Conqueror", level: 20 },

    // Oath of the Crown
    { subclass: Subclasses.OATH_OF_THE_CROWN, feature: "Oath of the Crown Spells", level: 3 },
    { subclass: Subclasses.OATH_OF_THE_CROWN, feature: "Channel Divinity: Champion Challenge", level: 3 },
    { subclass: Subclasses.OATH_OF_THE_CROWN, feature: "Channel Divinity: Turn the Tide", level: 3 },
    { subclass: Subclasses.OATH_OF_THE_CROWN, feature: "Divine Allegiance", level: 7 },
    { subclass: Subclasses.OATH_OF_THE_CROWN, feature: "Unyielding Spirit", level: 15 },
    { subclass: Subclasses.OATH_OF_THE_CROWN, feature: "Exalted Champion", level: 20 },

    // Oath of Devotion
    { subclass: Subclasses.OATH_OF_DEVOTION, feature: "Oath of Devotion Spells", level: 3 },
    { subclass: Subclasses.OATH_OF_DEVOTION, feature: "Channel Divinity: Sacred Weapon", level: 3 },
    { subclass: Subclasses.OATH_OF_DEVOTION, feature: "Channel Divinity: Turn the Unholy", level: 3 },
    { subclass: Subclasses.OATH_OF_DEVOTION, feature: "Aura of Devotion", level: 7 },
    { subclass: Subclasses.OATH_OF_DEVOTION, feature: "Purity of Spirit", level: 15 },
    { subclass: Subclasses.OATH_OF_DEVOTION, feature: "Holy Nimbus", level: 20 },

    // Oath of Glory
    { subclass: Subclasses.OATH_OF_GLORY, feature: "Oath of Glory Spells", level: 3 },
    { subclass: Subclasses.OATH_OF_GLORY, feature: "Channel Divinity: Peerless Athlete", level: 3 },
    { subclass: Subclasses.OATH_OF_GLORY, feature: "Channel Divinity: Inspiring Smite", level: 3 },
    { subclass: Subclasses.OATH_OF_GLORY, feature: "Aura of Alacrity", level: 7 },
    { subclass: Subclasses.OATH_OF_GLORY, feature: "Glorious Defense", level: 15 },
    { subclass: Subclasses.OATH_OF_GLORY, feature: "Living Legend", level: 20 },

    // Oath of Redemption
    { subclass: Subclasses.OATH_OF_REDEMPTION, feature: "Oath of Redemption Spells", level: 3 },
    { subclass: Subclasses.OATH_OF_REDEMPTION, feature: "Channel Divinity: Emissary of Peace", level: 3 },
    { subclass: Subclasses.OATH_OF_REDEMPTION, feature: "Channel Divinity: Rebuke the Violent", level: 3 },
    { subclass: Subclasses.OATH_OF_REDEMPTION, feature: "Aura of the Guardian", level: 7 },
    { subclass: Subclasses.OATH_OF_REDEMPTION, feature: "Protective Spirit", level: 15 },
    { subclass: Subclasses.OATH_OF_REDEMPTION, feature: "Emissary of Redemption", level: 20 },

    // Oath of Vengeance
    { subclass: Subclasses.OATH_OF_VENGEANCE, feature: "Oath of Vengeance Spells", level: 3 },
    { subclass: Subclasses.OATH_OF_VENGEANCE, feature: "Channel Divinity: Abjure Enemy", level: 3 },
    { subclass: Subclasses.OATH_OF_VENGEANCE, feature: "Channel Divinity: Vow of Enmity", level: 3 },
    { subclass: Subclasses.OATH_OF_VENGEANCE, feature: "Relentless Avenger", level: 7 },
    { subclass: Subclasses.OATH_OF_VENGEANCE, feature: "Soul of Vengeance", level: 15 },
    { subclass: Subclasses.OATH_OF_VENGEANCE, feature: "Avenging Angel", level: 20 },

    // Oath of the Watchers
    { subclass: Subclasses.OATH_OF_THE_WATCHERS, feature: "Oath of the Watchers Spells", level: 3 },
    { subclass: Subclasses.OATH_OF_THE_WATCHERS, feature: "Channel Divinity: Watcher's Will", level: 3 },
    { subclass: Subclasses.OATH_OF_THE_WATCHERS, feature: "Channel Divinity: Abjure the Extraplanar", level: 3 },
    { subclass: Subclasses.OATH_OF_THE_WATCHERS, feature: "Aura of the Sentinel", level: 7 },
    { subclass: Subclasses.OATH_OF_THE_WATCHERS, feature: "Vigilant Rebuke", level: 15 },
    { subclass: Subclasses.OATH_OF_THE_WATCHERS, feature: "Mortal Bulwark", level: 20 },

    // Oathbreaker
    { subclass: Subclasses.OATHBREAKER, feature: "Oathbreaker Spells", level: 3 },
    { subclass: Subclasses.OATHBREAKER, feature: "Channel Divinity: Control Undead", level: 3 },
    { subclass: Subclasses.OATHBREAKER, feature: "Channel Divinity: Dreadful Aspect", level: 3 },
    { subclass: Subclasses.OATHBREAKER, feature: "Aura of Hate", level: 7 },
    { subclass: Subclasses.OATHBREAKER, feature: "Supernatural Resistance", level: 15 },
    { subclass: Subclasses.OATHBREAKER, feature: "Dread Lord", level: 20 },

    // Arcane Archer
    { subclass: Subclasses.ARCANE_ARCHER, feature: "Arcane Archer Lore", level: 3 },
    { subclass: Subclasses.ARCANE_ARCHER, feature: "Arcane Shot", level: 3 },
    { subclass: Subclasses.ARCANE_ARCHER, feature: "Magic Arrow", level: 7 },
    { subclass: Subclasses.ARCANE_ARCHER, feature: "Curving Shot", level: 7 },
    { subclass: Subclasses.ARCANE_ARCHER, feature: "Ever-Ready Shot", level: 15 },

    // Banneret
    { subclass: Subclasses.BANNERET, feature: "Rallying Cry", level: 3 },
    { subclass: Subclasses.BANNERET, feature: "Royal Envoy", level: 7 },
    { subclass: Subclasses.BANNERET, feature: "Inspiring Surge", level: 10 },
    { subclass: Subclasses.BANNERET, feature: "Bulwark (Banneret)", level: 15 },

    // Battle Master
    { subclass: Subclasses.BATTLE_MASTER, feature: "Combat Superiority", level: 3 },
    { subclass: Subclasses.BATTLE_MASTER, feature: "Student of War", level: 3 },
    { subclass: Subclasses.BATTLE_MASTER, feature: "Know Your Enemy", level: 7 },
    { subclass: Subclasses.BATTLE_MASTER, feature: "Improved Combat Superiority", level: 10 },
    { subclass: Subclasses.BATTLE_MASTER, feature: "Relentless (Battle Master)", level: 15 },

    // Cavalier
    { subclass: Subclasses.CAVALIER, feature: "Bonus Proficiency (Cavalier)", level: 3 },
    { subclass: Subclasses.CAVALIER, feature: "Born to the Saddle", level: 3 },
    { subclass: Subclasses.CAVALIER, feature: "Unwavering Mark", level: 3 },
    { subclass: Subclasses.CAVALIER, feature: "Warding Maneuver", level: 7 },
    { subclass: Subclasses.CAVALIER, feature: "Hold the Line", level: 10 },
    { subclass: Subclasses.CAVALIER, feature: "Ferocious Charger", level: 15 },
    { subclass: Subclasses.CAVALIER, feature: "Vigilant Defender", level: 18 },

    // Champion
    { subclass: Subclasses.CHAMPION, feature: "Improved Critical (Champion)", level: 3 },
    { subclass: Subclasses.CHAMPION, feature: "Remarkable Athlete", level: 7 },
    { subclass: Subclasses.CHAMPION, feature: "Additional Fighting Style (Champion)", level: 10 },
    { subclass: Subclasses.CHAMPION, feature: "Superior Critical", level: 15 },
    { subclass: Subclasses.CHAMPION, feature: "Survivor", level: 18 },

    // Echo Knight
    { subclass: Subclasses.ECHO_KNIGHT, feature: "Manifest Echo", level: 3 },
    { subclass: Subclasses.ECHO_KNIGHT, feature: "Unleash Incarnation", level: 3 },
    { subclass: Subclasses.ECHO_KNIGHT, feature: "Echo Avatar", level: 7 },
    { subclass: Subclasses.ECHO_KNIGHT, feature: "Shadow Martyr", level: 10 },
    { subclass: Subclasses.ECHO_KNIGHT, feature: "Reclaim Potential", level: 15 },
    { subclass: Subclasses.ECHO_KNIGHT, feature: "Legion of One", level: 18 },

    // Eldritch Knight
    { subclass: Subclasses.ELDRITCH_KNIGHT, feature: "Spellcasting (Eldritch Knight)", level: 3 },
    { subclass: Subclasses.ELDRITCH_KNIGHT, feature: "Weapon Bond", level: 3 },
    { subclass: Subclasses.ELDRITCH_KNIGHT, feature: "War Magic", level: 7 },
    { subclass: Subclasses.ELDRITCH_KNIGHT, feature: "Eldritch Strike", level: 10 },
    { subclass: Subclasses.ELDRITCH_KNIGHT, feature: "Arcane Charge", level: 15 },
    { subclass: Subclasses.ELDRITCH_KNIGHT, feature: "Improved War Magic", level: 18 },

    // Psi Warrior
    { subclass: Subclasses.PSI_WARRIOR, feature: "Psionic Power", level: 3 },
    { subclass: Subclasses.PSI_WARRIOR, feature: "Telekinetic Adept", level: 7 },
    { subclass: Subclasses.PSI_WARRIOR, feature: "Guarded Mind", level: 10 },
    { subclass: Subclasses.PSI_WARRIOR, feature: "Bulwark of Force", level: 15 },
    { subclass: Subclasses.PSI_WARRIOR, feature: "Telekinetic Master", level: 18 },

    // Rune Knight
    { subclass: Subclasses.RUNE_KNIGHT, feature: "Bonus Proficiencies (Rune Knight)", level: 3 },
    { subclass: Subclasses.RUNE_KNIGHT, feature: "Rune Carver", level: 3 },
    { subclass: Subclasses.RUNE_KNIGHT, feature: "Giant's Might", level: 3 },
    { subclass: Subclasses.RUNE_KNIGHT, feature: "Runic Shield", level: 7 },
    { subclass: Subclasses.RUNE_KNIGHT, feature: "Great Stature", level: 10 },
    { subclass: Subclasses.RUNE_KNIGHT, feature: "Master of Runes", level: 15 },
    { subclass: Subclasses.RUNE_KNIGHT, feature: "Runic Juggernaut", level: 18 },

    // Samurai
    { subclass: Subclasses.SAMURAI, feature: "Bonus Proficiency (Samurai)", level: 3 },
    { subclass: Subclasses.SAMURAI, feature: "Fighting Spirit", level: 3 },
    { subclass: Subclasses.SAMURAI, feature: "Elegant Courtier", level: 7 },
    { subclass: Subclasses.SAMURAI, feature: "Tireless Spirit", level: 10 },
    { subclass: Subclasses.SAMURAI, feature: "Rapid Strike", level: 15 },
    { subclass: Subclasses.SAMURAI, feature: "Strength Before Death", level: 18 },

    // Path of the Ancestral Guardian
    { subclass: Subclasses.PATH_OF_THE_ANCESTRAL_GUARDIAN, feature: "Ancestral Protectors", level: 3 },
    { subclass: Subclasses.PATH_OF_THE_ANCESTRAL_GUARDIAN, feature: "Spirit Shield", level: 6 },
    { subclass: Subclasses.PATH_OF_THE_ANCESTRAL_GUARDIAN, feature: "Consult the Spirits", level: 10 },
    { subclass: Subclasses.PATH_OF_THE_ANCESTRAL_GUARDIAN, feature: "Vengeful Ancestors", level: 14 },

    // Path of the Battlerager
    { subclass: Subclasses.PATH_OF_THE_BATTLERAGER, feature: "Battlerager Armor", level: 3 },
    { subclass: Subclasses.PATH_OF_THE_BATTLERAGER, feature: "Reckless Abandon", level: 6 },
    { subclass: Subclasses.PATH_OF_THE_BATTLERAGER, feature: "Battlerager Charge", level: 10 },
    { subclass: Subclasses.PATH_OF_THE_BATTLERAGER, feature: "Spiked Retribution", level: 14 },

    // Path of the Beast
    { subclass: Subclasses.PATH_OF_THE_BEAST, feature: "Form of the Beast", level: 3 },
    { subclass: Subclasses.PATH_OF_THE_BEAST, feature: "Bestial Soul", level: 6 },
    { subclass: Subclasses.PATH_OF_THE_BEAST, feature: "Infectious Fury", level: 10 },
    { subclass: Subclasses.PATH_OF_THE_BEAST, feature: "Call the Hunt", level: 14 },

    // Path of the Berserker
    { subclass: Subclasses.PATH_OF_THE_BERSERKER, feature: "Frenzy", level: 3 },
    { subclass: Subclasses.PATH_OF_THE_BERSERKER, feature: "Mindless Rage", level: 6 },
    { subclass: Subclasses.PATH_OF_THE_BERSERKER, feature: "Intimidating Presence", level: 10 },
    { subclass: Subclasses.PATH_OF_THE_BERSERKER, feature: "Retaliation", level: 14 },

    // Path of the Giant
    { subclass: Subclasses.PATH_OF_THE_GIANT, feature: "Giants Power", level: 3 },
    { subclass: Subclasses.PATH_OF_THE_GIANT, feature: "Giants Havoc", level: 3 },
    { subclass: Subclasses.PATH_OF_THE_GIANT, feature: "Elemental Cleaver", level: 6 },
    { subclass: Subclasses.PATH_OF_THE_GIANT, feature: "Mighty Impel", level: 10 },
    { subclass: Subclasses.PATH_OF_THE_GIANT, feature: "Demiurgic Colossus", level: 14 },

    // Path of the Storm Herald
    { subclass: Subclasses.PATH_OF_THE_STORM_HERALD, feature: "Storm Aura", level: 3 },
    { subclass: Subclasses.PATH_OF_THE_STORM_HERALD, feature: "Storm Soul", level: 6 },
    { subclass: Subclasses.PATH_OF_THE_STORM_HERALD, feature: "Shielding Storm", level: 10 },
    { subclass: Subclasses.PATH_OF_THE_STORM_HERALD, feature: "Raging Storm", level: 14 },

    // Path of the Totem Warrior
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, feature: "Spirit Seeker", level: 3 },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, feature: "Totem Spirit", level: 3 },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, feature: "Aspect of the Beast", level: 6 },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, feature: "Spirit Walker", level: 10 },
    { subclass: Subclasses.PATH_OF_THE_TOTEM_WARRIOR, feature: "Totemic Attunement", level: 14 },

    // Path of Wild Magic
    { subclass: Subclasses.PATH_OF_WILD_MAGIC, feature: "Magic Awareness", level: 3 },
    { subclass: Subclasses.PATH_OF_WILD_MAGIC, feature: "Wild Surge", level: 3 },
    { subclass: Subclasses.PATH_OF_WILD_MAGIC, feature: "Bolstering Magic", level: 6 },
    { subclass: Subclasses.PATH_OF_WILD_MAGIC, feature: "Unstable Backlash", level: 10 },
    { subclass: Subclasses.PATH_OF_WILD_MAGIC, feature: "Controlled Surge", level: 14 },

    // Path of the Zealot
    { subclass: Subclasses.PATH_OF_THE_ZEALOT, feature: "Divine Fury", level: 3 },
    { subclass: Subclasses.PATH_OF_THE_ZEALOT, feature: "Warrior of the Gods", level: 3 },
    { subclass: Subclasses.PATH_OF_THE_ZEALOT, feature: "Fanatical Focus", level: 6 },
    { subclass: Subclasses.PATH_OF_THE_ZEALOT, feature: "Zealous Presence", level: 10 },
    { subclass: Subclasses.PATH_OF_THE_ZEALOT, feature: "Rage Beyond Death", level: 14 },

    // Arcana Domain
    { subclass: Subclasses.ARCANA_DOMAIN, feature: "Arcana Domain Spells", level: 1 },
    { subclass: Subclasses.ARCANA_DOMAIN, feature: "Arcane Initiate (Arcana Domain)", level: 1 },
    { subclass: Subclasses.ARCANA_DOMAIN, feature: "Channel Divinity: Arcane Abjuration", level: 2 },
    { subclass: Subclasses.ARCANA_DOMAIN, feature: "Spell Breaker", level: 6 },
    { subclass: Subclasses.ARCANA_DOMAIN, feature: "Potent Spellcasting (Arcana Domain)", level: 8 },
    { subclass: Subclasses.ARCANA_DOMAIN, feature: "Arcane Mastery", level: 17 },

    // Death Domain
    { subclass: Subclasses.DEATH_DOMAIN, feature: "Death Domain Spells", level: 1 },
    { subclass: Subclasses.DEATH_DOMAIN, feature: "Bonus Proficiency (Death Domain)", level: 1 },
    { subclass: Subclasses.DEATH_DOMAIN, feature: "Reaper", level: 1 },
    { subclass: Subclasses.DEATH_DOMAIN, feature: "Channel Divinity: Touch of Death", level: 2 },
    { subclass: Subclasses.DEATH_DOMAIN, feature: "Inescapable Destruction", level: 6 },
    { subclass: Subclasses.DEATH_DOMAIN, feature: "Divine Strike (Death)", level: 8 },
    { subclass: Subclasses.DEATH_DOMAIN, feature: "Improved Reaper", level: 17 },

    // Forge Domain
    { subclass: Subclasses.FORGE_DOMAIN, feature: "Forge Domain Spells", level: 1 },
    { subclass: Subclasses.FORGE_DOMAIN, feature: "Bonus Proficiencies (Forge Domain)", level: 1 },
    { subclass: Subclasses.FORGE_DOMAIN, feature: "Blessing of the Forge", level: 1 },
    { subclass: Subclasses.FORGE_DOMAIN, feature: "Channel Divinity: Artisans Blessing", level: 2 },
    { subclass: Subclasses.FORGE_DOMAIN, feature: "Soul of the Forge", level: 6 },
    { subclass: Subclasses.FORGE_DOMAIN, feature: "Divine Strike (Forge)", level: 8 },
    { subclass: Subclasses.FORGE_DOMAIN, feature: "Saint of Forge and Fire", level: 17 },

    // Grave Domain
    { subclass: Subclasses.GRAVE_DOMAIN, feature: "Grave Domain Spells", level: 1 },
    { subclass: Subclasses.GRAVE_DOMAIN, feature: "Circle of Mortality", level: 1 },
    { subclass: Subclasses.GRAVE_DOMAIN, feature: "Eyes of the Grave", level: 1 },
    { subclass: Subclasses.GRAVE_DOMAIN, feature: "Channel Divinity: Path to the Grave", level: 2 },
    { subclass: Subclasses.GRAVE_DOMAIN, feature: "Sentinel at Death's Door", level: 6 },
    { subclass: Subclasses.GRAVE_DOMAIN, feature: "Potent Spellcasting (Grave Domain)", level: 8 },
    { subclass: Subclasses.GRAVE_DOMAIN, feature: "Keeper of Souls", level: 17 },

    // Knowledge Domain
    { subclass: Subclasses.KNOWLEDGE_DOMAIN, feature: "Knowledge Domain Spells", level: 1 },
    { subclass: Subclasses.KNOWLEDGE_DOMAIN, feature: "Blessings of Knowledge", level: 1 },
    { subclass: Subclasses.KNOWLEDGE_DOMAIN, feature: "Channel Divinity: Knowledge of the Ages", level: 2 },
    { subclass: Subclasses.KNOWLEDGE_DOMAIN, feature: "Channel Divinity: Read Thoughts", level: 6 },
    { subclass: Subclasses.KNOWLEDGE_DOMAIN, feature: "Potent Spellcasting (Knowledge Domain)", level: 8 },
    { subclass: Subclasses.KNOWLEDGE_DOMAIN, feature: "Visions of the Past", level: 17 },

    // Life Domain
    { subclass: Subclasses.LIFE_DOMAIN, feature: "Life Domain Spells", level: 1 },
    { subclass: Subclasses.LIFE_DOMAIN, feature: "Bonus Proficiency (Life Domain)", level: 1 },
    { subclass: Subclasses.LIFE_DOMAIN, feature: "Disciple of Life", level: 1 },
    { subclass: Subclasses.LIFE_DOMAIN, feature: "Channel Divinity: Preserve Life", level: 2 },
    { subclass: Subclasses.LIFE_DOMAIN, feature: "Blessed Healer", level: 6 },
    { subclass: Subclasses.LIFE_DOMAIN, feature: "Divine Strike (Life)", level: 8 },
    { subclass: Subclasses.LIFE_DOMAIN, feature: "Supreme Healing", level: 17 },

    // Light Domain
    { subclass: Subclasses.LIGHT_DOMAIN, feature: "Light Domain Spells", level: 1 },
    { subclass: Subclasses.LIGHT_DOMAIN, feature: "Bonus Cantrip (Light Domain)", level: 1 },
    { subclass: Subclasses.LIGHT_DOMAIN, feature: "Warding Flare", level: 1 },
    { subclass: Subclasses.LIGHT_DOMAIN, feature: "Channel Divinity: Radiance of the Dawn", level: 2 },
    { subclass: Subclasses.LIGHT_DOMAIN, feature: "Improved Flare", level: 6 },
    { subclass: Subclasses.LIGHT_DOMAIN, feature: "Potent Spellcasting (Light Domain)", level: 8 },
    { subclass: Subclasses.LIGHT_DOMAIN, feature: "Corona of Light", level: 17 },

    // Nature Domain
    { subclass: Subclasses.NATURE_DOMAIN, feature: "Nature Domain Spells", level: 1 },
    { subclass: Subclasses.NATURE_DOMAIN, feature: "Acolyte of Nature", level: 1 },
    { subclass: Subclasses.NATURE_DOMAIN, feature: "Bonus Proficiency (Nature Domain)", level: 1 },
    { subclass: Subclasses.NATURE_DOMAIN, feature: "Channel Divinity: Charm Animals and Plants", level: 2 },
    { subclass: Subclasses.NATURE_DOMAIN, feature: "Dampen Elements", level: 6 },
    { subclass: Subclasses.NATURE_DOMAIN, feature: "Divine Strike (Nature)", level: 8 },
    { subclass: Subclasses.NATURE_DOMAIN, feature: "Master of Nature", level: 17 },

    // Order Domain
    { subclass: Subclasses.ORDER_DOMAIN, feature: "Order Domain Spells", level: 1 },
    { subclass: Subclasses.ORDER_DOMAIN, feature: "Bonus Proficiencies (Order Domain)", level: 1 },
    { subclass: Subclasses.ORDER_DOMAIN, feature: "Voice of Authority", level: 1 },
    { subclass: Subclasses.ORDER_DOMAIN, feature: "Channel Divinity: Orders Demand", level: 2 },
    { subclass: Subclasses.ORDER_DOMAIN, feature: "Embodiment of Law", level: 6 },
    { subclass: Subclasses.ORDER_DOMAIN, feature: "Divine Strike (Order)", level: 8 },
    { subclass: Subclasses.ORDER_DOMAIN, feature: "Orders Wrath", level: 17 },

    // Peace Domain
    { subclass: Subclasses.PEACE_DOMAIN, feature: "Peace Domain Spells", level: 1 },
    { subclass: Subclasses.PEACE_DOMAIN, feature: "Emboldening Bond", level: 1 },
    { subclass: Subclasses.PEACE_DOMAIN, feature: "Channel Divinity: Balm of Peace", level: 2 },
    { subclass: Subclasses.PEACE_DOMAIN, feature: "Protective Bond", level: 6 },
    { subclass: Subclasses.PEACE_DOMAIN, feature: "Potent Spellcasting (Peace Domain)", level: 8 },
    { subclass: Subclasses.PEACE_DOMAIN, feature: "Expansive Bond", level: 17 },

    // Tempest Domain
    { subclass: Subclasses.TEMPEST_DOMAIN, feature: "Tempest Domain Spells", level: 1 },
    { subclass: Subclasses.TEMPEST_DOMAIN, feature: "Bonus Proficiencies (Tempest Domain)", level: 1 },
    { subclass: Subclasses.TEMPEST_DOMAIN, feature: "Wrath of the Storm", level: 1 },
    { subclass: Subclasses.TEMPEST_DOMAIN, feature: "Channel Divinity: Destructive Wrath", level: 2 },
    { subclass: Subclasses.TEMPEST_DOMAIN, feature: "Thunderbolt Strike", level: 6 },
    { subclass: Subclasses.TEMPEST_DOMAIN, feature: "Divine Strike (Tempest)", level: 8 },
    { subclass: Subclasses.TEMPEST_DOMAIN, feature: "Stormborn", level: 17 },

    // Trickery Domain
    { subclass: Subclasses.TRICKERY_DOMAIN, feature: "Trickery Domain Spells", level: 1 },
    { subclass: Subclasses.TRICKERY_DOMAIN, feature: "Blessing of the Trickster", level: 1 },
    { subclass: Subclasses.TRICKERY_DOMAIN, feature: "Channel Divinity: Invoke Duplicity", level: 2 },
    { subclass: Subclasses.TRICKERY_DOMAIN, feature: "Cloak of Shadows", level: 6 },
    { subclass: Subclasses.TRICKERY_DOMAIN, feature: "Divine Strike (Trickery)", level: 8 },
    { subclass: Subclasses.TRICKERY_DOMAIN, feature: "Improved Duplicity", level: 17 },

    // Twilight Domain
    { subclass: Subclasses.TWILIGHT_DOMAIN, feature: "Twilight Domain Spells", level: 1 },
    { subclass: Subclasses.TWILIGHT_DOMAIN, feature: "Bonus Proficiencies (Twilight Domain)", level: 1 },
    { subclass: Subclasses.TWILIGHT_DOMAIN, feature: "Eyes of Night", level: 1 },
    { subclass: Subclasses.TWILIGHT_DOMAIN, feature: "Vigilant Blessing", level: 1 },
    { subclass: Subclasses.TWILIGHT_DOMAIN, feature: "Channel Divinity: Twilight Sanctuary", level: 2 },
    { subclass: Subclasses.TWILIGHT_DOMAIN, feature: "Steps of Night", level: 6 },
    { subclass: Subclasses.TWILIGHT_DOMAIN, feature: "Divine Strike (Twilight)", level: 8 },
    { subclass: Subclasses.TWILIGHT_DOMAIN, feature: "Midnight Shroud", level: 17 },

    // War Domain
    { subclass: Subclasses.WAR_DOMAIN, feature: "War Domain Spells", level: 1 },
    { subclass: Subclasses.WAR_DOMAIN, feature: "Bonus Proficiencies (War Domain)", level: 1 },
    { subclass: Subclasses.WAR_DOMAIN, feature: "War Priest", level: 1 },
    { subclass: Subclasses.WAR_DOMAIN, feature: "Channel Divinity: Guided Strike", level: 2 },
    { subclass: Subclasses.WAR_DOMAIN, feature: "Channel Divinity: War Gods Blessing", level: 6 },
    { subclass: Subclasses.WAR_DOMAIN, feature: "Divine Strike (War)", level: 8 },
    { subclass: Subclasses.WAR_DOMAIN, feature: "Avatar of Battle", level: 17 },

    // Archfey
    { subclass: Subclasses.ARCHFEY, feature: "Expanded Spell List (Archfey)", level: 1 },
    { subclass: Subclasses.ARCHFEY, feature: "Fey Presence", level: 1 },
    { subclass: Subclasses.ARCHFEY, feature: "Misty Escape", level: 6 },
    { subclass: Subclasses.ARCHFEY, feature: "Beguiling Defenses", level: 10 },
    { subclass: Subclasses.ARCHFEY, feature: "Dark Delirium", level: 14 },

    // Fiend
    { subclass: Subclasses.FIEND, feature: "Expanded Spell List (Fiend)", level: 1 },
    { subclass: Subclasses.FIEND, feature: "Dark Ones Blessing", level: 1 },
    { subclass: Subclasses.FIEND, feature: "Dark Ones Own Luck", level: 6 },
    { subclass: Subclasses.FIEND, feature: "Fiendish Resilience", level: 10 },
    { subclass: Subclasses.FIEND, feature: "Hurl Through Hell", level: 14 },

    // Great Old One
    { subclass: Subclasses.GREAT_OLD_ONE, feature: "Expanded Spell List (Great Old One)", level: 1 },
    { subclass: Subclasses.GREAT_OLD_ONE, feature: "Awakened Mind", level: 1 },
    { subclass: Subclasses.GREAT_OLD_ONE, feature: "Entropic Ward", level: 6 },
    { subclass: Subclasses.GREAT_OLD_ONE, feature: "Thought Shield", level: 10 },
    { subclass: Subclasses.GREAT_OLD_ONE, feature: "Create Thrall", level: 14 },

    // Hexblade
    { subclass: Subclasses.HEXBLADE, feature: "Expanded Spell List (Hexblade)", level: 1 },
    { subclass: Subclasses.HEXBLADE, feature: "Hexblades Curse", level: 1 },
    { subclass: Subclasses.HEXBLADE, feature: "Hex Warrior", level: 1 },
    { subclass: Subclasses.HEXBLADE, feature: "Accursed Specter", level: 6 },
    { subclass: Subclasses.HEXBLADE, feature: "Armor of Hexes", level: 10 },
    { subclass: Subclasses.HEXBLADE, feature: "Master of Hexes", level: 14 },

    // Celestial
    { subclass: Subclasses.CELESTIAL, feature: "Expanded Spell List (Celestial)", level: 1 },
    { subclass: Subclasses.CELESTIAL, feature: "Bonus Cantrips (Celestial)", level: 1 },
    { subclass: Subclasses.CELESTIAL, feature: "Healing Light", level: 1 },
    { subclass: Subclasses.CELESTIAL, feature: "Radiant Soul", level: 6 },
    { subclass: Subclasses.CELESTIAL, feature: "Celestial Resilience", level: 10 },
    { subclass: Subclasses.CELESTIAL, feature: "Searing Vengeance", level: 14 },

    // Fathomless
    { subclass: Subclasses.FATHOMLESS, feature: "Expanded Spell List (Fathomless)", level: 1 },
    { subclass: Subclasses.FATHOMLESS, feature: "Tentacle of the Deeps", level: 1 },
    { subclass: Subclasses.FATHOMLESS, feature: "Gift of the Sea", level: 1 },
    { subclass: Subclasses.FATHOMLESS, feature: "Oceanic Soul", level: 6 },
    { subclass: Subclasses.FATHOMLESS, feature: "Guardian Coil", level: 6 },
    { subclass: Subclasses.FATHOMLESS, feature: "Grasping Tentacles", level: 10 },
    { subclass: Subclasses.FATHOMLESS, feature: "Fathomless Plunge", level: 14 },

    // Genie
    { subclass: Subclasses.THE_GENIE, feature: "Genie Expanded Spells", level: 1 },
    { subclass: Subclasses.THE_GENIE, feature: "Genies Vessel", level: 1 },
    { subclass: Subclasses.THE_GENIE, feature: "Elemental Gift", level: 6 },
    { subclass: Subclasses.THE_GENIE, feature: "Sanctuary Vessel", level: 10 },
    { subclass: Subclasses.THE_GENIE, feature: "Limited Wish", level: 14 },

    // Undead
    { subclass: Subclasses.UNDEAD, feature: "Expanded Spell List (Undead)", level: 1 },
    { subclass: Subclasses.UNDEAD, feature: "Form of Dread", level: 1 },
    { subclass: Subclasses.UNDEAD, feature: "Grave Touched", level: 6 },
    { subclass: Subclasses.UNDEAD, feature: "Mortal Husk", level: 10 },
    { subclass: Subclasses.UNDEAD, feature: "Spirit Projection", level: 14 },

    // Undying
    { subclass: Subclasses.UNDYING, feature: "Expanded Spell List (Undying)", level: 1 },
    { subclass: Subclasses.UNDYING, feature: "Among the Dead", level: 1 },
    { subclass: Subclasses.UNDYING, feature: "Defy Death", level: 6 },
    { subclass: Subclasses.UNDYING, feature: "Undying Nature", level: 10 },
    { subclass: Subclasses.UNDYING, feature: "Indestructible Life", level: 14 },

    // Aberrant Mind
    { subclass: Subclasses.ABERRANT_MIND, feature: "Psionic Spells (Aberrant Mind)", level: 1 },
    { subclass: Subclasses.ABERRANT_MIND, feature: "Telepathic Speech", level: 1 },
    { subclass: Subclasses.ABERRANT_MIND, feature: "Psionic Sorcery", level: 6 },
    { subclass: Subclasses.ABERRANT_MIND, feature: "Psychic Defenses", level: 6 },
    { subclass: Subclasses.ABERRANT_MIND, feature: "Revelation in Flesh", level: 14 },
    { subclass: Subclasses.ABERRANT_MIND, feature: "Warping Implosion", level: 18 },

    // Clockwork Soul
    { subclass: Subclasses.CLOCKWORK_SOUL, feature: "Clockwork Spells", level: 1 },
    { subclass: Subclasses.CLOCKWORK_SOUL, feature: "Restore Balance", level: 1 },
    { subclass: Subclasses.CLOCKWORK_SOUL, feature: "Bastion of Law", level: 6 },
    { subclass: Subclasses.CLOCKWORK_SOUL, feature: "Trance of Order", level: 14 },
    { subclass: Subclasses.CLOCKWORK_SOUL, feature: "Clockwork Cavalcade", level: 18 },

    // Draconic Bloodline
    { subclass: Subclasses.DRACONIC_BLOODLINE, feature: "Draconic Ancestry", level: 1 },
    { subclass: Subclasses.DRACONIC_BLOODLINE, feature: "Draconic Resilience", level: 1 },
    { subclass: Subclasses.DRACONIC_BLOODLINE, feature: "Elemental Affinity", level: 6 },
    { subclass: Subclasses.DRACONIC_BLOODLINE, feature: "Dragon Wings", level: 14 },
    { subclass: Subclasses.DRACONIC_BLOODLINE, feature: "Draconic Presence", level: 18 },

    // Divine Soul
    { subclass: Subclasses.DIVINE_SOUL, feature: "Divine Magic", level: 1 },
    { subclass: Subclasses.DIVINE_SOUL, feature: "Favored by the Gods", level: 1 },
    { subclass: Subclasses.DIVINE_SOUL, feature: "Empowered Healing", level: 6 },
    { subclass: Subclasses.DIVINE_SOUL, feature: "Otherworldly Wings", level: 14 },
    { subclass: Subclasses.DIVINE_SOUL, feature: "Unearthly Recovery", level: 18 },

    // Lunar Sorcery
    { subclass: Subclasses.LUNAR_SORCERY, feature: "Lunar Embodiment", level: 1 },
    { subclass: Subclasses.LUNAR_SORCERY, feature: "Moon Fire", level: 1 },
    { subclass: Subclasses.LUNAR_SORCERY, feature: "Lunar Boons", level: 6 },
    { subclass: Subclasses.LUNAR_SORCERY, feature: "Waxing and Waning", level: 6 },
    { subclass: Subclasses.LUNAR_SORCERY, feature: "Lunar Empowerment", level: 14 },
    { subclass: Subclasses.LUNAR_SORCERY, feature: "Lunar Phenomenon", level: 18 },

    // Shadow Magic
    { subclass: Subclasses.SHADOW_MAGIC, feature: "Eyes of the Dark", level: 1 },
    { subclass: Subclasses.SHADOW_MAGIC, feature: "Strength of the Grave", level: 1 },
    { subclass: Subclasses.SHADOW_MAGIC, feature: "Hound of Ill Omen", level: 6 },
    { subclass: Subclasses.SHADOW_MAGIC, feature: "Shadow Walk", level: 14 },
    { subclass: Subclasses.SHADOW_MAGIC, feature: "Umbral Form", level: 18 },

    // Storm Sorcery
    { subclass: Subclasses.STORM_SORCERY, feature: "Wind Speaker", level: 1 },
    { subclass: Subclasses.STORM_SORCERY, feature: "Tempestuous Magic", level: 1 },
    { subclass: Subclasses.STORM_SORCERY, feature: "Heart of the Storm", level: 6 },
    { subclass: Subclasses.STORM_SORCERY, feature: "Storm Guide", level: 6 },
    { subclass: Subclasses.STORM_SORCERY, feature: "Storm's Fury", level: 14 },
    { subclass: Subclasses.STORM_SORCERY, feature: "Wind Soul", level: 18 },

    // Wild Magic
    { subclass: Subclasses.WILD_MAGIC, feature: "Wild Magic Surge", level: 1 },
    { subclass: Subclasses.WILD_MAGIC, feature: "Tides of Chaos", level: 1 },
    { subclass: Subclasses.WILD_MAGIC, feature: "Bend Luck", level: 6 },
    { subclass: Subclasses.WILD_MAGIC, feature: "Controlled Chaos", level: 14 },
    { subclass: Subclasses.WILD_MAGIC, feature: "Spell Bombardment", level: 18 },

    // School of Abjuration
    { subclass: Subclasses.SCHOOL_OF_ABJURATION, feature: "Arcane Ward", level: 2 },
    { subclass: Subclasses.SCHOOL_OF_ABJURATION, feature: "Projected Ward", level: 6 },
    { subclass: Subclasses.SCHOOL_OF_ABJURATION, feature: "Improved Abjuration", level: 10 },
    { subclass: Subclasses.SCHOOL_OF_ABJURATION, feature: "Spell Resistance", level: 14 },

    // School of Bladesinging
    { subclass: Subclasses.SCHOOL_OF_BLADESINGING, feature: "Training in War and Song", level: 2 },
    { subclass: Subclasses.SCHOOL_OF_BLADESINGING, feature: "Bladesong", level: 2 },
    { subclass: Subclasses.SCHOOL_OF_BLADESINGING, feature: "Extra Attack (Bladesinger)", level: 6 },
    { subclass: Subclasses.SCHOOL_OF_BLADESINGING, feature: "Song of Defense", level: 10 },
    { subclass: Subclasses.SCHOOL_OF_BLADESINGING, feature: "Song of Victory", level: 14 },

    // School of Chronurgy
    { subclass: Subclasses.SCHOOL_OF_CHRONURGY, feature: "Chronal Shift", level: 2 },
    { subclass: Subclasses.SCHOOL_OF_CHRONURGY, feature: "Temporal Awareness", level: 2 },
    { subclass: Subclasses.SCHOOL_OF_CHRONURGY, feature: "Momentary Stasis", level: 6 },
    { subclass: Subclasses.SCHOOL_OF_CHRONURGY, feature: "Arcane Abeyance", level: 10 },
    { subclass: Subclasses.SCHOOL_OF_CHRONURGY, feature: "Convergent Future", level: 14 },

    // School of Conjuration
    { subclass: Subclasses.SCHOOL_OF_CONJURATION, feature: "Minor Conjuration", level: 2 },
    { subclass: Subclasses.SCHOOL_OF_CONJURATION, feature: "Benign Transposition", level: 6 },
    { subclass: Subclasses.SCHOOL_OF_CONJURATION, feature: "Focused Conjuration", level: 10 },
    { subclass: Subclasses.SCHOOL_OF_CONJURATION, feature: "Durable Summons", level: 14 },

    // School of Divination
    { subclass: Subclasses.SCHOOL_OF_DIVINATION, feature: "Portent", level: 2 },
    { subclass: Subclasses.SCHOOL_OF_DIVINATION, feature: "Expert Divination", level: 6 },
    { subclass: Subclasses.SCHOOL_OF_DIVINATION, feature: "The Third Eye", level: 10 },
    { subclass: Subclasses.SCHOOL_OF_DIVINATION, feature: "Greater Portent", level: 14 },

    // School of Enchantment
    { subclass: Subclasses.SCHOOL_OF_ENCHANTMENT, feature: "Hypnotic Gaze", level: 2 },
    { subclass: Subclasses.SCHOOL_OF_ENCHANTMENT, feature: "Instinctive Charm", level: 6 },
    { subclass: Subclasses.SCHOOL_OF_ENCHANTMENT, feature: "Split Enchantment", level: 10 },
    { subclass: Subclasses.SCHOOL_OF_ENCHANTMENT, feature: "Alter Memories", level: 14 },

    // School of Evocation
    { subclass: Subclasses.SCHOOL_OF_EVOCATION, feature: "Sculpt Spells", level: 2 },
    { subclass: Subclasses.SCHOOL_OF_EVOCATION, feature: "Potent Cantrip (Evocation)", level: 6 },
    { subclass: Subclasses.SCHOOL_OF_EVOCATION, feature: "Empowered Evocation", level: 10 },
    { subclass: Subclasses.SCHOOL_OF_EVOCATION, feature: "Overchannel", level: 14 },

    // School of Graviturgy
    { subclass: Subclasses.SCHOOL_OF_GRAVITURGY, feature: "Adjust Density", level: 2 },
    { subclass: Subclasses.SCHOOL_OF_GRAVITURGY, feature: "Gravity Well", level: 6 },
    { subclass: Subclasses.SCHOOL_OF_GRAVITURGY, feature: "Violent Attraction", level: 10 },
    { subclass: Subclasses.SCHOOL_OF_GRAVITURGY, feature: "Event Horizon", level: 14 },

    // School of Illusion
    { subclass: Subclasses.SCHOOL_OF_ILLUSION, feature: "Improved Minor Illusion", level: 2 },
    { subclass: Subclasses.SCHOOL_OF_ILLUSION, feature: "Malleable Illusions", level: 6 },
    { subclass: Subclasses.SCHOOL_OF_ILLUSION, feature: "Illusory Self", level: 10 },
    { subclass: Subclasses.SCHOOL_OF_ILLUSION, feature: "Illusory Reality", level: 14 },

    // School of Necromancy
    { subclass: Subclasses.SCHOOL_OF_NECROMANCY, feature: "Grim Harvest", level: 2 },
    { subclass: Subclasses.SCHOOL_OF_NECROMANCY, feature: "Undead Thralls", level: 6 },
    { subclass: Subclasses.SCHOOL_OF_NECROMANCY, feature: "Inured to Undeath", level: 10 },
    { subclass: Subclasses.SCHOOL_OF_NECROMANCY, feature: "Command Undead", level: 14 },

    // Order of Scribes
    { subclass: Subclasses.ORDER_OF_SCRIBES, feature: "Wizardly Quill", level: 2 },
    { subclass: Subclasses.ORDER_OF_SCRIBES, feature: "Awakened Spellbook", level: 2 },
    { subclass: Subclasses.ORDER_OF_SCRIBES, feature: "Manifest Mind", level: 6 },
    { subclass: Subclasses.ORDER_OF_SCRIBES, feature: "Master Scrivener", level: 10 },
    { subclass: Subclasses.ORDER_OF_SCRIBES, feature: "One with the Word", level: 14 },

    // School of Transmutation
    { subclass: Subclasses.SCHOOL_OF_TRANSMUTATION, feature: "Minor Alchemy", level: 2 },
    { subclass: Subclasses.SCHOOL_OF_TRANSMUTATION, feature: "Transmuters Stone", level: 6 },
    { subclass: Subclasses.SCHOOL_OF_TRANSMUTATION, feature: "Shapechanger", level: 10 },
    { subclass: Subclasses.SCHOOL_OF_TRANSMUTATION, feature: "Master Transmuter", level: 14 },

    // War Magic
    { subclass: Subclasses.SCHOOL_OF_WAR_MAGIC, feature: "Arcane Deflection", level: 2 },
    { subclass: Subclasses.SCHOOL_OF_WAR_MAGIC, feature: "Tactical Wit", level: 2 },
    { subclass: Subclasses.SCHOOL_OF_WAR_MAGIC, feature: "Power Surge", level: 6 },
    { subclass: Subclasses.SCHOOL_OF_WAR_MAGIC, feature: "Durable Magic", level: 10 },
    { subclass: Subclasses.SCHOOL_OF_WAR_MAGIC, feature: "Deflecting Shroud", level: 14 },

    // Circle of Dreams
    { subclass: Subclasses.CIRCLE_OF_DREAMS, feature: "Balm of the Summer Court", level: 2 },
    { subclass: Subclasses.CIRCLE_OF_DREAMS, feature: "Hearth of Moonlight and Shadow", level: 6 },
    { subclass: Subclasses.CIRCLE_OF_DREAMS, feature: "Hidden Paths", level: 10 },
    { subclass: Subclasses.CIRCLE_OF_DREAMS, feature: "Walker in Dreams", level: 14 },

    // Circle of the Land
    { subclass: Subclasses.CIRCLE_OF_THE_LAND, feature: "Bonus Cantrip (Circle of the Land)", level: 2 },
    { subclass: Subclasses.CIRCLE_OF_THE_LAND, feature: "Natural Recovery", level: 2 },
    { subclass: Subclasses.CIRCLE_OF_THE_LAND, feature: "Lands Stride", level: 6 },
    { subclass: Subclasses.CIRCLE_OF_THE_LAND, feature: "Natures Ward", level: 10 },
    { subclass: Subclasses.CIRCLE_OF_THE_LAND, feature: "Natures Sanctuary", level: 14 },

    // Circle of the Moon
    { subclass: Subclasses.CIRCLE_OF_THE_MOON, feature: "Combat Wild Shape", level: 2 },
    { subclass: Subclasses.CIRCLE_OF_THE_MOON, feature: "Circle Forms", level: 2 },
    { subclass: Subclasses.CIRCLE_OF_THE_MOON, feature: "Primal Strike", level: 6 },
    { subclass: Subclasses.CIRCLE_OF_THE_MOON, feature: "Elemental Wild Shape", level: 10 },
    { subclass: Subclasses.CIRCLE_OF_THE_MOON, feature: "Thousand Forms", level: 14 },

    // Circle of the Shepherd
    { subclass: Subclasses.CIRCLE_OF_THE_SHEPHERD, feature: "Speech of the Woods", level: 2 },
    { subclass: Subclasses.CIRCLE_OF_THE_SHEPHERD, feature: "Spirit Totem", level: 2 },
    { subclass: Subclasses.CIRCLE_OF_THE_SHEPHERD, feature: "Mighty Summoner", level: 6 },
    { subclass: Subclasses.CIRCLE_OF_THE_SHEPHERD, feature: "Guardian Spirit", level: 10 },
    { subclass: Subclasses.CIRCLE_OF_THE_SHEPHERD, feature: "Faithful Summons", level: 14 },

    // Circle of Spores
    { subclass: Subclasses.CIRCLE_OF_SPORES, feature: "Halo of Spores", level: 2 },
    { subclass: Subclasses.CIRCLE_OF_SPORES, feature: "Symbiotic Entity", level: 2 },
    { subclass: Subclasses.CIRCLE_OF_SPORES, feature: "Fungal Infestation", level: 6 },
    { subclass: Subclasses.CIRCLE_OF_SPORES, feature: "Spreading Spores", level: 10 },
    { subclass: Subclasses.CIRCLE_OF_SPORES, feature: "Fungal Body", level: 14 },

    // Circle of Stars
    { subclass: Subclasses.CIRCLE_OF_STARS, feature: "Star Map", level: 2 },
    { subclass: Subclasses.CIRCLE_OF_STARS, feature: "Starry Form", level: 2 },
    { subclass: Subclasses.CIRCLE_OF_STARS, feature: "Cosmic Omen", level: 6 },
    { subclass: Subclasses.CIRCLE_OF_STARS, feature: "Twinkling Constellations", level: 10 },
    { subclass: Subclasses.CIRCLE_OF_STARS, feature: "Full of Stars", level: 14 },

    // Circle of Wildfire
    { subclass: Subclasses.CIRCLE_OF_WILDFIRE, feature: "Circle Spells  Wildfire", level: 2 },
    { subclass: Subclasses.CIRCLE_OF_WILDFIRE, feature: "Summon Wildfire Spirit", level: 2 },
    { subclass: Subclasses.CIRCLE_OF_WILDFIRE, feature: "Enhanced Bond", level: 6 },
    { subclass: Subclasses.CIRCLE_OF_WILDFIRE, feature: "Cauterizing Flames", level: 10 },
    { subclass: Subclasses.CIRCLE_OF_WILDFIRE, feature: "Blazing Revival", level: 14 },

    // Alchemist
    { subclass: Subclasses.ALCHEMIST, feature: "Alchemist Spells", level: 3 },
    { subclass: Subclasses.ALCHEMIST, feature: "Tools of the Trade (Alchemist)", level: 3 },
    { subclass: Subclasses.ALCHEMIST, feature: "Experimental Elixir", level: 3 },
    { subclass: Subclasses.ALCHEMIST, feature: "Alchemical Savant", level: 5 },
    { subclass: Subclasses.ALCHEMIST, feature: "Restorative Reagents", level: 9 },
    { subclass: Subclasses.ALCHEMIST, feature: "Chemical Mastery", level: 15 },

    // Armorer
    { subclass: Subclasses.ARMORER, feature: "Armorer Spells", level: 3 },
    { subclass: Subclasses.ARMORER, feature: "Tools of the Trade (Armorer)", level: 3 },
    { subclass: Subclasses.ARMORER, feature: "Arcane Armor", level: 3 },
    { subclass: Subclasses.ARMORER, feature: "Armor Model", level: 3 },
    { subclass: Subclasses.ARMORER, feature: "Extra Attack (Armorer)", level: 5 },
    { subclass: Subclasses.ARMORER, feature: "Armor Modifications", level: 9 },
    { subclass: Subclasses.ARMORER, feature: "Perfected Armor", level: 15 },

    // Artillerist
    { subclass: Subclasses.ARTILLERIST, feature: "Artillerist Spells", level: 3 },
    { subclass: Subclasses.ARTILLERIST, feature: "Tools of the Trade (Artillerist)", level: 3 },
    { subclass: Subclasses.ARTILLERIST, feature: "Eldritch Cannon", level: 3 },
    { subclass: Subclasses.ARTILLERIST, feature: "Arcane Firearm", level: 5 },
    { subclass: Subclasses.ARTILLERIST, feature: "Explosive Cannon", level: 9 },
    { subclass: Subclasses.ARTILLERIST, feature: "Fortified Position", level: 15 },

    // Battle Smith
    { subclass: Subclasses.BATTLE_SMITH, feature: "Battle Smith Spells", level: 3 },
    { subclass: Subclasses.BATTLE_SMITH, feature: "Tools of the Trade (Battle Smith)", level: 3 },
    { subclass: Subclasses.BATTLE_SMITH, feature: "Battle Ready", level: 3 },
    { subclass: Subclasses.BATTLE_SMITH, feature: "Steel Defender", level: 3 },
    { subclass: Subclasses.BATTLE_SMITH, feature: "Extra Attack (Battle Smith)", level: 5 },
    { subclass: Subclasses.BATTLE_SMITH, feature: "Arcane Jolt", level: 9 },
    { subclass: Subclasses.BATTLE_SMITH, feature: "Improved Defender", level: 15 },

    // Thief
    { subclass: Subclasses.THIEF, feature: "Fast Hands", level: 3 },
    { subclass: Subclasses.THIEF, feature: "Second-Story Work", level: 3 },
    { subclass: Subclasses.THIEF, feature: "Supreme Sneak", level: 9 },
    { subclass: Subclasses.THIEF, feature: "Use Magic Device", level: 13 },
    { subclass: Subclasses.THIEF, feature: "Thief's Reflexes", level: 17 },

    // Assassin
    { subclass: Subclasses.ASSASSIN, feature: "Bonus Proficiencies (Assassin)", level: 3 },
    { subclass: Subclasses.ASSASSIN, feature: "Assassinate", level: 3 },
    { subclass: Subclasses.ASSASSIN, feature: "Infiltration Expertise", level: 9 },
    { subclass: Subclasses.ASSASSIN, feature: "Impostor", level: 13 },
    { subclass: Subclasses.ASSASSIN, feature: "Death Strike", level: 17 },

    // Arcane Trickster
    { subclass: Subclasses.ARCANE_TRICKSTER, feature: "Spellcasting (Arcane Trickster)", level: 3 },
    { subclass: Subclasses.ARCANE_TRICKSTER, feature: "Mage Hand Legerdemain", level: 3 },
    { subclass: Subclasses.ARCANE_TRICKSTER, feature: "Magical Ambush", level: 9 },
    { subclass: Subclasses.ARCANE_TRICKSTER, feature: "Versatile Trickster", level: 13 },
    { subclass: Subclasses.ARCANE_TRICKSTER, feature: "Spell Thief", level: 17 },

    // Inquisitive
    { subclass: Subclasses.INQUISITIVE, feature: "Ear for Deceit", level: 3 },
    { subclass: Subclasses.INQUISITIVE, feature: "Eye for Detail", level: 3 },
    { subclass: Subclasses.INQUISITIVE, feature: "Insightful Fighting", level: 3 },
    { subclass: Subclasses.INQUISITIVE, feature: "Steady Eye", level: 9 },
    { subclass: Subclasses.INQUISITIVE, feature: "Unerring Eye", level: 13 },
    { subclass: Subclasses.INQUISITIVE, feature: "Eye for Weakness", level: 17 },

    // Mastermind
    { subclass: Subclasses.MASTERMIND, feature: "Master of Intrigue", level: 3 },
    { subclass: Subclasses.MASTERMIND, feature: "Master of Tactics", level: 3 },
    { subclass: Subclasses.MASTERMIND, feature: "Insightful Manipulator", level: 9 },
    { subclass: Subclasses.MASTERMIND, feature: "Misdirection", level: 13 },
    { subclass: Subclasses.MASTERMIND, feature: "Soul of Deceit", level: 17 },

    // Scout
    { subclass: Subclasses.SCOUT, feature: "Skirmisher", level: 3 },
    { subclass: Subclasses.SCOUT, feature: "Survivalist", level: 3 },
    { subclass: Subclasses.SCOUT, feature: "Superior Mobility", level: 9 },
    { subclass: Subclasses.SCOUT, feature: "Ambush Master", level: 13 },
    { subclass: Subclasses.SCOUT, feature: "Sudden Strike", level: 17 },

    // Phantom
    { subclass: Subclasses.PHANTOM, feature: "Whispers from the Dead", level: 3 },
    { subclass: Subclasses.PHANTOM, feature: "Wails from the Grave", level: 3 },
    { subclass: Subclasses.PHANTOM, feature: "Tokens of the Departed", level: 9 },
    { subclass: Subclasses.PHANTOM, feature: "Ghost Walk", level: 13 },
    { subclass: Subclasses.PHANTOM, feature: "Death's Friend", level: 17 },

    // Soulknife
    { subclass: Subclasses.SOULKNIFE, feature: "Psychic Whispers", level: 3 },
    { subclass: Subclasses.SOULKNIFE, feature: "Psychic Blades", level: 3 },
    { subclass: Subclasses.SOULKNIFE, feature: "Soul Blades", level: 9 },
    { subclass: Subclasses.SOULKNIFE, feature: "Psychic Veil", level: 13 },
    { subclass: Subclasses.SOULKNIFE, feature: "Rend Mind", level: 17 },

    // Swashbuckler
    { subclass: Subclasses.SWASHBUCKLER, feature: "Fancy Footwork", level: 3 },
    { subclass: Subclasses.SWASHBUCKLER, feature: "Rakish Audacity", level: 3 },
    { subclass: Subclasses.SWASHBUCKLER, feature: "Panache", level: 9 },
    { subclass: Subclasses.SWASHBUCKLER, feature: "Elegant Maneuver", level: 13 },
    { subclass: Subclasses.SWASHBUCKLER, feature: "Master Duelist", level: 17 },

    // Way of Mercy
    { subclass: Subclasses.WAY_OF_MERCY, feature: "Implements of Mercy", level: 3 },
    { subclass: Subclasses.WAY_OF_MERCY, feature: "Hand of Harm", level: 3 },
    { subclass: Subclasses.WAY_OF_MERCY, feature: "Hand of Healing", level: 3 },
    { subclass: Subclasses.WAY_OF_MERCY, feature: "Physician's Touch", level: 6 },
    { subclass: Subclasses.WAY_OF_MERCY, feature: "Flurry of Healing and Harm", level: 11 },
    { subclass: Subclasses.WAY_OF_MERCY, feature: "Hand of Ultimate Mercy", level: 17 },

    // Way of the Ascendant Dragon
    { subclass: Subclasses.WAY_OF_THE_ASCENDANT_DRAGON, feature: "Draconic Disciple", level: 3 },
    { subclass: Subclasses.WAY_OF_THE_ASCENDANT_DRAGON, feature: "Breath of the Dragon", level: 3 },
    { subclass: Subclasses.WAY_OF_THE_ASCENDANT_DRAGON, feature: "Wings Unfurled", level: 6 },
    { subclass: Subclasses.WAY_OF_THE_ASCENDANT_DRAGON, feature: "Aspect of the Wyrm", level: 11 },
    { subclass: Subclasses.WAY_OF_THE_ASCENDANT_DRAGON, feature: "Ascendant Aspect", level: 17 },

    // Way of the Astral Self
    { subclass: Subclasses.WAY_OF_THE_ASTRAL_SELF, feature: "Arms of the Astral Self", level: 3 },
    { subclass: Subclasses.WAY_OF_THE_ASTRAL_SELF, feature: "Visage of the Astral Self", level: 6 },
    { subclass: Subclasses.WAY_OF_THE_ASTRAL_SELF, feature: "Body of the Astral Self", level: 11 },
    { subclass: Subclasses.WAY_OF_THE_ASTRAL_SELF, feature: "Awakened Astral Self", level: 17 },

    // Way of the Drunken Master
    { subclass: Subclasses.WAY_OF_THE_DRUNKEN_MASTER, feature: "Bonus Proficiencies (Drunken Master)", level: 3 },
    { subclass: Subclasses.WAY_OF_THE_DRUNKEN_MASTER, feature: "Drunken Technique", level: 3 },
    { subclass: Subclasses.WAY_OF_THE_DRUNKEN_MASTER, feature: "Tipsy Sway", level: 6 },
    { subclass: Subclasses.WAY_OF_THE_DRUNKEN_MASTER, feature: "Drunkard's Luck", level: 11 },
    { subclass: Subclasses.WAY_OF_THE_DRUNKEN_MASTER, feature: "Intoxicated Frenzy", level: 17 },

    // Way of the Four Elements
    { subclass: Subclasses.WAY_OF_THE_FOUR_ELEMENTS, feature: "Disciple of the Elements", level: 3 },

    // Way of the Kensei
    { subclass: Subclasses.WAY_OF_THE_KENSEI, feature: "Path of the Kensei", level: 3 },
    { subclass: Subclasses.WAY_OF_THE_KENSEI, feature: "One with the Blade", level: 6 },
    { subclass: Subclasses.WAY_OF_THE_KENSEI, feature: "Sharpen the Blade", level: 11 },
    { subclass: Subclasses.WAY_OF_THE_KENSEI, feature: "Unerring Accuracy", level: 17 },

    // Way of the Long Death
    { subclass: Subclasses.WAY_OF_THE_LONG_DEATH, feature: "Touch of Death", level: 3 },
    { subclass: Subclasses.WAY_OF_THE_LONG_DEATH, feature: "Hour of Reaping", level: 6 },
    { subclass: Subclasses.WAY_OF_THE_LONG_DEATH, feature: "Mastery of Death", level: 11 },
    { subclass: Subclasses.WAY_OF_THE_LONG_DEATH, feature: "Touch of the Long Death", level: 17 },

    // Way of the Open Hand
    { subclass: Subclasses.WAY_OF_THE_OPEN_HAND, feature: "Open Hand Technique", level: 3 },
    { subclass: Subclasses.WAY_OF_THE_OPEN_HAND, feature: "Wholeness of Body", level: 6 },
    { subclass: Subclasses.WAY_OF_THE_OPEN_HAND, feature: "Tranquility", level: 11 },
    { subclass: Subclasses.WAY_OF_THE_OPEN_HAND, feature: "Quivering Palm", level: 17 },

    // Way of Shadow
    { subclass: Subclasses.WAY_OF_SHADOW, feature: "Shadow Arts", level: 3 },
    { subclass: Subclasses.WAY_OF_SHADOW, feature: "Shadow Step", level: 6 },
    { subclass: Subclasses.WAY_OF_SHADOW, feature: "Cloak of Shadows", level: 11 },
    { subclass: Subclasses.WAY_OF_SHADOW, feature: "Opportunist", level: 17 },

    // Way of the Sun Soul
    { subclass: Subclasses.WAY_OF_THE_SUN_SOUL, feature: "Radiant Sun Bolt", level: 3 },
    { subclass: Subclasses.WAY_OF_THE_SUN_SOUL, feature: "Searing Arc Strike", level: 6 },
    { subclass: Subclasses.WAY_OF_THE_SUN_SOUL, feature: "Searing Sunburst", level: 11 },
    { subclass: Subclasses.WAY_OF_THE_SUN_SOUL, feature: "Sun Shield", level: 17 },
  ]

  for (const feature of features) {
    const normalized = normalizeFeatureCreateInput(feature)
    await prisma.feature.upsert({
      where: { engName: normalized.engName },
      update: normalized,
      create: normalized,
    })
  }

  //       (   seed-),
  //  ,   subclass_feature_id    (subclass_id, feature_id).
  await prisma.$executeRaw`
    DELETE FROM "subclass_feature" a
    USING "subclass_feature" b
    WHERE a."subclass_id" = b."subclass_id"
      AND a."feature_id" = b."feature_id"
      AND a."subclass_feature_id" > b."subclass_feature_id";
  `

  const uniqueLinksMap = new Map<string, SubclassFeatureLink>()
  for (const link of links) {
    const key = `${link.subclass}::${link.feature}`
    if (uniqueLinksMap.has(key)) {
      console.warn(`  seed links: ${link.subclass} - ${link.feature} ( )`)
      continue
    }
    uniqueLinksMap.set(key, link)
  }
  const uniqueLinks = [...uniqueLinksMap.values()]

  const subclasses = await prisma.subclass.findMany({ select: { subclassId: true, name: true } })
  const subclassIdByName = new Map(subclasses.map(s => [s.name, s.subclassId] as const))

  const featuresToResolve = [...new Set(uniqueLinks.map(l => l.feature))]
  const featureRows = await prisma.feature.findMany({
    where: { engName: { in: featuresToResolve } },
    select: { featureId: true, engName: true },
  })
  const featureIdByEngName = new Map(featureRows.map(f => [f.engName, f.featureId] as const))

  for (const link of uniqueLinks) {
    const subclassId = subclassIdByName.get(link.subclass)
    const featureId = featureIdByEngName.get(link.feature)

    if (!subclassId || !featureId) {
      console.warn(` : ${link.subclass} - ${link.feature}`)
      continue
    }

    const existing = await prisma.subclassFeature.findFirst({
      where: { subclassId, featureId },
      orderBy: { subclassFeatureId: "asc" },
    })

    const data = {
      subclassId,
      featureId,
      levelGranted: link.level,
      grantsSpellSlots: subclassSpellSlotFeatures.has(link.feature),
    }

    if (existing) {
      await prisma.subclassFeature.update({
        where: { subclassFeatureId: existing.subclassFeatureId },
        data,
      })
    } else {
      await prisma.subclassFeature.create({ data })
    }
  }

  console.log(`.  ${features.length}   ${uniqueLinks.length}   .`)
}
</file>

<file path="src/lib/components/characterCreator/MultiStepForm.tsx">
"use client";

import React, { useCallback, useEffect, useMemo, useRef, useState } from "react";
import type { Weapon } from "@prisma/client";
import RacesForm from "@/lib/components/characterCreator/RacesForm";
import {CharacterCreateHeader} from "@/lib/components/characterCreator/CharacterCreateHeader";
import {usePersFormStore} from "@/lib/stores/persFormStore";
import ClassesForm from "@/lib/components/characterCreator/ClassesForm";
import BackgroundsForm from "@/lib/components/characterCreator/BackgroundsForm";
import ASIForm from "@/lib/components/characterCreator/ASIForm";
import SkillsForm from "@/lib/components/characterCreator/SkillsForm";
import { BackgroundI, ClassI, RaceI, FeatPrisma } from "@/lib/types/model-types";
import EquipmentForm from "@/lib/components/characterCreator/EquipmentForm";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Check, ChevronLeft, Circle } from "lucide-react";
import GoogleAuthDialog from "@/lib/components/auth/GoogleAuthDialog";
import clsx from "clsx";
import NameForm from "@/lib/components/characterCreator/NameForm";
import ClassChoiceOptionsForm from "@/lib/components/characterCreator/ClassChoiceOptionsForm";
import FeatChoiceOptionsForm from "@/lib/components/characterCreator/FeatChoiceOptionsForm";
import ClassOptionalFeaturesForm from "@/lib/components/characterCreator/ClassOptionalFeaturesForm";
import SubracesForm from "@/lib/components/characterCreator/SubracesForm";
import RaceVariantsForm from "@/lib/components/characterCreator/RaceVariantsForm";
import RaceChoiceOptionsForm from "@/lib/components/characterCreator/RaceChoiceOptionsForm";
import SubclassForm from "@/lib/components/characterCreator/SubclassForm";
import SubclassChoiceOptionsForm from "@/lib/components/characterCreator/SubclassChoiceOptionsForm";
import FeatsForm from "@/lib/components/characterCreator/FeatsForm";
import { ExpertiseForm } from "@/lib/components/characterCreator/ExpertiseForm";

import { createCharacter } from "@/lib/actions/character";
import { toast } from "sonner";
import { useRouter } from "next/navigation";
import { PersFormData } from "@/lib/zod/schemas/persCreateSchema";
import { useSession } from "next-auth/react";

interface Props {
  races: RaceI[]
  classes: ClassI[],
  backgrounds: BackgroundI[],
  weapons: Weapon[],
  feats: FeatPrisma[],
}

export const MultiStepForm = (
  {
    races,
    classes,
    backgrounds,
    weapons,
    feats,
  }: Props
) => {
  const { data: session, status: sessionStatus } = useSession();
  const {
    currentStep,
    prevStep,
    resetForm,
    formData,
    prevRaceId,
    setPrevRaceId,
    setCurrentStep,
    setTotalSteps,
    isHydrated,
  } = usePersFormStore()
  const [authDialogOpen, setAuthDialogOpen] = useState(false);
  const [nextDisabled, setNextDisabled] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const router = useRouter();
  const didMountRef = useRef(false);

  const handleNextDisabledChange = useCallback((disabled: boolean) => {
    setNextDisabled(disabled);
  }, []);

  const handleFinalSubmit = async () => {
    if (sessionStatus !== "authenticated") {
      setAuthDialogOpen(true);
      return;
    }

    setIsSubmitting(true);
    try {
      // We need to ensure formData has the latest name update, which happens in NameForm's onSubmit
      // But handleFinalSubmit is called AS the success callback of NameForm, so formData might not be updated yet in the store?
      // Actually, useStepForm calls updateFormData BEFORE calling onSuccess.
      // So formData in store should be up to date?
      // Wait, zustand updates are synchronous usually, but React state updates are batched.
      // However, we are reading from `formData` which is a const from `usePersFormStore()`.
      // This might be stale in the closure.
      // Better to use `usePersFormStore.getState().formData`.
      
      const currentData = usePersFormStore.getState().formData as PersFormData;
      
      const result = await createCharacter(currentData);

      if (result.error) {
        toast.error(" ", {
          description: result.error
        });
        if (result.details) {
            console.error(result.details);
        }
      } else if (result.success) {
        toast.success(" !");
        resetForm();
        router.push(`/pers/${result.persId}`);
      }
    } catch (e) {
      toast.error("   ...");
      console.error(e);
    } finally {
      setIsSubmitting(false);
    }
  }

  const race = useMemo(() => races.find(r => r.raceId === formData.raceId) as RaceI, [races, formData.raceId])
  const cls = useMemo(() => classes.find(c => c.classId === formData.classId) as ClassI, [classes, formData.classId])
  const subclass = useMemo(
    () => (cls?.subclasses || []).find((sc) => sc.subclassId === formData.subclassId),
    [cls, formData.subclassId]
  );
  const bg = useMemo(() => backgrounds.find(b => b.backgroundId === formData.backgroundId) as BackgroundI, [backgrounds, formData.backgroundId])
  const hasLevelOneChoices = useMemo(
    () => Boolean(cls?.classChoiceOptions?.some((opt) => (opt.levelsGranted || []).includes(1))),
    [cls]
  );
  const hasLevelOneOptionalFeatures = useMemo(
    () => Boolean(cls?.classOptionalFeatures?.some((opt) => (opt.grantedOnLevels || []).includes(1))),
    [cls]
  );
  const hasSubraces = useMemo(() => (race?.subraces?.length ?? 0) > 0, [race]);
  const hasRaceVariants = useMemo(() => (race?.raceVariants?.length ?? 0) > 0, [race]);
  const hasRaceChoiceOptions = useMemo(() => (race as any)?.raceChoiceOptions?.length > 0, [race]);
  const raceVariant = useMemo(() => 
    race?.raceVariants?.find(v => v.raceVariantId === formData.raceVariantId), 
    [race, formData.raceVariantId]
  );
  const hasFeatChoice = useMemo(() => {
    return raceVariant?.name === 'HUMAN_VARIANT';
  }, [raceVariant]);
  const feat = useMemo(() => feats.find(f => f.featId === formData.featId), [feats, formData.featId]);
  const hasFeatChoices = useMemo(() => (feat?.featChoiceOptions?.length ?? 0) > 0, [feat]);

  const hasSubclasses = useMemo(() => {
    if (!cls) return false;
    const allowedClasses = ["CLERIC_2014", "WARLOCK_2014", "SORCERER_2014"];
    return allowedClasses.includes(cls.name) && (cls.subclasses?.length ?? 0) > 0;
  }, [cls]);

  const hasLevelOneSubclassChoices = useMemo(
    () => Boolean(subclass?.subclassChoiceOptions?.some((opt) => (opt.levelsGranted || []).includes(1))),
    [subclass]
  );

  const hasExpertiseChoice = useMemo(() => {
    if (!cls) return false;
    return cls.features.some(f => 
      f.levelGranted === 1 && 
      (f.feature.skillExpertises as any)?.count > 0
    );
  }, [cls]);

  const steps = useMemo(() => {
    const dynamicSteps: { id: string; name: string; component: string }[] = [
      { id: "race", name: "", component: "races" },
    ];

    if (hasSubraces) {
      dynamicSteps.push({ id: "subrace", name: "", component: "subrace" });
    }
    if (hasRaceVariants) {
      dynamicSteps.push({ id: "raceVariant", name: " ", component: "raceVariant" });
    }

    if (hasRaceChoiceOptions) {
      dynamicSteps.push({ id: "raceChoices", name: " ", component: "raceChoices" });
    }

    dynamicSteps.push({ id: "class", name: "", component: "class" });

    if (hasSubclasses) {
      dynamicSteps.push({ id: "subclass", name: "", component: "subclass" });
    }

    if (hasLevelOneSubclassChoices) {
      dynamicSteps.push({ id: "subclassChoices", name: " ", component: "subclassChoices" });
    }

    if (hasLevelOneChoices) {
      dynamicSteps.push({ id: "classChoices", name: " ", component: "classChoices" });
    }

    if (hasLevelOneOptionalFeatures) {
      dynamicSteps.push({ id: "classOptional", name: " ", component: "classOptional" });
    }

    dynamicSteps.push(
      { id: "background", name: "", component: "background" },
      { id: "asi", name: "", component: "asi" },
      { id: "skills", name: "", component: "skills" },
    );

    if (hasExpertiseChoice) {
      dynamicSteps.push({ id: "expertise", name: "", component: "expertise" });
    }

    // MOVED: Feat selection AFTER skills and expertise
    if (hasFeatChoice) {
      dynamicSteps.push({ id: "feat", name: "", component: "feat" });
    }
    if (hasFeatChoices) {
      dynamicSteps.push({ id: "featChoices", name: " ", component: "featChoices" });
    }

    dynamicSteps.push(
      { id: "equipment", name: "", component: "equipment" },
      { id: "name", name: "", component: "name" },
    );

    return dynamicSteps;
  }, [hasLevelOneChoices, hasLevelOneOptionalFeatures, hasSubraces, hasRaceVariants, hasRaceChoiceOptions, hasSubclasses, hasLevelOneSubclassChoices, hasFeatChoice, hasFeatChoices, hasExpertiseChoice]);

  useEffect(() => {
    const total = steps.length;
    setTotalSteps(total);
    
    // DON'T reset currentStep if:
    // 1. Store hasn't hydrated yet (data still loading from localStorage)
    // 2. formData suggests user has progressed beyond what steps currently show
    //    (e.g. user has featId but steps don't include feat step yet)
    
    if (!isHydrated) {
      // Wait for hydration to complete before adjusting steps
      return;
    }
    
    // Check if formData has critical fields that suggest more steps should exist
    const hasProgressedData = 
      formData.raceId || 
      formData.classId || 
      formData.backgroundId ||
      formData.featId ||
      formData.skills?.length ||
      formData.name;
    
    // Only reduce currentStep if we're confident steps calculation is accurate
    // If user has data but steps is short, it means dependencies (race/class) aren't loaded yet
    if (currentStep > total) {
      // If user has formData but steps seem incomplete, DON'T reset yet
      if (hasProgressedData && total < 8) {
        // Likely still initializing - wait for races/classes to load
        console.log('[MultiStepForm] Waiting for data to load before adjusting currentStep');
        return;
      }
      
      // Safe to reset - either no data, or steps calculation is complete
      setCurrentStep(total);
    }
  }, [steps, currentStep, isHydrated, formData, setCurrentStep, setTotalSteps]);

  const renderStep = () => {
    const activeComponent = steps[currentStep - 1]?.component;

    switch (activeComponent) {
      case "races":
        return (
          <RacesForm
            races={races}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "subrace":
        return (
          <SubracesForm
            race={race}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "raceVariant":
        return (
          <RaceVariantsForm
            race={race}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "raceChoices":
        return (
          <RaceChoiceOptionsForm
            race={race}
            subraceId={formData.subraceId ?? null}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "feat":
        return (
          <FeatsForm
            feats={feats}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "featChoices":
        return (
          <FeatChoiceOptionsForm
            selectedFeat={feat}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "class":
        return (
          <ClassesForm
            classes={classes}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "subclass":
        return (
          <SubclassForm
            cls={cls}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "subclassChoices":
        return (
          <SubclassChoiceOptionsForm
            selectedSubclass={subclass}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "classChoices":
        return (
          <ClassChoiceOptionsForm
            selectedClass={cls}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "classOptional":
        return (
          <ClassOptionalFeaturesForm
            selectedClass={cls}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "background":
        return (
          <BackgroundsForm
            backgrounds={backgrounds}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "asi":
        if (!race || !cls) {
          return (
            <Card className="p-4 text-center text-slate-200">
                  .
            </Card>
          );
        }
        return (
          <ASIForm
            race={race}
            raceVariant={raceVariant}
            selectedClass={cls}
            prevRaceId={prevRaceId}
            setPrevRaceId={setPrevRaceId}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "skills":
        if (!race || !cls || !bg) {
          return (
            <Card className="p-4 text-center text-slate-200">
                ,   .
            </Card>
          );
        }
        return (
          <SkillsForm
            race={race}
            raceVariant={raceVariant}
            selectedClass={cls}
            background={bg}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "expertise":
        return (
          <ExpertiseForm
            selectedClass={cls}
            race={race}
            background={bg}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "equipment":
        if (!race || !cls) {
          return (
            <Card className="p-4 text-center text-slate-200">
                 .
            </Card>
          );
        }
        return (
          <EquipmentForm
            weapons={weapons}
            selectedClass={cls}
            race={race}
            formId={activeFormId}
            onNextDisabledChange={handleNextDisabledChange}
          />
        );
      case "name":
        return (
          <NameForm
            formId={activeFormId}
            race={race}
            raceVariant={raceVariant}
            selectedClass={cls}
            background={bg}
            feat={feat}
            onSuccess={handleFinalSubmit}
          />
        );
      default:
        return null;
    }
  }

  const progress = Math.round((currentStep / steps.length) * 100);
  const activeFormId = `character-step-form-${currentStep}`;

  useEffect(() => {
    setNextDisabled(false);
  }, [currentStep]);

  useEffect(() => {
    if (!isHydrated) return;
    if (!didMountRef.current) {
      didMountRef.current = true;
      return;
    }

    const prefersReducedMotion =
      typeof window !== "undefined" &&
      window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches;

    window.scrollTo({ top: 0, left: 0, behavior: prefersReducedMotion ? "auto" : "smooth" });
  }, [currentStep, isHydrated]);

  return (
    <div className="mx-auto flex w-full max-w-6xl flex-col gap-4 px-3 py-4 pb-24 sm:px-4 md:gap-6 md:px-0 md:py-6">
      <CharacterCreateHeader
        onReset={resetForm}
        onOpenAuth={() => setAuthDialogOpen(true)}
        isAuthenticated={sessionStatus === "authenticated" && !!session?.user}
      />

      <Card className="shadow-2xl">
        <CardContent className="grid gap-3 p-3 sm:gap-4 sm:p-4 md:grid-cols-[1fr,300px] md:p-6">
          <div className="glass-panel border-gradient-rpg space-y-3 rounded-xl p-3 sm:space-y-4 sm:p-4 md:p-5">
            {renderStep()}
          </div>

          <aside className="glass-panel border-gradient-rpg rounded-xl p-3 sm:p-4">
          <div className="sticky top-14 sm:top-16">
            <div className="flex items-center justify-between text-xs text-slate-400 sm:text-sm">
                <span className="font-medium text-slate-200"> </span>
                <Badge variant="outline" className="border-white/15 bg-white/5 text-[11px] text-slate-200 sm:text-xs">
                  {progress}% 
                </Badge>
              </div>

              <div className="mt-3 space-y-1.5 sm:mt-4 sm:space-y-2">
                {steps.map((step, index) => {
                  const stepOrder = index + 1;
                  const isDone = stepOrder < currentStep;
                  const isActive = stepOrder === currentStep;

                  return (
                    <div
                      key={step.id}
                      className={clsx(
                        "flex w-full items-center justify-between rounded-lg border px-2.5 py-2 text-left sm:px-3",
                        isActive
                          ? "border-gradient-rpg border-gradient-rpg-active glass-active bg-white/5 text-white"
                          : "border-white/10 bg-white/5 text-slate-300 hover:bg-white/7"
                      )}
                    >
                      <div>
                        <p className="text-[10px] uppercase tracking-[0.16em] text-slate-400 sm:text-[11px]">
                           {stepOrder}
                        </p>
                        <p className="text-xs font-semibold sm:text-sm">{step.name}</p>
                      </div>
                      {isDone ? (
                        <Badge variant="secondary" className="bg-emerald-500/20 text-emerald-200">
                          <Check className="h-4 w-4" />
                        </Badge>
                      ) : (
                        <Badge
                          variant="outline"
                          className={clsx(
                            "border-white/15 bg-white/5 text-slate-300",
                            isActive && "border-gradient-rpg border-gradient-rpg-active glass-active text-slate-100"
                          )}
                        >
                          <Circle className="h-3 w-3" />
                        </Badge>
                      )}
                    </div>
                  );
                })}
              </div>

              <div className="mt-4 h-1.5 rounded-full bg-white/10 sm:mt-5 sm:h-2">
                <div
                  className="h-1.5 rounded-full bg-gradient-to-r from-indigo-500 via-sky-500 to-emerald-400 transition-all sm:h-2"
                  style={{ width: `${progress}%` }}
                />
              </div>
            </div>
          </aside>
        </CardContent>
      </Card>

      <div className="sticky bottom-0 left-0 right-0 z-30 w-full px-2 pb-3 sm:px-3 md:px-0">
        <div className="border-gradient-rpg mx-auto flex w-full max-w-6xl items-center justify-between rounded-xl border-t border-white/10 bg-slate-900/95 px-2.5 py-2.5 backdrop-blur-xl shadow-xl shadow-black/30 sm:rounded-2xl sm:px-3 sm:py-3">
          <div className="flex items-center gap-2 text-xs text-slate-300 sm:gap-3 sm:text-sm">
            <Badge variant="secondary" className="bg-white/5 text-white text-[11px] sm:text-xs">
               {currentStep} / {steps.length}
            </Badge>
            <span className="hidden text-slate-400 sm:inline"> {progress}%</span>
          </div>
          <div className="flex items-center gap-2">
            {currentStep > 1 && (
              <Button
                type="button"
                variant="ghost"
                size="sm"
                className="border border-white/10 bg-white/5 text-sm text-slate-200 hover:bg-white/7 sm:text-base"
                onClick={prevStep}
              >
                <ChevronLeft className="mr-2 h-4 w-4" />
                
              </Button>
            )}
            <Button
              type="submit"
              form={activeFormId}
              disabled={nextDisabled || isSubmitting}
              size="sm"
              className="bg-gradient-to-r from-indigo-500 via-blue-500 to-emerald-500 text-sm text-white shadow-lg shadow-indigo-500/20 sm:text-base"
            >
              {currentStep === steps.length ? (isSubmitting ? "..." : "") : " "}
            </Button>
          </div>
        </div>
      </div>

      <GoogleAuthDialog open={authDialogOpen} onOpenChange={setAuthDialogOpen} />
    </div>
  )
}

export default MultiStepForm
</file>

<file path="src/lib/components/characterCreator/EntityInfoDialog.tsx">
"use client";

import { ReactNode } from "react";
import { CircleHelp } from "lucide-react";
import clsx from "clsx";
import { useModalBackButton } from "@/hooks/useModalBackButton";

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";

export const InfoDialogContent = ({
  title,
  subtitle,
  children,
  className,
}: {
  title: string;
  subtitle?: string;
  children: ReactNode;
  className?: string;
}) => {
  return (
    <DialogContent
      className={clsx(
        "max-h-[85vh] w-[95vw] max-w-lg overflow-y-auto",
        "shadow-2xl ring-1 ring-white/20",
        className
      )}
    >
      <div className="absolute left-1/2 top-0 h-[2px] w-1/3 -translate-x-1/2 bg-gradient-to-r from-transparent via-cyan-400/60 to-transparent" />

      <DialogHeader className="space-y-3 border-b border-white/10 pb-4">
        <DialogTitle className="font-rpg-display text-2xl font-semibold uppercase tracking-widest text-slate-200">
          {title}
        </DialogTitle>
        {subtitle && (
          <DialogDescription className="text-sm font-medium text-slate-300">
            {subtitle}
          </DialogDescription>
        )}
      </DialogHeader>

      <div className="space-y-4 pt-4 text-sm leading-relaxed text-slate-200/90 sm:text-base">{children}</div>
    </DialogContent>
  );
};

interface InfoDialogProps {
  title: string;
  subtitle?: string;
  triggerLabel: string;
  triggerClassName?: string;
  children: ReactNode;
}

export const InfoDialog = ({
  title,
  subtitle,
  triggerLabel,
  triggerClassName,
  children,
}: InfoDialogProps) => {
  return (
    <Dialog>
      <div 
        data-stop-card-click
        onPointerDown={(e) => {
          // Prevent the underlying Card onClick when the trigger overlaps the card.
          // Must NOT be capture-phase; capture would block the click from reaching the trigger.
          e.stopPropagation();
        }}
        onClick={(e) => {
          e.stopPropagation();
        }}
        className={clsx(
          "absolute -right-2.5 -top-2.5 z-[50] sm:-right-3 sm:-top-3",
          triggerClassName
        )}
      >
        <DialogTrigger asChild>
          <Button
            data-stop-card-click
            type="button"
            size="icon"
            variant="secondary"
            className="glass-panel border-gradient-rpg h-9 w-9 rounded-full text-slate-100 transition-all duration-200 hover:text-white focus-visible:ring-cyan-400/30"
            aria-label={triggerLabel}
          >
            <CircleHelp className="h-5 w-5" />
          </Button>
        </DialogTrigger>
      </div>
      
      <InfoDialogContent title={title} subtitle={subtitle}>
        {children}
      </InfoDialogContent>
    </Dialog>
  );
};

export const ControlledInfoDialog = ({
  open,
  onOpenChange,
  title,
  subtitle,
  children,
  contentClassName,
}: {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  title: string;
  subtitle?: string;
  children: ReactNode;
  contentClassName?: string;
}) => {
  useModalBackButton(open, () => onOpenChange(false));

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <InfoDialogContent title={title} subtitle={subtitle} className={contentClassName}>
        {children}
      </InfoDialogContent>
    </Dialog>
  );
};

export const InfoGrid = ({ children }: { children: ReactNode }) => (
  <div className="grid gap-2 sm:grid-cols-2">{children}</div>
);

export const InfoPill = ({
  label,
  value,
}: {
  label: string;
  value: ReactNode;
}) => {
  if (!value || value === "") return null;
  
  return (
    <div className="rounded-lg border border-white/10 bg-white/5 px-3 py-2">
      <p className="text-[11px] uppercase tracking-[0.14em] text-slate-400">
        {label}
      </p>
      <div className="text-sm font-semibold leading-tight text-slate-100">
        {value}
      </div>
    </div>
  );
};

export const InfoSectionTitle = ({ children }: { children: ReactNode }) => (
  <p className="text-xs font-semibold uppercase tracking-[0.16em] text-slate-300">
    {children}
  </p>
);

export default InfoDialog;
</file>

<file path="src/lib/components/characterCreator/EquipmentForm.tsx">
import {equipmentSchema} from "@/lib/zod/schemas/persCreateSchema";
import {useStepForm} from "@/hooks/useStepForm";
import {ClassI, RaceI} from "@/lib/types/model-types";
import {useEffect, useMemo, useState} from "react";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import { ClassStartingEquipmentOption, Weapon, WeaponType } from "@prisma/client";
import {groupBy} from "@/lib/server/formatters/generalFormatters";
import clsx from "clsx";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter, DialogClose } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Tabs, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { WeaponKindType } from "@/lib/types/enums";
import { weaponTranslations, weaponTranslationsEng } from "@/lib/refs/translation";
import { useModalBackButton } from "@/hooks/useModalBackButton";

interface Props {
  race: RaceI
  selectedClass: ClassI
  weapons: Weapon[]
  formId: string
  onNextDisabledChange?: (disabled: boolean) => void
}

const constToCamel: Record<string, WeaponKindType> = {
  SIMPLE_WEAPON: "meleeSimple", 
  MARTIAL_WEAPON: "meleeMartial",  
}

export const EquipmentForm = ({selectedClass, weapons, formId, onNextDisabledChange}: Props) => {
  const { updateFormData, nextStep } = usePersFormStore();
  
  const {form, onSubmit} = useStepForm(equipmentSchema, (data) => {
    updateFormData({ equipmentSchema: data });
    nextStep();
  });

  const choiceGroupToId = (form.watch('choiceGroupToId') ?? {}) as Record<string, number[]>
  const anyWeaponSelection = (form.watch('anyWeaponSelection') ?? {}) as Record<string, number[]>

  const choiceGroups = selectedClass.startingEquipmentOption
  const choiceGroupsGrouped: Record<string, Record<string, ClassStartingEquipmentOption[]>> = useMemo(() => {
    const raw = groupBy(choiceGroups ?? [], (group) => group.choiceGroup)
    const grouped: Record<string, Record<string, ClassStartingEquipmentOption[]>> = {}
    for (const [choiceGroup, group] of Object.entries(raw)) {
      grouped[choiceGroup] = groupBy(group, (g) => g.option)
    }
    return grouped
  }, [choiceGroups])

  const meleeSimple = useMemo(() => weapons.filter(w => !w.isRanged && w.weaponType === WeaponType.SIMPLE_WEAPON).sort((a, b) => a.sortOrder - b.sortOrder), [weapons]);
  const meleeMartial = useMemo(() => weapons.filter(w => !w.isRanged && w.weaponType === WeaponType.MARTIAL_WEAPON).sort((a, b) => a.sortOrder - b.sortOrder), [weapons]);
  
  const rangedSimple = useMemo(() => weapons.filter(w => w.isRanged && w.weaponType === WeaponType.SIMPLE_WEAPON).sort((a, b) => a.sortOrder - b.sortOrder), [weapons]);
  const rangedMartial= useMemo(() => weapons.filter(w => w.isRanged && (w.weaponType === WeaponType.MARTIAL_WEAPON || (w.weaponType === WeaponType.FIREARMS && !w.isAdditional))).sort((a, b) => a.sortOrder - b.sortOrder), [weapons]);
  const firearmsAdditional = useMemo(() => weapons.filter(w => w.isRanged && w.isAdditional).sort((a, b) => a.sortOrder - b.sortOrder), [weapons]);
  const weaponsByKind = useMemo(() => ({
    'meleeSimple': meleeSimple,
    'meleeMartial': meleeMartial,
    'rangedSimple': rangedSimple,
    'rangedMartial': rangedMartial,
    'firearmsAdditional': firearmsAdditional
  }), 
  [meleeSimple, meleeMartial, rangedSimple, rangedMartial, firearmsAdditional])

  const [weaponDialogOpen, setWeaponDialogOpen] = useState(false);
  const [weaponDialogIsMartial, setWeaponDialogIsMartial] = useState(false);
  const [weaponDialogGroup, setWeaponDialogGroup] = useState<string | null>(null);
  const [weaponDialogIndex, setWeaponDialogIndex] = useState<number>(0);
  const [weaponFilter, setWeaponFilter] = useState<WeaponKindType | undefined>(() => {
    const weaponType = (choiceGroups ?? []).find(g => g.chooseAnyWeapon)?.weaponType;
    return weaponType 
      ? constToCamel[weaponType]
      : undefined;
  });
  const [selectedWeaponId, setSelectedWeaponId] = useState<number | null>(null);

  useModalBackButton(weaponDialogOpen, () => setWeaponDialogOpen(false));

  const chooseOption = (optionGroup: ClassStartingEquipmentOption[]) => {
    const choiceGroup = optionGroup[0].choiceGroup
    const newOptions = optionGroup.map(g => g.optionId)

    form.setValue(`choiceGroupToId.${choiceGroup}`, newOptions, { shouldDirty: true });

    if (weaponFilter) {
      const weaponCount = optionGroup[0]?.weaponCount ?? 1;
      const existing = (form.getValues(`anyWeaponSelection.${choiceGroup}`) as number[] | undefined) ?? [];
      const defaults = weaponsByKind[weaponFilter]
        .slice(0, weaponCount)
        .map(w => w.weaponId);
      const fallback = weaponsByKind[weaponFilter][0]?.weaponId ?? weapons[0]?.weaponId;
      const selection = Array.from({ length: weaponCount }, (_, idx) => existing[idx] ?? defaults[idx] ?? fallback).filter((id): id is number => typeof id === 'number');
      form.setValue(`anyWeaponSelection.${choiceGroup}`, selection, { shouldDirty: true });
    }
  }

  const openWeaponDialog = (choiceGroup: string, isMartial: boolean, weaponIndex: number) => {
    if (!weaponFilter) return;
    setWeaponDialogIndex(weaponIndex);
    setWeaponDialogGroup(choiceGroup);
    const currentWeapons = (form.getValues(`anyWeaponSelection.${choiceGroup}`) as number[] | undefined) ?? [];
    const fallback = weaponsByKind[weaponFilter][weaponIndex]?.weaponId ?? weaponsByKind[weaponFilter][0]?.weaponId ?? null;
    setSelectedWeaponId(currentWeapons[weaponIndex] ?? fallback);
    setWeaponDialogOpen(true);
    setWeaponDialogIsMartial(isMartial);
  }

  const saveWeaponSelection = () => {
    if (!weaponDialogGroup || selectedWeaponId == null) {
      setWeaponDialogOpen(false);
      return;
    }
    const currentWeapons = (form.getValues(`anyWeaponSelection.${weaponDialogGroup}`) as number[] | undefined) ?? [];
    const updatedWeapons = [...currentWeapons];
    updatedWeapons[weaponDialogIndex] = selectedWeaponId;
    form.setValue(`anyWeaponSelection.${weaponDialogGroup}`, updatedWeapons, { shouldDirty: true });
    setWeaponDialogOpen(false);
  }

  useEffect(() => {
    if (!weaponFilter) return;
    const list = weaponsByKind[weaponFilter]
    if (selectedWeaponId != null && list?.some(w => w.weaponId === selectedWeaponId)) return;
    const fallback = list[0]?.weaponId ?? weapons[0]?.weaponId ?? null;
    setSelectedWeaponId(fallback);
  }, [weaponFilter, weaponsByKind, selectedWeaponId, weapons]);

  useEffect(() => {
    form.register("choiceGroupToId");
    form.register("anyWeaponSelection");
  }, [form]);

  useEffect(() => {
    onNextDisabledChange?.(false);
  }, [onNextDisabledChange]);

  useEffect(() => {
    if (!choiceGroupsGrouped || Object.keys(choiceGroupsGrouped).length === 0) return

    const current = form.getValues('choiceGroupToId')
    if (current && Object.keys(current).length > 0) return

    const initialChoiceGroupToId: Record<string, number[]> = {}
    const initialAnyWeaponSelection: Record<string, number[]> = {}

    Object.entries(choiceGroupsGrouped).forEach(([choiceGroup, choiceGroupToOptionGroup]) => {
      const optionGroup = choiceGroupToOptionGroup['a'] ?? Object.values(choiceGroupToOptionGroup)[0]
      if (!optionGroup?.[0]) return

      initialChoiceGroupToId[choiceGroup] = [optionGroup[0].optionId]

      const hasAny = optionGroup.some((o) => o.chooseAnyWeapon)
      if (hasAny && weaponFilter) {
        const weaponCount = optionGroup[0].weaponCount ?? 1
        const defaults = weaponsByKind[weaponFilter]
          .slice(0, weaponCount)
          .map((w) => w.weaponId)
        const fallback = weaponsByKind[weaponFilter]?.[0]?.weaponId ?? weapons[0]?.weaponId
        initialAnyWeaponSelection[choiceGroup] = Array.from(
          { length: weaponCount },
          (_, idx) => defaults[idx] ?? fallback
        ).filter((id): id is number => typeof id === 'number')
      }
    })

    form.setValue('choiceGroupToId', initialChoiceGroupToId, { shouldDirty: false })
    form.setValue('anyWeaponSelection', initialAnyWeaponSelection, { shouldDirty: false })
    onNextDisabledChange?.(false)
  }, [choiceGroupsGrouped, form, weaponsByKind, weaponFilter, weapons, onNextDisabledChange])


  const renderWeaponDialog = () => {
    if (!weaponFilter) return;
    const isMartial = weaponDialogIsMartial;
    const list = weaponsByKind[weaponFilter];
    return (
      <Dialog open={weaponDialogOpen} onOpenChange={setWeaponDialogOpen}>
        <DialogContent className="sm:max-w-[520px]">
          <DialogHeader>
            <DialogTitle className="text-white"> {isMartial && ''} </DialogTitle>
            <DialogDescription className="text-slate-400">
                  .
            </DialogDescription>
          </DialogHeader>

          <Tabs value={weaponFilter} onValueChange={(val: string) => setWeaponFilter(val as WeaponKindType)}>
            <TabsList className="grid grid-cols-2 bg-white/5">
              <TabsTrigger value={isMartial ? 'meleeMartial' : 'meleeSimple'} className="data-[state=active]:bg-white/7 data-[state=active]:text-white">
                 
              </TabsTrigger>
              <TabsTrigger value={isMartial ? 'rangedMartial' : 'rangedSimple'} className="data-[state=active]:bg-white/7 data-[state=active]:text-white">
                 
              </TabsTrigger>
            </TabsList>
            {/* <TabsContent value={isMartial ? 'meleeMartial' : 'meleeSimple'} />
            <TabsContent value={isMartial ? 'rangedMartial' : 'rangedSimple'} /> */} {/* No need for content, we just filter the list above based on selected tab */}
          </Tabs>

          <div className="space-y-2">
            <label className="text-sm text-slate-200">{isMartial ? ' ' : ' '}</label>
            <select
              className="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-white"
              value={selectedWeaponId ?? ''}
              onChange={(e) => setSelectedWeaponId(Number(e.target.value))}
            >
              {list.map((w) => (
                <option key={w.weaponId} value={w.weaponId} title={weaponTranslationsEng[w.name]}>
                  {weaponTranslations[w.name]}
                </option>
              ))}
            </select>
          </div>

          <DialogFooter className="mt-4 flex justify-end gap-2">
            <DialogClose asChild>
              <Button variant="ghost"></Button>
            </DialogClose>
            <Button onClick={saveWeaponSelection} className="bg-indigo-500 text-white"></Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    )
  }

  const weaponNameById = (id?: number) => weapons.find(w => w.weaponId === id);

  return (
    <form id={formId} onSubmit={onSubmit} className="glass-panel border-gradient-rpg space-y-4 rounded-xl p-4">
      <Card className="shadow-xl">
        <CardHeader>
          <CardTitle className="text-white"></CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {Object.entries(choiceGroupsGrouped).map(([choiceGroup, choiceGroupToOptionGroup], index) => (
            <div key={index} className="glass-panel border-gradient-rpg rounded-lg p-3">
              <div className="flex items-center justify-between">
                <p className="text-sm font-semibold text-white"> {choiceGroup}</p>
                <Badge className="cursor-default border border-white/15 bg-white/5 text-slate-200"> </Badge>
              </div>
              <div className="mt-3 space-y-2">
                {Object.values(choiceGroupToOptionGroup).map((optionGroup, idx) => {
                  const entry = optionGroup[0]
                  const output = optionGroup.map(g => g.description).join(', ')
                  const checked = !!(choiceGroupToId[choiceGroup]?.includes?.(entry.optionId))
                  const hasAnyWeapon = optionGroup.some(g => g.chooseAnyWeapon)
                  const selectedWeapons = anyWeaponSelection?.[choiceGroup] ?? [];

                  return (
                    <div
                      key={idx}
                      className={clsx(
                        "rounded-lg border px-3 py-2",
                        checked
                          ? "border-gradient-rpg border-gradient-rpg-active glass-active bg-white/5"
                          : "border-white/10 bg-white/5"
                      )}
                    >
                      <label className="flex items-center gap-2 text-slate-200 cursor-pointer">
                        <input
                          type="radio"
                          name={ choiceGroup }
                          onChange={ () => chooseOption(optionGroup) }
                          checked={checked}
                          className="h-4 w-4"
                        />
                        <span>{output}</span>
                      </label>
                      {hasAnyWeapon && checked && (
                        <div className="mt-2 space-y-2">
                          {Array.from({ length: entry.weaponCount || 1 }).map((_, weaponIdx) => {
                            const selectedWeaponName = weaponTranslations[weaponNameById(selectedWeapons?.[weaponIdx])?.name ?? ''] ?? ' ';
                            return (
                              <div key={weaponIdx} className="flex items-center justify-between rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-slate-200">
                                <div>
                                  <p className="text-xs text-slate-400"> #{weaponIdx + 1}</p>
                                  <p>{selectedWeaponName}</p>
                                </div>
                                <Button
                                  type="button"
                                  size="sm"
                                  variant="secondary"
                                  className="border border-white/15 bg-white/5 text-slate-100 hover:bg-white/7"
                                  onClick={() => openWeaponDialog(choiceGroup, entry.weaponType === WeaponType.MARTIAL_WEAPON, weaponIdx)}
                                >
                                   
                                </Button>
                              </div>
                            )
                          })}
                        </div>
                      )}
                    </div>
                  )
                })}
              </div>
            </div>
          ))}
        </CardContent>
      </Card>
      {renderWeaponDialog()}
    </form>
  )
};

export default EquipmentForm
</file>

<file path="src/app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;


@layer utilities {
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(.96);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
            transform: scale(1);
        }
        to {
            opacity: 0;
            transform: scale(.96)
        }
    }

    .animate-fadeIn {
        animation: fadeIn 0.15s ease-out forwards;
    }
    .animate-fadeOut {
        animation: fadeOut 0.15s ease-in forwards;
    }

    /* Arcane Glassmorphism Card */
    .glass-card {
        @apply bg-slate-900/60 border border-white/10;
        box-shadow: 0 4px 16px -8px rgba(0,0,0,0.6);
    }

    .glass-card:hover {
        @apply bg-slate-900/75 border-white/15;
        box-shadow: 0 6px 20px -8px rgba(0,0,0,0.7);
    }

    /* Same vibe, but for inset panels (search boxes, sidebars) */
    .glass-panel {
        /* Stabilize: prefer clean translucency over blur for perf */
        @apply bg-slate-950/30 ring-1 ring-white/10;
        background-image: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.012) 55%, rgba(255,255,255,0) 75%);
        box-shadow:
            0 10px 32px -34px rgba(0,0,0,0.95),
            inset 1px 1px 0 rgba(255,255,255,0.10),
            inset -1px -1px 0 rgba(0,0,0,0.35);
    }

    /* Selected state glow (inner + outer) */
    .glass-active {
        @apply bg-blue-500/15 border-blue-400/60;
        box-shadow:
            0 0 0 1px rgba(96, 165, 250, 0.3),
            0 4px 24px -4px rgba(59, 130, 246, 0.5),
            inset 0 0 20px rgba(96, 165, 250, 0.1);
    }

    .glass-active:hover {
        @apply bg-blue-500/20 border-blue-400/80;
        box-shadow:
            0 0 0 1px rgba(96, 165, 250, 0.5),
            0 6px 28px -4px rgba(59, 130, 246, 0.6),
            inset 0 0 24px rgba(96, 165, 250, 0.15);
    }

    .border-gradient-rpg {
        @apply border border-white/10;
    }

    .border-gradient-rpg-active {
        @apply border-blue-400/60;
    }
}





@layer base {
  :root {
        --background: 0 0% 100%;
        --foreground: 222.2 84% 4.9%;
        --card: 0 0% 100%;
        --card-foreground: 222.2 84% 4.9%;
        --popover: 0 0% 100%;
        --popover-foreground: 222.2 84% 4.9%;
        --primary: 222.2 47.4% 11.2%;
        --primary-foreground: 210 40% 98%;
        --secondary: 210 40% 96.1%;
        --secondary-foreground: 222.2 47.4% 11.2%;
        --muted: 210 40% 96.1%;
        --muted-foreground: 215.4 16.3% 46.9%;
        --accent: 210 40% 96.1%;
        --accent-foreground: 222.2 47.4% 11.2%;
        --destructive: 0 84.2% 60.2%;
        --destructive-foreground: 210 40% 98%;
        --border: 214.3 31.8% 91.4%;
        --input: 214.3 31.8% 91.4%;
        --ring: 222.2 84% 4.9%;
        --chart-1: 12 76% 61%;
        --chart-2: 173 58% 39%;
        --chart-3: 197 37% 24%;
        --chart-4: 43 74% 66%;
        --chart-5: 27 87% 67%;
        --radius: 0.5rem;
    }
  .dark {
        --background: 222.2 84% 4.9%;
        --foreground: 210 40% 98%;
        --card: 222.2 84% 4.9%;
        --card-foreground: 210 40% 98%;
        --popover: 222.2 84% 4.9%;
        --popover-foreground: 210 40% 98%;
        --primary: 210 40% 98%;
        --primary-foreground: 222.2 47.4% 11.2%;
        --secondary: 217.2 32.6% 17.5%;
        --secondary-foreground: 210 40% 98%;
        --muted: 217.2 32.6% 17.5%;
        --muted-foreground: 215 20.2% 65.1%;
        --accent: 217.2 32.6% 17.5%;
        --accent-foreground: 210 40% 98%;
        --destructive: 0 62.8% 30.6%;
        --destructive-foreground: 210 40% 98%;
        --border: 217.2 32.6% 17.5%;
        --input: 217.2 32.6% 17.5%;
        --ring: 212.7 26.8% 83.9%;
        --chart-1: 220 70% 50%;
        --chart-2: 160 60% 45%;
        --chart-3: 30 80% 55%;
        --chart-4: 280 65% 60%;
        --chart-5: 340 75% 55%;
    }
}

@layer base {
  body {
                @apply bg-slate-950 text-slate-200;
  }
}

@layer utilities {
    .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: rgba(148, 163, 184, 0.35) rgba(2, 6, 23, 0.3);
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(2, 6, 23, 0.3);
        border-radius: 9999px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.35);
        border: 2px solid rgba(2, 6, 23, 0.3);
        border-radius: 9999px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(148, 163, 184, 0.5);
    }
}





@layer base {
  * {
    @apply border-border;
    }
}
</file>

<file path="src/app/layout.tsx">
import React, { Suspense } from "react";
import { Cinzel, Forum, Inter, JetBrains_Mono } from "next/font/google";
import { Metadata, Viewport } from "next";
import './globals.css'
import { Navigation } from "@/components/ui/Navigation";
import { App } from "@/components/ui/App";
import { Providers } from "@/app/providers";
import { SpellInfoModal } from "@/lib/components/characterSheet/SpellInfoModal";

const inter = Inter({
  subsets: ['latin'],
  display: 'swap',
  variable: '--font-inter',
});

const jetBrainsMono = JetBrains_Mono({
  subsets: ['latin'],
  weight: ['400', '700'],
  variable: '--font-jetbrains-mono',
});

// Cinzel looks great for Latin, but has no Cyrillic glyphs (UA titles would fallback).
const cinzel = Cinzel({
  subsets: ["latin"],
  display: "swap",
  variable: "--font-cinzel",
});

// Primary RPG display font: Cyrillic-capable carved/antique vibe.
const rpgDisplay = Forum({
  subsets: ["latin", "cyrillic"],
  display: "swap",
  weight: ["400"],
  variable: "--font-rpg-display",
});


export const viewport: Viewport = {
  width: "device-width",
  initialScale: 1,
  maximumScale: 1,
  viewportFit: "cover",
};

export const metadata: Metadata = {
  title: ' ',
  description: 'Spells Holota Family -      !  ,  , , , ,  - !',
  icons: {
    icon: [
      {
        media: '(prefers-color-scheme: light)',
        url: '/images/dark-favicon.ico',
        href: '/images/dark-favicon.ico',
        sizes: 'any',
        type: 'image/x-icon',
      },
      {
        media: '(prefers-color-scheme: dark)',
        url: '/images/favicon.ico',
        href: '/images/favicon.ico',
        sizes: 'any',
        type: 'image/x-icon',
      },

    ]
  }
}

export default function RootLayout(
  { children, }:
    { children: React.ReactNode }
) {
  return (
    <html lang={ 'uk' } className="h-full w-full dark">
    <body
      className={ `${ jetBrainsMono.variable } ${ inter.variable } ${ cinzel.variable } ${ rpgDisplay.variable } relative bg-slate-950 text-slate-200 h-full w-full overflow-x-hidden antialiased` }>
    <div aria-hidden className="pointer-events-none fixed inset-0 -z-10 overflow-hidden">
      <div className="absolute inset-0 bg-slate-950" />
      {/* Mesh gradient layers */}
      <div className="absolute -inset-[30%] bg-[radial-gradient(ellipse_at_top_left,_var(--tw-gradient-stops))] from-indigo-950/55 via-purple-950/10 to-transparent blur-3xl" />
      <div className="absolute -inset-[30%] bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-purple-950/45 via-indigo-950/0 to-transparent blur-3xl" />
      <div className="absolute -inset-[30%] bg-[radial-gradient(ellipse_at_bottom,_var(--tw-gradient-stops))] from-indigo-950/45 via-slate-950/0 to-transparent blur-3xl" />

      {/* Noise overlay via SVG turbulence */}
      <svg
        className="absolute inset-0 h-full w-full opacity-[0.05] mix-blend-overlay"
        aria-hidden="true"
      >
        <filter id="rpg-noise">
          <feTurbulence
            type="fractalNoise"
            baseFrequency="0.85"
            numOctaves="3"
            stitchTiles="stitch"
          />
          <feColorMatrix type="saturate" values="0" />
        </filter>
        <rect width="100%" height="100%" filter="url(#rpg-noise)" />
      </svg>
    </div>
    <Providers>
      <div className="grid min-h-screen w-full grid-rows-[1fr_auto] md:grid-rows-1 md:grid-cols-[88px_1fr]">
        <Navigation/>
        <App>{ children }</App>
      </div>
      <Suspense fallback={null}>
        <SpellInfoModal />
      </Suspense>
    </Providers>
    </body>
    </html>
  )
}
</file>

<file path="src/lib/components/characterCreator/BackgroundsForm.tsx">
"use client";

// import type {Background} from "@prisma/client"
import {
  backgroundTranslations, backgroundTranslationsEng,
} from "@/lib/refs/translation";
import clsx from "clsx";
import {useStepForm} from "@/hooks/useStepForm";
import {backgroundSchema} from "@/lib/zod/schemas/persCreateSchema";
import { useEffect, useMemo, useCallback } from "react";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Search, X } from "lucide-react";
import {
  InfoDialog,
  InfoGrid,
  InfoPill,
  InfoSectionTitle,
} from "@/lib/components/characterCreator/EntityInfoDialog";
import { SourceBadge } from "@/lib/components/characterCreator/SourceBadge";
import {
  formatLanguages,
  formatSkillProficiencies,
  formatToolProficiencies,
  translateValue,
} from "@/lib/components/characterCreator/infoUtils";
import { BackgroundI } from "@/lib/types/model-types";
import { FormattedDescription } from "@/components/ui/FormattedDescription";

const normalizeText = (value?: string) =>
  (value || "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .trim();

const parseItems = (items: unknown): string[] => {
  if (!Array.isArray(items)) return [];

  return (items as unknown[])
    .map((item) => {
      if (!item) return null;
      if (typeof item === "string") return item;
      if (typeof item === "object") {
        const name = (item as any).name;
        const quantity = (item as any).quantity;
        if (!name) return null;
        return quantity ? `${name} x${quantity}` : name;
      }
      return null;
    })
    .filter(Boolean) as string[];
};

interface Props {
  backgrounds: BackgroundI[]
  formId: string
  onNextDisabledChange?: (disabled: boolean) => void
}

const PHB_BACKGROUNDS = new Set([
  "ACOLYTE","CHARLATAN","CRIMINAL","ENTERTAINER","FOLK_HERO","GUILD_ARTISAN","GUILD_MERCHANT",
  "HERMIT","NOBLE","OUTLANDER","SAGE","SAILOR","SOLDIER","URCHIN"
]);

const SOURCE_OVERRIDES: Record<string, string> = {
  AZORIUS_FUNCTIONARY: "Ravnica",
  BOROS_LEGIONNAIRE: "Ravnica",
  DIMIR_OPERATIVE: "Ravnica",
  GOLGARI_AGENT: "Ravnica",
  GRUUL_ANARCH: "Ravnica",
  IZZET_ENGINEER: "Ravnica",
  ORZHOV_REPRESENTATIVE: "Ravnica",
  RAKDOS_CULTIST: "Ravnica",
  SELESNYA_INITIATE: "Ravnica",
  SIMIC_SCIENTIST: "Ravnica",
  LOREHOLD_STUDENT: "Strixhaven",
  PRISMARI_STUDENT: "Strixhaven",
  QUANDRIX_STUDENT: "Strixhaven",
  SILVERQUILL_STUDENT: "Strixhaven",
  WITHERBLOOM_STUDENT: "Strixhaven",
  ASTRAL_DRIFTER: "Spelljammer",
  WILDSPACER: "Spelljammer",
  FEYLOST: "Witchlight",
  WITCHLIGHT_HAND: "Witchlight",
  KNIGHT_OF_SOLAMNIA: "Dragonlance",
  MAGE_OF_HIGH_SORCERY: "Dragonlance",
};

export const BackgroundsForm = (
  {backgrounds, formId, onNextDisabledChange}: Props
) => {
  const { updateFormData, nextStep } = usePersFormStore();
  
  const {form, onSubmit} = useStepForm(backgroundSchema, (data) => {
    updateFormData({ 
      backgroundId: data.backgroundId,
      backgroundSearch: data.backgroundSearch 
    });
    nextStep();
  });

  const chosenBackgroundId = form.watch('backgroundId') || 0
  const backgroundSearch = form.watch('backgroundSearch') || ''
  const normalizedBackgroundSearch = useMemo(() => normalizeText(backgroundSearch), [backgroundSearch])

  useEffect(() => {
    if (!chosenBackgroundId) {
      onNextDisabledChange?.(true);
      return;
    }
    onNextDisabledChange?.(false);
  }, [onNextDisabledChange, chosenBackgroundId]);

  const BackgroundInfoModal = ({ background }: { background: BackgroundI }) => {
    const items = parseItems(background.items);
    const sourceText = sourceLabel(background.name);
    const resolvedSource = sourceText === " " && background.source
      ? translateValue(background.source)
      : sourceText;

    return (
      <InfoDialog
        title={backgroundTranslations[background.name] || background.name}
        triggerLabel={`  ${backgroundTranslations[background.name] ?? background.name}`}
      >
        <InfoGrid>
          <InfoPill label="" value={resolvedSource} />
          <InfoPill
            label=""
            value={formatSkillProficiencies(background.skillProficiencies)}
          />
          <InfoPill
            label=""
            value={formatToolProficiencies(background.toolProficiencies)}
          />
          <InfoPill
            label=""
            value={formatLanguages([], background.languagesToChooseCount)}
          />
          <InfoPill
            label=""
            value={background.specialAbilityName || "-"}
          />
        </InfoGrid>

        {items.length ? (
          <div className="space-y-1.5">
            <InfoSectionTitle> </InfoSectionTitle>
            <ul className="space-y-1 text-sm text-slate-200/90">
              {items.map((item, index) => (
                <li key={`${item}-${index}`} className="flex items-start gap-2">
                  <span className="mt-1 h-1.5 w-1.5 rounded-full bg-indigo-400" aria-hidden />
                  <span className="flex-1">{item}</span>
                </li>
              ))}
            </ul>
          </div>
        ) : null}

        {(background.specialAbilityName || background.description) && (
          <div className="space-y-1">
            <InfoSectionTitle> </InfoSectionTitle>
            {background.specialAbilityName ? (
              <p className="text-sm font-semibold text-white">
                {background.specialAbilityName}
              </p>
            ) : null}
            {background.description ? (
              <FormattedDescription
                content={background.description}
                className="text-sm leading-relaxed text-slate-200/90"
              />
            ) : null}
          </div>
        )}
      </InfoDialog>
    );
  };

  const matchesSearch = useCallback((name: string) => {
    if (!normalizedBackgroundSearch) return true;
    const ua = normalizeText(backgroundTranslations[name]);
    return ua.includes(normalizedBackgroundSearch);
  }, [normalizedBackgroundSearch]);

  const primaryBackgrounds = useMemo(
    () => backgrounds
      .filter(b => PHB_BACKGROUNDS.has(b.name))
      .filter(b => matchesSearch(b.name)),
    [backgrounds, matchesSearch]
  );
  const otherBackgrounds = useMemo(
    () => backgrounds
      .filter(b => !PHB_BACKGROUNDS.has(b.name))
      .filter(b => matchesSearch(b.name)),
    [backgrounds, matchesSearch]
  );

  const sourceLabel = (name: string) => SOURCE_OVERRIDES[name] ?? " ";
  const hasNoResults = !primaryBackgrounds.length && !otherBackgrounds.length;
  const forceOpenOther = Boolean(normalizedBackgroundSearch);

  return (
    <form id={formId} onSubmit={onSubmit} className="w-full space-y-4">
      <div className="space-y-2 text-center">
        <h2 className="font-rpg-display text-3xl font-semibold uppercase tracking-widest text-slate-200 sm:text-4xl">
           
        </h2>
        <p className="text-sm text-slate-400">      (2014),    .</p>
      </div>

      <div className="glass-panel border-gradient-rpg rounded-xl p-3 sm:p-4">
        <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <div className="relative w-full">
            <Search className="pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-500" />
            <Input
              type="search"
              {...form.register('backgroundSearch')}
              value={backgroundSearch}
              onChange={(e) => form.setValue('backgroundSearch', e.target.value)}
              placeholder="  "
              aria-label=" "
              className="h-10 border-white/10 bg-white/5 pl-9 pr-10 text-sm text-slate-100 placeholder:text-slate-400 focus-visible:ring-cyan-400/30"
            />
            {backgroundSearch && (
              <Button
                type="button"
                variant="ghost"
                size="icon"
                className="absolute right-1.5 top-1/2 h-7 w-7 -translate-y-1/2 text-slate-400 hover:text-white"
                onClick={() => form.setValue('backgroundSearch', '')}
                aria-label="  "
              >
                <X className="h-4 w-4" />
              </Button>
            )}
          </div>
        </div>
      </div>

      {hasNoResults && (
        <p className="text-center text-sm text-slate-400">  .</p>
      )}

      <div className="space-y-3">
        <div>
          <div className="mb-2 flex items-center justify-between">
            <p className="text-sm font-semibold text-white">  (2014)</p>
            <Badge variant="outline" className="border-white/15 bg-white/5 text-slate-200"></Badge>
          </div>
          <div className="grid gap-3 sm:grid-cols-2">
            {primaryBackgrounds.map(b =>  (
              <Card
                key={b.backgroundId}
                className={clsx(
                  "glass-card cursor-pointer transition-all duration-200",
                  b.backgroundId === chosenBackgroundId && "glass-active"
                )}
                onClick={(e) => {
                  if ((e.target as HTMLElement | null)?.closest?.('[data-stop-card-click]')) return;
                  form.setValue('backgroundId', b.backgroundId);
                }}
              >
                <CardContent className="relative flex items-center justify-between p-4">
                  <BackgroundInfoModal background={b} />
                  <div>
                    <div className="text-lg font-semibold text-white">{backgroundTranslations[b.name]}</div>
                    <div className="text-xs text-slate-400">{backgroundTranslationsEng[b.name]}</div>
                  </div>
                  <SourceBadge code={b.source} active={b.backgroundId === chosenBackgroundId} />
                </CardContent>
              </Card>
            ))}
          </div>
        </div>

        <details className="glass-panel border-gradient-rpg rounded-xl" open={forceOpenOther || undefined}>
          <summary className="cursor-pointer list-none px-4 py-3 text-sm font-semibold text-white hover:bg-white/5 [&::-webkit-details-marker]:hidden">
             
          </summary>
          <div className="border-t border-white/10 p-3">
            <div className="grid gap-3 sm:grid-cols-2">
              {otherBackgrounds.map(b =>  (
                <Card
                  key={b.backgroundId}
                  className={clsx(
                    "glass-card cursor-pointer transition-all duration-200",
                    b.backgroundId === chosenBackgroundId && "glass-active"
                  )}
                  onClick={(e) => {
                    if ((e.target as HTMLElement | null)?.closest?.('[data-stop-card-click]')) return;
                    form.setValue('backgroundId', b.backgroundId);
                  }}
                >
                  <CardContent className="relative flex items-center justify-between p-4">
                    <BackgroundInfoModal background={b} />
                    <div>
                      <div className="text-lg font-semibold text-white">{backgroundTranslations[b.name]}</div>
                      <div className="text-xs text-slate-400">{backgroundTranslationsEng[b.name]}</div>
                    </div>
                    <SourceBadge code={b.source} active={b.backgroundId === chosenBackgroundId} />
                  </CardContent>
                </Card>
              ))}
            </div>
          </div>
        </details>
      </div>

      <input
        type="hidden"
        {...form.register("backgroundId", {
          setValueAs: (value) => {
            if (value === "" || value === undefined || value === null) return undefined;
            const num = typeof value === "number" ? value : Number(value);
            return Number.isFinite(num) ? num : undefined;
          },
        })}
      />
    </form>
  )
};

export default BackgroundsForm;
</file>

<file path="src/lib/zod/schemas/persCreateSchema.ts">
import {z} from "zod";
import { Ability } from "@prisma/client";
import {SkillsEnum} from "@/lib/types/enums";

export const raceSchema = z.object({
  raceId: z.number().min(1, ",  , !"),
  raceSearch: z.string().default('')
})

export const subraceSchema = z.object({
  subraceId: z.number().optional(),
});

export const raceVariantSchema = z.object({
  raceVariantId: z.number().nullable().optional(),
});

export const raceChoiceOptionsSchema = z.object({
  raceChoiceSelections: z.record(z.string(), z.number().int()).default({}),
});

export const featSchema = z.object({
  featId: z.number().min(1, " !"),
  featSearch: z.string().default('')
});

export const classSchema = z.object({
  classId: z
    .number({ message: " '  " })
    .min(1, "   , !"),
});

export const subclassSchema = z.object({
  subclassId: z.number().optional(),
  subclassChoiceSelections: z.record(z.string(), z.number().int()).default({}),
});

export const classChoiceOptionsSchema = z.object({
  classChoiceSelections: z.record(z.string(), z.number().int()).default({})
});

export const featChoiceOptionsSchema = z.object({
  featChoiceSelections: z.record(z.string(), z.number().int()).default({})
});

export const classOptionalFeaturesSchema = z.object({
  classOptionalFeatureSelections: z.record(z.string(), z.boolean()).default({})
});

export const backgroundSchema = z.object({
  backgroundId: z.number().min(1, ",  , !"),
  backgroundSearch: z.string().default('')
});

const choices = z.object({
  groupIndex: z.number(),
  choiceCount: z.number(),
  selectedAbilities: z.array(z.nativeEnum(Ability))
})

export const asiSchema = z.object({
  isDefaultASI: z.boolean().default(false), //   

  asiSystem: z.string().default('POINT_BUY'),
  points: z.number().default(0),
  simpleAsi: z.array(z.object({
    ability: z.string(),
    value: z.number(),
  })).default([]).optional(),
  asi: z.array(z.object({
    ability: z.string(),
    value: z.number(), // 
  })).default([]).optional(),
  customAsi: z.array(z.object({
    ability: z.string(),
    value: z.string().optional()
      // .min(0, '!     0').max(99, '!     100'), // 
  })).default([]).optional(),

  racialBonusChoiceSchema: z.object({
    basicChoices: z.array(choices).default([]),
    tashaChoices: z.array(choices).default([])
  }).optional()
})
  .refine((data) => {
  if (data.asiSystem === 'POINT_BUY') {
    return data.asi && data.asi.length === 6 && data.points >= 0;
  }
  return true
}, {
  message: "      0",
  path: ['points']
}).refine((data) => {
    if (data.asiSystem === 'SIMPLE') {
      return data.simpleAsi && data.simpleAsi.length === 6;
    }
    return true;
  }, {
  message: "...    ",
    path: ['simpleAsi']
  }).refine((data) => {
    if (data.asiSystem === 'CUSTOM') {
      return data.customAsi
        && data.customAsi.length === 6
        && data.customAsi.every((entry) => {
          try {
            const num = Number(entry.value)
            return !isNaN(num) && entry.value != '';
          } catch {
            return false;
          }
        })
    }
    return true;
  }, {
    message: "  ,  !",
    path: ['customAsi', 'root']
  }).refine((data) => {
    if (data.racialBonusChoiceSchema) {
      const check = (groups: any[]) => {
        return groups.every(g => g.selectedAbilities.length === g.choiceCount)
      }
      if (data.isDefaultASI && data.racialBonusChoiceSchema.basicChoices) {
        return check(data.racialBonusChoiceSchema.basicChoices)
      }
      else if (!data.isDefaultASI && data.racialBonusChoiceSchema.tashaChoices) {
        return check(data.racialBonusChoiceSchema.tashaChoices)
      }
    }
    return true;
  }, {
    message: ",  ",
    path: ['racialBonusChoiceSchema']
  })

const skills = z.enum(SkillsEnum)

export const skillsSchema  = z.object({
  isTasha: z.boolean().default(true),
  tashaChoices: z.array(skills).default([]),

  basicChoices: z.object({
    race: z.array(skills).default([]),
    selectedClass: z.array(skills).default([]),
  }).default({
    race: [],
    selectedClass: [],
  }),
  
  // Metadata fields for validation (not stored in DB)
  _requiredCount: z.number().optional(),
  _raceCount: z.number().optional(),
  _classCount: z.number().optional(),
}).strict()
  .superRefine((data, ctx) => {
    // Skip validation if metadata not provided (for backward compatibility)
    if (data.isTasha && data._requiredCount !== undefined) {
      // In Tasha mode: validate total count (upper bound)
      const actualCount = data.tashaChoices.length;
      if (actualCount > data._requiredCount) {
        ctx.addIssue({
          code: z.ZodIssueCode.custom,
          message: `   ${data._requiredCount} `,
          path: ['tashaChoices'],
        });
      }
    } else if (!data.isTasha && data._raceCount !== undefined && data._classCount !== undefined) {
      // In basic mode: validate race and class counts separately (upper bounds)
      if (data.basicChoices.race.length > data._raceCount) {
        ctx.addIssue({
          code: z.ZodIssueCode.custom,
          message: `   ${data._raceCount}   `,
          path: ['basicChoices', 'race'],
        });
      }
      if (data.basicChoices.selectedClass.length > data._classCount) {
        ctx.addIssue({
          code: z.ZodIssueCode.custom,
          message: `   ${data._classCount}   `,
          path: ['basicChoices', 'selectedClass'],
        });
      }
    }
  })

export const expertiseSchema = z.object({
  expertises: z.array(skills).default([])
});

export const equipmentSchema = z.object({
    choiceGroupToId: z.record(
      z.string(), // js has no numeric keys
      z.array(z.number())
    ).default({}),
    anyWeaponSelection: z.record(z.string(), z.array(z.number())).default({})
})

export const nameSchema = z.object({
  name: z.string()
    .max(100, " , sql '  ?)))  ))")
})

export const fullCharacterSchema = z.object({
  raceId: z.number(),
  raceSearch: z.string().default(''),
  subraceId: z.number().optional(),
  raceVariantId: z.number().nullable().optional(),
  raceChoiceSelections: z.record(z.string(), z.number().int()).default({}),
  featId: z.number().optional(),
  classId: z.number().min(1, " '  "),
  subclassId: z.number().optional(),
  subclassChoiceSelections: z.record(z.string(), z.number().int()).default({}),
  classChoiceSelections: z.record(z.string(), z.number().int()).default({}),
  featChoiceSelections: z.record(z.string(), z.number().int()).default({}),
  classOptionalFeatureSelections: z.record(z.string(), z.boolean()).default({}),
  backgroundId: z.number(),
  backgroundSearch: z.string().default(''),
  isDefaultASI: z.boolean().default(false),
  asiSystem: z.string().default('POINT_BUY'),
  points: z.number().min(0).default(0),
  simpleAsi: z.array(z.object({ability: z.string(), value: z.number()})).default([]),
  customAsi: z.array(z.object({ ability: z.string(), value: z.string().transform((val) => (val === '' ? 10 : Number(val)))})).default([]).optional(),
  asi: z.array(z.object({ability: z.string(), value: z.number()})).default([]),
  skills: z.array(z.string()).default([]),
  equipment: z.array(z.number()).default([]),
  name: z.string().default(''),
  racialBonusChoiceSchema: z.object({
    basicChoices: z.array(choices).default([]),
    tashaChoices: z.array(choices).default([])
  }).optional(),
  skillsSchema: skillsSchema.optional(),
  expertiseSchema: expertiseSchema.optional(),
  equipmentSchema: equipmentSchema.optional(),
  nameSchema: nameSchema.optional()
  ,
  // -------------------------------------------------------------------------
  // Level-up (     )
  // -------------------------------------------------------------------------
  levelUpPath: z.enum(["EXISTING", "MULTICLASS"]).optional(),
  levelUpHpIncrease: z.number().int().min(0).optional(),
})


export type PersFormData = z.infer<typeof fullCharacterSchema>
</file>

<file path="package.json">
{
  "name": "pers",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev --turbopack",
    "dev:classic": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "prisma": {
    "seed": "tsx prisma/seed.ts"
  },
  "dependencies": {
    "@auth/prisma-adapter": "^2.11.1",
    "@hookform/resolvers": "^5.2.2",
    "@pdf-lib/fontkit": "^1.1.1",
    "@prisma/adapter-pg": "^7.1.0",
    "@prisma/client": "^7.1.0",
    "@radix-ui/react-checkbox": "^1.3.3",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-label": "^2.1.8",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-slot": "^1.2.4",
    "@radix-ui/react-switch": "^1.2.6",
    "@radix-ui/react-tabs": "^1.1.13",
    "@sparticuz/chromium": "^143.0.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "dotenv": "^17.2.3",
    "framer-motion": "^12.23.26",
    "google-auth-library": "^10.5.0",
    "lucide-react": "^0.555.0",
    "next": "15.5.4",
    "next-auth": "^5.0.0-beta.30",
    "next-themes": "^0.4.6",
    "pdf-lib": "^1.17.1",
    "pg": "^8.16.3",
    "puppeteer-core": "^24.34.0",
    "react": "19.1.0",
    "react-dom": "19.1.0",
    "react-hook-form": "^7.66.0",
    "react-markdown": "^10.1.0",
    "react-virtuoso": "^4.18.0",
    "rehype-raw": "^7.0.0",
    "rehype-sanitize": "^6.0.0",
    "remark": "^15.0.1",
    "remark-gfm": "^4.0.1",
    "remark-html": "^16.0.1",
    "sonner": "^2.0.7",
    "tailwind-merge": "^3.4.0",
    "tailwindcss-animate": "^1.0.7",
    "zod": "^4.1.12",
    "zustand": "^5.0.8"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.21",
    "eslint": "^9",
    "eslint-config-next": "15.5.4",
    "postcss": "^8.5.6",
    "prisma": "^7.1.0",
    "tailwindcss": "^3.4.13",
    "tsx": "^4.20.6",
    "typescript": "^5"
  }
}
</file>

<file path="src/lib/components/characterCreator/ClassesForm.tsx">
"use client";

import { SpellcastingType } from "@prisma/client";
import { attributesUkrShort, classTranslations, classTranslationsEng } from "@/lib/refs/translation";
import clsx from "clsx";
import { useStepForm } from "@/hooks/useStepForm";
import { classSchema } from "@/lib/zod/schemas/persCreateSchema";
import { ClassI } from "@/lib/types/model-types";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { useEffect, useMemo } from "react";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import {
  InfoDialog,
  InfoGrid,
  InfoPill,
  InfoSectionTitle,
} from "@/lib/components/characterCreator/EntityInfoDialog";
import {
  formatAbilityList,
  formatArmorProficiencies,
  formatLanguages,
  formatMulticlassReqs,
  formatSkillProficiencies,
  formatToolProficiencies,
  formatWeaponProficiencies,
  prettifyEnum,
} from "@/lib/components/characterCreator/infoUtils";
import { FormattedDescription } from "@/components/ui/FormattedDescription";

interface Props {
  classes: ClassI[]
  formId: string
  onNextDisabledChange?: (disabled: boolean) => void
  mode?: "flow" | "wizard"
  onClassSelected?: (classId: number) => void
}

const SPELLCASTING_LABELS: Record<SpellcastingType, string> = {
  NONE: " ",
  FULL: " ",
  HALF: " ",
  THIRD: " ",
  PACT: " ",
};

export const ClassesForm = (
  {classes, formId, onNextDisabledChange, mode = "flow", onClassSelected}: Props
) => {
  const { updateFormData, nextStep } = usePersFormStore();
  
  const {form, onSubmit} = useStepForm(classSchema, (data) => {
    if (mode === "wizard") {
      if (typeof data.classId === "number") onClassSelected?.(data.classId);
      return;
    }

    updateFormData({ classId: data.classId });
    nextStep();
  });

  const chosenClassId = form.watch('classId') || 0
  const sortedClasses = useMemo(
    () => [...classes].sort((a, b) => (a.sortOrder - b.sortOrder) || (a.classId - b.classId)),
    [classes]
  );

  useEffect(() => {
    if (!chosenClassId) {
      onNextDisabledChange?.(true);
      return;
    }
    onNextDisabledChange?.(false);
  }, [onNextDisabledChange, chosenClassId]);

  const ClassInfoModal = ({ cls }: { cls: ClassI }) => {
    const features = [...(cls.features || [])].sort(
      (a, b) => (a.levelGranted || 0) - (b.levelGranted || 0)
    );

    return (
      <InfoDialog
        title={classTranslations[cls.name] || cls.name}
        triggerLabel={`  ${classTranslations[cls.name] ?? cls.name}`}
      >
        <InfoGrid>
          <InfoPill label=" " value={`d${cls.hitDie}`} />
          <InfoPill
            label=""
            value={SPELLCASTING_LABELS[cls.spellcastingType] ?? ""}
          />
          <InfoPill label="  " value={` ${cls.subclassLevel}`} />
          <InfoPill label="" value={formatAbilityList(cls.savingThrows)} />
          <InfoPill
            label=""
            value={formatSkillProficiencies(cls.skillProficiencies)}
          />
          <InfoPill
            label=""
            value={formatToolProficiencies(cls.toolProficiencies, cls.toolToChooseCount)}
          />
          <InfoPill
            label=""
            value={formatWeaponProficiencies(cls.weaponProficiencies)}
          />
          <InfoPill
            label=""
            value={formatArmorProficiencies(cls.armorProficiencies)}
          />
          <InfoPill
            label=""
            value={formatLanguages(cls.languages, cls.languagesToChooseCount)}
          />
          <InfoPill
            label=""
            value={formatMulticlassReqs(cls.multiclassReqs)}
          />
          {cls.primaryCastingStat ? (
            <InfoPill
              label=" "
              value={attributesUkrShort[cls.primaryCastingStat]}
            />
          ) : null}
        </InfoGrid>

        <div className="space-y-2">
          <InfoSectionTitle></InfoSectionTitle>
          {features.length ? (
            features.map((feature) => (
              <div
                key={feature.classFeatureId || feature.feature.featureId}
                className="glass-panel border-gradient-rpg rounded-lg px-3 py-2.5"
              >
                <div className="mb-1 flex items-center justify-between gap-2">
                  <p className="text-sm font-semibold text-white">{feature.feature.name}</p>
                  <Badge
                              variant="outline"
                              className="border-white/15 bg-white/5 text-[11px] text-slate-200"
                  >
                    . {feature.levelGranted}
                  </Badge>
                </div>
                  <FormattedDescription
                    content={feature.feature.description}
                    className="text-sm leading-relaxed text-slate-200/90"
                  />
              </div>
            ))
          ) : (
            <p className="text-sm text-slate-400">   .</p>
          )}
        </div>
      </InfoDialog>
    );
  };

  return (
    <form id={formId} onSubmit={onSubmit} className="w-full space-y-4">
      <div className="space-y-2 text-center">
        <h2 className="font-rpg-display text-3xl font-semibold uppercase tracking-widest text-slate-200 sm:text-4xl">
           
        </h2>
        <p className="text-sm text-slate-400"> ,   ?  .</p>
      </div>

      <div className="grid gap-3 md:grid-cols-2">
        {
          sortedClasses.map(c =>  (
            <Card
              key={c.classId}
              className={clsx(
                "glass-card cursor-pointer transition-all duration-200",
                c.classId === chosenClassId && "glass-active"
              )}
              onClick={(e) => {
                if ((e.target as HTMLElement | null)?.closest?.('[data-stop-card-click]')) return;
                form.setValue('classId', c.classId);
                if (mode === "wizard") onClassSelected?.(c.classId);
              }}
            >
                <CardContent className="relative flex items-center justify-between p-4">
                  <ClassInfoModal cls={c} />
                  <div>
                  <div className="text-lg font-semibold text-white">{classTranslations[c.name]}</div>
                  <div className="text-xs text-slate-400">{classTranslationsEng[c.name]}</div>
                  </div>
              </CardContent>
            </Card>
          ))}
      </div>

      <input
        type="hidden"
        {...form.register("classId", {
          setValueAs: (value) => {
            if (value === "" || value === undefined || value === null) return undefined;
            const num = typeof value === "number" ? value : Number(value);
            return Number.isFinite(num) ? num : undefined;
          },
        })}
      />
    </form>
  )
};

export default ClassesForm;
</file>

<file path="src/lib/components/characterCreator/RacesForm.tsx">
"use client";

import { raceTranslations, raceTranslationsEng, sourceTranslations } from "@/lib/refs/translation";
import clsx from "clsx";
import { useStepForm } from "@/hooks/useStepForm";
import { raceSchema } from "@/lib/zod/schemas/persCreateSchema";
import { RaceAC, RaceASI, RaceI } from "@/lib/types/model-types";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Search, X } from "lucide-react";
import { useEffect, useMemo, useCallback } from "react";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import {
  InfoDialog,
  InfoGrid,
  InfoPill,
  InfoSectionTitle,
} from "@/lib/components/characterCreator/EntityInfoDialog";
import { SourceBadge } from "@/lib/components/characterCreator/SourceBadge";
import {
  formatArmorProficiencies,
  formatList,
  formatLanguages,
  formatSkillProficiencies,
  formatToolProficiencies,
  formatWeaponProficiencies,
  prettifyEnum,
  translateValue,
} from "@/lib/components/characterCreator/infoUtils";
import { FormattedDescription } from "@/components/ui/FormattedDescription";

const normalizeText = (value?: string) =>
  (value || "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .trim();

const formatSpeeds = (race: RaceI) => {
  const speeds = [
    { label: "", value: race.speed },
    { label: "", value: race.climbSpeed },
    { label: "", value: race.swimSpeed },
    { label: "", value: race.flightSpeed },
    { label: "", value: race.burrowSpeed },
  ].filter((item) => (item.value ?? 0) > 0 || (item.label === "" && item.value != null));

  return speeds
    .map((item) => `${item.label}: ${item.value} `)
    .join("  ");
};

const formatRaceAC = (ac?: RaceAC | null) => {
  if (!ac) return "10";
  if ("consistentBonus" in ac) {
    return `+${ac.consistentBonus}  `;
  }
  const bonus = ac.bonus ? ` + ${ac.bonus}` : "";
  return ` ${ac.base}${bonus}`;
};

const formatASI = (asi?: RaceASI | null) => {
  if (!asi) return "";

  const fixedEntries = Object.entries(asi.basic?.simple || {});
  const basicFlexible = asi.basic?.flexible?.groups || [];
  const tashaFlexible = asi.tasha?.flexible?.groups || [];

  const parts: string[] = [];

  if (fixedEntries.length) {
    parts.push(
      `: ${fixedEntries
        .map(([stat, value]) => `${translateValue(String(stat).toUpperCase())} +${value}`)
        .join(", ")}`
    );
  }

  if (basicFlexible.length) {
    parts.push(
      `: ${basicFlexible
        .map(
          (group) =>
            `${group.groupName} (+${group.value},  ${group.choiceCount})`
        )
        .join("; ")}`
    );
  }

  if (tashaFlexible.length) {
    parts.push(
      ` : ${tashaFlexible
        .map(
          (group) =>
            `${group.groupName} (+${group.value},  ${group.choiceCount})`
        )
        .join("; ")}`
    );
  }

  return parts.join("  ") || "";
};

interface Props {
  races: RaceI[]
  formId: string
  onNextDisabledChange?: (disabled: boolean) => void
}

export const RacesForm = (
  {races, formId, onNextDisabledChange}: Props
) => {
  const { updateFormData, nextStep } = usePersFormStore();
  
  const {form, onSubmit} = useStepForm(raceSchema, (data) => {
    updateFormData({ 
      raceId: data.raceId,
      raceSearch: data.raceSearch 
    });
    nextStep();
  });

  const chosenRaceId = form.watch('raceId') || 0
  const raceSearch = form.watch('raceSearch') || ''
  const normalizedRaceSearch = useMemo(() => normalizeText(raceSearch), [raceSearch])

  useEffect(() => {
    if (!chosenRaceId) {
      onNextDisabledChange?.(true);
      return;
    }
    onNextDisabledChange?.(false);
  }, [onNextDisabledChange, chosenRaceId]);

  const matchesSearch = useCallback((raceName: string) => {
    if (!normalizedRaceSearch) return true;
    const ua = normalizeText(raceTranslations[raceName]);
    const eng = normalizeText(raceTranslationsEng[raceName]);
    return ua.includes(normalizedRaceSearch) || eng.includes(normalizedRaceSearch);
  }, [normalizedRaceSearch]);

  const sourceLabel = (race: RaceI) => sourceTranslations[race.source] ?? race.source;

  const RaceInfoModal = ({ race }: { race: RaceI }) => {
    const rawTraits = race.traits || [];
    const traitList = [...rawTraits].sort(
      (a, b) => (a.raceTraitId || 0) - (b.raceTraitId || 0)
    );

    const subraces = race.subraces || [];
    const variants = race.raceVariants || [];
    const raceOptions = race.raceChoiceOptions || [];

    const subraceNames = subraces
      .map((sr) => translateValue(sr.name))
      .filter(Boolean)
      .sort((a, b) => a.localeCompare(b));

    const variantNames = variants
      .map((rv) => translateValue(rv.name))
      .filter(Boolean)
      .sort((a, b) => a.localeCompare(b));

    const optionsByGroup = raceOptions.reduce((acc, opt) => {
      const group = opt.choiceGroupName || "";
      acc[group] = acc[group] || [];
      acc[group].push(opt.optionName);
      return acc;
    }, {} as Record<string, string[]>);

    const optionGroups = Object.entries(optionsByGroup)
      .map(([group, names]) => ({
        group,
        names: Array.from(new Set(names)).filter(Boolean).sort((a, b) => a.localeCompare(b)),
      }))
      .filter((g) => g.names.length)
      .sort((a, b) => a.group.localeCompare(b.group));

    return (
      <InfoDialog
        title={raceTranslations[race.name] || race.name}
        triggerLabel={`  ${raceTranslations[race.name] ?? race.name}`}
      >
        <InfoGrid>
          <InfoPill label="" value={sourceLabel(race)} />
          <InfoPill label="" value={formatList(race.size)} />
          <InfoPill label="" value={formatSpeeds(race)} />
          <InfoPill label=" " value={formatRaceAC(race.ac)} />
          <InfoPill label=" " value={formatASI(race.ASI)} />
          <InfoPill
            label=""
            value={formatLanguages(race.languages, race.languagesToChooseCount)}
          />
          <InfoPill
            label=""
            value={formatSkillProficiencies(race.skillProficiencies)}
          />
          <InfoPill
            label=""
            value={formatToolProficiencies(race.toolProficiencies, race.toolToChooseCount)}
          />
          <InfoPill
            label=""
            value={formatWeaponProficiencies(race.weaponProficiencies)}
          />
          <InfoPill
            label=""
            value={formatArmorProficiencies(race.armorProficiencies)}
          />
        </InfoGrid>

        {(subraceNames.length || variantNames.length || optionGroups.length) ? (
          <div className="space-y-2">
            <InfoSectionTitle> </InfoSectionTitle>

            {subraceNames.length ? (
              <div className="glass-panel border-gradient-rpg rounded-lg px-3 py-2.5">
                <p className="text-sm font-semibold text-white"></p>
                <p className="text-sm text-slate-200/90">{subraceNames.join(", ")}</p>
              </div>
            ) : null}

            {variantNames.length ? (
              <div className="glass-panel border-gradient-rpg rounded-lg px-3 py-2.5">
                <p className="text-sm font-semibold text-white"></p>
                <p className="text-sm text-slate-200/90">{variantNames.join(", ")}</p>
              </div>
            ) : null}

            {optionGroups.length ? (
              <div className="glass-panel border-gradient-rpg rounded-lg px-3 py-2.5">
                <p className="text-sm font-semibold text-white"> </p>
                <div className="space-y-1.5 text-sm text-slate-200/90">
                  {optionGroups.map(({ group, names }) => (
                    <p key={group}>
                      <span className="font-semibold text-slate-100">{group}:</span> {names.join(", ")}
                    </p>
                  ))}
                </div>
              </div>
            ) : null}
          </div>
        ) : null}

        <div className="space-y-2">
          <InfoSectionTitle></InfoSectionTitle>
          {traitList.length ? (
            traitList.map((trait) => (
              <div
                key={trait.raceTraitId || trait.feature.featureId}
                className="glass-panel border-gradient-rpg rounded-lg px-3 py-2.5"
              >
                <p className="text-sm font-semibold text-white">{trait.feature.name}</p>
                <FormattedDescription
                  content={trait.feature.description}
                  className="text-sm leading-relaxed text-slate-200/90"
                />
              </div>
            ))
          ) : (
            <p className="text-sm text-slate-400">      ,    // .</p>
          )}
        </div>
      </InfoDialog>
    );
  };

  const coreRaces = useMemo(
    () => races
      .filter(r => r.name.endsWith('2014'))
      .filter(r => matchesSearch(r.name))
      .sort((a, b) => (a.sortOrder - b.sortOrder) || (a.raceId - b.raceId)),
    [races, matchesSearch]
  );
  const otherRaces = useMemo(
    () => races
      .filter(r => !r.name.endsWith('2014'))
      .filter(r => matchesSearch(r.name))
      .sort((a, b) => (a.sortOrder - b.sortOrder) || (a.raceId - b.raceId)),
    [races, matchesSearch]
  );

  const hasNoResults = !coreRaces.length && !otherRaces.length;
  const forceOpenOther = Boolean(normalizedRaceSearch);

  return (
    <form id={formId} onSubmit={onSubmit} className="w-full space-y-4">
      <div className="space-y-2 text-center">
        <h2 className="font-rpg-display text-3xl font-semibold uppercase tracking-widest text-slate-200 sm:text-4xl">
           
        </h2>
        <p className="text-sm text-slate-400">  ,  .</p>
      </div>

      <div className="glass-panel border-gradient-rpg rounded-xl p-3 sm:p-4">
        <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <div className="relative w-full">
            <Search className="pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-500" />
            <Input
              type="search"
              {...form.register('raceSearch')}
              value={raceSearch}
              onChange={(e) => form.setValue('raceSearch', e.target.value)}
              placeholder="  "
              aria-label=" "
              className="h-10 border-white/10 bg-white/5 pl-9 pr-10 text-sm text-slate-100 placeholder:text-slate-400 focus-visible:ring-cyan-400/30"
            />
            {raceSearch && (
              <Button
                type="button"
                variant="ghost"
                size="icon"
                className="absolute right-1.5 top-1/2 h-7 w-7 -translate-y-1/2 text-slate-400 hover:text-white"
                onClick={() => form.setValue('raceSearch', '')}
                aria-label="  "
              >
                <X className="h-4 w-4" />
              </Button>
            )}
          </div>
        </div>
      </div>

      {hasNoResults && (
        <p className="text-center text-sm text-slate-400">  .</p>
      )}

      <div className="space-y-3">
        <div>
          <div className="mb-2 flex items-center justify-between">
            <p className="text-sm font-semibold text-white">PHB 2014</p>
            <Badge variant="outline" className="border-white/15 bg-white/5 text-slate-200"></Badge>
          </div>
          <div className="grid gap-3 sm:grid-cols-2">
            {coreRaces.map(r =>  (
              <Card
                key={r.raceId}
                className={clsx(
                  "glass-card cursor-pointer transition-all duration-200",
                  r.raceId === chosenRaceId && "glass-active"
                )}
                onClick={(e) => {
                  if ((e.target as HTMLElement | null)?.closest?.('[data-stop-card-click]')) return;
                  form.setValue('raceId', r.raceId);
                }}
              >
                <CardContent className="relative flex items-center justify-between p-4">
                  <RaceInfoModal race={r} />
                  <div>
                    <div className="text-lg font-semibold text-white">{raceTranslations[r.name]}</div>
                    <div className="text-xs text-slate-400">{raceTranslationsEng[r.name]}</div>
                  </div>
                  <SourceBadge code={r.source} active={r.raceId === chosenRaceId} />
                </CardContent>
              </Card>
            ))}
          </div>
        </div>

        <details className="glass-panel border-gradient-rpg rounded-xl" open={forceOpenOther || undefined}>
          <summary className="cursor-pointer list-none px-4 py-3 text-sm font-semibold text-white hover:bg-white/5 [&::-webkit-details-marker]:hidden">
             
          </summary>
          <div className="border-t border-white/10 p-3">
            <div className="grid gap-3 sm:grid-cols-2">
              {otherRaces.map(r =>  (
                <Card
                  key={r.raceId}
                  className={clsx(
                    "glass-card cursor-pointer transition-all duration-200",
                    r.raceId === chosenRaceId && "glass-active"
                  )}
                  onClick={(e) => {
                    if ((e.target as HTMLElement | null)?.closest?.('[data-stop-card-click]')) return;
                    form.setValue('raceId', r.raceId);
                  }}
                >
                  <CardContent className="relative flex items-center justify-between p-4">
                    <RaceInfoModal race={r} />
                    <div>
                      <div className="text-lg font-semibold text-white">{raceTranslations[r.name]}</div>
                      <div className="text-xs text-slate-400">{raceTranslationsEng[r.name]}</div>
                    </div>
                    <SourceBadge code={r.source} active={r.raceId === chosenRaceId} />
                  </CardContent>
                </Card>
              ))}
            </div>
          </div>
        </details>
      </div>

      <input
        type="hidden"
        {...form.register("raceId", {
          setValueAs: (value) => {
            if (value === "" || value === undefined || value === null) return undefined;
            const num = typeof value === "number" ? value : Number(value);
            return Number.isFinite(num) ? num : undefined;
          },
        })}
      />
    </form>
  )
};

export default RacesForm;
</file>

<file path="prisma/seed.ts">
import 'dotenv/config';
import { prisma } from "@/lib/prisma";
import { seedWeapons } from "./seed/weaponSeed";
import { seedArmor } from "./seed/armorSeed";
import { seedEquipmentPacks } from "./seed/equipmentPackSeed";
import { seedBackground } from "./seed/backgroundSeed";
import { seedRaceFeatures } from "./seed/raceFeatureSeed";
import { seedRaces } from "./seed/raceSeed";
import { seedClassFeatures } from "./seed/classFeatureSeed";
import { seedClasses } from "./seed/classSeed";
import { seedSubclasses } from "./seed/subclassSeed";
import { seedSubclassFeatures } from "./seed/subclassFeatureSeed";
import { seedSubclassChoiceOptions } from "./seed/subclassChoiceOptionSeed";
import { seedClassEquipment } from "./seed/classEquipmentSeed";
import { seedChoiceOptions } from "./seed/choiceOptionSeed";
import { seedClassChoiceOptions } from "./seed/classChoiceOptionSeed";
import { seedClassOptionalFeatures } from "./seed/optionalFeatureSeed";
import { seedSubraces } from "./seed/subraceSeed";
import { seedSubraceFeatures } from "./seed/subraceFeatureSeed";
import { seedRaceVariants } from "./seed/raceVariantSeed";
import { seedRaceChoiceOptions } from "./seed/raceChoiceOptionSeed";

import { seedInfusionFeatures } from "./seed/infusionFeaturesSeed";
import { seedInfusions } from "./seed/infusionSeed";
import { seedMagicItems } from "./seed/magicItemSeed";
import { seedFeats } from "./seed/featSeed";
import { seedFeatChoiceOptions } from "./seed/featChoiceOptionSeed";

async function main() {
    console.log('Starting seed...')
    console.log('  SEEDINDEX        !       !')
    // !  SEEDINDEX        !       !    classEquipment  classOptionalFeature
    // await seedWeapons(prisma)
    // await seedArmor(prisma)
    // await seedEquipmentPacks(prisma)
    // await seedBackground(prisma)
    // await seedRaceFeatures(prisma)
    // await seedSubraceFeatures(prisma)
    // await seedRaces(prisma)
    // await seedSubraces(prisma)
    // await seedRaceVariants(prisma)
    // await seedRaceChoiceOptions(prisma)

    // await seedClasses(prisma)
    // await seedSubclasses(prisma)
    await seedSubclassFeatures(prisma)
    // await seedChoiceOptions(prisma)
    // await seedClassChoiceOptions(prisma)
    // await seedSubclassChoiceOptions(prisma)
    
    // await seedMagicItems(prisma) // items for infusions
    // await seedInfusions(prisma)  // infusions themselves

    // await seedClassOptionalFeatures(prisma)
    
    // await seedFeats(prisma);
    // await seedFeatChoiceOptions(prisma);

    // await seedClassFeatures(prisma)
    // await seedInfusionFeatures(prisma) // features for infusions
}

main()
    .catch((e) => {
        console.error(e)
        process.exit(1)
    })
    .finally(async () => {
        await prisma.$disconnect()
    })
</file>

<file path="src/app/pers/page.tsx">
import MultiStepForm from "@/lib/components/characterCreator/MultiStepForm";
import { prisma } from "@/lib/prisma";
import {BackgroundI, ClassI, RaceI} from "@/lib/types/model-types";


export default async function Page() {
  const [
    races,
    classes,
    backgrounds,
    weapons,
    // armors,
    feats,
  ] = await Promise.all([
    prisma.race.findMany({
      include: {
        raceChoiceOptions: {
          include: {
            traits: {
              include: {
                feature: true,
              }
            }
          }
        },
        subraces: {
          include: {
            traits: {
              include: {
                feature: true,
              }
            }
          }
        },
        raceVariants: {
          include: {
            traits: {
              include: {
                feature: true,
              }
            }
          }
        },
        traits: {
          include: {
            feature: true,
          }
        },
      },
      orderBy: [
        { sortOrder: 'asc' },
        { raceId: 'asc' }
      ]
    }) as Promise<RaceI[]>,
    prisma.class.findMany({
      include: {
        subclasses: {
          include: {
            features: {
              include: {
                feature: true,
              },
            },
            subclassChoiceOptions: {
              include: {
                choiceOption: {
                  include: {
                    features: {
                      include: {
                        feature: true,
                      },
                    },
                  },
                },
              },
            },
            expandedSpells: true,
          },
        },
        startingEquipmentOption: {
          include: {
            equipmentPack: true,
            weapon: true,
            armor: true,
          },
        },
        classChoiceOptions: {
          include: {
            choiceOption: {
              include: {
                features: {
                  include: {
                    feature: true,
                  },
                },
              },
            },
          },
        },
        classOptionalFeatures: {
          include: {
            feature: true,
            replacesFeatures: {
              include: {
                replacedFeature: true,
              },
            },
            appearsOnlyIfChoicesTaken: true,
          },
        },
        features: {
          include: {
            feature: true,
          },
        },
      },
      orderBy: [
        { sortOrder: 'asc' },
        { classId: 'asc' }
      ]
    }) as unknown as Promise<ClassI[]>,
    prisma.background.findMany() as Promise<BackgroundI[]>,
    prisma.weapon.findMany({
      orderBy: [
        { sortOrder: 'asc' },
        { weaponId: 'asc' }
      ]
    }),
    prisma.feat.findMany({
      include: {
        grantsFeature: true,
        featChoiceOptions: {
          include: {
            choiceOption: {
              include: {
                features: {
                  include: {
                    feature: true
                  }
                }
              }
            }
          }
        }
      },
      orderBy: [
        { name: 'asc' }
      ]
    }),
  ])

  return (
    <>
      <MultiStepForm
        races={races}
        classes={classes}
        backgrounds={backgrounds}
        weapons={weapons}
        feats={feats}
      />
    </>
  );
}
</file>

<file path="src/hooks/useStepForm.ts">
import {z, ZodObject, ZodRawShape} from "zod";
import { usePersFormStore } from "@/lib/stores/persFormStore";
import { zodResolver } from "@hookform/resolvers/zod";
import {DefaultValues, useForm} from "react-hook-form";
import { useEffect, useMemo, useRef } from "react";
import { toast } from "sonner";

const extractErrorMessage = (err: unknown): string | null => {
    if (!err) return null;
    if (Array.isArray(err)) {
        for (const entry of err) {
            const msg = extractErrorMessage(entry);
            if (msg) return msg;
        }
    } else if (typeof err === "object") {
        if ("message" in (err as { message?: unknown }) && typeof (err as { message?: unknown }).message === "string") {
            return (err as { message: string }).message;
        }
        for (const value of Object.values(err as Record<string, unknown>)) {
            const msg = extractErrorMessage(value);
            if (msg) return msg;
        }
    }
    return null;
}

export function useStepForm<TShape extends ZodRawShape>(
    schema: ZodObject<TShape>,
    onSuccess?: (data: z.output<typeof schema>) => void
) {
    type Input = z.input<typeof schema>
    type Output = z.output<typeof schema>

    const { formData, updateFormData, nextStep, isHydrated } = usePersFormStore();

    const schemaDefaults = useMemo(() => {
        const result = schema.safeParse({});
        return result.success ? result.data: {}
    }, [schema]);

    const relevantFormData = useMemo(() => {
        const schemaKeys = Object.keys(schema.shape);
        return Object.keys(formData)
          .filter(key => schemaKeys.includes(key)).reduce((acc, key) => {
              acc[key] = formData[key]
              return acc;
          }, {} as Record<string, any>)
    }, [formData, schema])

    const mergedDefaults = useMemo(() => ({
        ...schemaDefaults,
        ...relevantFormData,
    }), [schemaDefaults, relevantFormData])

    const form = useForm<Input, unknown, Output>({
        resolver: zodResolver(schema),
        defaultValues: mergedDefaults as DefaultValues<Input>,
        mode: "onChange",
        shouldUnregister: false
    });

    const didApplyHydratedDefaults = useRef(false);

    useEffect(() => {
        if (!isHydrated) return;
        if (didApplyHydratedDefaults.current) return;
        // After zustand-persist hydration, ensure persisted values override schema defaults.
        form.reset(mergedDefaults as DefaultValues<Input>);
        didApplyHydratedDefaults.current = true;
    }, [isHydrated, form, mergedDefaults]);

    // Save data when unmounting (navigating away without submitting)
    useEffect(() => {
        return () => {
            if (!isHydrated) return;
            const values = form.getValues();
            updateFormData(values);
        };
    }, [form, updateFormData, isHydrated]);


    useEffect(() => {
        if (!isHydrated) return;
        const subscription = form.watch((value) => {
            updateFormData(value as Partial<Input>);
        });
        return () => subscription.unsubscribe();
    }, [form, updateFormData, isHydrated])

    const friendlyMessages: Record<string, string> = {
        raceId: ",  , ",
        classId: ",  , ",
        backgroundId: ",  , ",
        classChoiceSelections: "    ",
        classOptionalFeatureSelections: ",     ",
        asi: " ",
        simpleAsi: " ",
        customAsi: "  ",
        racialBonusChoiceSchema: "   ",
        basicChoices: "   ",
        tashaChoices: "   ",
        choiceGroupToId: " ",
        name: " ' ",
    };

    const onSubmit = form.handleSubmit((data) => {
        updateFormData(data as unknown as Partial<Input>);
        if (onSuccess) {
            onSuccess(data as unknown as Output);
        } else {
            nextStep();
        }
    }, (errors) => {
        const firstMessage = extractErrorMessage(errors);
        const firstKey = Object.keys(errors)[0];
        const friendly = firstKey ? friendlyMessages[firstKey] : undefined;
        toast.error(friendly ?? '   ', {
            description: friendly ? undefined : firstMessage ?? '  .',
        });
        console.error(' Validation errors:', errors);
    });

    return { form, onSubmit };
}
</file>

</files>
