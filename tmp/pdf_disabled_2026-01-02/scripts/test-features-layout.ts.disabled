import { loadBaseTemplate, generatePdfFromHtml } from "../src/server/pdf/generatePdfFromHtml";
import { renderFeaturesHTML } from "../src/server/pdf/renderers/renderFeatures";
import { renderSpellsHTML } from "../src/server/pdf/renderers/renderSpells";
import fs from "fs/promises";
import path from "path";

const featuresMock = {
  passive: [
    { key: '1', name: 'Вливання предмета', description: 'Ви вмієте вливати магічні властивості у немагічні предмети, обираючи відомі Вливання. Після довгого відпочинку ви можете влити певну кількість предметів; якщо перевищуєте ліміт, попереднє Вливання зникає. Деякі Вливання імітують магічні предмети. Предмети мають залишатися у вашій близькості, інакше вливання згасає через 24 години.', sourceName: 'Class', displayTypes: ['PASSIVE'] },
    { key: '2', name: 'Потойбічні виклики', description: 'У своєму дослідженні окультних знань ви відкрили потойбічні виклики - фрагменти забороненого знання, що надають вам постійні магічні здібності. На 2 рівні ви отримуєте два потойбічні виклики на ваш вибір. Ваші варіанти викликів детально описані в кінці опису класу. Коли ви досягаєте певних рівнів чорнокнижника, ви отримуєте додаткові виклики на ваш вибір, як показано в стовпці Відомі виклики таблиці Чорнокнижника.\n\n**Рівні отримання:** 2 виклики на 2 рівні, потім +1 виклик на рівнях: 5, 7, 9, 12, 15, 18 (всього до 8 викликів на 18 рівні).\nКрім того, коли ви отримуєте рівень у цьому класі, ви можете вибрати один з викликів, які ви знаєте, і замінити його іншим викликом, який ви могли б вивчити на цьому рівні.', sourceName: 'Class', displayTypes: ['PASSIVE'] },
    { key: '3', name: 'Чаротворення (Винахідник)', description: 'Ви вчитеся творити заклинання як напівкастер, використовуючи Інтелект як характеристику заклинань. Ви вивчаєте заклинання зі списку заклинань Винахідника.', sourceName: 'Class', displayTypes: ['PASSIVE'] },
    { key: '4', name: 'Божественний домен', description: 'На 1 рівні ви обираєте божественний домен, пов\'язаний з вашим божеством. Домен визначає частину ваших здібностей і дає доменні риси на вищих рівнях.', sourceName: 'Class', displayTypes: ['PASSIVE'] },
    { key: '5', name: 'Магія пакту', description: 'Ваше дослідження окультизму та магії, яку ваш патрон дарує вам, надають вам можливість накладати заклинання.\n\n**Замовляння:** Ви знаєте два замовляння на ваш вибір зі списку чорнокнижника. Ви вивчаєте додаткові замовляння чорнокнижника на вищих рівнях, як показано в стовпці Відомі замовляння таблиці Чорнокнижника.\n\n**Слоти заклинань:** Таблиця Чорнокнижника показує, скільки слотів заклинань у вас є. Таблиця також показує, якого рівня ці слоти. Усі ваші слоти заклинань однакового рівня. Щоб накласти одне з ваших заклинань чорнокнижника 1 рівня або вище, ви повинні витратити слот заклинань. Ви відновлюєте всі витрачені слоти заклинань, коли завершуєте короткий або тривалий відпочинок.\n\nНаприклад, коли ви 5 рівня, у вас є два слоти заклинань 3 рівня.\n\n**Відомі заклинання:** На 1 рівні ви знаєте два заклинання 1 рівня на ваш вибір зі списку заклинань чорнокнижника.', sourceName: 'Class', displayTypes: ['PASSIVE'] },
    { key: '6', name: 'Темний зір', description: 'Ви бачите при тьмяному світлі в межах 60 футів від вас так, ніби це яскраве світло, а в темряві - ніби це тьмяне світло. Ви не можете розрізняти кольори в темряві, лише відтінки сірого.', sourceName: 'Race', displayTypes: ['PASSIVE'] },
    { key: '7', name: 'Стійкість дворфів', description: 'Ви маєте перевагу на рятівні кидки проти отрути, і ви маєте стійкість до ушкоджень отрутою.', sourceName: 'Race', displayTypes: ['PASSIVE'] },
    { key: '8', name: 'Володіння інструментами', description: 'Ви отримуєте володіння одним з наступних ремісничих інструментів на ваш вибір: інструменти коваля, інструменти пивовара, або інструменти каменяра.', sourceName: 'Race', displayTypes: ['PASSIVE'] },
  ],
  actions: [
    { key: 'a1', name: 'Атака', description: 'Здійсніть атаку зброєю ближнього або далекобійного бою.', sourceName: 'General', displayTypes: ['ACTION'] },
    { key: 'a2', name: 'Ривок', description: 'Коли ви здійснюєте дію Ривок, ви отримуєте додатковий рух на поточний хід. Збільшення дорівнює вашій швидкості після застосування будь-яких модифікаторів.', sourceName: 'General', displayTypes: ['ACTION'] },
  ],
  bonusActions: [
    { key: 'b1', name: 'Атака другою зброєю', description: 'Коли ви здійснюєте дію Атака і атакуєте легкою зброєю ближнього бою, яку тримаєте в одній руці, ви можете бонусною дією атакувати іншою легкою зброєю ближнього бою, яку тримаєте в іншій руці.', sourceName: 'General', displayTypes: ['BONUSACTION'] },
  ],
  reactions: [
    { key: 'r1', name: 'Провокована атака', description: 'Ви можете здійснити провоковану атаку, коли ворожа істота, яку ви бачите, виходить з вашої досяжності.', sourceName: 'General', displayTypes: ['REACTION'] },
  ]
};

const spellsMock = [
  {
    spellId: 1,
    name: 'Вогняний заряд',
    engName: 'Fire Bolt',
    level: 0,
    school: 'Втілення',
    castingTime: '1 дія',
    range: '120 футів',
    duration: 'Миттєва',
    components: 'В, С',
    description: 'Ви жбурляєте іскру вогню в істоту чи предмет у межах відстані. Здійсніть далекобійну атаку чарами по цілі. У випадку влучання ціль отримує 1к10 ушкоджень вогнем. Займисті предмети, по яких влучили ці чари, загоряються, якщо їх ніхто не тримає при собі.\n\nУшкодження цих чарів зростають на 1к10, коли ви досягаєте 5 рівня (2к10), 11 рівня (3к10) та 17 рівня (4к10).',
    source: 'PHB'
  },
  {
    spellId: 2,
    name: 'Магічна рука',
    engName: 'Mage Hand',
    level: 0,
    school: 'Виклик',
    castingTime: '1 дія',
    range: '30 футів',
    duration: '1 хвилина',
    components: 'В, С',
    description: 'Спектральна, плинуча рука з\'являється у вибраній вами точці в межах відстані. Рука існує, поки діють чари, або поки ви не відпустите її дією. Рука зникає, якщо вона переміщується більш як на 30 футів геть від вас, або якщо ви створите ці чари знову.\n\nВи можете використовувати дію, щоб контролювати руку. Ви можете використовувати цю руку, щоб взаємодіяти з предметом, відкрити незамкнені двері чи контейнер, покласти або дістати предмет із відкритого контейнера, або вилити вміст флакона. Ви можете перемістити руку на відстань до 30 футів щоразу, коли використовуєте її.\n\nРука не може атакувати, активувати магічні предмети чи переносити більш як 10 фунтів.',
    source: 'PHB'
  },
  {
    spellId: 3,
    name: 'Гримучий Клинок',
    engName: 'Booming Blade',
    level: 0,
    school: 'Втілення',
    castingTime: '1 дія',
    range: 'На себе',
    duration: '1 раунд',
    components: 'В, М (зброя ближнього бою, що коштує принаймні 1 см)',
    description: 'Ви робите атаку зброєю ближнього бою по одній цілі в межах досяжності зброї. При влучанні ціль отримує звичайні ушкодження, і вона оповивається гуркочучою енергією до початку вашого наступного ходу.',
    source: 'TCOE'
  },
  {
    spellId: 4,
    name: 'Падіння пір\'їною',
    engName: 'Feather Fall',
    level: 1,
    school: 'Перетворення',
    castingTime: '1 реакція, яку ви здійснюєте, коли ви або істота у межах 60 футів від вас падає',
    range: '60 футів',
    duration: '1 хвилина',
    components: 'В, М (маленьке пір\'їна або пух)',
    description: 'Оберіть до п\'яти істот, що падають, в межах відстані. Швидкість падіння істоти зменшується до 60 футів за раунд до закінчення чарів. Якщо істота приземляється до закінчення чарів, вона не отримує ушкоджень від падіння і може приземлитися на ноги.',
    source: 'PHB'
  }
];

async function main() {
  const baseTemplate = await loadBaseTemplate();
  
  // Test features
  console.log("Generating features PDF...");
  const featuresHtml = renderFeaturesHTML('Балар-Залізобород', featuresMock as any);
  const fullFeaturesHtml = baseTemplate
    .replaceAll('{{TITLE}}', 'Здібності — Балар-Залізобород')
    .replace('{{CONTENT}}', `<div class="two-column">${featuresHtml}</div>`);
  
  const featuresPdfBytes = await generatePdfFromHtml(fullFeaturesHtml);
  const featuresPath = path.resolve(__dirname, "../test-features.pdf");
  await fs.writeFile(featuresPath, featuresPdfBytes);
  console.log(`Saved ${featuresPath}`);

  // Test spells
  console.log("Generating spells PDF...");
  const spellsHtml = renderSpellsHTML(spellsMock as any);
  const fullSpellsHtml = baseTemplate
    .replaceAll('{{TITLE}}', 'Заклинання')
    .replace('{{CONTENT}}', `<div class="two-column">${spellsHtml}</div>`);
  
  const spellsPdfBytes = await generatePdfFromHtml(fullSpellsHtml);
  const spellsPath = path.resolve(__dirname, "../test-spells.pdf");
  await fs.writeFile(spellsPath, spellsPdfBytes);
  console.log(`Saved ${spellsPath}`);
}

main().catch(console.error);
